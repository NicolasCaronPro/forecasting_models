window.Modernizr=function(t,h,d){function R(t){o.cssText=t}function u(t,e){return typeof t===e}function p(t,e){for(var i in t){i=t[i];if(!~(""+i).indexOf("-")&&o[i]!==d)return"pfx"!=e||i}return!1}function e(t,e,i){var n=t.charAt(0).toUpperCase()+t.slice(1),r=(t+" "+m.join(n+" ")+n).split(" ");if(u(e,"string")||void 0===e)return p(r,e);var a,s=r=(t+" "+_.join(n+" ")+n).split(" "),o=e,l=i;for(a in s){var c=o[s[a]];if(c!==d)return!1===l?s[a]:u(c,"function")?c.bind(l||o):c}return!1}function n(t,e,i,n){var r,a,s,o=h.createElement("div"),l=h.body,c=l||h.createElement("body");if(parseInt(i,10))for(;i--;)(a=h.createElement("div")).id=n?n[i]:f+(i+1),o.appendChild(a);return r=["&#173;",'<style id="s',f,'">',t,"</style>"].join(""),o.id=f,(l?o:c).innerHTML+=r,c.appendChild(o),l||(c.style.background="",c.style.overflow="hidden",s=g.style.overflow,g.style.overflow="hidden",g.appendChild(c)),r=e(o,t),l?o.parentNode.removeChild(o):(c.parentNode.removeChild(c),g.style.overflow=s),!!r}function k(t,e){e=e||h.createElement(r[t]||"div");var i=(t="on"+t)in e;return i||(e=e.setAttribute?e:h.createElement("div")).setAttribute&&e.removeAttribute&&(e.setAttribute(t,""),i=u(e[t],"function"),void 0!==e[t]&&(e[t]=d),e.removeAttribute(t)),e=null,i}var i,r,a,s={},g=h.documentElement,f="modernizr",o=h.createElement(f).style,l=" -webkit- -moz- -o- -ms- ".split(" "),c="Webkit Moz O ms",m=c.split(" "),_=c.toLowerCase().split(" "),F="http://www.w3.org/2000/svg",v={},y=[],b=y.slice,C=(r={select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"},{}.hasOwnProperty),x=void 0!==C&&void 0!==C.call?function(t,e){return C.call(t,e)}:function(t,e){return e in t&&void 0===t.constructor.prototype[e]};for(a in Function.prototype.bind||(Function.prototype.bind=function(i){var n=this;if("function"!=typeof n)throw new TypeError;var r=b.call(arguments,1),a=function(){var t,e;return this instanceof a?((t=function(){}).prototype=n.prototype,t=new t,e=n.apply(t,r.concat(b.call(arguments))),Object(e)===e?e:t):n.apply(i,r.concat(b.call(arguments)))};return a}),v.touch=function(){var e;return"ontouchstart"in t||t.DocumentTouch&&h instanceof DocumentTouch?e=!0:n(["@media (",l.join("touch-enabled),("),f,")","{#modernizr{top:9px;position:absolute}}"].join(""),function(t){e=9===t.offsetTop}),e},v.geolocation=function(){return"geolocation"in navigator},v.draganddrop=function(){var t=h.createElement("div");return"draggable"in t||"ondragstart"in t&&"ondrop"in t},v.csstransforms3d=function(){var i=!!e("perspective");return i&&"webkitPerspective"in g.style&&n("@media (transform-3d),(-webkit-transform-3d){#modernizr{left:9px;position:absolute;height:3px;}}",function(t,e){i=9===t.offsetLeft&&3===t.offsetHeight}),i},v.csstransitions=function(){return e("transition")},v.localstorage=function(){try{return localStorage.setItem(f,f),localStorage.removeItem(f),!0}catch(t){return!1}},v.sessionstorage=function(){try{return sessionStorage.setItem(f,f),sessionStorage.removeItem(f),!0}catch(t){return!1}},v.svg=function(){return!!h.createElementNS&&!!h.createElementNS(F,"svg").createSVGRect},v)x(v,a)&&(i=a.toLowerCase(),s[i]=v[a](),y.push((s[i]?"":"no-")+i));s.addTest=function(t,e){if("object"==typeof t)for(var i in t)x(t,i)&&s.addTest(i,t[i]);else{if(t=t.toLowerCase(),s[t]!==d)return s;e="function"==typeof e?e():e,g.className+=" "+(e?"":"no-")+t,s[t]=e}return s},R("");var c=this,w=h;function S(){var t=L.elements;return"string"==typeof t?t.split(" "):t}function M(t){var e=$[t[D]];return e||(e={},E++,t[D]=E,$[E]=e),e}function O(t,e,i){return e=e||w,T?e.createElement(t):!(e=(i=i||M(e)).cache[t]?i.cache[t].cloneNode():U.test(t)?(i.cache[t]=i.createElem(t)).cloneNode():i.createElem(t)).canHaveChildren||V.test(t)||e.tagUrn?e:i.frag.appendChild(e)}function G(t){var e,i,n,r,a,s=M(t=t||w);return!L.shivCSS||I||s.hasCSS||(s.hasCSS=(r="article,aside,dialog,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}mark{background:#FF0;color:#000}template{display:none}",a=(n=t).createElement("p"),n=n.getElementsByTagName("head")[0]||n.documentElement,a.innerHTML="x<style>"+r+"</style>",!!n.insertBefore(a.lastChild,n.firstChild))),T||(e=t,(i=s).cache||(i.cache={},i.createElem=e.createElement,i.createFrag=e.createDocumentFragment,i.frag=i.createFrag()),e.createElement=function(t){return L.shivMethods?O(t,e,i):i.createElem(t)},e.createDocumentFragment=Function("h,f","return function(){var n=f.cloneNode(),c=n.createElement;h.shivMethods&&("+S().join().replace(/[\w\-]+/g,function(t){return i.createElem(t),i.frag.createElement(t),'c("'+t+'")'})+");return n}")(L,i.frag)),t}var I,T,A,P=c.html5||{},V=/^<|^(?:button|map|select|textarea|object|iframe|option|optgroup)$/i,U=/^(?:a|b|code|div|fieldset|h1|h2|h3|h4|h5|h6|i|label|li|ol|p|q|span|strong|style|table|tbody|td|th|tr|ul)$/i,D="_html5shiv",E=0,$={};try{var N=w.createElement("a");N.innerHTML="<xyz></xyz>",I="hidden"in N,T=1==N.childNodes.length||(w.createElement("a"),void 0===(A=w.createDocumentFragment()).cloneNode||void 0===A.createDocumentFragment||void 0===A.createElement)}catch(t){T=I=!0}var L={elements:P.elements||"abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video",version:"3.7.0",shivCSS:!1!==P.shivCSS,supportsUnknownElements:T,shivMethods:!1!==P.shivMethods,type:"default",shivDocument:G,createElement:O,createDocumentFragment:function(t,e){if(t=t||w,T)return t.createDocumentFragment();for(var i=(e=e||M(t)).frag.cloneNode(),n=0,r=S(),a=r.length;n<a;n++)i.createElement(r[n]);return i}};return c.html5=L,G(w),s._version="2.8.3",s._prefixes=l,s._domPrefixes=_,s._cssomPrefixes=m,s.hasEvent=k,s.testProp=function(t){return p([t])},s.testAllProps=e,s.testStyles=n,g.className=g.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+(" js "+y.join(" ")),s}(this,this.document),function(t,p){function d(t){return"[object Function]"==r.call(t)}function g(t){return"string"==typeof t}function u(){}function f(t){return!t||"loaded"==t||"complete"==t||"uninitialized"==t}function m(){var t=y.shift();b=1,t?t.t?_(function(){("c"==t.t?O.injectCss:O.injectJs)(t.s,0,t.a,t.x,t.e,1)},0):(t(),m()):b=0}function e(t,e,i,n,r){return b=0,e=e||"j",g(t)?(s="c"==e?S:w,o=t,e=e,l=this.i++,i=i,n=n,r=(r=r)||O.errorTimeout,c=p.createElement(s),d=h=0,u={t:e,s:o,e:i,a:n,x:r},1===M[o]&&(d=1,M[o]=[]),"object"==s?c.data=o:(c.src=o,c.type=s),c.width=c.height="0",c.onerror=c.onload=c.onreadystatechange=function(){a.call(this,d)},y.splice(l,0,u),"img"!=s&&(d||2===M[o]?(x.insertBefore(c,C?null:v),_(a,r)):M[o].push(c))):(y.splice(this.i++,0,t),1==y.length&&m()),this;function a(t){if(!h&&f(c.readyState)&&(u.r=h=1,b||m(),c.onload=c.onreadystatechange=null,t))for(var e in"img"!=s&&_(function(){x.removeChild(c)},50),M[o])M[o].hasOwnProperty(e)&&M[o][e].onload()}var s,o,l,c,h,d,u}function o(){var t=O;return t.loader={load:e,i:0},t}var i,n=p.documentElement,_=t.setTimeout,v=p.getElementsByTagName("script")[0],r={}.toString,y=[],b=0,a="MozAppearance"in n.style,C=a&&!!p.createRange().compareNode,x=C?n:v.parentNode,n=t.opera&&"[object Opera]"==r.call(t.opera),n=!!p.attachEvent&&!n,w=a?"object":n?"script":"img",S=n?"script":w,s=Array.isArray||function(t){return"[object Array]"==r.call(t)},l=[],M={},c={timeout:function(t,e){return e.length&&(t.timeout=e[0]),t}},O=function(t){function h(t,e,i,n,r){var a=function(t){for(var e,i,t=t.split("!"),n=l.length,r=t.pop(),a=t.length,r={url:r,origUrl:r,prefixes:t},s=0;s<a;s++)i=t[s].split("="),(e=c[i.shift()])&&(r=e(r,i));for(s=0;s<n;s++)r=l[s](r);return r}(t),s=a.autoCallback;a.url.split(".").pop().split("?").shift(),a.bypass||(e=e&&(d(e)?e:e[t]||e[n]||e[t.split("/").pop().split("?")[0]]),a.instead?a.instead(t,e,i,n,r):(M[a.url]?a.noexec=!0:M[a.url]=1,i.load(a.url,a.forceCSS||!a.forceJS&&"css"==a.url.split(".").pop().split("?").shift()?"c":void 0,a.noexec,a.attrs,a.timeout),(d(e)||d(s))&&i.load(function(){o(),e&&e(a.origUrl,r,n),s&&s(a.origUrl,r,n),M[a.url]=2})))}function e(t,e){function i(i,t){if(i){if(g(i))h(i,o=t?o:function(){var t=[].slice.call(arguments);l.apply(this,t),c()},e,0,a);else if(Object(i)===i)for(r in n=function(){var t,e=0;for(t in i)i.hasOwnProperty(t)&&e++;return e}(),i)i.hasOwnProperty(r)&&(t||--n||(d(o)?o=function(){var t=[].slice.call(arguments);l.apply(this,t),c()}:o[r]=function(e){return function(){var t=[].slice.call(arguments);e&&e.apply(this,t),c()}}(l[r])),h(i[r],o,e,r,a))}else t||c()}var n,r,a=!!t.test,s=t.load||t.both,o=t.callback||u,l=o,c=t.complete||u;i(a?t.yep:t.nope,!!s),s&&i(s)}var i,n,r=this.yepnope.loader;if(g(t))h(t,0,r,0);else if(s(t))for(i=0;i<t.length;i++)g(n=t[i])?h(n,0,r,0):s(n)?O(n):Object(n)===n&&e(n,r);else Object(t)===t&&e(t,r)};O.addPrefix=function(t,e){c[t]=e},O.addFilter=function(t){l.push(t)},O.errorTimeout=1e4,null==p.readyState&&p.addEventListener&&(p.readyState="loading",p.addEventListener("DOMContentLoaded",i=function(){p.removeEventListener("DOMContentLoaded",i,0),p.readyState="complete"},0)),t.yepnope=o(),t.yepnope.executeStack=m,t.yepnope.injectJs=function(t,e,i,n,r,a){var s,o,l=p.createElement("script"),n=n||O.errorTimeout;for(o in l.src=t,i)l.setAttribute(o,i[o]);e=a?m:e||u,l.onreadystatechange=l.onload=function(){!s&&f(l.readyState)&&(s=1,e(),l.onload=l.onreadystatechange=null)},_(function(){s||e(s=1)},n),r?l.onload():v.parentNode.insertBefore(l,v)},t.yepnope.injectCss=function(t,e,i,n,r,a){var s,e=a?m:e||u;for(s in(n=p.createElement("link")).href=t,n.rel="stylesheet",n.type="text/css",i)n.setAttribute(s,i[s]);r||(v.parentNode.insertBefore(n,v),_(e,0))}}(this,document),Modernizr.load=function(){yepnope.apply(window,[].slice.call(arguments,0))},function(e,i){var t=i.jQuery;"object"==typeof exports?module.exports=t?e(i,t):function(t){return e(i,t)}:"function"==typeof define&&define.amd?define(["jquery"],function(t){return e(i,t)}):e(i,!1)}(function(C,at){"use strict";var t=!1===at;if(!(at=at||C.jQuery)||!at.fn)throw"JsViews requires jQuery";var e,a,V,d,T,A,P,U,c,$,h,k,Y,F,st,r,z,y,b,j,n,i,M,H,s,W,o,X,l,D,E,m,q,K,u,Z,N,p,g,J,f,_,Q,tt,v,O,G,I,et,it,L,nt="v1.0.11",x="_ocp",rt=/[ \t]*(\r\n|\n|\r)/g,mt=/\\(['"\\])/g,_t=/['"\\]/g,vt=/(?:\x08|^)(onerror:)?(?:(~?)(([\w$.]+):)?([^\x08]+))\x08(,)?([^\x08]+)/gi,yt=/^if\s/,bt=/<(\w+)[>\s]/,Ct=/[\x00`><\"'&=]/,xt=/^on[A-Z]|^convert(Back)?$/,wt=/^\#\d+_`[\s\S]*\/\d+_`$/,St=/[\x00`><"'&=]/g,Mt=/[&<>]/g,Ot=/&(amp|gt|lt);/g,Gt=/\[['"]?|['"]?\]/g,It=0,Tt={"&":"&amp;","<":"&lt;",">":"&gt;","\0":"&#0;","'":"&#39;",'"':"&#34;","`":"&#96;","=":"&#61;"},At={amp:"&",gt:">",lt:"<"},B="html",R="object",Pt="data-jsv-tmpl",Dt="jsvTmpl",Et="For #index in nested block use #getIndex().",Nt={},Lt={},Rt=C.jsrender,kt=Rt&&at&&!at.render,Ft={template:{compile:function i(n,t,r,a){function e(t){var e;if(""+t===t||0<t.nodeType&&(s=t)){if(!s)if(/^\.?\/[^\\:*?"<>]*$/.test(t))(e=c[n=n||t])?t=e:s=document.getElementById(t);else if("#"===t.charAt(0))s=document.getElementById(t.slice(1));else if(at.fn&&!Y.rTmpl.test(t))try{s=at(t,document)[0]}catch(t){}s&&("SCRIPT"!==s.tagName&&ot(t+": Use script block, not "+s.tagName),a?t=s.innerHTML:((e=s.getAttribute(Pt))&&(e!==Dt?(t=c[e],delete c[e]):at.fn&&(t=at.data(s)[Dt])),e&&t||(n=n||(at.fn?Dt:t),t=i(n,s.innerHTML,r,a)),t.tmplName=n=n||e,n!==Dt&&(c[n]=t),s.setAttribute(Pt,n),at.fn&&at.data(s,Dt,t))),s=void 0}else t.fn||(t=void 0);return t}var s,o,l=t=t||"";Y._html=$.html;0===a&&(a=void 0,l=e(l));a=a||(t.markup?t.bnds?w({},t):t:{});a.tmplName=a.tmplName||n||"unnamed";r&&(a._parentTmpl=r);!l&&t.markup&&(l=e(t.markup))&&l.fn&&(l=l.markup);if(void 0!==l)return l.render||t.render?l.tmpls&&(o=l):(t=ie(l,a),ce(l.replace(_t,"\\$&"),t)),o||te(o=w(function(){return o.render.apply(o,arguments)},t)),o}},tag:{compile:function(t,e,i){var n,r,a,s=new Y._tg;function o(){this._={unlinked:!0},this.inline=!0,this.tagName=t}P(e)?e={depends:e.depends,render:e}:""+e===e&&(e={template:e});if(r=e.baseTag)for(a in e.flow=!!e.flow,(r=""+r===r?i&&i.tags[r]||k[r]:r)||ot('baseTag: "'+e.baseTag+'" not found'),s=w(s,r),e)s[a]=Ut(r[a],e[a]);else s=w(s,e);void 0!==(n=s.template)&&(s.template=""+n===n?c[n]||c(n):n);(o.prototype=s).constructor=s._ctr=o,i&&(s._parentTmpl=i);return s}},viewModel:{compile:function(l,t){var n,e,i,c=this,h=t.getters,r=t.extend,f=t.id,a=at.extend({_is:l||"unnamed",unmap:g,merge:p},r),s="",o="",d=h?h.length:0,m=at.observable,_={};function u(t){e.apply(this,t)}function v(){return new u(arguments)}function y(t,e){for(var i,n,r,a,s,o,l=0;l<d;l++)i=void 0,(n=h[l])+""!==n&&(n=(i=n).getter,a=i.parentRef),void 0===(r=t[n])&&i&&void 0!==(s=i.defaultVal)&&(o=t,r=P(s=s)?s.call(o):s),e(r,i&&c[i.type],n,a)}function p(t,e,i){t=t+""===t?JSON.parse(t):t;var n,r,a,s,o,l,c,h,d,u,p=0,g=this;if(U(g)){for(c={},d=[],r=t.length,a=g.length;p<r;p++){for(h=t[p],l=!1,n=0;n<a&&!l;n++)c[n]||(o=g[n],f&&(c[n]=l=f+""===f?h[f]&&(_[f]?o[f]():o[f])===h[f]:f(o,h)));l?(o.merge(h),d.push(o)):(d.push(u=v.map(h)),i&&ee(u,i,e))}m?m(g).refresh(d,!0):g.splice.apply(g,[0,g.length].concat(d))}else for(s in y(t,function(t,e,i,n){e?g[i]().merge(t,g,n):g[i]()!==t&&g[i](t)}),t)s===A||_[s]||(g[s]=t[s])}function g(){var t,e,i,n,r=0,a=this;function s(t){for(var e=[],i=0,n=t.length;i<n;i++)e.push(t[i].unmap());return e}if(U(a))return s(a);for(t={};r<d;r++)i=void 0,n=a[e=(e=h[r])+""!==e?(i=e).getter:e](),t[e]=i&&n&&c[i.type]?U(n)?s(n):n.unmap():n;for(e in a)!a.hasOwnProperty(e)||"_"===e.charAt(0)&&_[e.slice(1)]||e===A||P(a[e])||(t[e]=a[e]);return t}for(u.prototype=a,n=0;n<d;n++)!function(e){e=e.getter||e,_[e]=n+1;var i="_"+e;s+=(s?",":"")+e,o+="this."+i+" = "+e+";\n",a[e]=a[e]||function(t){if(!arguments.length)return this[i];m?m(this).setProperty(e,t):this[i]=t},m&&(a[e].set=a[e].set||function(t){this[i]=t})}(h[n]);return o=new Function(s,o),((e=function(){o.apply(this,arguments),(i=arguments[d+1])&&ee(this,arguments[d],i)}).prototype=a).constructor=e,v.map=function(t){var e,i,n,r,a=0,s=t=t+""===t?JSON.parse(t):t,o=[];if(U(t)){for(e=(t=t||[]).length;a<e;a++)o.push(this.map(t[a]));return o._is=l,o.unmap=g,o.merge=p,o}if(t){for(y(t,function(t,e){e&&(t=e.map(t)),o.push(t)}),s=this.apply(this,o),a=d;a--;)if(n=o[a],(r=h[a].parentRef)&&n&&n.unmap)if(U(n))for(e=n.length;e--;)ee(n[e],r,s);else ee(n,r,s);for(i in t)i===A||_[i]||(s[i]=t[i])}return s},v.getters=h,v.extend=r,v.id=f,v}},helper:{},converter:{}};function Vt(i,n){return function(){var t,e=this.base;return this.base=i,t=n.apply(this,arguments),this.base=e,t}}function Ut(t,e){return P(e)&&((e=Vt(t?t._d?t:Vt(zt,t):zt,e))._d=(t&&t._d||0)+1),e}function $t(t,e){var i,n=e.props;for(i in n)!xt.test(i)||t[i]&&t[i].fix||(t[i]="convert"!==i?Ut(t.constructor.prototype[i],n[i]):n[i])}function Bt(t){return t}function zt(){return""}function jt(t){this.name=(at.link?"JsViews":"JsRender")+" Error",this.message=t||this.name}function w(t,e){if(t){for(var i in e)t[i]=e[i];return t}}function Ht(t,e,i){return t?U(t)?Ht.apply(d,t):(n=i?i[0]:n,/^(\W|_){5}$/.test(t+e+n)||ot("Invalid delimiters"),z=t[0],y=t[1],b=e[0],j=e[1],F.delimiters=[z+y,b+j,n],t="\\"+z+"(\\"+n+")?\\"+y,e="\\"+b+"\\"+j,a="(?:(\\w+(?=[\\/\\s\\"+b+"]))|(\\w+)?(:)|(>)|(\\*))\\s*((?:[^\\"+b+"]|\\"+b+"(?!\\"+j+"))*?)",Y.rTag="(?:"+a+")",a=new RegExp("(?:"+t+a+"(\\/)?|\\"+z+"(\\"+n+")?\\"+y+"(?:(?:\\/(\\w+))\\s*|!--[\\s\\S]*?--))"+e,"g"),Y.rTmpl=new RegExp("^\\s|\\s$|<.*>|([^\\\\]|^)[{}]|"+t+".*"+e),r):F.delimiters}function Wt(){var t=this.get("item");return t?t.index:void 0}function Xt(){return this.index}function Yt(t,e,i,n){var r,a,s,o=0;if(1===i&&(n=1,i=void 0),e)for(s=(a=e.split(".")).length;t&&o<s;o++)r=t,t=a[o]?t[a[o]]:t;return i&&(i.lt=i.lt||o<s),void 0===t?n?zt:"":n?function(){return t.apply(r,arguments)}:t}function qt(t,e,i){var n,r,a,s,o=this,l=!M&&1<arguments.length,c=o.ctx;if(t){if(o._||(a=o.index,o=o.tag),s=o,c&&c.hasOwnProperty(t)||(c=h).hasOwnProperty(t)){if(r=c[t],"tag"===t||"tagCtx"===t||"root"===t||"parentTags"===t)return r}else c=void 0;if((!M&&o.tagCtx||o.linked)&&(r&&r._cxp||(o=o.tagCtx||P(r)?o:!(o=o.scope||o).isTop&&o.ctx.tag||o,c=(o=void 0!==r&&o.tagCtx?o.tagCtx.view.scope:o)._ocps,(r=c&&c.hasOwnProperty(t)&&c[t]||r)&&r._cxp||!i&&!l||((c||(o._ocps=o._ocps||{}))[t]=r=[{_ocp:r,_vw:s,_key:t}],r._cxp={path:x,ind:0,updateValue:function(t,e){return at.observable(r[0]).setProperty(x,t),this}})),i=r&&r._cxp)){if(2<arguments.length)return(c=r[1]?Y._ceo(r[1].deps):[x]).unshift(r[0]),c._cxp=i,c;if(a=i.tagElse,c=r[1]?i.tag&&i.tag.cvtArgs?i.tag.cvtArgs(a,1)[i.ind]:r[1](r[0].data,r[0],Y):r[0]._ocp,l)return Y._ucp(t,e,o,i),o;r=c}return r&&P(r)&&w(n=function(){return r.apply(this&&this!==C?this:s,arguments)},r),n||r}}function Kt(t,e){var i,n,r,a,s,o,l,c=this;if(c.tagName){if(!(c=((o=c).tagCtxs||[c])[t||0]))return}else o=c.tag;if(s=o.bindFrom,a=c.args,(l=(l=o.convert)&&""+l===l?"true"===l?void 0:c.view.getRsc("converters",l)||ot("Unknown converter: '"+l+"'"):l)&&!e&&(a=a.slice()),s){for(r=[],i=s.length;i--;)n=s[i],r.unshift(Zt(c,n));e&&(a=r)}if(l){if(void 0===(l=l.apply(o,r||a)))return a;if(i=(s=s||[0]).length,U(l)&&(!1===l.arg0||1!==i&&l.length===i&&!l.arg0)||(l=[l],s=[0],i=1),e)a=l;else for(;i--;)+(n=s[i])===n&&(a[n]=l[i])}return a}function Zt(t,e){return(t=t[+e===e?"args":"props"])&&t[e]}function Jt(t){return this.cvtArgs(t,1)}function Qt(t,e,i,n,r,a,s,o){var l=this,c="array"===e;l.content=o,l.views=c?[]:{},l.data=n,l.tmpl=r,o=l._={key:0,useKey:c?0:1,id:""+It++,onRender:s,bnds:{}},l.linked=!!s,l.type=e||"top",e&&(l.cache={_ct:F._cchCt}),i&&"top"!==i.type||((l.ctx=t||{}).root=l.data),(l.parent=i)?(l.root=i.root||l,n=i.views,r=i._,l.isTop=r.scp,l.scope=(!t.tag||t.tag===i.ctx.tag)&&!l.isTop&&i.scope||l,r.useKey?((n[o.key="_"+r.useKey++]=l).index=Et,l.getIndex=Wt):n.length===(o.key=l.index=a)?n.push(l):n.splice(a,0,l),l.ctx=t||i.ctx):e&&(l.root=l)}function te(t){var e,i,n;for(e in Ft)t[i=e+"s"]&&(n=t[i],t[i]={},d[i](n,t))}function ee(t,e,i){Object.defineProperty(t,e,{value:i,configurable:!0})}function ie(t,e){var i,n=st._wm||{},r={tmpls:[],links:{},bnds:[],_is:"template",render:se};return(r=e?w(r,e):r).markup=t,r.htmlTag||(i=bt.exec(t),r.htmlTag=i?i[1].toLowerCase():""),(i=n[r.htmlTag])&&i!==n.div&&(r.markup=at.trim(r.markup)),r}function ne(l,c){var h=l+"s";d[h]=function t(e,i,n){var r,a,s,o=Y.onStore[l];if(!e||typeof e!==R||e.nodeType||e.markup||e.getTgt||"viewModel"===l&&e.getters||e.extend)return e&&""+e!==e&&(n=i,i=e,e=void 0),s=n?"viewModel"===l?n:n[h]=n[h]||{}:t,r=c.compile,void 0===i&&(i=r?e:s[e],e=void 0),null===i?e&&delete s[e]:(r&&((i=r.call(s,e,i,n,0)||{})._is=l),e&&(s[e]=i)),o&&o(e,i,n,r),i;for(a in e)t(a,e[a],i);return i||d}}function re(e){r[e]=r[e]||function(t){return arguments.length?(F[e]=t,r):F[e]}}function ae(i){function n(t,e){this.tgt=i.getTgt(t,e),e.map=this}return(i=(i=P(i)?{getTgt:i}:i).baseMap?w(w({},i.baseMap),i):i).map=function(t,e){return new n(t,e)},i}function se(t,e,i,n,r,a){var s,o,l,c,h,d,u=n,p="";if(!0===e?(i=e,e=void 0):typeof e!==R&&(e=void 0),(l=this.tag)?(c=(u=u||this.view)._getTmpl(l.template||this.tmpl),arguments.length||(t=l.contentCtx&&P(l.contentCtx)?l.contentCtx(t):u)):c=this,c){if((u=!n&&t&&"view"===t._is?t:u)&&t===u&&(t=u.data),n=!u,M=M||n,n&&((e=e||{}).root=t),!M||st.useViews||c.useViews||u&&u!==V)p=oe(c,t,e,i,u,r,a,l);else{if(u?(h=u.data,d=u.index,u.index=Et):(h=(u=V).data,u.data=t,u.ctx=e),U(t)&&!i)for(s=0,o=t.length;s<o;s++)u.index=s,u.data=t[s],p+=c.fn(t[s],u,Y);else u.data=t,p+=c.fn(t,u,Y);u.data=h,u.index=d}n&&(M=void 0)}return p}function oe(t,e,i,n,r,a,s,o){var l,c,h,d,u,p,g,f,m,_,v,y,b,C="";if(o&&(m=o.tagName,y=o.tagCtx,i=i?ge(i,o.ctx):o.ctx,t===r.content?g=t!==r.ctx._wrp?r.ctx._wrp:void 0:t!==y.content?t===o.template?(g=y.tmpl,i._wrp=y.content):g=y.content||r.content:g=r.content,!1===y.props.link&&((i=i||{}).link=!1)),r&&(s=s||r._.onRender,(b=i&&!1===i.link)&&r._.nl&&(s=void 0),i=ge(i,r.ctx),y=!o&&r.tag?r.tag.tagCtxs[r.tagElse]:y),(_=y&&y.props.itemVar)&&("~"!==_[0]&&lt("Use itemVar='~myItem'"),_=_.slice(1)),!0===a&&(p=!0,a=0),!0===(f=s=s&&o&&o._.noVws?void 0:s)&&(f=void 0,s=r._.onRender),v=i=t.helpers?ge(t.helpers,i):i,U(e)&&!n)for((h=p?r:void 0!==a&&r||new Qt(i,"array",r,e,t,a,s,g))._.nl=b,r&&r._.useKey&&(h._.bnd=!o||o._.bnd&&o,h.tag=o),l=0,c=e.length;l<c;l++)d=new Qt(v,"item",h,e[l],t,(a||0)+l,s,h.content),_&&((d.ctx=w({},v))[_]=Y._cp(e[l],"#data",d)),u=t.fn(e[l],d,Y),C+=h._.onRender?h._.onRender(u,d):u;else h=p?r:new Qt(v,m||"data",r,e,t,a,s,g),_&&((h.ctx=w({},v))[_]=Y._cp(e,"#data",h)),h.tag=o,h._.nl=b,C+=t.fn(e,h,Y);return o&&(h.tagElse=y.index,y.contentView=h),f?f(C,h):C}function le(t,e,i){var n=void 0!==i?P(i)?i.call(e.data,t,e):i||"":"{Error: "+(t.message||t)+"}";return F.onError&&void 0!==(i=F.onError.call(e.data,t,i&&n,e))&&(n=i),e&&!e._lc?$.html(n):n}function ot(t){throw new Y.Err(t)}function lt(t){ot("Syntax error\n"+t)}function ce(w,S,M,O,G){function I(t){(t-=E)&&L.push(w.substr(E,t).replace(rt,"\\n"))}function T(t,e){t&&(t+="}}",lt((e?"{{"+e+"}} block has {{/"+t+" without {{"+t:"Unmatched or missing {{/"+t)+", in template:\n"+w))}var t,e,A,P,i,D=F.allowCode||S&&S.allowCode||!0===r.allowCode,n=[],E=0,N=[],L=n,R=[,,n];if(D&&S._is&&(S.allowCode=D),M&&(void 0!==O&&(w=w.slice(0,-O.length-2)+b),w=z+w+j),T(N[0]&&N[0][2].pop()[0]),w.replace(a,function(t,e,i,n,r,a,s,o,l,c,h,d){(s&&e||l&&!i||o&&":"===o.slice(-1)||c)&&lt(t),a&&(r=":",n=B);var u,p,g,c=(e||M)&&[[]],f="",m="",_="",v="",y="",b="",C="",x="",a=!(l=l||M&&!G)&&!r;i=i||(o=o||"#data",r),I(d),E=d+t.length,s?D&&L.push(["*","\n"+o.replace(/^:/,"ret+= ").replace(mt,"$1")+";\n"]):i?("else"===i&&(yt.test(o)&&lt('For "{{else if expr}}" use "{{else expr}}"'),c=R[9]&&[[]],R[10]=w.substring(R[10],d),p=R[11]||R[0]||lt("Mismatched: "+t),R=N.pop(),L=R[2],a=!0),o&&ue(o.replace(rt," "),c,S,M).replace(vt,function(t,e,i,n,r,a,s,o){return"this:"===n&&(a="undefined"),o&&(g=g||"@"===o[0]),n="'"+r+"':",s?(m+=i+a+",",v+="'"+o+"',"):i?(_+=n+"j._cp("+a+',"'+o+'",view),',b+=n+"'"+o+"',"):e?C+=a:("trigger"===r&&(x+=a),"lateRender"===r&&(u="false"!==o),f+=n+a+",",y+=n+"'"+o+"',",P=P||xt.test(r)),""}).slice(0,-1),c&&c[0]&&c.pop(),A=[i,n||!!O||P||"",a&&[],de(v||(":"===i?"'#data',":""),y,b),de(m||(":"===i?"data,":""),f,_),C,x,u,g,c||0],L.push(A),a&&(N.push(R),(R=A)[10]=E,R[11]=p)):h&&(T(h!==R[0]&&h!==R[11]&&h,R[0]),R[10]=w.substring(R[10],d),R=N.pop()),T(!R&&h),L=R[2]}),I(w.length),(E=n[n.length-1])&&T(""+E!==E&&+E[10]===E[10]&&E[0]),M){for(e=pe(n,w,M),i=[],t=n.length;t--;)i.unshift(n[t][9]);he(e,i)}else e=pe(n,S);return e}function he(t,e){var i,n,r=0,a=e.length;for(t.deps=[],t.paths=[];r<a;r++)for(i in t.paths.push(n=e[r]),n)"_jsvto"!==i&&n.hasOwnProperty(i)&&n[i].length&&!n[i].skp&&(t.deps=t.deps.concat(n[i]))}function de(t,e,i){return[t.slice(0,-1),e.slice(0,-1),i.slice(0,-1)]}function ue(G,I,t,T){var A,P,D,E,N=I&&I[0],L={bd:N},R={0:L},k=0,F=0,V=0,U={},$=0,B={},z={},j={},H={0:0},W={0:""},X=0,t=((G="@"===G[0]?G.replace(Gt,"."):G)+(t?" ":"")).replace(Y.rPrm,function(t,e,i,n,l,r,a,s,o,c,h,d,u,p,g,f,m,_,v,y,b){r=r||"",u=u||"",i=i||e||u,l=(l=n&&!s?n+l:l)||o,(c=c&&!/\)|]/.test(b[y-1]))&&(l=l.slice(1).split(".").join("^")),h=h||_||"";var C,x,w,S,M,O=y;if(!E&&!D){if(a&&lt(G),m&&N){if(o=j[V-1],b.length-1>O-(o||0)){if(o=at.trim(b.slice(o,O+t.length)),C=P||R[V-1].bd,(x=C[C.length-1])&&x.prm){for(;x.sb&&x.sb.prm;)x=x.sb;w=x.sb={path:x.sb,bnd:x.bnd}}else C.push(w={path:C.pop()});x&&x.sb===w&&(W[V]=W[V-1].slice(x._cpPthSt)+W[V],W[V-1]=W[V-1].slice(0,x._cpPthSt)),w._cpPthSt=H[V-1],w._cpKey=o,W[V]+=b.slice(X,y),X=y,w._cpfn=Nt[o]=Nt[o]||new Function("data,view,j","//"+o+"\nvar v;\nreturn ((v="+W[V]+("]"===f?")]":f)+")!=null?v:null);"),W[V-1]+=z[F]&&st.cache?'view.getCache("'+o.replace(_t,"\\$&")+'"':W[V],w.prm=L.bd,w.bnd=w.bnd||w.path&&0<=w.path.indexOf("^")}W[V]=""}"["===h&&(h="[j._sq("),"["===i&&(i="[j._sq(")}return a=E?(E=!p)?t:u+'"':D?(D=!g)?t:u+'"':(i?(B[++F]=!0,U[F]=0,N&&(j[V++]=O++,L=R[V]={bd:[]},W[V]="",H[V]=1),i):"")+(v?F?"":(k=b.slice(k,O),(A?(A=P=!1,"\b"):"\b,")+k+(k=O+t.length,N&&I.push(L.bd=[]),"\b")):s?(V&&lt(G),N&&I.pop(),A="_"+l,k=O+t.length,N&&((N=L.bd=I[A]=[]).skp=!n),l+":"):l?l.split("^").join(".").replace(Y.rPath,function(t,e,i,n,r,a,s,o){if(S="."===i,i&&(l=l.slice(e.length),/^\.?constructor$/.test(o||l)&&lt(t),S||(t=(c?(T?"":"(ltOb.lt=ltOb.lt||")+"(ob=":"")+(n?'view.ctxPrm("'+n+'")':r?"view":"data")+(c?")===undefined"+(T?"":")")+'?"":view._getOb(ob,"':"")+(o?(a?"."+a:n||r?"":"."+i)+(s||""):(o=n?"":r?a||"":i,"")),t=e+("view.data"===(t+=o?"."+o:"").slice(0,9)?t.slice(5):t)+(c?(T?'"':'",ltOb')+(h?",1)":")"):"")),N)){if(C="_linkTo"===A?P=I._jsvto=I._jsvto||[]:L.bd,x=S&&C[C.length-1]){if(x._cpfn){for(;x.sb;)x=x.sb;x.prm&&(x.bnd&&(l="^"+l.slice(1)),x.sb=l,x.bnd=x.bnd||"^"===l[0])}}else C.push(l);h&&!S&&(j[V]=O,H[V]=W[V].length)}return t})+(h||r):r||(f?"]"===f?")]":")":d?(z[F]||lt(G),","):e?"":(E=p,D=g,'"'))),E||D||f&&(z[F]=!1,F--),N&&(E||D||(f&&(B[F+1]&&(L=R[--V],B[F+1]=!1),$=U[F+1]),h&&(U[F+1]=W[V].length+(i?1:0),(l||f)&&(L=R[++V]={bd:[]},B[F+1]=!0))),W[V]=(W[V]||"")+b.slice(X,y),X=y+t.length,E||D||((M=i&&B[F+1])&&(W[V-1]+=i,H[V-1]++),"("===h&&S&&!w&&(W[V]=W[V-1].slice($)+W[V],W[V-1]=W[V-1].slice(0,$))),W[V]+=M?a.slice(1):a),E||D||!h||(F++,l&&"("===h&&(z[F]=!0)),E||D||!_||(N&&(W[V]+=h),a+=h),a});return N&&(t=W[0]),!F&&t||lt(G)}function pe(t,e,i){var n,r,a,s,o,l,c,h,d,u,p,g,f,m,_,v,y,b,C,x,w,S,M,O,G,I,T,A,P,D=0,E=st.useViews||e.useViews||e.tags||e.templates||e.helpers||e.converters,N="",L={},R=t.length;for(""+e===e?(_=i?'data-link="'+e.replace(rt," ").slice(1,-1)+'"':e,e=0):(_=e.tmplName||"unnamed",e.allowCode&&(L.allowCode=!0),e.debug&&(L.debug=!0),d=e.bnds,m=e.tmpls),n=0;n<R;n++)if(""+(r=t[n])===r)N+='+"'+r+'"';else if("*"===(a=r[0]))N+=";\n"+r[1]+"\nret=ret";else{if(s=r[1],y=!i&&r[2],A=r[3],P=p=r[4],A="\n\tparams:{args:["+A[0]+"],\n\tprops:{"+A[1]+"}"+(A[2]?",\n\tctx:{"+A[2]+"}":"")+"},\n\targs:["+P[0]+"],\n\tprops:{"+P[1]+"}"+(P[2]?",\n\tctx:{"+P[2]+"}":""),P=r[6],G=r[7],T=r[8]?(I="\nvar ob,ltOb={},ctxs=",";\nctxs.lt=ltOb.lt;\nreturn ctxs;"):(I="\nreturn ",""),O=r[10]&&r[10].replace(mt,"$1"),(x="else"===a)?u&&u.push(r[9]):(M=r[5]||!1!==F.debugMode&&"undefined",d&&(u=r[9])&&(u=[u],D=d.push(1))),E=E||p[1]||p[2]||u||/view.(?!index)/.test(p[0]),(w=":"===a)?s&&(a=s===B?">":s+a):(y&&((O=ie(O,L)).tmplName=_+"/"+a,O.useViews=O.useViews||E,pe(y,O),E=O.useViews,m.push(O)),x||(v=a,E=E||a&&(!k[a]||!k[a].flow),C=N,N=""),b=(b=t[n+1])&&"else"===b[0]),O=M?";\ntry{\nret+=":"\n+",g=x="",w&&(u||P||s&&s!==B||G)){if((S=new Function("data,view,j","// "+_+" "+ ++D+" "+a+I+"{"+A+"};"+T))._er=M,S._tag=a,S._bd=!!u,S._lr=G,i)return S;he(S,u),h=!0,x=(f='c("'+s+'",view,')+D+",",g=")"}if(N+=w?(i?(M?"try{\n":"")+"return ":O)+(h?(E=c=!(h=void 0),f+(S?(d[D-1]=S,D):"{"+A+"}")+")"):">"===a?(l=!0,"h("+p[0]+")"):"((v="+p[0]+")!=null?v:"+(i?"null)":'"")')):(o=!0,"\n{view:view,content:false,tmpl:"+(y?m.length:"false")+","+A+"},"),v&&!b){if(N="["+N.slice(0,-1)+"]",f='t("'+v+'",view,this,',i||u){if((N=new Function("data,view,j"," // "+_+" "+D+" "+v+I+N+T))._er=M,N._tag=v,u&&he(d[D-1]=N,u),N._lr=G,i)return N;x=f+D+",undefined,",g=")"}N=C+O+f+(u&&D||N)+")",v=u=0}M&&!b&&(E=!0,N+=";\n}catch(e){ret"+(i?"urn ":"+=")+x+"j._err(e,view,"+M+")"+g+";}"+(i?"":"\nret=ret"))}N="// "+_+(L.debug?"\ndebugger;":"")+"\nvar v"+(o?",t=j._tag":"")+(c?",c=j._cnvt":"")+(l?",h=j._html":"")+(i?(r[8]?", ob":"")+";\n":',ret=""')+N+(i?"\n":";\nreturn ret;");try{N=new Function("data,view,j",N)}catch(t){lt("Compiled template code:\n\n"+N+'\n: "'+(t.message||t)+'"')}return e&&(e.fn=N,e.useViews=!!E),N}function ge(t,e){return t&&t!==e?e?w(w({},e),t):t:e&&w({},e)}function fe(e,t){var i,n,r,a=t.tag,s=t.props,o=t.params.props,l=s.filter,c=s.sort,h=!0===c,d=parseInt(s.step),u=s.reverse?-1:1;if(U(e)){if(h||c&&""+c===c?((i=e.map(function(t,e){return{i:e,v:""+(t=h?t:Yt(t,c))===t?t.toLowerCase():t}})).sort(function(t,e){return t.v>e.v?u:t.v<e.v?-u:0}),e=i.map(function(t){return e[t.i]})):(c||u<0)&&!a.dataMap&&(e=e.slice()),P(c)&&(e=e.sort(function(){return c.apply(t,arguments)})),(e=u<0&&(!c||P(c))?e.reverse():e).filter&&l&&(e=e.filter(l,t),t.tag.onFilter&&t.tag.onFilter(t)),o.sorted&&(i=c||u<0?e:e.slice(),a.sorted?at.observable(a.sorted).refresh(i):t.map.sorted=i),n=s.start,r=s.end,(o.start&&void 0===n||o.end&&void 0===r)&&(n=r=0),isNaN(n)&&isNaN(r)||(r=void 0===r||r>e.length?e.length:+r,e=e.slice(n=+n||0,r)),1<d){for(n=0,r=e.length,i=[];n<r;n+=d)i.push(e[n]);e=i}o.paged&&a.paged&&T(a.paged).refresh(e)}return e}function me(t,e,i){var n=this.jquery&&(this[0]||ot("Unknown template")),r=n.getAttribute(Pt);return se.call(r&&at.data(n)[Dt]||c(n),t,e,i)}function _e(t){return Tt[t]||(Tt[t]="&#"+t.charCodeAt(0)+";")}function ve(t,e){return At[e]||""}function ye(t){return null!=t?Ct.test(t)&&(""+t).replace(St,_e)||t:""}if(d={jsviews:nt,sub:{rPath:/^(!*?)(?:null|true|false|\d[\d.]*|([\w$]+|\.|~([\w$]+)|#(view|([\w$]+))?)([\w$.^]*?)(?:[.[^]([\w$]+)\]?)?)$/g,rPrm:/(\()(?=\s*\()|(?:([([])\s*)?(?:(\^?)(~?[\w$.^]+)?\s*((\+\+|--)|\+|-|~(?![\w$])|&&|\|\||===|!==|==|!=|<=|>=|[<>%*:?\/]|(=))\s*|(!*?(@)?[#~]?[\w$.^]+)([([])?)|(,\s*)|(?:(\()\s*)?\\?(?:(')|("))|(?:\s*(([)\]])(?=[.^]|\s*$|[^([])|[)\]])([([]?))|(\s+)/g,View:Qt,Err:jt,tmplFn:ce,parse:ue,extend:w,extendCtx:ge,syntaxErr:lt,onStore:{template:function(t,e){null===e?delete Lt[t]:t&&(Lt[t]=e)}},addSetting:re,settings:{allowCode:!1},advSet:zt,_thp:$t,_gm:Ut,_tg:function(){},_cnvt:function(t,e,i,n){var r,a,s,o,l,c="number"==typeof i&&e.tmpl.bnds[i-1];void 0===n&&c&&c._lr&&(n="");void 0!==n?i=n={props:{},args:[n]}:c&&(i=c(e.data,e,Y));if(c=c._bd&&c,t||c){if(a=e._lc,r=a&&a.tag,i.view=e,!r){if(r=w(new Y._tg,{_:{bnd:c,unlinked:!0,lt:i.lt},inline:!a,tagName:":",convert:t,onArrayChange:!0,flow:!0,tagCtx:i,tagCtxs:[i],_is:"tag"}),1<(o=i.args.length))for(l=r.bindTo=[];o--;)l.unshift(o);a&&((a.tag=r).linkCtx=a),i.ctx=ge(i.ctx,(a?a.view:e).ctx),$t(r,i)}r._er=n&&s,r.ctx=i.ctx||r.ctx||{},i.ctx=void 0,s=r.cvtArgs()[0],r._er=n&&s}else s=i.args[0];return null!=(s=c&&e._.onRender?e._.onRender(s,e,r):s)?s:""},_tag:function(t,e,i,n,r,a){function R(t){var e=s[t];if(void 0!==e)for(e=U(e)?e:[e],u=e.length;u--;)O=e[u],isNaN(parseInt(O))||(e[u]=parseInt(O));return e||[0]}var s,o,l,c,h,d,u,p,g,f,m,_,v,y,b,C,x,k,w,S,M,O,G,I,T,A,P=0,D="",E=(e=e||V)._lc||!1,N=e.ctx,F=i||e.tmpl,L="number"==typeof n&&e.tmpl.bnds[n-1];"tag"===t._is?(t=(s=t).tagName,n=s.tagCtxs,s.template):(o=e.getRsc("tags",t)||ot("Unknown tag: {{"+t+"}} "),o.template);void 0===a&&L&&(L._lr=o.lateRender&&!1!==L._lr||L._lr)&&(a="");void 0!==a?(D+=a,n=a=[{props:{},args:[],params:{props:{}}}]):L&&(n=L(e.data,e,Y));for(d=n.length;P<d;P++)f=n[P],b=f.tmpl,(!E||!E.tag||P&&!E.tag.inline||s._er||b&&+b===b)&&(b&&F.tmpls&&(f.tmpl=f.content=F.tmpls[b-1]),f.index=P,f.ctxPrm=qt,f.render=se,f.cvtArgs=Kt,f.bndArgs=Jt,f.view=e,f.ctx=ge(ge(f.ctx,o&&o.ctx),N)),(i=f.props.tmpl)&&(f.tmpl=e._getTmpl(i),f.content=f.content||f.tmpl),s?E&&E.fn._lr&&(C=!!s.init):(s=new o._ctr,C=!!s.init,s.parent=h=N&&N.tag,s.tagCtxs=n,E&&(s.inline=!1,E.tag=s),s.linkCtx=E,(s._.bnd=L||E.fn)?(s._.ths=f.params.props.this,s._.lt=n.lt,s._.arrVws={}):s.dataBoundOnly&&ot(t+" must be data-bound:\n{^{"+t+"}}")),S=s.dataMap,f.tag=s,S&&n&&(f.map=n[P].map),s.flow||(b=f.ctx=f.ctx||{},l=s.parents=b.parentTags=N&&ge(b.parentTags,N.parentTags)||{},h&&(l[h.tagName]=h),l[s.tagName]=b.tag=s,b.tagCtx=f);if(!(s._er=a)){for($t(s,n[0]),s.rendering={rndr:s.rendering},P=0;P<d;P++){if(f=s.tagCtx=n[P],w=f.props,s.ctx=f.ctx,!P){if(C&&(s.init(f,E,s.ctx),C=void 0),f.args.length||!1===f.argDefault||!1===s.argDefault||(f.args=x=[f.view.data],f.params.args=["#data"]),_=R("bindTo"),void 0!==s.bindTo&&(s.bindTo=_),void 0!==s.bindFrom?s.bindFrom=R("bindFrom"):s.bindTo&&(s.bindFrom=s.bindTo=_),v=s.bindFrom||_,I=_.length,G=v.length,s._.bnd&&(T=s.linkedElement)&&(s.linkedElement=T=U(T)?T:[T],I!==T.length&&ot("linkedElement not same length as bindTo")),(T=s.linkedCtxParam)&&(s.linkedCtxParam=T=U(T)?T:[T],G!==T.length&&ot("linkedCtxParam not same length as bindFrom/bindTo")),v)for(s._.fromIndex={},s._.toIndex={},p=G;p--;)for(O=v[p],u=I;u--;)O===_[u]&&(s._.fromIndex[u]=p,s._.toIndex[p]=u);E&&(E.attr=s.attr=E.attr||s.attr||E._dfAt),c=s.attr,s._.noVws=c&&c!==B}if(x=s.cvtArgs(P),s.linkedCtxParam)for(k=s.cvtArgs(P,1),u=G,A=s.constructor.prototype.ctx;u--;)(m=s.linkedCtxParam[u])&&(O=v[u],y=k[u],f.ctx[m]=Y._cp(A&&void 0===y?A[m]:y,void 0!==y&&Zt(f.params,O),f.view,s._.bnd&&{tag:s,cvt:s.convert,ind:u,tagElse:P}));(M=w.dataMap||S)&&(x.length||w.dataMap)&&((w=f.map)&&w.src===x[0]&&!r||(w&&w.src&&w.unmap(),M.map(x[0],f,w,!s._.bnd),w=f.map),x=[w.tgt]),g=void 0,s.render&&(g=s.render.apply(s,x),e.linked&&g&&!wt.test(g)&&((i={links:[]}).render=i.fn=function(){return g},g=oe(i,e.data,void 0,!0,e,void 0,void 0,s))),x.length||(x=[e]),void 0===g&&(M=x[0],s.contentCtx&&(M=!0===s.contentCtx?e:s.contentCtx(M)),g=f.render(M,!0)||(r?void 0:"")),D=D?D+(g||""):void 0!==g?""+g:void 0}s.rendering=s.rendering.rndr}s.tagCtx=n[0],s.ctx=s.tagCtx.ctx,s._.noVws&&s.inline&&(D="text"===c?$.html(D):"");return L&&e._.onRender?e._.onRender(D,e,s):D},_er:ot,_err:le,_cp:Bt,_sq:function(t){return"constructor"===t&&lt(""),t}},settings:{delimiters:Ht,advanced:function(t){return t?(w(st,t),Y.advSet(),r):st}},map:ae},(jt.prototype=new Error).constructor=jt,Wt.depends=function(){return[this.get("item"),"index"]},Xt.depends="index",Qt.prototype={get:function(t,e){e||!0===t||(e=t,t=void 0);var i,n,r,a,s=this,o="root"===e;if(t){if(!(a=e&&s.type===e&&s))if(i=s.views,s._.useKey){for(n in i)if(a=e?i[n].get(t,e):i[n])break}else for(n=0,r=i.length;!a&&n<r;n++)a=e?i[n].get(t,e):i[n]}else if(o)a=s.root;else if(e)for(;s&&!a;)a=s.type===e?s:void 0,s=s.parent;else a=s.parent;return a||void 0},getIndex:Xt,ctxPrm:qt,getRsc:function(t,e){var i,n,r=this;if(""+e===e){for(;void 0===i&&r;)i=(n=r.tmpl&&r.tmpl[t])&&n[e],r=r.parent;return i||d[t][e]}},_getTmpl:function(t){return t&&(t.fn?t:this.getRsc("templates",t)||c(t))},_getOb:Yt,getCache:function(t){return F._cchCt>this.cache._ct&&(this.cache={_ct:F._cchCt}),void 0!==this.cache[t]?this.cache[t]:this.cache[t]=Nt[t](this.data,this,Y)},_is:"view"},Y=d.sub,r=d.settings,!at.link){for(e in Ft)ne(e,Ft[e]);if($=d.converters,h=d.helpers,k=d.tags,Y._tg.prototype={baseApply:function(t){return this.base.apply(this,t)},cvtArgs:Kt,bndArgs:Jt,ctxPrm:qt},V=Y.topView=new Qt,at){if(at.fn.render=me,A=at.expando,at.observable){if(nt!==(nt=at.views.jsviews))throw"jquery.observable.js requires jsrender.js "+nt;w(Y,at.views.sub),d.map=at.views.map}}else at={},t&&(C.jsrender=at),at.renderFile=at.__express=at.compile=function(){throw"Node.js: use npm jsrender, or jsrender-node.js"},at.isFunction=function(t){return"function"==typeof t},at.isArray=Array.isArray||function(t){return"[object Array]"==={}.toString.call(t)},Y._jq=function(t){t!==at&&(w(t,at),(at=t).fn.render=me,delete at.jsrender,A=at.expando)},at.jsrender=nt;for(i in(F=Y.settings).allowCode=!1,P=at.isFunction,at.render=Lt,at.views=d,at.templates=c=d.templates,F)re(i);(r.debugMode=function(t){return void 0===t?F.debugMode:(F._clFns&&F._clFns(),F.debugMode=t,F.onError=t+""===t?function(){return t}:P(t)?t:void 0,r)})(!1),st=F.advanced={cache:!0,useViews:!1,_jsv:!1},k({if:{render:function(t){var e=this.tagCtx;return this.rendering.done||!t&&(e.args.length||!e.index)?"":(this.rendering.done=!0,void(this.selected=e.index))},contentCtx:!0,flow:!0},for:{sortDataMap:ae(fe),init:function(t,e){this.setDataMap(this.tagCtxs)},render:function(t){var e,i,n,r,a=this.tagCtx,s=!1===a.argDefault,o=a.props,l=s||a.args.length,c="",h=0;if(!this.rendering.done){if(e=l?t:a.view.data,s)for(s=o.reverse?"unshift":"push",n=+o.end,r=+o.step||1,e=[],i=+o.start||0;0<(n-i)*r;i+=r)e[s](i);void 0!==e&&(t=U(e),c+=a.render(e,!l||o.noIteration),h+=t?e.length:1),(this.rendering.done=h)&&(this.selected=a.index)}return c},setDataMap:function(t){for(var e,i,n,r=t.length;r--;)i=(e=t[r]).props,n=e.params.props,e.argDefault=void 0===i.end||0<e.args.length,i.dataMap=!1!==e.argDefault&&U(e.args[0])&&(n.sort||n.start||n.end||n.step||n.filter||n.reverse||i.sort||i.start||i.end||i.step||i.filter||i.reverse)&&this.sortDataMap},flow:!0},props:{baseTag:"for",dataMap:ae(function(t,e){var i,n,r=e.map,a=r&&r.propsArr;if(!a){if(a=[],typeof t===R||P(t))for(i in t)n=t[i],i===A||!t.hasOwnProperty(i)||e.props.noFunctions&&at.isFunction(n)||a.push({key:i,prop:n});r&&(r.propsArr=r.options&&a)}return fe(a,e)}),init:zt,flow:!0},include:{flow:!0},"*":{render:Bt,flow:!0},":*":{render:Bt,flow:!0},dbg:h.dbg=$.dbg=function(t){try{throw console.log("JsRender dbg breakpoint: "+t),"dbg breakpoint"}catch(t){}return this.base?this.baseApply(arguments):t}}),$({html:ye,attr:ye,encode:function(t){return""+t===t?t.replace(Mt,_e):t},unencode:function(t){return""+t===t?t.replace(Ot,ve):t},url:function(t){return null!=t?encodeURI(""+t):null===t?t:""}})}if(F=Y.settings,U=(at||Rt).isArray,r.delimiters("{{","}}","^"),kt&&Rt.views.sub._jq(at),d=at.views,Y=d.sub,P=at.isFunction,U=at.isArray,A=at.expando,at.observe||(t=at.event.special,H=[].slice,s=[].splice,W=[].concat,o=parseInt,X=/\S+/g,l=/^[^.[]*$/,D=Y.propChng=Y.propChng||"propertyChange",E=Y.arrChng=Y.arrChng||"arrayChange",m={},q=D+".observe",Z=u=K=1,N=at.data,p={},J=function(t){return t?t._cId=t._cId||".obs"+u++:""},f=function(t,e){return this._data=e,this._ns=t,this},_=function(t,e){return this._data=e,this._ns=t,this},Q=function(t,e,i){for(var n,r,a,s=r=e,o=(t=t?U(t)?t:[t]:[])&&t.length,l=[],c=0;c<o;c++)n=t[c],P(n)?(a=e.tagName?e.linkCtx.data:e,l=l.concat(Q(n.call(e,a,i),a,i))):""+n!==n?(e=s=n=void 0===n?null:n,s!==r&&l.push(r=s)):(s!==r&&l.push(r=s),l.push(n));return l.length&&(l.unshift({_ar:1}),l.push({_ar:-1})),l},tt=function(t,e){function i(t){return typeof t===R&&(d[0]||!h&&U(t))}var n,r,a,s,o,l,c,h,d,u;t.data&&t.data.off||(a=e.oldValue,s=e.value,l=(o=t.data).observeAll,c=o.cb,h=o._arOk?0:1,d=o.paths,u=o.ns,t.type===E?(c.array||c).call(o,t,e):o.prop!==e.path&&"*"!==o.prop||(l?(n=l._path+"."+e.path,r=l.filter,l=[t.target].concat(l.parents()),i(a)&&v(void 0,u,[a],d,c,!0,r,[l],n),i(s)&&v(void 0,u,[s],d,c,void 0,r,[l],n)):(i(a)&&v(h,u,[a],d,c,!0),i(s)&&v(h,u,[s],d,c)),o.cb(t,e)))},v=function(){var t=W.apply([],arguments);return L.apply(t.shift(),t)},O=function(t,e,i){G(this._ns,this._data,t,e,[],"root",i)},nt=function(t,e){O.call(this,t,e,!0)},G=function(r,t,a,s,e,i,n,o){function l(t,e){for(d=t.length,u=i+"[]";d--;)c(t,d,e,1)}function c(t,e,i,n){+e!==e&&e===A||!(t=T._fltr(u,t[e],p,s))||(e=p.slice(),n&&g&&e[0]!==g&&e.unshift(g),G(r,t,a,s||(n?void 0:0),e,u,i,o))}function h(t,e){switch(i=t.data.observeAll._path,g=t.target,e.change){case"insert":l(e.items);break;case"remove":l(e.items,!0);break;case"set":u=i+"."+e.path,c(e,"oldValue",!0),c(e,"value")}g=void 0,a.apply(this,arguments)}h._wrp=1;var d,u,p,g,f,m=!o||o.un||!n;if(t&&typeof t===R)if(p=[t].concat(e),e=U(t)?"":"*",o&&m&&at.hasData(t)&&o[f=N(t).obId])o[f]++;else{if(o=o||{un:n},a){if(e||0!==s)if(h._cId=J(a),m)L(r,t,e,h,n,s,p,i),f=N(t).obId,o[f]=(o[f]||0)+1;else{if(--o[N(t).obId])return;L(r,t,e,h,n,s,p,i)}}else o&&(o[N(t).obId]=1),L(r,t,e,void 0,n,s,p,i);if(e)for(d in t)u=i+"."+d,c(t,d,n);else l(t,n)}},I=function(t){return l.test(t)},et=function(){return[].push.call(arguments,!0),L.apply(void 0,arguments)},it=function(t){var e,i=this.slice();for(this.length=0,this._go=0;e=i.shift();)e.skip||e[0]._trigger(e[1],e[2],!0);this.paths={}},L=function(){var G,I=1==this?0:1,t=H.call(arguments),e=t[0];return e+""===e&&(G=e,t.shift()),function l(){var t,_,r,e,v,a,d,c,u,y,p,i,n,h,b,C,x;function s(t,e){var i;for(v in e)i=e[v],U(i)?S(t,i,_,_):w(t,i,void 0,O,"")}function w(t,e,i,n,r,a,s){var o,l=U(l=e)?[l]:l,c=u,h=y;if(n=G?n+"."+G:n,!_&&(s||a))for(C=(C=at._data(e).events)&&C[a?E:D],x=C&&C.length;x--;)if((v=C[x]&&C[x].data)&&(s&&v.ns!==G||!s&&v.ns===G&&v.cb&&v.cb._cId===t._cId&&(!t._wrp||v.cb._wrp)))return;_||s?at(l).off(n,tt):((a=a?{}:{fullPath:i,paths:r?[r]:[],prop:b,_arOk:I}).ns=G,a.cb=t,y&&(a.observeAll={_path:h,path:function(){return o=c.length,h.replace(/[[.]/g,function(t){return o--,"["===t?"["+at.inArray(c[o-1],c[o]):"."})},parents:function(){return c},filter:p}),at(l).on(n,null,a,tt),d&&(i=(i=N(e)).obId||(i.obId=K++),d[i]=d[i]||(d.len++,e)))}function S(t,e,i,n,r){var a,s;I&&(a=y,s=e,r&&(s=e[r],y=y&&y+"."+r),(s=p&&s?T._fltr(y,s,r?[e].concat(u):u,p):s)&&(n||U(s))&&w(t,s,void 0,E+".observe"+J(t),void 0,!0,i),y=a)}function M(t){function m(t,e,d,u){function p(t,n){function e(t,e){var i;if("insert"===e.change||(_="remove"===e.change)){for(i=e.items.length;i--;)p(e.items[i],n.slice());_=!1}}d&&(e._cId=J(d));var i,r,a,s,o,l,c,h=t;if(t&&t._cxp)return m(t[0],[t[1]],d,u);for(;void 0!==(b=n.shift());){if(h&&typeof h===R&&""+b===b){if(""===b)continue;if("()"===b.slice(-2)&&(b=b.slice(0,-2),c=!0),n.length<f+1&&!h.nodeType){if(!_&&(C=at._data(h).events)){for(C=C&&C[D],x=C&&C.length,r=0;x--;)!(v=C[x].data)||v.ns!==G||v.cb._cId!==d._cId||v.cb._inId!==d._inId||!v._arOk!=!I||v.prop!==b&&"*"!==v.prop&&"**"!==v.prop||((o=n.join("."))&&v.paths.push(o),r++);if(r){h=h[b];continue}}if("*"===b||"**"===b){if(!_&&C&&C.length&&w(d,h,g,O,"",!1,!0),"*"===b)for(o in w(d,h,g,O,""),h)o!==A&&S(d,h,_,void 0,o);else at.observable(G,h)[(_?"un":"")+"observeAll"](d);break}"[]"==b?U(h)&&(_?w(d,h,g,E+J(d),void 0,_,_):L(G,h,e,_)):b&&w(d,h,g,O+".p_"+b,n.join("^"))}if(y&&(y+="."+b),"[]"===b){for(U(h)&&(i=(s=h).length);i--;)p(h=s[i],n.slice());return}b=h[b],n[0]||S(d,b,_)}if(P(b)&&((a=(l=b).depends)&&(h._vw&&h._ocp&&(h=(h=(h=h._vw)._tgId?h.tagCtx.view:h).data),M(W.apply([],[[h],Q(a,h,d)]))),c)){if(!n[0]){S(d,l.call(h),_);break}if(!(b=l.call(h)))break}h=b}}var i,n,r,a,s,g,f=0,o=e.length;for(!t||u||!(h="view"===t._is)&&"tag"!==t._is||(u=Y._gccb(h?t:t.tagCtx.contentView),d&&!_&&(n=t,r=d,(d=function(t,e){r.call(n,t,e)})._cId=r._cId,d._inId=r._inId),t=h?t.data:t),e[0]||(U(t)?S(d,t,_,!0):_&&w(d,t,void 0,O,"")),i=0;i<o;i++)""!==(g=e[i])&&(g&&g._ar?I+=g._ar:""+g===g?((c=g.split("^"))[1]&&(f=c[0].split(".").length,g=c.join("."),f=g.split(".").length-f),u&&(c=u(g,f))?c.length&&(a=c[0],s=c[1],a&&a._cxp&&(s=a[1],"view"===(a=a[0])._is)?m(a,[s],d):s+""===s?p(a,s.split(".")):m(c.shift(),c,d,u)):p(t,g.split("."))):!P(g)&&g&&g._cpfn&&((c=_?g.cb:function(a){return a.ob=u(a),a.cb=function(t,e){var i=a.ob,n=a.sb,r=u(a);r!==i&&(typeof i===R&&(S(d,i,!0),(n||I&&U(i))&&l([i],n,d,u,!0)),typeof(a.ob=r)===R&&(S(d,r),(n||I&&U(r))&&l([r],n,d,u))),d(t,e)}}(g))._cId=d._cId,c._inId=c._inId||".obIn"+Z++,(g.bnd||g.prm&&g.prm.length||!g.sb)&&l([t],g.path,g.prm.length?[g.root||t]:[],g.prm,c,u,_),g.sb&&(g.sb.prm&&(g.sb.root=t),m(g.ob,[g.sb],d,u))))}for(var e,i=[],n=t.length;n--;)(e=t[n])+""===e||e&&(e._ar||e._cpfn)?i.unshift(e):(m(e,i,r,a),i=[])}var O=q,o=1!=this?W.apply([],arguments):H.call(arguments),g=o.pop()||!1,f=o.length;if(g+""===g&&(y=g,u=o.pop(),p=o.pop(),g=!!o.pop(),f-=3),g===!!g&&(_=g,g=o[f-1],g=!f||g+""===g||g&&!P(g)?void 0:(f--,o.pop()),_&&!f&&P(o[0])&&(g=o.shift())),r=g,f&&P(o[f-1])&&(a=r,g=r=o.pop(),f--),!_||!r||r._cId){for(O+=r?(g=r._inId||"",_?r._cId+g:(e=J(r))+g):"",e&&!_&&(d=m[e]=m[e]||{len:0}),n=(i=G&&G.match(X)||[""]).length;n--;){if(G=i[n],_&&arguments.length<3)if(r)s(r,m[r._cId]);else if(!o[0])for(t in m)s(r,m[t]);M(o)}return e&&!d.len&&delete m[e],{cbId:e,bnd:d}}}.apply(1,t)},(g=[]).wait=function(){var t=this;t._go=1,setTimeout(function(){t.trigger(!0),t._go=0,t.paths={}})},T=function(t,e,i){t+""!==t&&(i=e,e=t,t=""),i=void 0===i?st.asyncObserve:i;t=new(U(e)?_:f)(t,e);return i&&(!0===i&&(t.async=!0,i=g),i.trigger||(U(i)?(i.trigger=it,i.paths={}):i=void 0),t._batch=i),t},(at.observable=T)._fltr=function(t,e,i,n){if(!n||!P(n)||n(t,e,i))return typeof(e=P(e)?e.set&&e.call(i[0]):e)===R&&e},T.Object=f,T.Array=_,at.observe=T.observe=L,at.unobserve=T.unobserve=et,T._apply=v,f.prototype={_data:null,observeAll:O,unobserveAll:nt,data:function(){return this._data},setProperty:function(t,e,i,n){t=t||"";var r,a,s,o,l=this,c=l._data,h=l._batch;if(c)if(t+""!==t)if(i=e,U(t))for(r=t.length;r--;)a=t[r],l.setProperty(a.name,a.value,void 0===i||i);else{for(r in h||(l._batch=o=[],o.trigger=it,o.paths={}),t)l.setProperty(r,t[r],i);o&&(l._batch.trigger(),l._batch=void 0)}else if(t!==A){for(s=t.split(/[.^]/);c&&1<s.length;)c=c[s.shift()];c&&l._setProperty(c,s[0],e,i,n)}return l},removeProperty:function(t){return this.setProperty(t,p),this},_setProperty:function(t,e,i,n,r){var a,s,o,l,c=e?t[e]:t;if(P(c)&&!P(i)){if(r&&!c.set)return;c.set&&(l=t._vw||t,a=!0===(s=c).set?s:s.set,c=s.call(l))}(c!==i||n&&c!=i)&&(!(c instanceof Date&&i instanceof Date)||i<c||c<i)&&(a?(a.call(l,i),i=s.call(l)):(o=i===p)?void 0!==c?(delete t[e],i=void 0):e=void 0:e&&(t[e]=i),e&&(r={change:"set",path:e,value:i,oldValue:c,remove:o},t._ocp&&(r.ctxPrm=t._key),this._trigger(t,r)))},_trigger:function(t,e,i){F._cchCt++;var n,r;at.hasData(t)&&(!i&&(i=this._batch)?(this.async&&!i._go&&i.wait(),i.push([this,t,e]),n=N(t).obId+e.path,(r=i.paths[n])&&(i[r-1].skip=1),i.paths[n]=i.length):(at(t).triggerHandler(D+(this._ns?"."+/^\S+/.exec(this._ns)[0]:""),e),e.oldValue=null))}},_.prototype={_data:null,observeAll:O,unobserveAll:nt,data:function(){return this._data},insert:function(t,e){var i=this._data;return 1===arguments.length&&(e=t,t=i.length),-1<(t=o(t))&&(e=U(e)?e:[e]).length&&this._insert(t,e),this},_insert:function(t,e){var i=this._data,n=i.length;s.apply(i,[t=n<t?n:t,0].concat(e)),this._trigger({change:"insert",index:t,items:e},n)},remove:function(t,e){var i=this._data;return void 0===t&&(t=i.length-1),t=o(t),0<(e=e?o(e):0===e?0:1)&&-1<t&&(e=(i=i.slice(t,t+e)).length)&&this._remove(t,e,i),this},_remove:function(t,e,i){var n=this._data,r=n.length;n.splice(t,e),this._trigger({change:"remove",index:t,items:i},r)},move:function(t,e,i){return i=i?o(i):0===i?0:1,t=o(t),e=o(e),0<i&&-1<t&&-1<e&&t!==e&&this._move(t,e,i),this},_move:function(t,e,i){var n=this._data,r=n.length,a=t+i-r;0<a&&(i-=a),i&&(a=n.splice(t,i),e>n.length&&(e=n.length),s.apply(n,[e,0].concat(a)),e!==t&&this._trigger({change:"move",oldIndex:t,index:e,items:a},r))},refresh:function(t){function e(){r&&(o.insert(n-r,l),u+=r,i+=r,r=0,l=[])}var i,n,r,a,s,o=this,l=[],c=o._data,h=c.slice(),d=c.length,u=d,p=t.length;for(o._srt=!0,n=r=0;n<p;n++)if((a=t[n])===c[n-r])e();else{for(i=n-r;i<u&&a!==c[i];i++);if(i<u){for(e(),s=0;s++<p-i&&t[n+s]===c[i+s];);o.move(i,n,s),n+=s-1}else r++,l.push(a)}return e(),n<u&&o.remove(n,u-n),o._srt=void 0,(d||p)&&o._trigger({change:"refresh",oldItems:h},d),o},_trigger:function(t,e,i){F._cchCt++;var n,r=this;at.hasData(n=r._data)&&(!i&&(i=r._batch)?(t._dly=!0,i.push([r,t,e]),r.async&&!i._go&&i.wait()):(i=n.length,n=at([n]),r._srt?t.refresh=!0:i!==e&&n.triggerHandler(D,{change:"set",path:"length",value:i,oldValue:e}),n.triggerHandler(E+(r._ns?"."+/^\S+/.exec(r._ns)[0]:""),t)))}},t[D]=t[E]={remove:function(t){var e,i,n,r,a,s=t.data;if(s&&(s.off=!0,s=s.cb)&&(e=m[s._cId])){for(r=(n=at._data(this).events[t.type]).length;r--&&!i;)i=(a=n[r].data)&&a.cb&&a.cb._cId===s._cId;i||(--e.len?delete e[N(this).obId]:delete m[s._cId])}}},d.map=function(s){function r(t,e,i,n){var r,a=this;a.src&&a.unmap(),e&&(e.map=a),typeof t!==R&&!P(t)||(a.src=t,n?a.tgt=s.getTgt(t,e):(i&&(a.tgt=i.tgt||U(i)&&i),a.tgt=a.tgt||[],a.options=e||a.options,(n=a.update())?a=n:(s.obsSrc&&T(a.src).observeAll(a.obs=function(t,e){r||e.refresh||(r=!0,s.obsSrc(a,t,e),r=void 0)},a.srcFlt),s.obsTgt&&T(a.tgt).observeAll(a.obt=function(t,e){r||a.tgt._updt||(r=!0,s.obsTgt(a,t,e),r=void 0)},a.tgtFlt))))}return(s=(s=P(s)?{getTgt:s}:s).baseMap?at.extend({},s.baseMap,s):s).map=function(t,e,i,n){return new r(t,e,i,n)},(r.prototype={srcFlt:s.srcFlt||I,tgtFlt:s.tgtFlt||I,update:function(t){var e,i=this,n=i.tgt;if(!n._updt&&(n._updt=!0,e=i.options&&i.options.map,T(n).refresh(s.getTgt(i.src,i.options=t||i.options)),n._updt=!1,(t=i.options&&i.options.map)&&e!==t))return t},observe:function(t,e){var i=this,n=i.options;i.obmp&&et(i.obmp),i.obmp=function(){var t=e.fn(e.data,e.view,Y)[n.index];at.extend(n.props,t.props),n.args=t.args,i.update()},T._apply(1,e.data,Q(t,e.tag,i.obmp),i.obmp,e._ctxCb)},unmap:function(){var t=this;t.src&&t.obs&&T(t.src).unobserveAll(t.obs,t.srcFlt),t.tgt&&t.obt&&T(t.tgt).unobserveAll(t.obt,t.tgtFlt),t.obmp&&et(t.obmp),t.src=void 0},map:r,_def:s}).constructor=r,s},Y.advSet=function(){Y=this,st=F.advanced,C._jsv=st._jsv?{cbBindings:m}:void 0},Y._dp=Q,Y._gck=J,Y._obs=L,F._cchCt=0,st=F.advanced=st||{useViews:!1,_jsv:!1}),r=d.settings,F=Y.settings,st=F.advanced,$=d.converters,at.templates=c=d.templates,k=d.tags,bt=/<(?!script)(\w+)[>\s]/,!at.link){F.trigger=!0;var be,Ce,xe,ct,we,ht,dt,Se,Me,Oe=window.navigator.userAgent,Ge=void 0!==document.textContent?"textContent":"innerText",ut="data-jsv",Ie="change.jsv",Te="onBeforeChange",Ae="onAfterChange",Pe="onAfterCreate",De="checked",Ee="checkbox",Ne="radio",Le="input[type=",Re="input[type="+Ee+"]",ke="none",S="value",Fe="SCRIPT",Ve="true",Ue='"><\/script>',$e='<script type="jsv',Be=ut+"-df",ze="script,["+ut+"]",je={value:"val",input:"val",html:B,text:"text"},kt={from:S,to:S},He=0,We=at.cleanData,Xe=r.delimiters,Ye={},qe=document.createDocumentFragment(),Ke=document.querySelector,Ze={ol:1,ul:1,table:1,tbody:1,thead:1,tfoot:1,tr:1,colgroup:1,dl:1,select:1,optgroup:1,svg:1,svg_ns:1},Je={tr:"table"},Qe={br:1,img:1,input:1,hr:1,area:1,base:1,col:1,link:1,meta:1,command:1,embed:1,keygen:1,param:1,source:1,track:1,wbr:1},ti={},pt={},ei=1,ii=/^#(view\.?)?/,ni=/((\/>)|<\/(\w+)>|)(\s*)([#/]\d+(?:_|(\^)))`(\s*)(<\w+(?=[\s\/>]))?|\s*(?:(<\w+(?=[\s\/>]))|<\/(\w+)>(\s*)|(\/>)\s*|(>)|$)/g,ri=/(#)()(\d+)(_)/g,ai=/(#)()(\d+)([_^])/g,si=/(?:(#)|(\/))(\d+)(_)/g,oi=/(?:(#)|(\/))(\d+)(\^)/g,li=/(#)()(\d+)(\^)/g,ci=/(?:(#)|(\/))(\d+)([_^])([-+@\d]+)?/g,hi=/&(\d+)\+?/g,di=/^[^.]*$/,ui=C.getComputedStyle,pi=at.inArray;if(Le+=Ne+"]",Oe=0<Oe.indexOf("MSIE ")||0<Oe.indexOf("Trident/"),!(T=at.observable))throw requiresStr+"jquery.observable.js";L=T.observe,F._clFns=function(){Ye={}},Yi(Y.View.prototype),Y.onStore.template=function(t,e,i){null===e?(delete at.link[t],delete at.render[t]):(e.link=Si,t&&!i&&"jsvTmpl"!==t&&(at.render[t]=e,at.link[t]=function(){return Si.apply(e,arguments)}))},Y.viewInfos=ft,(r.delimiters=function(){var t=Xe.apply(0,arguments);return Xe!==Ht&&(t=Ht.apply(0,arguments)),Ce=new RegExp("(?:^|\\s*)([\\w-]*)(\\"+n+")?(\\"+y+Y.rTag+"(:\\w*)?\\"+b+")","g"),t})(),Y.addSetting("trigger"),$.merge=function(t){var e,i=this.linkCtx.elem.className,n=this.tagCtx.props.toggle;return n&&(e=n.replace(/[\\^$.|?*+()[{]/g,"\\$&"),t=(i=i.replace(new RegExp("(\\s(?="+e+"$)|(\\s)|^)("+e+"(\\s|$))"),"$2"))+(t?(i&&" ")+n:"")),t},k({on:{attr:ke,bindTo:[],init:function(t){for(var e,i=0,n=t.args,r=n.length;i<r&&!P(n[i]);i++);this._hi=i<r&&i+1,this.inline&&(Y.rTmpl.exec(e=at.trim(t.tmpl.markup))||(this.template="<button>"+(e||t.params.args[i]||"noop")+"</button>"),this.attr=B)},onBind:function(){this.template&&(this.mainElem=this.contents("button"))},onAfterLink:function(t,n){var r,a,s=this,e=s._hi,i=t.args,o=i.length,l=t.props,c=l.data,h=t.view,d=l.context;e&&(r=i[e-1],a=i.slice(e),i=i.slice(0,e-1),s._sel=i[1],l=s.activeElem=s.activeElem||at(s.inline?(s._sel=i[1]||"*",s.parentElem):n.elem),d=d||(d=/^(.*)[.^][\w$]+$/.exec(t.params.args.slice(-a.length-1)[0]))&&Y.tmplFn(y+":"+d[1]+b,h.tmpl,!0)(n.data,h,Y),s._evs&&s.onUnbind(t,n,s.ctx),l.on(s._evs=i[0]||"click",s._sel,null==c?null:c,s._hlr=function(t){var e,i=!s.inline;if(!i)for(e=s.contents("*"),o=e.length;!i&&o--;)e[o].contains(t.target)&&(i=!0);if(i)return r.apply(d||n.data,[].concat(a,t,{change:t.type,view:h,linkCtx:n},a.slice.call(arguments,1)))}))},onUpdate:!1,onArrayChange:!1,onUnbind:function(){var t=this,e=He;t.activeElem&&(He=0,t.activeElem.off(t._evs,t._sel,t._hlr),He=e)},contentCtx:!0,setSize:!0,dataBoundOnly:!0},radiogroup:{boundProps:["disabled"],init:function(t){this.name=t.props.name||(Math.random()+"jsv").slice(9)},onBind:function(s,t){var o,l,c=this,h=(h=s.params.props)&&h.disabled,d=c.inline?(o=(o=c.contents("*")[0])&&xe(o).ctx.tag===c.parent?o:c.parentElem,c.contents(!0,Le)):(o=t.elem,at(Le,t.elem));for(c.linkedElem=d,l=d.length;l--;)d[l].name=d[l].name||c.name;at(o).on("jsv-domchange",c._dmChg=function(t,e,i,n){var r,a,e=e.ctx.parentTags;if(!n.refresh&&(!c.inline||o!==c.parentElem||e&&e[c.tagName]===c)){for(a=c.cvtArgs()[0],d=c.linkedElem=c.contents(!0,Le),l=d.length;l--;)(r=d[l])._jsvLkEl=c,r.name=r.name||c.name,r._jsvBnd="&"+c._tgId+"+",r.checked=a===r.value,h&&(r.disabled=!!s.props.disabled);c.linkedElems=s.linkedElems=[d]}}),c._dmChg.tgt=o},onAfterLink:function(t,e,i,n,r){var a=t.params.props;a&&a.disabled&&this.linkedElem.prop("disabled",!!t.props.disabled)},onUnbind:function(){this._dmChg&&(at(this._dmChg.tgt).off("jsv-domchange",this._dmChg),this._dmChg=void 0)},onUpdate:!1,contentCtx:!0,dataBoundOnly:!0},checkboxgroup:{boundProps:["disabled"],init:function(t){this.name=t.props.name||(Math.random()+"jsv").slice(9)},onBind:function(a,t){for(var s,o=this,e=a.params.props,l=e&&e.disabled,c=a.params.args[0],h=o.contents(!0,Re),d=h.length;d--;)h[d].name=h[d].name||o.name,h[d]._jsvLkEl=o;for(d in e)c+=" "+d+"="+e[d];h.link(c,t.data,void 0,void 0,t.view),o.linkedElem=h,s=o.inline?(s=o.contents("*")[0])&&at.view(s).ctx.tag===o.parent?s:o.parentElem:t.elem,at(s).on("jsv-domchange",o._dmChg=function(t,e,i,n){var r,e=e.ctx.parentTags;if(!n.refresh&&(!o.inline||s!==o.parentElem||e&&e[o.tagName]===o))for(h=o.contents(!0,Re),d=h.length;d--;)(r=h[d])._jsvSel||(r.name=r.name||o.name,at.link(c,r,i.data),l&&(r.disabled=!!a.props.disabled))}),o._dmChg.tgt=s},onAfterLink:function(t,e,i,n,r){var a=t.params.props;a&&a.disabled&&this.contents(!0,Re).prop("disabled",!!t.props.disabled)},onUnbind:function(){this._dmChg&&(at(this._dmChg.tgt).off("jsv-domchange",this._dmChg),this._dmChg=void 0)},onUpdate:!1,contentCtx:!0,dataBoundOnly:!0}}),w(k.for,{sortDataMap:d.map({getTgt:k.for.sortDataMap.getTgt,obsSrc:function(t,e,i){t.update()},obsTgt:function(t,e,i){var n,r=i.items,a=t.src;if("remove"===i.change)for(n=r.length;n--;)T(a).remove(pi(r[n],a));else"insert"===i.change&&T(a).insert(r)}}),mapProps:["filter","sort","reverse","start","end","step"],bindTo:["paged","sorted"],bindFrom:[0],onArrayChange:function(t,e,i,n){var r,a=t.target.length,s=this;if(!s.rendering)if(s._.noVws||s.tagCtxs[1]&&("insert"===e.change&&a===e.items.length||"remove"===e.change&&!a))a=i.map&&i.map.propsArr,s.refresh(),a&&(i.map.propsArr=a);else for(r in s._.arrVws)(r=s._.arrVws[r]).data===t.target&&_i.apply(r,arguments);s.domChange(i,n,e),t.done=!0},onUpdate:function(t,e,i){this.setDataMap(i)},onBind:function(t,n,e,i,r){for(var a,s=this,o=0,l=s._ars=s._ars||{},c=s.tagCtxs,h=c.length,d=s.selected||0;o<=d;o++)t=c[o],a=t.map?t.map.tgt:t.args.length?t.args[0]:t.view.data,l[o]&&(L(l[o],!0),delete l[o]),!l[o]&&U(a)&&!function(){var i=t;L(a,l[o]=function(t,e){s.onArrayChange(t,e,i,n)})}();for(o=d+1;o<h;o++)l[o]&&(L(l[o],!0),delete l[o]);r&&s.domChange(t,n,r)},onAfterLink:function(t){for(var e,i,n,r=this,a=0,s=r.tagCtxs,o=(s.length,r.selected||0);a<=o;a++)i=(t=s[a]).map,e=t.map?i.tgt:t.args.length?t.args[0]:t.view.data,U(e)&&(n=t.params.props)&&(n.paged&&!r.paged&&(at.observable(r).setProperty("paged",e.slice()),r.updateValue(r.paged,0,a,!0)),n.sorted&&!r.sorted&&(at.observable(r).setProperty("sorted",i&&i.sorted||e.slice()),r.updateValue(r.sorted,1,a,!0)))},onDispose:function(){for(var t in this._ars)L(this._ars[t],!0)}}),w(k.if,{onUpdate:function(t,e,i){for(var n,r,a=0;n=this.tagCtxs[a];a++)if(r=n.props.tmpl!==i[a].props.tmpl||n.args.length&&!(n=n.args[0])!=!i[a].args[0],!this.convert&&n||r)return r;return!1},onAfterLink:function(t,e,i,n,r){r&&this.domChange(t,e,r)}}),k("props",{baseTag:"for",dataMap:d.map({getTgt:k.props.dataMap.getTgt,obsSrc:function(t,e,i){var n,r,a=t.options.props;if(qi(t.propsArr,i.path,i.value,i.remove),void 0!==a.sort||void 0!==a.start||void 0!==a.end||void 0!==a.step||a.filter||a.reverse)t.update();else if("set"===i.change){for(r=(n=t.tgt).length;r--&&n[r].key!==i.path;);-1===r?i.path&&!i.remove&&T(n).insert({key:i.path,prop:i.value}):i.remove?T(n).remove(r):T(n[r]).setProperty("prop",i.value)}},obsTgt:function(t,e,i){var n,r,a,s,o=t.src,l=i.change;if("set"===l)"prop"===i.path?T(o).setProperty(e.target.key,i.value):(T(o).removeProperty(i.oldValue),T(o).setProperty(i.value,e.target.prop));else if("insert"===l||(s="remove"===l))for(r=(n=i.items).length;r--;)(a=n[r].key)&&(qi(t.propsArr,a,n[r].prop,s),s?(T(o).removeProperty(a),delete o[a]):T(o).setProperty(a,n[r].prop))},tgtFlt:function(t){return di.test(t)}}),flow:!0}),w(at,{view:xe=function(t,e,i){function n(t,e){if(t)for(a=ft(t,e,ri),o=0,l=a.length;o<l&&(!(r=dt[a[o].id])||!(r=r&&i?r.get(!0,i):r));o++);}e!==!!e&&(i=e,e=void 0);var r,a,s,o,l,c,h,d=0,u=document.body;if(t&&t!==u&&1<V._.useKey&&(t=""+t===t?at(t)[0]:t.jquery?t[0]:t)){if(e){if(n(t._df,!0),!r&&t.tagName)for(c=(h=Ke?t.querySelectorAll(ze):at(ze,t).get()).length,s=0;!r&&s<c;s++)n(h[s]);return r}for(;t;){if(a=ft(t,void 0,si))for(c=a.length;c--;)if((r=a[c]).open){if(d<1)return(r=dt[r.id])&&i?r.get(i):r||V;d--}else d++;t=t.previousSibling||t.parentNode}}return V},link:Mi,unlink:Bi,cleanData:function(t){t.length&&He&&Ui(t),We.apply(at,arguments)}}),w(at.fn,{link:function(t,e,i,n,r,a,s){return Mi(t,this,e,i,n,r,a,s)},unlink:function(){return Bi(this)},view:function(t,e){return xe(this[0],t,e)}}),at.each([B,"replaceWith","empty","remove"],function(t,e){var i=at.fn[e];at.fn[e]=function(){var t;He++;try{t=i.apply(this,arguments)}finally{He--}return t}}),w(V=Y.topView,{tmpl:{links:{}}}),dt={0:V},Y._glt=function(t){for(var e,i=/#(\d*)\^\/\1\^/g,n=[],r=Ai(t);e=i.exec(r);)(e=pt[e[1]])&&n.push(e.linkCtx.tag);return n},Y._gccb=function(d){return function(t,e){var i,n,r,a,s,o,l,c,h;if(d&&t){if(t._cpfn)try{return st.cache?d.getCache(t._cpKey):t._cpfn.call(d.tmpl,d.data,d,Y)}catch(t){return}if("~"===t.charAt(0)){if("~tag"===t.slice(0,4)&&(i=d.ctx,"."===t.charAt(4)?(a=t.slice(5),i=i.tag):"~tagCtx."===t.slice(0,8)&&(a=t.slice(8),i=i.tagCtx),a))return i?[i,a]:[];if(t=t.slice(1).split("."),r=d.ctxPrm(a=t.shift(),void 0,!0))if(l=r._cxp){if(t.length&&(s="."+t.join("."),(a=r[o=r.length-1])._cpfn?(a.sb=s,a.bnd=!!e):(r[o]=(a+s).replace("#data.",""),"#view"===a.slice(0,5)&&(r[o]=r[o].slice(6),r.splice(o,0,d)))),n=[r],(i=l.tag)&&i.convert)for(o=(h=i.bindTo||[0]).length;o--;)void 0!==e&&o!==l.ind&&(c=h[o],(c=[r[0],i.tagCtx.params[+c===c?"args":"props"]])._cxp=l,n.push(c))}else(t.length||P(r))&&(n=[r,t.join(".")]);return n||[]}if("#"===t.charAt(0))return"#data"===t?[]:[d,t.replace(ii,"")]}}},Y._cp=function(e,t,i,n){var r;return i.linked&&(n&&(n.cvt||void 0===n.tag._.toIndex[n.ind])?(e=[{_ocp:e}],n.updateValue=function(t){return at.observable(e._cxp.data).setProperty(x,t),this}):e=t?((r=Ye[t=y+":"+t+b])||(Ye[t]=r=Y.tmplFn(t.replace(_t,"\\$&"),i.tmpl,!0)),r.deps[0]?[i,r]:[{_ocp:n?e:r()}]):[{_ocp:e}],e._cxp=n||{updateValue:function(t){return T(e._cxp.data).setProperty(e._cxp.path,t),this}}),e},Y._ucp=function(t,e,i,n){var r=n.tag,a=r?pi(t,r.linkedCtxParam):0;return n.path||Fi("~"+t,i.data,Y._gccb(i)),(n.updateValue||r.updateValue)(e,a,n.tagElse,void 0,r)},Y._ceo=function t(e){for(var i,n=[],r=e.length;r--;)(i=e[r])._cpfn&&((i=w({},i)).prm=t(i.prm)),n.unshift(i);return n},Se=Y.advSet,Y.advSet=function(){Se.call(Y),C._jsv=st._jsv?w(C._jsv||{},{views:dt,bindings:pt}):void 0,ct=st.linkAttr,we=ze+",["+ct+"]",(ht=st._wm).optgroup=ht.option,ht.tbody=ht.tfoot=ht.colgroup=ht.caption=ht.thead,ht.th=ht.td},r.advanced({linkAttr:"data-link",useViews:!1,noValidate:!1,_wm:{option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],svg_ns:[1,"<svg>","</svg>"],div:at.support.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]},_fe:{input:{from:function(t){return t.type===Ee?t[De]:t.value},to:S},textarea:kt,select:kt,optgroup:{to:"label"}}})}return at;function gi(t,e,i,n,r){var a,s,o,l,c,h,d,u,p,g,f,m,_,v,y,b;if(n&&n._tgId&&(n=(v=n)._tgId,v.bindTo||(ki(pt[n],v),v.bindTo=[0])),(n=pt[n])&&(d=n.to))for(d=d[e||0],n=(a=n.linkCtx).elem,y=a.view,!(v=a.tag)&&d._cxp&&(v=d._cxp.path!==x&&d._cxp.tag,l=t[0],(t=[])[d._cxp.ind]=l),v&&(v._.chg=1,(b=v.convertBack)&&(s=P(b)?b:y.getRsc("converters",b))),"SELECT"===n.nodeName?(n.multiple&&null===t[0]&&(t=[[]]),n._jsvSel=t):n._jsvSel&&(y=n._jsvSel,-1<(b=pi(n.value,y))&&!n.checked?y.splice(b,1):b<0&&n.checked&&y.push(n.value),t=[y.slice()]),c=t,m=d.length,s&&(void 0===(t=s.apply(v,t))&&(d=[]),U(t)&&(!1===t.arg0||1!==m&&t.length===m&&!t.arg0)||(t=[t]));m--;)if((u=d[m])&&(o=(u=u+""===u?[a.data,u]:u)[0],p=u.tag,!(void 0===(l=(o&&o._ocp&&!o._vw?c:t)[m])||v&&v.onBeforeUpdateVal&&!1===v.onBeforeUpdateVal(r,{change:"change",data:o,path:u[1],index:m,tagElse:e,value:l}))))if(p)void 0!==(_=p._.toIndex[u.ind])&&p.updateValue(l,_,u.tagElse,void 0,void 0,r),p.setValue(l,u.ind,u.tagElse);else if(void 0!==l&&o){if((p=r&&(h=r.target)._jsvInd===m&&h._jsvLkEl)&&void 0!==(_=p._.fromIndex[m])&&p.setValue(c[m],_,h._jsvElse),o._cpfn)for(f=a._ctxCb,g=o,o=a.data,g._cpCtx&&(o=g.data,f=g._cpCtx);g&&g.sb;)o=f(g),g=g.sb;T(o,i).setProperty(u[1],l,void 0,u.isCpfn)}if(v)return v._.chg=void 0,v}function fi(t){var e,i,n=t.target,r=yi(n),a=je[r];if(!n._jsvTr||t.delegateTarget!==be&&"number"!==n.type||"input"===t.type){for(i=P(r)?r(n):a?at(n)[a]():at(n).attr(r),n._jsvChg=1,hi.lastIndex=0;e=hi.exec(n._jsvBnd);)Wi(i,n._jsvInd,n._jsvElse,void 0,e[1],t);n._jsvChg=void 0}}function gt(t,e){t._df=e,t[(e?"set":"remove")+"Attribute"](Be,"")}function mi(t,e,i,n){var r,a,s,o,l,c,h,d,u,p=!(i===ke||void 0===t||e._noUpd||(i===S||i===B)&&!n&&e.elem._jsvChg),g=e.data,f=n&&n.parentElem||e.elem,m=f.parentNode,_=at(f),v=e.view,y=e._val,b=n;n&&(n._.unlinked=!0,n.parentElem=n.parentElem||e.expr||n._elCnt?f:m,r=n._prv,a=n._nxt),p?(/^css-/.test(i="visible"===i?"css-display":i)?("visible"===e.attr&&(d=(f.currentStyle||ui.call(C,f,"")).display,t?(t=f._jsvd||d)!==ke||(t=ti[h=f.nodeName])||(c=document.createElement(h),document.body.appendChild(c),t=ti[h]=(c.currentStyle||ui.call(C,c,"")).display,document.body.removeChild(c)):(f._jsvd=d,t=ke)),(b=b||y!==t)&&at.style(f,i.slice(4),t)):"link"!==i&&(/^data-/.test(i)?at.data(f,i.slice(5),t):/^prop-/.test(i)?(s=!0,i=i.slice(5)):i===De?(s=!0,t=f.name&&U(t)?(f._jsvSel=t,-1<pi(f.value,t)):t&&"false"!==t):i===Ne?(s=!0,i=De,t=f.value===t):"selected"===i||"disabled"===i||"multiple"===i||"readonly"===i?t=t&&"false"!==t?i:null:i===S&&"SELECT"===f.nodeName&&(f._jsvSel=U(t)?t:""+t),(h=je[i])?i===B?n&&n.inline?(c=n.nodes(!0),n._elCnt&&(r&&r!==a?ji(r,a,f,n._tgId,"^",!0):(d=r?r.getAttribute(ut):f._df,o=n._tgId+"^",u=d.indexOf("#"+o)+1,l=d.indexOf("/"+o),u&&0<l&&(u+=o.length)<l&&(Hi(d.slice(u,l)),d=d.slice(0,u)+d.slice(l),r?r.setAttribute(ut,d):f._df&&gt(f,d))),r=r?r.previousSibling:a?a.previousSibling:f.lastChild),at(c).remove(),o=v.link(v.data,f,r,a,t,n&&{tag:n._tgId})):p&&y!==t&&(_.empty(),o=v.link(g,f,r,a,t,n&&{tag:n._tgId})):f._jsvSel?_[h](t):((b=b||y!==t)&&("text"===i&&f.children&&!f.children[0]?f[Ge]=null===t?"":t:_[h](t)),void 0===(u=m._jsvSel)||i!==S&&void 0!==_.attr(S)||(f.selected=-1<pi(""+t,U(u)?u:[u]))):(b=b||y!==t)&&_[s?"prop":"attr"](i,void 0!==t||s?t:null)),e._val=t,wi(o)):e._val=t}function _i(t,e){var i=this,n=zi(i,Te,i.tag),r=zi(i,Ae,i.tag);if(!n||!1!==n.call(i,t,e)){if(e){var n=e.change,a=e.index,s=e.items;switch(i._.srt=e.refresh,n){case"insert":i.addViews(a,s,e._dly);break;case"remove":i.removeViews(a,s.length,void 0,e._dly);break;case"move":i.moveViews(e.oldIndex,a,s.length);break;case"refresh":i._.srt=void 0,i.fixIndex(0)}}r&&r.call(i,t,e)}}function vi(e){var t,i=e.type,n=e.data,r=e._.bnd;!e._.useKey&&r&&((t=e._.bndArr)&&(at([t[1]]).off(E,t[0]),e._.bndArr=void 0),r!==!!r?i?r._.arrVws[e._.id]=e:delete r._.arrVws[e._.id]:i&&n&&(t=function(t){t.data&&t.data.off||_i.apply(e,arguments)},at([n]).on(E,t),e._.bndArr=[t,n]))}function yi(t,e,i){var n=t.nodeName.toLowerCase(),r=st._fe[n]||t.contentEditable===Ve&&{to:B,from:B};return r?e?"input"===n&&t.type===Ne?Ne:r.to:r.from:e?i?"text":B:""}function bi(t,e,i,n,r,a,s){var o,l,c,h,d=t.parentElem,u=t._prv,p=t._nxt,g=t._elCnt;if(u&&u.parentNode!==d&&ot("Missing parentNode"),s)for(h in c=t.nodes(),g&&u&&u!==p&&ji(u,p,d,t._.id,"_",!0),t.removeViews(void 0,void 0,!0),o=p,g&&(u=u?u.previousSibling:p?p.previousSibling:d.lastChild),at(c).remove(),t._.bnds)$i(h);else{if(e){if(!(l=n[e-1]))return!1;u=l._nxt}g?u=(o=u)?o.previousSibling:d.lastChild:o=u.nextSibling}p=i.render(r,a,t._.useKey&&s,t,s||e,!0),wi(t.link(r,d,u,o,p,l))}function Ci(t,e,i){var n,r;return i?(r="^`",Yi(i),(n=i._tgId)||((pt[n=ei++]=i)._tgId=""+n)):(r="_`",dt[n=e._.id]=e),"#"+n+r+(null!=t?t:"")+"/"+n+r}function xi(t,e,i){var n,r,a,s,o,l,c,h,d,u,p,g=t.tag,f=!g,m=t.convertBack,_=t._hdl;if(e="object"==typeof e&&e,g&&((h=g.convert)&&(h=h===Ve?g.tagCtx.props.convert:h,h=(h=(h=t.view.getRsc("converters",h)||h)&&h.depends)&&Y._dp(h,e,_)),(d=g.tagCtx.props.depends||g.depends)&&(d=Y._dp(d,g,_),h=h?h.concat(d):d),p=g.linkedElems),h=h||[],!t._depends||""+t._depends!=""+h){if(s=t.fn.deps.slice(),t._depends&&(u=t._depends.bdId,T._apply(1,[e],s,t._depends,_,t._ctxCb,!0)),g){for(n=g.boundProps.length;n--;)for(l=g.boundProps[n],r=g._.bnd.paths.length;r--;)(c=g._.bnd.paths[r]["_"+l])&&c.length&&c.skp&&(s=s.concat(c));f=void 0===g.onArrayChange||!0===g.onArrayChange}for(n=s.length;n--;)(o=s[n])._cpfn&&(s[n]=w({},o));if(d=T._apply(f?0:1,[e],s,h,_,t._ctxCb),u||(u=t._bndId||""+ei++,t._bndId=void 0,i._jsvBnd=(i._jsvBnd||"")+"&"+u,t.view._.bnds[u]=u),d.elem=i,d.linkCtx=t,d._tgId=u,h.bdId=u,t._depends=h,pt[u]=d,(p||void 0!==m||g&&g.bindTo)&&ki(d,g,m),p)for(n=p.length;n--;)for(r=(a=p[n])&&a.length;r--;)a[r]._jsvLkEl?a[r]._jsvBnd||(a[r]._jsvBnd="&"+u+"+"):(Ri(a[r]._jsvLkEl=g,a[r]),a[r]._jsvBnd="&"+u+"+");else void 0!==m&&Ri(g,i);g&&!g.inline&&(g.flow||i.setAttribute(ut,(i.getAttribute(ut)||"")+"#"+u+"^/"+u+"^"),g._tgId=""+u)}}function wi(t){var e;if(t)for(;e=t.pop();)e._hdl()}function Si(t,e,i,n,r,a,s){return Mi(this,t,e,i,n,r,a,s)}function Mi(t,e,i,n,r,a,s,o){if(n=!0===n?void(r=n):"object"!=typeof n?void 0:w({},n),t&&e){e=e.jquery?e:at(e),be||(be=document.body,Me="oninput"in be,at(be).on(Ie,fi).on("blur.jsv","[contenteditable]",fi));for(var l,c,h,d,u,p,g,f,m,_,v=Ci,y=n&&"replace"===n.target,b=e.length;b--;){if(g=e[b],_=a||xe(g),""+t===t)Gi(m=[],t,g,_,void 0,"expr",i,n);else{if(void 0!==t.markup)y&&(p=g.parentNode),_._.scp=!0,h=t.render(i,n,r,_,void 0,v,!0),_._.scp=void 0,p?(s=g.previousSibling,o=g.nextSibling,at.cleanData([g],!0),p.removeChild(g),g=p):(s=o=void 0,at(g).empty());else{if(!0!==t||_!==V)break;f={lnk:"top"}}if(g._df&&!o){for(c=(d=ft(g._df,!(l=0),ri)).length;l<c;l++)u=d[l],(u=dt[u.id])&&void 0!==u.data&&u.parent.removeViews(u._.key,void 0,!0);gt(g)}m=_.link(i,g,s,o,h,f,n)}wi(m)}}return e}function Oi(R,l,t,e,m,i,k,F){function n(t,e){var i,n,r,a,s,o=[];if(t){for("@"===t._tkns.charAt(0)&&(e=d.previousSibling,d.parentNode.removeChild(d),d=void 0),h=t.length;h--;){if(a=(p=t[h]).ch,i=p.path)for(c=i.length-1;n=i.charAt(c--);)e="+"===n?"-"===i.charAt(c)?(c--,e.previousElementSibling):e.parentNode:e.lastElementChild;"^"===a?(v=pt[r=p.id])&&(s=e&&(!d||d.parentNode!==e),d&&!s||(v.parentElem=e),p.elCnt&&s&&gt(e,(p.open?"#":"/")+r+a+(e._df||"")),o.push([s?null:d,p])):(u=dt[r=p.id])&&(u.parentElem||(u.parentElem=e||d&&d.parentNode||l,u._.onRender=Ci,u._.onArrayChange=_i,vi(u)),s=u.parentElem,p.open?(u._elCnt=p.elCnt,e&&!d?gt(e,"#"+r+a+(e._df||"")):(u._prv||gt(s,Ti(s._df,"#"+r+a)),u._prv=d)):(!e||d&&d.parentNode===e?d&&(u._nxt||gt(s,Ti(s._df,"/"+r+a)),u._nxt=d):(gt(e,"/"+r+a+(e._df||"")),u._nxt=void 0),(a=zi(u,Pe)||it)&&a.call(u.ctx.tag,u)))}for(h=o.length;h--;)D.push(o[h])}return!t||t.elCnt}function V(t){var e,i,n;if(t)for(h=t.length,c=0;c<h;c++)if(p=t[c],!(v=pt[p.id])._is&&v.linkCtx&&(i=v=v.linkCtx.tag,n=v.tagName===z,!v.flow||n)){if(!B){for(e=1;i=i.parent;)e++;j=j||e}!B&&e!==j||z&&!n||$.push(v)}}var _,v,r,a,c,h,s,d,u,p,o,g,f,U,y,$,B,z,b,C,j,H,W,X,x,w,S,Y,M,O,q,G,I,K,Z,T,J,A,Q=this._.id+"_",P="",D=[],E=[],tt=[],et=[],it=zi(this,Pe),nt=n;if(i&&(i.tmpl?f="/"+i._.id+"_":(J=i.lnk,i.tag&&(Q=i.tag+"^",i=!0),(A=i.get)&&(nt=V,$=A.tags,B=A.deep,z=A.name)),i=!0===i),l=l?""+l===l?at(l)[0]:l.jquery?l[0]:l:this.parentElem||document.body,C=!st.noValidate&&l.contentEditable!==Ve,x=l.tagName.toLowerCase(),O=!!Ze[x],t=t&&Di(t,O),e=e&&Di(e,O)||null,null!=m){if(S=Y=document.createElement("div"),K=I="",G="http://www.w3.org/2000/svg"===l.namespaceURI?"svg_ns":(G=bt.exec(m))&&G[1]||"",O){for(y=e;y&&!(U=ft(y));)y=y.nextSibling;(M=U?U._tkns:l._df)&&(g=f||"",!i&&f||(g+="#"+Q),(c=M.indexOf(g))+1&&(c+=g.length,K=I=M.slice(0,c),M=M.slice(c),U?y.setAttribute(ut,M):gt(l,M)))}if(w=void 0,m=(""+m).replace(ni,function(t,e,i,n,r,a,s,o,l,c,h,d,u,p){var g,f="";return p?(_=0,t):(v=(l||c||"").toLowerCase(),n=n||h,i=i||u,w&&!i&&(!t||n||v||a&&!_)&&(w=void 0,x=E.shift()),(n=n||i)&&(n=n.toLowerCase(),w=void(_=0),C&&(i||u?Qe[x]||/;svg;|;math;/.test(";"+E.join(";")+";")||(g="'<"+x+".../"):Qe[n]?g="'</"+n:E.length&&n===x||(g="Mismatch: '</"+n),g&&lt(g+">' in:\n"+m)),q=O,x=E.shift(),O=Ze[x],h=h?"</"+h+">":"",q&&(P+=I,I="",O?P+="-":(f=h+$e+"@"+P+Ue+(d||""),P=tt.shift()))),O&&!_?(a?I+=a:e=h||u||"",v&&(e+=v,I&&(e+=" "+ut+'="'+I+'"',I=""))):e=a?e+f+r+(_?"":$e+a+Ue)+o+v:f||t,C&&s&&(_&&lt("{^{ within elem markup ("+_+' ). Use data-link="..."'),"#"===a.charAt(0)?E.unshift(a.slice(1)):a.slice(1)!==(p=E.shift())&&lt("Closing tag for {^{...}} under different elem: <"+p+">")),v&&(_=v,E.unshift(x),x=v.slice(1),C&&E[0]&&E[0]===Je[x]&&ot("Parent of <tr> must be <tbody>"),w=Qe[x],(O=Ze[x])&&!q&&(tt.unshift(P),P=""),q=O,P&&O&&(P+="+")),e)}),C&&E.length&&lt("Mismatched '<"+x+"...>' in:\n"+m),F)return;for(qe.appendChild(Y),H=(G=ht[G]||ht.div)[0],S.innerHTML=G[1]+m+G[2];H--;)S=S.lastChild;for(qe.removeChild(Y),W=document.createDocumentFragment();X=S.firstChild;)W.appendChild(X);l.insertBefore(W,e)}var N,L="",rt={},i=we+(A?",["+Be+"]":"");for(s=Ke?l.querySelectorAll(i):at(i,l).get(),a=s.length,t&&t.innerHTML&&(t=(f=Ke?t.querySelectorAll(i):at(i,t).get()).length?f[f.length-1]:t),r=j=0;r<a;r++)if(d=s[r],t&&!Z)Z=d===t;else{if(e&&d===e){A&&(L+=Ai(d));break}if(d.parentNode)if(A){if(L+=Ai(d),d._df){for(N=r+1;N<a&&d.contains(s[N]);)N++;rt[N-1]=d._df}rt[r]&&(L+=rt[r]||"")}else!(T=J&&(p=ft(d,void 0,si))&&(p=p[0])?T?p.id!==T&&T:p.open&&p.id:T)&&nt(ft(d))&&d.getAttribute(ct)&&D.push([d])}if(A&&V(ft(L=(i=(L=(i=(L+=l._df||"").indexOf("#"+A.id)+1)?L.slice(i+A.id.length):L).indexOf("/"+A.id))+1?L.slice(0,i):L,void 0,li)),void 0===m&&l.getAttribute(ct)&&D.push([l]),Pi(t,O),Pi(e,O),!A)for(O&&P+I&&(d=e,P&&(e?n(ft(P+"+",!0),e):n(ft(P,!0),l)),n(ft(I,!0),l),e&&(L=e.getAttribute(ut),(a=L.indexOf(K)+1)&&(L=L.slice(a+K.length-1)),e.setAttribute(ut,I+L))),a=D.length,r=0;r<a;r++)d=D[r],o=d[1],d=d[0],o?(v=pt[o.id])&&((b=v.linkCtx)&&((v=b.tag).linkCtx=b),o.open?(d&&(v.parentElem=d.parentNode,v._prv=d),v._elCnt=o.elCnt,u=v.tagCtx.view,Gi(et,void 0,v._prv,u,o.id)):(v._nxt=d,v._.unlinked&&!v._toLk&&(b=v.tagCtx,u=b.view,Ei(v)))):Gi(et,d.getAttribute(ct),d,xe(d),void 0,J,R,k);return et}function Gi(t,e,i,n,r,a,s,o){var l,c,h,d,u,p,g,f,m,_,v=[];if(r)p=(_=(_=pt[r]).linkCtx?_.linkCtx.tag:_).linkCtx||{type:"inline",data:n.data,elem:_._elCnt?_.parentElem:i,view:n,ctx:n.ctx,attr:B,fn:_._.bnd,tag:_,_bndId:r},Ii(_.linkCtx=p,t),_._toLk=p._bndId;else if(e&&i){for(s=a?s:n.data,l=n.tmpl,r=e,_=yi(i),e=(r=at.trim(r)).slice(-1)!==b?r=y+":"+r+(_?":":"")+b:r,m=Ce.lastIndex=0;c=Ce.exec(e);)v.push(c),m=Ce.lastIndex;for(m<e.length&&lt(e);c=v.shift();){for(g=Ce.lastIndex,u=c[1],d=c[3];v[0]&&"else"===v[0][4];)d+=j+z+v.shift()[3],f=!0;f&&(d+=j+z+y+"/"+c[4]+b),p={type:a||"link",data:s,elem:i,view:n,ctx:o,attr:u,_toLk:1,_noUpd:c[2]},h=void 0,c[6]&&(h=c[10]||void 0,p.convert=c[5]||"",void 0!==h&&yi(i)&&(u&&lt(d+"- Remove target: "+u),p.convertBack=h=h.slice(1))),p.expr=u+d,(u=Ye[d])||(Ye[d]=u=Y.tmplFn(d.replace(_t,"\\$&"),l,!0,h,f)),p.fn=u,Ii(p,t),Ce.lastIndex=g}}}function Ii(i,t){function e(t,e){e&&e.refresh||!function(t,e){var i,n,r,a,s,o,l,c=this,h=c.fn,d=c.tag,u=c.data,p=c.elem,g=c.convert,f=p.parentNode,m=c.view,_=m._lc,v=e&&zi(m,Te,d);if(f&&(!v||!1!==v.call(d||c,t,e))&&(!e||"*"===t.data.prop||t.data.prop===e.path)){if(m._lc=c,e||c._toLk){if(c._toLk=0,h._er)try{i=h(u,m,Y)}catch(t){r=h._er,i=[{props:{},args:[a=le(t,m,new Function("data,view","return "+r+";")(u,m))],tag:d}]}else i=h(u,m,Y);if(f=d&&d.attr||c.attr||(c._dfAt=yi(p,!0,void 0!==g)),c._dfAt===S&&(d&&d.parentElem||c.elem).type===Ee&&(f=De),d){if(s=r||d._er,i=i[0]?i:[i],n=!s&&(!1===d.onUpdate||e&&P(d.onUpdate)&&!1===d.onUpdate(t,e,i)),Vi(d,i,s),d._.chg&&(f===B||f===S)||n||f===ke)return Ei(d,t,e),d._.chg||xi(c,u,p),m._lc=_,e&&(v=zi(m,Ae,d))&&v.call(d||c,t,e),void(d.tagCtx.props.dataMap&&d.tagCtx.props.dataMap.map(d.tagCtx.args[0],d.tagCtx,d.tagCtx.map,M||!d._.bnd));for(d.onUnbind&&d.onUnbind(d.tagCtx,c,d.ctx,t,e),d.linkedElems=d.linkedElem=d.mainElem=d.displayElem=void 0,l=d.tagCtxs.length;l--;)(o=d.tagCtxs[l]).linkedElems=o.mainElem=o.displayElem=void 0;i=":"===d.tagName?Y._cnvt(d.convert,m,i[0]):Y._tag(d,m,m.tmpl,i,!0,a)}else h._tag&&(i=(g=""===g?Ve:g)?Y._cnvt(g,m,i[0]||i):Y._tag(h._tag,m,m.tmpl,i,!0,a),Yi(d=c.tag),f=c.attr||f);(s=d&&(!d.inline||c.fn._lr)&&d.template)&&xi(c,u,p),mi(i,c,f,d),c._noUpd=0,d&&(d._er=r,Ei(d,t,e))}s||xi(c,u,p),d&&d._.ths&&d.updateValue(d,d.bindTo?d.bindTo.length:1),e&&(v=zi(m,Ae,d))&&v.call(d||c,t,e),m._lc=_}}.call(i,t,e)}var n,r,a,s,o=i.type;"top"!==o&&"expr"!==o||(i.view=new Y.View(Y.extendCtx(i.ctx,i.view.ctx),"link",i.view,i.data,i.expr,void 0,Ci)),i._ctxCb=Y._gccb(n=i.view),i._hdl=e,"SELECT"===i.elem.nodeName&&(i.elem._jsvLkEl||"link"===o&&!i.attr&&void 0!==i.convert)&&(a=i.elem,(s=at(a)).on("jsv-domchange",function(){arguments[3].refresh||(a._jsvLkEl?s.val(a._jsvLkEl.cvtArgs(a._jsvElse,1)[a._jsvInd]):i.tag?s.val(i.tag.cvtArgs(0,1)):(r=i.fn(n.data,n,Y),s.val(i.convert||i.convertBack?Y._cnvt(i.convert,n,r):r)))})),i.fn._lr?(i._toLk=1,t.push(i)):e(!0)}function Ti(t,e){var i;return t?(i=t.indexOf(e))+1?t.slice(0,i)+t.slice(i+e.length):t:""}function Ai(t){return t&&(""+t===t?t:t.tagName===Fe?t.type.slice(3):1===t.nodeType&&t.getAttribute(ut)||"")}function ft(t,e,i){var s,o=[];if(e=e?t:Ai(t))return s=o.elCnt=t.tagName!==Fe,s="@"===e.charAt(0)||s,(o._tkns=e).replace(i||ci,function(t,e,i,n,r,a){o.push({elCnt:s,id:n,ch:r,open:e,close:i,path:a,token:t})}),o}function Pi(t,e){t&&("jsv"===t.type?t.parentNode.removeChild(t):e&&""===t.getAttribute(ct)&&t.removeAttribute(ct))}function Di(t,e){for(var i=t;e&&i&&1!==i.nodeType;)i=i.previousSibling;return i&&(1!==i.nodeType?((i=document.createElement(Fe)).type="jsv",t.parentNode.insertBefore(i,t)):Ai(i)||i.getAttribute(ct)||i.setAttribute(ct,"")),i}function Ei(t,e,i){function n(){(r=b.linkedElems||t.linkedElems||t.linkedElem&&[t.linkedElem])&&(t.linkedElems=b.linkedElems=r,t.linkedElem=r[0]=t.linkedElem||r[0]),(s=b.mainElem||t.mainElem)&&(b.mainElem=t.mainElem=s),(s=b.displayElem||t.displayElem)&&(b.displayElem=t.displayElem=s)}var r,a,s,o,l,c,h,d,u,p,g,f,m,_,v,y,b=t.tagCtx,C=t.tagCtxs,x=C&&C.length,w=t.linkCtx,S=t.bindTo||{};if(t._.unlinked){if(c=at(w.elem),t.linkedElement||t.mainElement||t.displayElement){if(a=t.linkedElement)for(t.linkedElem=void 0,o=a.length;o--;)if(a[o])for(h=!t.inline&&c.filter(a[o]),l=x;l--;)p=C[l],r=p.linkedElems=p.linkedElems||new Array(o),(s=h[0]?h:p.contents(!0,a[o]))[0]&&s[0].type!==Ne&&(r[o]=s.eq(0));if(a=t.mainElement)for(h=!t.inline&&c.filter(a),l=x;l--;)p=C[l],(s=h[0]?h:p.contents(!0,a).eq(0))[0]&&(p.mainElem=s);if(a=t.displayElement)for(h=!t.inline&&c.filter(a),l=x;l--;)p=C[l],(s=h[0]?h:p.contents(!0,a).eq(0))[0]&&(p.displayElem=s);n()}t.onBind&&(t.onBind(b,w,t.ctx,e,i),n())}for(l=x;l--;){if(g=(p=C[l]).props,t._.unlinked&&p.map&&t.mapProps){for(v=t.mapProps.length,y=g.mapDepends||t.mapDepends||[],y=U(y)?y:[y];v--;){var M=t.mapProps[v];(M=t._.bnd.paths[l]["_"+M])&&M.length&&M.skp&&(y=y.concat(M))}y.length&&p.map.observe(y,w)}(s=p.mainElem||!t.mainElement&&p.linkedElems&&p.linkedElems[0])&&(s[0]&&g.id&&!s[0].id&&(s[0].id=g.id),t.setSize&&((f=!S.height&&g.height||t.height)&&s.height(f),(f=!S.width&&g.width||t.width)&&s.width(f))),(f=(s=p.displayElem||s)&&(!S.class&&g.class||t.className))&&f!==(m=s[0]._jsvCl)&&(s.hasClass(m)&&s.removeClass(m),s.addClass(f),s[0]._jsvCl=f)}if(t.onAfterLink&&(t.onAfterLink(b,w,t.ctx,e,i),n()),!t.flow&&!t._.chg)for(t._tgId&&t._.unlinked&&(t.linkedElems||t.bindTo)&&ki(pt[t._tgId],t),l=C.length;l--;){for(o=(g=t.cvtArgs(l,1)).length;o--;)t.setValue(g[o],o,l,e,i);if(t._.unlinked)for(b=C[l],r=b.linkedElems||!l&&t.linkedElem&&[t.linkedElem],_=(t.bindTo||[0]).length;_--;)if((s=r&&r[_])&&(o=s.length))for(;o--;)(u=(d=s[o])._jsvLkEl)&&u===t||(d._jsvLkEl=t,d._jsvInd=_,d._jsvElse=l,Ri(t,d),t._tgId&&(d._jsvBnd="&"+t._tgId+"+"))}t._.unlinked=void 0,t._.lt&&t.refresh()}function Ni(t){var e=t.which;15<e&&e<21||32<e&&e<41||111<e&&e<131||27===e||144===e||setTimeout(function(){fi(t)})}function Li(t,e,i){!0!==e||!Me||Oe&&t[0].contentEditable===Ve?t[i](e=""+e===e?e:"keydown.jsv",0<=e.indexOf("keydown")?Ni:fi):t[i]("input.jsv",fi)}function Ri(t,e){var i,n=e._jsvTr||!1;n!==(i=(i=void 0===(i=t&&void 0===(i=t.tagCtx.props.trigger)?t.trigger:i)?F.trigger:i)&&("INPUT"===e.tagName&&e.type!==Ee&&e.type!==Ne||"textarea"===e.type||e.contentEditable===Ve)&&i||!1)&&(Li(t=at(e),n,"off"),Li(t,e._jsvTr=i,"on"))}function ki(t,e,i){var n,r,a,s,o,l,c,h,d,u,p,g,f=1,m=[],_=t.linkCtx,v=_.data,y=_.fn.paths;if(t&&!t.to){for(e&&(e.convertBack||(e.convertBack=i),o=e.bindTo,f=e.tagCtxs?e.tagCtxs.length:1);f--;){if(u=[],d=y[f])for(o=d._jsvto?["jsvto"]:o||[0],l=(o=!f&&e&&e._.ths?o.concat("this"):o).length;l--;){if(n="",h=_._ctxCb,p=(c=d[+(c=o[l])===c?c:"_"+c])&&c.length){if((r=c[p-1])._cpfn){for(a=r;r.sb&&r.sb._cpfn;)n=r=r.sb;n=r.sb||n&&n.path,g=r._cpfn&&!r.sb,r=n?n.slice(1):a.path}s=n?[a,r]:Fi(r,v,h)}else c=e.linkedCtxParam,s=[],(p=e._.fromIndex)&&c&&c[p[l]]&&(s=[e.tagCtxs[f].ctx[c[p[l]]][0],x]);(s=(h=s._cxp)&&h.tag&&r.indexOf(".")<0?h:s).isCpfn=g,u.unshift(s)}m.unshift(u)}t.to=m}}function Fi(t,e,i){for(var n,r,a,s,o,l,c;t&&t!==x&&(r=i(n=t.split("^").join(".")))&&(a=r.length);){if(s=r[0]._cxp)if(l=l||s,o=r[0][0],x in o?o=(c=o)._vw:c=o.data,l.path=t=r[0][1],r=[l.data=c,t],i=Y._gccb(o),t._cpfn){for((o=t).data=r[0],o._cpCtx=i;t.sb&&t.sb._cpfn;)n=t=t.sb;r=[o,t=(n=t.sb||n&&n.path)?n.slice(1):o.path]}else s.tag&&s.path===x&&(r=s);else r=1<a?[r[a-2],r[a-1]]:[r[a-1]];e=r[0],t=r[1]}return(r=r||[e,n])._cxp=l,r}function Vi(t,e,i){var n,r,a=t.tagCtx.view,s=t.tagCtxs||[t.tagCtx],o=s.length,l=!e;if(l){if((e=t._.bnd.call(a.tmpl,(t.linkCtx||a).data,a,Y)).lt)return;t._.lt=void 0,e=U(e)?e:[e]}if(i)s=t.tagCtxs=e,t.tagCtx=s[0],Yi(t);else for(;o--;)n=s[o],r=e[o],w(n.ctx,r.ctx),n.args=r.args,l&&(n.tmpl=r.tmpl),T(n.props).setProperty(r.props);return Y._thp(t,s[0]),s}function Ui(t){for(var e,i,n,r=[],a=t.length,s=a;s--;)r.push(t[s]);for(s=a;s--;)if((i=r[s]).parentNode){if(n=i._jsvBnd)for(n=n.slice(1).split("&"),i._jsvBnd="",e=n.length;e--;)$i(n[e],i._jsvLkEl,i);Hi(Ai(i)+(i._df||""),i)}}function $i(t,e,i){var n,r,a,s,o,l,c,h,d,u,p,g=pt[t];if(e)i._jsvLkEl=void 0;else if(g&&(!i||i===g.elem)){for(n in delete pt[t],g.bnd)(r=g.bnd[n])&&(a=g.cbId,(U(r)?at([r]).off(E+a):at(r)).off(D+a),delete g.bnd[n]);if(e=g.linkCtx){if(i=e.tag){if(s=i.tagCtxs)for(o=s.length;o--;)(l=(d=s[o]).map)&&l.unmap(),(u=d.linkedElems)&&(p=(p||[]).concat(u));i.onUnbind&&i.onUnbind(i.tagCtx,e,i.ctx),i.onDispose&&i.onDispose(),i._elCnt||(i._prv&&i._prv.parentNode.removeChild(i._prv),i._nxt&&i._nxt.parentNode.removeChild(i._nxt))}for(o=(u=p||[at(e.elem)]).length;o--;)(h=(c=u[o])&&c[0]&&c[0]._jsvTr)&&(Li(c,h,"off"),c[0]._jsvTr=void 0);"link"===(i=e.view).type?i.parent.removeViews(i._.key,void 0,!0):delete i._.bnds[t]}delete m[g.cbId]}}function Bi(t){t?((t=t.jquery?t:at(t)).each(function(){for(var t;(t=xe(this,!0))&&t.parent;)t.parent.removeViews(t._.key,void 0,!0);Ui(this.getElementsByTagName("*"))}),Ui(t)):(be&&(at(be).off(Ie,fi).off("blur.jsv","[contenteditable]",fi),be=void 0),V.removeViews(),Ui(document.body.getElementsByTagName("*")))}function zi(t,e,i){return i&&i[e]||t.ctx[e]&&t.ctxPrm(e)||d.helpers[e]}function ji(t,e,i,n,r,a){var s,o,l,c,h,d,u=0,p=t===e;if(t){for(s=0,o=(l=ft(t)||[]).length;s<o;s++){if((d=(c=l[s]).id)===n&&c.ch===r){if(!a)break;o=0}p||(h="_"===c.ch?dt[d]:pt[d].linkCtx.tag)&&(c.open?h._prv=e:c.close&&(h._nxt=e)),u+=d.length+2}u&&t.setAttribute(ut,t.getAttribute(ut).slice(u)),(t=(o=(t=e?e.getAttribute(ut):i._df).indexOf("/"+n+r)+1)?l._tkns.slice(0,u)+t.slice(o+(a?-1:n.length+1)):t)&&(e?e.setAttribute(ut,t):gt(i,t))}else gt(i,Ti(i._df,"#"+n+r)),a||e||gt(i,Ti(i._df,"/"+n+r))}function Hi(t,e){var i,n,r,a;if(a=ft(t,!0,ai))for(i=0,n=a.length;i<n;i++)"_"===(r=a[i]).ch?!(r=dt[r.id])||!r.type||e&&r._prv!==e&&r.parentElem!==e||r.parent.removeViews(r._.key,void 0,!0):$i(r.id,void 0,e)}function Wi(t,e,i,n,r,a){var s=[];return this&&this._tgId&&(r=this),arguments.length<4&&(+e!==e?(n=e,i=e=0):+i!==i&&(n=i,i=0)),s[e||0]=t,gi(s,i,n,r,a),this}function Xi(){for(var t=this.tag.bindTo.length,e=arguments[t],i=arguments[t+1];t--;)this.tag.setValue(arguments[t],t,this.index,e,i)}function Yi(t){var l,e,i,n,r,a,c,s;if(t.contents=function(t,e){t!==!!t&&(e=t,t=void 0);var i,n=at(this.nodes());return n[0]&&(i=(e=t?e||"*":e)?n.filter(e):n,n=t?i.add(n.find(e)):i),n},t.nodes=function(t,e,i){var n,r=this.contentView||this,a=r._elCnt,s=!e&&a,o=[];if(!r.args)for(e=e||r._prv,i=i||r._nxt,n=s?e===r._nxt?r.parentElem.lastSibling:e:!1===r.inline?e||r.linkCtx.elem.firstChild:e&&e.nextSibling;n&&(!i||n!==i);)(t||a||n.tagName!==Fe)&&o.push(n),n=n.nextSibling;return o},t.childTags=function(t,e){t!==!!t&&(e=t,t=void 0);var i=this.contentView||this,n=i.link?i:i.tagCtx.view,r=i._prv,a=i._elCnt,s=[];return i.args||n.link(void 0,i.parentElem,a?r&&r.previousSibling:r,i._nxt,void 0,{get:{tags:s,deep:t,name:e,id:i.link?i._.id+"_":i._tgId+"^"}}),s},"tag"===t._is){for(e=(c=t).tagCtxs.length;e--;)(i=c.tagCtxs[e]).setValues=Xi,i.contents=t.contents,i.childTags=t.childTags,i.nodes=t.nodes;if(n=c.boundProps=c.boundProps||[],r=c.bindFrom)for(l=r.length;l--;)(a=r[l])+""===a&&(r[a]=1,pi(a,n)<0&&n.push(a));c.setValue=Y._gm(c.constructor.prototype.setValue||function(t){return t},function(t,e,i,n,r){e=e||0;var a,s,o=c.tagCtxs[i=i||0];if(!o._bdArgs||!r&&void 0===t||o._bdArgs[e]!==t||r&&"set"===r.change&&(n.target===t||r.value===t)?(o._bdArgs=o._bdArgs||[],o._bdArgs[e]=t,void 0!==(i=c.base.call(c,t,e,i,n,r))&&(o._bdVals=o._bdVals||[],t=o._bdVals[e]=i)):o._bdVals&&(t=o._bdVals[e]),void 0!==t&&(n=c.linkedCtxParam)&&n[e]&&o.ctxPrm(n[e],t),void 0!==(r=c._.toIndex[e])&&(i=o.linkedElems||c.linkedElem&&[c.linkedElem])&&(a=i[r])&&(l=a.length))for(;l--;)s=a[l],void 0===t||s._jsvChg||c.linkCtx._val===t||(void 0!==s.value?s.type===Ee?s[De]=at.isArray(t)?-1<at.inArray(s.value,t):t&&"false"!==t:s.type===Ne?s[De]=s.value===t:at(s).val(t):s[s.contentEditable===Ve?"innerHTML":Ge]=t),o.props.name&&(s.name=s.name||o.props.name);return c}),c.updateValue=Wi,c.updateValues=function(){var t,e,i=this.bindTo?this.bindTo.length:1,n=arguments.length-i;return n&&(t=arguments[i],1<n?e=1<n?arguments[i+1]:void 0:+t!==t&&(e=t,t=0)),gi(arguments,t,e,this)},c.setValues=function(){return Xi.apply(c.tagCtx,arguments),c},c.refresh=function(){var t,e,i=c.linkCtx,n=c.tagCtx.view;if(e=Vi(c))return c.onUnbind&&(c.onUnbind(c.tagCtx,i,c.ctx),c._.unlinked=!0),t=c.inline?B:i.attr||yi(c.parentElem,!0),e=":"===c.tagName?Y._cnvt(c.convert,n,c.tagCtx):Y._tag(c,n,n.tmpl,e,!0),xi(i,i.data,i.elem),mi(e,i,t,c),Ei(c),c},c.domChange=function(){var t=this.parentElem,e=at._data(t).events,i="jsv-domchange";e&&e[i]&&at(t).triggerHandler(i,arguments)}}else(s=t).addViews=function(t,e,i){var n,r=this,a=e.length,s=r.views;!r._.useKey&&a&&(n=s.length+a,!i&&n!==r.data.length||!1===bi(r,t,r.tmpl,s,e,r.ctx)||r._.srt||r.fixIndex(t+a))},s.removeViews=function(t,e,o,i){function n(t){var e,i,n,r,a,s,t=h[t];if(t&&t.link){for(i in e=t._.id,o||(s=t.nodes()),t.removeViews(void 0,void 0,!0),t.type=void 0,r=t._prv,a=t._nxt,n=t.parentElem,o||(t._elCnt&&ji(r,a,n,e,"_"),at(s).remove()),!t._elCnt&&r&&(r.parentNode.removeChild(r),a.parentNode.removeChild(a)),vi(t),t._.bnds)$i(i);delete dt[e]}}var r,a,s,l=this,c=!l._.useKey,h=l.views;if(c&&(s=h.length),void 0===t)if(c){for(r=s;r--;)n(r);l.views=[]}else{for(a in h)n(a);l.views={}}else if(void 0===e&&(c?e=1:(n(t),delete h[t])),c&&e&&(i||s-e===l.data.length)){for(r=t+e;r-- >t;)n(r);h.splice(t,e),l._.srt||l.fixIndex(t)}},s.moveViews=function(t,e,i){function n(t,e){return RegExp("^(.*)("+(e?"\\/":"#")+t._.id+"_.*)$").exec(e||t._prv.getAttribute(ut))}function r(t,e){var r,a=t._prv;a.setAttribute(ut,e),e.replace(oi,function(t,e,i,n){(r=pt[n].linkCtx.tag).inline&&(r[e?"_prv":"_nxt"]=a)}),e.replace(si,function(t,e,i,n){dt[n][e?"_prv":"_nxt"]=a})}var a,s,o,l,c=this,h=c._nxt,d=c.views,u=e<t,p=u?e:t,g=u?t:e,f=e,m=[],t=d.splice(t,i);for(e>d.length&&(e=d.length),d.splice.apply(d,[e,0].concat(t)),o=e+(i=t.length),g+=i;f<o;f++)a=(s=d[f]).nodes(!0),m=c._elCnt?m.concat(a):m.concat(s._prv,a,s._nxt);m=at(m),o<d.length?m.insertBefore(d[o]._prv):h?m.insertBefore(h):m.appendTo(c.parentElem),c._elCnt&&(d[p-1],e=d[p],t=d[u?p+i:g-i],u=d[g],i=n(e),r(e,(e=n(t))[1]+i[2]),u?(l=n(u),r(u,i[1]+l[2])):(d[g-1]._nxt=h)?(l=n(c,h.getAttribute(ut)),h.setAttribute(ut,i[1]+l[2])):(l=n(c,c.parentElem._df),gt(c.parentElem,i[1]+l[2])),r(t,l[1]+e[2])),c.fixIndex(p)},s.refresh=function(){var t=this,e=t.parent;return e&&(bi(t,t.index,t.tmpl,e.views,t.data,void 0,!0),vi(t)),t},s.fixIndex=function(t){for(var e=this.views,i=e.length;t<i--;)e[i].index!==i&&T(e[i]).setProperty("index",i)},s.link=Oi}function qi(t,e,i,n){for(var r=t.length;r--&&t[r].key!==e;);-1===r?e&&!n&&t.push({key:e,prop:i}):n&&t.splice(r,1)}},window),function(c){c.fn.rwdImageMaps=function(){var t=this;return c(window).resize(function(){t.each(function(){var e;void 0!==c(this).attr("usemap")&&(e=c(this),c("<img />").on("load",function(){var r=e.attr("width"),a=e.attr("height"),s=(r&&a||((t=new Image).src=e.attr("src"),r=r||t.width,a=a||t.height),e.width()/100),o=e.height()/100,t=e.attr("usemap").replace("#",""),l="coords";c('map[name="'+t+'"]').find("area").each(function(){for(var t=c(this),e=(t.data(l)||t.data(l,t.attr(l)),t.data(l).split(",")),i=new Array(e.length),n=0;n<i.length;++n)i[n]=n%2==0?parseInt(e[n]/r*100*s):parseInt(e[n]/a*100*o);t.attr(l,i.toString())})}).attr("src",e.attr("src")))})}).trigger("resize"),this}}(jQuery),function(t){function r(t,e){this.setNotifyMethod(t),this.setNotifyContext(e)}function n(t,e,i){this.name=t,this.body=e,this.type=i}function e(){}function i(){}function a(){this.subCommands=[],this.initializeMacroCommand()}function s(t,e){this.mediatorName=t||this.constructor.NAME,this.viewComponent=e}function o(t,e){this.proxyName=t||this.constructor.NAME,null!=e&&this.setData(e)}function l(t){if(null!=l.instanceMap[t])throw Error(l.MULTITON_MSG);this.initializeNotifier(t),(l.instanceMap[t]=this).initializeFacade()}function c(t){if(null!=c.instanceMap[t])throw Error(c.MULTITON_MSG);this.multitonKey=t,(c.instanceMap[this.multitonKey]=this).mediatorMap=[],this.observerMap=[],this.initializeView()}function h(t){if(h.instanceMap[t])throw Error(h.MULTITON_MSG);this.multitonKey=t,(h.instanceMap[t]=this).proxyMap=[],this.initializeModel()}function d(t){if(null!=d.instanceMap[t])throw Error(d.MULTITON_MSG);this.multitonKey=t,(d.instanceMap[this.multitonKey]=this).commandMap=[],this.initializeController()}function u(t,e,i){for(var n,r,t=t.split("."),i=i||p.global,a=0,s=t.length;a<s;a++)i=null==(n=i)[r=t[a]]?i[r]={}:i[r];return null==e?i:n[r]=e}var p;(t=null==t?window:t).puremvc||(r.prototype.setNotifyMethod=function(t){this.notify=t},r.prototype.setNotifyContext=function(t){this.context=t},r.prototype.getNotifyMethod=function(){return this.notify},r.prototype.getNotifyContext=function(){return this.context},r.prototype.notifyObserver=function(t){this.getNotifyMethod().call(this.getNotifyContext(),t)},r.prototype.compareNotifyContext=function(t){return t===this.context},r.prototype.notify=null,r.prototype.context=null,n.prototype.getName=function(){return this.name},n.prototype.setBody=function(t){this.body=t},n.prototype.getBody=function(){return this.body},n.prototype.setType=function(t){this.type=t},n.prototype.getType=function(){return this.type},n.prototype.toString=function(){return"Notification Name: "+this.getName()+"\nBody:"+(null==this.body?"null":this.body.toString())+("\nType:"+(null==this.type?"null":this.type))},n.prototype.name=null,n.prototype.type=null,n.prototype.body=null,e.prototype.sendNotification=function(t,e,i){var n=this.getFacade();n&&n.sendNotification(t,e,i)},e.prototype.initializeNotifier=function(t){this.multitonKey=""+t,this.facade=this.getFacade()},e.prototype.getFacade=function(){if(null==this.multitonKey)throw Error(e.MULTITON_MSG);return l.getInstance(this.multitonKey)},e.prototype.multitonKey=null,e.MULTITON_MSG="multitonKey for this Notifier not yet initialized!",((i.prototype=new e).constructor=i).prototype.execute=function(){},((a.prototype=new e).constructor=a).prototype.subCommands=null,a.prototype.initializeMacroCommand=function(){},a.prototype.addSubCommand=function(t){this.subCommands.push(t)},a.prototype.execute=function(t){for(;0<this.subCommands.length;){var e=new(this.subCommands.shift());e.initializeNotifier(this.multitonKey),e.execute(t)}},s.NAME="Mediator",((s.prototype=new e).constructor=s).prototype.getMediatorName=function(){return this.mediatorName},s.prototype.setViewComponent=function(t){this.viewComponent=t},s.prototype.getViewComponent=function(){return this.viewComponent},s.prototype.listNotificationInterests=function(){return[]},s.prototype.handleNotification=function(){},s.prototype.onRegister=function(){},s.prototype.onRemove=function(){},s.prototype.mediatorName=null,s.prototype.viewComponent=null,o.NAME="Proxy",((o.prototype=new e).constructor=o).prototype.getProxyName=function(){return this.proxyName},o.prototype.setData=function(t){this.data=t},o.prototype.getData=function(){return this.data},o.prototype.onRegister=function(){},o.prototype.onRemove=function(){},o.prototype.proxyName=null,o.prototype.data=null,l.prototype.initializeFacade=function(){this.initializeModel(),this.initializeController(),this.initializeView()},l.getInstance=function(t){return null==t?null:(null==l.instanceMap[t]&&(l.instanceMap[t]=new l(t)),l.instanceMap[t])},l.prototype.initializeController=function(){null==this.controller&&(this.controller=d.getInstance(this.multitonKey))},l.prototype.initializeModel=function(){null==this.model&&(this.model=h.getInstance(this.multitonKey))},l.prototype.initializeView=function(){null==this.view&&(this.view=c.getInstance(this.multitonKey))},l.prototype.registerCommand=function(t,e){this.controller.registerCommand(t,e)},l.prototype.removeCommand=function(t){this.controller.removeCommand(t)},l.prototype.hasCommand=function(t){return this.controller.hasCommand(t)},l.prototype.registerProxy=function(t){this.model.registerProxy(t)},l.prototype.retrieveProxy=function(t){return this.model.retrieveProxy(t)},l.prototype.removeProxy=function(t){var e=null;return e=null!=this.model?this.model.removeProxy(t):e},l.prototype.hasProxy=function(t){return this.model.hasProxy(t)},l.prototype.registerMediator=function(t){null!=this.view&&this.view.registerMediator(t)},l.prototype.retrieveMediator=function(t){return this.view.retrieveMediator(t)},l.prototype.removeMediator=function(t){var e=null;return e=null!=this.view?this.view.removeMediator(t):e},l.prototype.hasMediator=function(t){return this.view.hasMediator(t)},l.prototype.sendNotification=function(t,e,i){this.notifyObservers(new n(t,e,i))},l.prototype.notifyObservers=function(t){null!=this.view&&this.view.notifyObservers(t)},l.prototype.initializeNotifier=function(t){this.multitonKey=t},l.hasCore=function(t){return null!=l.instanceMap[t]},l.removeCore=function(t){null!=l.instanceMap[t]&&(h.removeModel(t),c.removeView(t),d.removeController(t),delete l.instanceMap[t])},l.prototype.controller=null,l.prototype.model=null,l.prototype.view=null,l.prototype.multitonKey=null,l.instanceMap=[],l.MULTITON_MSG="Facade instance for this Multiton key already constructed!",c.prototype.initializeView=function(){},c.getInstance=function(t){return null==t?null:(null==c.instanceMap[t]&&(c.instanceMap[t]=new c(t)),c.instanceMap[t])},c.prototype.registerObserver=function(t,e){null!=this.observerMap[t]?this.observerMap[t].push(e):this.observerMap[t]=[e]},c.prototype.notifyObservers=function(t){if(null!=this.observerMap[t.getName()]){for(var e,i=this.observerMap[t.getName()],n=[],r=0;r<i.length;r++)e=i[r],n.push(e);for(r=0;r<n.length;r++)(e=n[r]).notifyObserver(t)}},c.prototype.removeObserver=function(t,e){for(var i=this.observerMap[t],n=0;n<i.length;n++)if(1==i[n].compareNotifyContext(e)){i.splice(n,1);break}0==i.length&&delete this.observerMap[t]},c.prototype.registerMediator=function(t){if(null==this.mediatorMap[t.getMediatorName()]){t.initializeNotifier(this.multitonKey);var e=(this.mediatorMap[t.getMediatorName()]=t).listNotificationInterests();if(0<e.length)for(var i=new r(t.handleNotification,t),n=0;n<e.length;n++)this.registerObserver(e[n],i);t.onRegister()}},c.prototype.retrieveMediator=function(t){return this.mediatorMap[t]},c.prototype.removeMediator=function(t){var e=this.mediatorMap[t];if(e){for(var i=e.listNotificationInterests(),n=0;n<i.length;n++)this.removeObserver(i[n],e);delete this.mediatorMap[t],e.onRemove()}return e},c.prototype.hasMediator=function(t){return null!=this.mediatorMap[t]},c.removeView=function(t){delete c.instanceMap[t]},c.prototype.mediatorMap=null,c.prototype.observerMap=null,c.instanceMap=[],c.prototype.multitonKey=null,c.MULTITON_MSG="View instance for this Multiton key already constructed!",h.prototype.initializeModel=function(){},h.getInstance=function(t){return null==t?null:(null==h.instanceMap[t]&&(h.instanceMap[t]=new h(t)),h.instanceMap[t])},h.prototype.registerProxy=function(t){t.initializeNotifier(this.multitonKey),(this.proxyMap[t.getProxyName()]=t).onRegister()},h.prototype.retrieveProxy=function(t){return this.proxyMap[t]},h.prototype.hasProxy=function(t){return null!=this.proxyMap[t]},h.prototype.removeProxy=function(t){var e=this.proxyMap[t];return e&&(this.proxyMap[t]=null,e.onRemove()),e},h.removeModel=function(t){delete h.instanceMap[t]},h.prototype.proxyMap=null,h.instanceMap=[],h.MULTITON_MSG="Model instance for this Multiton key already constructed!",d.prototype.initializeController=function(){this.view=c.getInstance(this.multitonKey)},d.getInstance=function(t){return null==t?null:(null==this.instanceMap[t]&&(this.instanceMap[t]=new this(t)),this.instanceMap[t])},d.prototype.executeCommand=function(t){var e=this.commandMap[t.getName()];null!=e&&((e=new e).initializeNotifier(this.multitonKey),e.execute(t))},d.prototype.registerCommand=function(t,e){null==this.commandMap[t]&&this.view.registerObserver(t,new r(this.executeCommand,this)),this.commandMap[t]=e},d.prototype.hasCommand=function(t){return null!=this.commandMap[t]},d.prototype.removeCommand=function(t){this.hasCommand(t)&&(this.view.removeObserver(t,this),this.commandMap[t]=null)},d.removeController=function(t){delete this.instanceMap[t]},d.prototype.view=null,d.prototype.commandMap=null,d.prototype.multitonKey=null,d.instanceMap=[],d.MULTITON_MSG="controller key for this Multiton key already constructed",p={global:function(){return this}(),extend:function(t,e){if("function"!=typeof t)throw new TypeError("#extend- child should be Function");if("function"!=typeof e)throw new TypeError("#extend- parent should be Function");var i;if(e!==t)return(i=new Function).prototype=e.prototype,t.prototype=new i,t.prototype.constructor=t},decorate:function(t,e){for(var i in e)t[i]=e[i];return t}},t.puremvc={View:c,Model:h,Controller:d,SimpleCommand:i,MacroCommand:a,Facade:l,Mediator:s,Observer:r,Notification:n,Notifier:e,Proxy:o,define:function(t,e,i){var n=(t=t||{}).name,r=t.parent,a="function"==typeof r,s=t.scope||null;if("parent"in t&&!a)throw new TypeError("Class parent must be Function");if(t.hasOwnProperty("constructor")){if("function"!=typeof(t=t.constructor))throw new TypeError("Class constructor must be Function")}else t=a?function(){r.apply(this,arguments)}:new Function;if(a&&p.extend(t,r),e&&(a=t.prototype,p.decorate(a,e),a.constructor=t),i&&p.decorate(t,i),n){if("string"!=typeof n)throw new TypeError("Class name must be primitive string");u(n,t,s)}return t},declare:u})}(this);var saveAs=saveAs||function(o){"use strict";var l,c,h,d,u,p,g,e,f,m,n,t;if(!(void 0===o||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent)))return t=o.document,l=function(){return o.URL||o.webkitURL||o},c=t.createElementNS("http://www.w3.org/1999/xhtml","a"),h="download"in c,d=/constructor/i.test(o.HTMLElement)||o.safari,u=/CriOS\/[\d]+/.test(navigator.userAgent),p=o.setImmediate||o.setTimeout,g=function(t){p(function(){throw t},0)},e=4e4,f=function(t){setTimeout(function(){"string"==typeof t?l().revokeObjectURL(t):t.remove()},e)},m=function(t){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob([String.fromCharCode(65279),t],{type:t.type}):t},n=function(t,i,e){e||(t=m(t));var n,r,a=this,e="application/octet-stream"===t.type,s=function(){for(var t=a,e="writestart progress write writeend".split(" "),i=void 0,n=(e=[].concat(e)).length;n--;){var r=t["on"+e[n]];if("function"==typeof r)try{r.call(t,i||t)}catch(t){g(t)}}};if(a.readyState=a.INIT,h)return n=l().createObjectURL(t),void p(function(){var t,e;c.href=n,c.download=i,t=c,e=new MouseEvent("click"),t.dispatchEvent(e),s(),f(n),a.readyState=a.DONE},0);(u||e&&d)&&o.FileReader?((r=new FileReader).onloadend=function(){var t=u?r.result:r.result.replace(/^data:[^;]*;/,"data:attachment/file;");o.open(t,"_blank")||(o.location.href=t),t=void 0,a.readyState=a.DONE,s()},r.readAsDataURL(t),a.readyState=a.INIT):(n=n||l().createObjectURL(t),!e&&o.open(n,"_blank")||(o.location.href=n),a.readyState=a.DONE,s(),f(n))},t=n.prototype,"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(t,e,i){return e=e||t.name||"download",i||(t=m(t)),navigator.msSaveOrOpenBlob(t,e)}:(t.abort=function(){},t.readyState=t.INIT=0,t.WRITING=1,t.DONE=2,t.error=t.onwritestart=t.onprogress=t.onwrite=t.onabort=t.onerror=t.onwriteend=null,function(t,e,i){return new n(t,e||t.name||"download",i)})}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this),carrousels=("undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return saveAs}),!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():0==typeof exports?exports.postRobot=e():t.postRobot=e()}("undefined"!=typeof self?self:this,function(){return i=[function(R,t,e){"use strict";function y(t){return"[object RegExp]"==={}.toString.call(t)}e.r(t),e.d(t,"Promise",function(){return S}),e.d(t,"TYPES",function(){return $t}),e.d(t,"ProxyWindow",function(){return D}),e.d(t,"setup",function(){return Vt}),e.d(t,"destroy",function(){return Ut}),e.d(t,"serializeMessage",function(){return Lt}),e.d(t,"deserializeMessage",function(){return Rt}),e.d(t,"createProxyWindow",function(){return kt}),e.d(t,"toProxyWindow",function(){return Ft}),e.d(t,"on",function(){return N}),e.d(t,"once",function(){return Nt}),e.d(t,"send",function(){return L}),e.d(t,"markWindowKnown",function(){return pt}),e.d(t,"cleanUpWindow",function(){return Bt}),e.d(t,"bridge",function(){});var i="Call was rejected by callee.\r\n";function k(t){return"about:"===(t=void 0===t?window:t).location.protocol}function s(t){if(t=void 0===t?window:t)try{if(t.parent&&t.parent!==t)return t.parent}catch(t){}}function F(t){if((t=void 0===t?window:t)&&!s(t))try{return t.opener}catch(t){}}function n(){try{return 1}catch(t){}}function r(t){var e=(t=void 0===t?window:t).location;if(!e)throw new Error("Can not read window location");var i=e.protocol;if(!i)throw new Error("Can not read window protocol");if("file:"===i)return"file://";if("about:"===i)return(t=s(t))&&n()?r(t):"about://";t=e.host;if(t)return i+"//"+t;throw new Error("Can not read window host")}function C(t){var e=r(t=void 0===t?window:t);return e&&t.mockDomain&&0===t.mockDomain.indexOf("mock:")?t.mockDomain:e}function l(t){if(function(t){try{if(t===window)return 1}catch(t){}try{var e=Object.getOwnPropertyDescriptor(t,"location");if(e&&!1===e.enumerable)return}catch(t){}try{if(k(t)&&n())return 1}catch(t){}try{if(r(t)===r(window))return 1}catch(t){}}(t))try{if(t===window)return!0;if(k(t)&&n())return!0;if(C(window)===C(t))return!0}catch(t){}return!1}function c(t){if(l(t))return t;throw new Error("Expected window to be same domain")}function V(t,e){var i;if(t&&e)return i=s(e),i?i===t:-1!==function(t){var e=[];try{for(;t.parent!==t;)e.push(t.parent),t=t.parent}catch(t){}return e}(e).indexOf(t)}function U(t){var e,i,n=[];try{e=t.frames}catch(i){e=t}try{i=e.length}catch(t){}if(0!==i)if(i)for(var r=0;r<i;r++){var a=void 0;try{a=e[r]}catch(t){continue}n.push(a)}else for(var s=0;s<100;s++){var o=void 0;try{o=e[s]}catch(t){return n}if(!o)return n;n.push(o)}return n}var $=[],B=[];function x(t,e){void 0===e&&(e=!0);try{if(t===window)return!1}catch(t){return!0}try{if(!t)return!0}catch(t){return!0}try{if(t.closed)return!0}catch(t){return!t||t.message!==i}if(e&&l(t))try{if(t.mockclosed)return!0}catch(t){}try{if(!t.parent||!t.top)return!0}catch(t){}e=function(t,e){for(var i=0;i<t.length;i++)try{if(t[i]===e)return i}catch(t){}return-1}($,t);if(-1!==e){e=B[e];if(e&&function(t){if(!t.contentWindow)return 1;if(!t.parentNode)return 1;var e=t.ownerDocument;if(e&&e.documentElement&&!e.documentElement.contains(t)){for(var i=t;i.parentNode&&i.parentNode!==i;)i=i.parentNode;if(!i.host||!e.documentElement.contains(i.host))return 1}}(e))return!0}return!1}function z(t){return F(t=(t=void 0===t?window:t)||window)||s(t)||void 0}function w(t,e){if("string"==typeof t){if("string"==typeof e)return"*"===t||e===t;if(y(e))return!1;if(Array.isArray(e))return!1}return y(t)?y(e)?t.toString()===e.toString():!Array.isArray(e)&&Boolean(e.match(t)):!!Array.isArray(t)&&(Array.isArray(e)?JSON.stringify(t)===JSON.stringify(e):!y(e)&&t.some(function(t){return w(t,e)}))}function h(t){try{if(t===window)return 1}catch(t){if(t&&t.message===i)return 1}try{if("[object Window]"==={}.toString.call(t))return 1}catch(t){if(t&&t.message===i)return 1}try{if(window.Window&&t instanceof window.Window)return 1}catch(t){if(t&&t.message===i)return 1}try{if(t&&t.self===t)return 1}catch(t){if(t&&t.message===i)return 1}try{if(t&&t.parent===t)return 1}catch(t){if(t&&t.message===i)return 1}try{if(t&&t.top===t)return 1}catch(t){if(t&&t.message===i)return 1}try{if(t&&"__unlikely_value__"===t.__cross_domain_utils_window_check__)return}catch(t){return 1}try{if("postMessage"in t&&"self"in t&&"location"in t)return 1}catch(t){}}function j(t){try{t.close()}catch(t){}}function d(t){try{if(!t)return!1;if("undefined"!=typeof Promise&&t instanceof Promise)return!0;if("undefined"!=typeof window&&"function"==typeof window.Window&&t instanceof window.Window)return!1;if("undefined"!=typeof window&&"function"==typeof window.constructor&&t instanceof window.constructor)return!1;var e={}.toString;if(e){var i=e.call(t);if("[object Window]"===i||"[object global]"===i||"[object DOMWindow]"===i)return!1}if("function"==typeof t.then)return!0}catch(t){return!1}return!1}var a,H=[],o=[],W=0;function X(){var t;!W&&a&&(t=a,a=null,t.resolve())}function Y(){W+=1}function u(){--W,X()}(e=p.prototype).resolve=function(t){if(this.resolved||this.rejected)return this;if(d(t))throw new Error("Can not resolve promise with another promise");return this.resolved=!0,this.value=t,this.dispatch(),this},e.reject=function(n){var t,r=this;if(this.resolved||this.rejected)return this;if(d(n))throw new Error("Can not reject promise with another promise");return n||(t=n&&"function"==typeof n.toString?n.toString():{}.toString.call(n),n=new Error("Expected reject to be called with Error, got "+t)),this.rejected=!0,this.error=n,this.errorHandled||setTimeout(function(){if(!r.errorHandled){var t=n,e=r;if(-1===H.indexOf(t)){H.push(t),setTimeout(function(){throw t},1);for(var i=0;i<o.length;i++)o[i](t,e)}}},1),this.dispatch(),this},e.asyncReject=function(t){return this.errorHandled=!0,this.reject(t),this},e.dispatch=function(){var t=this.resolved,e=this.rejected,i=this.handlers;if(!this.dispatching&&(t||e)){this.dispatching=!0,Y();for(var n=0;n<i.length;n++){var r=i[n],a=r.onSuccess,s=r.onError,r=r.promise,o=void 0;if(t)try{o=a?a(this.value):this.value}catch(t){r.reject(t);continue}else if(e){if(!s){r.reject(this.error);continue}try{o=s(this.error)}catch(t){r.reject(t);continue}}o instanceof p&&(o.resolved||o.rejected)?(o.resolved?r.resolve(o.value):r.reject(o.error),o.errorHandled=!0):d(o)?o instanceof p&&(o.resolved||o.rejected)?o.resolved?r.resolve(o.value):r.reject(o.error):function(t,e){t.then(function(t){e.resolve(t)},function(t){e.reject(t)})}(o,r):r.resolve(o)}i.length=0,this.dispatching=!1,u()}},e.then=function(t,e){if(t&&"function"!=typeof t&&!t.call)throw new Error("Promise.then expected a function for success handler");if(e&&"function"!=typeof e&&!e.call)throw new Error("Promise.then expected a function for error handler");var i=new p;return this.handlers.push({promise:i,onSuccess:t,onError:e}),this.errorHandled=!0,this.dispatch(),i},e.catch=function(t){return this.then(void 0,t)},e.finally=function(e){if(e&&"function"!=typeof e&&!e.call)throw new Error("Promise.finally expected a function");return this.then(function(t){return p.try(e).then(function(){return t})},function(t){return p.try(e).then(function(){throw t})})},e.timeout=function(t,e){var i=this;if(this.resolved||this.rejected)return this;var n=setTimeout(function(){i.resolved||i.rejected||i.reject(e||new Error("Promise timed out after "+t+"ms"))},t);return this.then(function(t){return clearTimeout(n),t})},e.toPromise=function(){if("undefined"==typeof Promise)throw new TypeError("Could not find Promise");return Promise.resolve(this)},p.resolve=function(i){return i instanceof p?i:d(i)?new p(function(t,e){return i.then(t,e)}):(new p).resolve(i)},p.reject=function(t){return(new p).reject(t)},p.asyncReject=function(t){return(new p).asyncReject(t)},p.all=function(t){var n=new p,r=t.length,a=[];if(!r)return n.resolve(a),n;for(var e=0;e<t.length;e++){var i=t[e];if(i instanceof p){if(i.resolved){a[e]=i.value,--r;continue}}else if(!d(i)){a[e]=i,--r;continue}!function(e,t,i){t.then(function(t){a[e]=t,0==--r&&n.resolve(a)},function(t){i.reject(t)})}(e,p.resolve(i),n)}return 0===r&&n.resolve(a),n},p.hash=function(i){var t,n={},r=[];for(t in i)!function(e){var t;i.hasOwnProperty(e)&&(d(t=i[e])?r.push(t.then(function(t){n[e]=t})):n[e]=t)}(t);return p.all(r).then(function(){return n})},p.map=function(t,e){return p.all(t.map(e))},p.onPossiblyUnhandledException=function(t){return e=t,o.push(e),{cancel:function(){o.splice(o.indexOf(e),1)}};var e},p.try=function(t,e,i){if(t&&"function"!=typeof t&&!t.call)throw new Error("Promise.try expected a function");var n;Y();try{n=t.apply(e,i||[])}catch(t){return u(),p.reject(t)}return u(),p.resolve(n)},p.delay=function(e){return new p(function(t){setTimeout(t,e)})},p.isPromise=function(t){return!!(t&&t instanceof p)||d(t)},p.flush=function(){return t=a=a||new p,X(),t;var t};var S=p;function p(t){var e=this;if(this.resolved=void 0,this.rejected=void 0,this.errorHandled=void 0,this.value=void 0,this.error=void 0,this.handlers=void 0,this.dispatching=void 0,this.stack=void 0,this.resolved=!1,this.rejected=!1,this.errorHandled=!1,this.handlers=[],t){var i,n,r=!1,a=!1,s=!1;Y();try{t(function(t){s?e.resolve(t):(r=!0,i=t)},function(t){s?e.reject(t):(a=!0,n=t)})}catch(t){return u(),void this.reject(t)}u(),s=!0,r?this.resolve(i):a&&this.reject(n)}}function g(t,e){for(var i=0;i<t.length;i++)try{if(t[i]===e)return i}catch(t){}return-1}(t=K.prototype)._cleanupClosedWindows=function(){for(var t=this.weakmap,e=this.keys,i=0;i<e.length;i++){var n=e[i];if(h(n)&&x(n)){if(t)try{t.delete(n)}catch(t){}e.splice(i,1),this.values.splice(i,1),--i}}},t.isSafeToReadWrite=function(t){return!h(t)},t.set=function(t,e){if(!t)throw new Error("WeakMap expected key");var i=this.weakmap;if(i)try{i.set(t,e)}catch(t){delete this.weakmap}if(this.isSafeToReadWrite(t))try{var n=this.name,r=t[n];return void(r&&r[0]===t?r[1]=e:Object.defineProperty(t,n,{value:[t,e],writable:!0}))}catch(t){}this._cleanupClosedWindows();i=this.keys,r=this.values,n=g(i,t);-1===n?(i.push(t),r.push(e)):r[n]=e},t.get=function(t){if(!t)throw new Error("WeakMap expected key");var e=this.weakmap;if(e)try{if(e.has(t))return e.get(t)}catch(t){delete this.weakmap}if(this.isSafeToReadWrite(t))try{var i=t[this.name];return i&&i[0]===t?i[1]:void 0}catch(t){}this._cleanupClosedWindows();e=g(this.keys,t);if(-1!==e)return this.values[e]},t.delete=function(t){if(!t)throw new Error("WeakMap expected key");var e=this.weakmap;if(e)try{e.delete(t)}catch(t){delete this.weakmap}if(this.isSafeToReadWrite(t))try{var i=t[this.name];i&&i[0]===t&&(i[0]=i[1]=void 0)}catch(t){}this._cleanupClosedWindows();e=this.keys,i=g(e,t);-1!==i&&(e.splice(i,1),this.values.splice(i,1))},t.has=function(t){if(!t)throw new Error("WeakMap expected key");var e=this.weakmap;if(e)try{if(e.has(t))return!0}catch(t){delete this.weakmap}if(this.isSafeToReadWrite(t))try{var i=t[this.name];return!(!i||i[0]!==t)}catch(t){}return this._cleanupClosedWindows(),-1!==g(this.keys,t)},t.getOrSet=function(t,e){if(this.has(t))return this.get(t);e=e();return this.set(t,e),e};var f,q=K;function K(){if(this.name=void 0,this.weakmap=void 0,this.keys=void 0,this.values=void 0,this.name="__weakmap_"+(1e9*Math.random()>>>0)+"__",function(){if("undefined"!=typeof WeakMap&&void 0!==Object.freeze)try{var t=new WeakMap,e={};return Object.freeze(e),t.set(e,"__testvalue__"),"__testvalue__"===t.get(e)}catch(t){return}}())try{this.weakmap=new WeakMap}catch(t){}this.keys=[],this.values=[]}function Z(t){return t.name||t.__name__||t.displayName||"anonymous"}function J(t,e){try{delete t.name,t.name=e}catch(t){}return t.__name__=t.displayName=e,t}function M(){var t="0123456789abcdef";return"xxxxxxxxxx".replace(/./g,function(){return t.charAt(Math.floor(Math.random()*t.length))})+"_"+function(t){if("function"==typeof btoa)return btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,function(t,e){return String.fromCharCode(parseInt(e,16))}));if("undefined"!=typeof Buffer)return Buffer.from(t,"utf8").toString("base64");throw new Error("Can not find window.btoa or Buffer")}((new Date).toISOString().slice(11,19).replace("T",".")).replace(/[^a-zA-Z0-9]/g,"").toLowerCase()}function Q(t){try{return JSON.stringify([].slice.call(t),function(t,e){return"function"==typeof e?"memoize["+function(t){if(f=f||new q,null==t||"object"!=typeof t&&"function"!=typeof t)throw new Error("Invalid object");var e=f.get(t);return e||(e=typeof t+":"+M(),f.set(t,e)),e}(e)+"]":e})}catch(t){throw new Error("Arguments not serializable -- can not be used to memoize")}}var tt=[];function m(o,l){function t(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];var n=c.getOrSet(l.thisNamespace?this:o,function(){return{}}),r=Q(e),a=l.time;if(n[r]&&a&&Date.now()-n[r].time<a&&delete n[r],n[r])return n[r].value;var a=Date.now(),s=o.apply(this,arguments);return n[r]={time:a,value:s},n[r].value}var e=this,c=(void 0===l&&(l={}),new q);return t.reset=function(){c.delete(l.thisNamespace?e:o)},tt.push(t),J(t,(l.name||Z(o))+"::memoized")}function O(){}function G(t,e){if(3<=(e=void 0===e?1:e))return"stringifyError stack overflow";try{if(!t)return"<unknown error: "+{}.toString.call(t)+">";if("string"==typeof t)return t;if(t instanceof Error){var i=t&&t.stack,n=t&&t.message;if(i&&n)return-1!==i.indexOf(n)?i:n+"\n"+i;if(i)return i;if(n)return n}return t&&t.toString&&"function"==typeof t.toString?t.toString():{}.toString.call(t)}catch(t){return"Error while stringifying error: "+G(t,e+1)}}function et(t){return"string"==typeof t?t:t&&t.toString&&"function"==typeof t.toString?t.toString():{}.toString.call(t)}function it(t){return"[object RegExp]"==={}.toString.call(t)}function v(t,e,i){if(t.hasOwnProperty(e))return t[e];i=i();return t[e]=i}function nt(){return Boolean(document.body)&&"complete"===document.readyState}function rt(){return Boolean(document.body)&&"interactive"===document.readyState}m.clear=function(){for(var t=0;t<tt.length;t++)tt[t].reset()},m(function(t){if(Object.values)return Object.values(t);var e,i=[];for(e in t)t.hasOwnProperty(e)&&i.push(t[e]);return i}),Error,m(function(){return new S(function(t){if(nt()||rt())return t();var e=setInterval(function(){if(nt()||rt())return clearInterval(e),t()},10)})});var _="undefined"!=typeof document?document.currentScript:null,at=m(function(){if(_)return _;if(_=function(){try{var t=function(){try{throw new Error("_")}catch(t){return t.stack||""}}(),e=/.*at [^(]*\((.*):(.+):(.+)\)$/gi.exec(t),i=e&&e[1];if(!i)return;for(var n=0,r=[].slice.call(document.getElementsByTagName("script")).reverse();n<r.length;n++){var a=r[n];if(a.src&&a.src===i)return a}}catch(t){}}())return _;throw new Error("Can not determine current script")}),st=M();function b(t){var e="__post_robot_10_0_41__";return(t=void 0===t?window:t)!==window?t[e]:t[e]=t[e]||{}}m(function(){var t;try{t=at()}catch(t){return st}var e=t.getAttribute("data-uid");return e&&"string"==typeof e||(e=M(),t.setAttribute("data-uid",e)),e});var ot=function(){return{}};function I(t,e){return void 0===t&&(t="store"),void 0===e&&(e=ot),v(b(),t,function(){var i=e();return{has:function(t){return i.hasOwnProperty(t)},get:function(t,e){return i.hasOwnProperty(t)?i[t]:e},set:function(t,e){return i[t]=e},del:function(t){delete i[t]},getOrSet:function(t,e){return v(i,t,e)},reset:function(){i=e()},keys:function(){return Object.keys(i)}}})}function lt(){}function T(){var t=b();return t.WINDOW_WILDCARD=t.WINDOW_WILDCARD||new lt,t.WINDOW_WILDCARD}function A(n,r){return void 0===n&&(n="store"),void 0===r&&(r=ot),I("windowStore").getOrSet(n,function(){function i(t){return e.getOrSet(t,r)}var e=new q;return{has:function(t){return i(t).hasOwnProperty(n)},get:function(t,e){t=i(t);return t.hasOwnProperty(n)?t[n]:e},set:function(t,e){return i(t)[n]=e},del:function(t){delete i(t)[n]},getOrSet:function(t,e){return v(i(t),n,e)}}})}function ct(){return I("instance").getOrSet("instanceID",M)}function ht(t,e){var e=e.domain,i=A("helloPromises"),n=i.get(t),n=(n&&n.resolve({domain:e}),S.resolve({domain:e}));i.set(t,n)}function dt(i,t){return(0,t.send)(i,"postrobot_hello",{instanceID:ct()},{domain:"*",timeout:-1}).then(function(t){var e=t.origin,t=t.data.instanceID;return ht(i,{domain:e}),{win:i,domain:e,instanceID:t}})}function ut(t,e){var i=e.send;return A("windowInstanceIDPromises").getOrSet(t,function(){return dt(t,{send:i}).then(function(t){return t.instanceID})})}function pt(t){A("knownWindows").set(t,!0)}function gt(t){return"object"==typeof t&&null!==t&&"string"==typeof t.__type__}function ft(t){return void 0===t?"undefined":null===t?"null":Array.isArray(t)?"array":"function"==typeof t?"function":"object"==typeof t?t instanceof Error?"error":"function"==typeof t.then?"promise":"[object RegExp]"==={}.toString.call(t)?"regex":"[object Date]"==={}.toString.call(t)?"date":"object":"string"==typeof t?"string":"number"==typeof t?"number":"boolean"==typeof t?"boolean":void 0}function P(t,e){return{__type__:t,__val__:e}}(e={}).function=function(){},e.error=function(t){return P("error",{message:t.message,stack:t.stack,code:t.code,data:t.data})},e.promise=function(){},e.regex=function(t){return P("regex",t.source)},e.date=function(t){return P("date",t.toJSON())},e.array=function(t){return t},e.object=function(t){return t},e.string=function(t){return t},e.number=function(t){return t},e.boolean=function(t){return t},e.null=function(t){return t};var mt=e,_t={},vt=((t={}).function=function(){throw new Error("Function serialization is not implemented; nothing to deserialize")},t.error=function(t){var e=t.stack,i=t.code,n=t.data,t=new Error(t.message);return t.code=i,n&&(t.data=n),t.stack=e+"\n\n"+t.stack,t},t.promise=function(){throw new Error("Promise serialization is not implemented; nothing to deserialize")},t.regex=function(t){return new RegExp(t)},t.date=function(t){return new Date(t)},t.array=function(t){return t},t.object=function(t){return t},t.string=function(t){return t},t.number=function(t){return t},t.boolean=function(t){return t},t.null=function(t){return t},t),yt={};function bt(){for(var t=I("idToProxyWindow"),e=0,i=t.keys();e<i.length;e++){var n=i[e];t.get(n).shouldClean()&&t.del(n)}}function Ct(t,e){var s,o,i=e.send,e=e.id,e=void 0===e?M():e,r=t.then(function(t){if(l(t))return c(t).name}),n=t.then(function(t){if(x(t))throw new Error("Window is closed, can not determine type");return F(t)?"popup":"iframe"});return r.catch(O),n.catch(O),{id:e,getType:function(){return n},getInstanceID:(s=function(){return t.then(function(t){return ut(t,{send:i})})},o={},a.reset=function(){o={}},J(a,Z(s)+"::promiseMemoized")),close:function(){return t.then(j)},getName:function(){return t.then(function(t){if(!x(t))return l(t)?c(t).name:r})},focus:function(){return t.then(function(t){t.focus()})},isClosed:function(){return t.then(function(t){return x(t)})},setLocation:function(i){return t.then(function(t){var e=window.location.protocol+"//"+window.location.host;if(0===i.indexOf("/"))i=e+i;else if(!i.match(/^https?:\/\//)&&0!==i.indexOf(e))throw new Error("Expected url to be http or https url, or absolute path, got "+JSON.stringify(i));if(l(t))try{if(t.location&&"function"==typeof t.location.replace)return void t.location.replace(i)}catch(t){}t.location=i})},setName:function(n){return t.then(function(t){var e=l(t),i=function(t){if(l(t))return c(t).frameElement;for(var e=0,i=document.querySelectorAll("iframe");e<i.length;e++){var n=i[e];if(n&&n.contentWindow&&n.contentWindow===t)return n}}(t);if(!e)throw new Error("Can not set name for cross-domain window: "+n);c(t).name=n,i&&i.setAttribute("name",n),r=S.resolve(n)})}};function a(){for(var t=arguments,e=this,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];var a=Q(n);return o.hasOwnProperty(a)||(o[a]=S.try(function(){return s.apply(e,t)}).finally(function(){delete o[a]})),o[a]}}new S(function(t){if(window.document&&window.document.body)return t(window.document.body);var e=setInterval(function(){if(window.document&&window.document.body)return clearInterval(e),t(window.document.body)},10)});(e=E.prototype).getID=function(){return this.serializedWindow.id},e.getType=function(){return this.serializedWindow.getType()},e.isPopup=function(){return this.getType().then(function(t){return"popup"===t})},e.setLocation=function(t){var e=this;return this.serializedWindow.setLocation(t).then(function(){return e})},e.getName=function(){return this.serializedWindow.getName()},e.setName=function(t){var e=this;return this.serializedWindow.setName(t).then(function(){return e})},e.close=function(){var t=this;return this.serializedWindow.close().then(function(){return t})},e.focus=function(){var t=this,e=this.isPopup(),i=this.getName(),e=S.hash({isPopup:e,name:i}).then(function(t){var e=t.name;t.isPopup&&e&&window.open("",e)}),i=this.serializedWindow.focus();return S.all([e,i]).then(function(){return t})},e.isClosed=function(){return this.serializedWindow.isClosed()},e.getWindow=function(){return this.actualWindow},e.setWindow=function(t,e){e=e.send;this.actualWindow=t,this.actualWindowPromise.resolve(this.actualWindow),this.serializedWindow=Ct(this.actualWindowPromise,{send:e,id:this.getID()}),A("winToProxyWindow").set(t,this)},e.awaitWindow=function(){return this.actualWindowPromise},e.matchWindow=function(e,t){var i=this,n=t.send;return S.try(function(){return i.actualWindow?e===i.actualWindow:S.hash({proxyInstanceID:i.getInstanceID(),knownWindowInstanceID:ut(e,{send:n})}).then(function(t){t=t.proxyInstanceID===t.knownWindowInstanceID;return t&&i.setWindow(e,{send:n}),t})})},e.unwrap=function(){return this.actualWindow||this},e.getInstanceID=function(){return this.serializedWindow.getInstanceID()},e.shouldClean=function(){return Boolean(this.actualWindow&&x(this.actualWindow))},e.serialize=function(){return this.serializedWindow},E.unwrap=function(t){return E.isProxyWindow(t)?t.unwrap():t},E.serialize=function(t,e){e=e.send;return bt(),E.toProxyWindow(t,{send:e}).serialize()},E.deserialize=function(t,e){e=e.send;return bt(),I("idToProxyWindow").get(t.id)||new E({serializedWindow:t,send:e})},E.isProxyWindow=function(t){return Boolean(t&&!h(t)&&t.isProxyWindow)},E.toProxyWindow=function(t,e){e=e.send;if(bt(),E.isProxyWindow(t))return t;return A("winToProxyWindow").get(t)||new E({win:t,send:e})};var D=E;function E(t){var e=t.send,i=t.win,t=t.serializedWindow;this.id=void 0,this.isProxyWindow=!0,this.serializedWindow=void 0,this.actualWindow=void 0,this.actualWindowPromise=void 0,this.send=void 0,this.name=void 0,this.actualWindowPromise=new S,this.serializedWindow=t||Ct(this.actualWindowPromise,{send:e}),I("idToProxyWindow").set(this.getID(),this),i&&this.setWindow(i,{send:e})}function xt(t,e,i,n,r){var a=A("methodStore"),s=I("proxyWindowMethods");D.isProxyWindow(n)?s.set(t,{val:e,name:i,domain:r,source:n}):(s.del(t),a.getOrSet(n,function(){return{}})[t]={domain:r,name:i,val:e,source:n})}function wt(t,e){var i=A("methodStore"),n=I("proxyWindowMethods");return i.getOrSet(t,function(){return{}})[e]||n.get(e)}function St(t,e,i,n,r){var a=(r={on:r.on,send:r.send}).on,h=r.send,s=(I("builtinListeners").getOrSet("functionCalls",function(){return a("postrobot_method",{domain:"*"},function(t){var e=t.source,i=t.origin,n=t.data,r=n.id,a=n.name,s=wt(e,r);if(!s)throw new Error("Could not find method '"+a+"' with id: "+n.id+" in "+C(window));var o=s.source,l=s.domain,c=s.val;return S.try(function(){if(!w(l,i))throw new Error("Method '"+n.name+"' domain "+JSON.stringify(it(s.domain)?s.domain.source:s.domain)+" does not match origin "+i+" in "+C(window));if(D.isProxyWindow(o))return o.matchWindow(e,{send:h}).then(function(t){if(!t)throw new Error("Method call '"+n.name+"' failed - proxy window does not match source in "+C(window))})}).then(function(){return c.apply({source:e,origin:i},n.args)},function(e){return S.try(function(){if(c.onError)return c.onError(e)}).then(function(){var t;throw e.stack&&(e.stack="Remote call to "+a+"("+(t=t=void 0===(t=n.args)?[]:t,[].slice.call(t).map(function(t){return"string"==typeof t?"'"+t+"'":void 0===t?"undefined":null===t?"null":"boolean"==typeof t?t.toString():Array.isArray(t)?"[ ... ]":"object"==typeof t?"{ ... }":"function"==typeof t?"() => { ... }":"<"+typeof t+">"}).join(", ")+") failed\n\n")+e.stack),e})}).then(function(t){return{result:t,id:r,name:a}})})}),i.__id__||M()),o=(t=D.unwrap(t),i.__name__||i.name||n);return"string"==typeof o&&"function"==typeof o.indexOf&&0===o.indexOf("anonymous::")&&(o=o.replace("anonymous::",n+"::")),D.isProxyWindow(t)?(xt(s,i,o,t,e),t.awaitWindow().then(function(t){xt(s,i,o,t,e)})):xt(s,i,o,t,e),P("cross_domain_function",{id:s,name:o})}function Mt(n,r,t,e){var a=e.on,s=e.send,e=t,o=((t={}).promise=function(t,e){return i=t,P("cross_domain_zalgo_promise",{then:St(n,r,function(t,e){return i.then(t,e)},e,{on:(t={on:a,send:s}).on,send:t.send})});var i},t.function=function(t,e){return St(n,r,t,e,{on:a,send:s})},t.object=function(t){return h(t)||D.isProxyWindow(t)?P("cross_domain_window",D.serialize(t,{send:s})):t},t);return void 0===t&&(o=_t),void 0===(e=JSON.stringify(e,function(t){var e=this[t];if(gt(this))return e;var i=ft(e);if(!i)return e;i=o[i]||mt[i];return i?i(e,t):e}))?"undefined":e}function Ot(i,n,t,e){var r=e.send,e=t,a=((t={}).cross_domain_zalgo_promise=function(t){return new S(t.then)},t.cross_domain_function=function(t){return a=i,s=n,o=t.id,l=t.name,c={send:r}.send,(t=e()).fireAndForget=e({fireAndForget:!0}),t;function e(n){function r(){var i=arguments;return D.toProxyWindow(a,{send:c}).awaitWindow().then(function(t){var e=wt(t,o);if(e&&e.val!==r)return e.val.apply({source:window,origin:C()},i);e=[].slice.call(i);return n.fireAndForget?c(t,"postrobot_method",{id:o,name:l,args:e},{domain:s,fireAndForget:!0}):c(t,"postrobot_method",{id:o,name:l,args:e},{domain:s,fireAndForget:!1}).then(function(t){return t.data.result})}).catch(function(t){throw t})}return void 0===n&&(n={}),r.__name__=l,r.__origin__=s,r.__source__=a,r.__id__=o,r.origin=s,r}var a,s,o,l,c},t.cross_domain_window=function(t){return D.deserialize(t,{send:r})},t);if(void 0===a&&(a=yt),"undefined"!==e)return JSON.parse(e,function(t,e){if(gt(this))return e;e=gt(e)?(i=e.__type__,e.__val__):(i=ft(e),e);if(!i)return e;var i=a[i]||vt[i];return i?i(e,t):e})}var Gt={};function It(o,l,t,e){var c=e.on,h=e.send;return S.try(function(){var s=A().getOrSet(o,function(){return{}});return s.buffer=s.buffer||[],s.buffer.push(t),s.flush=s.flush||S.flush().then(function(){if(x(o))throw new Error("Window is closed");var t,e=Mt(o,l,((t={}).__post_robot_10_0_41__=s.buffer||[],t),{on:c,send:h});delete s.buffer;for(var i=Object.keys(Gt),n=[],r=0;r<i.length;r++){var a=i[r];try{Gt[a](o,e,l)}catch(t){n.push(t)}}if(n.length===i.length)throw new Error("All post-robot messaging strategies failed:\n\n"+n.map(function(t,e){return e+". "+G(t)}).join("\n\n"))}),s.flush.then(function(){delete s.flush})}).then(O)}function Tt(t){return I("responseListeners").get(t)}function At(t){I("responseListeners").del(t)}function Pt(t){return I("erroredResponseListeners").has(t)}function Dt(t){var e=t.name,i=t.win,n=t.domain,r=A("requestListeners");if("*"===i&&(i=null),"*"===n&&(n=null),!e)throw new Error("Name required to get request listener");for(var a=0,s=[i,T()];a<s.length;a++){var o=s[a];if(o){o=r.get(o);if(o){o=o[e];if(o){if(n&&"string"==typeof n){if(o[n])return o[n];if(o.__domain_regex__)for(var l=0,c=o.__domain_regex__;l<c.length;l++){var h=c[l],d=h.listener;if(w(h.regex,n))return d}}if(o["*"])return o["*"]}}}}}function Et(t,e){var i=e.on,n=e.send,r=I("receivedMessages");try{if(!window||window.closed||!t.source)return}catch(t){return}var a=t.source,s=t.origin,o=function(t,e,i,n){var r,a=n.on,n=n.send;try{r=Ot(e,i,t,{on:a,send:n})}catch(t){return}if(r&&"object"==typeof r&&null!==r){e=r.__post_robot_10_0_41__;if(Array.isArray(e))return e}}(t.data,a,s,{on:i,send:n});if(o){pt(a);for(var l=0;l<o.length;l++){var c=o[l];if(r.has(c.id))return;if(r.set(c.id,!0),x(a)&&!c.fireAndForget)return;0===c.origin.indexOf("file:")&&(s="file://");try{if("postrobot_message_request"===c.type)(function(n,r,a,t){var s=t.on,o=t.send,e=Dt({name:a.name,win:n,domain:r}),l="postrobot_method"===a.name&&a.data&&"string"==typeof a.data.name?a.data.name+"()":a.name;function i(t,e,i){return S.flush().then(function(){if(!a.fireAndForget&&!x(n))try{return It(n,r,{id:M(),origin:C(window),type:"postrobot_message_response",hash:a.hash,name:a.name,ack:t,data:e,error:i},{on:s,send:o})}catch(t){throw new Error("Send response message failed for "+l+" in "+C()+"\n\n"+G(t))}})}S.all([S.flush().then(function(){if(!a.fireAndForget&&!x(n))try{return It(n,r,{id:M(),origin:C(window),type:"postrobot_message_ack",hash:a.hash,name:a.name},{on:s,send:o})}catch(t){throw new Error("Send ack message failed for "+l+" in "+C()+"\n\n"+G(t))}}),S.try(function(){if(!e)throw new Error("No handler found for post message: "+a.name+" from "+r+" in "+window.location.protocol+"//"+window.location.host+window.location.pathname);if(w(e.domain,r))return e.handler({source:n,origin:r,data:a.data});throw new Error("Request origin "+r+" does not match domain "+e.domain.toString())}).then(function(t){return i("success",t)},function(t){return i("error",null,t)})]).then(O).catch(function(t){if(e&&e.handleError)return e.handleError(t);throw t})})(a,s,c,{on:i,send:n});else if("postrobot_message_response"===c.type){h=void 0;d=void 0;u=void 0;p=void 0;g=void 0;var h=a;var d=s;var u=c;if(!Pt(u.hash)){var p,g=Tt(u.hash);if(!g)throw new Error("No handler found for post message response for message: "+u.name+" from "+d+" in "+window.location.protocol+"//"+window.location.host+window.location.pathname);if(!w(g.domain,d))throw new Error("Response origin "+d+" does not match domain "+(p=g.domain,Array.isArray(p)?"("+p.join(" | ")+")":y(p)?"RegExp("+p.toString():p.toString()));if(h!==g.win)throw new Error("Response source does not match registered window");At(u.hash),"error"===u.ack?g.promise.reject(u.error):"success"===u.ack&&g.promise.resolve({source:h,origin:d,data:u.data})}}else if("postrobot_message_ack"===c.type){f=void 0;m=void 0;_=void 0;v=void 0;var f=a;var m=s;var _=c;if(!Pt(_.hash)){var v=Tt(_.hash);if(!v)throw new Error("No handler found for post message ack for message: "+_.name+" from "+m+" in "+window.location.protocol+"//"+window.location.host+window.location.pathname);try{if(!w(v.domain,m))throw new Error("Ack origin "+m+" does not match domain "+v.domain.toString());if(f!==v.win)throw new Error("Ack source does not match registered window")}catch(f){v.promise.reject(f)}v.ack=!0}}}catch(t){setTimeout(function(){throw t},0)}}}}function N(t,e,i){if(!t)throw new Error("Expected name");if("function"==typeof(e=e||{})&&(i=e,e={}),!i)throw new Error("Expected handler");(e=e||{}).name=t,e.handler=i||e.handler;var i=e.window,n=e.domain,r=function t(e,i){var n=e.name,r=e.win,a=e.domain,s=A("requestListeners");if(!n||"string"!=typeof n)throw new Error("Name required to add request listener");if(Array.isArray(r)){for(var o=[],l=0,c=r;l<c.length;l++)o.push(t({name:n,domain:a,win:c[l]},i));return{cancel:function(){for(var t=0;t<o.length;t++)o[t].cancel()}}}if(Array.isArray(a)){for(var h=[],d=0,u=a;d<u.length;d++)h.push(t({name:n,win:r,domain:u[d]},i));return{cancel:function(){for(var t=0;t<h.length;t++)h[t].cancel()}}}e=Dt({name:n,win:r,domain:a});if(r&&"*"!==r||(r=T()),a=a||"*",e)throw r&&a?new Error("Request listener already exists for "+n+" on domain "+a.toString()+" for "+(r===T()?"wildcard":"specified")+" window"):r?new Error("Request listener already exists for "+n+" for "+(r===T()?"wildcard":"specified")+" window"):a?new Error("Request listener already exists for "+n+" on domain "+a.toString()):new Error("Request listener already exists for "+n);var p,g,f=s.getOrSet(r,function(){return{}}),m=v(f,n,function(){return{}}),_=a.toString();return it(a)?(p=v(m,"__domain_regex__",function(){return[]})).push(g={regex:a,listener:i}):m[_]=i,{cancel:function(){delete m[_],g&&(p.splice(p.indexOf(g,1)),p.length||delete m.__domain_regex__),Object.keys(m).length||delete f[n],r&&!Object.keys(f).length&&s.del(r)}}}({name:t,win:i,domain:n},{handler:e.handler,handleError:e.errorHandler||function(t){throw t},window:i,domain:n||"*",name:t});return{cancel:function(){r.cancel()}}}function Nt(t,e,i){"function"==typeof(e=e||{})&&(i=e,e={});var n,r=new S;return e.errorHandler=function(t){n.cancel(),r.reject(t)},n=N(t,e,function(t){if(n.cancel(),r.resolve(t),i)return i(t)}),r.cancel=n.cancel,r}Gt.postrobot_post_message=function(t,e,i){0===i.indexOf("file:")&&(i="*"),t.postMessage(e,i)};var L=function f(m,_,v,t){var a=(t=t||{}).domain||"*",y=t.timeout||-1,n=t.timeout||5e3,b=t.fireAndForget||!1;return S.try(function(){var t=_,e=m,i=a;if(!t)throw new Error("Expected name");if(i&&"string"!=typeof i&&!Array.isArray(i)&&!it(i))throw new TypeError("Can not send "+t+". Expected domain "+JSON.stringify(i)+" to be a string, array, or regex");if(x(e))throw new Error("Can not send "+t+". Target window is closed");if(function(t,e){var i=z(e);if(i)return i===t;if(e!==t&&function(t){void 0===t&&(t=window);try{if(t.top)return t.top}catch(t){}if(s(t)===t)return t;try{if(V(window,t)&&window.top)return window.top}catch(t){}try{if(V(t,window)&&window.top)return window.top}catch(t){}for(var e=0,i=function t(e){for(var i=[],n=0,r=U(e);n<r.length;n++){var a=r[n];i.push(a);for(var s=0,o=t(a);s<o.length;s++)i.push(o[s])}return i}(t);e<i.length;e++){var n=i[e];try{if(n.top)return n.top}catch(t){}if(s(n)===n)return n}}(e)!==e)for(var n=0,r=U(t);n<r.length;n++)if(r[n]===e)return 1}(window,m))return i=n,e=void 0,void 0===i&&(i=5e3),void 0===e&&(e="Window"),t=m,t=A("helloPromises").getOrSet(t,function(){return new S}),t=-1!==i?t.timeout(i,new Error(e+" did not load after "+i+"ms")):t}).then(function(t){return e=m,i=a,n=(void 0===t?{}:t).domain,r={send:f}.send,S.try(function(){return"string"==typeof i?i:S.try(function(){return n||dt(e,{send:r}).then(function(t){return t.domain})}).then(function(t){if(w(i,i))return t;throw new Error("Domain "+et(i)+" does not match "+et(i))})});var e,i,n,r}).then(function(t){var e,i,n,r,a,s,o,l,c,h,d,u="postrobot_method"===_&&v&&"string"==typeof v.name?v.name+"()":_,p=new S,g=_+"_"+M();return b||(h=g,d=n={name:_,win:m,domain:t,promise:p},I("responseListeners").set(h,d),(r=A("requestPromises").getOrSet(m,function(){return[]})).push(p),p.catch(function(){var t;t=g,I("erroredResponseListeners").set(t,!0),At(g)}),h=m,a=A("knownWindows").get(h,!1)?1e4:2e3,o=a,l=s=y,e=function(){return x(m)?p.reject(new Error("Window closed for "+_+" before "+(n.ack?"response":"ack"))):n.cancelled?p.reject(new Error("Response listener was cancelled for "+_)):(o=Math.max(o-500,0),-1!==l&&(l=Math.max(l-500,0)),n.ack||0!==o?0===l?p.reject(new Error("No response for postMessage "+u+" in "+C()+" in "+s+"ms")):void 0:p.reject(new Error("No ack for postMessage "+u+" in "+C()+" in "+a+"ms")))},function t(){i=setTimeout(function(){e(),t()},500)}(),c={cancel:function(){clearTimeout(i)}},p.finally(function(){c.cancel(),r.splice(r.indexOf(p,1))}).catch(O)),It(m,t,{id:M(),origin:C(window),type:"postrobot_message_request",hash:g,name:_,data:v,fireAndForget:b},{on:N,send:f}).then(function(){return b?p.resolve():p},function(t){throw new Error("Send request message failed for "+u+" in "+C()+"\n\n"+G(t))})})};function Lt(t,e,i){return Mt(t,e,i,{on:N,send:L})}function Rt(t,e,i){return Ot(t,e,i,{on:N,send:L})}function kt(t){return new D({send:L,win:t})}function Ft(t){return D.toProxyWindow(t,{send:L})}function Vt(){var e,i,n,r,t,s,o;b().initialized||(b().initialized=!0,e=(t={on:N,send:L}).on,i=t.send,(t=b()).receiveMessage=t.receiveMessage||function(t){return Et(t,{on:e,send:i})},s=(t={on:N,send:L}).on,o=t.send,I().getOrSet("postMessageListener",function(){return(t=window).addEventListener("message",e=function(t){var n,r,a;n=t,r=(t={on:s,send:o}).on,a=t.send,S.try(function(){var t=n.source||n.sourceElement,e=n.origin||n.originalEvent&&n.originalEvent.origin,i=n.data;if("null"===e&&(e="file://"),t){if(!e)throw new Error("Post message did not have origin domain");Et({source:t,origin:e,data:i},{on:r,send:a})}})}),{cancel:function(){t.removeEventListener("message",e)}};var t,e}),n=(t={on:N,send:L}).on,r=t.send,I("builtinListeners").getOrSet("helloListener",function(){var t=n("postrobot_hello",{domain:"*"},function(t){return ht(t.source,{domain:t.origin}),{instanceID:ct()}}),e=z();return e&&dt(e,{send:r}).catch(function(t){}),t}))}function Ut(){for(var t,e=I("responseListeners"),i=0,n=e.keys();i<n.length;i++){var r=n[i],a=e.get(r);a&&(a.cancelled=!0),e.del(r)}(t=I().get("postMessageListener"))&&t.cancel(),delete window.__post_robot_10_0_41__}var $t=!0;function Bt(t){for(var e=0,i=A("requestPromises").get(t,[]);e<i.length;e++)i[e].reject(new Error("Window "+(x(t)?"closed":"cleaned up")+" before response")).catch(O)}Vt()}],n={},r.m=i,r.c=n,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(i,n,function(t){return e[t]}.bind(null,n));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return{}.hasOwnProperty.call(t,e)},r.p="",r(r.s=0);function r(t){if(n[t])return n[t].exports;var e=n[t]={i:t,l:!1,exports:{}};return i[t].call(e.exports,e,e.exports,r),e.l=!0,e.exports}var i,n}),!function(a,s){"use strict";function t(t){if(!t)throw new Error("Element required to initialize object");this.element=t,this.$element=a(t),this.opened=!0}var n="Menu",r="aria-hidden",o="menu-selected",l="a,input,[tabindex]";t.prototype.fill=function(t,i){var n="";a.each(t,function(t,e){n+="<li"+(e===i?" class='"+o+"'":"")+">"+e+"</li>"}),this.$element.find("ol,ul").html(n)},t.prototype.moveSelected=function(t,e){var i,n=this.$element.find("li"),r=n.filter("."+o);r.length&&"start"!==t?"next"===t?(i=r.nextAll("li").first()).length||(i=n.eq(0)):(i=r.prevAll("li").first()).length||(i=n.eq(n.length-1)):i=n.not(".no-display").eq(this.selectedIndex),r.removeClass(o),i.addClass(o),this.selectedIndex=n.not(".no-display").index(i),(e||a(s.document.activeElement).closest(r).length)&&(i.is(l)?i[0].focus():(t=i.find(l)).length&&t[0].focus())},t.prototype.getSelectedElement=function(){return this.$element.find("li."+o)},t.prototype.selectActive=function(){var t=this.$element.data(n+"-trigger"),e=this.getSelectedElement();return t&&a(t).is("input")&&(t.value=e.text()),e.trigger(n+":select"),this.close(),e.text()},t.prototype.keycodes={38:function(t){this.moveSelected("prev"),t.preventDefault()},40:function(t){this.moveSelected("next"),t.preventDefault()},13:function(){return this.selectActive()},9:function(t){this.moveSelected(t.shiftKey?"prev":"next"),t.preventDefault()},27:function(){this.selectedIndex=parseFloat(this.$element.data("menuSelectedindex")||0),this.close()}},t.prototype.keyDown=function(t){return(this.keycodes[t.keyCode]||function(){}).call(this,t)},t.prototype._bindKeyHandling=function(){var e=this;this.$element.bind("keydown",function(t){e.keyDown(t)}).bind("mouseover",function(t){e.$element.find("."+o).removeClass(o),a(t.target).closest("li").addClass(o)}).bind("mouseleave",function(t){a(t.target).closest("li").removeClass(o)}).bind("click",function(){e.selectActive()})},t.prototype.open=function(t,e){this.opened||(this.selectedIndex=parseFloat(this.$element.data("menuSelectedindex")||0),this.$element.attr(r,!1),this.$element.data(n+"-trigger",t),this.opened=!0,this.moveSelected("start",e),this.$element.trigger(n+":open"),this.$element.get(0).scrollHeight>this.$element.height()?a("a",this.element).addClass("menuItemWithScroll"):a("a",this.element).removeClass("menuItemWithScroll"))},t.prototype.close=function(t){var e,i;this.opened&&(this.$element.data("menuSelectedindex",this.selectedIndex),this.$element.attr(r,!0),e=this.$element.data(n+"-trigger"),i=this,GCO5.core.GcDelayUtil.callLater(function(){i.opened=!1},[],2,this),e&&!t&&e.focus(),this.$element.trigger(n+":close"))},t.prototype.toggle=function(t,e){this[this.opened?"close":"open"](t,e)},t.prototype.init=function(){var e;this.$element.data(n)||(this.$element.data(n,this),this.$element.attr("role","menu"),this.close(),e=this,a(document).bind("mouseup",function(t){if(""==a(t.target).data("menu"))return!1;t=0<=["select-one","submit","search","checkbox"].indexOf(t.target.type);e.close(t)}),this._bindKeyHandling(),this.$element.trigger(n+":init"))},t.prototype.isOpen=function(){return this.opened},(s.componentNamespace=s.componentNamespace||s)[n]=t}(jQuery,this),!function(e){var i="menu";e.fn[i]=function(){return this.each(function(){new window.componentNamespace.Menu(this).init()})},e(document).bind("enhance",function(t){e("[data-menu]",t.target)[i]()})}((Menu,jQuery)),!function(e,t){"use strict";function i(t){if(!t)throw new Error("Element required to initialize object");this.element=t,this.$element=e(t),this.$menu=e("#"+this.$element.attr("data-menu-trigger")),this.menu=this.$menu.data("Menu")}var n="Menutrigger";i.prototype._bindbehavior=function(){var a=this,t=this.$element.is("a"),e=this.$element.is("button");t||e?this.$element.attr("role","button").bind("click",function(t){t.preventDefault(),a.menu.toggle(this,!0);var e=a.$element.outerWidth(),t=a.$element.outerHeight(),i=(1==a.$element.width()&&(t+=3),a.$element.offset()),n=a.$element.parent().offset(),r=(a.$menu.css("top",a.$element.position().top+t+2+4+"px"),GCO5.core.GcLangManager.getInstance().getTextDirection());"rtl"===r?(t=i.left+a.$element.width(),t=n.left+a.$element.parent().width()-t+e-a.$menu.width()-100,a.$menu.css("right",t+"px")):(t=i.left-n.left+e-a.$menu.width()-100,a.$menu.css("left",t+"px")),GCO5.core.GcDelayUtil.callLater(function(){var t;"rtl"===r?(t=i.left+a.$element.width(),t=n.left+a.$element.parent().width()-t+e-a.$menu.width(),a.$menu.css("right",Math.max(0,t)+"px")):a.$menu.css("left",Math.max(0,i.left-n.left+e-a.$menu.width())+"px")},[],0,this)}):this.$element.is("input")&&this.$element.bind("input keyup",function(){""===this.value?a.menu.close():a.menu.open(this,!1)}).bind("input keydown",function(t){a.menu.keyDown(t)}).bind("focus click",function(){""!==this.value&&a.menu.open()}).bind("blur",function(t){a.menu.close()})},i.prototype.init=function(){this.$element.data(n)||(this.$element.data(n,this),this.$element.attr("aria-controls",this.$menu.attr("id")),this.$element.attr("aria-haspopup","true"),this._bindbehavior(),this.$element.trigger(n+":init"),this.$element.trigger("click"))},t[n]=i}(jQuery,this),!function(t,e){var i="menu-trigger";e.fn[i]=function(){return this.each(function(){new t(this).init()})},e(document).bind("enhance",function(t){e("[data-menu-trigger]",t.target)[i]()})}(Menutrigger,jQuery),!function(){"use strict";var t=$("body"),a="data-controls",s="aria-expanded",o="data-hidden";$.fn.accessibleHideShowAria=function(t){$(this).each(function(t){var e=$(this),t=t+1,i=e.data(),i=void 0!==i.hideshowPrefixClass?i.hideshowPrefixClass+"-":"",n=e.next(".js-to_expand"),r=e.html();0<e.find(".expandmore__button").length||(e.html('<button class="'+i+'expandmore__button js-expandmore-button">'+r+"</button>"),r=e.children(".js-expandmore-button"),n.addClass(i+"expandmore__to_expand").stop().delay(1500).queue(function(){var t=$(this);t.hasClass("js-first_load")&&t.removeClass("js-first_load")}),r.attr("id","label_expand_"+t),r.attr(a,"expand_"+t),r.attr(s,"false"),n.attr("id","expand_"+t),n.attr(o,"true"),n.attr("data-labelledby","label_expand_"+t),n.hasClass("is-opened")&&(r.addClass("is-opened").attr(s,"true"),n.removeClass("is-opened").removeAttr(o)))})},$(document).ready(function(){t.on("click",".js-expandmore-button",function(t){var e=$(this),i=$("#"+e.attr(a),e.closest("div"));"false"===e.attr(s)?(e.addClass("is-opened").attr(s,"true"),i.removeAttr(o)):(e.removeClass("is-opened").attr(s,"false"),i.attr(o,"true")),t.preventDefault()}),t.on("click keydown",".js-expandmore",function(t){var e=$(this),i=$(t.target),e=e.find(".js-expandmore-button");if(!i.is(e)&&!i.closest(e).length)return"click"!=t.type&&("keydown"!=t.type||13!=t.keyCode&&32!=t.keyCode)?void 0:(e.trigger("click"),!1)})})}(),!function(){"use strict";$.fn.accessibleDialogTooltipAria=function(n){n=n||{},$(this).each(function(){var t=$(this),e=void 0!==n.tooltipPrefixClass?n.tooltipPrefixClass+"-":"",i=Math.random().toString(32).slice(2,12);t.attr("id")&&0===t.attr("id").indexOf("label_tooltip_")||(t.attr({id:"label_tooltip_"+i}),t.wrap('<span class="'+e+'container"></span>'))})},$(document).ready(function(){var t=$("body");t.on("click",function(t){t=$(t.target);t.is(".js-dialogtooltip")||t.is(".js-tooltip")||t.parents(".js-dialogtooltip").is(".js-dialogtooltip")||($(".js-dialogtooltip").remove(),$("body").removeClass("has-modal"))}).on("click keydown",".js-tooltip",function(t){var e,i,n,r,a,s,o,l,c,h;"keydown"==t.type&&13!=t.keyCode&&32!=t.keyCode||(i=void 0!==(l=(e=$(this)).data()).tooltipPrefixClass?l.tooltipPrefixClass+"-":"",n=l.tooltipText||"",r=void 0!==l.tooltipContentId?"#"+l.tooltipContentId:"",a=l.tooltipTitle||"",s=l.tooltipCloseText||"Close",o=l.tooltipCloseTitle||l.tooltipCloseText,l=!0===l.tooltipCloseNofocus,c=e.attr("id"),$("#js-tooltip").remove(),$(".js-tooltip").removeClass("is-active"),h='<dialog id="js-tooltip" class="js-dialogtooltip '+i+'tooltip" data-launched-by="click" role="dialog" aria-labelledby="tooltip-title"><div role="document">',h+='<button id="js-tooltip-close" class="'+i+'tooltip__close" data-focus-back="'+c+'" title="'+o+'">'+s+"</button>",""!==a&&(h+='<h1 id="tooltip-title" class="tooltip-title '+i+'tooltip__title">'+a+"</h1>"),""!==n?h+="<p>"+n+"</p>":r&&$(r).length&&(h+=$(r).html()),h+="</div></dialog>",$("body").addClass("has-modal"),setTimeout(function(){$(h).insertAfter(e)},50),l||setTimeout(function(){$("#js-tooltip-close").focus()},51),$("#"+c).addClass("is-active"),t.preventDefault())}).on("mouseleave","#js-tooltip",function(t){var e=$(this),i=e.data(),i=(i.launchedBy,$("#"+i.focusBack));e.find(".tooltip-close").click(),i.removeClass("is-active")}),t.on("click","#js-tooltip-close",function(t){var e=$(this),e=(e.parents("#js-tooltip").attr("data-launched-by"),$("#"+e.attr("data-focus-back")));$("#js-tooltip").remove(),e.focus(),e.removeClass("is-active"),$("body").removeClass("has-modal")}).on("keydown","#js-tooltip",function(t){var e,i,n=$(this);27==t.keyCode&&($("#js-tooltip-close").click(),t.preventDefault()),9==t.keyCode&&(n=n.find("*").filter("a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, object, embed, *[tabindex], *[contenteditable]").filter(":visible"),i=$(document.activeElement),e=n.length,i=n.index(i),t.shiftKey||i!=e-1||(n.get(0).focus(),t.preventDefault()),t.shiftKey&&0==i&&(n.get(e-1).focus(),t.preventDefault()))})})}(),!function(){"use strict";$.fn.accessibleTabsAria=function(t){var e=$(this);e.find(".js-tablist").each(function(){var t=$(this),a=t.data(),e=void 0!==a.tabsPrefixClass?a.tabsPrefixClass+"-":"",s=void 0!==a.hx?a.hx:"",o=void 0!==a.existingHx?a.existingHx:"",i=t.children(".js-tablist__item"),n=t.find(".js-tablist__link");t.attr("role","tablist"),i.attr("role","presentation"),n.attr("role","tab"),t.addClass(e+"tabs__list"),i.addClass(e+"tabs__item"),n.addClass(e+"tabs__link"),n.each(function(){var t=$(this),e=void 0!==a.tabsGeneratedHxClass?a.tabsGeneratedHxClass:"invisible",i=t.attr("href"),n=$(i),r=t.text();""!==s&&n.prepend("<"+s+' class="'+e+'" tabindex="0">'+r+"</"+s+">"),""!==o&&n.find(o+":first-child").attr("tabindex",0),void 0!==i&&""!==i&&"#"!==i&&(t.attr({"aria-controls":i.replace("#",""),tabindex:-1,"aria-selected":"false"}),t.parent().attr({"aria-selected":"false"})),t.removeAttr("href")})}),$(".js-tabcontent",$(this)).each(function(){"tabpanel"!=$(this).attr("role")&&$(this).attr({role:"tabpanel","aria-hidden":"true"});var t=$(this),e=t.attr("id"),i=$("#label_"+e).closest(".js-tablist").attr("data-tabs-prefix-class"),i=void 0!==i?i+"-":"";t.attr("aria-labelledby","label_"+e),t.addClass(i+"tabs__content")}),e.each(function(){var t=$(this),e=t.find('.js-tablist__link[aria-selected="true"]'),i=t.find(".js-tablist__link:first"),t=t.find(".js-tabcontent:first");0===e.length&&(i.attr({"aria-selected":"true",tabindex:0}),i.parent().attr({"aria-selected":"true"}),t.removeAttr("aria-hidden"))})},$(document).ready(function(){$("body").on("click",".js-tablist__link",function(t){var e=$(this),i=$("#"+e.attr("aria-controls")),n=e.closest(".js-tabs"),r=n.find(">ul .js-tablist__link"),n=n.find("> .js-tabcontent, >div .js-tabcontent");r.attr({tabindex:-1,"aria-selected":"false"}),r.parent().attr({"aria-selected":"false"}),e.attr({"aria-selected":"true",tabindex:0}),e.parent().attr({"aria-selected":"true"}),n.attr("aria-hidden","true"),i.removeAttr("aria-hidden"),t.preventDefault()}).on("keydown",".js-tablist",function(t){var e=$(this).closest(".js-tabs"),i=e.find('.js-tablist__link[aria-selected="true"]').parent(),n=e.find(".js-tablist__item:last-child .js-tablist__link"),r=e.find(".js-tablist__item:first-child .js-tablist__link"),a=!1;(a=$(document.activeElement).is(e.find(".js-tablist__link"))?!0:a)&&!t.ctrlKey&&(37==t.keyCode||38==t.keyCode?((i.is(".js-tablist__item:first-child")?n:i.prevAll(":visible").first().children(".js-tablist__link")).click().focus(),t.preventDefault()):40==t.keyCode||39==t.keyCode?((i.is(".js-tablist__item:last-child")?r:i.nextAll(":visible").first().children(".js-tablist__link")).click().focus(),t.preventDefault()):36==t.keyCode?(r.click().focus(),t.preventDefault()):35==t.keyCode&&(n.click().focus(),t.preventDefault()))}).on("keydown",".js-tabcontent",function(t){var e=$(this).attr("aria-labelledby"),e=$("#"+e),i=e.parent(),n=i.parent();37!=t.keyCode&&38!=t.keyCode||!t.ctrlKey||(e.focus(),t.preventDefault()),33==t.keyCode&&t.ctrlKey&&(e.focus(),(i.is(".js-tablist__item:first-child")?n.find(".js-tablist__item:last-child .js-tablist__link"):i.prev().children(".js-tablist__link")).click().focus(),t.preventDefault()),34==t.keyCode&&t.ctrlKey&&(e.focus(),(i.is(".js-tablist__item:last-child")?n.find(".js-tablist__item:first-child .js-tablist__link"):i.next().children(".js-tablist__link")).click().focus(),t.preventDefault())}).on("click",".js-link-to-tab",function(t){var e=$(this),e=$(e.attr("href")),i=$("#"+e.attr("aria-labelledby"));i.click(),setTimeout(function(){i.focus()},10)})})}(),!function(){"use strict";$.fn.accessibleAccordionAria=function(t){$(this).each(function(t){var e=$(this),i=e.data(),n=e.children(".js-accordion__header"),r=i.accordionPrefixClasses||"",a=i.accordionMultiselectable||"",s=i.accordionId||"",o=t+1;e.attr({role:"tablist","aria-multiselectable":"true",class:r}),"none"===a&&e.attr("aria-multiselectable","false"),n.each(function(t){var e=$(this),i=e.html(),n=e.next(".js-accordion__panel"),t=t+1,i=(n.prepend(e.removeClass("js-accordion__header").addClass(r+"__title").attr("tabindex","0")),$('<button class="js-accordion__header '+r+'__header">'+i+"</button>"));n.before(i),i.attr({"aria-controls":"accordion"+s+o+"_panel"+t,"aria-expanded":"false",role:"tab",id:"accordion"+s+o+"_tab"+t,tabindex:"-1","aria-selected":"false"}),n.attr({"aria-labelledby":"accordion"+s+o+"_tab"+t,role:"tabpanel",id:"accordion"+s+o+"_panel"+t,"aria-hidden":"true"}).addClass(r+"__panel"),"true"==e.attr("data-accordion-opened")&&(i.attr("aria-expanded","true").removeAttr("data-accordion-opened"),n.attr("aria-hidden","false")),1===t&&i.removeAttr("tabindex")})})},$(document).ready(function(){$("body").on("focus",".js-accordion__header",function(t){var e=$(this);e.parent().find(".js-accordion__header").attr({tabindex:"-1","aria-selected":"false"}),e.attr("aria-selected","true").removeAttr("tabindex")}).on("click",".js-accordion__header",function(t){var e=$(this),i=$("#"+e.attr("aria-controls")),n=e.parent(),r=n.attr("aria-multiselectable"),a=n.find(".js-accordion__header"),n=n.find(".js-accordion__panel");a.attr("aria-selected","false"),e.attr("aria-selected","true"),"false"==e.attr("aria-expanded")?(e.attr("aria-expanded","true"),i.attr("aria-hidden","false"),i.scrollIntoView()):(e.attr("aria-expanded","false"),i.attr("aria-hidden","true")),"false"==r&&(n.not(i).attr("aria-hidden","true"),a.not(e).attr("aria-expanded","false")),setTimeout(function(){e.focus()},0),t.preventDefault()}).on("keydown",".js-accordion__header",function(t){var e=$(this),i=e.parent(),n=i.find(".js-accordion__header"),r=i.find(".js-accordion__header").first(),a=i.find(".js-accordion__header").last(),s=e.prevAll(".js-accordion__header").first(),o=e.nextAll(".js-accordion__header").first();37!=t.keyCode&&38!=t.keyCode||t.ctrlKey?40!=t.keyCode&&39!=t.keyCode||t.ctrlKey?36==t.keyCode?(n.attr({tabindex:"-1","aria-selected":"false"}),r.attr("aria-selected","true").removeAttr("tabindex"),setTimeout(function(){r.focus()},0),t.preventDefault()):35==t.keyCode&&(n.attr({tabindex:"-1","aria-selected":"false"}),a.attr("aria-selected","true").removeAttr("tabindex"),setTimeout(function(){a.focus()},0),t.preventDefault()):(n.attr({tabindex:"-1","aria-selected":"false"}),e.is(a)?(r.attr("aria-selected","true").removeAttr("tabindex"),setTimeout(function(){r.focus()},0)):(o.attr("aria-selected","true").removeAttr("tabindex"),setTimeout(function(){o.focus()},0)),t.preventDefault()):(n.attr({tabindex:"-1","aria-selected":"false"}),e.is(r)?(a.attr("aria-selected","true").removeAttr("tabindex"),setTimeout(function(){a.focus()},0)):(s.attr("aria-selected","true").removeAttr("tabindex"),setTimeout(function(){s.focus()},0)),t.preventDefault())}).on("keydown",".js-accordion__panel",function(t){var e=$(this),i=$("#"+e.attr("aria-labelledby")),e=e.parent(),n=e.find(".js-accordion__header").first(),r=i.prevAll(".js-accordion__header").first(),a=i.nextAll(".js-accordion__header").first(),s=e.find(".js-accordion__header").last();38==t.keyCode&&t.ctrlKey?(setTimeout(function(){i.focus()},0),t.preventDefault()):33==t.keyCode&&t.ctrlKey?(i.is(n)?setTimeout(function(){s.focus()},0):setTimeout(function(){r.focus()},0),t.preventDefault()):34==t.keyCode&&t.ctrlKey&&(i.is(s)?setTimeout(function(){n.focus()},0):setTimeout(function(){a.focus()},0),t.preventDefault())})})}(),!function(d){d.fn.scrollIntoView=function(t,e,i){for(var n=d.extend({},d.fn.scrollIntoView.defaults),r=("object"==d.type(t)?d.extend(n,t):"number"==d.type(t)?d.extend(n,{duration:t,easing:e,complete:i}):0==t&&(n.smooth=!1),1/0),a=0,s=(1==this.length?null!=(r=this.get(0).offsetTop)&&(a=r+this.get(0).offsetHeight):this.each(function(t,e){e.offsetTop<r?r=e.offsetTop:e.offsetTop+e.offsetHeight>a&&(a=e.offsetTop+e.offsetHeight)}),a-=r,this.commonAncestor().get(0)),o=d(window).height();s;){var l=s.scrollTop,c=s.clientHeight;if(0==(c=o<c?o:c)&&"BODY"==s.tagName&&(c=o),s.scrollTop!=(null==(s.scrollTop+=1)||s.scrollTop)&&null!=--s.scrollTop||s.scrollTop!=(null==--s.scrollTop||s.scrollTop)&&null!=(s.scrollTop+=1))return void h(s,r<=l?r:l+c<r+a?r+a-c:void 0);s=s.parentNode}function h(t,e){void 0===e?d.isFunction(n.complete)&&n.complete.call(t):n.smooth?d(t).stop().animate({scrollTop:e},n):(t.scrollTop=e,d.isFunction(n.complete)&&n.complete.call(t))}return this},d.fn.scrollIntoView.defaults={smooth:!0,duration:null,easing:d.easing&&d.easing.easeOutExpo?"easeOutExpo":null,complete:d.noop(),step:null,specialEasing:{}},d.fn.isOutOfView=function(r){var a=!0;return this.each(function(){var t=this.parentNode,e=t.scrollTop,t=t.clientHeight,i=this.offsetTop,n=this.offsetHeight;(r?e+t<i:e+t<i+n)||(r?i+n<e:i<e)||(a=!1)}),a},d.fn.commonAncestor=function(){var e=[],i=1/0;d(this).each(function(){var t=d(this).parents();e.push(t),i=Math.min(i,t.length)});for(var t=0;t<e.length;t++)e[t]=e[t].slice(e[t].length-i);for(t=0;t<e[0].length;t++){var n,r=!0;for(n in e)if(e[n][t]!=e[0][t]){r=!1;break}if(r)return d(e[0][t])}return d([])}}(jQuery),!function(b,C,c){"use strict";var i,x,a,w,s,S,M,n,r,o,l,h,d,u,p,g,f="accessibleMegaMenu",m={uuidPrefix:"accessible-megamenu",menuClass:"accessible-megamenu",topNavItemClass:"accessible-megamenu-top-nav-item",panelClass:"accessible-megamenu-panel",panelGroupClass:"accessible-megamenu-panel-group",hoverClass:"hover",focusClass:"focus",openClass:"open"},O={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38,keyMap:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",190:"."}};function G(t,e){this.element=t,this.settings=b.extend({},m,e),this._defaults=m,this._name=f,this.mouseTimeoutID=null,this.focusTimeoutID=null,this.mouseFocused=!1,this.justFocused=!1,this.init()}function _(t){return b.expr.filters.visible(t)&&!b(t).parents().addBack().filter(function(){return"hidden"===b.css(this,"visibility")}).length}function v(t,e){var i,n,r=t.nodeName.toLowerCase();return"area"===r?(i=(n=t.parentNode).name,!(!t.href||!i||"map"!==n.nodeName.toLowerCase())&&(!!(n=b("img[usemap=#"+i+"]")[0])&&_(n))):(/input|select|textarea|button|object/.test(r)?!t.disabled:"a"===r&&t.href||e)&&_(t)}G.prototype=(i=0,x="",a="function"==typeof C.hasOwnProperty&&!!C.hasOwnProperty("ontouchstart"),w=function(t){return b(t).closest(":data(plugin_"+f+")").data("plugin_"+f)},s=function(t){t=b(t);var e=this.settings;t.attr("id")||t.attr("id",e.uuidPrefix+"-"+(new Date).getTime()+"-"+ ++i)},S=function(t,e){var i,n=b(t.target),r=this,a=this.settings,s=this.menu,o=n.closest("."+a.topNavItemClass),l=n.hasClass(a.panelClass)?n:n.closest("."+a.panelClass);g.call(this,!0),e?(o=s.find("."+a.topNavItemClass+" ."+a.openClass+":first").closest("."+a.topNavItemClass)).is(t.relatedTarget)||0<o.has(t.relatedTarget).length?0===o.length&&s.find("[aria-expanded=true]").attr("aria-expanded","false").removeClass(a.openClass).filter("."+a.panelClass).attr("aria-hidden","true"):("mouseout"===t.type||"focusout"===t.type)&&0<o.has(c.activeElement).length||(o.find("[aria-expanded]").attr("aria-expanded","false").removeClass(a.openClass).filter("."+a.panelClass).attr("aria-hidden","true"),("keydown"===t.type&&t.keyCode===O.ESCAPE||"DOMAttrModified"===t.type)&&(i=o.find(":tabbable:first"),setTimeout(function(){s.find("[aria-expanded]."+r.settings.panelClass).off("DOMAttrModified.accessible-megamenu"),i.focus(),r.justFocused=!1},99))):(clearTimeout(r.focusTimeoutID),o.siblings().find("[aria-expanded]").attr("aria-expanded","false").removeClass(a.openClass).filter("."+a.panelClass).attr("aria-hidden","true"),o.find("[aria-expanded]").attr("aria-expanded","true").addClass(a.openClass).filter("."+a.panelClass).attr("aria-hidden","false"),"mouseover"===t.type&&n.is(":tabbable")&&1===o.length&&0===l.length&&0<s.has(c.activeElement).length&&(n.focus(),r.justFocused=!1),g.call(r))},M=function(t){var e=b(t.currentTarget),i=e.closest("."+this.settings.topNavItemClass),n=e.closest("."+this.settings.panelClass);1===i.length&&0===n.length&&1===i.find("."+this.settings.panelClass).length&&(e.hasClass(this.settings.openClass)?this.justFocused?(t.preventDefault(),t.stopPropagation(),this.justFocused=!1):a&&(t.preventDefault(),t.stopPropagation(),S.call(this,t,e.hasClass(this.settings.openClass))):(t.preventDefault(),t.stopPropagation(),S.call(this,t),this.justFocused=!1))},n=function(t){0===b(t.target).closest(this.menu).length&&(t.preventDefault(),t.stopPropagation(),S.call(this,t,!0))},r=function(t){"aria-expanded"===t.originalEvent.attrName&&"false"===t.originalEvent.newValue&&b(t.target).hasClass(this.settings.openClass)&&(t.preventDefault(),t.stopPropagation(),S.call(this,t,!0))},o=function(t){clearTimeout(this.focusTimeoutID);var e=b(t.target),i=e.closest("."+this.settings.panelClass);e.addClass(this.settings.focusClass).on("click.accessible-megamenu",b.proxy(M,this)),this.justFocused=!this.mouseFocused,this.mouseFocused=!1,this.panels.not(i).filter("."+this.settings.openClass).length&&S.call(this,t)},l=function(e){this.justFocused=!1;var i=this,t=b(e.target),n=t.closest("."+this.settings.topNavItemClass);t.removeClass(this.settings.focusClass).off("click.accessible-megamenu"),C.cvox?i.focusTimeoutID=setTimeout(function(){C.cvox.Api.getCurrentNode(function(t){n.has(t).length?clearTimeout(i.focusTimeoutID):i.focusTimeoutID=setTimeout(function(t,e,i){S.call(t,e,i)},275,i,e,!0)})},25):i.focusTimeoutID=setTimeout(function(){S.call(i,e,!0)},300)},h=function(t){var e=this.constructor===G?this:w(this);if(e){var i,n,r,a,s,o,l=e.settings,c=b(b(this).is("."+l.hoverClass+":tabbable")?this:t.target),h=e.menu,d=e.topnavitems,u=c.closest("."+l.topNavItemClass),p=h.find(":tabbable"),h=c.hasClass(l.panelClass)?c:c.closest("."+l.panelClass),g=h.find("."+l.panelGroupClass),f=c.closest("."+l.panelGroupClass),m=t.keyCode||t.which,_=!1,v=O.keyMap[t.keyCode]||"",y=1===u.length&&0===h.length;if(!c.is("input:focus, select:focus, textarea:focus, button:focus")){switch(c.is("."+l.hoverClass+":tabbable")&&b("html").off("keydown.accessible-megamenu"),m){case O.ESCAPE:S.call(e,t,!0);break;case O.DOWN:t.preventDefault(),!(_=y?(S.call(e,t),1===u.find("."+l.panelClass+" :tabbable:first").focus().length):1===p.filter(":gt("+p.index(c)+"):first").focus().length)&&C.opera&&"[object Opera]"===opera.toString()&&(t.ctrlKey||t.metaKey)&&(r=(p=b(":tabbable")).index(c),_=1===b(":tabbable:gt("+b(":tabbable").index(c)+"):first").focus().length);break;case O.UP:t.preventDefault(),y&&c.hasClass(l.openClass)?(S.call(e,t,!0),(i=d.filter(":lt("+d.index(u)+"):last")).children("."+l.panelClass).length&&(_=1===i.children().attr("aria-expanded","true").addClass(l.openClass).filter("."+l.panelClass).attr("aria-hidden","false").find(":tabbable:last").focus())):y||(_=1===p.filter(":lt("+p.index(c)+"):last").focus().length),!_&&C.opera&&"[object Opera]"===opera.toString()&&(t.ctrlKey||t.metaKey)&&(r=(p=b(":tabbable")).index(c),_=1===b(":tabbable:lt("+b(":tabbable").index(c)+"):first").focus().length);break;case O.RIGHT:t.preventDefault(),_=y?1===d.filter(":gt("+d.index(u)+"):first").find(":tabbable:first").focus().length:(_=g.length&&f.length?1===g.filter(":gt("+g.index(f)+"):first").find(":tabbable:first").focus().length:_)||1===u.find(":tabbable:first").focus().length;break;case O.LEFT:t.preventDefault(),_=y?1===d.filter(":lt("+d.index(u)+"):last").find(":tabbable:first").focus().length:(_=g.length&&f.length?1===g.filter(":lt("+g.index(f)+"):last").find(":tabbable:first").focus().length:_)||1===u.find(":tabbable:first").focus().length;break;case O.TAB:r=p.index(c),t.shiftKey&&y&&c.hasClass(l.openClass)?(S.call(e,t,!0),(i=d.filter(":lt("+d.index(u)+"):last")).children("."+l.panelClass).length&&(_=i.children().attr("aria-expanded","true").addClass(l.openClass).filter("."+l.panelClass).attr("aria-hidden","false").find(":tabbable:last").focus())):t.shiftKey&&0<r?_=1===p.filter(":lt("+r+"):last").focus().length:!t.shiftKey&&r<p.length-1?_=1===p.filter(":gt("+r+"):first").focus().length:C.opera&&"[object Opera]"===opera.toString()&&(r=(p=b(":tabbable")).index(c),_=t.shiftKey?1===b(":tabbable:lt("+b(":tabbable").index(c)+"):last").focus().length:1===b(":tabbable:gt("+b(":tabbable").index(c)+"):first").focus().length),_&&t.preventDefault();break;case O.SPACE:if(!y)return!0;t.preventDefault(),M.call(e,t);break;case O.ENTER:return!0;default:if(clearTimeout(this.keydownTimeoutID),0===(x+=v!==x?v:"").length)return;for(this.keydownTimeoutID=setTimeout(function(){x=""},1e3),p=y&&!c.hasClass(l.openClass)?p.filter(":not(."+l.panelClass+" :tabbable)"):u.find(":tabbable"),t.shiftKey&&(p=b(p.get().reverse())),r=0;r<p.length;r++)if((a=p.eq(r)).is(c)){n=1===x.length?r+1:r;break}for(o=new RegExp("^"+x.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"),"i"),r=n;r<p.length;r++)if(a=p.eq(r),s=b.trim(a.text()),o.test(s)){_=!0,a.focus();break}if(!_)for(r=0;r<n;r++)if(a=p.eq(r),s=b.trim(a.text()),o.test(s)){a.focus();break}}e.justFocused=!1}}},d=function(t){(b(t.target).is(this.settings.panelClass)||b(t.target).closest(":focusable").length)&&(this.mouseFocused=!0),this.mouseTimeoutID=setTimeout(function(){clearTimeout(this.focusTimeoutID)},1)},u=function(t){clearTimeout(this.mouseTimeoutID),b(t.target).addClass(this.settings.hoverClass),S.call(this,t),b(t.target).is(":tabbable")&&b("html").on("keydown.accessible-megamenu",b.proxy(h,t.target))},p=function(t){var e=this;b(t.target).removeClass(e.settings.hoverClass),e.mouseTimeoutID=setTimeout(function(){S.call(e,t,!0)},250),b(t.target).is(":tabbable")&&b("html").off("keydown.accessible-megamenu")},g=function(t){var e=this.menu;t?(b("html").off("mouseup.outside-accessible-megamenu, touchend.outside-accessible-megamenu, mspointerup.outside-accessible-megamenu,  pointerup.outside-accessible-megamenu"),e.find("[aria-expanded]."+this.settings.panelClass).off("DOMAttrModified.accessible-megamenu")):(b("html").on("mouseup.outside-accessible-megamenu, touchend.outside-accessible-megamenu, mspointerup.outside-accessible-megamenu,  pointerup.outside-accessible-megamenu",b.proxy(n,this)),e.find("[aria-expanded=true]."+this.settings.panelClass).on("DOMAttrModified.accessible-megamenu",b.proxy(r,this)))},{constructor:G,init:function(){var t=this.settings,e=b(this.element),i=e.children().first(),n=i.children();this.start(t,e,i,n)},start:function(n,t,e,i){var r=this;this.settings=n,this.menu=e,this.topnavitems=i,t.attr("role","navigation"),e.addClass(n.menuClass),i.each(function(t,e){var i;(e=b(e)).addClass(n.topNavItemClass),i=e.find(":tabbable:first"),e=e.children(":not(:tabbable):last"),s.call(r,i),e.length&&(s.call(r,e),i.attr({"aria-haspopup":!0,"aria-controls":e.attr("id"),"aria-expanded":!1}),e.attr({role:"group","aria-expanded":!1,"aria-hidden":!0}).addClass(n.panelClass).not("[aria-labelledby]").attr("aria-labelledby",i.attr("id")))}),this.panels=e.find("."+n.panelClass),e.on("focusin.accessible-megamenu",":focusable, ."+n.panelClass,b.proxy(o,this)).on("focusout.accessible-megamenu",":focusable, ."+n.panelClass,b.proxy(l,this)).on("keydown.accessible-megamenu",b.proxy(h,this)).on("mouseover.accessible-megamenu",b.proxy(u,this)).on("mouseout.accessible-megamenu",b.proxy(p,this)).on("mousedown.accessible-megamenu",b.proxy(d,this)),a&&e.on("touchstart.accessible-megamenu",b.proxy(M,this)),e.find("hr").attr("role","separator"),b(c.activeElement).closest(e).length&&b(c.activeElement).trigger("focusin.accessible-megamenu")},getDefaults:function(){return this._defaults},getOption:function(t){return this.settings[t]},getAllOptions:function(){return this.settings},setOption:function(t,e,i){this.settings[t]=e,i&&this.init()}}),b.fn[f]=function(t){return this.each(function(){b.data(this,"plugin_"+f)||b.data(this,"plugin_"+f,new b.fn[f].AccessibleMegaMenu(this,t))})},b.fn[f].AccessibleMegaMenu=G,b.extend(b.expr[":"],{data:b.expr.createPseudo?b.expr.createPseudo(function(e){return function(t){return!!b.data(t,e)}}):function(t,e,i){return!!b.data(t,i[3])},focusable:function(t){return v(t,!isNaN(b.attr(t,"tabindex")))},tabbable:function(t){var e=b.attr(t,"tabindex"),i=isNaN(e);return(i||0<=e)&&v(t,!i)}})}(jQuery,window,document),!function(){"use strict";!function(Ut,$t){"use strict";var t,Bt={beforeShow:i,move:i,change:i,show:i,hide:i,color:!1,flat:!1,type:"",showInput:!1,allowEmpty:!0,showButtons:!0,clickoutFiresChange:!0,showInitial:!1,showPalette:!0,showPaletteOnly:!1,hideAfterPaletteSelect:!1,togglePaletteOnly:!1,showSelectionPalette:!0,localStorageKey:!1,appendTo:"body",maxSelectionSize:8,locale:"en",cancelText:"cancel",chooseText:"choose",togglePaletteMoreText:"more",togglePaletteLessText:"less",clearText:"Clear Color Selection",noColorSelectedText:"No Color Selected",preferredFormat:"name",className:"",containerClassName:"",replacerClassName:"",showAlpha:!0,theme:"sp-light",palette:[["#000000","#444444","#5b5b5b","#999999","#bcbcbc","#eeeeee","#f3f6f4","#ffffff"],["#f44336","#744700","#ce7e00","#8fce00","#2986cc","#16537e","#6a329f","#c90076"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#cc0000","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#990000","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#660000","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]],selectionPalette:[],disabled:!1,offset:null},zt=[],jt=!!/msie/i.exec(window.navigator.userAgent),Ht=((t=document.createElement("div").style).cssText="background-color:rgba(0,0,0,.5)",e(t.backgroundColor,"rgba")||e(t.backgroundColor,"hsla")),Wt=["<div class='sp-replacer'>","<div class='sp-preview'><div class='sp-preview-inner'></div></div>","<div class='sp-dd'>&#9660;</div>","</div>"].join(""),Zt=function(){var t="";if(jt)for(var e=1;e<=6;e++)t+="<div class='sp-"+e+"'></div>";return["<div class='sp-container sp-hidden'>","<div class='sp-palette-container'>","<div class='sp-palette sp-thumb sp-cf'></div>","<div class='sp-palette-button-container sp-cf'>","<button type='button' class='sp-palette-toggle'></button>","</div>","</div>","<div class='sp-picker-container'>","<div class='sp-top sp-cf'>","<div class='sp-fill'></div>","<div class='sp-top-inner'>","<div class='sp-color'>","<div class='sp-sat'>","<div class='sp-val'>","<div class='sp-dragger'></div>","</div>","</div>","</div>","<div class='sp-clear sp-clear-display'>","</div>","<div class='sp-hue'>","<div class='sp-slider'></div>",t,"</div>","</div>","<div class='sp-alpha'><div class='sp-alpha-inner'><div class='sp-alpha-handle'></div></div></div>","</div>","<div class='sp-input-container sp-cf'>","<input class='sp-input' type='text' spellcheck='false'  />","</div>","<div class='sp-initial sp-thumb sp-cf'></div>","<div class='sp-button-container sp-cf'>","<button class='sp-cancel' href='#'></button>","<button type='button' class='sp-choose'></button>","</div>","</div>","</div>"].join("")}();function e(t,e){return!!~(""+t).indexOf(e)}function Xt(t,e,i,n){for(var r=[],a=0;a<t.length;a++){var s=t[a];if(s){var o=tinycolor(s),l=o.toHsl().l<.5?"sp-thumb-el sp-thumb-dark":"sp-thumb-el sp-thumb-light";l+=tinycolor.equals(e,s)?" sp-thumb-active":"";var c=o.toString(n.preferredFormat||"rgb"),h=Ht?"background-color:"+o.toRgbString():"filter:"+o.toFilter();r.push('<span title="'+c+'" data-color="'+o.toRgbString()+'" class="'+l+'"><span class="sp-thumb-inner" style="'+h+';"></span></span>')}else r.push('<span class="sp-thumb-el sp-clear-display" ><span class="sp-clear-palette-only" style="background-color: transparent;"></span></span>')}return"<div class='sp-cf "+i+"'>"+r.join("")+"</div>"}function M(t,k){var F,V,U,$,u=function(t,e){t.locale=t.locale||window.navigator.language,t.locale&&(t.locale=t.locale.split("-")[0].toLowerCase()),"en"!=t.locale&&Ut.spectrum.localization[t.locale]&&(t=Ut.extend({},Ut.spectrum.localization[t.locale],t));var i=Ut.extend({},Bt,t);return i.callbacks={move:Yt(i.move,e),change:Yt(i.change,e),show:Yt(i.show,e),hide:Yt(i.hide,e),beforeShow:Yt(i.beforeShow,e)},i}(k,t),B=u.type,p="flat"==B,z=u.showSelectionPalette,i=u.localStorageKey,j=u.theme,n=u.callbacks,H=(F=R,function(){var t=this,e=arguments;U&&clearTimeout($),!U&&$||($=setTimeout(function(){$=null,F.apply(t,e)},V))}),g=!(V=10),W=!1,f=0,m=0,_=0,X=0,Y=0,q=0,K=0,d=0,o=0,l=0,v=1,r=[],a=[],Z={},s=u.selectionPalette.slice(0),J=u.maxSelectionSize,Q="sp-dragging",tt=!1,c=null,e=t.ownerDocument,y=(e.body,Ut(t)),et=!1,b=Ut(Zt,e).addClass(j),it=b.find(".sp-picker-container"),nt=b.find(".sp-color"),rt=b.find(".sp-dragger"),at=b.find(".sp-hue"),st=b.find(".sp-slider"),ot=b.find(".sp-alpha-inner"),lt=b.find(".sp-alpha"),ct=b.find(".sp-alpha-handle"),C=b.find(".sp-input"),ht=b.find(".sp-palette"),dt=b.find(".sp-initial"),ut=b.find(".sp-cancel"),pt=b.find(".sp-clear"),gt=b.find(".sp-choose"),ft=b.find(".sp-palette-toggle"),mt=y.is("input"),_t=(mt&&"color"===y.attr("type")&&Kt(),mt&&"color"==B),h=_t?Ut(Wt).addClass(j).addClass(u.className).addClass(u.replacerClassName):Ut([]),vt=_t?h:y,x=h.find(".sp-preview-inner"),w=u.color||mt&&y.val(),S=!1,M=u.preferredFormat,yt=!u.showButtons||u.clickoutFiresChange,O=!w,G=u.allowEmpty,I=null,T=null,bt=null,Ct=null,xt=y.attr("id");if(xt!==$t&&0<xt.length){var wt=Ut('label[for="'+xt+'"]');wt.length&&wt.on("click",function(t){return t.preventDefault(),y.spectrum("show"),!1})}function St(){if(u.showPaletteOnly&&(u.showPalette=!0),ft.text(u.showPaletteOnly?u.togglePaletteMoreText:u.togglePaletteLessText),u.palette){r=u.palette.slice(0),a=Ut.isArray(r[0])?r:[r],Z={};for(var t=0;t<a.length;t++)for(var e=0;e<a[t].length;e++){var i=tinycolor(a[t][e]).toRgbString();Z[i]=!0}u.showPaletteOnly&&!w&&(w=""===r[0][0]?r[0][0]:Object.keys(Z)[0])}b.toggleClass("sp-flat",p),b.toggleClass("sp-input-disabled",!u.showInput),b.toggleClass("sp-alpha-enabled",u.showAlpha),b.toggleClass("sp-clear-enabled",G),b.toggleClass("sp-buttons-disabled",!u.showButtons),b.toggleClass("sp-palette-buttons-disabled",!u.togglePaletteOnly),b.toggleClass("sp-palette-disabled",!u.showPalette),b.toggleClass("sp-palette-only",u.showPaletteOnly),b.toggleClass("sp-initial-disabled",!u.showInitial),b.addClass(u.className).addClass(u.containerClassName),R()}function Mt(){if(i){try{var t=window.localStorage,e=t[i].split(",#");1<e.length&&(delete t[i],Ut.each(e,function(t,e){Ot(e)}))}catch(t){}try{s=window.localStorage[i].split(";")}catch(t){}}}function Ot(t){if(z){var e=tinycolor(t).toRgbString();if(!Z[e]&&-1===Ut.inArray(e,s))for(s.push(e);s.length>J;)s.shift();if(i)try{window.localStorage[i]=s.join(";")}catch(t){}}}function Gt(){var i=D(),t=Ut.map(a,function(t,e){return Xt(t,i,"sp-palette-row sp-palette-row-"+e,u)});Mt(),s&&t.push(Xt(function(){var t=[];if(u.showPalette)for(var e=0;e<s.length;e++){var i=tinycolor(s[e]).toRgbString();Z[i]||t.push(s[e])}return t.reverse().slice(0,u.maxSelectionSize)}(),i,"sp-palette-row sp-palette-row-selection",u)),ht.html(t.join(""))}function It(){if(u.showInitial){var t=S,e=D();dt.html(Xt([t,e],e,"sp-palette-row-initial",u))}}function Tt(){(m<=0||f<=0||X<=0)&&R(),W=!0,b.addClass(Q),c=null,y.trigger("dragstart.spectrum",[D()])}function At(){W=!1,b.removeClass(Q),y.trigger("dragstop.spectrum",[D()])}function Pt(t){if(tt)tt=!1;else if(null!==t&&""!==t||!G){var e=tinycolor(t);e.isValid()?(P(e),E(),L()):C.addClass("sp-validation-error")}else P(null),E(),L()}function Dt(){(g?A:Et)()}function Et(){var t=Ut.Event("beforeShow.spectrum");g?R():(y.trigger(t,[D()]),!1===n.beforeShow(D())||t.isDefaultPrevented()||(function(){for(var t=0;t<zt.length;t++)zt[t]&&zt[t].hide()}(),g=!0,Ut(e).on("keydown.spectrum",Nt),Ut(e).on("click.spectrum",Lt),Ut(window).on("resize.spectrum",H),h.addClass("sp-active"),b.removeClass("sp-hidden"),R(),N(),S=D(),It(),n.show(S),y.trigger("show.spectrum",[S])))}function Nt(t){27===t.keyCode&&A()}function Lt(t){2!=t.button&&(W||(yt?L(!0):Rt(),A()))}function A(){g&&!p&&(g=!1,Ut(e).off("keydown.spectrum",Nt),Ut(e).off("click.spectrum",Lt),Ut(window).off("resize.spectrum",H),h.removeClass("sp-active"),b.addClass("sp-hidden"),n.hide(D()),y.trigger("hide.spectrum",[D()]))}function Rt(){P(S,!0),L(!0)}function P(t,e){var i,n;tinycolor.equals(t,D())?N():(t&&t!==$t||!G?(O=!1,n=(i=tinycolor(t)).toHsv(),d=n.h%360/360,o=n.s,l=n.v,v=n.a):O=!0,N(),i&&i.isValid()&&!e&&(M=u.preferredFormat||i.getFormat()))}function D(t){return t=t||{},G&&O?null:tinycolor.fromRatio({h:d,s:o,v:l,a:Math.round(1e3*v)/1e3},{format:t.format||M})}function E(){N(),n.move(D()),y.trigger("move.spectrum",[D()])}function N(){C.removeClass("sp-validation-error"),kt();var t=tinycolor.fromRatio({h:d,s:1,v:1});nt.css("background-color",t.toHexString());var e=M;v<1&&(0!==v||"name"!==e)&&("hex"!==e&&"hex3"!==e&&"hex6"!==e&&"name"!==e||(e="rgb"));var i=D({format:e}),n="";if(x.removeClass("sp-clear-display"),x.css("background-color","transparent"),!i&&G)x.addClass("sp-clear-display");else{var r=i.toHexString(),a=i.toRgbString();if(Ht||1===i.alpha?x.css("background-color",a):(x.css("background-color","transparent"),x.css("filter",i.toFilter())),u.showAlpha){var s=i.toRgb();s.a=0;var o=tinycolor(s).toRgbString(),l="linear-gradient(left, "+o+", "+r+")";jt?ot.css("filter",tinycolor(o).toFilter({gradientType:1},r)):(ot.css("background","-webkit-"+l),ot.css("background","-moz-"+l),ot.css("background","-ms-"+l),ot.css("background","linear-gradient(to right, "+o+", "+r+")"))}n=i.toString(e)}if(u.showInput&&C.val(n),y.val(n),"text"==u.type||"component"==u.type){var c=i;if(c&&T){var h=c.isLight()||c.getAlpha()<.4?"black":"white";T.css("background-color",c.toRgbString()).css("color",h)}else T.css("background-color",Ct).css("color",bt)}u.showPalette&&Gt(),It()}function kt(){var t=o,e=l;if(G&&O)ct.hide(),st.hide(),rt.hide();else{ct.show(),st.show(),rt.show();var i=t*f,n=m-e*m;i=Math.max(-_,Math.min(f-_,i-_)),n=Math.max(-_,Math.min(m-_,n-_)),rt.css({top:n+"px",left:i+"px"});var r=v*Y;ct.css({left:r-q/2+"px"});var a=d*X;st.css({top:a-K+"px"})}}function L(t){var e=D(),i=!tinycolor.equals(e,S);e&&(e.toString(M),Ot(e)),t&&i&&(n.change(e),tt=!0,y.trigger("change",[e]))}function R(){var t,e,i,n,r,a,s,o,l,c,h,d;g&&(f=nt.width(),m=nt.height(),_=rt.height(),at.width(),X=at.height(),K=st.height(),Y=lt.width(),q=ct.width(),p||(b.css("position","absolute"),u.offset?b.offset(u.offset):b.offset((e=vt,i=(t=b).outerWidth(),n=t.outerHeight(),r=e.outerHeight(),a=t[0].ownerDocument,s=a.documentElement,o=s.clientWidth+Ut(a).scrollLeft(),l=s.clientHeight+Ut(a).scrollTop(),c=e.offset(),h=c.left,d=c.top,d+=r,h-=Math.min(h,o<h+i&&i<o?Math.abs(h+i-o):0),{top:d-=Math.min(d,l<d+n&&n<l?Math.abs(+(n+r)):0),bottom:c.bottom,left:h,right:c.right,width:c.width,height:c.height}))),kt(),u.showPalette&&Gt(),y.trigger("reflow.spectrum"))}function Ft(){A(),et=!0,y.attr("disabled",!0),vt.addClass("sp-disabled")}!function(){if(jt&&b.find("*:not(input)").attr("unselectable","on"),St(),I=Ut('<span class="sp-original-input-container"></span>'),["margin"].forEach(function(t){I.css(t,y.css(t))}),"block"==y.css("display")&&I.css("display","flex"),_t)y.after(h).hide();else if("text"==B)I.addClass("sp-colorize-container"),y.addClass("spectrum sp-colorize").wrap(I);else if("component"==B){y.addClass("spectrum").wrap(I);var t=Ut(["<div class='sp-colorize-container sp-add-on'>","<div class='sp-colorize'></div> ","</div>"].join(""));t.width(y.outerHeight()+"px").css("border-radius",y.css("border-radius")).css("border",y.css("border")),y.addClass("with-add-on").before(t)}if(T=y.parent().find(".sp-colorize"),bt=T.css("color"),Ct=T.css("background-color"),G||pt.hide(),p)y.after(b).hide();else{var e="parent"===u.appendTo?y.parent():Ut(u.appendTo);1!==e.length&&(e=Ut("body")),e.append(b)}function i(t){return t.data&&t.data.ignore?(P(Ut(t.target).closest(".sp-thumb-el").data("color")),E()):(P(Ut(t.target).closest(".sp-thumb-el").data("color")),E(),u.hideAfterPaletteSelect?(L(!0),A()):L()),!1}Mt(),vt.on("click.spectrum touchstart.spectrum",function(t){et||Dt(),t.stopPropagation(),Ut(t.target).is("input")||t.preventDefault()}),!y.is(":disabled")&&!0!==u.disabled||Ft(),b.click(Jt),[C,y].forEach(function(e){e.change(function(){Pt(e.val())}),e.on("paste",function(){setTimeout(function(){Pt(e.val())},1)}),e.keydown(function(t){13==t.keyCode&&(Pt(Ut(e).val()),e==y&&A())})}),ut.text(u.cancelText),ut.on("click.spectrum",function(t){t.stopPropagation(),t.preventDefault(),Rt(),A()}),pt.attr("title",u.clearText),pt.on("click.spectrum",function(t){t.stopPropagation(),t.preventDefault(),O=!0,E(),p&&L(!0)}),gt.text(u.chooseText),gt.on("click.spectrum",function(t){t.stopPropagation(),t.preventDefault(),jt&&C.is(":focus")&&C.trigger("change"),C.hasClass("sp-validation-error")||(L(!0),A())}),ft.text(u.showPaletteOnly?u.togglePaletteMoreText:u.togglePaletteLessText),ft.on("click.spectrum",function(t){t.stopPropagation(),t.preventDefault(),u.showPaletteOnly=!u.showPaletteOnly,u.showPaletteOnly||p||b.css("left","-="+(it.outerWidth(!0)+5)),St()}),qt(lt,function(t,e,i){v=t/Y,O=!1,i.shiftKey&&(v=Math.round(10*v)/10),E()},Tt,At),qt(at,function(t,e){d=parseFloat(e/X),O=!1,u.showAlpha||(v=1),E()},Tt,At),qt(nt,function(t,e,i){if(i.shiftKey){if(!c){var n=o*f,r=m-l*m,a=Math.abs(t-n)>Math.abs(e-r);c=a?"x":"y"}}else c=null;var s=!c||"y"===c;c&&"x"!==c||(o=parseFloat(t/f)),s&&(l=parseFloat((m-e)/m)),O=!1,u.showAlpha||(v=1),E()},Tt,At),w?(P(w),N(),M=tinycolor(w).format||u.preferredFormat,Ot(w)):(""===w&&P(w),N()),p&&Et();var n=jt?"mousedown.spectrum":"click.spectrum touchstart.spectrum";ht.on(n,".sp-thumb-el",i),dt.on(n,".sp-thumb-el:nth-child(1)",{ignore:!0},i)}();var Vt={show:Et,hide:A,toggle:Dt,reflow:R,option:function(t,e){return t===$t?Ut.extend({},u):e===$t?u[t]:(u[t]=e,"preferredFormat"===t&&(M=u.preferredFormat),void St())},enable:function(){et=!1,y.attr("disabled",!1),vt.removeClass("sp-disabled")},disable:Ft,offset:function(t){u.offset=t,R()},set:function(t){P(t),L()},get:D,destroy:function(){y.show().removeClass("spectrum with-add-on sp-colorize"),vt.off("click.spectrum touchstart.spectrum"),b.remove(),h.remove(),T&&T.css("background-color",Ct).css("color",bt);var t=y.closest(".sp-original-input-container");0<t.length&&t.after(y).remove(),zt[Vt.id]=null},container:b};return Vt.id=zt.push(Vt)-1,Vt}function i(){}function Jt(t){t.stopPropagation()}function Yt(t,e){var i=Array.prototype.slice,n=i.call(arguments,2);return function(){return t.apply(e,n.concat(i.call(arguments)))}}function qt(s,o,e,t){o=o||function(){},e=e||function(){},t=t||function(){};var l=document,c=!1,h={},d=0,u=0,p="ontouchstart"in window,i={};function g(t){t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),t.returnValue=!1}function n(t){if(c){if(jt&&l.documentMode<9&&!t.button)return f();var e=t.originalEvent&&t.originalEvent.touches&&t.originalEvent.touches[0],i=e&&e.pageX||t.pageX,n=e&&e.pageY||t.pageY,r=Math.max(0,Math.min(i-h.left,u)),a=Math.max(0,Math.min(n-h.top,d));p&&g(t),o.apply(s,[r,a,t])}}function f(){c&&(Ut(l).off(i),Ut(l.body).removeClass("sp-dragging"),setTimeout(function(){t.apply(s,arguments)},0)),c=!1}i.selectstart=g,i.dragstart=g,i["touchmove mousemove"]=n,i["touchend mouseup"]=f,Ut(s).on("touchstart mousedown",function(t){(t.which?3==t.which:2==t.button)||c||!1!==e.apply(s,arguments)&&(c=!0,d=Ut(s).height(),u=Ut(s).width(),h=Ut(s).offset(),Ut(l).on(i),Ut(l.body).addClass("sp-dragging"),n(t),g(t))})}function Kt(){return Ut.fn.spectrum.inputTypeColorSupport()}var a="spectrum.id",O=(Ut.fn.spectrum=function(i,t){if("string"!=typeof i)return this.spectrum("destroy").each(function(){var t=Ut.extend({},Ut(this).data(),i);Ut(this).is("input")?t.flat||"flat"==t.type?t.type="flat":"color"==Ut(this).attr("type")?t.type="color":t.type=t.type||"component":t.type="noInput";var e=M(this,t);Ut(this).data(a,e.id)});var n=this,r=Array.prototype.slice.call(arguments,1);return this.each(function(){var t=zt[Ut(this).data(a)];if(t){var e=t[i];if(!e)throw new Error("Spectrum: no such method: '"+i+"'");"get"==i?n=t.get():"container"==i?n=t.container:"option"==i?n=t.option.apply(t,r):"destroy"==i?(t.destroy(),Ut(this).removeData(a)):e.apply(t,r)}}),n},Ut.fn.spectrum.load=!0,Ut.fn.spectrum.loadOpts={},Ut.fn.spectrum.draggable=qt,Ut.fn.spectrum.defaults=Bt,Ut.fn.spectrum.inputTypeColorSupport=function t(){if(void 0===t._cachedResult){var e=Ut("<input type='color'/>")[0];t._cachedResult="color"===e.type&&""!==e.value}return t._cachedResult},Ut.spectrum={},Ut.spectrum.localization={},Ut.spectrum.palettes={},Ut.fn.spectrum.processNativeColorInputs=function(){var t=Ut("input[type=color]");t.length&&!Kt()&&t.spectrum({preferredFormat:"hex6"})},/^[\s,#]+/),G=/\s+$/,I=0,c=Math,s=c.round,h=c.min,d=c.max,n=c.random,u=function(t,e){if(e=e||{},(t=t||"")instanceof u)return t;if(!(this instanceof u))return new u(t,e);var i=function(t){var e={r:0,g:0,b:0},i=1,n=!1,r=!1;"string"==typeof t&&(t=function(t){t=t.replace(O,"").replace(G,"").toLowerCase();var e,i=!1;if(g[t])t=g[t],i=!0;else if("transparent"==t)return{r:0,g:0,b:0,a:0,format:"name"};if(e=S.rgb.exec(t))return{r:e[1],g:e[2],b:e[3]};if(e=S.rgba.exec(t))return{r:e[1],g:e[2],b:e[3],a:e[4]};if(e=S.hsl.exec(t))return{h:e[1],s:e[2],l:e[3]};if(e=S.hsla.exec(t))return{h:e[1],s:e[2],l:e[3],a:e[4]};if(e=S.hsv.exec(t))return{h:e[1],s:e[2],v:e[3]};if(e=S.hsva.exec(t))return{h:e[1],s:e[2],v:e[3],a:e[4]};if(e=S.hex8.exec(t))return{a:function(t){return v(t)/255}(e[1]),r:v(e[2]),g:v(e[3]),b:v(e[4]),format:i?"name":"hex8"};if(e=S.hex6.exec(t))return{r:v(e[1]),g:v(e[2]),b:v(e[3]),format:i?"name":"hex"};if(e=S.hex3.exec(t))return{r:v(e[1]+""+e[1]),g:v(e[2]+""+e[2]),b:v(e[3]+""+e[3]),format:i?"name":"hex"};return!1}(t));"object"==typeof t&&(t.hasOwnProperty("r")&&t.hasOwnProperty("g")&&t.hasOwnProperty("b")?(e=function(t,e,i){return{r:255*m(t,255),g:255*m(e,255),b:255*m(i,255)}}(t.r,t.g,t.b),n=!0,r="%"===String(t.r).substr(-1)?"prgb":"rgb"):t.hasOwnProperty("h")&&t.hasOwnProperty("s")&&t.hasOwnProperty("v")?(t.s=b(t.s),t.v=b(t.v),e=function(t,e,i){t=6*m(t,360),e=m(e,100),i=m(i,100);var n=c.floor(t),r=t-n,a=i*(1-e),s=i*(1-r*e),o=i*(1-(1-r)*e),l=n%6;return{r:255*[i,s,a,a,o,i][l],g:255*[o,i,i,s,a,a][l],b:255*[a,a,o,i,i,s][l]}}(t.h,t.s,t.v),n=!0,r="hsv"):t.hasOwnProperty("h")&&t.hasOwnProperty("s")&&t.hasOwnProperty("l")&&(t.s=b(t.s),t.l=b(t.l),e=function(t,e,i){var n,r,a;function s(t,e,i){return i<0&&(i+=1),1<i&&--i,i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t}if(t=m(t,360),e=m(e,100),i=m(i,100),0===e)n=r=a=i;else{var o=i<.5?i*(1+e):i+e-i*e,l=2*i-o;n=s(l,o,t+1/3),r=s(l,o,t),a=s(l,o,t-1/3)}return{r:255*n,g:255*r,b:255*a}}(t.h,t.s,t.l),n=!0,r="hsl"),t.hasOwnProperty("a")&&(i=t.a));return i=f(i),{ok:n,format:t.format||r,r:h(255,d(e.r,0)),g:h(255,d(e.g,0)),b:h(255,d(e.b,0)),a:i}}(t);this._originalInput=t,this._r=i.r,this._g=i.g,this._b=i.b,this._a=i.a,this._roundA=s(1e3*this._a)/1e3,this._format=e.format||i.format,this._gradientType=e.gradientType,this._r<1&&(this._r=s(this._r)),this._g<1&&(this._g=s(this._g)),this._b<1&&(this._b=s(this._b)),this._ok=i.ok,this._tc_id=I++};function r(t,e,i){t=m(t,255),e=m(e,255),i=m(i,255);var n,r,a=d(t,e,i),s=h(t,e,i),o=(a+s)/2;if(a==s)n=r=0;else{var l=a-s;switch(r=.5<o?l/(2-a-s):l/(a+s),a){case t:n=(e-i)/l+(e<i?6:0);break;case e:n=(i-t)/l+2;break;case i:n=(t-e)/l+4}n/=6}return{h:n,s:r,l:o}}function o(t,e,i){t=m(t,255),e=m(e,255),i=m(i,255);var n,r,a=d(t,e,i),s=h(t,e,i),o=a,l=a-s;if(r=0===a?0:l/a,a==s)n=0;else{switch(a){case t:n=(e-i)/l+(e<i?6:0);break;case e:n=(i-t)/l+2;break;case i:n=(t-e)/l+4}n/=6}return{h:n,s:r,v:o}}function l(t,e,i,n){var r=[y(s(t).toString(16)),y(s(e).toString(16)),y(s(i).toString(16))];return n&&r[0].charAt(0)==r[0].charAt(1)&&r[1].charAt(0)==r[1].charAt(1)&&r[2].charAt(0)==r[2].charAt(1)?r[0].charAt(0)+r[1].charAt(0)+r[2].charAt(0):r.join("")}function p(t,e,i,n){var r;return[y((r=n,Math.round(255*parseFloat(r)).toString(16))),y(s(t).toString(16)),y(s(e).toString(16)),y(s(i).toString(16))].join("")}function T(t,e){e=0===e?0:e||10;var i=u(t).toHsl();return i.s-=e/100,i.s=_(i.s),u(i)}function A(t,e){e=0===e?0:e||10;var i=u(t).toHsl();return i.s+=e/100,i.s=_(i.s),u(i)}function P(t){return u(t).desaturate(100)}function D(t,e){e=0===e?0:e||10;var i=u(t).toHsl();return i.l+=e/100,i.l=_(i.l),u(i)}function E(t,e){e=0===e?0:e||10;var i=u(t).toRgb();return i.r=d(0,h(255,i.r-s(-e/100*255))),i.g=d(0,h(255,i.g-s(-e/100*255))),i.b=d(0,h(255,i.b-s(-e/100*255))),u(i)}function N(t,e){e=0===e?0:e||10;var i=u(t).toHsl();return i.l-=e/100,i.l=_(i.l),u(i)}function L(t,e){var i=u(t).toHsl(),n=(s(i.h)+e)%360;return i.h=n<0?360+n:n,u(i)}function R(t){var e=u(t).toHsl();return e.h=(e.h+180)%360,u(e)}function k(t){var e=u(t).toHsl(),i=e.h;return[u(t),u({h:(i+120)%360,s:e.s,l:e.l}),u({h:(i+240)%360,s:e.s,l:e.l})]}function F(t){var e=u(t).toHsl(),i=e.h;return[u(t),u({h:(i+90)%360,s:e.s,l:e.l}),u({h:(i+180)%360,s:e.s,l:e.l}),u({h:(i+270)%360,s:e.s,l:e.l})]}function V(t){var e=u(t).toHsl(),i=e.h;return[u(t),u({h:(i+72)%360,s:e.s,l:e.l}),u({h:(i+216)%360,s:e.s,l:e.l})]}function U(t,e,i){e=e||6,i=i||30;var n=u(t).toHsl(),r=360/i,a=[u(t)];for(n.h=(n.h-(r*e>>1)+720)%360;--e;)n.h=(n.h+r)%360,a.push(u(n));return a}function $(t,e){e=e||6;for(var i=u(t).toHsv(),n=i.h,r=i.s,a=i.v,s=[],o=1/e;e--;)s.push(u({h:n,s:r,v:a})),a=(a+o)%1;return s}u.prototype={isDark:function(){return this.getBrightness()<128},isLight:function(){return!this.isDark()},isValid:function(){return this._ok},getOriginalInput:function(){return this._originalInput},getFormat:function(){return this._format},getAlpha:function(){return this._a},getBrightness:function(){var t=this.toRgb();return(299*t.r+587*t.g+114*t.b)/1e3},setAlpha:function(t){return this._a=f(t),this._roundA=s(1e3*this._a)/1e3,this},toHsv:function(){var t=o(this._r,this._g,this._b);return{h:360*t.h,s:t.s,v:t.v,a:this._a}},toHsvString:function(){var t=o(this._r,this._g,this._b),e=s(360*t.h),i=s(100*t.s),n=s(100*t.v);return 1==this._a?"hsv("+e+", "+i+"%, "+n+"%)":"hsva("+e+", "+i+"%, "+n+"%, "+this._roundA+")"},toHsl:function(){var t=r(this._r,this._g,this._b);return{h:360*t.h,s:t.s,l:t.l,a:this._a}},toHslString:function(){var t=r(this._r,this._g,this._b),e=s(360*t.h),i=s(100*t.s),n=s(100*t.l);return 1==this._a?"hsl("+e+", "+i+"%, "+n+"%)":"hsla("+e+", "+i+"%, "+n+"%, "+this._roundA+")"},toHex:function(t){return l(this._r,this._g,this._b,t)},toHexString:function(t){return"#"+this.toHex(t)},toHex8:function(){return p(this._r,this._g,this._b,this._a)},toHex8String:function(){return"#"+this.toHex8()},toRgb:function(){return{r:s(this._r),g:s(this._g),b:s(this._b),a:this._a}},toRgbString:function(){return 1==this._a?"rgb("+s(this._r)+", "+s(this._g)+", "+s(this._b)+")":"rgba("+s(this._r)+", "+s(this._g)+", "+s(this._b)+", "+this._roundA+")"},toPercentageRgb:function(){return{r:s(100*m(this._r,255))+"%",g:s(100*m(this._g,255))+"%",b:s(100*m(this._b,255))+"%",a:this._a}},toPercentageRgbString:function(){return 1==this._a?"rgb("+s(100*m(this._r,255))+"%, "+s(100*m(this._g,255))+"%, "+s(100*m(this._b,255))+"%)":"rgba("+s(100*m(this._r,255))+"%, "+s(100*m(this._g,255))+"%, "+s(100*m(this._b,255))+"%, "+this._roundA+")"},toName:function(){return 0===this._a?"transparent":!(this._a<1)&&(B[l(this._r,this._g,this._b,!0)]||!1)},toFilter:function(t){var e="#"+p(this._r,this._g,this._b,this._a),i=e,n=this._gradientType?"GradientType = 1, ":"";t&&(i=u(t).toHex8String());return"progid:DXImageTransform.Microsoft.gradient("+n+"startColorstr="+e+",endColorstr="+i+")"},toString:function(t){var e=!!t;t=t||this._format;var i=!1,n=this._a<1&&0<=this._a;return e||!n||"hex"!==t&&"hex6"!==t&&"hex3"!==t&&"name"!==t?("rgb"===t&&(i=this.toRgbString()),"prgb"===t&&(i=this.toPercentageRgbString()),"hex"!==t&&"hex6"!==t||(i=this.toHexString()),"hex3"===t&&(i=this.toHexString(!0)),"hex8"===t&&(i=this.toHex8String()),"name"===t&&(i=this.toName()),"hsl"===t&&(i=this.toHslString()),"hsv"===t&&(i=this.toHsvString()),i||this.toHexString()):"name"===t&&0===this._a?this.toName():this.toRgbString()},_applyModification:function(t,e){var i=t.apply(null,[this].concat([].slice.call(e)));return this._r=i._r,this._g=i._g,this._b=i._b,this.setAlpha(i._a),this},lighten:function(){return this._applyModification(D,arguments)},brighten:function(){return this._applyModification(E,arguments)},darken:function(){return this._applyModification(N,arguments)},desaturate:function(){return this._applyModification(T,arguments)},saturate:function(){return this._applyModification(A,arguments)},greyscale:function(){return this._applyModification(P,arguments)},spin:function(){return this._applyModification(L,arguments)},_applyCombination:function(t,e){return t.apply(null,[this].concat([].slice.call(e)))},analogous:function(){return this._applyCombination(U,arguments)},complement:function(){return this._applyCombination(R,arguments)},monochromatic:function(){return this._applyCombination($,arguments)},splitcomplement:function(){return this._applyCombination(V,arguments)},triad:function(){return this._applyCombination(k,arguments)},tetrad:function(){return this._applyCombination(F,arguments)}},u.fromRatio=function(t,e){if("object"==typeof t){var i={};for(var n in t)t.hasOwnProperty(n)&&(i[n]="a"===n?t[n]:b(t[n]));t=i}return u(t,e)},u.equals=function(t,e){return!(!t||!e)&&u(t).toRgbString()==u(e).toRgbString()},u.random=function(){return u.fromRatio({r:n(),g:n(),b:n()})},u.mix=function(t,e,i){i=0===i?0:i||50;var n,r=u(t).toRgb(),a=u(e).toRgb(),s=i/100,o=2*s-1,l=a.a-r.a,c=1-(n=((n=o*l==-1?o:(o+l)/(1+o*l))+1)/2),h={r:a.r*n+r.r*c,g:a.g*n+r.g*c,b:a.b*n+r.b*c,a:a.a*s+r.a*(1-s)};return u(h)},u.readability=function(t,e){var i=u(t),n=u(e),r=i.toRgb(),a=n.toRgb(),s=i.getBrightness(),o=n.getBrightness(),l=Math.max(r.r,a.r)-Math.min(r.r,a.r)+Math.max(r.g,a.g)-Math.min(r.g,a.g)+Math.max(r.b,a.b)-Math.min(r.b,a.b);return{brightness:Math.abs(s-o),color:l}},u.isReadable=function(t,e){var i=u.readability(t,e);return 125<i.brightness&&500<i.color},u.mostReadable=function(t,e){for(var i=null,n=0,r=!1,a=0;a<e.length;a++){var s=u.readability(t,e[a]),o=125<s.brightness&&500<s.color,l=s.brightness/125*3+s.color/500;(o&&!r||o&&r&&n<l||!o&&!r&&n<l)&&(r=o,n=l,i=u(e[a]))}return i};var g=u.names={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"0ff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"00f",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",burntsienna:"ea7e5d",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"0ff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"f0f",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",rebeccapurple:"663399",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"},B=u.hexNames=function(t){var e={};for(var i in t)t.hasOwnProperty(i)&&(e[t[i]]=i);return e}(g);function f(t){return t=parseFloat(t),(isNaN(t)||t<0||1<t)&&(t=1),t}function m(t,e){var i;"string"==typeof(i=t)&&-1!=i.indexOf(".")&&1===parseFloat(i)&&(t="100%");var n,r="string"==typeof(n=t)&&-1!=n.indexOf("%");return t=h(e,d(0,parseFloat(t))),r&&(t=parseInt(t*e,10)/100),c.abs(t-e)<1e-6?1:t%e/parseFloat(e)}function _(t){return h(1,d(0,t))}function v(t){return parseInt(t,16)}function y(t){return 1==t.length?"0"+t:""+t}function b(t){return t<=1&&(t=100*t+"%"),t}var C,x,w,S=(x="[\\s|\\(]+("+(C="(?:[-\\+]?\\d*\\.\\d+%?)|(?:[-\\+]?\\d+%?)")+")[,|\\s]+("+C+")[,|\\s]+("+C+")\\s*\\)?",w="[\\s|\\(]+("+C+")[,|\\s]+("+C+")[,|\\s]+("+C+")[,|\\s]+("+C+")\\s*\\)?",{rgb:new RegExp("rgb"+x),rgba:new RegExp("rgba"+w),hsl:new RegExp("hsl"+x),hsla:new RegExp("hsla"+w),hsv:new RegExp("hsv"+x),hsva:new RegExp("hsva"+w),hex3:/^([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,hex8:/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/});window.tinycolor=u,Ut(function(){Ut.fn.spectrum.load&&Ut.fn.spectrum.processNativeColorInputs()})}(jQuery)}(),jQuery.spectrum.localization.ar={cancelText:"إلغاء",chooseText:"إختار",clearText:"إرجاع الألوان على ما كانت",noColorSelectedText:"لم تختار أي لون",togglePaletteMoreText:"أكثر",togglePaletteLessText:"أقل"},jQuery.spectrum.localization.ca={cancelText:"Cancel·lar",chooseText:"Escollir",clearText:"Esborrar color seleccionat",noColorSelectedText:"Cap color seleccionat",togglePaletteMoreText:"Més",togglePaletteLessText:"Menys"},jQuery.spectrum.localization.cs={cancelText:"zrušit",chooseText:"vybrat",clearText:"Resetovat výměr barev",noColorSelectedText:"Žádná barva nebyla vybrána",togglePaletteMoreText:"více",togglePaletteLessText:"méně"},jQuery.spectrum.localization.de={cancelText:"Abbrechen",chooseText:"Wählen",clearText:"Farbauswahl zurücksetzen",noColorSelectedText:"Keine Farbe ausgewählt",togglePaletteMoreText:"Mehr",togglePaletteLessText:"Weniger"},jQuery.spectrum.localization.dk={cancelText:"annuller",chooseText:"Vælg"},jQuery.spectrum.localization.es={cancelText:"Cancelar",chooseText:"Elegir",clearText:"Borrar color seleccionado",noColorSelectedText:"Ningún color seleccionado",togglePaletteMoreText:"Más",togglePaletteLessText:"Menos"},jQuery.spectrum.localization.et={cancelText:"Katkesta",chooseText:"Vali",clearText:"Tühista värvivalik",noColorSelectedText:"Ühtki värvi pole valitud",togglePaletteMoreText:"Rohkem",togglePaletteLessText:"Vähem"},jQuery.spectrum.localization.fa={cancelText:"لغو",chooseText:"انتخاب",clearText:"تنظیم مجدد رنگ",noColorSelectedText:"هیچ رنگی انتخاب نشده است!",togglePaletteMoreText:"بیشتر",togglePaletteLessText:"کمتر"},jQuery.spectrum.localization.fi={cancelText:"Kumoa",chooseText:"Valitse"},jQuery.spectrum.localization.fr={cancelText:"Annuler",chooseText:"Valider",clearText:"Effacer couleur sélectionnée",noColorSelectedText:"Aucune couleur sélectionnée",togglePaletteMoreText:"Plus",togglePaletteLessText:"Moins"},jQuery.spectrum.localization.gr={cancelText:"Ακύρωση",chooseText:"Επιλογή",clearText:"Καθαρισμός επιλεγμένου χρώματος",noColorSelectedText:"Δεν έχει επιλεχθεί κάποιο χρώμα",togglePaletteMoreText:"Περισσότερα",togglePaletteLessText:"Λιγότερα"},jQuery.spectrum.localization.he={cancelText:"בטל בחירה",chooseText:"בחר צבע",clearText:"אפס בחירה",noColorSelectedText:"לא נבחר צבע",togglePaletteMoreText:"עוד צבעים",togglePaletteLessText:"פחות צבעים"},jQuery.spectrum.localization.hr={cancelText:"Odustani",chooseText:"Odaberi",clearText:"Poništi odabir",noColorSelectedText:"Niti jedna boja nije odabrana",togglePaletteMoreText:"Više",togglePaletteLessText:"Manje"},jQuery.spectrum.localization.hu={cancelText:"Mégsem",chooseText:"Mentés",clearText:"A színválasztás visszaállítása",noColorSelectedText:"Nincs szín kijelölve",togglePaletteMoreText:"Több",togglePaletteLessText:"Kevesebb"},jQuery.spectrum.localization.id={cancelText:"Batal",chooseText:"Pilih",clearText:"Hapus Pilihan Warna",noColorSelectedText:"Warna Tidak Dipilih",togglePaletteMoreText:"tambah",togglePaletteLessText:"kurangi"},jQuery.spectrum.localization.it={cancelText:"annulla",chooseText:"scegli",clearText:"Annulla selezione colore",noColorSelectedText:"Nessun colore selezionato"},jQuery.spectrum.localization.ja={cancelText:"中止",chooseText:"選択"},jQuery.spectrum.localization.ko={cancelText:"취소",chooseText:"선택",clearText:"선택 초기화",noColorSelectedText:"선택된 색상 없음",togglePaletteMoreText:"더보기",togglePaletteLessText:"줄이기"},jQuery.spectrum.localization.lt={cancelText:"Atšaukti",chooseText:"Pasirinkti",clearText:"Išvalyti pasirinkimą",noColorSelectedText:"Spalva nepasirinkta",togglePaletteMoreText:"Daugiau",togglePaletteLessText:"Mažiau"},jQuery.spectrum.localization["nb-no"]={cancelText:"Avbryte",chooseText:"Velg",clearText:"Tilbakestill",noColorSelectedText:"Farge er ikke valgt",togglePaletteMoreText:"Mer",togglePaletteLessText:"Mindre"},jQuery.spectrum.localization["nl-nl"]={cancelText:"Annuleer",chooseText:"Kies",clearText:"Wis kleur selectie",togglePaletteMoreText:"Meer",togglePaletteLessText:"Minder"},jQuery.spectrum.localization.pl={cancelText:"Anuluj",chooseText:"Wybierz",clearText:"Usuń wybór koloru",noColorSelectedText:"Nie wybrano koloru",togglePaletteMoreText:"Więcej",togglePaletteLessText:"Mniej"},jQuery.spectrum.localization["pt-br"]={cancelText:"Cancelar",chooseText:"Escolher",clearText:"Limpar cor selecionada",noColorSelectedText:"Nenhuma cor selecionada",togglePaletteMoreText:"Mais",togglePaletteLessText:"Menos"},jQuery.spectrum.localization["pt-pt"]={cancelText:"Cancelar",chooseText:"Escolher",clearText:"Limpar cor seleccionada",noColorSelectedText:"Nenhuma cor seleccionada",togglePaletteMoreText:"Mais",togglePaletteLessText:"Menos"},jQuery.spectrum.localization.ru={cancelText:"Отмена",chooseText:"Выбрать",clearText:"Сбросить",noColorSelectedText:"Цвет не выбран",togglePaletteMoreText:"Ещё",togglePaletteLessText:"Скрыть"},jQuery.spectrum.localization.sv={cancelText:"Avbryt",chooseText:"Välj"},jQuery.spectrum.localization.tr={cancelText:"iptal",chooseText:"tamam"},jQuery.spectrum.localization["zh-cn"]={cancelText:"取消",chooseText:"选择",clearText:"清除",togglePaletteMoreText:"更多选项",togglePaletteLessText:"隐藏",noColorSelectedText:"尚未选择任何颜色"},jQuery.spectrum.localization["zh-tw"]={cancelText:"取消",chooseText:"選擇",clearText:"清除",togglePaletteMoreText:"更多選項",togglePaletteLessText:"隱藏",noColorSelectedText:"尚未選擇任何顏色"},!function(d){var u,c,n,h,i,e,r,o,p,g,f,a,m,s=Array.prototype.slice,_=decodeURIComponent,l=d.param,t=d.bbq=d.bbq||Object.create(null),v=d.event.special,y="hashchange",b="querystring",C="fragment",x="elemUrlAttr",w=/^.*\?|#.*$/g,S=Object.create(null);function M(t){return"string"==typeof t}function O(t){var e=s.call(arguments,1);return function(){return t.apply(this,e.concat(s.call(arguments)))}}function G(t,e,i,n,r){var a,s,o,l,r=n!==u?(l=(s=i.match(t?g:/^([^#?]*)\??([^#]*)(#?.*)/))[3]||"",2===r&&M(n)?a=n.replace(t?p:w,""):(o=h(s[2]),n=M(n)?h[t?C:b](n):n,a=2===r?n:1===r?d.extend(Object.create(null),n,o):d.extend(Object.create(null),o,n),a=c(a),t&&(a=a.replace(f,_))),s[1]+(t?m:a||!s[1]?"?":"")+a+l):e(i!==u?i:location.href);return r}function I(t,e,i){return e=e===u||"boolean"==typeof e?(i=e,l[t?C:b]()):M(e)?e.replace(t?p:w,""):e,h(e,i)}function T(n,r,a,s){return M(a)||"object"==typeof a||(s=a,a=r,r=u),this.each(function(){var t=d(this),e=r||o()[(this.nodeName||"").toLowerCase()]||"",i=e&&t.attr(e)||"";t.attr(e,l[n](i,a,s))})}l[b]=O(G,0,function(t){return t.replace(/(?:^[^?#]*\?([^#]*).*$)?.*/,"$1")}),l[C]=n=O(G,1,function(t){return t.replace(g,"$2")}),l.sorted=c=function(t,e){var r=[],a=Object.create(null);return d.each(l(t,e).split("&"),function(t,e){var i=e.replace(/(?:%5B|=).*$/,""),n=a[i];n||(n=a[i]=[],r.push(i)),n.push(e)}),d.map(r.sort(),function(t){return a[t]}).join("&")},n.noEscape=function(t){t=d.map((t=t||"").split(""),encodeURIComponent);f=new RegExp(t.join("|"),"g")},n.noEscape(",/"),n.ajaxCrawlable=function(t){return t!==u&&(m=t?(p=/^.*(?:#!|#)/,g=/^([^#]*)(?:#!|#)?(.*)$/,"#!"):(p=/^.*#/,g=/^([^#]*)#?(.*)$/,"#"),a=!!t),a},n.ajaxCrawlable(0),d.deparam=h=function(t,l){var c=Object.create(null),h={true:!0,false:!1,null:null};return d.each(t.replace(/\+/g," ").split("&"),function(t,e){if(/^[a-zA-Z0-9,%\|\.\/_\-\=]*$/.test(e)){var i,e=e.split("="),n=_(e[0]),r=c,a=0,s=n.split("]["),o=s.length-1,o=/\[/.test(s[0])&&/\]$/.test(s[o])?(s[o]=s[o].replace(/\]$/,""),(s=s.shift().split("[").concat(s)).length-1):0;if(2===e.length)if(i=_(e[1]),l&&(i=i&&!isNaN(i)?+i:"undefined"===i?u:h[i]!==u?h[i]:i),o)for(;a<=o;a++)r=r[n=""===s[a]?r.length:s[a]]=a<o?r[n]||(s[a+1]&&isNaN(s[a+1])?Object.create(null):[]):i;else d.isArray(c[n])?c[n].push(i):c[n]!==u?c[n]=[c[n],i]:c[n]=i;else n&&(c[n]=l?u:"")}}),c},h[b]=O(I,0),h[C]=i=O(I,1),d[x]||(d[x]=function(t){return d.extend(S,t)})({a:"href",base:"href",iframe:"src",img:"src",input:"src",form:"action",link:"href",script:"src"}),o=d[x],d.fn[b]=O(T,b),d.fn[C]=O(T,C),t.pushState=e=function(t,e){M(t)&&/^#/.test(t)&&e===u&&(e=2);var i=t!==u,t=n(location.href,i?t:Object.create(null),i?e:2);location.href=t},t.getState=r=function(t,e){return t===u||"boolean"==typeof t?i(t):i(e)[t]},t.removeState=function(t){var i=Object.create(null);t!==u&&(i=r(),d.each(d.isArray(t)?t:arguments,function(t,e){delete i[e]})),e(i,2)},v[y]=d.extend(v[y],{add:function(t){var e;function i(t){var i=t[C]=n();t.getState=function(t,e){return t===u||"boolean"==typeof t?h(i,t):h(i,e)[t]},e.apply(this,arguments)}if(d.isFunction(t))return e=t,i;e=t.handler,t.handler=i}})}(jQuery),!function(i,n){var t,r,a,s,o,l="hashchange",e=document,c=i.event.special,e=e.documentMode,h="on"+l in n&&(void 0===e||7<e);function d(t){return"#"+(t=t||location.href).replace(/^[^#]*#?(.*)$/,"$1")}function u(t){return t}function p(){var t=d(),e=o(a);t!==a?(s(a=t,e),i(n).trigger(l)):e!==a&&(location.href=location.href.replace(/#.*/,"")+e),r=setTimeout(p,i.fn[l].delay)}i.fn[l]=function(t){return t?this.bind(l,t):this.trigger(l)},i.fn[l].delay=50,c[l]=i.extend(c[l],{setup:function(){if(h)return!1;i(t.start)},teardown:function(){if(h)return!1;i(t.stop)}}),e=Object.create(null),a=d(),o=s=u,e.start=function(){r||p()},e.stop=function(){r&&clearTimeout(r),r=void 0},t=e}(jQuery,this),!function(t){"use strict";t(jQuery)}(function(y){"use strict";y.ui=y.ui||{},y.ui.version="1.13.2";var r,i=0,s=Array.prototype.hasOwnProperty,o=Array.prototype.slice;y.cleanData=(r=y.cleanData,function(t){for(var e,i,n=0;null!=(i=t[n]);n++)(e=y._data(i,"events"))&&e.remove&&y(i).triggerHandler("remove");r(t)}),y.widget=function(t,i,e){var n,r,a,s={},o=t.split(".")[0],l=o+"-"+(t=t.split(".")[1]);return e||(e=i,i=y.Widget),Array.isArray(e)&&(e=y.extend.apply(null,[{}].concat(e))),y.expr.pseudos[l.toLowerCase()]=function(t){return!!y.data(t,l)},y[o]=y[o]||{},n=y[o][t],r=y[o][t]=function(t,e){if(!this||!this._createWidget)return new r(t,e);arguments.length&&this._createWidget(t,e)},y.extend(r,n,{version:e.version,_proto:y.extend({},e),_childConstructors:[]}),(a=new i).options=y.widget.extend({},a.options),y.each(e,function(e,n){function r(){return i.prototype[e].apply(this,arguments)}function a(t){return i.prototype[e].apply(this,t)}s[e]="function"==typeof n?function(){var t,e=this._super,i=this._superApply;return this._super=r,this._superApply=a,t=n.apply(this,arguments),this._super=e,this._superApply=i,t}:n}),r.prototype=y.widget.extend(a,{widgetEventPrefix:n&&a.widgetEventPrefix||t},s,{constructor:r,namespace:o,widgetName:t,widgetFullName:l}),n?(y.each(n._childConstructors,function(t,e){var i=e.prototype;y.widget(i.namespace+"."+i.widgetName,r,e._proto)}),delete n._childConstructors):i._childConstructors.push(r),y.widget.bridge(t,r),r},y.widget.extend=function(t){for(var e,i,n=o.call(arguments,1),r=0,a=n.length;r<a;r++)for(e in n[r])i=n[r][e],s.call(n[r],e)&&void 0!==i&&(y.isPlainObject(i)?t[e]=y.isPlainObject(t[e])?y.widget.extend({},t[e],i):y.widget.extend({},i):t[e]=i);return t},y.widget.bridge=function(a,e){var s=e.prototype.widgetFullName||a;y.fn[a]=function(i){var t="string"==typeof i,n=o.call(arguments,1),r=this;return t?this.length||"instance"!==i?this.each(function(){var t,e=y.data(this,s);return"instance"===i?(r=e,!1):e?"function"!=typeof e[i]||"_"===i.charAt(0)?y.error("no such method '"+i+"' for "+a+" widget instance"):(t=e[i].apply(e,n))!==e&&void 0!==t?(r=t&&t.jquery?r.pushStack(t.get()):t,!1):void 0:y.error("cannot call methods on "+a+" prior to initialization; attempted to call method '"+i+"'")}):r=void 0:(n.length&&(i=y.widget.extend.apply(null,[i].concat(n))),this.each(function(){var t=y.data(this,s);t?(t.option(i||{}),t._init&&t._init()):y.data(this,s,new e(i,this))})),r}},y.Widget=function(){},y.Widget._childConstructors=[],y.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{classes:{},disabled:!1,create:null},_createWidget:function(t,e){e=y(e||this.defaultElement||this)[0],this.element=y(e),this.uuid=i++,this.eventNamespace="."+this.widgetName+this.uuid,this.bindings=y(),this.hoverable=y(),this.focusable=y(),this.classesElementLookup={},e!==this&&(y.data(e,this.widgetFullName,this),this._on(!0,this.element,{remove:function(t){t.target===e&&this.destroy()}}),this.document=y(e.style?e.ownerDocument:e.document||e),this.window=y(this.document[0].defaultView||this.document[0].parentWindow)),this.options=y.widget.extend({},this.options,this._getCreateOptions(),t),this._create(),this.options.disabled&&this._setOptionDisabled(this.options.disabled),this._trigger("create",null,this._getCreateEventData()),this._init()},_getCreateOptions:function(){return{}},_getCreateEventData:y.noop,_create:y.noop,_init:y.noop,destroy:function(){var i=this;this._destroy(),y.each(this.classesElementLookup,function(t,e){i._removeClass(e,t)}),this.element.off(this.eventNamespace).removeData(this.widgetFullName),this.widget().off(this.eventNamespace).removeAttr("aria-disabled"),this.bindings.off(this.eventNamespace)},_destroy:y.noop,widget:function(){return this.element},option:function(t,e){var i,n,r,a=t;if(0===arguments.length)return y.widget.extend({},this.options);if("string"==typeof t)if(a={},t=(i=t.split(".")).shift(),i.length){for(n=a[t]=y.widget.extend({},this.options[t]),r=0;r<i.length-1;r++)n[i[r]]=n[i[r]]||{},n=n[i[r]];if(t=i.pop(),1===arguments.length)return void 0===n[t]?null:n[t];n[t]=e}else{if(1===arguments.length)return void 0===this.options[t]?null:this.options[t];a[t]=e}return this._setOptions(a),this},_setOptions:function(t){for(var e in t)this._setOption(e,t[e]);return this},_setOption:function(t,e){return"classes"===t&&this._setOptionClasses(e),this.options[t]=e,"disabled"===t&&this._setOptionDisabled(e),this},_setOptionClasses:function(t){var e,i,n;for(e in t)n=this.classesElementLookup[e],t[e]!==this.options.classes[e]&&n&&n.length&&(i=y(n.get()),this._removeClass(n,e),i.addClass(this._classes({element:i,keys:e,classes:t,add:!0})))},_setOptionDisabled:function(t){this._toggleClass(this.widget(),this.widgetFullName+"-disabled",null,!!t),t&&(this._removeClass(this.hoverable,null,"ui-state-hover"),this._removeClass(this.focusable,null,"ui-state-focus"))},enable:function(){return this._setOptions({disabled:!1})},disable:function(){return this._setOptions({disabled:!0})},_classes:function(r){var a=[],s=this;function t(t,e){for(var i,n=0;n<t.length;n++)i=s.classesElementLookup[t[n]]||y(),i=r.add?(function(){var i=[];r.element.each(function(t,e){y.map(s.classesElementLookup,function(t){return t}).some(function(t){return t.is(e)})||i.push(e)}),s._on(y(i),{remove:"_untrackClassesElement"})}(),y(y.uniqueSort(i.get().concat(r.element.get())))):y(i.not(r.element).get()),s.classesElementLookup[t[n]]=i,a.push(t[n]),e&&r.classes[t[n]]&&a.push(r.classes[t[n]])}return(r=y.extend({element:this.element,classes:this.options.classes||{}},r)).keys&&t(r.keys.match(/\S+/g)||[],!0),r.extra&&t(r.extra.match(/\S+/g)||[]),a.join(" ")},_untrackClassesElement:function(i){var n=this;y.each(n.classesElementLookup,function(t,e){-1!==y.inArray(i.target,e)&&(n.classesElementLookup[t]=y(e.not(i.target).get()))}),this._off(y(i.target))},_removeClass:function(t,e,i){return this._toggleClass(t,e,i,!1)},_addClass:function(t,e,i){return this._toggleClass(t,e,i,!0)},_toggleClass:function(t,e,i,n){var r="string"==typeof t||null===t;return(i={extra:r?e:i,keys:r?t:e,element:r?this.element:t,add:n="boolean"==typeof n?n:i}).element.toggleClass(this._classes(i),n),this},_on:function(r,a,t){var s,o=this;"boolean"!=typeof r&&(t=a,a=r,r=!1),t?(a=s=y(a),this.bindings=this.bindings.add(a)):(t=a,a=this.element,s=this.widget()),y.each(t,function(t,e){function i(){if(r||!0!==o.options.disabled&&!y(this).hasClass("ui-state-disabled"))return("string"==typeof e?o[e]:e).apply(o,arguments)}"string"!=typeof e&&(i.guid=e.guid=e.guid||i.guid||y.guid++);var n=t.match(/^([\w:-]*)\s*(.*)$/),t=n[1]+o.eventNamespace;(n=n[2])?s.on(t,n,i):a.on(t,i)})},_off:function(t,e){e=(e||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,t.off(e),this.bindings=y(this.bindings.not(t).get()),this.focusable=y(this.focusable.not(t).get()),this.hoverable=y(this.hoverable.not(t).get())},_delay:function(t,e){var i=this;return setTimeout(function(){return("string"==typeof t?i[t]:t).apply(i,arguments)},e||0)},_hoverable:function(t){this.hoverable=this.hoverable.add(t),this._on(t,{mouseenter:function(t){this._addClass(y(t.currentTarget),null,"ui-state-hover")},mouseleave:function(t){this._removeClass(y(t.currentTarget),null,"ui-state-hover")}})},_focusable:function(t){this.focusable=this.focusable.add(t),this._on(t,{focusin:function(t){this._addClass(y(t.currentTarget),null,"ui-state-focus")},focusout:function(t){this._removeClass(y(t.currentTarget),null,"ui-state-focus")}})},_trigger:function(t,e,i){var n,r,a=this.options[t];if(i=i||{},(e=y.Event(e)).type=(t===this.widgetEventPrefix?t:this.widgetEventPrefix+t).toLowerCase(),e.target=this.element[0],r=e.originalEvent)for(n in r)n in e||(e[n]=r[n]);return this.element.trigger(e,i),!("function"==typeof a&&!1===a.apply(this.element[0],[e].concat(i))||e.isDefaultPrevented())}},y.each({show:"fadeIn",hide:"fadeOut"},function(a,s){y.Widget.prototype["_"+a]=function(e,t,i){var n,r=(t="string"==typeof t?{effect:t}:t)?!0!==t&&"number"!=typeof t&&t.effect||s:a;"number"==typeof(t=t||{})?t={duration:t}:!0===t&&(t={}),n=!y.isEmptyObject(t),t.complete=i,t.delay&&e.delay(t.delay),n&&y.effects&&y.effects.effect[r]?e[a](t):r!==a&&e[r]?e[r](t.duration,t.easing,i):e.queue(function(t){y(this)[a](),i&&i.call(e[0]),t()})}}),y.widget,y.extend(y.expr.pseudos,{data:y.expr.createPseudo?y.expr.createPseudo(function(e){return function(t){return!!y.data(t,e)}}):function(t,e,i){return!!y.data(t,i[3])}}),y.fn.extend({disableSelection:(t="onselectstart"in document.createElement("div")?"selectstart":"mousedown",function(){return this.on(t+".ui-disableSelection",function(t){t.preventDefault()})}),enableSelection:function(){return this.off(".ui-disableSelection")}}),y.ui.keyCode={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38},y.fn.scrollParent=function(t){var e=this.css("position"),i="absolute"===e,n=t?/(auto|scroll|hidden)/:/(auto|scroll)/,t=this.parents().filter(function(){var t=y(this);return(!i||"static"!==t.css("position"))&&n.test(t.css("overflow")+t.css("overflow-y")+t.css("overflow-x"))}).eq(0);return"fixed"!==e&&t.length?t:y(this[0].ownerDocument||document)},y.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase());var t,a=!1;y(document).on("mouseup",function(){a=!1}),y.widget("ui.mouse",{version:"1.13.2",options:{cancel:"input, textarea, button, select, option",distance:1,delay:0},_mouseInit:function(){var e=this;this.element.on("mousedown."+this.widgetName,function(t){return e._mouseDown(t)}).on("click."+this.widgetName,function(t){if(!0===y.data(t.target,e.widgetName+".preventClickEvent"))return y.removeData(t.target,e.widgetName+".preventClickEvent"),t.stopImmediatePropagation(),!1}),this.started=!1},_mouseDestroy:function(){this.element.off("."+this.widgetName),this._mouseMoveDelegate&&this.document.off("mousemove."+this.widgetName,this._mouseMoveDelegate).off("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(t){var e,i,n;if(!a)return this._mouseMoved=!1,this._mouseStarted&&this._mouseUp(t),i=1===(this._mouseDownEvent=t).which,n=!("string"!=typeof(e=this).options.cancel||!t.target.nodeName)&&y(t.target).closest(this.options.cancel).length,!(i&&!n&&this._mouseCapture(t))||(this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){e.mouseDelayMet=!0},this.options.delay)),this._mouseDistanceMet(t)&&this._mouseDelayMet(t)&&(this._mouseStarted=!1!==this._mouseStart(t),!this._mouseStarted)?(t.preventDefault(),!0):(!0===y.data(t.target,this.widgetName+".preventClickEvent")&&y.removeData(t.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(t){return e._mouseMove(t)},this._mouseUpDelegate=function(t){return e._mouseUp(t)},this.document.on("mousemove."+this.widgetName,this._mouseMoveDelegate).on("mouseup."+this.widgetName,this._mouseUpDelegate),t.preventDefault(),a=!0))},_mouseMove:function(t){if(this._mouseMoved){if(y.ui.ie&&(!document.documentMode||document.documentMode<9)&&!t.button)return this._mouseUp(t);if(!t.which)if(t.originalEvent.altKey||t.originalEvent.ctrlKey||t.originalEvent.metaKey||t.originalEvent.shiftKey)this.ignoreMissingWhich=!0;else if(!this.ignoreMissingWhich)return this._mouseUp(t)}return(t.which||t.button)&&(this._mouseMoved=!0),this._mouseStarted?(this._mouseDrag(t),t.preventDefault()):(this._mouseDistanceMet(t)&&this._mouseDelayMet(t)&&(this._mouseStarted=!1!==this._mouseStart(this._mouseDownEvent,t),this._mouseStarted?this._mouseDrag(t):this._mouseUp(t)),!this._mouseStarted)},_mouseUp:function(t){this.document.off("mousemove."+this.widgetName,this._mouseMoveDelegate).off("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,t.target===this._mouseDownEvent.target&&y.data(t.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(t)),this._mouseDelayTimer&&(clearTimeout(this._mouseDelayTimer),delete this._mouseDelayTimer),this.ignoreMissingWhich=!1,a=!1,t.preventDefault()},_mouseDistanceMet:function(t){return Math.max(Math.abs(this._mouseDownEvent.pageX-t.pageX),Math.abs(this._mouseDownEvent.pageY-t.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return!0}}),y.ui.plugin={add:function(t,e,i){var n,r=y.ui[t].prototype;for(n in i)r.plugins[n]=r.plugins[n]||[],r.plugins[n].push([e,i[n]])},call:function(t,e,i,n){var r,a=t.plugins[e];if(a&&(n||t.element[0].parentNode&&11!==t.element[0].parentNode.nodeType))for(r=0;r<a.length;r++)t.options[a[r][0]]&&a[r][1].apply(t.element,i)}},y.ui.safeActiveElement=function(e){var i;try{i=e.activeElement}catch(t){i=e.body}return(i=i||e.body).nodeName?i:e.body},y.ui.safeBlur=function(t){t&&"body"!==t.nodeName.toLowerCase()&&y(t).trigger("blur")},y.widget("ui.draggable",y.ui.mouse,{version:"1.13.2",widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1,drag:null,start:null,stop:null},_create:function(){"original"===this.options.helper&&this._setPositionRelative(),this.options.addClasses&&this._addClass("ui-draggable"),this._setHandleClassName(),this._mouseInit()},_setOption:function(t,e){this._super(t,e),"handle"===t&&(this._removeHandleClassName(),this._setHandleClassName())},_destroy:function(){(this.helper||this.element).is(".ui-draggable-dragging")?this.destroyOnClear=!0:(this._removeHandleClassName(),this._mouseDestroy())},_mouseCapture:function(t){var e=this.options;return!(this.helper||e.disabled||0<y(t.target).closest(".ui-resizable-handle").length||(this.handle=this._getHandle(t),!this.handle||(this._blurActiveElement(t),this._blockFrames(!0===e.iframeFix?"iframe":e.iframeFix),0)))},_blockFrames:function(t){this.iframeBlocks=this.document.find(t).map(function(){var t=y(this);return y("<div>").css("position","absolute").appendTo(t.parent()).outerWidth(t.outerWidth()).outerHeight(t.outerHeight()).offset(t.offset())[0]})},_unblockFrames:function(){this.iframeBlocks&&(this.iframeBlocks.remove(),delete this.iframeBlocks)},_blurActiveElement:function(t){var e=y.ui.safeActiveElement(this.document[0]);y(t.target).closest(e).length||y.ui.safeBlur(e)},_mouseStart:function(t){var e=this.options;return this.helper=this._createHelper(t),this._addClass(this.helper,"ui-draggable-dragging"),this._cacheHelperProportions(),y.ui.ddmanager&&(y.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(!0),this.offsetParent=this.helper.offsetParent(),this.hasFixedAncestor=0<this.helper.parents().filter(function(){return"fixed"===y(this).css("position")}).length,this.positionAbs=this.element.offset(),this._refreshOffsets(t),this.originalPosition=this.position=this._generatePosition(t,!1),this.originalPageX=t.pageX,this.originalPageY=t.pageY,e.cursorAt&&this._adjustOffsetFromHelper(e.cursorAt),this._setContainment(),!1===this._trigger("start",t)?(this._clear(),!1):(this._cacheHelperProportions(),y.ui.ddmanager&&!e.dropBehaviour&&y.ui.ddmanager.prepareOffsets(this,t),this._mouseDrag(t,!0),y.ui.ddmanager&&y.ui.ddmanager.dragStart(this,t),!0)},_refreshOffsets:function(t){this.offset={top:this.positionAbs.top-this.margins.top,left:this.positionAbs.left-this.margins.left,scroll:!1,parent:this._getParentOffset(),relative:this._getRelativeOffset()},this.offset.click={left:t.pageX-this.offset.left,top:t.pageY-this.offset.top}},_mouseDrag:function(t,e){if(this.hasFixedAncestor&&(this.offset.parent=this._getParentOffset()),this.position=this._generatePosition(t,!0),this.positionAbs=this._convertPositionTo("absolute"),!e){if(e=this._uiHash(),!1===this._trigger("drag",t,e))return this._mouseUp(new y.Event("mouseup",t)),!1;this.position=e.position}return this.helper[0].style.left=this.position.left+"px",this.helper[0].style.top=this.position.top+"px",y.ui.ddmanager&&y.ui.ddmanager.drag(this,t),!1},_mouseStop:function(t){var e=this,i=!1;return y.ui.ddmanager&&!this.options.dropBehaviour&&(i=y.ui.ddmanager.drop(this,t)),this.dropped&&(i=this.dropped,this.dropped=!1),"invalid"===this.options.revert&&!i||"valid"===this.options.revert&&i||!0===this.options.revert||"function"==typeof this.options.revert&&this.options.revert.call(this.element,i)?y(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){!1!==e._trigger("stop",t)&&e._clear()}):!1!==this._trigger("stop",t)&&this._clear(),!1},_mouseUp:function(t){return this._unblockFrames(),y.ui.ddmanager&&y.ui.ddmanager.dragStop(this,t),this.handleElement.is(t.target)&&this.element.trigger("focus"),y.ui.mouse.prototype._mouseUp.call(this,t)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp(new y.Event("mouseup",{target:this.element[0]})):this._clear(),this},_getHandle:function(t){return!this.options.handle||!!y(t.target).closest(this.element.find(this.options.handle)).length},_setHandleClassName:function(){this.handleElement=this.options.handle?this.element.find(this.options.handle):this.element,this._addClass(this.handleElement,"ui-draggable-handle")},_removeHandleClassName:function(){this._removeClass(this.handleElement,"ui-draggable-handle")},_createHelper:function(t){var e=this.options,i="function"==typeof e.helper;return(t=i?y(e.helper.apply(this.element[0],[t])):"clone"===e.helper?this.element.clone().removeAttr("id"):this.element).parents("body").length||t.appendTo("parent"===e.appendTo?this.element[0].parentNode:e.appendTo),i&&t[0]===this.element[0]&&this._setPositionRelative(),t[0]===this.element[0]||/(fixed|absolute)/.test(t.css("position"))||t.css("position","absolute"),t},_setPositionRelative:function(){/^(?:r|a|f)/.test(this.element.css("position"))||(this.element[0].style.position="relative")},_adjustOffsetFromHelper:function(t){"string"==typeof t&&(t=t.split(" ")),"left"in(t=Array.isArray(t)?{left:+t[0],top:+t[1]||0}:t)&&(this.offset.click.left=t.left+this.margins.left),"right"in t&&(this.offset.click.left=this.helperProportions.width-t.right+this.margins.left),"top"in t&&(this.offset.click.top=t.top+this.margins.top),"bottom"in t&&(this.offset.click.top=this.helperProportions.height-t.bottom+this.margins.top)},_isRootNode:function(t){return/(html|body)/i.test(t.tagName)||t===this.document[0]},_getParentOffset:function(){var t=this.offsetParent.offset(),e=this.document[0];return"absolute"===this.cssPosition&&this.scrollParent[0]!==e&&y.contains(this.scrollParent[0],this.offsetParent[0])&&(t.left+=this.scrollParent.scrollLeft(),t.top+=this.scrollParent.scrollTop()),{top:(t=this._isRootNode(this.offsetParent[0])?{top:0,left:0}:t).top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:t.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"!==this.cssPosition)return{top:0,left:0};var t=this.element.position(),e=this._isRootNode(this.scrollParent[0]);return{top:t.top-(parseInt(this.helper.css("top"),10)||0)+(e?0:this.scrollParent.scrollTop()),left:t.left-(parseInt(this.helper.css("left"),10)||0)+(e?0:this.scrollParent.scrollLeft())}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var t,e,i,n=this.options,r=this.document[0];this.relativeContainer=null,n.containment?"window"!==n.containment?"document"!==n.containment?n.containment.constructor!==Array?("parent"===n.containment&&(n.containment=this.helper[0].parentNode),(i=(e=y(n.containment))[0])&&(t=/(scroll|auto)/.test(e.css("overflow")),this.containment=[(parseInt(e.css("borderLeftWidth"),10)||0)+(parseInt(e.css("paddingLeft"),10)||0),(parseInt(e.css("borderTopWidth"),10)||0)+(parseInt(e.css("paddingTop"),10)||0),(t?Math.max(i.scrollWidth,i.offsetWidth):i.offsetWidth)-(parseInt(e.css("borderRightWidth"),10)||0)-(parseInt(e.css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(t?Math.max(i.scrollHeight,i.offsetHeight):i.offsetHeight)-(parseInt(e.css("borderBottomWidth"),10)||0)-(parseInt(e.css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relativeContainer=e)):this.containment=n.containment:this.containment=[0,0,y(r).width()-this.helperProportions.width-this.margins.left,(y(r).height()||r.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]:this.containment=[y(window).scrollLeft()-this.offset.relative.left-this.offset.parent.left,y(window).scrollTop()-this.offset.relative.top-this.offset.parent.top,y(window).scrollLeft()+y(window).width()-this.helperProportions.width-this.margins.left,y(window).scrollTop()+(y(window).height()||r.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]:this.containment=null},_convertPositionTo:function(t,e){e=e||this.position;var i="absolute"===t?1:-1,t=this._isRootNode(this.scrollParent[0]);return{top:e.top+this.offset.relative.top*i+this.offset.parent.top*i-("fixed"===this.cssPosition?-this.offset.scroll.top:t?0:this.offset.scroll.top)*i,left:e.left+this.offset.relative.left*i+this.offset.parent.left*i-("fixed"===this.cssPosition?-this.offset.scroll.left:t?0:this.offset.scroll.left)*i}},_generatePosition:function(t,e){var i,n=this.options,r=this._isRootNode(this.scrollParent[0]),a=t.pageX,s=t.pageY;return r&&this.offset.scroll||(this.offset.scroll={top:this.scrollParent.scrollTop(),left:this.scrollParent.scrollLeft()}),e&&(this.containment&&(i=this.relativeContainer?(i=this.relativeContainer.offset(),[this.containment[0]+i.left,this.containment[1]+i.top,this.containment[2]+i.left,this.containment[3]+i.top]):this.containment,t.pageX-this.offset.click.left<i[0]&&(a=i[0]+this.offset.click.left),t.pageY-this.offset.click.top<i[1]&&(s=i[1]+this.offset.click.top),t.pageX-this.offset.click.left>i[2]&&(a=i[2]+this.offset.click.left),t.pageY-this.offset.click.top>i[3]&&(s=i[3]+this.offset.click.top)),n.grid&&(t=n.grid[1]?this.originalPageY+Math.round((s-this.originalPageY)/n.grid[1])*n.grid[1]:this.originalPageY,s=!i||t-this.offset.click.top>=i[1]||t-this.offset.click.top>i[3]?t:t-this.offset.click.top>=i[1]?t-n.grid[1]:t+n.grid[1],t=n.grid[0]?this.originalPageX+Math.round((a-this.originalPageX)/n.grid[0])*n.grid[0]:this.originalPageX,a=!i||t-this.offset.click.left>=i[0]||t-this.offset.click.left>i[2]?t:t-this.offset.click.left>=i[0]?t-n.grid[0]:t+n.grid[0]),"y"===n.axis&&(a=this.originalPageX),"x"===n.axis&&(s=this.originalPageY)),{top:s-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.offset.scroll.top:r?0:this.offset.scroll.top),left:a-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.offset.scroll.left:r?0:this.offset.scroll.left)}},_clear:function(){this._removeClass(this.helper,"ui-draggable-dragging"),this.helper[0]===this.element[0]||this.cancelHelperRemoval||this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1,this.destroyOnClear&&this.destroy()},_trigger:function(t,e,i){return i=i||this._uiHash(),y.ui.plugin.call(this,t,[e,i,this],!0),/^(drag|start|stop)/.test(t)&&(this.positionAbs=this._convertPositionTo("absolute"),i.offset=this.positionAbs),y.Widget.prototype._trigger.call(this,t,e,i)},plugins:{},_uiHash:function(){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),y.ui.plugin.add("draggable","connectToSortable",{start:function(e,t,i){var n=y.extend({},t,{item:i.element});i.sortables=[],y(i.options.connectToSortable).each(function(){var t=y(this).sortable("instance");t&&!t.options.disabled&&(i.sortables.push(t),t.refreshPositions(),t._trigger("activate",e,n))})},stop:function(e,t,i){var n=y.extend({},t,{item:i.element});i.cancelHelperRemoval=!1,y.each(i.sortables,function(){var t=this;t.isOver?(t.isOver=0,i.cancelHelperRemoval=!0,t.cancelHelperRemoval=!1,t._storedCSS={position:t.placeholder.css("position"),top:t.placeholder.css("top"),left:t.placeholder.css("left")},t._mouseStop(e),t.options.helper=t.options._helper):(t.cancelHelperRemoval=!0,t._trigger("deactivate",e,n))})},drag:function(i,n,r){y.each(r.sortables,function(){var t=!1,e=this;e.positionAbs=r.positionAbs,e.helperProportions=r.helperProportions,e.offset.click=r.offset.click,e._intersectsWith(e.containerCache)&&(t=!0,y.each(r.sortables,function(){return this.positionAbs=r.positionAbs,this.helperProportions=r.helperProportions,this.offset.click=r.offset.click,t=(this===e||!this._intersectsWith(this.containerCache)||!y.contains(e.element[0],this.element[0]))&&t})),t?(e.isOver||(e.isOver=1,r._parent=n.helper.parent(),e.currentItem=n.helper.appendTo(e.element).data("ui-sortable-item",!0),e.options._helper=e.options.helper,e.options.helper=function(){return n.helper[0]},i.target=e.currentItem[0],e._mouseCapture(i,!0),e._mouseStart(i,!0,!0),e.offset.click.top=r.offset.click.top,e.offset.click.left=r.offset.click.left,e.offset.parent.left-=r.offset.parent.left-e.offset.parent.left,e.offset.parent.top-=r.offset.parent.top-e.offset.parent.top,r._trigger("toSortable",i),r.dropped=e.element,y.each(r.sortables,function(){this.refreshPositions()}),r.currentItem=r.element,e.fromOutside=r),e.currentItem&&(e._mouseDrag(i),n.position=e.position)):e.isOver&&(e.isOver=0,e.cancelHelperRemoval=!0,e.options._revert=e.options.revert,e.options.revert=!1,e._trigger("out",i,e._uiHash(e)),e._mouseStop(i,!0),e.options.revert=e.options._revert,e.options.helper=e.options._helper,e.placeholder&&e.placeholder.remove(),n.helper.appendTo(r._parent),r._refreshOffsets(i),n.position=r._generatePosition(i,!0),r._trigger("fromSortable",i),r.dropped=!1,y.each(r.sortables,function(){this.refreshPositions()}))})}}),y.ui.plugin.add("draggable","cursor",{start:function(t,e,i){var n=y("body"),i=i.options;n.css("cursor")&&(i._cursor=n.css("cursor")),n.css("cursor",i.cursor)},stop:function(t,e,i){(i=i.options)._cursor&&y("body").css("cursor",i._cursor)}}),y.ui.plugin.add("draggable","opacity",{start:function(t,e,i){e=y(e.helper),i=i.options,e.css("opacity")&&(i._opacity=e.css("opacity")),e.css("opacity",i.opacity)},stop:function(t,e,i){(i=i.options)._opacity&&y(e.helper).css("opacity",i._opacity)}}),y.ui.plugin.add("draggable","scroll",{start:function(t,e,i){i.scrollParentNotHidden||(i.scrollParentNotHidden=i.helper.scrollParent(!1)),i.scrollParentNotHidden[0]!==i.document[0]&&"HTML"!==i.scrollParentNotHidden[0].tagName&&(i.overflowOffset=i.scrollParentNotHidden.offset())},drag:function(t,e,i){var n=i.options,r=!1,a=i.scrollParentNotHidden[0],s=i.document[0];a!==s&&"HTML"!==a.tagName?(n.axis&&"x"===n.axis||(i.overflowOffset.top+a.offsetHeight-t.pageY<n.scrollSensitivity?a.scrollTop=r=a.scrollTop+n.scrollSpeed:t.pageY-i.overflowOffset.top<n.scrollSensitivity&&(a.scrollTop=r=a.scrollTop-n.scrollSpeed)),n.axis&&"y"===n.axis||(i.overflowOffset.left+a.offsetWidth-t.pageX<n.scrollSensitivity?a.scrollLeft=r=a.scrollLeft+n.scrollSpeed:t.pageX-i.overflowOffset.left<n.scrollSensitivity&&(a.scrollLeft=r=a.scrollLeft-n.scrollSpeed))):(n.axis&&"x"===n.axis||(t.pageY-y(s).scrollTop()<n.scrollSensitivity?r=y(s).scrollTop(y(s).scrollTop()-n.scrollSpeed):y(window).height()-(t.pageY-y(s).scrollTop())<n.scrollSensitivity&&(r=y(s).scrollTop(y(s).scrollTop()+n.scrollSpeed))),n.axis&&"y"===n.axis||(t.pageX-y(s).scrollLeft()<n.scrollSensitivity?r=y(s).scrollLeft(y(s).scrollLeft()-n.scrollSpeed):y(window).width()-(t.pageX-y(s).scrollLeft())<n.scrollSensitivity&&(r=y(s).scrollLeft(y(s).scrollLeft()+n.scrollSpeed)))),!1!==r&&y.ui.ddmanager&&!n.dropBehaviour&&y.ui.ddmanager.prepareOffsets(i,t)}}),y.ui.plugin.add("draggable","snap",{start:function(t,e,i){var n=i.options;i.snapElements=[],y(n.snap.constructor!==String?n.snap.items||":data(ui-draggable)":n.snap).each(function(){var t=y(this),e=t.offset();this!==i.element[0]&&i.snapElements.push({item:this,width:t.outerWidth(),height:t.outerHeight(),top:e.top,left:e.left})})},drag:function(t,e,i){for(var n,r,a,s,o,l,c,h,d,u=i.options,p=u.snapTolerance,g=e.offset.left,f=g+i.helperProportions.width,m=e.offset.top,_=m+i.helperProportions.height,v=i.snapElements.length-1;0<=v;v--)l=(o=i.snapElements[v].left-i.margins.left)+i.snapElements[v].width,h=(c=i.snapElements[v].top-i.margins.top)+i.snapElements[v].height,f<o-p||l+p<g||_<c-p||h+p<m||!y.contains(i.snapElements[v].item.ownerDocument,i.snapElements[v].item)?(i.snapElements[v].snapping&&i.options.snap.release&&i.options.snap.release.call(i.element,t,y.extend(i._uiHash(),{snapItem:i.snapElements[v].item})),i.snapElements[v].snapping=!1):("inner"!==u.snapMode&&(n=Math.abs(c-_)<=p,r=Math.abs(h-m)<=p,a=Math.abs(o-f)<=p,s=Math.abs(l-g)<=p,n&&(e.position.top=i._convertPositionTo("relative",{top:c-i.helperProportions.height,left:0}).top),r&&(e.position.top=i._convertPositionTo("relative",{top:h,left:0}).top),a&&(e.position.left=i._convertPositionTo("relative",{top:0,left:o-i.helperProportions.width}).left),s&&(e.position.left=i._convertPositionTo("relative",{top:0,left:l}).left)),d=n||r||a||s,"outer"!==u.snapMode&&(n=Math.abs(c-m)<=p,r=Math.abs(h-_)<=p,a=Math.abs(o-g)<=p,s=Math.abs(l-f)<=p,n&&(e.position.top=i._convertPositionTo("relative",{top:c,left:0}).top),r&&(e.position.top=i._convertPositionTo("relative",{top:h-i.helperProportions.height,left:0}).top),a&&(e.position.left=i._convertPositionTo("relative",{top:0,left:o}).left),s&&(e.position.left=i._convertPositionTo("relative",{top:0,left:l-i.helperProportions.width}).left)),!i.snapElements[v].snapping&&(n||r||a||s||d)&&i.options.snap.snap&&i.options.snap.snap.call(i.element,t,y.extend(i._uiHash(),{snapItem:i.snapElements[v].item})),i.snapElements[v].snapping=n||r||a||s||d)}}),y.ui.plugin.add("draggable","stack",{start:function(t,e,i){var n,i=i.options;(i=y.makeArray(y(i.stack)).sort(function(t,e){return(parseInt(y(t).css("zIndex"),10)||0)-(parseInt(y(e).css("zIndex"),10)||0)})).length&&(n=parseInt(y(i[0]).css("zIndex"),10)||0,y(i).each(function(t){y(this).css("zIndex",n+t)}),this.css("zIndex",n+i.length))}}),y.ui.plugin.add("draggable","zIndex",{start:function(t,e,i){e=y(e.helper),i=i.options,e.css("zIndex")&&(i._zIndex=e.css("zIndex")),e.css("zIndex",i.zIndex)},stop:function(t,e,i){(i=i.options)._zIndex&&y(e.helper).css("zIndex",i._zIndex)}}),y.ui.draggable,y.widget("ui.resizable",y.ui.mouse,{version:"1.13.2",widgetEventPrefix:"resize",options:{alsoResize:!1,animate:!1,animateDuration:"slow",animateEasing:"swing",aspectRatio:!1,autoHide:!1,classes:{"ui-resizable-se":"ui-icon ui-icon-gripsmall-diagonal-se"},containment:!1,ghost:!1,grid:!1,handles:"e,s,se",helper:!1,maxHeight:null,maxWidth:null,minHeight:10,minWidth:10,zIndex:90,resize:null,start:null,stop:null},_num:function(t){return parseFloat(t)||0},_isNumber:function(t){return!isNaN(parseFloat(t))},_hasScroll:function(t,e){if("hidden"===y(t).css("overflow"))return!1;var i=e&&"left"===e?"scrollLeft":"scrollTop",e=!1;if(0<t[i])return!0;try{t[i]=1,e=0<t[i],t[i]=0}catch(t){}return e},_create:function(){var t,e=this.options,i=this;this._addClass("ui-resizable"),y.extend(this,{_aspectRatio:!!e.aspectRatio,aspectRatio:e.aspectRatio,originalElement:this.element,_proportionallyResizeElements:[],_helper:e.helper||e.ghost||e.animate?e.helper||"ui-resizable-helper":null}),this.element[0].nodeName.match(/^(canvas|textarea|input|select|button|img)$/i)&&(this.element.wrap(y("<div class='ui-wrapper'></div>").css({overflow:"hidden",position:this.element.css("position"),width:this.element.outerWidth(),height:this.element.outerHeight(),top:this.element.css("top"),left:this.element.css("left")})),this.element=this.element.parent().data("ui-resizable",this.element.resizable("instance")),this.elementIsWrapper=!0,t={marginTop:this.originalElement.css("marginTop"),marginRight:this.originalElement.css("marginRight"),marginBottom:this.originalElement.css("marginBottom"),marginLeft:this.originalElement.css("marginLeft")},this.element.css(t),this.originalElement.css("margin",0),this.originalResizeStyle=this.originalElement.css("resize"),this.originalElement.css("resize","none"),this._proportionallyResizeElements.push(this.originalElement.css({position:"static",zoom:1,display:"block"})),this.originalElement.css(t),this._proportionallyResize()),this._setupHandles(),e.autoHide&&y(this.element).on("mouseenter",function(){e.disabled||(i._removeClass("ui-resizable-autohide"),i._handles.show())}).on("mouseleave",function(){e.disabled||i.resizing||(i._addClass("ui-resizable-autohide"),i._handles.hide())}),this._mouseInit()},_destroy:function(){function t(t){y(t).removeData("resizable").removeData("ui-resizable").off(".resizable")}var e;return this._mouseDestroy(),this._addedHandles.remove(),this.elementIsWrapper&&(t(this.element),e=this.element,this.originalElement.css({position:e.css("position"),width:e.outerWidth(),height:e.outerHeight(),top:e.css("top"),left:e.css("left")}).insertAfter(e),e.remove()),this.originalElement.css("resize",this.originalResizeStyle),t(this.originalElement),this},_setOption:function(t,e){switch(this._super(t,e),t){case"handles":this._removeHandles(),this._setupHandles();break;case"aspectRatio":this._aspectRatio=!!e}},_setupHandles:function(){var t,e,i,n,r,a=this.options,s=this;if(this.handles=a.handles||(y(".ui-resizable-handle",this.element).length?{n:".ui-resizable-n",e:".ui-resizable-e",s:".ui-resizable-s",w:".ui-resizable-w",se:".ui-resizable-se",sw:".ui-resizable-sw",ne:".ui-resizable-ne",nw:".ui-resizable-nw"}:"e,s,se"),this._handles=y(),this._addedHandles=y(),this.handles.constructor===String)for("all"===this.handles&&(this.handles="n,e,s,w,se,sw,ne,nw"),i=this.handles.split(","),this.handles={},e=0;e<i.length;e++)n="ui-resizable-"+(t=String.prototype.trim.call(i[e])),r=y("<div>"),this._addClass(r,"ui-resizable-handle "+n),r.css({zIndex:a.zIndex}),this.handles[t]=".ui-resizable-"+t,this.element.children(this.handles[t]).length||(this.element.append(r),this._addedHandles=this._addedHandles.add(r));this._renderAxis=function(t){var e,i,n;for(e in t=t||this.element,this.handles)this.handles[e].constructor===String?this.handles[e]=this.element.children(this.handles[e]).first().show():(this.handles[e].jquery||this.handles[e].nodeType)&&(this.handles[e]=y(this.handles[e]),this._on(this.handles[e],{mousedown:s._mouseDown})),this.elementIsWrapper&&this.originalElement[0].nodeName.match(/^(textarea|input|select|button)$/i)&&(i=y(this.handles[e],this.element),n=/sw|ne|nw|se|n|s/.test(e)?i.outerHeight():i.outerWidth(),i=["padding",/ne|nw|n/.test(e)?"Top":/se|sw|s/.test(e)?"Bottom":/^e$/.test(e)?"Right":"Left"].join(""),t.css(i,n),this._proportionallyResize()),this._handles=this._handles.add(this.handles[e])},this._renderAxis(this.element),this._handles=this._handles.add(this.element.find(".ui-resizable-handle")),this._handles.disableSelection(),this._handles.on("mouseover",function(){s.resizing||(this.className&&(r=this.className.match(/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i)),s.axis=r&&r[1]?r[1]:"se")}),a.autoHide&&(this._handles.hide(),this._addClass("ui-resizable-autohide"))},_removeHandles:function(){this._addedHandles.remove()},_mouseCapture:function(t){var e,i,n=!1;for(e in this.handles)(i=y(this.handles[e])[0])!==t.target&&!y.contains(i,t.target)||(n=!0);return!this.options.disabled&&n},_mouseStart:function(t){var e,i,n=this.options,r=this.element;return this.resizing=!0,this._renderProxy(),e=this._num(this.helper.css("left")),i=this._num(this.helper.css("top")),n.containment&&(e+=y(n.containment).scrollLeft()||0,i+=y(n.containment).scrollTop()||0),this.offset=this.helper.offset(),this.position={left:e,top:i},this.size=this._helper?{width:this.helper.width(),height:this.helper.height()}:{width:r.width(),height:r.height()},this.originalSize=this._helper?{width:r.outerWidth(),height:r.outerHeight()}:{width:r.width(),height:r.height()},this.sizeDiff={width:r.outerWidth()-r.width(),height:r.outerHeight()-r.height()},this.originalPosition={left:e,top:i},this.originalMousePosition={left:t.pageX,top:t.pageY},this.aspectRatio="number"==typeof n.aspectRatio?n.aspectRatio:this.originalSize.width/this.originalSize.height||1,n=y(".ui-resizable-"+this.axis).css("cursor"),y("body").css("cursor","auto"===n?this.axis+"-resize":n),this._addClass("ui-resizable-resizing"),this._propagate("start",t),!0},_mouseDrag:function(t){var e=this.originalMousePosition,i=this.axis,n=t.pageX-e.left||0,e=t.pageY-e.top||0,i=this._change[i];return this._updatePrevProperties(),i&&(e=i.apply(this,[t,n,e]),this._updateVirtualBoundaries(t.shiftKey),(this._aspectRatio||t.shiftKey)&&(e=this._updateRatio(e,t)),e=this._respectSize(e,t),this._updateCache(e),this._propagate("resize",t),e=this._applyChanges(),!this._helper&&this._proportionallyResizeElements.length&&this._proportionallyResize(),y.isEmptyObject(e)||(this._updatePrevProperties(),this._trigger("resize",t,this.ui()),this._applyChanges())),!1},_mouseStop:function(t){this.resizing=!1;var e,i,n,r=this.options,a=this;return this._helper&&(n=(e=(i=this._proportionallyResizeElements).length&&/textarea/i.test(i[0].nodeName))&&this._hasScroll(i[0],"left")?0:a.sizeDiff.height,i=e?0:a.sizeDiff.width,e={width:a.helper.width()-i,height:a.helper.height()-n},i=parseFloat(a.element.css("left"))+(a.position.left-a.originalPosition.left)||null,n=parseFloat(a.element.css("top"))+(a.position.top-a.originalPosition.top)||null,r.animate||this.element.css(y.extend(e,{top:n,left:i})),a.helper.height(a.size.height),a.helper.width(a.size.width),this._helper&&!r.animate&&this._proportionallyResize()),y("body").css("cursor","auto"),this._removeClass("ui-resizable-resizing"),this._propagate("stop",t),this._helper&&this.helper.remove(),!1},_updatePrevProperties:function(){this.prevPosition={top:this.position.top,left:this.position.left},this.prevSize={width:this.size.width,height:this.size.height}},_applyChanges:function(){var t={};return this.position.top!==this.prevPosition.top&&(t.top=this.position.top+"px"),this.position.left!==this.prevPosition.left&&(t.left=this.position.left+"px"),this.size.width!==this.prevSize.width&&(t.width=this.size.width+"px"),this.size.height!==this.prevSize.height&&(t.height=this.size.height+"px"),this.helper.css(t),t},_updateVirtualBoundaries:function(t){var e,i,n=this.options,r={minWidth:this._isNumber(n.minWidth)?n.minWidth:0,maxWidth:this._isNumber(n.maxWidth)?n.maxWidth:1/0,minHeight:this._isNumber(n.minHeight)?n.minHeight:0,maxHeight:this._isNumber(n.maxHeight)?n.maxHeight:1/0};(this._aspectRatio||t)&&(e=r.minHeight*this.aspectRatio,i=r.minWidth/this.aspectRatio,n=r.maxHeight*this.aspectRatio,t=r.maxWidth/this.aspectRatio,e>r.minWidth&&(r.minWidth=e),i>r.minHeight&&(r.minHeight=i),n<r.maxWidth&&(r.maxWidth=n),t<r.maxHeight&&(r.maxHeight=t)),this._vBoundaries=r},_updateCache:function(t){this.offset=this.helper.offset(),this._isNumber(t.left)&&(this.position.left=t.left),this._isNumber(t.top)&&(this.position.top=t.top),this._isNumber(t.height)&&(this.size.height=t.height),this._isNumber(t.width)&&(this.size.width=t.width)},_updateRatio:function(t){var e=this.position,i=this.size,n=this.axis;return this._isNumber(t.height)?t.width=t.height*this.aspectRatio:this._isNumber(t.width)&&(t.height=t.width/this.aspectRatio),"sw"===n&&(t.left=e.left+(i.width-t.width),t.top=null),"nw"===n&&(t.top=e.top+(i.height-t.height),t.left=e.left+(i.width-t.width)),t},_respectSize:function(t){var e=this._vBoundaries,i=this.axis,n=this._isNumber(t.width)&&e.maxWidth&&e.maxWidth<t.width,r=this._isNumber(t.height)&&e.maxHeight&&e.maxHeight<t.height,a=this._isNumber(t.width)&&e.minWidth&&e.minWidth>t.width,s=this._isNumber(t.height)&&e.minHeight&&e.minHeight>t.height,o=this.originalPosition.left+this.originalSize.width,l=this.originalPosition.top+this.originalSize.height,c=/sw|nw|w/.test(i),i=/nw|ne|n/.test(i);return a&&(t.width=e.minWidth),s&&(t.height=e.minHeight),n&&(t.width=e.maxWidth),r&&(t.height=e.maxHeight),a&&c&&(t.left=o-e.minWidth),n&&c&&(t.left=o-e.maxWidth),s&&i&&(t.top=l-e.minHeight),r&&i&&(t.top=l-e.maxHeight),t.width||t.height||t.left||!t.top?t.width||t.height||t.top||!t.left||(t.left=null):t.top=null,t},_getPaddingPlusBorderDimensions:function(t){for(var e=0,i=[],n=[t.css("borderTopWidth"),t.css("borderRightWidth"),t.css("borderBottomWidth"),t.css("borderLeftWidth")],r=[t.css("paddingTop"),t.css("paddingRight"),t.css("paddingBottom"),t.css("paddingLeft")];e<4;e++)i[e]=parseFloat(n[e])||0,i[e]+=parseFloat(r[e])||0;return{height:i[0]+i[2],width:i[1]+i[3]}},_proportionallyResize:function(){if(this._proportionallyResizeElements.length)for(var t,e=0,i=this.helper||this.element;e<this._proportionallyResizeElements.length;e++)t=this._proportionallyResizeElements[e],this.outerDimensions||(this.outerDimensions=this._getPaddingPlusBorderDimensions(t)),t.css({height:i.height()-this.outerDimensions.height||0,width:i.width()-this.outerDimensions.width||0})},_renderProxy:function(){var t=this.element,e=this.options;this.elementOffset=t.offset(),this._helper?(this.helper=this.helper||y("<div></div>").css({overflow:"hidden"}),this._addClass(this.helper,this._helper),this.helper.css({width:this.element.outerWidth(),height:this.element.outerHeight(),position:"absolute",left:this.elementOffset.left+"px",top:this.elementOffset.top+"px",zIndex:++e.zIndex}),this.helper.appendTo("body").disableSelection()):this.helper=this.element},_change:{e:function(t,e){return{width:this.originalSize.width+e}},w:function(t,e){var i=this.originalSize;return{left:this.originalPosition.left+e,width:i.width-e}},n:function(t,e,i){var n=this.originalSize;return{top:this.originalPosition.top+i,height:n.height-i}},s:function(t,e,i){return{height:this.originalSize.height+i}},se:function(t,e,i){return y.extend(this._change.s.apply(this,arguments),this._change.e.apply(this,[t,e,i]))},sw:function(t,e,i){return y.extend(this._change.s.apply(this,arguments),this._change.w.apply(this,[t,e,i]))},ne:function(t,e,i){return y.extend(this._change.n.apply(this,arguments),this._change.e.apply(this,[t,e,i]))},nw:function(t,e,i){return y.extend(this._change.n.apply(this,arguments),this._change.w.apply(this,[t,e,i]))}},_propagate:function(t,e){y.ui.plugin.call(this,t,[e,this.ui()]),"resize"!==t&&this._trigger(t,e,this.ui())},plugins:{},ui:function(){return{originalElement:this.originalElement,element:this.element,helper:this.helper,position:this.position,size:this.size,originalSize:this.originalSize,originalPosition:this.originalPosition}}}),y.ui.plugin.add("resizable","animate",{stop:function(e){var i=y(this).resizable("instance"),t=i.options,n=i._proportionallyResizeElements,r=(s=n.length&&/textarea/i.test(n[0].nodeName))&&i._hasScroll(n[0],"left")?0:i.sizeDiff.height,a=s?0:i.sizeDiff.width,s={width:i.size.width-a,height:i.size.height-r},a=parseFloat(i.element.css("left"))+(i.position.left-i.originalPosition.left)||null,r=parseFloat(i.element.css("top"))+(i.position.top-i.originalPosition.top)||null;i.element.animate(y.extend(s,r&&a?{top:r,left:a}:{}),{duration:t.animateDuration,easing:t.animateEasing,step:function(){var t={width:parseFloat(i.element.css("width")),height:parseFloat(i.element.css("height")),top:parseFloat(i.element.css("top")),left:parseFloat(i.element.css("left"))};n&&n.length&&y(n[0]).css({width:t.width,height:t.height}),i._updateCache(t),i._propagate("resize",e)}})}}),y.ui.plugin.add("resizable","containment",{start:function(){var i,n,r=y(this).resizable("instance"),t=r.options,e=r.element,a=t.containment,s=a instanceof y?a.get(0):/parent/.test(a)?e.parent().get(0):a;s&&(r.containerElement=y(s),/document/.test(a)||a===document?(r.containerOffset={left:0,top:0},r.containerPosition={left:0,top:0},r.parentData={element:y(document),left:0,top:0,width:y(document).width(),height:y(document).height()||document.body.parentNode.scrollHeight}):(i=y(s),n=[],y(["Top","Right","Left","Bottom"]).each(function(t,e){n[t]=r._num(i.css("padding"+e))}),r.containerOffset=i.offset(),r.containerPosition=i.position(),r.containerSize={height:i.innerHeight()-n[3],width:i.innerWidth()-n[1]},t=r.containerOffset,e=r.containerSize.height,a=r.containerSize.width,a=r._hasScroll(s,"left")?s.scrollWidth:a,e=r._hasScroll(s)?s.scrollHeight:e,r.parentData={element:s,left:t.left,top:t.top,width:a,height:e}))},resize:function(t){var e=y(this).resizable("instance"),i=e.options,n=e.containerOffset,r=e.position,a=e._aspectRatio||t.shiftKey,s={top:0,left:0},o=e.containerElement,t=!0;o[0]!==document&&/static/.test(o.css("position"))&&(s=n),r.left<(e._helper?n.left:0)&&(e.size.width=e.size.width+(e._helper?e.position.left-n.left:e.position.left-s.left),a&&(e.size.height=e.size.width/e.aspectRatio,t=!1),e.position.left=i.helper?n.left:0),r.top<(e._helper?n.top:0)&&(e.size.height=e.size.height+(e._helper?e.position.top-n.top:e.position.top),a&&(e.size.width=e.size.height*e.aspectRatio,t=!1),e.position.top=e._helper?n.top:0),i=e.containerElement.get(0)===e.element.parent().get(0),r=/relative|absolute/.test(e.containerElement.css("position")),i&&r?(e.offset.left=e.parentData.left+e.position.left,e.offset.top=e.parentData.top+e.position.top):(e.offset.left=e.element.offset().left,e.offset.top=e.element.offset().top),r=Math.abs(e.sizeDiff.width+(e._helper?e.offset.left-s.left:e.offset.left-n.left)),n=Math.abs(e.sizeDiff.height+(e._helper?e.offset.top-s.top:e.offset.top-n.top)),r+e.size.width>=e.parentData.width&&(e.size.width=e.parentData.width-r,a&&(e.size.height=e.size.width/e.aspectRatio,t=!1)),n+e.size.height>=e.parentData.height&&(e.size.height=e.parentData.height-n,a&&(e.size.width=e.size.height*e.aspectRatio,t=!1)),t||(e.position.left=e.prevPosition.left,e.position.top=e.prevPosition.top,e.size.width=e.prevSize.width,e.size.height=e.prevSize.height)},stop:function(){var t=y(this).resizable("instance"),e=t.options,i=t.containerOffset,n=t.containerPosition,r=t.containerElement,a=(o=y(t.helper)).offset(),s=o.outerWidth()-t.sizeDiff.width,o=o.outerHeight()-t.sizeDiff.height;t._helper&&!e.animate&&/relative/.test(r.css("position"))&&y(this).css({left:a.left-n.left-i.left,width:s,height:o}),t._helper&&!e.animate&&/static/.test(r.css("position"))&&y(this).css({left:a.left-n.left-i.left,width:s,height:o})}}),y.ui.plugin.add("resizable","alsoResize",{start:function(){var t=y(this).resizable("instance").options;y(t.alsoResize).each(function(){var t=y(this);t.data("ui-resizable-alsoresize",{width:parseFloat(t.width()),height:parseFloat(t.height()),left:parseFloat(t.css("left")),top:parseFloat(t.css("top"))})})},resize:function(t,i){var e=y(this).resizable("instance"),n=e.options,r=e.originalSize,a=e.originalPosition,s={height:e.size.height-r.height||0,width:e.size.width-r.width||0,top:e.position.top-a.top||0,left:e.position.left-a.left||0};y(n.alsoResize).each(function(){var t=y(this),n=y(this).data("ui-resizable-alsoresize"),r={},e=t.parents(i.originalElement[0]).length?["width","height"]:["width","height","top","left"];y.each(e,function(t,e){var i=(n[e]||0)+(s[e]||0);i&&0<=i&&(r[e]=i||null)}),t.css(r)})},stop:function(){y(this).removeData("ui-resizable-alsoresize")}}),y.ui.plugin.add("resizable","ghost",{start:function(){var t=y(this).resizable("instance"),e=t.size;t.ghost=t.originalElement.clone(),t.ghost.css({opacity:.25,display:"block",position:"relative",height:e.height,width:e.width,margin:0,left:0,top:0}),t._addClass(t.ghost,"ui-resizable-ghost"),!1!==y.uiBackCompat&&"string"==typeof t.options.ghost&&t.ghost.addClass(this.options.ghost),t.ghost.appendTo(t.helper)},resize:function(){var t=y(this).resizable("instance");t.ghost&&t.ghost.css({position:"relative",height:t.size.height,width:t.size.width})},stop:function(){var t=y(this).resizable("instance");t.ghost&&t.helper&&t.helper.get(0).removeChild(t.ghost.get(0))}}),y.ui.plugin.add("resizable","grid",{resize:function(){var t,e=y(this).resizable("instance"),i=e.options,n=e.size,r=e.originalSize,a=e.originalPosition,s=e.axis,o="number"==typeof i.grid?[i.grid,i.grid]:i.grid,l=o[0]||1,c=o[1]||1,h=Math.round((n.width-r.width)/l)*l,d=Math.round((n.height-r.height)/c)*c,u=r.width+h,p=r.height+d,g=i.maxWidth&&i.maxWidth<u,f=i.maxHeight&&i.maxHeight<p,m=i.minWidth&&i.minWidth>u,n=i.minHeight&&i.minHeight>p;i.grid=o,m&&(u+=l),n&&(p+=c),g&&(u-=l),f&&(p-=c),/^(se|s|e)$/.test(s)?(e.size.width=u,e.size.height=p):/^(ne)$/.test(s)?(e.size.width=u,e.size.height=p,e.position.top=a.top-d):/^(sw)$/.test(s)?(e.size.width=u,e.size.height=p,e.position.left=a.left-h):((p-c<=0||u-l<=0)&&(t=e._getPaddingPlusBorderDimensions(this)),0<p-c?(e.size.height=p,e.position.top=a.top-d):(p=c-t.height,e.size.height=p,e.position.top=a.top+r.height-p),0<u-l?(e.size.width=u,e.position.left=a.left-h):(u=l-t.width,e.size.width=u,e.position.left=a.left+r.width-u))}}),y.ui.resizable,y.widget("ui.slider",y.ui.mouse,{version:"1.13.2",widgetEventPrefix:"slide",options:{animate:!1,classes:{"ui-slider":"ui-corner-all","ui-slider-handle":"ui-corner-all","ui-slider-range":"ui-corner-all ui-widget-header"},distance:0,max:100,min:0,orientation:"horizontal",range:!1,step:1,value:0,values:null,change:null,slide:null,start:null,stop:null},numPages:5,_create:function(){this._keySliding=!1,this._mouseSliding=!1,this._animateOff=!0,this._handleIndex=null,this._detectOrientation(),this._mouseInit(),this._calculateNewMax(),this._addClass("ui-slider ui-slider-"+this.orientation,"ui-widget ui-widget-content"),this._refresh(),this._animateOff=!1},_refresh:function(){this._createRange(),this._createHandles(),this._setupEvents(),this._refreshValue()},_createHandles:function(){var t,e=this.options,i=this.element.find(".ui-slider-handle"),n=[],r=e.values&&e.values.length||1;for(i.length>r&&(i.slice(r).remove(),i=i.slice(0,r)),t=i.length;t<r;t++)n.push("<span tabindex='0'></span>");this.handles=i.add(y(n.join("")).appendTo(this.element)),this._addClass(this.handles,"ui-slider-handle","ui-state-default"),this.handle=this.handles.eq(0),this.handles.each(function(t){y(this).data("ui-slider-handle-index",t).attr("tabIndex",0)})},_createRange:function(){var t=this.options;t.range?(!0===t.range&&(t.values?t.values.length&&2!==t.values.length?t.values=[t.values[0],t.values[0]]:Array.isArray(t.values)&&(t.values=t.values.slice(0)):t.values=[this._valueMin(),this._valueMin()]),this.range&&this.range.length?(this._removeClass(this.range,"ui-slider-range-min ui-slider-range-max"),this.range.css({left:"",bottom:""})):(this.range=y("<div>").appendTo(this.element),this._addClass(this.range,"ui-slider-range")),"min"!==t.range&&"max"!==t.range||this._addClass(this.range,"ui-slider-range-"+t.range)):(this.range&&this.range.remove(),this.range=null)},_setupEvents:function(){this._off(this.handles),this._on(this.handles,this._handleEvents),this._hoverable(this.handles),this._focusable(this.handles)},_destroy:function(){this.handles.remove(),this.range&&this.range.remove(),this._mouseDestroy()},_mouseCapture:function(t){var i,n,r,a,e,s,o=this,l=this.options;return!l.disabled&&(this.elementSize={width:this.element.outerWidth(),height:this.element.outerHeight()},this.elementOffset=this.element.offset(),s={x:t.pageX,y:t.pageY},i=this._normValueFromMouse(s),n=this._valueMax()-this._valueMin()+1,this.handles.each(function(t){var e=Math.abs(i-o.values(t));(e<n||n===e&&(t===o._lastChangedValue||o.values(t)===l.min))&&(n=e,r=y(this),a=t)}),!1!==this._start(t,a)&&(this._mouseSliding=!0,this._handleIndex=a,this._addClass(r,null,"ui-state-active"),r.trigger("focus"),e=r.offset(),s=!y(t.target).parents().addBack().is(".ui-slider-handle"),this._clickOffset=s?{left:0,top:0}:{left:t.pageX-e.left-r.width()/2,top:t.pageY-e.top-r.height()/2-(parseInt(r.css("borderTopWidth"),10)||0)-(parseInt(r.css("borderBottomWidth"),10)||0)+(parseInt(r.css("marginTop"),10)||0)},this.handles.hasClass("ui-state-hover")||this._slide(t,a,i),this._animateOff=!0))},_mouseStart:function(){return!0},_mouseDrag:function(t){var e={x:t.pageX,y:t.pageY},e=this._normValueFromMouse(e);return this._slide(t,this._handleIndex,e),!1},_mouseStop:function(t){return this._removeClass(this.handles,null,"ui-state-active"),this._mouseSliding=!1,this._stop(t,this._handleIndex),this._change(t,this._handleIndex),this._handleIndex=null,this._clickOffset=null,this._animateOff=!1},_detectOrientation:function(){this.orientation="vertical"===this.options.orientation?"vertical":"horizontal"},_normValueFromMouse:function(t){var e;return(t=1<(t=(t="horizontal"===this.orientation?(e=this.elementSize.width,t.x-this.elementOffset.left-(this._clickOffset?this._clickOffset.left:0)):(e=this.elementSize.height,t.y-this.elementOffset.top-(this._clickOffset?this._clickOffset.top:0)))/e)?1:t)<0&&(t=0),"vertical"===this.orientation&&(t=1-t),e=this._valueMax()-this._valueMin(),e=this._valueMin()+t*e,this._trimAlignValue(e)},_uiHash:function(t,e,i){var n={handle:this.handles[t],handleIndex:t,value:void 0!==e?e:this.value()};return this._hasMultipleValues()&&(n.value=void 0!==e?e:this.values(t),n.values=i||this.values()),n},_hasMultipleValues:function(){return this.options.values&&this.options.values.length},_start:function(t,e){return this._trigger("start",t,this._uiHash(e))},_slide:function(t,e,i){var n,r=this.value(),a=this.values();this._hasMultipleValues()&&(n=this.values(e?0:1),r=this.values(e),2===this.options.values.length&&!0===this.options.range&&(i=0===e?Math.min(n,i):Math.max(n,i)),a[e]=i),i!==r&&!1!==this._trigger("slide",t,this._uiHash(e,i,a))&&(this._hasMultipleValues()?this.values(e,i):this.value(i))},_stop:function(t,e){this._trigger("stop",t,this._uiHash(e))},_change:function(t,e){this._keySliding||this._mouseSliding||(this._lastChangedValue=e,this._trigger("change",t,this._uiHash(e)))},value:function(t){return arguments.length?(this.options.value=this._trimAlignValue(t),this._refreshValue(),void this._change(null,0)):this._value()},values:function(t,e){var i,n,r;if(1<arguments.length)return this.options.values[t]=this._trimAlignValue(e),this._refreshValue(),void this._change(null,t);if(!arguments.length)return this._values();if(!Array.isArray(t))return this._hasMultipleValues()?this._values(t):this.value();for(i=this.options.values,n=t,r=0;r<i.length;r+=1)i[r]=this._trimAlignValue(n[r]),this._change(null,r);this._refreshValue()},_setOption:function(t,e){var i,n=0;switch("range"===t&&!0===this.options.range&&("min"===e?(this.options.value=this._values(0),this.options.values=null):"max"===e&&(this.options.value=this._values(this.options.values.length-1),this.options.values=null)),Array.isArray(this.options.values)&&(n=this.options.values.length),this._super(t,e),t){case"orientation":this._detectOrientation(),this._removeClass("ui-slider-horizontal ui-slider-vertical")._addClass("ui-slider-"+this.orientation),this._refreshValue(),this.options.range&&this._refreshRange(e),this.handles.css("horizontal"===e?"bottom":"left","");break;case"value":this._animateOff=!0,this._refreshValue(),this._change(null,0),this._animateOff=!1;break;case"values":for(this._animateOff=!0,this._refreshValue(),i=n-1;0<=i;i--)this._change(null,i);this._animateOff=!1;break;case"step":case"min":case"max":this._animateOff=!0,this._calculateNewMax(),this._refreshValue(),this._animateOff=!1;break;case"range":this._animateOff=!0,this._refresh(),this._animateOff=!1}},_setOptionDisabled:function(t){this._super(t),this._toggleClass(null,"ui-state-disabled",!!t)},_value:function(){var t=this.options.value;return this._trimAlignValue(t)},_values:function(t){var e,i;if(arguments.length)return t=this.options.values[t],this._trimAlignValue(t);if(this._hasMultipleValues()){for(e=this.options.values.slice(),i=0;i<e.length;i+=1)e[i]=this._trimAlignValue(e[i]);return e}return[]},_trimAlignValue:function(t){if(t<=this._valueMin())return this._valueMin();if(t>=this._valueMax())return this._valueMax();var e=0<this.options.step?this.options.step:1,i=(t-this._valueMin())%e,t=t-i;return 2*Math.abs(i)>=e&&(t+=0<i?e:-e),parseFloat(t.toFixed(5))},_calculateNewMax:function(){var t=this.options.max,e=this._valueMin(),i=this.options.step;(t=Math.round((t-e)/i)*i+e)>this.options.max&&(t-=i),this.max=parseFloat(t.toFixed(this._precision()))},_precision:function(){var t=this._precisionOf(this.options.step);return null!==this.options.min?Math.max(t,this._precisionOf(this.options.min)):t},_precisionOf:function(t){var e=t.toString();return-1===(t=e.indexOf("."))?0:e.length-t-1},_valueMin:function(){return this.options.min},_valueMax:function(){return this.max},_refreshRange:function(t){"vertical"===t&&this.range.css({width:"",left:""}),"horizontal"===t&&this.range.css({height:"",bottom:""})},_refreshValue:function(){var e,i,t,n,r,a=this.options.range,s=this.options,o=this,l=!this._animateOff&&s.animate,c={};this._hasMultipleValues()?this.handles.each(function(t){i=(o.values(t)-o._valueMin())/(o._valueMax()-o._valueMin())*100,c["horizontal"===o.orientation?"left":"bottom"]=i+"%",y(this).stop(1,1)[l?"animate":"css"](c,s.animate),!0===o.options.range&&("horizontal"===o.orientation?(0===t&&o.range.stop(1,1)[l?"animate":"css"]({left:i+"%"},s.animate),1===t&&o.range[l?"animate":"css"]({width:i-e+"%"},{queue:!1,duration:s.animate})):(0===t&&o.range.stop(1,1)[l?"animate":"css"]({bottom:i+"%"},s.animate),1===t&&o.range[l?"animate":"css"]({height:i-e+"%"},{queue:!1,duration:s.animate}))),e=i}):(t=this.value(),n=this._valueMin(),r=this._valueMax(),i=r!==n?(t-n)/(r-n)*100:0,c["horizontal"===this.orientation?"left":"bottom"]=i+"%",this.handle.stop(1,1)[l?"animate":"css"](c,s.animate),"min"===a&&"horizontal"===this.orientation&&this.range.stop(1,1)[l?"animate":"css"]({width:i+"%"},s.animate),"max"===a&&"horizontal"===this.orientation&&this.range.stop(1,1)[l?"animate":"css"]({width:100-i+"%"},s.animate),"min"===a&&"vertical"===this.orientation&&this.range.stop(1,1)[l?"animate":"css"]({height:i+"%"},s.animate),"max"===a&&"vertical"===this.orientation&&this.range.stop(1,1)[l?"animate":"css"]({height:100-i+"%"},s.animate))},_handleEvents:{keydown:function(t){var e,i,n,r=y(t.target).data("ui-slider-handle-index");switch(t.keyCode){case y.ui.keyCode.HOME:case y.ui.keyCode.END:case y.ui.keyCode.PAGE_UP:case y.ui.keyCode.PAGE_DOWN:case y.ui.keyCode.UP:case y.ui.keyCode.RIGHT:case y.ui.keyCode.DOWN:case y.ui.keyCode.LEFT:if(t.preventDefault(),!this._keySliding&&(this._keySliding=!0,this._addClass(y(t.target),null,"ui-state-active"),!1===this._start(t,r)))return}switch(n=this.options.step,e=i=this._hasMultipleValues()?this.values(r):this.value(),t.keyCode){case y.ui.keyCode.HOME:i=this._valueMin();break;case y.ui.keyCode.END:i=this._valueMax();break;case y.ui.keyCode.PAGE_UP:i=this._trimAlignValue(e+(this._valueMax()-this._valueMin())/this.numPages);break;case y.ui.keyCode.PAGE_DOWN:i=this._trimAlignValue(e-(this._valueMax()-this._valueMin())/this.numPages);break;case y.ui.keyCode.UP:case y.ui.keyCode.RIGHT:if(e===this._valueMax())return;i=this._trimAlignValue(e+n);break;case y.ui.keyCode.DOWN:case y.ui.keyCode.LEFT:if(e===this._valueMin())return;i=this._trimAlignValue(e-n)}this._slide(t,r,i)},keyup:function(t){var e=y(t.target).data("ui-slider-handle-index");this._keySliding&&(this._keySliding=!1,this._stop(t,e),this._change(t,e),this._removeClass(y(t.target),null,"ui-state-active"))}}})}),!function(t){function e(t,e){var i,n;1<t.originalEvent.touches.length||(t.preventDefault(),i=t.originalEvent.changedTouches[0],(n=document.createEvent("MouseEvents")).initMouseEvent(e,!0,!0,window,1,i.screenX,i.screenY,i.clientX,i.clientY,!1,!1,!1,!1,0,null),t.target.dispatchEvent(n))}var i,n,r,a;t.support.touch="ontouchend"in document,t.support.touch&&(n=t.ui.mouse.prototype,r=n._mouseInit,a=n._mouseDestroy,n._touchStart=function(t){!i&&this._mouseCapture(t.originalEvent.changedTouches[0])&&(i=!0,this._touchMoved=!1,e(t,"mouseover"),e(t,"mousemove"),e(t,"mousedown"))},n._touchMove=function(t){i&&(this._touchMoved=!0,e(t,"mousemove"))},n._touchEnd=function(t){i&&(e(t,"mouseup"),e(t,"mouseout"),this._touchMoved||e(t,"click"),i=!1)},n._mouseInit=function(){this.element.bind({touchstart:t.proxy(this,"_touchStart"),touchmove:t.proxy(this,"_touchMove"),touchend:t.proxy(this,"_touchEnd")}),r.call(this)},n._mouseDestroy=function(){this.element.unbind({touchstart:t.proxy(this,"_touchStart"),touchmove:t.proxy(this,"_touchMove"),touchend:t.proxy(this,"_touchEnd")}),a.call(this)})}(jQuery),!function(t){"function"==typeof define&&define.amdXX?define([],t):"object"==typeof exports?module.exports=t():window.noUiSlider=t()}(function(){"use strict";var ct="14.4.0";function ht(t){t.parentElement.removeChild(t)}function s(t){return null!=t}function dt(t){t.preventDefault()}function d(t){return"number"==typeof t&&!isNaN(t)&&isFinite(t)}function ut(t,e,i){0<i&&(ft(t,e),setTimeout(function(){mt(t,e)},i))}function pt(t){return Math.max(Math.min(t,100),0)}function gt(t){return Array.isArray(t)?t:[t]}function e(t){t=(t=String(t)).split(".");return 1<t.length?t[1].length:0}function ft(t,e){t.classList&&!/\s/.test(e)?t.classList.add(e):t.className+=" "+e}function mt(t,e){t.classList&&!/\s/.test(e)?t.classList.remove(e):t.className=t.className.replace(new RegExp("(^|\\b)"+e.split(" ").join("|")+"(\\b|$)","gi")," ")}function _t(t){var e=void 0!==window.pageXOffset,i="CSS1Compat"===(t.compatMode||"");return{x:e?window.pageXOffset:(i?t.documentElement:t.body).scrollLeft,y:e?window.pageYOffset:(i?t.documentElement:t.body).scrollTop}}function u(t,e){return 100/(e-t)}function p(t,e){return 100*e/(t[1]-t[0])}function o(t,e){for(var i=1;t>=e[i];)i+=1;return i}function i(t,e,i){this.xPct=[],this.xVal=[],this.xSteps=[i||!1],this.xNumSteps=[!1],this.xHighestCompleteStep=[],this.snap=e;var n,r,a,s,o=[];for(n in t)t.hasOwnProperty(n)&&o.push([t[n],n]);for(o.length&&"object"==typeof o[0][0]?o.sort(function(t,e){return t[0][0]-e[0][0]}):o.sort(function(t,e){return t[0]-e[0]}),n=0;n<o.length;n++){l=void 0;c=void 0;h=void 0;l=void 0;var l=o[n][1];var c=o[n][0];var h=this;if("number"==typeof c&&(c=[c]),!Array.isArray(c))throw new Error("noUiSlider ("+ct+"): 'range' contains invalid value.");if(!d(l="min"===l?0:"max"===l?100:parseFloat(l))||!d(c[0]))throw new Error("noUiSlider ("+ct+"): 'range' value isn't numeric.");h.xPct.push(l),h.xVal.push(c[0]),l?h.xSteps.push(!isNaN(c[1])&&c[1]):isNaN(c[1])||(h.xSteps[0]=c[1]),h.xHighestCompleteStep.push(0)}for(this.xNumSteps=this.xSteps.slice(0),n=0;n<this.xNumSteps.length;n++)r=n,a=this.xNumSteps[n],s=this,a&&(s.xVal[r]!==s.xVal[r+1]?(s.xSteps[r]=p([s.xVal[r],s.xVal[r+1]],a)/u(s.xPct[r],s.xPct[r+1]),a=(s.xVal[r+1]-s.xVal[r])/s.xNumSteps[r],a=Math.ceil(Number(a.toFixed(3))-1),a=s.xVal[r]+s.xNumSteps[r]*a,s.xHighestCompleteStep[r]=a):s.xSteps[r]=s.xHighestCompleteStep[r]=s.xVal[r])}i.prototype.getMargin=function(t){var e=this.xNumSteps[0];if(e&&t/e%1!=0)throw new Error("noUiSlider ("+ct+"): 'limit', 'margin' and 'padding' must be divisible by step.");return 2===this.xPct.length&&p(this.xVal,t)},i.prototype.toStepping=function(t){var e=this.xVal,i=this.xPct;if(t>=e.slice(-1)[0])return 100;var n=o(t,e),r=e[n-1],e=e[n],a=i[n-1],i=i[n];return a+(n=t,p(t=[r,e],t[0]<0?n+Math.abs(t[0]):n-t[0])/u(a,i))},i.prototype.fromStepping=function(t){var e=this.xVal,i=this.xPct;if(100<=t)return e.slice(-1)[0];var n=o(t,i),r=e[n-1],e=e[n],a=i[n-1],r=[r,e];return(t-a)*u(a,i[n])*(r[1]-r[0])/100+r[0]},i.prototype.getStep=function(t){var e=this.xPct,i=this.xSteps,n=this.snap;if(100===t)return t;var r=o(t,e),a=e[r-1],s=e[r];return n?(s-a)/2<t-a?s:a:i[r-1]?e[r-1]+(n=t-e[r-1],s=i[r-1],Math.round(n/s)*s):t},i.prototype.getDefaultStep=function(t,e,i){var n=o(t,this.xPct);return(100===t||e&&t===this.xPct[n-1])&&(n=Math.max(n-1,1)),(this.xVal[n]-this.xVal[n-1])/i},i.prototype.getNearbySteps=function(t){t=o(t,this.xPct);return{stepBefore:{startValue:this.xVal[t-2],step:this.xNumSteps[t-2],highestStep:this.xHighestCompleteStep[t-2]},thisStep:{startValue:this.xVal[t-1],step:this.xNumSteps[t-1],highestStep:this.xHighestCompleteStep[t-1]},stepAfter:{startValue:this.xVal[t],step:this.xNumSteps[t],highestStep:this.xHighestCompleteStep[t]}}},i.prototype.countStepDecimals=function(){var t=this.xNumSteps.map(e);return Math.max.apply(null,t)},i.prototype.convert=function(t){return this.getStep(this.toStepping(t))};var l={to:function(t){return void 0!==t&&t.toFixed(2)},from:Number},c={target:"target",base:"base",origin:"origin",handle:"handle",handleLower:"handle-lower",handleUpper:"handle-upper",touchArea:"touch-area",horizontal:"horizontal",vertical:"vertical",background:"background",connect:"connect",connects:"connects",ltr:"ltr",rtl:"rtl",textDirectionLtr:"txt-dir-ltr",textDirectionRtl:"txt-dir-rtl",draggable:"draggable",drag:"state-drag",tap:"state-tap",active:"active",tooltip:"tooltip",pips:"pips",pipsHorizontal:"pips-horizontal",pipsVertical:"pips-vertical",marker:"marker",markerHorizontal:"marker-horizontal",markerVertical:"marker-vertical",markerNormal:"marker-normal",markerLarge:"marker-large",markerSub:"marker-sub",value:"value",valueHorizontal:"value-horizontal",valueVertical:"value-vertical",valueNormal:"value-normal",valueLarge:"value-large",valueSub:"value-sub"};function n(t){if("object"!=typeof t||"function"!=typeof t.to||"function"!=typeof t.from)throw new Error("noUiSlider ("+ct+"): 'format' requires 'to' and 'from' methods.")}function h(t,e){if(!d(e))throw new Error("noUiSlider ("+ct+"): 'step' is not numeric.");t.singleStep=e}function g(t,e){if("object"!=typeof e||Array.isArray(e))throw new Error("noUiSlider ("+ct+"): 'range' is not an object.");if(void 0===e.min||void 0===e.max)throw new Error("noUiSlider ("+ct+"): Missing 'min' or 'max' in 'range'.");if(e.min===e.max)throw new Error("noUiSlider ("+ct+"): 'range' 'min' and 'max' cannot be equal.");t.spectrum=new i(e,t.snap,t.singleStep)}function f(t,e){if(e=gt(e),!Array.isArray(e)||!e.length)throw new Error("noUiSlider ("+ct+"): 'start' option is incorrect.");t.handles=e.length,t.start=e}function m(t,e){if("boolean"!=typeof(t.snap=e))throw new Error("noUiSlider ("+ct+"): 'snap' option must be a boolean.")}function _(t,e){if("boolean"!=typeof(t.animate=e))throw new Error("noUiSlider ("+ct+"): 'animate' option must be a boolean.")}function v(t,e){if("number"!=typeof(t.animationDuration=e))throw new Error("noUiSlider ("+ct+"): 'animationDuration' option must be a number.")}function y(t,e){var i,n=[!1];if("lower"===e?e=[!0,!1]:"upper"===e&&(e=[!1,!0]),!0===e||!1===e){for(i=1;i<t.handles;i++)n.push(e);n.push(!1)}else{if(!Array.isArray(e)||!e.length||e.length!==t.handles+1)throw new Error("noUiSlider ("+ct+"): 'connect' option doesn't match handle count.");n=e}t.connect=n}function b(t,e){switch(e){case"horizontal":t.ort=0;break;case"vertical":t.ort=1;break;default:throw new Error("noUiSlider ("+ct+"): 'orientation' option is invalid.")}}function C(t,e){if(!d(e))throw new Error("noUiSlider ("+ct+"): 'margin' option must be numeric.");if(0!==e&&(t.margin=t.spectrum.getMargin(e),!t.margin))throw new Error("noUiSlider ("+ct+"): 'margin' option is only supported on linear sliders.")}function x(t,e){if(!d(e))throw new Error("noUiSlider ("+ct+"): 'limit' option must be numeric.");if(t.limit=t.spectrum.getMargin(e),!t.limit||t.handles<2)throw new Error("noUiSlider ("+ct+"): 'limit' option is only supported on linear sliders with 2 or more handles.")}function w(t,e){if(!d(e)&&!Array.isArray(e))throw new Error("noUiSlider ("+ct+"): 'padding' option must be numeric or array of exactly 2 numbers.");if(Array.isArray(e)&&2!==e.length&&!d(e[0])&&!d(e[1]))throw new Error("noUiSlider ("+ct+"): 'padding' option must be numeric or array of exactly 2 numbers.");if(0!==e){if(Array.isArray(e)||(e=[e,e]),!(t.padding=[t.spectrum.getMargin(e[0]),t.spectrum.getMargin(e[1])])===t.padding[0]||!1===t.padding[1])throw new Error("noUiSlider ("+ct+"): 'padding' option is only supported on linear sliders.");if(t.padding[0]<0||t.padding[1]<0)throw new Error("noUiSlider ("+ct+"): 'padding' option must be a positive number(s).");if(100<t.padding[0]+t.padding[1])throw new Error("noUiSlider ("+ct+"): 'padding' option must not exceed 100% of the range.")}}function S(t,e){switch(e){case"ltr":t.dir=0;break;case"rtl":t.dir=1;break;default:throw new Error("noUiSlider ("+ct+"): 'direction' option was not recognized.")}}function M(t,e){if("string"!=typeof e)throw new Error("noUiSlider ("+ct+"): 'behaviour' must be a string containing options.");var i=0<=e.indexOf("tap"),n=0<=e.indexOf("drag"),r=0<=e.indexOf("fixed"),a=0<=e.indexOf("snap"),s=0<=e.indexOf("hover"),e=0<=e.indexOf("unconstrained");if(r){if(2!==t.handles)throw new Error("noUiSlider ("+ct+"): 'fixed' behaviour must be used with 2 handles");C(t,t.start[1]-t.start[0])}if(e&&(t.margin||t.limit))throw new Error("noUiSlider ("+ct+"): 'unconstrained' behaviour cannot be used with margin or limit");t.events={tap:i||a,drag:n,fixed:r,snap:a,hover:s,unconstrained:e}}function O(t,e){if(!1!==e)if(!0===e){t.tooltips=[];for(var i=0;i<t.handles;i++)t.tooltips.push(!0)}else{if(t.tooltips=gt(e),t.tooltips.length!==t.handles)throw new Error("noUiSlider ("+ct+"): must pass a formatter for all handles.");t.tooltips.forEach(function(t){if("boolean"!=typeof t&&("object"!=typeof t||"function"!=typeof t.to))throw new Error("noUiSlider ("+ct+"): 'tooltips' must be passed a formatter or 'false'.")})}}function G(t,e){n(t.ariaFormat=e)}function I(t,e){n(t.format=e)}function T(t,e){if("boolean"!=typeof(t.keyboardSupport=e))throw new Error("noUiSlider ("+ct+"): 'keyboardSupport' option must be a boolean.")}function A(t,e){t.documentElement=e}function P(t,e){if("string"!=typeof e&&!1!==e)throw new Error("noUiSlider ("+ct+"): 'cssPrefix' must be a string or `false`.");t.cssPrefix=e}function D(t,e){if("object"!=typeof e)throw new Error("noUiSlider ("+ct+"): 'cssClasses' must be an object.");if("string"==typeof t.cssPrefix)for(var i in t.cssClasses={},e)e.hasOwnProperty(i)&&(t.cssClasses[i]=t.cssPrefix+e[i]);else t.cssClasses=e}function vt(e){var i={margin:0,limit:0,padding:0,animate:!0,animationDuration:300,ariaFormat:l,format:l},n={step:{r:!1,t:h},start:{r:!0,t:f},connect:{r:!0,t:y},direction:{r:!0,t:S},snap:{r:!1,t:m},animate:{r:!1,t:_},animationDuration:{r:!1,t:v},range:{r:!0,t:g},orientation:{r:!1,t:b},margin:{r:!1,t:C},limit:{r:!1,t:x},padding:{r:!1,t:w},behaviour:{r:!0,t:M},ariaFormat:{r:!1,t:G},format:{r:!1,t:I},tooltips:{r:!1,t:O},keyboardSupport:{r:!0,t:T},documentElement:{r:!1,t:A},cssPrefix:{r:!0,t:P},cssClasses:{r:!0,t:D}},r={connect:!1,direction:"ltr",behaviour:"tap",orientation:"horizontal",keyboardSupport:!0,cssPrefix:"noUi-",cssClasses:c},t=(e.format&&!e.ariaFormat&&(e.ariaFormat=e.format),Object.keys(n).forEach(function(t){if(!s(e[t])&&void 0===r[t]){if(n[t].r)throw new Error("noUiSlider ("+ct+"): '"+t+"' is required.");return!0}n[t].t(i,(s(e[t])?e:r)[t])}),i.pips=e.pips,document.createElement("div")),a=void 0!==t.style.msTransform,t=void 0!==t.style.transform;return i.transformRule=t?"transform":a?"msTransform":"webkitTransform",i.style=[["left","top"],["right","bottom"]][i.dir][i.ort],i}function r(t,u,a){var o,s,l,n,c,h,d=window.navigator.pointerEnabled?{start:"pointerdown",move:"pointermove",end:"pointerup"}:window.navigator.msPointerEnabled?{start:"MSPointerDown",move:"MSPointerMove",end:"MSPointerUp"}:{start:"mousedown touchstart",move:"mousemove touchmove",end:"mouseup touchend"},k=window.CSS&&CSS.supports&&CSS.supports("touch-action","none")&&function(){var t=!1;try{var e=Object.defineProperty({},"passive",{get:function(){t=!0}});window.addEventListener("test",null,e)}catch(t){}return t}(),b=t,C=u.spectrum,p=[],g=[],r=[],f=0,m={},_=t.ownerDocument,v=u.documentElement||_.documentElement,y=_.body,F=-1,x=0,w=1,S=2,V="rtl"===_.dir||1===u.ort?0:100;function M(t,e){var i=_.createElement("div");return e&&ft(i,e),t.appendChild(i),i}function i(t,h){var t=M(t,u.cssClasses.origin),e=M(t,u.cssClasses.handle);return M(e,u.cssClasses.touchArea),e.setAttribute("data-handle",h),u.keyboardSupport&&(e.setAttribute("tabindex","0"),e.addEventListener("keydown",function(t){var e=h;if(B()||O(e))return!1;var i=["Left","Right"],n=["Down","Up"],r=["PageDown","PageUp"],a=["Home","End"];u.dir&&!u.ort?i.reverse():u.ort&&!u.dir&&(n.reverse(),r.reverse());var s,o=t.key.replace("Arrow",""),l=o===r[0],r=o===r[1],c=o===n[0]||o===i[0]||l,n=o===n[1]||o===i[1]||r,i=o===a[1];if(!(c||n||o===a[0]||i))return!0;if(t.preventDefault(),n||c){o=c?0:1,a=at(e)[o];if(null===a)return!1;!1===a&&(a=C.getDefaultStep(g[e],c,10)),(r||l)&&(a*=5),a=Math.max(a,1e-7),s=p[e]+(a*=c?-1:1)}else s=i?u.spectrum.xVal[u.spectrum.xVal.length-1]:u.spectrum.xVal[0];return N(e,C.toStepping(s),!0,!0),D("slide",e),D("update",e),D("change",e),D("set",e),!1})),e.setAttribute("role","slider"),e.setAttribute("aria-orientation",u.ort?"vertical":"horizontal"),0===h?ft(e,u.cssClasses.handleLower):h===u.handles-1&&ft(e,u.cssClasses.handleUpper),t}function U(t,e){return!!e&&M(t,u.cssClasses.connect)}function $(t,e){return!!u.tooltips[e]&&M(t.firstChild,u.cssClasses.tooltip)}function B(){return b.hasAttribute("disabled")}function O(t){return o[t].hasAttribute("disabled")}function G(){n&&(Z("update.tooltips"),n.forEach(function(t){t&&ht(t)}),n=null)}function z(){G(),n=o.map($),K("update.tooltips",function(t,e,i){n[e]&&(t=t[e],!0!==u.tooltips[e]&&(t=u.tooltips[e].to(i[e])),n[e].innerHTML=t)})}function j(r,a,s){var o=_.createElement("div"),n=[],l=(n[x]=u.cssClasses.valueNormal,n[w]=u.cssClasses.valueLarge,n[S]=u.cssClasses.valueSub,[]),c=(l[x]=u.cssClasses.markerNormal,l[w]=u.cssClasses.markerLarge,l[S]=u.cssClasses.markerSub,[u.cssClasses.valueHorizontal,u.cssClasses.valueVertical]),h=[u.cssClasses.markerHorizontal,u.cssClasses.markerVertical];function d(t,e){var i=e===u.cssClasses.value;return e+" "+(i?c:h)[u.ort]+" "+(i?n:l)[t]}return ft(o,u.cssClasses.pips),ft(o,0===u.ort?u.cssClasses.pipsHorizontal:u.cssClasses.pipsVertical),Object.keys(r).forEach(function(t){var e,i,n;i=r[e=t][0],t=r[t][1],(t=a?a(i,t):t)!==F&&((n=M(o,!1)).className=d(t,u.cssClasses.marker),n.style[u.style]=e+"%",x<t&&((n=M(o,!1)).className=d(t,u.cssClasses.value),n.setAttribute("data-value",i),n.style[u.style]=e+"%",n.innerHTML=s.to(i)))}),o}function I(){l&&(ht(l),l=null)}function T(t){I();var p,g,f,m,_,v,y,e=t.mode,i=t.density||1,n=t.filter||!1,r=function(t,e,i){if("range"===t||"steps"===t)return C.xVal;if("count"===t){if(e<2)throw new Error("noUiSlider ("+ct+"): 'values' (>= 2) required for mode 'count'.");var n=e-1,r=100/n;for(e=[];n--;)e[n]=n*r;e.push(100),t="positions"}return"positions"===t?e.map(function(t){return C.fromStepping(i?C.getStep(t):t)}):"values"===t?i?e.map(function(t){return C.fromStepping(C.getStep(C.toStepping(t)))}):e:void 0}(e,t.values||!1,t.stepped||!1),r=(p=i,g=e,f=r,m={},i=C.xVal[0],e=C.xVal[C.xVal.length-1],v=_=!1,y=0,(f=f.slice().sort(function(t,e){return t-e}).filter(function(t){return!this[t]&&(this[t]=!0)},{}))[0]!==i&&(f.unshift(i),_=!0),f[f.length-1]!==e&&(f.push(e),v=!0),f.forEach(function(t,e){var i,n,r,a,s,o,l,c,h=f[e+1],d="steps"===g,u=(u=d?C.xNumSteps[e]:u)||h-t;if(!1!==t&&void 0!==h)for(u=Math.max(u,1e-7),i=t;i<=h;i=+(i+u).toFixed(7)){for(o=(s=(r=C.toStepping(i))-y)/p,c=s/(l=Math.round(o)),n=1;n<=l;n+=1)m[(a=y+n*c).toFixed(5)]=[C.fromStepping(a),0];s=-1<f.indexOf(i)?w:d?S:x,!e&&_&&i!==h&&(s=0),i===h&&v||(m[r.toFixed(5)]=[i,s]),y=r}}),m),i=t.format||{to:Math.round};return l=b.appendChild(j(r,n,i))}function H(){var t=R.getBoundingClientRect(),e="offset"+["Width","Height"][u.ort];return 0===u.ort?t.width||R[e]:t.height||R[e]}function A(n,r,a,s){function e(t){return!!(t=function(t,e,i){var n,r=0===t.type.indexOf("touch"),a=0===t.type.indexOf("mouse"),s=0===t.type.indexOf("pointer");if(0===t.type.indexOf("MSPointer")&&(s=!0),r){r=function(t){return t.target===i||i.contains(t.target)||t.target.shadowRoot&&t.target.shadowRoot.contains(i)};if("touchstart"===t.type){var o=Array.prototype.filter.call(t.touches,r);if(1<o.length)return!1;n=o[0].pageX,o=o[0].pageY}else{r=Array.prototype.find.call(t.changedTouches,r);if(!r)return!1;n=r.pageX,o=r.pageY}}return e=e||_t(_),(a||s)&&(n=t.clientX+e.x,o=t.clientY+e.y),t.pageOffset=e,t.points=[n,o],t.cursor=a||s,t}(t,s.pageOffset,s.target||r))&&!(B()&&!s.doNotReject)&&(e=b,i=u.cssClasses.tap,!((e.classList?e.classList.contains(i):new RegExp("\\b"+i+"\\b").test(e.className))&&!s.doNotReject)&&!(n===d.start&&void 0!==t.buttons&&1<t.buttons)&&(!s.hover||!t.buttons)&&(k||t.preventDefault(),t.calcPoint=t.points[u.ort],void a(t,s)));var e,i}var i=[];return n.split(" ").forEach(function(t){r.addEventListener(t,e,!!k&&{passive:!0}),i.push([t,e])}),i}function W(t){var e,i,n=pt(100*(t-(t=R,n=u.ort,e=t.getBoundingClientRect(),i=(t=t.ownerDocument).documentElement,t=_t(t),/webkit.*Chrome.*Mobile/i.test(navigator.userAgent)&&(t.x=0),n?e.top+t.y-i.clientTop:e.left+t.x-i.clientLeft))/H());return u.dir?100-n:n}function X(t,e){"mouseout"===t.type&&"HTML"===t.target.nodeName&&null===t.relatedTarget&&P(t,e)}function Y(t,e){if(-1===navigator.appVersion.indexOf("MSIE 9")&&0===t.buttons&&0!==e.buttonsProperty)return P(t,e);t=(u.dir?-1:1)*(t.calcPoint-e.startCalcPoint);Q(0<t,100*t/e.baseSize,e.locations,e.handleNumbers)}function P(t,e){e.handle&&(mt(e.handle,u.cssClasses.active),--f),e.listeners.forEach(function(t){v.removeEventListener(t[0],t[1])}),0===f&&(mt(b,u.cssClasses.drag),et(),t.cursor&&(y.style.cursor="",y.removeEventListener("selectstart",dt))),e.handleNumbers.forEach(function(t){D("change",t),D("set",t),D("end",t)})}function q(t,e){if(e.handleNumbers.some(O))return!1;1===e.handleNumbers.length&&(a=o[e.handleNumbers[0]].children[0],f+=1,ft(a,u.cssClasses.active)),t.stopPropagation();var i=[],n=A(d.move,v,Y,{target:t.target,handle:a,listeners:i,startCalcPoint:t.calcPoint,baseSize:H(),pageOffset:t.pageOffset,handleNumbers:e.handleNumbers,buttonsProperty:t.buttons,locations:g.slice()}),r=A(d.end,v,P,{target:t.target,handle:a,listeners:i,doNotReject:!0,handleNumbers:e.handleNumbers}),a=A("mouseout",v,X,{target:t.target,handle:a,listeners:i,doNotReject:!0,handleNumbers:e.handleNumbers});i.push.apply(i,n.concat(r,a)),t.cursor&&(y.style.cursor=getComputedStyle(t.target).cursor,1<o.length&&ft(b,u.cssClasses.drag),y.addEventListener("selectstart",dt,!1)),e.handleNumbers.forEach(function(t){D("start",t)})}function K(t,e){m[t]=m[t]||[],m[t].push(e),"update"===t.split(".")[0]&&o.forEach(function(t,e){D("update",e)})}function Z(t){var n=t&&t.split(".")[0],r=n&&t.substring(n.length);Object.keys(m).forEach(function(t){var e=t.split(".")[0],i=t.substring(e.length);n&&n!==e||r&&r!==i||delete m[t]})}function D(i,n,r){Object.keys(m).forEach(function(t){var e=t.split(".")[0];i===e&&m[t].forEach(function(t){t.call(c,p.map(u.format.to),n,p.slice(),r||!1,g.slice(),c)})})}function E(t,e,i,n,r,a){return 1<o.length&&!u.events.unconstrained&&(n&&0<e&&(i=Math.max(i,t[e-1]+u.margin)),r&&e<o.length-1&&(i=Math.min(i,t[e+1]-u.margin))),1<o.length&&u.limit&&(n&&0<e&&(i=Math.min(i,t[e-1]+u.limit)),r&&e<o.length-1&&(i=Math.max(i,t[e+1]-u.limit))),u.padding&&(0===e&&(i=Math.max(i,u.padding[0])),e===o.length-1&&(i=Math.min(i,100-u.padding[1]))),!((i=pt(i=C.getStep(i)))===t[e]&&!a)&&i}function J(t,e){var i=u.ort;return(i?e:t)+", "+(i?t:e)}function Q(t,i,n,e){var r=n.slice(),a=[!t,t],s=[t,!t],o=(e=e.slice(),t&&e.reverse(),1<e.length?e.forEach(function(t,e){e=E(r,t,r[t]+i,a[e],s[e],!1);!1===e?i=0:(i=e-r[t],r[t]=e)}):a=s=[!0],!1);e.forEach(function(t,e){o=N(t,n[t]+i,a[e],s[e])||o}),o&&e.forEach(function(t){D("update",t),D("slide",t)})}function tt(t,e){return u.dir?100-t-e:t}function et(){r.forEach(function(t){var e=50<g[t]?-1:1,e=3+(o.length+e*t);o[t].style.zIndex=e})}function N(t,e,i,n){return!1!==(e=E(g,t,e,i,n,!1))&&(function(t,e){g[t]=e,p[t]=C.fromStepping(e);e="translate("+J(10*(tt(e,0)-V)+"%","0")+")";o[t].style[u.transformRule]=e,it(t),it(t+1)}(t,e),!0)}function it(t){var e,i;s[t]&&(i=100,e="translate("+J(tt(e=(e=0)!==t?g[t-1]:e,i=(i=t!==s.length-1?g[t]:i)-e)+"%","0")+")",i="scale("+J(i/100,"1")+")",s[t].style[u.transformRule]=e+" "+i)}function nt(t,e){return null===t||!1===t||void 0===t?g[e]:("number"==typeof t&&(t=String(t)),t=u.format.from(t),!1===(t=C.toStepping(t))||isNaN(t)?g[e]:t)}function L(t,e){var i=gt(t),t=void 0===g[0];e=void 0===e||!!e,u.animate&&!t&&ut(b,u.cssClasses.tap,u.animationDuration),r.forEach(function(t){N(t,nt(i[t],t),!0,!1)});for(var n=1===r.length?0:1;n<r.length;++n)r.forEach(function(t){N(t,g[t],!0,!0)});et(),r.forEach(function(t){D("update",t),null!==i[t]&&e&&D("set",t)})}function rt(){var t=p.map(u.format.to);return 1===t.length?t[0]:t}function at(t){var e=g[t],i=C.getNearbySteps(e),t=p[t],n=i.thisStep.step,r=null;if(u.snap)return[t-i.stepBefore.startValue||null,i.stepAfter.startValue-t||null];!1!==n&&t+n>i.stepAfter.startValue&&(n=i.stepAfter.startValue-t),r=t>i.thisStep.startValue?i.thisStep.step:!1!==i.stepBefore.step&&t-i.stepBefore.highestStep,100===e?n=null:0===e&&(r=null);t=C.countStepDecimals();return null!==n&&!1!==n&&(n=Number(n.toFixed(t))),[r=null!==r&&!1!==r?Number(r.toFixed(t)):r,n]}ft(t=b,u.cssClasses.target),0===u.dir?ft(t,u.cssClasses.ltr):ft(t,u.cssClasses.rtl),0===u.ort?ft(t,u.cssClasses.horizontal):ft(t,u.cssClasses.vertical),ft(t,"rtl"===getComputedStyle(t).direction?u.cssClasses.textDirectionRtl:u.cssClasses.textDirectionLtr);var R=M(t,u.cssClasses.base),st=u.connect,ot=R,lt=M(ot,u.cssClasses.connects);o=[],(s=[]).push(U(lt,st[0]));for(var e=0;e<u.handles;e++)o.push(i(ot,e)),r[e]=e,s.push(U(lt,st[e+1]));return(h=u.events).fixed||o.forEach(function(t,e){A(d.start,t.children[0],q,{handleNumbers:[e]})}),h.tap&&A(d.start,R,function(t){t.stopPropagation();var r,a,s,e=W(t.calcPoint),i=(r=e,s=!(a=100),o.forEach(function(t,e){var i,n;O(e)||(i=g[e],((n=Math.abs(i-r))<a||n<=a&&i<r||100===n&&100===a)&&(s=e,a=n))}),s);if(!1===i)return!1;u.events.snap||ut(b,u.cssClasses.tap,u.animationDuration),N(i,e,!0,!0),et(),D("slide",i,!0),D("update",i,!0),D("change",i,!0),D("set",i,!0),u.events.snap&&q(t,{handleNumbers:[i]})},{}),h.hover&&A(d.move,R,function(t){var t=W(t.calcPoint),t=C.getStep(t),e=C.fromStepping(t);Object.keys(m).forEach(function(t){"hover"===t.split(".")[0]&&m[t].forEach(function(t){t.call(c,e)})})},{hover:!0}),h.drag&&s.forEach(function(t,e){var i,n,r;!1!==t&&0!==e&&e!==s.length-1&&(i=o[e-1],n=o[e],r=[t],ft(t,u.cssClasses.draggable),h.fixed&&(r.push(i.children[0]),r.push(n.children[0])),r.forEach(function(t){A(d.start,t,q,{handles:[i,n],handleNumbers:[e-1,e]})}))}),L(u.start),u.pips&&T(u.pips),u.tooltips&&z(),K("update",function(t,e,a,i,s){r.forEach(function(t){var e=o[t],i=E(g,t,0,!0,!0,!0),n=E(g,t,100,!0,!0,!0),r=s[t],t=u.ariaFormat.to(a[t]),i=C.fromStepping(i).toFixed(1),n=C.fromStepping(n).toFixed(1),r=C.fromStepping(r).toFixed(1);e.children[0].setAttribute("aria-valuemin",i),e.children[0].setAttribute("aria-valuemax",n),e.children[0].setAttribute("aria-valuenow",r),e.children[0].setAttribute("aria-valuetext",t)})}),c={destroy:function(){for(var t in u.cssClasses)u.cssClasses.hasOwnProperty(t)&&mt(b,u.cssClasses[t]);for(;b.firstChild;)b.removeChild(b.firstChild);delete b.noUiSlider},steps:function(){return r.map(at)},on:K,off:Z,get:rt,set:L,setHandle:function(t,e,i){if(!(0<=(t=Number(t))&&t<r.length))throw new Error("noUiSlider ("+ct+"): invalid handle number, got: "+t);N(t,nt(e,t),!0,!0),D("update",t),i&&D("set",t)},reset:function(t){L(u.start,t)},__moveHandles:function(t,e,i){Q(t,e,g,i)},options:a,updateOptions:function(e,t){var i=rt(),n=["margin","limit","padding","range","animate","snap","step","format","pips","tooltips"],r=(n.forEach(function(t){void 0!==e[t]&&(a[t]=e[t])}),vt(a));n.forEach(function(t){void 0!==e[t]&&(u[t]=r[t])}),C=r.spectrum,u.margin=r.margin,u.limit=r.limit,u.padding=r.padding,u.pips?T(u.pips):I(),(u.tooltips?z:G)(),g=[],L(e.start||i,t)},target:b,removePips:I,removeTooltips:G,getTooltips:function(){return n},getOrigins:function(){return o},pips:T}}return{__spectrum:i,version:ct,cssClasses:c,create:function(t,e){if(!t||!t.nodeName)throw new Error("noUiSlider ("+ct+"): create requires a single element, got: "+t);if(t.noUiSlider)throw new Error("noUiSlider ("+ct+"): Slider was already initialized.");e=r(t,vt(e),e);return t.noUiSlider=e}}}),!function(){var e={_lang:GCO5._lang,_nextID:0,core:{},model:{geom:{},maps:{},indics:{},dashboard:{}},view:{component:{},display:{},mediator:{}},API:{},browser:{},event:{},transitions:{},AppConstants:{STARTUP:"startup",INIT_COMPONENT:"initComponent",ON_RESIZE:"resize",BEFORE_PRINT:"beforePrint",POSTROBOT_IN_MSG:"POSTROBOT_IN_MSG"}},t=(GCO5.initInfo&&(e.initInfo=GCO5.initInfo),navigator.userAgent.toLowerCase()),i=(t.indexOf("android 2.3"),e.browser.isAndroid=-1<t.indexOf("android"),e.browser.isIE=-1<t.indexOf("msie")||0<=t.indexOf("trident/")||0<=t.indexOf("edge/"),e.browser.isEdge=0<=t.indexOf("edge/"),e.browser.isFirefox=-1<t.indexOf("firefox"),e.browser.isChrome=!e.browser.isIE&&-1<t.indexOf("chrome"),e.browser.canvasBugged=-1<t.indexOf("android 4.2")||-1<t.indexOf("android 4.1"),e.browser.webkit=-1<t.indexOf("webkit"),e.browser.translate3d=Modernizr.csstransforms3d&&500<$(window).width(),1);void 0!==window.devicePixelRatio&&(i=window.devicePixelRatio),e.browser.dpr=i,e.browser.isIphone=t.match(/(iphone|ipod)/),e.browser.isIOS=t.match(/(iphone|ipod|ipad)/)?1:0,e.browser.isIOSSafari=e.browser.isIOS&&t.match(/(safari)/),e.browser.isTouch="ontouchstart"in window||0<navigator.msMaxTouchPoints,window.addEventListener("touchstart",function t(){e.browser.isTouch=!0,window.removeEventListener("touchstart",t)},!1),e.getUID=function(){return e._nextID++},window.GCO5=e}(),!function(){var a=!1,s=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;GCO5.Class=function(){},GCO5.Class.extend=function(t){var e,r=this.prototype,i=(a=!0,new this);for(e in a=!1,t)i[e]="function"==typeof t[e]&&"function"==typeof r[e]&&s.test(t[e])&&"statics"!=e?function(i,n){return function(){var t=this._super,e=(this._super=r[i],n.apply(this,arguments));return this._super=t,e}}(e,t[e]):t[e];function n(){!a&&this.initialize&&this.initialize.apply(this,arguments)}return((n.prototype=i).constructor=n).extend=arguments.callee,t.statics&&(GCO5.core.GcObjectUtil.extend(n,t.statics),delete t.statics),n}}(),GCO5.core.GcObjectUtil={extend:function(i){return Array.prototype.slice.call(arguments,1).forEach(function(t){if(t)for(var e in t)t.hasOwnProperty(e)&&(i[e]=t[e])}),i},copyProps:function(t,e,i){for(var n in i){n=i[n];t.hasOwnProperty(n)&&(e[n]=t[n])}return e},defaults:function(i){return Array.prototype.slice.call(arguments,1).forEach(function(t){if(t)for(var e in t)t.hasOwnProperty(e)&&null==i[e]&&(i[e]=t[e])}),i},clean:function(t){return GCO5.core.GcObjectUtil.castToNumbers(t),GCO5.core.GcObjectUtil.trimStrings(t),t},equal:function(t,e){var i,n=GCO5.core.GcObjectUtil.count(t),r=GCO5.core.GcObjectUtil.count(e);if(!e||n!=r)return!1;for(i in t)if(t[i]!==e[i])return!1;return!0},castToNumbers:function(t){for(var e in t)GCO5.core.GcMathUtil.isNumber(t[e])&&(t[e]=Number(t[e]));return t},trimStrings:function(t){for(var e in t){var i=t[e];Array.isArray(i)||GCO5.core.GcMathUtil.isNumber(i)||(t[e]=$.trim(i))}},isTypedArray:function(t){switch(Object.prototype.toString.call(t)){case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Float32Array]":case"[object Float64Array]":return!0}return!1},clone:function(t){return t!==Object(t)?t:Array.isArray(t)?t.slice():this.extend({},t)},cloneJson:function(t){return t!==Object(t)?t:JSON.parse(JSON.stringify(t))},isEmpty:function(t){return null==t||0==GCO5.core.GcObjectUtil.count(t)},count:function(t){var e,i=0;for(e in t)i++;return i},keys:function(t){var e=[];return $.each(t,function(t){e.push(t)}),e},sum:function(t){var e,i=0;for(e in t)i+=t[e];return i},getFirstKey:function(t){for(var e in t)return e;return null},getFirstVal:function(t){var e=GCO5.core.GcObjectUtil.getFirstKey(t);return null!==e?t[e]:null},getSVGComputedTextLength:function(t,e){var i=0;if(!e)try{if(0<(i=t?t.getBBox().width:i))return i}catch(t){}var i=$("<svg id='temp' class='"+e+"' ></svg>"),e=$(t),t=e.parent(),n=(i.append(e),$("body").append(i),e[0].getBBox()),n=n?n.width:e[0].getComputedTextLength();return t.append(e),i.remove(),n},getSvgTextMaxWidthInChars:function(t){var i=0;return 0==$(t).children().length?i=$(t).text().length:$(t).children().each(function(t,e){i=e instanceof SVGTSpanElement?Math.max(i,e.textContent.length):Math.max(i,e.length)}),i},getSVGElementBbox:function(t,e){var i=t instanceof SVGTSpanElement,n=i?"<svg id='tempSvg'><text ></text></svg>":"<svg id='tempSvg'></svg>",e=(e&&(n=i?"<svg id='tempSvg' ><text class='"+e+"'></text></svg>":"<svg id='tempSvg' class='"+e+"'></svg>"),$(n)),n=$(t),t=n.parent(),i=((i?$("text",e):e).append(n),$("body").append(e),e.get(0).getBBox());return t.append(n),e.remove(),i},wrapDelims:function(t,s){t.each(function(){var t,e=d3.select(this),i=e.text().split(s).reverse(),n=0,r=e.attr("y"),a=parseFloat(e.attr("dy"));for(e.text(null);t=i.pop();)e.append("tspan").attr("x",0).attr("y",r).attr("dy",1.2*++n+a+"em").text(t)})}},GCO5.core.GcMathUtil={SPECIFIC_VALUE:{NODATA:-9999,NODATA_SPEC:-8888,SECRET:-99999,DIV0:-999999,SECRET_INDUIT:-9999999},isNumber:function(t){if(null==t)return!1;var e=String(t);return"0"===e||("0"!==e.substr(0,1)||"."===e.substr(1,1))&&$.isNumeric(t)},countDecimals:function(t){return Math.floor(t)!==t&&t.toString().split(".")[1].length||0},WGS_to_SMC:function(t,e){var i=360/(2*Math.PI),n=40075016.68/(2*Math.PI);return{x:n*t/i,y:n*Math.log(Math.tan(Math.PI/4+e/(2*i)))}},RGBToHex:function(t,e,i){return GCO5.core.GcMathUtil.binToHex(t<<16|e<<8|i)},binToHex:function(t){return t=parseInt(t),t=t.toString(16).toUpperCase(),"#"+new Array(7-t.length).join("0")+t},toStandardHex:function(t){return(t=(t="0x"==t.substr(0,2)?"#"+t.substr(2):t).replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(t,e,i,n){return"#"+e+e+i+i+n+n})).toUpperCase()},hexToBin:function(t){if("#"!=String(t).substr(0,1)&&"0x"!=String(t).substr(0,2))return t;if("0x"==(t=String(t)).substr(0,2))return parseInt(t);return t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(t,e,i,n){return"#"+e+e+i+i+n+n}),parseInt("0x"+t.substr(1))},binToRGB:function(t){return[t>>16,t>>8&255,255&t]},hexToRGB:function(t){t=GCO5.core.GcMathUtil.hexToBin(t);return GCO5.core.GcMathUtil.binToRGB(t)},alphaFromRgba:function(t){return t.indexOf("rgba")<0&&0<=t.indexOf("rgb")?1:t.replace(/^.*,(.+)\)/,"$1")},rgba2hex:function(t){return(t=t.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i))&&4===t.length?"#"+("0"+parseInt(t[1],10).toString(16)).slice(-2)+("0"+parseInt(t[2],10).toString(16)).slice(-2)+("0"+parseInt(t[3],10).toString(16)).slice(-2):""},hexToRGBAString:function(t,e){9==t.length&&(e=parseInt(t.substr(-2),16)/255,t=t.substring(0,t.length-2));var i=GCO5.core.GcMathUtil.hexToRGB(t);return 7==t.length&&void 0===e?"rgb("+i.join(",")+")":"rgba("+i.join(",")+(e?","+e:"")+")"},decalTf:function(t,e){t=GCO5.core.GcMathUtil.hexToBin(t);e=(e=isNaN(e)?100:e)/100;return GCO5.core.GcMathUtil.binToHex(e*(t>>16)<<16|e*(t>>8&255)<<8|e*(255&t))},isGray:function(t){var e=(t=GCO5.core.GcMathUtil.hexToBin(t))>>8&255;return(t>>16&255)==e&&e==(255&t)},adjustBrightness2:function(t,e){var i,n,r;return 0==e?GCO5.core.GcMathUtil.hexToBin(t):(t=GCO5.core.GcMathUtil.hexToBin(t),r=e<0?(i=(t>>16&255)*(e=(100+e)/100),n=(t>>8&255)*e,(255&t)*e):(i=t>>16&255,n=t>>8&255,r=255&t,i+=(255-i)*(e/=100),n+=(255-n)*e,r+=(255-r)*e,i=Math.min(i,255),n=Math.min(n,255),Math.min(r,255)),i<<16|n<<8|r)},isRoughlyEqual:function(t,e,i){return null==i&&(i=.01),t==e||(0==e?Math.abs(t)<i:Math.abs((t-e)/e)<i)},isInvalid:function(t){return GCO5.core.GcMathUtil.isSpecificValue(t)||!$.isNumeric(t)},isNumericInvalid:function(t){return GCO5.core.GcMathUtil.isSpecificValue(t)},isSpecificValue:function(t){t=parseFloat(t);return-1<Object.keys(GCO5.core.GcMathUtil.SPECIFIC_VALUE).map(function(t){return GCO5.core.GcMathUtil.SPECIFIC_VALUE[t]}).indexOf(t)},isSecret:function(t){return t==GCO5.core.GcMathUtil.SPECIFIC_VALUE.SECRET||t==GCO5.core.GcMathUtil.SPECIFIC_VALUE.SECRET_INDUIT},getSimpleHaltonSequenceb2:function(t,e){null==e&&(e=2);var i=new Array(t);if(2==e)for(var n=0;n<t;n++)i[n]=GCO5.core.GcMathUtil.halton_base2(n+1);else for(n=0;n<t;n++)i[n]=GCO5.core.GcMathUtil.halton_base3(n+1);return i},halton_base2:function(t){for(var e=0,i=.5;0!=t;){var n=t%2;e+=i*n,t=(t-n)/2,i*=.5}return e},halton_base3:function(t){for(var e=0,i=.3333333333;0!=t;){var n=t%3;e+=i*n,t=(t-n)/3,i*=.3333333333}return e},getD3VividColor:function(t){for(var e,i,n=[],r=0;r<t.length;r++)0==r&&1<t.length&&GCO5.core.GcMathUtil.isGray(t[r])||(i=d3.rgb(t[r]),e=d3.hsl(i),a=(i.r+i.g+i.b)/765,i=e.s,e.l,n.push({col:t[r],score:i,hsl:e,m:a}));n.sort(function(t,e){return t.score-e.score}),e=n[0].hsl;var a=n[0].m,s=d3.rgb(e),s=s.r<<16|s.g<<8|s.b,o=GCO5.core.GcMathUtil.binToHex(s);return.6<a&&(s=GCO5.core.GcMathUtil.adjustBrightness2(o,100*(.6-a))),GCO5.core.GcMathUtil.binToHex(s)},parseHexString:function(t){for(var e=t.length/2,i=new Uint8Array(e),n=0;2<=t.length;)i[n++]=parseInt(t.substring(0,2),16),t=t.substring(2,t.length);return i},getDistanceFromLatLonInM:function(t,e,i,n){var r=360/(2*Math.PI),a=(i-t)/r,n=(n-e)/r,e=Math.sin(a/2)*Math.sin(a/2)+Math.cos(t/r)*Math.cos(i/r)*Math.sin(n/2)*Math.sin(n/2);return 6371e3*(2*Math.atan2(Math.sqrt(e),Math.sqrt(1-e)))}},GCO5.core.GcBitmapUtil={alphaRatio:function(t,e,i){for(var n=0,r=t.getImageData(0,0,t.canvas.width,t.canvas.height).data,a=r.length,s=3;s<a;s+=4)0<r[s]&&n++;return e?n:n/(t.canvas.width*t.canvas.height)},alphaBbox:function(t){for(var e=t.canvas.width,i=t.canvas.height,t=t.getImageData(0,0,t.canvas.width,t.canvas.height).data,n=new Uint32Array(t.buffer),r=e,a=i,s=0,o=0,l=0;l<i;l++)for(var c=0;c<e;c++)0<n[c+l*e]&&(c<r&&(r=c),l<a&&(a=l),s<c&&(s=c),o<l&&(o=l));return new GCO5.model.geom.Rectangle(r,a,s-r,o-a)},isImage:function(t){return t instanceof HTMLImageElement||t instanceof HTMLCanvasElement},isCanvas:function(t){return t instanceof HTMLCanvasElement},createCanvas:function(t,e,i){var n=document.createElement("canvas");return n.width=i?i.width:t,n.height=i?i.height:e,n},debugCanvas:function(t,e){var i=new Image;i.src=t.toDataURL(),i.width=t.width,i.height=t.height,(250<GCO5.core.GcDelayUtil.curFrame()||e)&&$("#mapSection").append($(i).css("position","fixed"))},cloneCanvas:function(t,e){e?GCO5.core.GcBitmapUtil.clearAndResetCanvas(e):e=document.createElement("canvas");var i=e.getContext("2d");return e.width=t.width,e.height=t.height,i.drawImage(t,0,0),e},dropCanvas:function(t){t&&(t.width=t.height=1)},clearCanvas:function(t){var e=t.getContext("2d");e.save(),GCO5.core.GcBitmapUtil.clearAndResetCanvas(t),e.restore()},clearAndResetCanvas:function(t){var e=t.getContext("2d");e.globalCompositeOperation="source-over",e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,t.width,t.height)},exportCanvas:function(t,e,i){var n;navigator.msSaveBlob?window.navigator.msSaveBlob(t.msToBlob(),e):(GCO5.browser.isIOS?(localStorage.expimg=t.toDataURL(),(n=document.createElement("a")).href="GC_exportImg.php?lang="+GCO5.appModel.getLang()+"&fmt=png&ios="+GCO5.browser.isIOS):(t=t.toDataURL(),(n=document.createElement("a")).download=e,n.href=t),i&&(n.target="_blank"),document.body.appendChild(n),n.click()),GCO5.core.GcDelayUtil.callLater(function(){document.body.removeChild(n)},[],50,this)},downScaleCanvas:function(t,e){for(var i=t,n=1;e<.5*n;)n*=.5,i=this._stepDown(i,.5);return i},_stepDown:function(t,e){var i=document.createElement("canvas"),n=i.getContext("2d");return i.width=t.width*e+1,i.height=t.height*e+1,n.scale(e,e),n.drawImage(t,0,0),i},drawEndArrow:function(t,e,i,n){i=i||new GCO5.model.geom.Point(0,0),n=n||6;var r=180*Math.atan2(e.y-i.y,e.x-i.x)/Math.PI,a=e.x,e=e.y,a=.5*(a+i.x),e=.5*(e+i.y),i=n/2;t.moveTo(a-n*Math.cos((r-25)*Math.PI/180),e-n*Math.sin((r-25)*Math.PI/180)),t.lineTo(a+i*Math.cos(r*Math.PI/180),e+i*Math.sin(r*Math.PI/180)),t.lineTo(a-n*Math.cos((25+r)*Math.PI/180),e-n*Math.sin((25+r)*Math.PI/180))}},GCO5.core.ColorThief={REF_X:95.047,REF_Y:100,REF_Z:108.883,col64Arrays:null,reduceColoursObject:function(t){t=t||16;for(var e=new Array(256),i=256/(t/3),n=0;n<256;n++)e[n]=Math.floor(n/i)*i;return{b:e}},getIndexedColors:function(t,e){for(var i,n,r,a,s,o=this.reduceColoursObject64(),l=(e=e||5,{}),c=[],h=t.getContext("2d").getImageData(0,0,t.width,t.height).data,d=t.width*t.height,u=0;u<d;u+=e)i=4*u,n=o.b[h[i++]],r=o.b[h[i++]],a=o.b[h[i++]],125<=h[i]&&(n<250||r<250||a<250)&&(l[i=n<<16|r<<8|a]?l[i]++:l[i]=1,0);for(s in l)c.push({col:s,eft:l[s]});c.sort(function(t,e){return e.eft-t.eft});for(var p=0,g=[],f=c.length,u=0;u<f;u++){var m=GCO5.core.GcMathUtil.binToHex(c[u].col);GCO5.core.GcMathUtil.isGray(m)||(p+=c[u].eft,c[u].strCol=m,g.push(c[u]))}f=g.length;for(u=0;u<f;u++)g[u].pct=g[u].eft/p;return g},reduceColoursObject64:function(){return this.col64Arrays||(this.col64Arrays=this.reduceColoursObject(64)),this.col64Arrays},getMostContrastedColor:function(t,e,i,n,r){var a=t.length,s=e.length,o=[],l=i.length,c=(r=r||(1==l?70:50),1),h=1,d=0;n&&2==n.length&&(c=n[0],d=(h=n[1])<c?1:-1);for(var u=0;u<s;u++){if(o.push({id:u,score1:0,score2:0,score:0,col:e[u].col}),Array.isArray(e[u].col)){var p=GCO5.core.GcMathUtil.adjustBrightness2(e[u].col[0],10),g=GCO5.core.GcMathUtil.adjustBrightness2(e[u].col[1],10);if(GCO5.core.GcMathUtil.isGray(g))continue}else p=GCO5.core.GcMathUtil.adjustBrightness2(e[u].col,10);if(!GCO5.core.GcMathUtil.isGray(p))for(var f=0;f<a;f++)GCO5.core.GcMathUtil.isGray(t[f].col)||(o[u].score1+=this.diff(t[f].col,p)*t[f].pct,2==l&&(o[u].score2+=this.diff(t[f].col,g)*t[f].pct),o[u].score=o[u].score1,2==l&&(o[u].score=c*o[u].score1+h*o[u].score2))}if(o.sort(function(t,e){return e.score-t.score}),2==l){for(var m,u=0;u<o.length;u++){var _=o[u].score1/o[u].score,v=o[u].score2/o[u].score,y=Math.abs(o[u].score1-o[u].score2);if(30<o[u].score1&&30<o[u].score2&&(c<.3||h<.3||y/o[u].score<.25)){o[u].score1,o[u].score2,m=o[u].col;break}}if(!m){for(console.log("FAIL"),u=0;u<o.length;u++)if(_=o[u].score1/o[u].score,v=o[u].score2/o[u].score,40<o[u].score&&0<=d*(_-v)){m=o[u].col;break}m=o[u=m?u:0].col,o[u].score1,o[u].score2}for(var b=GCO5.core.GcMathUtil.adjustBrightness2(i[0],10),C=GCO5.core.GcMathUtil.adjustBrightness2(i[1],10),f=0;f<a;f++)this.diff(t[f].col,b),t[f].pct,this.diff(t[f].col,C),t[f].pct;return m}if(1==l){for(u=0;u<s;u++){var x=e[o[u].id];o[u].col=x.col,o[u].lib=x.lib}var n=o[0].col,w=o[0].score,S=0,M=GCO5.core.GcMathUtil.adjustBrightness2(i[0],10);for(f=0;f<a;f++)GCO5.core.GcMathUtil.isGray(t[f].col)||(S+=this.diff(t[f].col,M)*t[f].pct);return[r<w&&7<w-S?n:i[0]]}},diff:function(t,e){var i=e>>16&255,n=e>>8&255,e=255&e,t=this.rgb2lab(t>>16&255,t>>8&255,255&t),i=this.rgb2lab(i,n,e);return Math.sqrt((i.l-t.l)*(i.l-t.l)+(i.a-t.a)*(i.a-t.a)+(i.b-t.b)*(i.b-t.b))},rgb2lab:function(t,e,i){t=this.rgb2xyz(t,e,i);return this.xyz2lab(t.x,t.y,t.z)},rgb2xyz:function(t,e,i){var t=t/255,e=e/255,i=i/255,n=(.04045<t?t=Math.pow((t+.055)/1.055,2.4):t/=12.92,.04045<e?e=Math.pow((e+.055)/1.055,2.4):e/=12.92,.04045<i?i=Math.pow((i+.055)/1.055,2.4):i/=12.92,{x:0,y:0,z:0});return n.x=.4124*(t*=100)+.3576*(e*=100)+.1805*(i*=100),n.y=.2126*t+.7152*e+.0722*i,n.z=.0193*t+.1192*e+.9505*i,n},xyz2lab:function(t,e,i){var t=t/this.REF_X,e=e/this.REF_Y,i=i/this.REF_Z,t=.008856<t?Math.pow(t,1/3):7.787*t+16/116,e=.008856<e?Math.pow(e,1/3):7.787*e+16/116,i=.008856<i?Math.pow(i,1/3):7.787*i+16/116,n={l:0,a:0,b:0};return n.l=116*e-16,n.a=500*(t-e),n.b=200*(e-i),n}},GCO5.core.GcStringUtil={trim:function(t){return null==t?t:t.replace(/^\\s*(\\S*(\\s+\\S+)*)\\s*$/,"$1")},toHTmlWithSingleBr:function(t){return t&&t.replace(/[\n\r]/g,"<br>").replace(/(<br>)+/g,"<br>").replace(' " ',' "').replace(' " ','" ')},toHTmlWithBr:function(t){return t=t&&t.replace("<","&lt;").replace(">","&gt;").replace(/[\n\r]/g,"<br>").replace(' " ',' "').replace(' " ','" ')},isEmpty:function(t){if(null==t)return!0;if(!1===t)return!0;t=String(t).trim();return""===t||"null"===t},nullIfEmpty:function(t){return GCO5.core.GcStringUtil.isEmpty(t)?null:t},validColName:function(t){return t=(t=(t=t.replace(/[%#$()\'\"]/g,"")).replace(/[ /,+.*:\-\r\n]/g,"_")).replace(/_+/g,"_"),GCO5.core.GcStringUtil.unaccent(t)},htmlDecode:function(t){return $("<div></div>").html(t).text()},hasOnlyZeros:function(t){return(t=String(t))===GCO5.core.GcStringUtil.spad("",t.length)},proper:function(t,e){return t&&""!=t?t.substr(0,1).toUpperCase()+(e?t.substr(1):t.substr(1).toLowerCase()):""},repeat:function(t,e){for(var i="",n=0;n<e;n++)i+=t;return i},spad:function(t,e){return"00000000000000".substr(0,e-String(t).length)+t},htmlEncode:function(t){if(!t)return t;t=t.split("<").join("&lt;");return t=(t=(t=(t=t.split(">").join("&gt;")).split("\r").join("<br>")).split("\n").join("<br>")).split("&nbsp;").join(" ")},formatNum:function(t,e){e=Math.pow(10,e||5);return Math.round(t*e)/e},hashCode:function(t){var e,i=0,n=t.length;if(0!=n)for(e=0;e<n;e++)i=(i<<5)-i+t.charCodeAt(e),i|=0;return i},hashCode2:function(t){var e,i=0,n=t.length;if(0!=n)for(e=0;e<n;e++)i=(i<<5)-i+t[e],i|=0;return i},unaccent:function(t){return t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.toLowerCase()).replace(new RegExp(/&nbsp;/g)," ")).replace(new RegExp(/\s+/g)," ")).replace(new RegExp(/[àáâãäå]/g),"a")).replace(new RegExp(/æ/g),"ae")).replace(new RegExp(/ç/g),"c")).replace(new RegExp(/[èéêë]/g),"e")).replace(new RegExp(/[ìíîï]/g),"i")).replace(new RegExp(/ñ/g),"n")).replace(new RegExp(/[òóôõö]/g),"o")).replace(new RegExp(/œ/g),"oe")).replace(new RegExp(/[ùúûü]/g),"u")).replace(new RegExp(/[ýÿ]/g),"y")},prettyHTML:function(t,e){return t=t&&(t=(t=(t=(t=e?t.toLowerCase():t).replace(new RegExp(/\n/g),"<br>")).replace(new RegExp(/\r/g),"<br>")).replace(new RegExp(/« /g),"«&nbsp;")).replace(new RegExp(/ »/g),"&nbsp;»")},secondsToHms:function(t){t=Number(t);var e=Math.floor(t/3600),i=Math.floor(t%3600/60),t=Math.floor(t%3600%60);return 0==t&&0==i?e+" h":0==t?(0<e?e+" h ":"")+i+" mn":(0<e?e+" h ":"")+i+" mn "+t+" s"},htmlTableToArray:function(t){var n,r=[],a={},e=GCO5.core.GcLangManager.getInstance().get_delim_mil(),i=GCO5.core.GcLangManager.getInstance().get_delim_dec(),t=$(t.split("&nbsp;").join("").split(e).join("").split(i).join(".")),e=(t.find("p.ui-table-cell-label").remove(),t.find("td.score").remove(),t.find("#score").remove(),t.find("thead > tr").each(function(){var t,e=[],i=$(this).find("th");0<i.length&&(t=0,i.each(function(){2==n&&0==t&&(e.push(""),n=0),e.push($.trim($(this).text())),2==$(this).attr("colspan")&&e.push(""),2==$(this).attr("rowspan")&&(n=2),t++}),r.push(e))}),r.length);return t.find("tbody > tr").each(function(){var t,e=[],i=$(this).find("td, th");0<i.length&&(t=0,i.each(function(){$(this).hasClass("numcol")?e.push($.trim($(this).text()).replace(",",".")):e.push($.trim($(this).text())),a["col"+t]||(a["col"+t]=$(this).hasClass("numcol")?"num":"char"),t++}),r.push(e))}),{bodyData:r,colsdef:a,headerLength:e}}},GCO5.core.GcArrayUtil={CASEINSENSITIVE:1,DESCENDING:2,UNIQUESORT:4,RETURNINDEXEDARRAY:8,NUMERIC:16,indexOfByKey:function(t,e,i,n){if(t)for(var r=t.length,a=0;a<r;++a)if(!n&&t[a][e]==i||n&&t[a][e]===i)return a;return-1},getAttrByKey:function(t,e,i,n){e=GCO5.core.GcArrayUtil.indexOfByKey(t,e,i);return e<0?null:t[e][n]},nest:function(t,e){var i={};return d3.nest().key(function(t){return t[e]}).sortKeys(d3.ascending).entries(t).forEach(function(t){i[t.key]=t.values}),i},deleteItemByKey:function(t,e,i,n){var r,e=GCO5.core.GcArrayUtil.indexOfByKey(t,e,i,n);return r=0<=e?t.splice(e,1)[0]:r},toIndexedObj:function(t,e){if(!t)return null;for(var i,n={},r=t.length,a=0;a<r;a++)n[(i=t[a])[e]]=i;return n},getColumnByKey:function(t,i){return t&&t.reduce(function(t,e){return t.push(e[i]),t},[])},getSubArray:function(t,e,i){var n=[];if(!t)return[];var r=t.length;for(s in e)Array.isArray(e[s])||(e[s]=[e[s]]);for(var a=0;a<r;a++){var s,o=1,l=t[a];for(s in e)(!l.hasOwnProperty(s)||e[s].indexOf(l[s])<0)&&(o=0);for(s in i)l.hasOwnProperty(s)&&("|"+l[s]+"|").indexOf("|"+i[s]+"|")<0&&(o=0);1==o&&n.push(l)}return n},getDistinctValues:function(t){return t.filter(function(t,e,i){return i.indexOf(t)===e})},addUnique:function(t,e){var i=t.indexOf(e);0<=i&&t.splice(i,1),t.push(e)},countDistinctValues:function(t,e,i){var n,r={},a=[],s=t.length;e=e||"key",i=i||"count";for(var o,l=0;l<s;l++)r[n=t[l]]?r[n]++:r[n]=1;for(o in r){var c={};c[e]=o,c[i]=r[o],a.push(c)}return GCO5.core.GcArrayUtil.sortOn(a,[i],[GCO5.core.GcArrayUtil.NUMERIC]),a.reverse(),a},sum:function(t){return t&&0!=t.length?Array.prototype.reduce.call(t,function(t,e){return t+e},0):NaN},min:function(t){return t&&0!=t.length?Array.prototype.reduce.call(t,function(t,e){return t<e?t:e}):NaN},max:function(t){return t&&0!=t.length?Array.prototype.reduce.call(t,function(t,e){return e<t?t:e}):NaN},avg:function(t){var e=t.length;return t&&0!=e?GCO5.core.GcArrayUtil.sum(t)/e:NaN},intersection:function(t,e){return t?t.filter(function(t){return-1<e.indexOf(t)}):null},getUniqueValues:function(t,e,i,n,r){e=e||"S";for(var a,s={},o=[],l=0,c=t.length;l<c;++l)a=i?t[l][i]:t[l],s.hasOwnProperty(""+a)?r&&s[""+a]++:(o.push(a),s[""+a]=1);return n||"S"!=e&&o.sort(function(t,e){return t-e}),r?{a:o,s:s}:o},getQuantilesIndices:function(t,e,i){var n,r=[],a=t/e,s=0;if(i)for(;Math.round(s*a)<t;)r.push(n=Math.round(s*a)),s++;else for(;Math.ceil(s*a)<t;)r.push(n=Math.ceil(s*a)),s++;return n<t-1&&r.push(t),r},getClosestIndex:function(t,e){var i,n,r,a=t.length;if(!(e<t[0])){if(e>=t[a-1])return a-1;for(i=0;i<a-1;i++)if(n=t[i],r=t[i+1],n<=e&&e<r)return e-n<r-e?i:i+1}return 0},getClosestIndiceInfo:function(t,e){(t=t.concat()).sort(function(t,e){return t-e});var i,n=t.length;if(e<=t[0])o=(t[s=0]-e)/t[0]-1;else if(e>=t[n-1])o=(e-t[s=n-1])/t[n-1]-1;else for(i=0;i<n-1;i++)if(e>=t[i]&&e<t[i+1]){var r=t[i+1]-t[i],a=(e-t[i])/r,r=(t[i+1]-e)/r,s=a<r?i:i+1,o=a<r?(e-t[i])/t[i]-1:(t[i+1]-e)/t[i+1]-1;break}return{indice:s,closest:t[s],t:void 0,stick:o}},getPositionInfo:function(t,e,i){(t=t.concat()).sort();var n,r,a,s,o,l,c=t.length;if(e<t[0]&&(r=0),e>=t[c-1]&&(r=c),0==(i=i||0)){for(n=0;n<c-1;n++)if(e>t[n]&&e<=t[n+1]){r=n+1;break}}else for(n=0;n<c-1;n++)if(Math.round(i*e)>Math.round(i*t[n])&&Math.round(i*e)<=Math.round(i*t[n+1])){r=n+1;break}return{b1:r,b2:a=r<c-1?r+1:a,t:s=r<c-1&&0<r?(e-t[r-1])/(t[r]-t[r-1]):s,s1:o=0<r?e/t[r-1]:o,s2:l=r<c?e/t[r]:l}},csvToHTML:function(t,e,i,n,r){r=r||1;var a="";if(0<e.length){for(var a="<h1>",s=[],o=0;o<e.length;o++)s.push(e[o].split(t)[0]);a+=s.join("<br>")+"</h1>"}a+="<table><thead><tr>";for(var l=i[0].split(t),c=0;c<l.length;c++)a+="<th style='font-weight:700' class='"+(c<r?"txtleft":"txtright")+"'>"+l[c]+"</th>";a+="</tr></thead><tbody>";for(o=1;o<i.length;o++){a+="<tr>";for(l=i[o].split(t),c=0;c<l.length;c++)a+="<td class='"+(c<r?"txtleft":"txtright")+"'>"+l[c]+"</d>";a+="</tr>"}return a+="</tbody></table>",0<n.length&&(a+="<p class='source'>"+n[0].split(t)[0]+"</p>"),a},sort_fn:function(o,l,t,e){var c=this;return function t(e,i){var n,a,s,r=i[0];return function t(e,i,n){var r=e[0];1<e.length?t(e.slice(1),i[r],n[r]):(a=i[r].toString(),s=n[r].toString())}(e[0].match(/[^.]+/g),o,l),0===(n=r&c.NUMERIC?parseFloat(a)-parseFloat(s):(r&c.CASEINSENSITIVE&&(a=a.toLowerCase(),s=s.toLowerCase()),s<a?1:a<s?-1:0))&&1<e.length?n=t(e.slice(1),i.slice(1)):r&c.DESCENDING&&(n*=-1),n}(t,e)},sortOn:function(t,i,n){function e(t,e){return r.sort_fn(t,e,i,n)}var r=this;if((n=n.length!==i.length?[]:n)[0]&this.RETURNINDEXEDARRAY)return t.slice().sort(e);t.sort(e)},repeat:function(t,e){for(var i=[],n=0;n<e;n++)i.push(t);return i}},GCO5.core.GcDelayUtil={nbFrames:0,metronomeStarted:!1,startFrameCounting:function(){var t;GCO5.core.GcDelayUtil.metronomeStarted||((t=function(){GCO5.core.GcDelayUtil.nbFrames++,GCO5.core.GcDelayUtil.requestAnimFrame.call(window,t)})(),GCO5.core.GcDelayUtil.metronomeStarted=!0)},curFrame:function(){return GCO5.core.GcDelayUtil.nbFrames},setFlagForAWhile:function(t,e,i,n,r){t[e]=i,this.callLater(function(){t[e]=n},[],r,t)},callLater:function(e,i,t,n,r){function a(){var t;r?0<o&&s++>o||(1==(t=r.call(n))?e.apply(n,i):0==t&&GCO5.core.GcDelayUtil.requestAnimFrame.call(window,a)):s++<=o?GCO5.core.GcDelayUtil.requestAnimFrame.call(window,a):e.apply(n,i)}var s=1,o=t;e||console.error("callLater fn",e);a()},callFunctionWhile:function(t,e,i,n,r,a){var s,o=1,l=i;r&&(s=function(){0<l&&o++>l||(1==r.call()?(t&&t.apply(n,e),GCO5.core.GcDelayUtil.requestAnimFrame.call(window,s)):a&&a.apply(n))})()},Quad_easeOut:function(t,e,i,n){return-i*((t=t/n-1)*t*t*t-1)+e},Quad_easeIn:function(t,e,i,n){return i*(t/=n)*t*t*t+e},Quad_easeInOut:function(t,e,i,n){return(t/=n/2)<1?i/2*t*t*t*t+e:-i/2*((t-=2)*t*t*t-2)+e},animate:function(n,r,a,s,o,l,c,h,d,u){var t,p=1,g=(o+=c=c||0,{});for(t in r)g[t]=n[t];d=d||GCO5.core.GcDelayUtil.Quad_easeInOut;function f(){if(p<=o){if(c<=p){if(u&&u.apply(h))return void s.apply(h,l);for(var t in r){var e,i=r[t];$.isFunction(i)?(e=d.apply(this,[p-c,0,1,o-c]),n[t]=i.apply(this,[e])):n[t]=d.apply(this,[p-c,g[t],r[t]-g[t],o-c])}a.apply(h)}p++,GCO5.core.GcDelayUtil.requestAnimFrame.call(window,f)}else s.apply(h,l)}f()},callLaterAfterEventStopped:function(t,e,i,n,r,a,s){null==n&&(n=400);var o=0;return t.on(i,function(t){s&&s.apply(r,[t])&&t.preventDefault(),clearTimeout(o),a&&a.apply(r,[t]);o=setTimeout(function(){e.apply(r,[t])},n)})},requestAnimFrame:window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}},GCO5.core.GcLangManager=GCO5.Class.extend({statics:{NAME:"GCO5.core.GcLangManager",DELIMDEC_NF:{fr:",",en:".",br:",",xx:","},DELIMMIL_NF:{fr:" ",en:",",br:".",xx:" "},DELIMCSV_NF:{fr:";",en:",",br:";",xx:";"},DELIMDEC:{fr:",",en:".",br:",",xx:","},DELIMMIL:{fr:"&nbsp;",en:",",br:".",xx:"&nbsp;"},DELIMCSV:{fr:";",en:",",br:";",xx:";"},TEXT_DIRECTION_LTR:"ltr",TEXT_DIRECTION_RTL:"rtl",instance:null,getInstance:function(){return null==GCO5.core.GcLangManager.instance&&(GCO5.core.GcLangManager.instance=new GCO5.core.GcLangManager),GCO5.core.GcLangManager.instance}},lg:"fr",lastlg:null,bundle:{},newBundles_o:null,initialize:function(){this.textDirection=$("body").css("direction")||GCO5.core.GcLangManager.TEXT_DIRECTION_LTR},getLang:function(){return this.lg},setLang:function(t){this.lastlg=this.lg,this.lastlg||(this.lastlg=t),this.lg=t,window.Intl&&(this.nf=this.nf0=new Intl.NumberFormat([this.lg]),this.nf1=new Intl.NumberFormat([this.lg],{minimumFractionDigits:1}),this.nf2=new Intl.NumberFormat([this.lg],{minimumFractionDigits:2}))},addBundle:function(t,e,i,n){if(this.bundle[e]||(this.bundle[e]={}),this.bundle[e][i]=t,n){var r,a=this.bundle[e].main;for(r in t)for(var s in t[r])a[r]&&a[r][s]&&(a[r][s]=t[r][s])}},getString:function(t,e,i){e=e||"common",i=i||"main";var n=this.bundle[this.lg];return n&&n[i]&&n[i][e]?""+n[i][e][t]:null},get_delim_dec:function(){return GCO5.core.GcLangManager.DELIMDEC[this.lg]||GCO5.core.GcLangManager.DELIMDEC.xx},get_delim_mil:function(){return GCO5.core.GcLangManager.DELIMMIL[this.lg]||GCO5.core.GcLangManager.DELIMMIL.xx},get_delim_mil_raw:function(){return GCO5.core.GcLangManager.DELIMMIL_NF[this.lg]||GCO5.core.GcLangManager.DELIMMIL_NF.xx},get_delim_csv:function(){return GCO5.core.GcLangManager.DELIMCSV[this.lg]||GCO5.core.GcLangManager.DELIMCSV.xx},injectLocaleStrings:function(t){if(!t)return"";for(var e=t.split("##"),i=e.length,n=0;n<i;n++)if(n%2==1)try{var r=e[n].split(".");e[n]=this.getString(r[2],r[1],r[0]).split("\n").join("<br>")}catch(t){console.log("erreur strlang "+e[n])}return e.join("")},formatDate:function(t,e,i){return e=GCO5.core.GcStringUtil.spad(e,2),t=GCO5.core.GcStringUtil.spad(t,2),"en"==this.lg?e+"/"+t+"/"+i:t+"/"+e+"/"+i},formatNumber:function(t,e,i,n,r){if(!$.isNumeric(t))return t;this.lg;var a=this.get_delim_dec(),s=this.get_delim_mil(),t=(t=(t+"").replace(/[^0-9+\-Ee.]/g,""),isFinite(+t)?+t:0),e=isFinite(+e)?Math.abs(e):0,o="";return 3<(o=(e?function(t,e){e=Math.pow(10,e);return""+Math.round(t*e)/e}(t,e):""+Math.round(t)).split("."))[0].length&&!n&&(o[0]=o[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,s)),(o[1]||"").length<e&&(o[1]=o[1]||"",o[1]+=new Array(e-o[1].length+1).join("0")),"-"==o[0].substr(0,1)&&(o[0]="-&nbsp;"+o[0].substr(1)),i?o.join(a).split("&nbsp;").join(" "):o.join(a)},getTextDirection:function(){return this.textDirection||$("body").css("direction")||GCO5.core.GcLangManager.TEXT_DIRECTION_LTR}}),GCO5.core.ClientInfo=GCO5.Class.extend({statics:{NAME:"GCO5.core.ClientInfo",EXPIRE_COOKIE:380,EXPIRE_CONSENT_COOKIE:182,instance:null,getInstance:function(){return null==GCO5.core.ClientInfo.instance&&(GCO5.core.ClientInfo.instance=new GCO5.core.ClientInfo),GCO5.core.ClientInfo.instance}},_session_o:{},lastResizeFrame:0,initialDims:null,_orientationChanging:null,noHashEvent:null,initialize:function(){var e=this;$(window).on("orientationchange",function(t){e._orientationChanging=!0}),GCO5.core.GcDelayUtil.callLaterAfterEventStopped($(window),this._onResize,"resize",300,this),this.deleteCookie("testCookie","/"),this.deleteCookie("cookie_accepted","/"),this._onResize(null,!0),GCO5.browser.isAndroid&&GCO5.core.GcDelayUtil.callLater(this._onResize,[null,!0],20,this)},isInIframe:function(){return $("body").hasClass("iframe")},isSingleBlockReport:function(){var t=this.checkAndCleanState($.deparam.fragment());return void 0!==t.block&&"report"===t.c},purifyHTML:function(t){return t},htmlEncode:function(t){$.views.converters.html(t);return GCO5.core.GcStringUtil.htmlEncode(t)},clearHash:function(t){t=t||["c"];var e,i=$.bbq.getState(),n={};for(e in i)0<=t.indexOf(e)&&(n[e]=i[e]);$.bbq.pushState(n,2)},hideCookieContainer:function(){$(".cookie-notice-container").hide()},deleteCookie:function(t,e,i){this.getCookie(t)&&(document.cookie=t+"="+(e?";Path="+e:"")+(i?";Domain="+i:"")+";expires=Thu, 01-Jan-1970 00:00:01 GMT")},setCookieExpiry13Months:function(t,e,i){var n=new Date;n.setDate(n.getDate()+390),this.getCookie(t)&&(document.cookie=t+"="+this.getCookie(t)+(e?";Path="+e:"")+(i?";Domain="+i:"")+";expires="+n.toUTCString())},dismissCookie:function(){this.setCookie("cookie_optin",0,GCO5.core.ClientInfo.EXPIRE_CONSENT_COOKIE),window.refuseGA&&refuseGA(),this.hideCookieContainer()},acceptCookie:function(){this.setCookie("cookie_optin",1,GCO5.core.ClientInfo.EXPIRE_CONSENT_COOKIE),window.gtag&&window.accepteGA(),window.GCO5.initInfo.AT_KEY&&this.setCookie("at_accepted",1,GCO5.core.ClientInfo.EXPIRE_CONSENT_COOKIE),window.GCO5.initInfo.PIWIK_KEY&&this.setCookie("ma_accepted",1,GCO5.core.ClientInfo.EXPIRE_CONSENT_COOKIE),this.hideCookieContainer()},getCookie:function(t){t=("; "+document.cookie).split("; "+t+"=");return 2!=t.length?void 0:t.pop().split(";").shift()},setCookie:function(t,e,i,n,r){var a=new Date,i=(a.setDate(a.getDate()+(i||365)),[t+"="+e,"expires="+a.toUTCString(),"path="+(r||"/"),"SameSite=Strict"]);GCO5.core.ClientInfo.getInstance().isHttps()&&i.push("Secure"),n&&i.push("domain="+n),document.cookie=i.join(";")},isLargeWidthScreen:function(){var t=GCO5.appModel.breakPoints;return GCO5.browser.width>t.w.large},isMediumWidthScreen:function(){var t=GCO5.appModel.breakPoints;return GCO5.browser.width>t.w.medium},isLargerThanSmallWidthScreen:function(){var t=GCO5.appModel.breakPoints;return GCO5.browser.width>t.w.small},isTinyHeightScreen:function(){GCO5.appModel.breakPoints;return GCO5.browser.height<=500},isTinyWidthScreen:function(){var t=GCO5.appModel.breakPoints;return GCO5.browser.width<=t.w.tiny},isSmallWidthScreen:function(){var t=GCO5.appModel.breakPoints;return GCO5.browser.width<=t.w.small},isWithoutPilotagePanel:function(){return this.isSmallWidthScreen()||this.isInIframe()},isLocalhost:function(){return!1},_onResize:function(t,e){var i=GCO5.core.SystemManager.getInstance();if(!GCO5.browser.isTouch||!i.focusInText()){var n,r=$(window).height(),a=window.innerHeight,s=$(window).width(),a=a||r,o={lastWidth:GCO5.browser.width,lastHeight:GCO5.browser.width,lastOrient:GCO5.browser.orientation};if(o.type=t?t.type:null,o.evt=t,this._orientationChanging&&(o.type="orientationchange",this._orientationChanging=!1),s<=r?(a>=GCO5.browser.portraitHeight&&(GCO5.browser.portraitHeight=a),GCO5.browser.orientation="portrait"):(a>=GCO5.browser.landscapeHeight&&(GCO5.browser.landscapeHeight=a),GCO5.browser.orientation="landscape"),GCO5.browser.width=o.newWidth=s,GCO5.browser.height=o.newHeight=a,"orientationchange"==o.type)GCO5.core.GcDelayUtil.callLater(window.scrollTo,[0,1],5);else if(GCO5.browser.isTouch&&i.panelOpen)return;GCO5.core.GcDelayUtil.curFrame()-this.lastResizeFrame<20||(this.lastResizeFrame=GCO5.core.GcDelayUtil.curFrame(),n=t&&"resize"==t.type,e||n||i.freeze("ON_RESIZE",null,!0),GCO5.core.GcDelayUtil.callLater(function(){GCO5.appModel&&GCO5.appModel.sendNotification?GCO5.appModel.sendNotification(GCO5.AppConstants.ON_RESIZE,o):$(window).trigger("endResize"),e||n||i.unFreeze("ON_RESIZE")},[],10,this),GCO5.browser.initialDims||(GCO5.browser.initialDims={w:GCO5.browser.width,h:GCO5.browser.height}))}},isSafari:function(){return-1!==navigator.userAgent.indexOf("Safari")&&-1===navigator.userAgent.indexOf("Chrome")&&-1===navigator.userAgent.indexOf("Opera")},newLine:function(t){return navigator.userAgent.match(/Windows/)?"\r\n":"\n"},parseUrl:function(t){if("object"===$.type(t))return t;t=/^\s*(((([^:\/#\?]+:)?(?:(\/\/)((?:(([^:@\/#\?]+)(?:\:([^:@\/#\?]+))?)@)?(([^:\/#\?\]\[]+|\[[^\/\]@#?]+\])(?:\:([0-9]+))?))?)?)?((\/?(?:[^\/\?#]+\/+)*)([^\?#]*)))?(\?[^#]+)?)(#.*)?/.exec(t||"")||[];return{href:t[0]||"",hrefNoHash:t[1]||"",hrefNoSearch:t[2]||"",domain:t[3]||"",protocol:t[4]||"",doubleSlash:t[5]||"",authority:t[6]||"",username:t[8]||"",password:t[9]||"",host:t[10]||"",hostname:t[11]||"",port:t[12]||"",pathname:t[13]||"",directory:t[14]||"",filename:t[15]||"",search:t[16]||"",hash:t[17]||""}},getPathInfo:function(){var t=$(location).attr("href"),t=GCO5.core.ClientInfo.getInstance().parseUrl(t);return{origin:t.hostname,appDir:"/"===t.directory?"":t.directory.substr(1,t.directory.length-2),appRoot:t.domain+t.directory,domain:t.domain,getParams:t.search,href:t.href,protocol:t.protocol}},replaceQueryParam:function(t,e,i){var n=new RegExp("([?;&])"+t+"[^&;]*[;&]?"),i=i.replace(n,"$1").replace(/&$/,"");return i.indexOf("?")<0&&(i+="?"),((2<i.length?i+"&":"?")+(e?t+"="+e:"")).replace("?&","?")},removeURLParameter:function(t,e){var i=t.split("?");if(2<=i.length){for(var n=i[1].split("#"),r=encodeURIComponent(e)+"=",a=n[0].split(/[&;]/g),s=a.length;0<s--;)-1!==a[s].lastIndexOf(r,0)&&a.splice(s,1);return i[0]+(0<a.length?"?"+a.join("&"):"")+(n[1]?"#"+n[1]:"")}return t},replaceHashParam:function(t,e,i){var n=new RegExp("([#;&])"+t+"[^&;]*[;&]?"),i=i.replace(n,"$1").replace(/&$/,"");return i.indexOf("#")<0&&(i+="#"),((2<i.length?i+"&":"#")+(e?t+"="+e:"")).replace("#&","#")},getUrlForNewLang:function(t){var e=$(location).attr("href"),e=this.parseUrl(e),i=e.hrefNoHash,e=e.hash;return this.replaceQueryParam("lang",t,i)+e},getUrlWithoutQueryString:function(){return this.parseUrl($(location).attr("href")).hrefNoSearch},getUrlWithoutQueryString2:function(){var t=this.parseUrl($(location).attr("href"));return t.domain+t.directory+t.hash},getUrlWithoutHash:function(){return this.parseUrl($(location).attr("href")).hrefNoHash},isHttps:function(){return"https:"==this.getPathInfo().protocol.toLowerCase()},isValidHashParam:function(t,e){return!!t.toLowerCase().match(/^[0-9a-z.|_\-, ]+$/)&&t},checkAndCleanState:function(t){for(var e in t)if(!1===this.isValidHashParam(t[e]))return{};return t},getAppRoot:function(){return this.getPathInfo().appRoot},getAppDomain:function(){return this.getPathInfo().domain},getAppDir:function(){return this.getPathInfo().appDir},postRobotSend:function(e,t,i){var n,r;postRobot&&(i||(n=GCO5.core.ClientInfo.getInstance().getAppDomain(),i={},r=GCO5.appModel.getOption("reservedAPIDomain"),GCO5.core.GcStringUtil.isEmpty(r)||(i.domain="."==r?n:r)),postRobot.send(window.top,e,t,i).catch(function(t){console.log(t,e)}))},localStorageSupported:function(){try{return localStorage.test=2,!0}catch(t){return!1}},writeToLocalStorage:function(t,e){if(GCO5.core.ClientInfo.getInstance().localStorageSupported()){var i=this.getAppDir()+"/";try{localStorage[i+"_"+t]=e}catch(t){return console.log("error writeToLocalStorage",t),!1}return!0}return!1},readFromLocalStorage:function(t){var e;if(GCO5.core.ClientInfo.getInstance().localStorageSupported())return e=this.getAppDir()+"/",localStorage.getItem(e+"_"+t)},writeToSessionStorage:function(t,e){if(GCO5.core.ClientInfo.getInstance().localStorageSupported()){try{sessionStorage[t]=e}catch(t){return!1}return!0}return this._session_o[t]=e,!1},readFromSessionStorage:function(t){try{if(GCO5.core.ClientInfo.getInstance().localStorageSupported())return sessionStorage[t];if(this._session_o)return this._session_o[t]}catch(t){return}},clearSessionStorage:function(){if(GCO5.core.ClientInfo.getInstance().localStorageSupported())try{sessionStorage.clear()}catch(t){}else this._session_o={}},removeItemFromSessionStorage:function(t){if(GCO5.core.ClientInfo.getInstance().localStorageSupported())try{sessionStorage.removeItem(t)}catch(t){}else this._session_o&&delete this._session_o[t]},submit_post_via_hidden_form:function(t,e){var i,n=$("<form target='_blank' method='POST' style='display:none;'></form>").attr({action:t}).appendTo(document.body);for(i in e)e.hasOwnProperty(i)&&$('<input type="hidden" ></input>').attr({name:i,value:e[i]}).appendTo(n);n.submit(),n.remove()},reloadAndReinit:function(){document.location=this.getAppRoot()},reloadPage:function(t){void 0===t&&(t=20),GCO5.core.GcDelayUtil.callLater(function(){var t=$(location).attr("href"),t=this.parseUrl(t),e=t.hrefNoHash,t=t.hash,e=GCO5.core.ClientInfo.getInstance().replaceQueryParam("redirect",Math.floor(1e5*Math.random()),e);document.location=e+t},[],t,this)},exportBlob:function(t,e,i,n){var r,a,s,o;if("download"in n)Blob&&!GCO5.browser.isIOS?(s=new Blob(["\ufeff"+t],{type:"text/csv"}),a=window.URL.createObjectURL(s),r=!0):a="data:text/csv;base64;charset=utf-8,"+btoa(t);else{if(navigator.msSaveBlob)return s=new Blob(["\ufeff"+t],{type:"text/plain;charset=utf-8;"}),void navigator.msSaveBlob(s,e);GCO5.browser.isIOS&&(o=t.split("\r\n"),GCO5.core.GcLangManager.getInstance().get_delim_csv()),a="data:text/csv;base64,"+btoa(t)}(o=document.createElement("a")).download=e,o.href=a,n&&(o.target="_blank"),document.body.appendChild(o),o.click(),GCO5.core.GcDelayUtil.callLater(function(){document.body.removeChild(o)},[],50,this),r&&GCO5.core.GcDelayUtil.callLater(function(){window.URL.revokeObjectURL(a)},[],20,this)}}),GCO5.core.SystemManager=GCO5.Class.extend({statics:{NAME:"GCO5.core.SystemManager",instance:null,getInstance:function(){var t;return null==GCO5.core.SystemManager.instance&&(t=GCO5.core.SystemManager.instance=new GCO5.core.SystemManager,GCO5.core.GcDelayUtil.startFrameCounting(),GCO5.core.ClientInfo.getInstance(),document.body&&(document.body.onmousedown=function(){t.mouseDown=1},document.body.onmouseup=function(){t.mouseDown=0})),GCO5.core.SystemManager.instance}},frozen:!1,freeze_o:{},time0:(new Date).getTime(),modalWidget:null,panelOpen:!1,popupClosing:!1,printMode:null,activeComponent:{},activePanel:null,component_o:{},historyBrowsing:null,cuState:{},mouseDown:0,isMouseDown:function(){return 1==this.mouseDown},freeze:function(t,e,i){var n=$(".modalFreezeWindow2");n.css("visibility","visible"),e?$(".modalFreezeWindow2-item",n).show().text(e):this.isFrozen()||$(".modalFreezeWindow2-item",n).hide(),this.freeze_o[t]=1},unFreeze:function(t,e){var i;this.freeze_o[t]&&(delete this.freeze_o[t],this.isFrozen()||(i=$(".modalFreezeWindow2"),e=e||0,GCO5.core.GcDelayUtil.callLater(function(){i.css("visibility","hidden"),$(window).scrollTop(0)},[],e)))},setFreezeMsg:function(t){this.isFrozen()&&$(".modalFreezeWindow2-item").show().text(t)},isFrozen:function(){return GCO5.core.GcObjectUtil.count(this.freeze_o)},setPrintMode:function(t){this.printMode=t},getPrintMode:function(t){return this.printMode},registerCuState:function(t,e){this.cuState[t]=e},getCuState:function(t){return this.cuState[t]},setActivePanel:function(t){this.activePanel=t},getActivePanel:function(){return this.activePanel},setActiveComponent:function(t,e){this.component_o[e=e||"main"]||(this.component_o[e]={}),this.activeComponent[e]=t,this.component_o[e][t.getName()]=t},setAppComponent:function(t){this.component_o.main||(this.component_o.main={}),this.component_o.main.app=t},getActiveComponent:function(t){return this.activeComponent[t=t||"main"]},getActiveRenderedComponent:function(t){t=this.activeComponent[t=t||"main"];return t?t.getRenderedContent():null},getComponent:function(t,e){return this.component_o[e=e||"main"][t]},registerHistoryBrowsing:function(){var t=this;this.historyBrowsing=!0,GCO5.core.GcDelayUtil.callLater(function(){t.historyBrowsing=!1},[],2,this)},focusInText:function(){var t=document.activeElement;return 0<=["INPUT","TEXTAREA","SELECT","P"].indexOf(t.tagName.toUpperCase())},freezeAfterPopup:function(){var t=this;this.popupClosing=!0,GCO5.core.GcDelayUtil.callLater(function(){t.popupClosing=!1},[],50,this)},freezeWhile:function(t){GCO5.core.SystemManager.getInstance().freeze("freeze",null,!0),GCO5.core.GcDelayUtil.callLater(GCO5.core.SystemManager.getInstance().unFreeze,["freeze"],50,this)},getTime:function(){return(new Date).getTime()-this.time0},statTrack:function(t,e,i,n,r){var a=GCO5.core.GcLangManager.getInstance().getLang(),s=GCO5.core.ClientInfo.getInstance(),o=GCO5.appModel.getConcept("lang"),l=(s.isInIframe()&&(t+="_api"),""),c="";1<o.length&&(c+=a+"/"),"1"==GCO5.appModel.getOption("structuredByExtent")&&this.getCuState("view")&&(c+=GCO5.appModel.getInfo("infoFromMapName",[this.getCuState("view"),"id_extent"])+"/"),this.getActiveComponent()&&(l=c+=this.getActiveComponent().getShortName()+"/"+t,o="",e&&(o+="/"+e,i&&(o+="/"+i,n&&(o+="/"+n))),window.gtag&&1==s.getCookie("ga_accepted")&&(l+=o,(a=window.GAAcceptConfig||{anonymize_ip:!0,cookie_expires:24*GCO5.core.ClientInfo.EXPIRE_COOKIE*60*60,cookie_update:!1}).page_path=l,gtag("config",GCO5.initInfo.GA_KEY,a)),window._paq&&0!=s.getCookie("ma_accepted")&&(""!=o?_paq.push(["trackEvent",c,o,1]):_paq.push(["trackEvent",c,"init",1])),window._AT_tag&&0!=s.getCookie("at_accepted")&&(t={name:l},e&&(t.chapter1=e,i&&(t.chapter2=i,n&&(t.chapter3=n))),_AT_tag.page.send(t)))}}),GCO5.core.GcD3Util={addD3Attributes:function(t,e){for(var i in e)t.attr(e[i],function(t){return t[e[i]]})},getSVGComputedTextLength:function(t,e){var i=0;if(!e)try{if(0<(i=t?t.getBBox().width:i))return i}catch(t){}var i=$("<svg id='temp' class='"+e+"' ></svg>"),e=$(t),t=e.parent(),n=(i.append(e),$("body").append(i),e[0].getBBox()),n=n?n.width:e[0].getComputedTextLength();return t.append(e),i.remove(),n},getSvgTextMaxWidthInChars:function(t){var i=0;return $(t).children().each(function(t,e){i=e instanceof SVGTSpanElement?Math.max(i,e.textContent.length):Math.max(i,e.length)}),i},getSVGElementBbox:function(t,e){var i=t instanceof SVGTSpanElement,n=i?$("<svg id='tempSvg'><text ></text></svg>"):$("<svg id='tempSvg'></svg>"),e=(e&&(n=i?$("<svg id='tempSvg' class='"+e+"'><text ></text></svg>"):$("<svg id='tempSvg' class='"+e+"'></svg>")),$(t)),t=e.parent(),i=((i?$("text",n):n).append(e),$("body").append(n),n.get(0).getBBox());return t.append(e),n.remove(),i},wrapDelims:function(t,s){t.each(function(){var t,e=d3.select(this),i=e.text().split(s).reverse(),n=0,r=e.attr("y"),a=parseFloat(e.attr("dy"));for(e.text(null);t=i.pop();)e.append("tspan").attr("x",0).attr("y",r).attr("dy",1.2*++n+a+"em").text(t)})},_getMiddleIndice:function(t,e){var i=(t=t.map(function(t){return t+e})).length;if(i<=2)return{id:1,sum1:t[0],sum2:t[2==i?1:0]};for(var n=[],r=1;r<i-1;r++){var a=this._getMaxSumSplittedArray(t,r);n.push({id:r,sum1:a[0],sum2:a[1],maxsum:Math.max(a[0],a[1])})}return n.sort(function(t,e){return t.maxsum-e.maxsum}),n[0]},_getMaxSumSplittedArray:function(t,e){var i=t.slice(0,e),t=t.slice(e);return[GCO5.core.GcArrayUtil.sum(i),GCO5.core.GcArrayUtil.sum(t)]},calculateStarPoints:function(t,e,i,n,r){for(var a=[],s=Math.PI/i,o=-90*Math.PI/180,l=0;l<2*i;l++){var c=0==(1&l)?n:r,h=t+Math.cos(o+l*s)*c,c=e+Math.sin(o+l*s)*c;a.push([h,c])}return a},calculateCrossPoints:function(t,e,i){var n=[],r=i/3;return n.push([t-r,e+r]),n.push([t-r,e+i]),n.push([t+r,e+i]),n.push([t+r,e+r]),n.push([t+i,e+r]),n.push([t+i,e-r]),n.push([t+r,e-r]),n.push([t+r,e-i]),n.push([t-r,e-i]),n.push([t-r,e-r]),n.push([t-i,e-r]),n.push([t-i,e+r]),n.push([t-r,e+r]),n},calculateTrianglePoints:function(t,e,i){var n=[],r=1.732*i*.25;return n.push([t-i/2,e+r]),n.push([t+i/2,e+r]),n.push([t,e-r]),n.push([t-i/2,e+r]),n},calculateLosangePoints:function(t,e,i){var n=[],i=.707*i;return n.push([t-i,e]),n.push([t,e-i]),n.push([t+i,e]),n.push([t,e+i]),n},arrayToSVGPolygon:function(t){for(var e="",i=t.length,n=0;n<i;n++)e+=t[n].join(",")+" ";return e},arrayToCanvasPolygon:function(t,e){e.length;var i=e[0];t.moveTo(i[0],i[1]);for(var n=1;n<e.length;n++)i=e[n],t.lineTo(i[0],i[1]);i=e[0],t.lineTo(i[0],i[1])}},GCO5.core.GcXlsUtil={xlsBoldFormat:{font:{bold:!0,underline:!1},alignment:{}},xlsItalicFormat:{font:{italic:!0,sz:11}},xlsBackgroundFormat:{fill:{fgColor:{rgb:"00E0E0E0"}}},addXlsStringLine:function(t,e,i,n,r,a,s,o){var l,c,h="w"==a;for(c in i){t.e.r=Math.max(t.e.r,+n+1),t.e.c=Math.max(t.e.c,+c+1);var d=XLSX.utils.encode_cell({c:c,r:0+n});null!==i[c]&&(e[d]={v:i[c],t:"s"},"l"==a&&(e[d].l={Target:i[c],Tooltip:i[c]}),h||r?(l={},r&&(l=GCO5.core.GcObjectUtil.clone(GCO5.core.GcXlsUtil.xlsBoldFormat)),h&&(l.alignment={wrapText:"1"}),e[d].s=l):l=null,r&&(e[d].s=GCO5.core.GcObjectUtil.clone(GCO5.core.GcXlsUtil.xlsBoldFormat)),s&&(e[d].s=GCO5.core.GcObjectUtil.clone(GCO5.core.GcXlsUtil.xlsItalicFormat)),o&&(e[d].s=GCO5.core.GcObjectUtil.clone(GCO5.core.GcXlsUtil.xlsBackgroundFormat)),"w"==a&&(e[d].s.alignment={wrapText:"1"}))}return e[d]},saveXlsFile:function(t,e,i){i=i||"xlsx",e=e||"data.xlsx";var n=XLSX.write(t,{bookType:i,bookSST:!1,type:"binary"});GCO5.core.GcDelayUtil.callLater(function(){saveAs(new Blob([function(t){for(var e=new ArrayBuffer(t.length),i=new Uint8Array(e),n=0,r=t.length;n<r;n++)i[n]=255&t.charCodeAt(n);return e}(n)],{type:"application/octet-stream"}),e)},[],5,this)},tableToDp:function(t){var e=[],i=[];return $("thead th",t).each(function(t){e.push($(this).text())}),t.find("tbody tr").each(function(){var e=[];$(this).find("td").each(function(){var t=$(this).contents().filter(function(){return 3===this.nodeType}).text();e.push($.trim(t))}),i.push(e)}),[e].concat(i)},getMetaIndicXls:function(i,t){function e(t){return c.getString(t,"indics")}function n(t){return c.getString(t,"pilotage","indicator")}var r,a,s={},o=-2,l={s:{c:0,r:0},e:{c:0,r:0}},c=GCO5.core.GcLangManager.getInstance(),h=!GCO5.core.GcStringUtil.isEmpty(i.getProp("TJSMention"))&&i.getProp("TJSServer"),d={source:e("SOURCE"),unit:e("UNIT"),descIndicateur:n("INDIC_DESC"),precisions:n("INDIC_PREC"),limitUtil:n("INDIC_LIM_UTIL"),formulaLib:e("INDIC_FORMULA"),URLIndicateur:n("INDIC_KNOW_MORE")},u=(i.isPie()&&(d.VILibs=e("VARS")),i.isVI()&&(d.VILibs=GCO5.core.GcStringUtil.proper(e("CATEGS"))),GCO5.core.GcXlsUtil.addXlsStringLine);for(r in u(l,s,[c.getString("LABEL")],o+=2,!0),u(l,s,[i.getProp("libIndicWithF1",!0,!0)],++o),d)GCO5.core.GcStringUtil.isEmpty(i.getProp(r))||(u(l,s,[d[r]],o+=2,!0),a=i.getProp(r),u(l,s,[a="VILibs"==r?i.isVI()?(a=a.map(function(t,e){return i.getProp("VIMods")[e]+" = "+t})).join("\n"):a.join(", "):a],++o,!1,"URLIndicateur"==r?"l":"w"));i.getProp("hasCI")&&(u(l,s,[e("DATA_PRECISION")],o+=2,!0),u(l,s,[e("VALUES_WITH_CI")],++o,!1)),i.onImportedData()||h||(u(l,s,[c.getString("LINK_MAP_INDIC","indics")],o+=2,!0),u(l,s,[t.getCurrentUrl(i)],++o,!1,"l")),h&&(u(l,s,["Origine TJS"],o+=2,!0),u(l,s,[i.getProp("TJSMention")],++o,!1,"w"),u(l,s,[i.getProp("TJSServerGeoclipURL")],++o,!1,"l")),s["!ref"]=XLSX.utils.encode_range(l);return s["!cols"]=[{wch:100}],s},writeDatasetToSheet:function(t,e,i,n){var r={},a=0,s={s:{c:1e7,r:0},e:{c:0,r:0}},o=GCO5.core.GcXlsUtil.addXlsStringLine;for(g in i)o(s,r,[i[g]],a++,!0);for(g in a++,e)s.s.r=s.e.r=0,s.s.c=s.e.c=g,r[u=XLSX.utils.encode_cell({c:g,r:a})]={v:e[g],t:"s",s:GCO5.core.GcXlsUtil.xlsBoldFormat};for(var l=0,c=t.length;l<c;l++){var h,d,u,p=t[l],g=-1;for(h in p)!n&&(0==h||2<h&&h%2==1)||(g++,s.s.r>l+a&&(s.s.r=l+1+a),s.s.c>g&&(s.s.c=g),null!=(d={v:p[h]}).v&&(u=XLSX.utils.encode_cell({c:g,r:l+1+a}),-9999==d.v||-99999==d.v||-999999==d.v||-9999999==d.v?d.v="NA":"number"==typeof d.v?d.t="n":"boolean"==typeof d.v?d.t="b":d.t="s",r[u]=d))}return s.s.r>l&&(s.s.r=l+1+a),s.e.r<l&&(s.e.r=l+1+a),s.s.c<1e7&&(r["!ref"]=XLSX.utils.encode_range(s)),r}},{}),carrouselsvar={duration:5e3,help:"Accéder aux autres panneaux via les flèches directionnelles, appuyez sur la touche entrée pour vous rendre sur le panneau courant ou appuyez sur la touche supprimer pour annuler ce message."},carrouselssrc={selectedtab:["css/images/notselected.png","css/images/selected.png"],previoustab:["css/images/previousdisabled.png","css/images/previous.png"],nexttab:["css/images/nextdisabled.png","css/images/next.png"]},carrouselstxt={previoustab:["Aucun item précédent","Item précédent"],nexttab:["Aucun item suivant","Item suivant"]};function createCarrousel(i){i.hasAttribute("id")||i.setAttribute("id",getAvailableId("carrousel")),i.addEventListener("click",function(t){for(var e=t.target;-1==["li","button"].indexOf(e.tagName.toLowerCase())&&e!=i;)e=e.parentNode;e!=i&&(e[t=(t=e.matches||e.mozMatchesSelector||e.msMatchesSelector||e.webkitMatchesSelector).name||t.toString().match(/^\s*function\s*(\S*)\s*\(/)[1]]("#"+this.getAttribute("id")+' > ol[role="tablist"] > li[role="tab"]')||e[t]("#"+this.getAttribute("id")+" > p.carrousel-previousitem button, #"+this.getAttribute("id")+" > p.carrousel-nextitem button"))&&this.removeAttribute("data-reverse")},!1);for(var t=document.querySelectorAll("#"+i.getAttribute("id")+" > div"),e=document.createElement("ol"),n=(e.setAttribute("role","tablist"),i.insertBefore(e,i.firstChild),null),r=("true"==i.getAttribute("data-help")&&"false"!=readCookie("carrouselhelp")&&((n=document.createElement("p")).setAttribute("id",i.getAttribute("id")+"-tooltip"),n.setAttribute("role","tooltip"),n.setAttribute("hidden","hidden"),n.appendChild(document.createTextNode(carrouselsvar.help)),e.addEventListener("keydown",deleteCarrouselHelp,!1)),i.getAttribute("data-selectedpanel")),a=("last"==r?r=t.length-1:1<=r&&r<=t.length?r-=1:r=0,document.createElement("div")),s=0;s<t.length;s++){t[s].hasAttribute("id")||t[s].setAttribute("id",getAvailableId("tabpanel"));var o,l=document.createElement("li"),c=(l.setAttribute("false"==i.getAttribute("data-ariacontrols")?"data-controls":"aria-controls",t[s].getAttribute("id")),l.setAttribute("role","tab"),t[s].querySelector('[role="heading"], h1, h2, h3, h4, h5, h6'));if(s==r?(t[s].setAttribute("aria-hidden","false"),l.setAttribute("aria-selected","true"),l.setAttribute("tabindex","0")):(t[s].setAttribute("aria-hidden","true"),l.setAttribute("aria-selected","false"),l.setAttribute("tabindex","-1")),"text"==i.getAttribute("data-tabs")?(l.setAttribute("aria-label",c.textContent),(o=document.createElement("span")).setAttribute("title",l.getAttribute("aria-label")),o.appendChild(document.createTextNode(s+1)),l.appendChild(o)):((o=document.createElement("img")).setAttribute("src",carrouselssrc.selectedtab[s==r?1:0]),o.setAttribute("alt",c.textContent),o.setAttribute("height","24"),o.setAttribute("width","24"),l.appendChild(o)),s!=r)for(var h=t[s].querySelectorAll('a, area, button, input, select, textarea, [contenteditable="true"], [tabindex]'),d=0;d<h.length;d++)h[d].hasAttribute("contenteditable")&&(h[d].setAttribute("data-contenteditable","true"),h[d].removeAttribute("contenteditable")),h[d].hasAttribute("tabindex")?h[d].setAttribute("data-tabindex",h[d].getAttribute("tabindex")):h[d].setAttribute("data-removetabindex","true"),h[d].setAttribute("tabindex","-1");l.setAttribute("id",getAvailableId("tab")),n&&(l.setAttribute("aria-describedby",n.getAttribute("id")),l.addEventListener("mousedown",carrouselHelpTabMouseDown,!1),l.addEventListener("keydown",carrouselHelpTabKeyDown,!1),l.addEventListener("focus",carrouselHelpTabFocus,!1),l.addEventListener("blur",carrouselHelpTabBlur,!1)),l.addEventListener("click",function(t){if("false"==this.getAttribute("aria-selected")){if("false"!=this.parentNode.parentNode.getAttribute("data-navbuttons")){for(var e=this.parentNode.nextSibling;1!=e.nodeType;)e=e.nextSibling;e=e.firstChild,this.previousSibling?(e.removeAttribute("disabled"),o="img"==(o=this.previousSibling.firstChild).tagName.toLowerCase()?o.getAttribute("alt"):o.parentNode.getAttribute("aria-label"),e.firstChild.setAttribute("alt",o+", "+GCO5.core.GcLangManager.getInstance().getString("PREVIOUS").toLowerCase()),e.firstChild.setAttribute("src",carrouselssrc.previoustab[1])):(e.setAttribute("disabled","disabled"),e.firstChild.setAttribute("alt",carrouselstxt.previoustab[0]),e.firstChild.setAttribute("src",carrouselssrc.previoustab[0])),e.firstChild.setAttribute("title",e.firstChild.getAttribute("alt"));var i=(i="tooltip"==(i=this.parentNode.parentNode.lastChild).getAttribute("role")?i.previousSibling:i).firstChild;this.nextSibling?(i.removeAttribute("disabled"),o="img"==(o=this.nextSibling.firstChild).tagName.toLowerCase()?o.getAttribute("alt"):o.parentNode.getAttribute("aria-label"),i.firstChild.setAttribute("alt",o+", "+GCO5.core.GcLangManager.getInstance().getString("NEXT").toLowerCase()),i.firstChild.setAttribute("src",carrouselssrc.nexttab[1])):(i.setAttribute("disabled","disabled"),i.firstChild.setAttribute("alt",carrouselstxt.nexttab[0]),i.firstChild.setAttribute("src",carrouselssrc.nexttab[0])),i.firstChild.setAttribute("title",i.firstChild.getAttribute("alt"))}for(var n=this.parentNode,r=0,a=0;a<n.childNodes.length&&(r++,n.childNodes[a]!=this);a++);for(var s=n.nextSibling;1!=s.nodeType||s.tagName&&"div"!=s.tagName.toLowerCase();)s=s.nextSibling;s.setAttribute("class",n.parentNode.getAttribute("id")+"-"+r);for(var o=this.parentNode.querySelector('[aria-selected="true"]'),i=(n.parentNode.getAttribute("data-tabs")&&"dots"!=n.parentNode.getAttribute("data-tabs")||o.firstChild.setAttribute("src",carrouselssrc.selectedtab[0]),o.setAttribute("aria-selected","false"),o.setAttribute("tabindex","-1"),"false"==this.parentNode.parentNode.getAttribute("data-ariacontrols")?"data-controls":"aria-controls"),o=document.getElementById(o.getAttribute(i)),l=(o.setAttribute("aria-hidden","true"),o.querySelectorAll('a, area, button, input, select, textarea, [contenteditable="true"], [tabindex]')),c=0;c<l.length;c++)l[c].hasAttribute("contenteditable")&&(l[c].setAttribute("data-contenteditable","true"),l[c].removeAttribute("contenteditable")),l[c].hasAttribute("tabindex")?l[c].setAttribute("data-tabindex",l[c].getAttribute("tabindex")):l[c].setAttribute("data-removetabindex","true"),l[c].setAttribute("tabindex","-1");n.parentNode.getAttribute("data-tabs")&&"dots"!=n.parentNode.getAttribute("data-tabs")||this.firstChild.setAttribute("src",carrouselssrc.selectedtab[1]),this.setAttribute("aria-selected","true"),this.setAttribute("tabindex","0");o=document.getElementById(this.getAttribute(i));o.setAttribute("aria-hidden","false");for(l=o.querySelectorAll("[data-tabindex], [data-removetabindex]"),c=0;c<l.length;c++)l[c].hasAttribute("data-contenteditable")&&(l[c].setAttribute("contenteditable","true"),l[c].removeAttribute("data-contenteditable")),l[c].hasAttribute("data-tabindex")?(l[c].setAttribute("tabindex",l[c].getAttribute("data-tabindex")),l[c].removeAttribute("data-tabindex")):(l[c].removeAttribute("data-removetabindex"),l[c].removeAttribute("tabindex"))}},!1),l.addEventListener("keydown",function(t){var e,i;-1<[37,38].indexOf(t.keyCode)?(i=(i=this.previousSibling)||this.parentNode.lastChild,(e=document.createEvent("MouseEvent")).initEvent("click",!0,!0),i.focus(),i.dispatchEvent(e),t.preventDefault()):-1<[39,40].indexOf(t.keyCode)?(i=(i=this.nextSibling)||this.parentNode.firstChild,(e=document.createEvent("MouseEvent")).initEvent("click",!0,!0),i.focus(),i.dispatchEvent(e),t.preventDefault()):13==t.keyCode&&((i=document.getElementById(this.getAttribute(this.hasAttribute("data-controls")?"data-controls":"aria-controls"))).setAttribute("tabindex","-1"),i.focus())},!1),e.appendChild(l),t[s].setAttribute("aria-labelledby",l.getAttribute("id")),t[s].setAttribute("role","tabpanel"),t[s].addEventListener("keydown",function(t){var e,i,n;t.ctrlKey&&-1<[38,33,34].indexOf(t.keyCode)&&(e=document.getElementById(this.getAttribute("aria-labelledby")),38==t.keyCode?e.focus():33==t.keyCode?(i=(i=e.previousSibling)||e.parentNode.lastChild,(n=document.createEvent("MouseEvent")).initEvent("click",!0,!0),i.focus(),i.dispatchEvent(n)):34==t.keyCode&&(i=(i=e.nextSibling)||e.parentNode.firstChild,(n=document.createEvent("MouseEvent")).initEvent("click",!0,!0),i.focus(),i.dispatchEvent(n)),t.preventDefault())},!1),t[s].addEventListener("transitionend",carrouselItemChangeEnd,!1),t[s].addEventListener("oTransitionEnd",carrouselItemChangeEnd,!1),t[s].addEventListener("webkitTransitionEnd",carrouselItemChangeEnd,!1)}for(var u=[],s=0;s<t.length;s++)s==r&&a.setAttribute("class",i.getAttribute("id")+"-"+(s+1)),a.appendChild(t[s].parentNode.removeChild(t[s])),u.push("#"+i.getAttribute("id")+" ."+i.getAttribute("id")+"-"+(s+1)+" > div { left: "+(0<s?-100*s+"%":0)+"; }");var p,g,f,m=document.createElement("style"),_=(m.setAttribute("type","text/css"),m.appendChild(document.createTextNode(u.join(" "))),document.querySelector("head").appendChild(m),"false"!=i.getAttribute("data-navbuttons")&&((m=document.createElement("p")).setAttribute("class","carrousel-previousitem"),(p=document.createElement("button")).setAttribute("type","button"),0==r?(p.setAttribute("title",carrouselstxt.previoustab[0]),p.setAttribute("disabled","disabled")):(_="img"==(_=document.getElementById(t[r-1].getAttribute("aria-labelledby")).firstChild).tagName.toLowerCase()?_.getAttribute("alt"):_.parentNode.getAttribute("aria-label"),p.setAttribute("title",_+", "+carrouselstxt.previoustab[1].toLowerCase())),n&&(p.addEventListener("keydown",carrouselHelpGlobalButtonKeyDown,!1),p.addEventListener("mousedown",carrouselHelpGlobalPreviousButtonMouseDown,!1)),p.addEventListener("click",function(t){var e=document.createEvent("MouseEvent"),i=(e.initEvent("click",!1,!0),this.parentNode.parentNode.querySelector('ol[role="tablist"] li[role="tab"][aria-selected="true"]'));(i=i.previousSibling||i.parentNode.lastChild).focus(),i.dispatchEvent(e)},!1),(g=document.createElement("img")).setAttribute("src",carrouselssrc.previoustab[p.disabled?0:1]),g.setAttribute("alt",p.getAttribute("title")),p.removeAttribute("title"),g.setAttribute("height","24"),g.setAttribute("width","24"),g.setAttribute("title",g.getAttribute("alt")),p.appendChild(g),m.appendChild(p),i.appendChild(m)),i.appendChild(a),"false"!=i.getAttribute("data-navbuttons")&&((g=document.createElement("p")).setAttribute("class","carrousel-nextitem"),(p=document.createElement("button")).setAttribute("type","button"),r==t.length-1?(p.setAttribute("title",carrouselstxt.nexttab[0]),p.setAttribute("disabled","disabled")):(_="img"==(_=document.getElementById(t[r+1].getAttribute("aria-labelledby")).firstChild).tagName.toLowerCase()?_.getAttribute("alt"):_.parentNode.getAttribute("aria-label"),p.setAttribute("title",_+", "+carrouselstxt.nexttab[1].toLowerCase())),n&&(p.addEventListener("keydown",carrouselHelpGlobalButtonKeyDown,!1),p.addEventListener("mousedown",carrouselHelpGlobalNextButtonMouseDown,!1)),p.addEventListener("click",function(t){var e=document.createEvent("MouseEvent"),i=(e.initEvent("click",!1,!0),this.parentNode.parentNode.querySelector('ol[role="tablist"] li[role="tab"][aria-selected="true"]'));(i=i.nextSibling||i.parentNode.firstChild).focus(),i.dispatchEvent(e)},!1),(m=document.createElement("img")).setAttribute("src",carrouselssrc.nexttab[p.disabled?0:1]),m.setAttribute("alt",p.getAttribute("title")),p.removeAttribute("title"),m.setAttribute("height","24"),m.setAttribute("width","24"),m.setAttribute("title",m.getAttribute("alt")),p.appendChild(m),g.appendChild(p),i.appendChild(g)),n&&i.appendChild(n),i.getAttribute("data-play"));-1<["auto","demand"].indexOf(_)&&((m=document.createElement("button")).setAttribute("type","button"),m.setAttribute("data-stop","demand"==_?"true":"false"),m.addEventListener("click",function(t){var e,i;"true"==this.getAttribute("data-stop")?(this.setAttribute("data-stop","false"),e=this.parentNode.parentNode.getAttribute("id"),i=this.parentNode.parentNode.hasAttribute("data-duration")?this.parentNode.parentNode.getAttribute("data-duration"):carrouselsvar.duration,carrousels[e]=window.setInterval(function(){carrouselItemChange(e)},i),this.replaceChild(document.createTextNode(GCO5.core.GcLangManager.getInstance().getString("STOP_CAROUSEL","home")),this.firstChild)):(this.setAttribute("data-stop","true"),window.clearInterval(carrousels[this.parentNode.parentNode.getAttribute("id")]),carrousels[this.parentNode.parentNode.getAttribute("id")]=null,this.replaceChild(document.createTextNode(GCO5.core.GcLangManager.getInstance().getString("RUN_CAROUSEL","home")),this.firstChild))},!1),m.appendChild(document.createTextNode(GCO5.core.GcLangManager.getInstance().getString("demand"==_?"RUN_CAROUSEL":"STOP_CAROUSEL","home"))),(p=document.createElement("p")).setAttribute("class","carrousel-playpause"),p.appendChild(m),i.insertBefore(p,i.firstChild),i.addEventListener("mouseover",function(t){this.setAttribute("data-stop","true")},!1),i.addEventListener("mouseout",function(t){for(var e=document.activeElement.parentNode,i=!1;e;){if(e==this){i=!0;break}e=e.parentNode}i||this.removeAttribute("data-stop")},!1),"auto"==_&&(g=i.hasAttribute("data-duration")?i.getAttribute("data-duration"):carrouselsvar.duration,f=i.getAttribute("id"),carrousels[f]=window.setInterval(function(){carrouselItemChange(f)},g)))}function carrouselItemChange(t){var e=document.getElementById(t),i=document.activeElement.parentNode,n=!1;if(document.querySelector(":focus"))for(;i;){if(i==e){n=!0;break}i=i.parentNode}for(var r,i=document.querySelector(":hover"),a=!1;i;){if(i==e){a=!0;break}i=i.parentNode}n||a||document.querySelector("#"+e.getAttribute("id")+":hover")?e.setAttribute("data-stop","true"):e.removeAttribute("data-stop"),e.hasAttribute("data-stop")||(r=(t=e.querySelector('[role="tab"][aria-selected="true"]')).nextSibling,-1<["reverse","imitate"].indexOf(e.getAttribute("data-playmode"))?e.hasAttribute("data-reverse")?(r=t.previousSibling).previousSibling||e.removeAttribute("data-reverse"):r||(e.setAttribute("data-reverse","true"),r=t.previousSibling):r=r||t.parentNode.firstChild,(t=document.createEvent("MouseEvent")).initEvent("click",!1,!0),r.dispatchEvent(t))}function carrouselItemChangeEnd(){"true"==this.getAttribute("aria-hidden")&&this.querySelector(":focus")&&this.parentNode.parentNode.querySelector('[role="tab"][aria-selected="true"]').focus()}function carrouselHelpGlobalButtonKeyDown(t){-1<[13,32].indexOf(t.keyCode)&&this.setAttribute("data-help","false")}function carrouselHelpGlobalPreviousButtonMouseDown(){var t=this.parentNode.parentNode.querySelector('ol[role="tablist"] li[role="tab"][aria-selected="true"]');(t=t.previousSibling||t.parentNode.lastChild).setAttribute("data-help","false")}function carrouselHelpGlobalNextButtonMouseDown(){var t=this.parentNode.parentNode.querySelector('ol[role="tablist"] li[role="tab"][aria-selected="true"]');(t=t.nextSibling||t.parentNode.firstChild).setAttribute("data-help","false")}function carrouselHelpTabMouseDown(t){this.setAttribute("data-help","false")}function carrouselHelpTabKeyDown(t){27==t.keyCode&&document.getElementById(this.getAttribute("aria-describedby")).setAttribute("hidden","hidden")}function carrouselHelpTabFocus(t){"false"!=this.getAttribute("data-help")&&document.getElementById(this.getAttribute("aria-describedby")).removeAttribute("hidden"),this.removeAttribute("data-help")}function carrouselHelpTabBlur(t){document.getElementById(this.getAttribute("aria-describedby")).setAttribute("hidden","hidden")}function deleteCarrouselHelp(t){if(46==t.keyCode){createCookie("carrouselhelp","false",null);for(var t=document.getElementById(t.target.getAttribute("aria-describedby")),e=(t.parentNode.removeChild(t),this.parentNode.parentNode.querySelectorAll("#"+this.parentNode.getAttribute("id")+' > ol[role="tablist"] > li[role="tab"]')),i=0;i<e.length;i++)e[i].removeAttribute("aria-describedby"),e[i].removeEventListener("mousedown",carrouselHelpTabMouseDown,!1),e[i].removeEventListener("keydown",carrouselHelpTabKeyDown,!1),e[i].removeEventListener("focus",carrouselHelpTabFocus,!1),e[i].removeEventListener("blur",carrouselHelpTabBlur,!1);t=this.parentNode.parentNode.querySelectorAll("#"+this.parentNode.getAttribute("id")+" > p.carrousel-previousitem button, #"+this.parentNode.getAttribute("id")+" > p.carrousel-nextitem button");0<t.length&&(t[0].removeEventListener("keydown",carrouselHelpGlobalButtonKeyDown,!1),t[0].removeEventListener("mousedown",carrouselHelpGlobalPreviousButtonMouseDown,!1),t[1].removeEventListener("keydown",carrouselHelpGlobalButtonKeyDown,!1),t[1].removeEventListener("mousedown",carrouselHelpGlobalNextButtonMouseDown,!1)),this.removeEventListener("keydown",deleteCarrouselHelp,!1)}}function getAvailableId(t){for(var e=1;document.getElementById(t+"-"+e);)e++;return t+"-"+e}function createCookie(t,e,i){var n;i=i?((n=new Date).setTime(n.getTime()+24*i*60*60*1e3),"; expires="+n.toGMTString()):"",document.cookie=t+"="+e+i+"; path=/"}function readCookie(t){for(var e=t+"=",i=document.cookie.split(";"),n=0;n<i.length;n++){for(var r=i[n];" "==r.charAt(0);)r=r.substring(1,r.length);if(0==r.indexOf(e))return r.substring(e.length,r.length)}return null}function eraseCookie(t){createCookie(t,"",-1)}function RGBColor(t){this.ok=!1,t=(t=(t="#"==t.charAt(0)?t.substr(1,6):t).replace(/ /g,"")).toLowerCase();var e,h={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};for(e in h)t==e&&(t=h[e]);for(var d=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(t){return[parseInt(t[1]),parseInt(t[2]),parseInt(t[3])]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(t){return[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(t){return[parseInt(t[1]+t[1],16),parseInt(t[2]+t[2],16),parseInt(t[3]+t[3],16)]}}],i=0;i<d.length;i++){var n=d[i].re,r=d[i].process,n=n.exec(t);n&&(channels=r(n),this.r=channels[0],this.g=channels[1],this.b=channels[2],this.ok=!0)}this.r=this.r<0||isNaN(this.r)?0:255<this.r?255:this.r,this.g=this.g<0||isNaN(this.g)?0:255<this.g?255:this.g,this.b=this.b<0||isNaN(this.b)?0:255<this.b?255:this.b,this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"},this.toHex=function(){var t=this.r.toString(16),e=this.g.toString(16),i=this.b.toString(16);return"#"+(t=1==t.length?"0"+t:t)+(e=1==e.length?"0"+e:e)+(i=1==i.length?"0"+i:i)},this.getHelpXML=function(){for(var t,e=new Array,i=0;i<d.length;i++)for(var n=d[i].example,r=0;r<n.length;r++)e[e.length]=n[r];for(t in h)e[e.length]=t;var a=document.createElement("ul");a.setAttribute("id","rgbcolor-examples");for(i=0;i<e.length;i++)try{var s=document.createElement("li"),o=new RGBColor(e[i]),l=document.createElement("div"),c=(l.style.cssText="margin: 3px; border: 1px solid black; background:"+o.toHex()+"; color:"+o.toHex(),l.appendChild(document.createTextNode("test")),document.createTextNode(" "+e[i]+" -> "+o.toRGB()+" -> "+o.toHex()));s.appendChild(l),s.appendChild(c),a.appendChild(s)}catch(t){}return a}}window.addEventListener("DOMContentLoaded",function(t){for(var e=document.querySelectorAll('[data-custompattern="carrousel"]'),i=0;i<e.length;i++)createCarrousel(e[i])},!1),function(r,R,y){"use strict";function k(t,e,i){return setTimeout(V(t,i),e)}function i(t,e,i){return Array.isArray(t)&&(s(t,i[e],i),1)}function s(t,e,i){if(t)if(t.forEach)t.forEach(e,i);else if(t.length!==y)for(n=0;n<t.length;)e.call(i,t[n],n,t),n++;else for(var n in t)t.hasOwnProperty(n)&&e.call(i,t[n],n,t)}function F(i,t,e){var n="DEPRECATED METHOD: "+t+"\n"+e+" AT \n";return function(){var t=new Error("get-stack-trace"),t=t&&t.stack?t.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",e=r.console&&(r.console.warn||r.console.log);return e&&e.call(r.console,n,t),i.apply(this,arguments)}}function t(t,e,i){var e=e.prototype,n=t.prototype=Object.create(e);n.constructor=t,n._super=e,i&&x(n,i)}function V(t,e){return function(){return t.apply(e,arguments)}}function U(t,e){return typeof t==gt?t.apply(e&&e[0]||y,e):t}function $(t,e){return t===y?e:t}function e(e,t,i){s(a(t),function(t){e.addEventListener(t,i,!1)})}function n(e,t,i){s(a(t),function(t){e.removeEventListener(t,i,!1)})}function B(t,e){for(;t;){if(t==e)return!0;t=t.parentNode}return!1}function l(t,e){return-1<t.indexOf(e)}function a(t){return t.trim().split(/\s+/g)}function o(t,e,i){if(t.indexOf&&!i)return t.indexOf(e);for(var n=0;n<t.length;){if(i&&t[n][i]==e||!i&&t[n]===e)return n;n++}return-1}function c(t){return Array.prototype.slice.call(t,0)}function z(t,i,e){for(var n=[],r=[],a=0;a<t.length;){var s=i?t[a][i]:t[a];o(r,s)<0&&n.push(t[a]),r[a]=s,a++}return n=e?i?n.sort(function(t,e){return t[i]>e[i]}):n.sort():n}function h(t,e){for(var i,n=e[0].toUpperCase()+e.slice(1),r=0;r<ut.length;){if((i=(i=ut[r])?i+n:e)in t)return i;r++}return y}function j(t){t=t.ownerDocument||t;return t.defaultView||t.parentWindow||r}function d(e,t){var i=this;this.manager=e,this.callback=t,this.element=e.element,this.target=e.options.inputTarget,this.domHandler=function(t){U(e.options.enable,[e])&&i.handler(t)},this.init()}function H(t,e,i){var n,r,a,s,o,l,c,h=i.pointers.length,d=i.changedPointers.length,u=e&S&&h-d==0,h=e&(M|O)&&h-d==0,p=(i.isFirst=!!u,i.isFinal=!!h,u&&(t.session={}),i.eventType=e,d=i,u=(h=t).session,e=d.pointers,r=e.length,u.firstInput||(u.firstInput=W(d)),1<r&&!u.firstMultiple?u.firstMultiple=W(d):1===r&&(u.firstMultiple=!1),r=u.firstInput,a=u.firstMultiple,s=(a||r).center,p=d.center=X(e),d.timeStamp=ft(),d.deltaTime=d.timeStamp-r.timeStamp,d.angle=K(s,p),d.distance=b(s,p),u),g=d,f=g.center,m=p.offsetDelta||{},_=p.prevDelta||{},v=p.prevInput||{},v=(g.eventType!==S&&v.eventType!==M||(_=p.prevDelta={x:v.deltaX||0,y:v.deltaY||0},m=p.offsetDelta={x:f.x,y:f.y}),g.deltaX=_.x+(f.x-m.x),g.deltaY=_.y+(f.y-m.y),d.offsetDirection=q(d.deltaX,d.deltaY),r=Y(d.deltaTime,d.deltaX,d.deltaY),d.overallVelocityX=r.x,d.overallVelocityY=r.y,d.overallVelocity=C(r.x)>C(r.y)?r.x:r.y,d.scale=a?function(t,e){return b(e[0],e[1],Ot)/b(t[0],t[1],Ot)}(a.pointers,e):1,d.rotation=a?function(t,e){return K(e[1],e[0],Ot)+K(t[1],t[0],Ot)}(a.pointers,e):0,d.maxPointers=!u.prevInput||d.pointers.length>u.prevInput.maxPointers?d.pointers.length:u.prevInput.maxPointers,u),p=d,g=v.lastInterval||p,_=p.timeStamp-g.timeStamp;p.eventType!=O&&(xt<_||g.velocity===y)?(n=p.deltaX-g.deltaX,f=p.deltaY-g.deltaY,_=Y(_,n,f),l=_.x,c=_.y,o=C(_.x)>C(_.y)?_.x:_.y,n=q(n,f),v.lastInterval=p):(o=g.velocity,l=g.velocityX,c=g.velocityY,n=g.direction),p.velocity=o,p.velocityX=l,p.velocityY=c,p.direction=n,s=h.element,B(d.srcEvent.target,s)&&(s=d.srcEvent.target),d.target=s,t.emit("hammer.input",i),t.recognize(i),t.session.prevInput=i}function W(t){for(var e=[],i=0;i<t.pointers.length;)e[i]={clientX:v(t.pointers[i].clientX),clientY:v(t.pointers[i].clientY)},i++;return{timeStamp:ft(),pointers:e,center:X(e),deltaX:t.deltaX,deltaY:t.deltaY}}function X(t){var e=t.length;if(1===e)return{x:v(t[0].clientX),y:v(t[0].clientY)};for(var i=0,n=0,r=0;r<e;)i+=t[r].clientX,n+=t[r].clientY,r++;return{x:v(i/e),y:v(n/e)}}function Y(t,e,i){return{x:e/t||0,y:i/t||0}}function q(t,e){return t===e?wt:C(t)>=C(e)?t<0?G:I:e<0?T:A}function b(t,e,i){var n=e[(i=i||Mt)[0]]-t[i[0]],e=e[i[1]]-t[i[1]];return Math.sqrt(n*n+e*e)}function K(t,e,i){var n=e[(i=i||Mt)[0]]-t[i[0]],e=e[i[1]]-t[i[1]];return 180*Math.atan2(e,n)/Math.PI}function u(){this.evEl="mousedown",this.evWin="mousemove mouseup",this.pressed=!1,d.apply(this,arguments)}function Z(){this.evEl=At,this.evWin=Pt,d.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}function J(){this.evTarget="touchstart",this.evWin="touchstart touchmove touchend touchcancel",this.started=!1,d.apply(this,arguments)}function p(){this.evTarget="touchstart touchmove touchend touchcancel",this.targetIds={},d.apply(this,arguments)}function Q(){d.apply(this,arguments);var t=V(this.handler,this);this.touch=new p(this.manager,t),this.mouse=new u(this.manager,t),this.primaryTouch=null,this.lastTouches=[]}function tt(t){var e,i,t=t.changedPointers[0];t.identifier===this.primaryTouch&&(e={x:t.clientX,y:t.clientY},this.lastTouches.push(e),i=this.lastTouches,setTimeout(function(){var t=i.indexOf(e);-1<t&&i.splice(t,1)},Nt))}function et(t,e){this.manager=t,this.set(e)}function g(t){this.options=x({},this.defaults,t||{}),this.id=vt++,this.manager=null,this.options.enable=$(this.options.enable,!0),this.state=1,this.simultaneous={},this.requireFail=[]}function it(t){return 16&t?"cancel":8&t?"end":4&t?"move":2&t?"start":""}function nt(t){return t==A?"down":t==T?"up":t==G?"left":t==I?"right":""}function f(t,e){e=e.manager;return e?e.get(t):t}function m(){g.apply(this,arguments)}function rt(){m.apply(this,arguments),this.pX=null,this.pY=null}function at(){m.apply(this,arguments)}function st(){g.apply(this,arguments),this._timer=null,this._input=null}function ot(){m.apply(this,arguments)}function lt(){m.apply(this,arguments)}function ct(){g.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}function _(t,e){return(e=e||{}).recognizers=$(e.recognizers,_.defaults.preset),new ht(t,e)}function ht(t,e){this.options=x({},_.defaults,e||{}),this.options.inputTarget=this.options.inputTarget||t,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=t,this.input=new((e=this).options.inputClass||(bt?Z:Ct?p:yt?Q:u))(e,H),this.touchAction=new et(this,this.options.touchAction),dt(this,!0),s(this.options.recognizers,function(t){var e=this.add(new t[0](t[1]));t[2]&&e.recognizeWith(t[2]),t[3]&&e.requireFailure(t[3])},this)}function dt(i,n){var r,a=i.element;a.style&&(s(i.options.cssProps,function(t,e){r=h(a.style,e),n?(i.oldCssProps[r]=a.style[r],a.style[r]=t):a.style[r]=i.oldCssProps[r]||""}),n||(i.oldCssProps={}))}var ut=["","webkit","Moz","MS","ms","o"],pt=R.createElement("div"),gt="function",v=Math.round,C=Math.abs,ft=Date.now,x="function"!=typeof Object.assign?function(t){if(t===y||null===t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),i=1;i<arguments.length;i++){var n=arguments[i];if(n!==y&&null!==n)for(var r in n)n.hasOwnProperty(r)&&(e[r]=n[r])}return e}:Object.assign,mt=F(function(t,e,i){for(var n=Object.keys(e),r=0;r<n.length;)i&&t[n[r]]!==y||(t[n[r]]=e[n[r]]),r++;return t},"extend","Use `assign`."),_t=F(function(t,e){return mt(t,e,!0)},"merge","Use `assign`."),vt=1,yt="ontouchstart"in r,bt=h(r,"PointerEvent")!==y,Ct=yt&&/mobile|tablet|ip(ad|hone|od)|android/i.test(navigator.userAgent),w="touch",xt=25,S=1,M=4,O=8,wt=1,G=2,I=4,T=8,A=16,P=G|I,D=T|A,St=P|D,Mt=["x","y"],Ot=["clientX","clientY"],Gt=(d.prototype={handler:function(){},init:function(){this.evEl&&e(this.element,this.evEl,this.domHandler),this.evTarget&&e(this.target,this.evTarget,this.domHandler),this.evWin&&e(j(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&n(this.element,this.evEl,this.domHandler),this.evTarget&&n(this.target,this.evTarget,this.domHandler),this.evWin&&n(j(this.element),this.evWin,this.domHandler)}},{mousedown:S,mousemove:2,mouseup:M}),It=(t(u,d,{handler:function(t){var e=Gt[t.type];e&S&&0===t.button&&(this.pressed=!0),2&e&&1!==t.which&&(e=M),this.pressed&&(e&M&&(this.pressed=!1),this.callback(this.manager,e,{pointers:[t],changedPointers:[t],pointerType:"mouse",srcEvent:t}))}}),{pointerdown:S,pointermove:2,pointerup:M,pointercancel:O,pointerout:O}),Tt={2:w,3:"pen",4:"mouse",5:"kinect"},At="pointerdown",Pt="pointermove pointerup pointercancel",Dt=(r.MSPointerEvent&&!r.PointerEvent&&(At="MSPointerDown",Pt="MSPointerMove MSPointerUp MSPointerCancel"),t(Z,d,{handler:function(t){var e=this.store,i=!1,n=t.type.toLowerCase().replace("ms",""),n=It[n],r=Tt[t.pointerType]||t.pointerType,a=r==w,s=o(e,t.pointerId,"pointerId");n&S&&(0===t.button||a)?s<0&&(e.push(t),s=e.length-1):n&(M|O)&&(i=!0),s<0||(e[s]=t,this.callback(this.manager,n,{pointers:e,changedPointers:[t],pointerType:r,srcEvent:t}),i&&e.splice(s,1))}}),{touchstart:S,touchmove:2,touchend:M,touchcancel:O}),Et=(t(J,d,{handler:function(t){var e,i=Dt[t.type];i===S&&(this.started=!0),this.started&&(e=function(t,e){var i=c(t.touches),t=c(t.changedTouches);return[i=e&(M|O)?z(i.concat(t),"identifier",!0):i,t]}.call(this,t,i),i&(M|O)&&e[0].length-e[1].length==0&&(this.started=!1),this.callback(this.manager,i,{pointers:e[0],changedPointers:e[1],pointerType:w,srcEvent:t}))}}),{touchstart:S,touchmove:2,touchend:M,touchcancel:O}),Nt=(t(p,d,{handler:function(t){var e=Et[t.type],i=function(t,e){var i=c(t.touches),n=this.targetIds;if(e&(2|S)&&1===i.length)return n[i[0].identifier]=!0,[i,i];var r,a=c(t.changedTouches),s=[],o=this.target,l=i.filter(function(t){return B(t.target,o)});if(e===S)for(r=0;r<l.length;)n[l[r].identifier]=!0,r++;for(r=0;r<a.length;)n[a[r].identifier]&&s.push(a[r]),e&(M|O)&&delete n[a[r].identifier],r++;return s.length?[z(l.concat(s),"identifier",!0),s]:void 0}.call(this,t,e);i&&this.callback(this.manager,e,{pointers:i[0],changedPointers:i[1],pointerType:w,srcEvent:t})}}),2500),Lt=(t(Q,d,{handler:function(t,e,i){var n=i.pointerType==w,r="mouse"==i.pointerType;if(!(r&&i.sourceCapabilities&&i.sourceCapabilities.firesTouchEvents)){if(n)!function(t,e){t&S?(this.primaryTouch=e.changedPointers[0].identifier,tt.call(this,e)):t&(M|O)&&tt.call(this,e)}.call(this,e,i);else if(r&&function(t){for(var e=t.srcEvent.clientX,i=t.srcEvent.clientY,n=0;n<this.lastTouches.length;n++){var r=this.lastTouches[n],a=Math.abs(e-r.x),r=Math.abs(i-r.y);if(a<=25&&r<=25)return!0}return!1}.call(this,i))return;this.callback(t,e,i)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}}),h(pt.style,"touchAction")),Rt=Lt!==y,kt="manipulation",E="none",N="pan-x",L="pan-y",Ft=function(){if(!Rt)return!1;var e={},i=r.CSS&&r.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach(function(t){e[t]=!i||r.CSS.supports("touch-action",t)}),e}();et.prototype={set:function(t){"compute"==t&&(t=this.compute()),Rt&&this.manager.element.style&&Ft[t]&&(this.manager.element.style[Lt]=t),this.actions=t.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var e=[],t=(s(this.manager.recognizers,function(t){U(t.options.enable,[t])&&(e=e.concat(t.getTouchAction()))}),e.join(" "));if(l(t,E))return E;var i=l(t,N),n=l(t,L);return i&&n?E:i||n?i?N:L:l(t,kt)?kt:"auto"},preventDefaults:function(t){var e=t.srcEvent,i=t.offsetDirection;if(!this.manager.session.prevented){var n=this.actions,r=l(n,E)&&!Ft.none,a=l(n,L)&&!Ft[L],n=l(n,N)&&!Ft[N];if(r){var s=1===t.pointers.length,o=t.distance<2,t=t.deltaTime<250;if(s&&o&&t)return}return(!n||!a)&&(r||a&&i&P||n&&i&D)?this.preventSrc(e):void 0}e.preventDefault()},preventSrc:function(t){this.manager.session.prevented=!0,t.preventDefault()}},g.prototype={defaults:{},set:function(t){return x(this.options,t),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(t){if(i(t,"recognizeWith",this))return this;var e=this.simultaneous;return e[(t=f(t,this)).id]||(e[t.id]=t).recognizeWith(this),this},dropRecognizeWith:function(t){return i(t,"dropRecognizeWith",this)||(t=f(t,this),delete this.simultaneous[t.id]),this},requireFailure:function(t){if(i(t,"requireFailure",this))return this;var e=this.requireFail;return-1===o(e,t=f(t,this))&&(e.push(t),t.requireFailure(this)),this},dropRequireFailure:function(t){if(i(t,"dropRequireFailure",this))return this;t=f(t,this);t=o(this.requireFail,t);return-1<t&&this.requireFail.splice(t,1),this},hasRequireFailures:function(){return 0<this.requireFail.length},canRecognizeWith:function(t){return!!this.simultaneous[t.id]},emit:function(e){function t(t){i.manager.emit(t,e)}var i=this,n=this.state;n<8&&t(i.options.event+it(n)),t(i.options.event),e.additionalEvent&&t(e.additionalEvent),8<=n&&t(i.options.event+it(n))},tryEmit:function(t){return this.canEmit()?this.emit(t):void(this.state=32)},canEmit:function(){for(var t=0;t<this.requireFail.length;){if(!(33&this.requireFail[t].state))return!1;t++}return!0},recognize:function(t){t=x({},t);return U(this.options.enable,[this,t])?(56&this.state&&(this.state=1),this.state=this.process(t),void(30&this.state&&this.tryEmit(t))):(this.reset(),void(this.state=32))},process:function(t){},getTouchAction:function(){},reset:function(){}},t(m,g,{defaults:{pointers:1},attrTest:function(t){var e=this.options.pointers;return 0===e||t.pointers.length===e},process:function(t){var e=this.state,i=t.eventType,n=6&e,t=this.attrTest(t);return n&&(i&O||!t)?16|e:n||t?i&M?8|e:2&e?4|e:2:32}}),t(rt,m,{defaults:{event:"pan",threshold:10,pointers:1,direction:St},getTouchAction:function(){var t=this.options.direction,e=[];return t&P&&e.push(L),t&D&&e.push(N),e},directionTest:function(t){var e=this.options,i=!0,n=t.distance,r=t.direction,a=t.deltaX,s=t.deltaY;return r&e.direction||(n=e.direction&P?(r=0===a?wt:a<0?G:I,i=a!=this.pX,Math.abs(t.deltaX)):(r=0===s?wt:s<0?T:A,i=s!=this.pY,Math.abs(t.deltaY))),t.direction=r,i&&n>e.threshold&&r&e.direction},attrTest:function(t){return m.prototype.attrTest.call(this,t)&&(2&this.state||!(2&this.state)&&this.directionTest(t))},emit:function(t){this.pX=t.deltaX,this.pY=t.deltaY;var e=nt(t.direction);e&&(t.additionalEvent=this.options.event+e),this._super.emit.call(this,t)}}),t(at,m,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[E]},attrTest:function(t){return this._super.attrTest.call(this,t)&&(Math.abs(t.scale-1)>this.options.threshold||2&this.state)},emit:function(t){var e;1!==t.scale&&(e=t.scale<1?"in":"out",t.additionalEvent=this.options.event+e),this._super.emit.call(this,t)}}),t(st,g,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return["auto"]},process:function(t){var e=this.options,i=t.pointers.length===e.pointers,n=t.distance<e.threshold,r=t.deltaTime>e.time;if(this._input=t,!n||!i||t.eventType&(M|O)&&!r)this.reset();else if(t.eventType&S)this.reset(),this._timer=k(function(){this.state=8,this.tryEmit()},e.time,this);else if(t.eventType&M)return 8;return 32},reset:function(){clearTimeout(this._timer)},emit:function(t){8===this.state&&(t&&t.eventType&M?this.manager.emit(this.options.event+"up",t):(this._input.timeStamp=ft(),this.manager.emit(this.options.event,this._input)))}}),t(ot,m,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[E]},attrTest:function(t){return this._super.attrTest.call(this,t)&&(Math.abs(t.rotation)>this.options.threshold||2&this.state)}}),t(lt,m,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:P|D,pointers:1},getTouchAction:function(){return rt.prototype.getTouchAction.call(this)},attrTest:function(t){var e,i=this.options.direction;return i&(P|D)?e=t.overallVelocity:i&P?e=t.overallVelocityX:i&D&&(e=t.overallVelocityY),this._super.attrTest.call(this,t)&&i&t.offsetDirection&&t.distance>this.options.threshold&&t.maxPointers==this.options.pointers&&C(e)>this.options.velocity&&t.eventType&M},emit:function(t){var e=nt(t.offsetDirection);e&&this.manager.emit(this.options.event+e,t),this.manager.emit(this.options.event,t)}}),t(ct,g,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[kt]},process:function(t){var e=this.options,i=t.pointers.length===e.pointers,n=t.distance<e.threshold,r=t.deltaTime<e.time;if(this.reset(),t.eventType&S&&0===this.count)return this.failTimeout();if(n&&r&&i){if(t.eventType!=M)return this.failTimeout();n=!this.pTime||t.timeStamp-this.pTime<e.interval,r=!this.pCenter||b(this.pCenter,t.center)<e.posThreshold;if(this.pTime=t.timeStamp,this.pCenter=t.center,r&&n?this.count+=1:this.count=1,this._input=t,0==this.count%e.taps)return this.hasRequireFailures()?(this._timer=k(function(){this.state=8,this.tryEmit()},e.interval,this),2):8}return 32},failTimeout:function(){return this._timer=k(function(){this.state=32},this.options.interval,this),32},reset:function(){clearTimeout(this._timer)},emit:function(){8==this.state&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}}),_.VERSION="2.0.7",_.defaults={domEvents:!1,touchAction:"compute",enable:!0,inputTarget:null,inputClass:null,preset:[[ot,{enable:!1}],[at,{enable:!1},["rotate"]],[lt,{direction:P}],[rt,{direction:P},["swipe"]],[ct],[ct,{event:"doubletap",taps:2},["tap"]],[st]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};ht.prototype={set:function(t){return x(this.options,t),t.touchAction&&this.touchAction.update(),t.inputTarget&&(this.input.destroy(),this.input.target=t.inputTarget,this.input.init()),this},stop:function(t){this.session.stopped=t?2:1},recognize:function(t){var e=this.session;if(!e.stopped){this.touchAction.preventDefaults(t);var i,n=this.recognizers,r=e.curRecognizer;(!r||8&r.state)&&(r=e.curRecognizer=null);for(var a=0;a<n.length;)i=n[a],2===e.stopped||r&&i!=r&&!i.canRecognizeWith(r)?i.reset():i.recognize(t),!r&&14&i.state&&(r=e.curRecognizer=i),a++}},get:function(t){if(t instanceof g)return t;for(var e=this.recognizers,i=0;i<e.length;i++)if(e[i].options.event==t)return e[i];return null},add:function(t){if(i(t,"add",this))return this;var e=this.get(t.options.event);return e&&this.remove(e),this.recognizers.push(t),(t.manager=this).touchAction.update(),t},remove:function(t){var e;return!i(t,"remove",this)&&(t=this.get(t))&&-1!==(t=o(e=this.recognizers,t))&&(e.splice(t,1),this.touchAction.update()),this},on:function(t,e){var i;if(t!==y&&e!==y)return i=this.handlers,s(a(t),function(t){i[t]=i[t]||[],i[t].push(e)}),this},off:function(t,e){var i;if(t!==y)return i=this.handlers,s(a(t),function(t){e?i[t]&&i[t].splice(o(i[t],e),1):delete i[t]}),this},emit:function(t,e){this.options.domEvents&&(i=t,n=e,(r=R.createEvent("Event")).initEvent(i,!0,!0),(r.gesture=n).target.dispatchEvent(r));var i,n,r,a=this.handlers[t]&&this.handlers[t].slice();if(a&&a.length){e.type=t,e.preventDefault=function(){e.srcEvent.preventDefault()};for(var s=0;s<a.length;)a[s](e),s++}},destroy:function(){this.element&&dt(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}},x(_,{INPUT_START:S,INPUT_MOVE:2,INPUT_END:M,INPUT_CANCEL:O,STATE_POSSIBLE:1,STATE_BEGAN:2,STATE_CHANGED:4,STATE_ENDED:8,STATE_RECOGNIZED:8,STATE_CANCELLED:16,STATE_FAILED:32,DIRECTION_NONE:wt,DIRECTION_LEFT:G,DIRECTION_RIGHT:I,DIRECTION_UP:T,DIRECTION_DOWN:A,DIRECTION_HORIZONTAL:P,DIRECTION_VERTICAL:D,DIRECTION_ALL:St,Manager:ht,Input:d,TouchAction:et,TouchInput:p,MouseInput:u,PointerEventInput:Z,TouchMouseInput:Q,SingleTouchInput:J,Recognizer:g,AttrRecognizer:m,Tap:ct,Pan:rt,Swipe:lt,Pinch:at,Rotate:ot,Press:st,on:e,off:n,each:s,merge:_t,extend:mt,assign:x,inherit:t,bindFn:V,prefixed:h}),(void 0!==r?r:"undefined"!=typeof self?self:{}).Hammer=_,"function"==typeof define&&define.amd?define(function(){return _}):"undefined"!=typeof module&&module.exports?module.exports=_:r.Hammer=_}(window,document),function(){var e,i,n,r,t=window.MutationObserver||window.WebKitMutationObserver,a="ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch;void 0!==document.documentElement.style["touch-action"]||document.documentElement.style["-ms-touch-action"]||!a||!t||(window.Hammer=window.Hammer||{},e=/touch-action[:][\s]*(none)[^;'"]*/,i=/touch-action[:][\s]*(manipulation)[^;'"]*/,n=/touch-action/,a=!!navigator.userAgent.match(/(iPad|iPhone|iPod)/g),r=function(){try{var t=document.createElement("canvas");return!(!window.WebGLRenderingContext||!t.getContext("webgl")&&!t.getContext("experimental-webgl"))}catch(t){return!1}}()&&a,window.Hammer.time={getTouchAction:function(t){return this.checkStyleString(t.getAttribute("style"))},checkStyleString:function(t){return n.test(t)?e.test(t)?"none":!i.test(t)||"manipulation":void 0},shouldHammer:function(t){var e=this.hasParent(t.target);return!(!e||r&&!(Date.now()-t.target.lastStart<125))&&e},touchHandler:function(t){var e=t.target.getBoundingClientRect(),e=e.top!==this.pos.top||e.left!==this.pos.left,i=this.shouldHammer(t);("none"===i||!1==e&&"manipulation"===i)&&("touchend"===t.type&&(t.target.focus(),setTimeout(function(){t.target.click()},0)),t.preventDefault()),this.scrolled=!1,delete t.target.lastStart},touchStart:function(t){this.pos=t.target.getBoundingClientRect(),r&&this.hasParent(t.target)&&(t.target.lastStart=Date.now())},styleWatcher:function(t){t.forEach(this.styleUpdater,this)},styleUpdater:function(t){var e;{if(!t.target.updateNext)return(e=this.getTouchAction(t.target))?void("none"!==e&&(t.target.hadTouchNone=!1)):void(!e&&(t.oldValue&&this.checkStyleString(t.oldValue)||t.target.hadTouchNone)&&(t.target.hadTouchNone=!0,t.target.updateNext=!1,t.target.setAttribute("style",t.target.getAttribute("style")+" touch-action: none;")));t.target.updateNext=!1}},hasParent:function(t){for(var e,i=t;i&&i.parentNode;i=i.parentNode)if(e=this.getTouchAction(i))return e;return!1},installStartEvents:function(){document.addEventListener("touchstart",this.touchStart.bind(this)),document.addEventListener("mousedown",this.touchStart.bind(this))},installEndEvents:function(){document.addEventListener("touchend",this.touchHandler.bind(this),!0),document.addEventListener("mouseup",this.touchHandler.bind(this),!0)},installObserver:function(){this.observer=new t(this.styleWatcher.bind(this)).observe(document,{subtree:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["style"]})},install:function(){this.installEndEvents(),this.installStartEvents(),this.installObserver()}},window.Hammer.time.install())}(),GCO5.model.dashboard.GcDatavizModel=GCO5.Class.extend({statics:{NAME:"GCO5.model.dashboard.GcDatavizModel",EPSILON:1e-5,BLOC_DISPLAY_DELAY:10,getNbBlocs:function(t,e){if(e==GCO5.model.dashboard.GcChapterModel.SINGLEBLOCK_DVZ)return 1;var t=t.report.datavizs,e=e.split("*"),i=e[0],e=e[1];return GCO5.core.GcArrayUtil.getSubArray(t,{c_id_chapter:i,c_id_dataviz:e})[0].blocks.length},NB_ZONS_REF:3,TAC_SUB_TYPE:{LIST_INDICS:"LIST_INDICS",LIST_FILTER1:"LIST_FILTER1",LIST_MODS:"LIST_MODS"},INVALID_REASON_STR:{ZERODATA:"ZERODATA",SECRET:"SECRET",OTHER:"OTHER"}},dashboardData:null,curIdDataviz:null,curIdReport:null,storeMultiPagesData:!1,gclg:null,cli:null,mapdef_o:null,grid_o:null,$container:null,lastDataviz:null,chapterModel:null,printAll:null,initialize:function(t){this.gclg=GCO5.core.GcLangManager.getInstance(),this.cli=GCO5.core.ClientInfo.getInstance(),this._setup(t)},_setup:function(t){this.$container=t.container,this.chapterModel=t.chapterModel,this.dashboardData={},this.mapdef_o={},this.lastDataviz=t.lastDataviz,this.printAll=t.printAll},setSelectedDataviz:function(t,e){this.curIdDataviz=t,e&&this.loadData(this.dashboardData,!0)},loadData:function(t,e,i,n,r,a){if(t&&(this.dashboardData=t,this.curIdReport=t.report.chapters[0].c_id_report,this.curIdChapter=r.c_id_chapter,r&&(this.dvz_o=r,this.curIdDataviz=r.c_id_dataviz),e)){var s=this.getBlocList({include:["MAP"]},!0),o=this,l={},t=s.length,c=t;if(0<t){function h(t){l[t.id_grid_item]={defBloc:t},0==--c&&(i&&i.apply(n),a?o._genDatavizHtml(l):o._updateDatavizData(l))}for(var d in s)this.getDefFromIdBloc(s[d].pk,s[d].type,h,this)}else i&&i.apply(n)}},addSingleBlockToDvzGrid:function(t){this.grid_o={singleBlock:t}},_updateDatavizData:function(r){var t=$(".report-viewport"),a=this;t.find(".dataviz-container:not(.duplistgeo)").each(function(t){var e,i={fullHTML:!0,report:!0},n=$(this).attr("id");a.grid_o[n]&&(e=r[n].defBloc,$(this).removeClass("no-data"),e.css&&$(this).addClass(e.css),e.datavizModel=a,i.chartOuterHeight=function(){return a._chartOuterHeight.call(a,e.type,e)},GCO5.core.GcDelayUtil.callLater(function(){a.grid_o[n].destroy(),a.grid_o[n].update(e,i)},[],a.constructor.BLOC_DISPLAY_DELAY*t,a))})},_chartOuterHeight:function(t,e,i){var n,r=330;return"barh"==t?(r=250,(n=e.seriesData[0].chartData.length)<=5&&(r=Math.max(80,Math.min(30*n,r)))):"pyr"==t?0<(n=e.seriesData[0].chartData?e.seriesData[0].chartData.length:0)&&n<10&&(r-=50):r-=100,"pie"==t.substr(0,3)?"pie2"!=t?250:(i=i&&!this.grid_o?i:this.grid_o[e.id_grid_item]).getPieContainerHeight(e.id_bloc):r},_genDatavizHtml:function(t){function n(t,i){t.forEach(function(e){var t=l.dvz_o.c_id_chapter+"*"+e.c_id_dataviz+e.c_id_grid_item+"_"+e.c_path;d[t]||(d[t]=1,r=$("<div id='"+t+"'></div>"),a="",s=[],o=[],GCO5.core.GcStringUtil.isEmpty(e.c_css_class)||(a+=e.c_css_class),(t=e.c_path.split(".").length)%2==1&&3<=t&&e.c_css_class.indexOf("row")<0&&(a+=" row"),e.c_id_breakpoint.forEach(function(t){a.indexOf("row")<0&&(s.push("col-"+c[t]+"-"+Math.round(12*e.c_size[t]/100)),"large"==t&&e.c_id_breakpoint.indexOf("print")<0&&s.push("col-pr-"+Math.round(12*e.c_size[t]/100))),o.push(1==e.c_visibility[t]?"":"d-"+c[t]+"-none"),o.push((1==e.c_visibility[t]?"visible-":"hidden-")+c[t])}),r.addClass(a+" "+s.join(" ")+" "+o.join(" ")).appendTo(i),e.children?(r.addClass("section"),e.children&&n.call(l,e.children,r)):(t=l.getBlockNode(e))&&(t.appendTo(r),t.hasClass("widget-link"),t.attr("tabindex",0)))})}var i,r,a,s,o,e=this.dvz_o.grid,l=this,c={large:"lg",medium:"md",small:"sm",xlarge:"xl",print:"pr"},h=this.$container,d={};e.forEach(function(e){var t;i=$("<div id='"+l.dvz_o.c_id_chapter+"*"+e.c_id_dataviz+e.c_id_grid_item+"_"+e.c_path+"'></div>"),a="dataviz ",s=[],o=[],GCO5.core.GcStringUtil.isEmpty(e.c_css_class)||(a+=e.c_css_class,0<=e.c_css_class.indexOf("row")&&(a+=" no-margin")),e.c_id_breakpoint.forEach(function(t){a.indexOf("row")<0&&(s.push(c[t]+"-"+Math.round(12*e.c_size[t]/100)),"large"==t&&e.c_id_breakpoint.indexOf("print")<0&&s.push("col-pr-"+Math.round(12*e.c_size[t]/100))),o.push(1==e.c_visibility[t]?"":"d-"+c[t]+"-none"),o.push((1==e.c_visibility[t]?"visible-":"hidden-")+c[t])}),i.addClass(a+" "+s.join(" ")+" "+o.join(" ")),i.appendTo(h),e.children?n.call(l,e.children,i):(t=l.getBlockNode(e))&&t.appendTo(i)}),this._buildDatavizsInGrid(h,t)},getBlocDisplayDelay:function(){return GCO5.core.ClientInfo.getInstance().isInIframe()&&GCO5.browser.isTouch?20:this.printAll?1:this.constructor.BLOC_DISPLAY_DELAY},_buildDatavizsInGrid:function(t,r){var a=this,s=0,t=(this.grid_o={},t.find(".dataviz-container")),o=t.length,l=(a.chapterModel.displayed=!1,this.getBlocDisplayDelay());t.each(function(t){var e,i={fullHTML:!0,report:!0,chartOuterWidth:function(){var t=this.get$ChartContainer().closest(".dataviz-container"),e=t.parent();return 0==e.innerWidth()?this.get$ChartContainer().innerWidth():e.innerWidth()-2*parseFloat(e.css("padding-right"))-parseFloat(t.css("padding-right"))-parseFloat(t.css("margin-right"))}},n=((a.printAll||GCO5.core.ClientInfo.getInstance().isInIframe()&&GCO5.browser.isTouch)&&(i.timing=0),this);s++,r[$(n).attr("id")]?(e=r[$(n).attr("id")].defBloc,"1"!=GCO5.initInfo.ip_emc3||GCO5.browser.isKitchen||$(n).attr("title","Bloc : "+e.id_bloc),i.chartOuterHeight=function(){return a._chartOuterHeight.call(a,e.type,e)},GCO5.core.GcDelayUtil.callLater(function(){$(n).css("visibility","visible").addClass("dv-"+e.type.toLowerCase()),$(n).css("flex","1"),$(n).removeClass("no-data"),e.css&&$(n).addClass(e.css),!$(n).is(":visible")&&(console.warn("erreur : Xtentative de dessin chart dans un container non visible",$(n).attr("id"),$(n).closest(".visible-pr").length),0==$(n).closest(".visible-pr").length)||((e.datavizModel=a).grid_o[$(n).attr("id")]=new GCO5.view.component.D3ChartContainer($(n),e,i),a.lastDataviz&&t==o-1&&GCO5.core.GcDelayUtil.callLater(function(){a.chapterModel._resizing=!0,a.sendMessageToIframe()},[],10,a))},[],l*t,n)):console.log("bloc hors grille ou elt de grille sans bloc ",$(n).attr("id"))}),GCO5.core.GcDelayUtil.callLater(function(){$(document).trigger("enhance"),a.chapterModel.displayed=!0,a.chapterModel._resizing=!1},[],l*s+5,this),this.lastRenderedIdDataviz=this.curIdDataviz},sendMessageToIframe:function(){var t;GCO5.core.ClientInfo.getInstance().isInIframe()&&(t=this.getReportFullHeight(),this.chapterModel.lastIframeContentHeight=t,this.chapterModel.lastIframeContentWidth=GCO5.browser.width,$(".report-viewport").css("opacity","1"),GCO5.core.SystemManager.getInstance().unFreeze("drawReportDv"),this.cli.postRobotSend("resizeIframe",{h:t,chapters:this.curIdReport?GCO5.appModel.getConcept("report_o")[this.curIdReport].chapters:null,id_chapter:this.curIdChapter?this.curIdChapter.split("|").pop():null,msg:"REPORT_COMPLETE"}),GCO5.core.GcDelayUtil.callLater(function(){$(".iframe-notice-container").css("visibility","visible")},[],1))},getReportFullHeight:function(){return $("body").hasClass("single-dvz-block")?$(".report-viewport").height():$(".report-viewport").height()+$(".report-viewport").parent().find(">nav").height()+$(".report-viewport").parent().find(">.ficHeader").height()+$(".iframe-notice-container").height()+5},resize:function(t,e,i){$(".report-viewport");var n=this,r=0,a=GCO5.core.SystemManager.getInstance(),s=this.getReportFullHeight();n.cli.isInIframe()&&s==n.chapterModel.lastIframeContentHeight&&n.chapterModel.lastIframeContentWidth==GCO5.browser.width||(this.$container.find(".dataviz-container").each(function(t){var e=$(this).attr("id");n.grid_o[e]&&("preprint"==a.getPrintMode()&&n.grid_o[e].get$ChartContainer().parent().hide(),GCO5.core.GcDelayUtil.callLater(function(){n.grid_o[e].get$ChartContainer().parent().css("display","flex"),n.grid_o[e].resize()},[],2+r++))}),GCO5.core.GcDelayUtil.callLater(function(){n.cli.isInIframe()&&"preprint"!=a.getPrintMode()&&(n.chapterModel.lastIframeContentHeight=s,n.chapterModel.lastIframeContentWidth=GCO5.browser.width,t==e&&n.cli.postRobotSend("resizeIframe",{h:s,chapters:n.curIdReport?GCO5.appModel.getConcept("report_o")[n.curIdReport].chapters:null,id_chapter:n.curIdChapter?n.curIdChapter.split("|").pop():null,msg:"REPORT_COMPLETE"}))},[],2+r,this))},getBlockNode:function(t){var e=(e=t.c_css_class||"").replace(/bordered/g,"");return $("<article style='visibility:hidden' id='"+this.curIdChapter+"*"+t.c_id_dataviz+t.c_id_grid_item+"' class='dataviz-container "+e+"'></article>")},getDashboardData:function(t){return this.storeMultiPagesData?this.dashboardData[t||this.curIdPage]:this.dashboardData},isScoreCard:function(t){return 0==this.curIdReport.indexOf("SYNTH")||"r01"==this.curIdReport&&!this.dashboardData.pages},buildReportPageTree:function(){for(var t=[],e=0;e<this.report_a.length;e++){var i=this.report_a[e],i={data:i.id_rep,label:i.lib_rep,pages:GCO5.core.GcArrayUtil.getSubArray(this.page_a,{id_rep:[i.id_rep]})};t.push(i)}return t},getPagesFromReport:function(t){return GCO5.core.GcArrayUtil.getSubArray(this.page_a,{id_rep:[t]})},_getFilter1Table:function(t,e,i){var n=this.dashboardData.nomencs;return!(!n||!n[t])&&(n=n[t].data,i&&(n=n.filter(function(t){return 0<=i.indexOf(t.id)})),e?GCO5.core.GcArrayUtil.toIndexedObj(n,"id"):n)},getReportPageInfo:function(t){t=GCO5.core.GcArrayUtil.getSubArray(this.page_a,{pk:[t]})[0];return{lib_page:t.label,lib_rep:t.lib_rep}},getBlocInfo:function(t){var e=this.dashboardData.pages[0].blocs,t=GCO5.core.GcArrayUtil.indexOfByKey(e,"id",t);return 0<=t?e[t]:null},getReportIndex:function(t){return GCO5.core.GcArrayUtil.indexOfByKey(this.report_a,"id_rep",t)},getBlocList:function(t,e){for(var i=this.dashboardData.report.datavizs||this.dashboardData.report.chapters[0].dataviz,i=GCO5.core.GcArrayUtil.indexOfByKey(i,"c_id_dataviz",this.curIdDataviz),n=[],r=this.dashboardData.report.datavizs[i].blocks,a=0;a<r.length;a++)n.push({pk:r[a].c_id_block,type:r[a].c_block_type,lib_bloc:r[a].c_title});return n},_checkBlockVisibility:function(t){var e=!0,i=t.struct,n=t.c_id_block.substr(0,3);return"BAH_TOP_UNITS"==i&&1==t.territories.length&&(e=!1),e="TXT"==n&&(!t.text||t.text.length<30)?!1:e},_getBlocInfo:function(t){var e=this.dashboardData.report.datavizs||this.dashboardData.report.chapters[0].dataviz,e=e[GCO5.core.GcArrayUtil.indexOfByKey(e,"c_id_dataviz",this.curIdDataviz)].blocks;return e[GCO5.core.GcArrayUtil.indexOfByKey(e,"c_id_block",t)]},_isSpecificValueOrNotNumeric:function(t){return GCO5.core.GcMathUtil.isInvalid(t)},_isSpecificValue:function(t){return GCO5.core.GcMathUtil.isSpecificValue(t)},_getDisplayStrForSpecificValues:function(t,e){var i=parseInt(t);return i===GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA||GCO5.core.GcStringUtil.isEmpty(t)?this.gclg.getString("NAMQ_SHORT","indics"):i===GCO5.core.GcMathUtil.SPECIFIC_VALUE.SECRET?this.gclg.getString("NASS_SHORT","indics"):i===GCO5.core.GcMathUtil.SPECIFIC_VALUE.SECRET_INDUIT?this.gclg.getString("NASS_IND_SHORT","indics"):i===GCO5.core.GcMathUtil.SPECIFIC_VALUE.DIV0?this.gclg.getString("NAD0_SHORT","indics"):i===GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA_SPEC?this.gclg.getString("NAOLP_SHORT","indics"):e&&!$.isNumeric(t)?this.gclg.getString("NAMQ_SHORT","indics"):t},_getDisplayValue:function(t,e,i){var n=t;return n=e&&this._isSpecificValueOrNotNumeric(t)||this._isSpecificValue(t)?this._getDisplayStrForSpecificValues(void 0!==i?i:t,e):n},_getFullBlocInfo:function(t,e){var i=this._getBlocInfo(t);if(i.c_id_chapter=this.curIdChapter,"TXT"==i.c_block_type)return E={type:i.c_block_type,title:i.c_title?i.c_title.split("|").join("<br>"):"",text:i.c_content||"",source:i.c_source?i.c_source.split("|").join(" "):""},L=GCO5.core.GcObjectUtil.cloneJson(i),GCO5.core.GcObjectUtil.extend(L,E),L;var n,t=i.c_id_dataset,r=this.dashboardData.data[t],a=GCO5.appModel.getConcept("dataset_o"),s={},o=[],l=0,c=0,h=0;s.series=a[t].series;var d,u,p,g,f,m,_=[],v=!1,y=!1,b=0,a=(i.blocksAxis.forEach(function(t){var e;"Z"==t.c_util&&("T"==t.c_type_axis&&_.push("serie"),"F"==t.c_type_axis&&_.push("filter1")),"T"==t.c_type_axis&&(s.serie=t.c_id_variable,t.c_filter&&(s.series=[t.c_filter]),t.c_period_end&&(l=t.c_period_end),c=t.c_nb_period||s.series.length,"X"==t.c_util&&(d="serie")),"F"==t.c_type_axis&&(s.filter1=t.c_id_variable,"X"==t.c_util&&(d="filter1"),g=t.c_filter_default,t.c_filter&&(f=(t.c_filter||"").split("|"),g=g||f[0])),"E"==t.c_type_axis&&(s.filter0=t.c_id_variable,"X"==t.c_util&&(d="filter0"),isNaN(t.c_filter)||(b=+t.c_filter)),"A"==t.c_util&&(e=t.c_id_variable&&0==t.c_id_variable.indexOf("@comparison"),"G"==t.c_type_axis&&(t.c_id_zonref||e)?(v=1,e&&(h++,v=+t.c_id_variable.substr(-1,1),n=1==t.c_vrefline)):"G"==t.c_type_axis&&"@selection"==t.c_id_variable?y=1:"F"==t.c_type_axis?p="filter1":"I"==t.c_type_axis&&(p="indic")),"I"==t.c_type_axis&&((d=!(d=!d&&"Y"==t.c_util&&t.c_classes?"mods":d)&&"Y"==t.c_util&&0<=["BAV","PIE","TAB","LIN"].indexOf(i.c_block_type)?"indics":d)||"X"!=t.c_util&&"BAH"!=i.c_block_type||(d="mods"),o.push(t)),"Y"==t.c_util&&(u=t.c_type_axis),"G"==t.c_type_axis&&"Y"==t.c_util&&GCO5.core.GcMathUtil.isNumber(t.c_filter)&&(b=+t.c_filter)}),("mods"==d||"indic"==p)&&["BXAH","PYR","TAB"].indexOf(i.c_block_type)<0&&(a=t+"."+o[0].c_id_variable,2==o.length&&(a+="."+o[1].c_id_variable),this.dashboardData.data[a]&&(r=this.dashboardData.data[a])),GCO5.core.GcStringUtil.isEmpty(s.serie)?null:s.serie),C=a?s.series:null,R=GCO5.core.GcStringUtil.isEmpty(s.filter0)?null:s.filter0,k=GCO5.core.GcStringUtil.isEmpty(s.filter1)?null:s.filter1,F=a?C[C.length-1]:null,x=l-1,x=C?C.length+x:null,V=C?C[x]:null,x=C?C.slice(x+1-parseFloat(c),x+1):null,U=("E"==i.c_computed_col&&(x=C),GCO5.core.GcArrayUtil.getColumnByKey(o,"c_id_variable")),w=this._getTerritoryPkByType(1),S=this._getTerritoryPkByType(0,"REF",i,v?1:0),M=this._getTerritoryPkByType(3,"INTERM",i),O=this._getTerritoryPkByType(4,"INTERM",i),G=e?this._getTerritoryPkByType(2):S,$=this._getTerritoryLibgeo(w,e?G:null),e=e?this._getTerritoryLibgeo(G,w):null,I=M?this._getTerritoryLibgeo(M,null,!0):null,T=O?this._getTerritoryLibgeo(O,null,!0):null,B=this._getTerritoryLibgeo(S),A=o;if(S&&M&&(m=[{id:M,title:I}]),S&&O&&m.push({id:O,title:T}),0<A.length){var P,D=A[0].c_classes?A[0].c_classes.split("|"):null,z=A[0].c_classeslib?A[0].c_classeslib.split("|"):null,j={};for(P in D)j[D[P]]=z[P]}var E,H=i.colorPalette||["#c90119","#f49c2a","#f9d433","#a20672","#c975a9","#129b9e","#8ccdcf","#00f"],W=S&&(v||!!M&&["PIE","BAV","LIN"].indexOf(i.c_block_type)<0);if(""==(E={nbItemsMax:b,nbPeriods:c,cols:H,colf_a:i.colorPalette,datasetData:r,pkgeo:w,pkgeo2:G,pkref:S,pkinter:M,pkinter2:O,nbComparisonRefAxis:h,terrRef:S,serie:a,series:C,validSeries:x,indic_a:U,lastSerie:F,curSerie:V,zonreflib:B,filter0:R,filter1:k,filterModDefault:g,filterModsRestriction:f,mods:D,modslib:z,mods_o:j,blocvar_a:A,ci:!1,XAxis:d,YAxis:u,ZAxis:_,AAxis:p,computed_col:i.c_computed_col,hasRef:W,hasZonUser:y,type:i.c_block_type,title:i.c_title.split("|").join("<br>"),source:i.c_source?i.c_source.split("|").join(" "):"",id_dataset:t,vrefline:n,terrInterLabel:I,terrInter2Label:T,terrInterm:m,selgeo1Label:$,selgeo2Label:e}).source&&A){var N=[];for(P in A)N.indexOf(A[P].c_source)<0&&N.push(A[P].c_source);E.source=N.join(" + ")}if("MAP"==i.c_block_type)return E.height=300,L=GCO5.core.GcObjectUtil.cloneJson(i),GCO5.core.GcObjectUtil.extend(L,E),L;r&&r[w]&&A&&0!=A.length||(console.log("NODATA1",i.c_id_block,E,t,w,A,"datasetData",r,this.dashboardData.data[t]),E.NODATA=!0);var L=GCO5.core.GcObjectUtil.cloneJson(i);return GCO5.core.GcObjectUtil.extend(L,E),L},_isTerritorySymb:function(t){t=this.dashboardData.territories[t];return t?t.isSymb:null},_getTerritoryPkByType:function(t,e,i,n){if(e&&i&&i.territories){i=GCO5.core.GcArrayUtil.getSubArray(i.territories,{type:e});if(1==i.length)return i[0].id}var r,a=1;for(r in this.dashboardData.territories){var s=this.dashboardData.territories[r];if(t&&s.selNum==t)return s.id;if(e&&s.type==e&&"REF"==e){if(isNaN(n))return s.id;if(a==n)return s.id;a++}if("SELGEO"==s.type&&"INTERM"==e&&t&&s.selNum==t+2)return s.id}return null},_getTerritoryLibgeo:function(t,e,i){t=GCO5.core.GcArrayUtil.getSubArray(this.dashboardData.territories,{id:t});if(0==t.length)return null;var n,r=t[0].title;return(e||i)&&(n=GCO5.appModel.getInfo("libNivgeo",[t[0].nivgeo,e])),e?r==this._getTerritoryLibgeo(e)&&r.toLowerCase()!=n.toLowerCase()&&(r+=" ("+n+")"):i&&(r+="|("+n+")"),r},getDefFromIdBloc:function(e,t,i,n){var r,a=1==GCO5.core.GcArrayUtil.getSubArray(this.dashboardData.territories,{selNum:2}).length;try{var s=this._getFullBlocInfo(e,a)}catch(t){return(s=this._getBlocInfo(e)).type="TXT",console.warn("NODATA2",s,t),s.text=this.gclg.getString("NODATA_DVZ"),s.title=s.c_title,s.css="no-data",r=this.getTxtDef(s),i&&n&&i.apply(n,[r]),r}return s.NODATA?(s.type="TXT",s.text=this.gclg.getString("NODATA_DVZ"),s.css="no-data",r=this.getTxtDef(s),i&&n&&i.apply(n,[r]),r):"MAP"===t.substr(0,3)?(r=this.getMapDef(s),this.mapdef_o[r.idBloc]?i&&n?void i.apply(n,[this.mapdef_o[r.idBloc]]):this.mapdef_o[r.idBloc]:i&&n?void this._loadFullMapDef(r,i,n):r):(r="TA"===t.substr(0,2)?this.getTableDef(s):"TXT"===t.substr(0,3)?this.getTxtDef(s):"SPC"===t.substr(0,3)?this.getSpineDef(s):this.getChartDef(s))?r.ZERODATA?(s.type="TXT",s.text=this.gclg.getString("NODATA_DVZ"),s.css="no-data",console.warn("ZERODATA",s),r=this.getTxtDef(s),i&&n&&i.apply(n,[r]),r):r?i&&n?void i.apply(n,[r]):r:void 0:void 0},_loadFullMapDef:function(e,i,n){var r={},a=e.mapdef_o.selgeo,s=e.mapdef_o.nivgeo,t=(e.selgeo=e.mapdef_o.selgeo,GCO5.appModel.getInfo("mapNameFromNivgeo",[s,a?a.id_extent:null]));if(a&&(t?a&&!a.id_extent&&(a.id_extent=GCO5.appModel.getInfo("infoFromMapName",[t,"id_extent"])):(o=GCO5.appModel.getConcept("view").map(function(t){return t.c_id_nivgeo}),o=GCO5.appModel.getInfo("subNivgeos",[a.nivgeo,o]),s=0<o.length?o[0].nivgeo:null)),GCO5.browser.isKitchen)return e.mapName=t,void i.apply(n,[e]);var o={c_id_dataset:e.indic.split(".")[0],c_id_indicateur:e.indic.split(".")[1]};e.fullBlocInfo&&e.fullBlocInfo.filterModDefault&&(o.f1code=e.fullBlocInfo.filterModDefault),r[e.indic]=new GCO5.model.indics.IndicModel(o),a&&("PTX"==a.getTopology()?GCO5.appModel.loadMapViewModel(i,n,t,null,r,e):a.getSelIds(s,null,function(){var t=GCO5.appModel.getInfo("mapNameFromNivgeo",[s,a.id_extent]);GCO5.appModel.loadMapViewModel(i,n,t,null,r,e)}))},getChartDef:function(t){var e="get"+GCO5.core.GcStringUtil.proper(t.c_block_type)+"Def";if(this[e])return this[e](t)},getPyrDef:function(t){for(var i=this,e={},n=t.datasetData,r=t.hasRef?t.pkgeo2:null,a=t.hasZonUser?t.pkgeo:r,s=t.serie,o=t.series,l=t.filter1,c=this._getFilter1Table(l,!0),h=n[a].length,d=0,u=0;u<h;u++)c[(p=n[a][u])[l]]?p.f1codelib=c[p[l]].lib:(d++,console.warn("lib manquant pour "+l+" : "+p[l]));if(d){for(var p,g=[],u=0;u<h;u++)(p=n[a][u]).f1codelib&&g.push(p);n[a]=g}if(o){for(var f=[],m=0;m<o.length;m++){var _={},v=o[m],_=(_[s]=[String(v),parseFloat(v)],GCO5.core.GcArrayUtil.getSubArray(n[a],_));0<_.length&&(e[v]=_,f.push(v))}f.length<o.length&&(t.series=o=f,t.validSeries=GCO5.core.GcArrayUtil.intersection(t.validSeries,o))}else e=n[a];var y=t.indic_a[1],b=t.indic_a[0],r={type:"pyr",filter:l,filterMods:t.validSeries,subsetKey:t.curSerie,subsetType:"serie",fullBlocInfo:t,animate:o&&1<o.length,colf_a:t.colf_a,blocvar_a:t.blocvar_a,metrics:{},xVar:y,x2Var:b,yVar:"f1codelib",seriesData:[{className:".main.l1",label:"",data:e,enabled:!0}]},t=(GCO5.core.GcObjectUtil.extend(r,this._getBaseChartDef(t)),r.subTitle=this._getSubtitle(t),GCO5.core.GcObjectUtil.copyProps(t,r.metrics,["x","y","width","height"]),t.blocvar_a),C=t&&2==t.length?t[0].c_lib_court:this.gclg.getString("WOMEN","report"),x=t&&2==t.length?t[1].c_lib_court:this.gclg.getString("MEN","report");return r.tooltip=function(t,e){d3.select(this.parentNode).attr("class");return{caption:i.gclg.getString("TRAGE","report")+i.gclg.getString("P2B")+" "+t.f1codelib,row_a:[{th:C,td:i.gclg.formatNumber(t[b],0,!0)},{th:x,td:i.gclg.formatNumber(t[y],0,!0)}]}},r},_getSubtitle:function(t){var e=t.hasZonUser?t.selgeo1Label:t.selgeo2Label||t.zonreflib;return t.c_subtitle?t.c_subtitle+" - "+e:e},_getBaseChartDef:function(t){var e=t.c_subtitle,i=(t.ZAxis&&0<=t.ZAxis.indexOf("filter1")&&((i=GCO5.core.GcArrayUtil.toIndexedObj(this.dashboardData.nomencs[t.filter1].data,"id"))&&i[t.f1code]&&(e=t.c_subtitle?t.c_subtitle+" - "+i[t.f1code].lib:i[t.f1code].lib)),t.source);return t.ZAxis&&0<=t.ZAxis.indexOf("serie")&&t.curSerie&&(i+=" - "+t.curSerie),"filter0"==t.XAxis&&(i+=" - Données potentiellement partielles en raison du secret statistique"),{selgeo1:this.chapterModel.selgeo1,id_grid_item:t.c_id_chapter+"*"+t.c_id_dataviz+t.c_id_grid_item,id_bloc:t.c_id_block,source:i,title:t.title,subTitle:e,note:t.c_note,fullBlocInfo:t}},getPieDef:function(n){var e,t=this._joinSelgeo12Data(n,{epsilon:!1,removeTotal:!0,totalize:!0,maxZones:2}),r=this,i=[t.seriesData[0]],a="pie",s=(2<=t.seriesData.length&&(i.push(t.seriesData[t.seriesData.length-1]),a="pie2"),{type:a,cVar:"X",xVar:"label",yVar:"Y",fullBlocInfo:n,display_numbers:n.c_display_numbers,filterMods:n.validSeries,subsetKey:n.curSerie,subsetType:n.series?"serie":"",animate:n.series&&1<n.series.length,colf_a:n.cols,seriesData:i});0<=n.ZAxis.indexOf("filter1")?((t=this.dashboardData.nomencs[n.filter1])&&(s.filterMods=t.data.filter(function(t){return i[0].data.hasOwnProperty(t.id)&&(!r.dashboardData.globalFilter1||r.dashboardData.globalFilter1Id!=n.filter1||t.id==r.dashboardData.globalFilter1)}),Array.isArray(n.filterModsRestriction)&&(s.filterMods=s.filterMods.filter(function(t){return 0<=n.filterModsRestriction.indexOf(t.id)})),a=null!==n.filterModDefault?n.filterModDefault:s.filterMods[0].id,s.subsetKey=n.f1code=a,s.subsetType="filter1",s.animate=!1),n.curSerie&&0<=n.ZAxis.indexOf("serie")&&((e={})[n.serie]=n.curSerie,s.filterMods.forEach(function(t){i[0].data[t.id]=GCO5.core.GcArrayUtil.getSubArray(i[0].data[t.id],e),i[1]&&(i[1].data[t.id]=GCO5.core.GcArrayUtil.getSubArray(i[1].data[t.id],e))})),i[0].chartData=i[0].data[s.subsetKey],i[1]&&(i[1].chartData=i[1].data[s.subsetKey])):n.curSerie&&0<=n.ZAxis.indexOf("serie")&&(s.filterMods=s.filterMods.filter(function(t){var e=i[0].data.hasOwnProperty(t),t=!i[1]||i[1].data.hasOwnProperty(t);return e&&t}));if("filter0"==n.XAxis&&n.nbItemsMax){t=s.subsetKey?i[0].data[s.subsetKey]:i[0].data,territories=n.territories,n.curSerie&&(territories=territories[n.curSerie]),n.f1code&&(territories=territories[n.f1code]);for(var o,l=GCO5.core.GcArrayUtil.toIndexedObj(t,n.filter0),c=[],h=0;h<territories.length;h++){var d=territories[h].id.split("@")[1],u=l[d];u||"others"!=d?c.push({X:d,label:territories[h].title+" ("+r.gclg.formatNumber(u.Y,0,!0)+")",Y:u.Y}):(c.push({X:d,label:"Autres ("+r.gclg.formatNumber(territories[h].eft,0,!0)+")",Y:territories[h].eft}),o=!0),o&&1==c.length&&(c[0].label="Autres ("+c[0].Y+")"),s.subsetKey&&(i[0].data[s.subsetKey]=c)}}GCO5.core.GcObjectUtil.extend(s,this._getBaseChartDef(n)),1===i.length&&(s.subTitle=this._getSubtitle(n));var a=s.subsetKey?i[0].data[s.subsetKey]:i[0].data,p=(i[0]=this._checkPieData(i[0],a),i[1]&&(t=s.subsetKey?i[1].data[s.subsetKey]:i[1].data,i[1]=this._checkPieData(i[1],t)),s.metrics={},GCO5.core.GcObjectUtil.copyProps(n,s.metrics,["x","y","width","height"]),"");return n.blocvar_a&&0<n.blocvar_a.length&&!GCO5.core.GcStringUtil.isEmpty(n.blocvar_a[0].c_unite)&&(p=" "+n.blocvar_a[0].c_unite),s.tooltip=function(t){var e=t.data.Y,i=t.data.hasOwnProperty("_TOT_")?r.gclg.formatNumber(100*t.data.Y/t.data._TOT_,1,!0):null,t={caption:t.data.label,row_a:[{th:r.gclg.getString("VALUE"),td:r.gclg.formatNumber(e,0,!0)+p+(null!==i?" ("+i+" %)":"")}]};return n.series&&t.row_a.push({th:r.gclg.getString("PERIOD","indics"),td:n.curSerie}),t},s},_checkPieData:function(t,e){var i=this,n=!0;return(n=e?e.every(function(t){return t.Y==GCO5.model.dashboard.GcDatavizModel.EPSILON||0==t.Y||i._isSpecificValueOrNotNumeric(t.Y)}):n)?(t.isInvalid=!0,t.isInvalidReason=GCO5.model.dashboard.GcDatavizModel.INVALID_REASON_STR.ZERODATA):e.some(function(t){return i._isSpecificValueOrNotNumeric(t.Y)})&&(t.isInvalid=!0,n=e.some(function(t){return GCO5.core.GcMathUtil.isSecret(t.Y)}),t.isInvalidReason=n?GCO5.model.dashboard.GcDatavizModel.INVALID_REASON_STR.SECRET:GCO5.model.dashboard.GcDatavizModel.INVALID_REASON_STR.OTHER),t},_joinSelgeo12Data:function(r,a,k){var s=this,F=r.pkgeo,V=r.hasRef?r.pkgeo2:null,U=r.pkinter,$=r.pkinter2,i=r.serie,t=r.filter0,n=r.filter1,e=r.mods_o,l=r.blocvar_a,c=GCO5.core.GcObjectUtil.cloneJson(r.datasetData),h=r.cols,d={},B=0,z=GCO5.model.dashboard.GcDatavizModel.EPSILON,u=(a=GCO5.core.GcObjectUtil.defaults(a||{},{epsilon:!1,totalize:!1,removeTotal:!1,base100:!1,maxZones:4}),0),p=0,g=[],f=[],m=[],j=(g[0]=c[F],g[1]=1<a.maxZones&&V?c[V]:null,m[0]={},m[1]={},f[0]=[],f[1]=1<a.maxZones&&g[1]?[]:null,r.hasRef?c[r.pkref]:null),_=(2<a.maxZones&&U&&r.hasRef&&(g[2]=c[U],f[2]=g[2]?[]:null,m[2]={}),2<a.maxZones&&$&&r.hasRef&&(g[3]=c[$],f[3]=g[3]?[]:null,m[3]={}),Math.min(a.maxZones,g.length)),v=function(t){return t};if("filter0"!=r.XAxis)if("filter1"==r.XAxis){var y=this._getFilter1Table(r.filter1,!0),v=function(t){return y[t]?y[t].lib:t};for(b in y)GCO5.core.GcStringUtil.hasOnlyZeros(y[b].id)||(d[y[b].id]=h[B++])}else if("mods"==r.XAxis)for(var b in v=function(t){return e[t]||t},e)d[b]=h[B++];else if("indics"==r.XAxis){for(var e={},C=0;C<l.length;C++)d[l[C].c_id_variable]=h[C],e[l[C].c_id_variable]=l[C].c_lib_court;v=function(t){return e[t]||t}}var x,w,S=[],H={};if(i&&S.push(i),t&&S.push(t),n&&S.push(n),"mods"==r.XAxis&&S.push("X"),"serie"==r.XAxis){if(1<l.length){for(var M=[],O=0;O<l.length;O++)G=(G=g[0].map(function(t){var e={X:t[i],Y:t[l[O].c_id_variable]};return n&&(e[n]=t[n]),e})).filter(function(t){return 0<=r.validSeries.indexOf(t.X)}),d[l[O].c_id_variable]=h[O],0<=r.ZAxis.indexOf("filter1")&&(G=GCO5.core.GcArrayUtil.nest(G,n)),M.push({className:".main.l"+String(O+1),label:l[O].c_lib_court,nbdec:l[O].c_nbdec,data:G,enabled:!0});return{seriesData:M,colf_o:d}}if(n&&"filter1"==r.AAxis){y=this._getFilter1Table(n,!0),O=(v=function(t){return y[t]?y[t].lib:t},0),M=[];for(b in y)GCO5.core.GcStringUtil.hasOnlyZeros(y[b].id)||0!=(G=g[0].filter(function(t){return t[n]==y[b].id})).length&&(G=G.map(function(t){return{X:t[i],Y:t[l[0].c_id_variable]}}),d[y[b].id]=h[O],M.push({className:".main.l"+String(O+1),label:y[b].lib,nbdec:l[0].c_nbdec,data:G,enabled:!0}),O++);return{seriesData:M,colf_o:d}}if("indic"==r.AAxis){v=function(t){return e[t]||t};l[0].c_classes.split("|");var G,O=0,M=[];for(b in e)d[b]=h[O],0!=(G=g[0].filter(function(t){return t.code==b})).length&&(G=G.map(function(t){return{X:t[i],Y:t.eft}}),M.push({className:".main.l"+String(O+1),label:e[b],nbdec:0,data:G,enabled:!0}),O++);return{seriesData:M,colf_o:d}}1==l[0].c_hasci&&"S"==r.computed_col&&(p++,g.forEach(function(t,e){t&&t.forEach(function(t){t.Y_LCL=t[l[0].c_id_variable+"_lcl"],t.Y_UCL=t[l[0].c_id_variable+"_ucl"]})}),u=2)}if(1<l.length&&"mods"!=r.XAxis){function W(t){for(var e in x={},S)x[S[e]]=t[S[e]];T=0;var i,n=E.length;for(i in p=0,l)(D=GCO5.core.GcObjectUtil.clone(x)).X=l[i].c_id_variable,D.highIsBad=l[i].c_highisbad,D.Y=t[D.X],D.label=l[i].c_lib_court,X=Math.max(X,l[i].c_nbdec),1==l[i].c_hasci&&"S"==r.computed_col&&(p++,D.Y_LCL=t[D.X+"_lcl"],D.Y_UCL=t[D.X+"_ucl"]),s._isSpecificValueOrNotNumeric(D.Y)?(a.epsilon&&(D.Y=z),T=GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA):s._isSpecificValueOrNotNumeric(T)||(T+=D.Y),E.push(D);p==l.length&&u++,a.totalize&&(E.forEach(function(t,e){n<=e&&(t._TOT_=T)}),(D=GCO5.core.GcObjectUtil.clone(x)).X="_TOT_",D.Y=T,D._TOT_=T,D.label=s.gclg.getString("TOTAL"),E.push(D))}for(var X=0,I=0;I<_;I++)f[I]&&(1==I&&r.vrefline&&u&&(g[1]=j),E=f[I],g[I].forEach(W),g[I]=f[I]);S.push("X")}else for(var Y=l[0].c_id_variable,X=l[0].c_nbdec,T=0,A={},q=n&&"filter1"==r.XAxis?n:t&&"filter0"==r.XAxis?t:"serie"==r.XAxis?i:"mods"==r.XAxis?"code":void 0,K=0<=r.ZAxis.indexOf("serie"),Z=a.totalize,P=function(t){return GCO5.core.GcStringUtil.hasOnlyZeros(t)},J=!!r.filterModsRestriction,Q=function(t){return!J||0<=r.filterModsRestriction.indexOf(t)},tt=!J&&g[0].some(function(t){return P(t[q])}),et=function(t){n||"mods"==r.XAxis||"serie"==r.XAxis||t.hasOwnProperty("label")||(t.label=l[0].c_lib_court),t.X=t[q],t.Y=t["mods"==r.XAxis?"eft":Y],K?tt&&P(t.X)?A[t[i]]=t.Y:tt||P(t.X)||!Q(t.X)||(A[t[i]]||(A[t[i]]=0),s._isSpecificValueOrNotNumeric(t.Y)||A[t[i]]===GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA?A[t[i]]=GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA:A[t[i]]+=t.Y):Q(t.X)&&(s._isSpecificValueOrNotNumeric(t.Y)||T===GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA?T=GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA:T+=t.Y),1==l[0].c_hasci&&"S"==r.computed_col&&(u++,t.Y_LCL=t[l[0].c_id_variable+"_lcl"],t.Y_UCL=t[l[0].c_id_variable+"_ucl"]),t.highIsBad=l[0].c_highisbad},I=0;I<_;I++)g[I]=((w=g[I])&&(Z&&K&&r.series.forEach(function(t){A[t]=0}),T=0,w.forEach(et),"filter1"==r.XAxis&&(a.removeTotal||J)&&(w=w.filter(function(t){return(!a.removeTotal||!P(t.X))&&Q(t.X)})),Z&&(K?w.forEach(function(t){t._TOT_=A[t[i]]}):w.forEach(function(t){t._TOT_=T}))),w);for(var it,nt,rt=function(t){for(var e in G=[],S)G.push(t[S[e]]);o[G.join("|")]=t,H[G.join("|")]=1},I=0;I<_;I++)g[I]&&(o=m[I],g[I].forEach(rt),f[I]=g[I]?[]:null);for(it in H){G=it.split("|");var D={};for(b in S)D[S[b]]=G[b];"serie"==r.XAxis?D.X=D[i]:"filter1"==r.XAxis&&(D.X=D[n]);for(I=0;I<_;I++)g[I]&&f[I].push(m[I][it]||D)}if("serie"==r.XAxis)for(I=0;I<_;I++)f[I]&&(f[I]=f[I].filter(function(t){return 0<=r.validSeries.indexOf(t.X)}),f[I].sort(function(t,e){return t.X>=e.X?1:-1}));r.terrInterm&&(nt=GCO5.core.GcArrayUtil.getColumnByKey(r.terrInterm,"title"));for(var at=function(t){return 0===t?r.selgeo1Label:1===t?r.selgeo2Label||r.zonreflib:2===t?nt[0].replace(/\|/g," "):3===t?nt[1].replace(/\|/g," "):void 0},I=0;I<_;I++)f[I]&&f[I].forEach(function(t){t.label||(t.label=v(t.X)),t.libgeo=at(I)});if(0<r.ZAxis.length)for(var E,st=0<=r.ZAxis.indexOf("filter1")?n:i,I=0;I<_;I++)f[I]&&(E=f[I],f[I]=GCO5.core.GcArrayUtil.nest(E,st));f[1]||(a.base100=!1);var N=[];if(a.base100)if(Array.isArray(f[0])){if(!(L=this._getValidDataRange(f)))return a.base100=!1,k?null:this._joinSelgeo12Data(r,a,2);for(I=0;I<_;I++)f[I]&&(f[I]=f[I].slice(L[0],L[1]+1),ot=f[I][0].Y,N[I]=GCO5.core.GcObjectUtil.cloneJson(f[I]),N[I].forEach(function(t){t.vbrute=t.Y,t.Y=100*t.Y/ot}))}else{for(I=0;I<_;I++)N[I]={};for(b in f[0]){for(var L,R=[],I=0;I<_;I++)R[I]=f[I][b]||null;if(L=this._getValidDataRange(R))for(var ot,lt=[],I=0;I<_;I++)R[I]&&(R[I]=R[I].slice(L[0],L[1]+1),ot=R[I][0].Y,lt[I]=GCO5.core.GcObjectUtil.cloneJson(R[I]),lt[I].forEach(function(t){t.vbrute=t.Y,t.Y=100*t.Y/ot}),N[I][b]=lt[I])}}M=[];function ct(t){f[t]&&M.push({className:".main.l"+(t+1),nbdec:X,label:at(t),data:f[t],datab100:N[t]||{},enabled:!0})}if(ct(0),2<_)for(I=2;I<_;I++)ct(I);return ct(1),{seriesData:M,colf_o:d,blocHasCiVars:2<=u}},_hasValidValueForIndex:function(t,e){return t.some(function(t){return t[e]&&0!==t[e].Y&&!GCO5.core.GcMathUtil.isInvalid(t[e].Y)})},_getValidDataRange:function(t){for(var e=0,i=t[0].length,n=i;e<=i;){if(this._hasValidValueForIndex(t,e)){n=e;break}e++}for(var r=i-1,a=-1;0<=r;){if(this._hasValidValueForIndex(t,r)){a=r;break}r--}return!(i<=n||n===a)&&[n,a]},_hasNa:function(t,e){return!t||!!Array.isArray(t)&&t.some(function(t){return GCO5.core.GcMathUtil.isInvalid(t[e])})},_hasNaDeep:function(t,e){if(!t)return!0;if(Array.isArray(t))return this._hasNa(t,e);for(var i in t)if(this._hasNa(t[i],e))return!0;return!1},_hasNegatives:function(t,e){return!t||!!Array.isArray(t)&&t.some(function(t){return t[e]<0})},_hasNegativesDeep:function(t,e){if(!t)return!0;if(Array.isArray(t))return this._hasNegatives(t,e);for(var i in t)if(this._hasNegatives(t[i],e))return!0;return!1},_hasAllNaOrZeros:function(t,e){return!t||!!Array.isArray(t)&&t.every(function(t){return 0==t[e]||GCO5.core.GcMathUtil.isInvalid(t[e])})},_hasAllNa:function(t,e){return!t||!!Array.isArray(t)&&t.every(function(t){return GCO5.core.GcMathUtil.isInvalid(t[e])})},getLinDef:function(n){var t=1==n.blocvar_a.length&&"R"==n.blocvar_a[0].c_id_typind,e=this._joinSelgeo12Data(n,{base100:t}),r=this;if(!e)return console.log("s0 err nodata"),{err:"nodata"};var i=e.seriesData,a=(e.colf_o,i[0].data.length);if(0==a)return console.log("s1 err nodata"),{err:"nodata"};var s,t=t&&2<=i.length&&i[0].datab100,o=(i.forEach(function(t,e){t.className=".main.l"+(e+1)}),{type:"line-dotted",xVar:"serie"==n.XAxis?"X":"label",yVar:"Y",base100:t,hasBase100Switch:t,seriesData:i,ci:e.blocHasCiVars}),l=(o.ci&&(o.ylclVar="Y_LCL",o.yuclVar="Y_UCL"),n.c_id_colfam&&(o.colf_a=n.cols.concat(["#ccc"])),0<=n.ZAxis.indexOf("filter1")&&(e=this.dashboardData.nomencs[n.filter1],o.filterMods=e.data.filter(function(t){return i[0].data.hasOwnProperty(t.id)&&(!r.dashboardData.globalFilter1||r.dashboardData.globalFilter1Id!=n.filter1||t.id==r.dashboardData.globalFilter1)&&(!n.filterModsRestriction||0<=n.filterModsRestriction.indexOf(t.id))}),o.subsetKey=n.f1code=null!==n.filterModDefault?n.filterModDefault:o.filterMods[0].id,o.subsetType="filter1",o.animate=!1,i[0].chartData=i[0].data[o.subsetKey],i[1]&&(i[1].chartData=i[1].data[o.subsetKey])),!1),c=!1,h=!0;for(s in i){var d=o.subsetKey?i[s].data[o.subsetKey]:i[s].data;l||(this._hasNaDeep(d,"Y")?l=!0:h=!1),l||c||this._hasNegativesDeep(d,"Y")&&(c=!0),!h||this._hasAllNa(d,"Y")||(h=!1)}l?(o.type="barv",o.base100=o.hasBase100Switch=!1):(c&&(o.base100=o.hasBase100Switch=!1),200<(i[0].chartData?i[0].chartData.length:a)&&(o.type="line")),o.ZERODATA=h,2<=i.length&&"barv"==o.type&&(o.legendBottom=!0),GCO5.core.GcObjectUtil.extend(o,this._getBaseChartDef(n)),o.subTitle||"indic"!=n.AAxis||(o.subTitle=n.hasRef?n.selgeo2Label:n.selgeo1Label),o.metrics={x:0,y:0},GCO5.core.GcObjectUtil.copyProps(n,o.metrics,["x","y","width","height"]);var u=n.blocvar_a[0].c_nbdec,p=GCO5.core.GcStringUtil.isEmpty(n.blocvar_a[0].c_unite)?"":" "+n.blocvar_a[0].c_unite;return o.tooltip=function(t,e){var i=t[o.yVar],i={caption:"",row_a:[{th:r.gclg.getString("PERIOD","indics"),td:t[o.xVar]},{th:o.base100?r.gclg.getString("BASE100_INDICE","report"):r.gclg.getString("VALUE"),td:r.gclg.formatNumber(i,o.base100?1:u,!0)+(o.base100?"":p)}]};return o.ci&&i.row_a.push({th:r.gclg.getString("CI","tables"),td:"["+r.gclg.formatNumber(t.Y_LCL,u,!0)+" ; "+r.gclg.formatNumber(t.Y_UCL,u,!0)+"]"}),n.hasRef&&1==n.blocvar_a.length&&i.row_a.unshift({th:r.gclg.getString("ZONE","concepts"),td:t.libgeo}),o.base100&&i.row_a.push({th:r.gclg.getString("VALUE"),td:r.gclg.formatNumber(t.vbrute,0,!0)}),i},o},getBavDef:function(a){var t=this._joinSelgeo12Data(a,{epsilon:!1,removeTotal:!0}),s=this,e=(a.hasRef&&a.pkgeo2,a.pkref,t.seriesData.slice(0,2)),o=(2<t.seriesData.length&&(e=[t.seriesData[0]].concat(t.seriesData[t.seriesData.length-1])),t.colf_o,a.series),l=a.blocvar_a,i=t.blocHasCiVars;if(i)if(a.colf_a=(a.colf_a||["#33cc66","#ffcc00","#ff0000"]).concat(["#ccc"]),0<=a.ZAxis.indexOf("filter1")){var n=e[0].data,r=e[1].data;for(f in n){var c,h=n[f],d=r[f];for(c in h){var u=h[c],p=d[c].Y;u.compar=1,p<u.Y_LCL?u.compar=u.highIsBad?2:0:p>u.Y_UCL&&(u.compar=u.highIsBad?0:2),d[c].compar=3}}}else{n=a.curSerie&&!Array.isArray(e[0].data)?e[0].data[a.curSerie]:e[0].data,r=a.curSerie&&!Array.isArray(e[1].data)?e[1].data[a.curSerie]:e[1].data;n.forEach(function(t,e){var i=r[e].Y;t.compar=1,i<t.Y_LCL?t.compar=t.highIsBad?2:0:i>t.Y_UCL&&(t.compar=t.highIsBad?0:2),r[e].compar=3})}if(0==e[0].data.length)return{err:"nodata"};var g={type:"barv",xVar:"label",yVar:"Y",colf_a:a.colf_a,legendBottom:!0,seriesData:e,metrics:{},ci:i,fullBlocInfo:a};if(o&&1<=o.length&&0<=a.ZAxis.indexOf("serie")){var f,m=[];for(f in e[0].data)!(n=e[0].data[f]).every(function(t){return s._isSpecificValueOrNotNumeric(t.Y)})&&0<=a.validSeries.indexOf(f)&&m.push(f),i&&(r=e[1].data[f],n.forEach(function(t,e){var i=r[e].Y;t.compar=1,i<t.Y_LCL?t.compar=t.highIsBad?2:0:i>t.Y_UCL&&(t.compar=t.highIsBad?0:2),r[e].compar=3}));g.filterMods=m,g.subsetKey=a.curSerie,g.subsetType="serie",g.animate=1<o.length}if(0<=a.ZAxis.indexOf("filter1")){var _,t=this.dashboardData.nomencs[a.filter1];if(s.dashboardData.globalFilter1Id==a.filter1&&(a.f1code=s.dashboardData.globalFilter1),g.filterMods=t.data.filter(function(t){return e[0].data.hasOwnProperty(t.id)&&(!s.dashboardData.globalFilter1||s.dashboardData.globalFilter1Id!=a.filter1||t.id==s.dashboardData.globalFilter1)&&(!a.filterModsRestriction||0<=a.filterModsRestriction.indexOf(t.id))}),0==g.filterMods.length)return{err:"nodata",ZERODATA:!0,subTitle:"momo"};g.subsetKey=a.f1code=g.filterMods[0].id,g.subsetType="filter1",g.animate=!1,a.curSerie&&0<=a.ZAxis.indexOf("serie")&&((_={})[a.serie]=a.curSerie,g.filterMods.forEach(function(t){e[0].data[t.id]=GCO5.core.GcArrayUtil.getSubArray(e[0].data[t.id],_),e[1]&&(e[1].data[t.id]=GCO5.core.GcArrayUtil.getSubArray(e[1].data[t.id],_))}))}t=g.subsetKey?e[0].data[g.subsetKey]:e[0].data;return g.ZERODATA=this._hasAllNaOrZeros(t,"Y"),i&&(g.ci=!0,g.zonreflib=a.selgeo2Label||a.zonreflib),a.vrefline&&i&&(t=g.subsetKey?e[1].data[g.subsetKey]:e[1].data,g.yrefVal=t[0].Y,g.seriesData=[e[0]],g.zonreflib=a.zonreflib),0<l[0].c_valmax&&(g.ymaxVal=l[0].c_valmax),g.tooltip=function(t,e){var i=t.hasOwnProperty(g.yVar+"0")?t[g.yVar+"0"]:t[g.yVar],n=GCO5.core.GcArrayUtil.getSubArray(l,{c_id_variable:t.X}),n=(1==n.length?n:l)[0],r=GCO5.core.GcStringUtil.isEmpty(n.c_unite)?"":" "+n.c_unite,n=n.c_nbdec||0,i={caption:t[g.xVar],row_a:[{th:s.gclg.getString("VALUE"),td:s.gclg.formatNumber(i,n,!0)+r}]};return a.hasRef&&i.row_a.unshift({th:s.gclg.getString("ZONE","concepts"),td:t.libgeo}),o&&"serie"!=a.XAxis&&i.row_a.push({th:s.gclg.getString("PERIOD","indics"),td:a.curSerie}),g.ci&&i.row_a.push({th:s.gclg.getString("CI","tables"),td:"["+s.gclg.formatNumber(t.Y_LCL,n,!0)+" ; "+s.gclg.formatNumber(t.Y_UCL,n,!0)+"]"}),t.hasOwnProperty("compar")&&t.compar<3&&i.row_a.push({th:"",td:s.gclg.getString(["SBETTER_AVG","NOTSDIFF_AVG","SWORST_AVG"][t.compar],"report")+(1!=t.compar?" / "+g.zonreflib:"")}),i},GCO5.core.GcObjectUtil.extend(g,this._getBaseChartDef(a)),GCO5.core.GcObjectUtil.copyProps(a,g.metrics,["x","y","width","height"]),1!==g.seriesData.length&&!i||(g.subTitle=this._getSubtitle(a)),g},getBahDef:function(i){var t,n,r=this,e=[],a=i.datasetData,s=i.series,o=i.indic_a[0],l=[];if("G"==i.YAxis){var c=i.territories;if(i.curSerie&&(c=c[i.curSerie]),i.f1code&&(c=c[i.f1code]),!(t=GCO5.core.GcArrayUtil.getColumnByKey(c,"id")))return console.warn("erreur : territoires non définis",i.curSerie,i),{err:"nodata",ZERODATA:!0};for(var h=0;h<t.length;h++)var d=c[h].id,u=GCO5.core.GcObjectUtil.cloneJson(a[d]).map(function(t){return t.idgeo=d,t.libgeo=c[h].title,t.X=t[o],t}),l=l.concat(u)}else"I"==i.YAxis?l=GCO5.core.GcObjectUtil.cloneJson(a[i.pkgeo]).map(function(t){return t.idgeo=t.code,t.libgeo=i.mods_o[t.code],t.X=t.eft,t}).filter(function(t){return 0<t.X}):"F"==i.YAxis&&(n=this._getFilter1Table(i.filter1,!0),l=GCO5.core.GcObjectUtil.cloneJson(a[i.pkgeo]).map(function(t){var e;return t.idgeo=t[i.filter1],t.libgeo=(e=t[i.filter1],n[e]?n[e].lib:e),t.X=t[o],t}).filter(function(t){return 0<t.X&&!GCO5.core.GcStringUtil.hasOnlyZeros(t.idgeo)}));var e=l,p={},g=(i.series&&1<i.series.length?(d3.nest().key(function(t){return t[i.serie]}).sortKeys(d3.ascending).entries(l).forEach(function(t){p[t.key]=t.values.sort(function(t,e){return t.X-e.X}),GCO5.core.GcMathUtil.isNumber(i.nbItemsMax)&&0<i.nbItemsMax&&(p[t.key]=p[t.key].slice(Math.max(0,p[t.key].length-i.nbItemsMax),p[t.key].length))}),e=p[i.curSerie]):(p=e=e.sort(function(t,e){return t.X-e.X}),GCO5.core.GcMathUtil.isNumber(i.nbItemsMax)&&0<i.nbItemsMax&&(p=e=e.slice(Math.max(0,e.length-i.nbItemsMax),e.length))),i.blocvar_a&&0<i.blocvar_a.length?i.blocvar_a[0].c_nbdec:0),f={type:"barh",xVar:"X",yVar:"libgeo",fullBlocInfo:i,colf_a:i.colf_a||null,seriesData:[{className:".main.l1",label:"",data:p,chartData:e,enabled:!0,nbdec:g}]};return s&&1<=s.length&&0<=i.ZAxis.indexOf("serie")&&(f.filterMods=i.validSeries,f.subsetKey=i.curSerie,f.subsetType="serie",f.animate=1<s.length),GCO5.core.GcObjectUtil.extend(f,this._getBaseChartDef(i)),"I"!=i.YAxis&&"F"!=i.YAxis||(f.subTitle=this._getSubtitle(i)),f.metrics={},GCO5.core.GcObjectUtil.copyProps(i,f.metrics,["x","y","width","height"]),f.tooltip=function(t,e){var i=t[f.xVar];return{caption:t[f.yVar],row_a:[{th:r.gclg.getString("VALUE"),td:r.gclg.formatNumber(i,g,!0)}]}},f},getTxtDef:function(t){var e=t.text,e={text:e=GCO5.browser.isKitchen?e&&e.replace(/(\"|\')assets\//,"$1../assets/"):e,metrics:{},type:"TXT",css:t.css};return GCO5.core.GcObjectUtil.extend(e,this._getBaseChartDef(t)),GCO5.core.GcObjectUtil.copyProps(t,e.metrics,["x","y","width","height"]),e},getMapDef:function(t){var e=t.pkgeo.split("@"),i={type:"MAP",nivgeo:e[0],codgeo:e[1],styles:{mouseEventList:{mouseMove:1},noZoomAnim:!0},indic:t.id_dataset+"."+t.blocvar_a[0].c_id_variable,metrics:{}},e=(GCO5.core.GcObjectUtil.extend(i,this._getBaseChartDef(t)),GCO5.model.maps.SelGeo.cloneSelgeo(this.dashboardData.selgeo));return i.mapdef_o={nivgeo:i.nivgeo,selgeo:e},t.blocvar_a[0].c_views&&(e=GCO5.appModel.getConcept("view").map(function(t){return t.c_id_view}),(e=GCO5.core.GcArrayUtil.intersection(e,t.blocvar_a[0].c_views)).some(function(t){return GCO5.appModel.getInfo("infoFromMapName",[t,"id_nivgeo"])==i.nivgeo})||(i.mapdef_o.nivgeo=GCO5.appModel.getInfo("infoFromMapName",[e[0],"id_nivgeo"]))),GCO5.core.GcObjectUtil.copyProps(t,i.metrics,["x","y","width","height"]),i.subTitle=this._getSubtitle(t),i},getUsableSeries:function(t,e,i){var n,r=[];for(n in GCO5.core.GcArrayUtil.nest(t,e))0<=i.indexOf(n)&&r.push(n);return r.sort()},getFilter1Lib:function(t,e){t=GCO5.core.GcArrayUtil.toIndexedObj(this.dashboardData.nomencs[t].data,"id");return t[e]?t[e].lib:null},getSpineDef:function(t){for(var e=[],i=t.pkgeo,n=t.blocvar_a,r=GCO5.appModel.getConcept("dataset_o"),t={type:"SPC",fullBlocInfo:t,libgroupvar:this.gclg.getString("INDICS2","concepts"),selLabel:this.gclg.getString("VALUE")},a=0;a<n.length;a++){var s=n[a],o=this.dashboardData.data[s.c_id_dataset][i],l=r[s.c_id_dataset],c={},h=(l.filter1&&(h=this.dashboardData.nomencs[l.filter1].data,c[l.filter1]=h[0].id,o=GCO5.core.GcArrayUtil.getSubArray(o,c)),(o=l.varserie||Array.isArray(o)?o.concat().pop():o)[s.c_id_variable]),c=l.varserie?String(o[l.varserie]):null,o=GCO5.core.GcStringUtil.isEmpty(s.c_unite)?"":" ("+s.c_unite+")",l={VALSEL:this._getDisplayValue(h,!0),INDS:s.c_lib_court.split("|").join(" ")+o+(c?" - "+c:""),INDSL:s.c_lib_long+o+" "+(c?" - "+c:""),IND:s.c_id_dataset+"."+s.c_id_variable,isIndic:!1,SERIE:c,nbdec:s.c_nbdec,typind:s.c_id_typind||"C"};e.push(l)}return t.v_a=e,t},getTableDef_getFullBlocStruct:function(t){return"filter1"==t.XAxis?"LIST_FILTER1":"serie"==t.XAxis?"SERIE":"mods"==t.XAxis&&"TAC"!=t.type&&"G"==t.YAxis?"LIST_ALL_UNITS":"SEL_INDICS"},getTableDef_getFilteredDataset:function(t,e,i,n,r){var a={},s={};if(s[t.filter1]=[t.f1code],a[i]=GCO5.core.GcArrayUtil.getSubArray(e[i],s),n&&(a[n]=GCO5.core.GcArrayUtil.getSubArray(e[n],s)),r)for(var o=0;o<r.length;o++)a[r[o]]=GCO5.core.GcArrayUtil.getSubArray(e[r[o]],s);return a},getTableDef_getLibGroupVar:function(t){var e=t.struct,t=t.libgroupvar;return GCO5.core.GcStringUtil.isEmpty(t)&&("SEL_INDICS"===e&&(t=this.gclg.getString("INDICS2","concepts")),"LIST_FILTER1"===e&&(t=""),"SERIE"===e&&(t=this.gclg.getString("PERIODS","indics"))),t},getTableDef_getModsForI:function(t){var e={};if(t)for(var i=0;i<t.length;i++)if("I"==t[i].c_id_typind){for(var n=t[i].c_classes.split("|"),r=t[i].c_classeslib.split("|"),a={},s=0;s<n.length;s++)a[n[s]]=r[s];e[t[i].c_id_variable]=a}return e},getTableDef:function(i){var t,e=[],n=this,r=i.is_ref?i.pkref:i.terrBase||i.pkgeo,a=0<i.nbComparisonRefAxis?i.pkgeo2:null,s=i.struct=this.getTableDef_getFullBlocStruct(i),o=i.type,l=i.serie,c=i.filter1,h=i.blocvar_a,d=i.curSerie,u=GCO5.core.GcObjectUtil.cloneJson(i.datasetData),R="1"==GCO5.appModel.getOption("noCompArrowsInTable"),k=0<i.nbComparisonRefAxis,p=(i.terrInterm&&(t=GCO5.core.GcArrayUtil.getColumnByKey(i.terrInterm,"id")),this.getTableDef_getModsForI(h));if(0<=i.ZAxis.indexOf("filter1")){var g=this.dashboardData.nomencs[i.filter1],f=(n.dashboardData.globalFilter1Id==i.filter1&&(i.f1code=n.dashboardData.globalFilter1),g.data.filter(function(t){return 0<=GCO5.core.GcArrayUtil.indexOfByKey(u[r],i.filter1,t.id)&&(!n.dashboardData.globalFilter1||n.dashboardData.globalFilter1Id!=i.filter1||t.id==n.dashboardData.globalFilter1)&&(!i.filterModsRestriction||0<=i.filterModsRestriction.indexOf(t.id))})),m=GCO5.core.GcArrayUtil.toIndexedObj(this.dashboardData.nomencs[i.filter1].data,"id");null!==i.filterModDefault&&null==i.f1code&&(i.f1code=i.filterModDefault);var F=m[N=i.f1code||(0<f.length?f[0].id:n.dashboardData.globalFilter1)]?i.c_subtitle?i.c_subtitle+" - "+m[N].lib:m[N].lib:null;if(0==f.length)return{err:"nodata",source:i.source,type:o,subTitle:F,id_grid_item:this.curIdChapter+"*"+i.c_id_dataviz+i.c_id_grid_item,fullBlocInfo:i};i.f1code||(i.f1code=f[0].id)}if(!(u=!i.f1code||"LIST_ALL_UNITS"==s&&"TAC"!=o?u:this.getTableDef_getFilteredDataset(i,u,r,a,t))[r]||0===u[r].length)return{err:"nodata"};var V=!1,_=this.getTableDef_getLibGroupVar(i),_={id_grid_item:this.curIdChapter+"*"+i.c_id_dataviz+i.c_id_grid_item,id_bloc:i.c_id_block,libgroupvar:_,terrRef:i.terrRef,struct:i.struct,type:i.type,title:i.title,source:i.source,subTitle:i.c_subtitle,note:i.c_note,fullBlocInfo:i};if(!GCO5.browser.isKitchen&&this.chapterModel.selgeo1&&(_.selgeo1=this.chapterModel.selgeo1,_.id_view=this.chapterModel.selgeo1.getIdView()),i.curSerie&&"SERIE"!=s&&(_.filterMods=this.getUsableSeries(u[r],i.serie,i.validSeries),_.filterMods.indexOf(i.curSerie)<0&&(i.curSerie=_.filterMods[_.filterMods.length-1]),_.subsetKey=i.curSerie,_.subsetType="serie"),0<=i.ZAxis.indexOf("filter1")&&(_.subsetKey=i.f1code,_.subsetType="filter1",_.filterMods=f,_.subTitle=F),i.hasRef&&i.terrInterm&&(_.terrInterm=i.terrInterm),"SERIE"==s&&1<h.length){a&&u[a]&&(J={},Q={},D=u[r],E=u[a],D.forEach(function(t,e){J[t[i.serie]]=e}),E.forEach(function(t,e){Q[t[i.serie]]=e}));for(var v=0,U=u[r].length;v<U;v++){for(var y={SERIE:(I=u[r][v])[i.serie]},b=0;b<h.length;b++){var C=I[(M=h[b]).c_id_variable],x=(this._isSpecificValue(C)||"I"!=M.c_id_typind?this._isSpecificValue(C)&&(C=this._getDisplayStrForSpecificValues(C)):C=p[M.c_id_variable][C],y["v"+b]=C,Q?Q[I[i.serie]]:v),w=a&&u[a]&&void 0!==x?u[a][x][M.c_id_variable]:null;this._isSpecificValue(w)||"I"!=M.c_id_typind?this._isSpecificValue(w)&&(w=this._getDisplayStrForSpecificValues(w)):w=p[M.c_id_variable][w],y["vref"+b]=w}e.push(y)}_.v_a=e}else if(0<=["SEL_INDICS","SERIE"].indexOf(s)&&"TAC"!=o){var $={};if("SERIE"==s&&(u[r]=u[r].filter(function(t){return 0<=i.validSeries.indexOf(t[l])}),u[a]&&(u[a]=u[a].filter(function(t){return 0<=i.validSeries.indexOf(t[l])}))),a&&u[a])for(v=0;v<u[a].length;v++)$[u[a][v][l]]=v;if(!u[r])return{err:"dataset "+i.id_dataset+" absent"};"SERIE"==s&&(M=h[0]);for(var S,B=a&&u[a]&&0<u[a].length,v=0;v<u[r].length;v++)for(var x=l?$[u[r][v][l]]:0,z=l?String(u[r][v][l]):null,b=0;b<h.length;b++){var M=h[b],O=u[r][v][M.c_id_variable],G=("I"!=M.c_id_typind||this._isSpecificValue(O)||(O=p[M.c_id_variable][O]),!B||null==x?null:u[a][x][M.c_id_variable]),j=GCO5.core.GcStringUtil.isEmpty(M.c_unite)?"":" ("+M.c_unite+")",I={VAL0:this._getDisplayValue(G,!1),VALSEL:this._getDisplayValue(O,!1),INDS:"SERIE"==s?z:M.c_lib_court.split("|").join(" ")+j,INDSL:M.c_lib_long+j+" "+(z?" - "+z:""),IND:i.c_id_dataset+"."+M.c_id_variable,isIndic:"A"==M.c_output&&"SERIE"!=s,SERIE:z,nbdec:M.c_nbdec||0,typind:M.c_id_typind||"C"};if("SERIE"==s&&(I.SERIE=I.INDS),t)for(var H=0;H<t.length;H++){var W=null!=x&&u[t[H]]?u[t[H]][x][M.c_id_variable]:null;I["VAL"+(H+1)]=this._getDisplayValue(W,!0,GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA)}I.comp=-1,"SERIE"!=s&&"C"==M.c_id_typind&&k&&(I.comp=0,I.symb="",I.class="",!R&&!this._isSpecificValueOrNotNumeric(G)&&!this._isSpecificValueOrNotNumeric(O)&&.01<Math.abs((O-G)/(O+G))&&(I.comp=G<O?2:1,I.symb=G<O?"▲":"▼",I.class="score plm "+(1==M.c_highisbad&&G<O||0==M.c_highisbad&&O<G?"red":"green"),V=!0)),e.push(I)}"SEL_INDICS"==s&&l&&"E"==i.computed_col&&(f=1==i.nbPeriods?(x=i.validSeries.indexOf(d),i.validSeries[Math.max(0,x-1)]):i.validSeries[i.validSeries.length-i.nbPeriods],0<(X=GCO5.core.GcArrayUtil.getSubArray(e,{SERIE:[f]})).length&&(S=GCO5.core.GcArrayUtil.toIndexedObj(X,"IND"),f!=i.curSerie&&(_.evol=this.gclg.getString("EVOL_ABB","report")+"<br>"+f+"-"+i.curSerie),e.forEach(function(t){t.EVOL_VAL0=n._isSpecificValueOrNotNumeric(S[t.IND].VAL0)||0==S[t.IND].VAL0?n.gclg.getString("NA","indics"):n.gclg.formatNumber(100*(t.VAL0-S[t.IND].VAL0)/S[t.IND].VAL0,1)+"&nbsp;%",t.EVOL_VALSEL=n._isSpecificValueOrNotNumeric(S[t.IND].VALSEL)||0==S[t.IND].VALSEL?n.gclg.getString("NA","indics"):n.gclg.formatNumber(100*(t.VALSEL-S[t.IND].VALSEL)/S[t.IND].VALSEL,1)+"&nbsp;%"})));var X="SERIE"!=s&&l?GCO5.core.GcArrayUtil.getSubArray(e,{SERIE:[i.curSerie]}):e;_.v_a=X,R||(_.score=V)}else if("LIST_ALL_UNITS"==s&&"TAC"!=o){var m={},Y=(l&&(m[l]=[d]),N&&(m[c]=[N]),i.territories);for(b in d&&(Y=Y[d]),Y=N?Y[N]:Y){g=Y[b];if("DETAIL"==g.type){I={codgeo:g.codgeo,libgeo:g.title};d&&(I[l]=d);for(v=0;v<h.length;v++){var T=h[v].c_id_variable;u[g.id]?(GCO5.core.GcObjectUtil.isEmpty(m)?(I[T]=u[g.id][0][T],I[T]=n._getDisplayValue(I[T],!1,GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA)):(X=GCO5.core.GcArrayUtil.getSubArray(u[g.id],m),I[T]=0==X.length?null:n._getDisplayValue(X[0][T],!1,GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA)),"I"==h[v].c_id_typind&&I[T]!==n.gclg.getString("NAMQ_SHORT","indics")&&(I[T]=p[T][I[T]])):I[T]=null}e.push(I)}}_.v_a=e,_.blocvar_a=h,!_.filterMods&&0<=i.ZAxis.indexOf("serie")&&(_.filterMods=this.getUsableSeries(e,i.serie,i.series),(!i.curSerie||_.filterMods.indexOf(i.curSerie)<0)&&(i.curSerie=_.filterMods[_.filterMods.length-1]))}else if("SERIE"!=s||"TAB"!=o||i.terrRef)if("TAC"==o)_=this.getTableDef_forTAC(_,i,u,r,a,l,s,c);else{if("LIST_FILTER1"!=s)return console.warn("struct",s,o,i),{err:"structure invalide "+s+" "+o};var m=this._getFilter1Table(c,!0),q=this._getFilter1Table(c);if(i.hasRef&&a){var A,P,K,Z,J={},Q={},D=u[r],E=u[a];t&&(A=u[t[0]],P=1<t.length?u[t[1]]:null,K={},Z={}),GCO5.core.GcStringUtil.isEmpty(d)||(D=D.filter(function(t){return t[i.serie]==d}),E=E&&E.filter(function(t){return t[i.serie]==d}),A=A&&A.filter(function(t){return t[i.serie]==d}),P=P&&P.filter(function(t){return t[i.serie]==d})),D.forEach(function(t,e){J[t[c]]=e}),E&&E.forEach(function(t,e){Q[t[c]]=e}),A&&A.forEach(function(t,e){K[t[c]]=e}),P&&P.forEach(function(t,e){Z[t[c]]=e});for(b in q){var N=q[b].id;if((null!=J[N]||void 0!==Q[N])&&!(i.filterModsRestriction&&i.filterModsRestriction.indexOf(N)<0)){m[N]&&m[N].lib;GCO5.core.GcStringUtil.hasOnlyZeros(N)&&m[N]&&m[N].lib;for(y={f1lib:m[N]?m[N].lib:N},b=0;b<h.length;b++){var L,M=h[b],C=void 0===(v=J[N])?this._getDisplayStrForSpecificValues(GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA):D[v][M.c_id_variable],w=("I"!=M.c_id_typind||this._isSpecificValue(C)||(C=p[M.c_id_variable][C]||C),!GCO5.core.GcStringUtil.isEmpty(d)&&void 0!==v&&D[v]&&(y.SERIE=D[v][i.serie]),void 0===(v=Q[N])?GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA:E[v][M.c_id_variable]);"I"!=M.c_id_typind||this._isSpecificValue(w)||(w=p[M.c_id_variable][w]||w),y["v"+b]=this._getDisplayValue(C,!1,GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA),y["vref"+b]=this._getDisplayValue(w,!1,GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA),t&&t[0]&&(L=void 0===(v=K[N])?this._getDisplayStrForSpecificValues(GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA):A[v][M.c_id_variable],"I"!=M.c_id_typind||this._isSpecificValue(L)||(L=p[M.c_id_variable][L]||L),y["vref0"+b]=this._isSpecificValue(L)?this._getDisplayStrForSpecificValues(GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA):L),t&&t[1]&&(L=void 0===(v=Z[N])?this._getDisplayStrForSpecificValues(GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA):P[v][M.c_id_variable],"I"!=M.c_id_typind||this._isSpecificValue(L)||(L=p[M.c_id_variable][L]||L),y["vref1"+b]=this._isSpecificValue(L)?this._getDisplayStrForSpecificValues(GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA):L),0==b&&y["v"+b]==this._getDisplayStrForSpecificValues(GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA)&&0,1==h.length&&(y.IND=i.c_id_dataset+"."+M.c_id_variable,y.isIndic="A"==M.c_output,y.f1code=N)}e.push(y)}}10<e.length&&1==h.length&&(e=e.filter(function(t){return t.v0!=n._getDisplayStrForSpecificValues(GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA)}),1!==this.dashboardData.nomencs[i.filter1].meta.c_is_ordered&&(e=e.sort(function(t,e){return e.v0-t.v0})))}else for(v=0;v<u[r].length;v++){N=(I=u[r][v])[c];if(!(i.filterModsRestriction&&i.filterModsRestriction.indexOf(N)<0)&&m[N]){var tt,et,y={f1lib:m[N]?m[N].lib:N};1==h.length&&"O"==h[0].c_id_typind&&(tt=this.dashboardData.refdata[r.split("@")[0]],et=GCO5.core.GcArrayUtil.toIndexedObj(tt,"codgeo"));for(b=0;b<h.length;b++){C=I[(M=h[b]).c_id_variable];"I"!=M.c_id_typind||this._isSpecificValue(C)||(C=p[M.c_id_variable][C]||C),y["v"+b]=this._getDisplayValue(C,!1),et&&et[C]&&(y["v"+b]+=" - "+et[C].libgeo),GCO5.core.GcStringUtil.isEmpty(d)||(y.SERIE=I[i.serie]),y.IND=i.c_id_dataset+"."+M.c_id_variable,y.isIndic="A"==M.c_output,y.f1code=N}e.push(y)}}_.v_a=GCO5.core.GcStringUtil.isEmpty(d)?e:GCO5.core.GcArrayUtil.getSubArray(e,{SERIE:[d]})}else{for(var v=0;v<u[r].length;v++){var M=h[0],O=u[r][v][M.id],z=l?String(u[r][v][l]):null,I={v:this._getDisplayValue(O,!1),INDS:z,INDSL:M.lib_long+" "+(z||""),isIndic:!1,nbdec:M.nbdec,typind:M.c_id_typind};e.push(I)}_.v_a=e}M&&(_.indic_o=M),(0<=i.ZAxis.indexOf("serie")||"SERIE"!=s)&&i.curSerie&&(_.source+=" - "+i.curSerie);F="VI_COUNT"==s?" (%)":"";return _.refLabel=(i.selgeo2Label||i.zonreflib)+F,_.selLabel=i.selgeo1Label+F,"SERIE"!=s||i.terrRef||(_.selLabel=M.lib_court),_.metrics={},GCO5.core.GcObjectUtil.copyProps(i,_.metrics,["x","y","width","height"]),_},getTableDef_forTAC:function(t,e,i,n,r,a,s,o){var l,c,h=this._getTACSubType(e)!==GCO5.model.dashboard.GcDatavizModel.TAC_SUB_TYPE.LIST_INDICS,d=this._joinSelgeo12Data(e,{removeTotal:!0,totalize:h,maxZone:2}),u=d.seriesData[0].data;if(e.hasRef&&1<d.seriesData.length&&(l=d.seriesData[1].data),0<=e.ZAxis.indexOf("filter1")?(u=u[e.f1code],l=l&&l[e.f1code],0<=e.ZAxis.indexOf("serie")&&((d={})[e.serie]=e.curSerie,u=GCO5.core.GcArrayUtil.getSubArray(u,d),l=l&&GCO5.core.GcArrayUtil.getSubArray(l,d))):0<=e.ZAxis.indexOf("serie")&&(u=u[e.curSerie],l=l&&l[e.curSerie]),h)if(0<u.length&&!u[0].hasOwnProperty("_TOT_")){for(var p=0,g=0,f=0,m=u.length;f<m;f++){var _=u[f];if(this._isSpecificValueOrNotNumeric(_.Y)){p=this.gclg.getString("NA","indics");break}"_TOT_"!=u[f].X&&(p+=_.Y||0)}if(l)for(f=0,m=l.length;f<m;f++){if(this._isSpecificValueOrNotNumeric(l[f].Y)){g=this.gclg.getString("NA","indics");break}"_TOT_"!=l[f].X&&(g+=l[f].Y||0)}}else 0<u.length&&u[0].hasOwnProperty("_TOT_")&&(p=u[0]._TOT_,l&&(g=l[0]._TOT_));else{d=i[n],h=r?i[r]:null;if(0<=e.ZAxis.indexOf("serie")&&(d=d.filter(function(t){return t[a]===e.curSerie}),h=h?h.filter(function(t){return t[a]===e.curSerie}):null),0<=e.ZAxis.indexOf("filter1")&&(d=d.filter(function(t){return t[o]===e.f1code}),h=h?h.filter(function(t){return t[o]===e.f1code}):null),0===d.length||null!==h&&0===h.length)return{err:"Error in dataSet, dataset not found for current serie and filter1"};p=d[0][e.c_id_block+"_tot"],g=h?h[0][e.c_id_block+"_tot"]:null}for(f=0,m=u.length;f<m;f++){var _=u[f],v=(this._isSpecificValueOrNotNumeric(_.Y)?(_.v0=this._getDisplayStrForSpecificValues(_.Y),_.v1=this.gclg.getString("NA","indics")):(_.v0=_.Y,_.v1=0===p||this._isSpecificValueOrNotNumeric(p)?this.gclg.getString("NA","indics"):100*_.v0/p),l&&(v=l[f],this._isSpecificValueOrNotNumeric(v.Y)?(_.vref0=this._getDisplayStrForSpecificValues(v.Y),_.vref1=this.gclg.getString("NA","indics")):(_.vref0=v.Y,_.vref1=0===g||this._isSpecificValueOrNotNumeric(g)?this.gclg.getString("NA","indics"):100*_.vref0/g)),"_TOT_"===_.X&&(c=!0),e.blocvar_a.filter(function(t){return t.c_id_variable===_.X&&"A"===t.c_output}));_.isIndic=1===v.length&&"SERIE"!==s,_.isIndic&&(_.IND=e.c_id_dataset+"."+_.X)}c||(n={label:this.gclg.getString("TOTAL"),v0:this._getDisplayValue(p,!0),v1:this._isSpecificValueOrNotNumeric(p)?this.gclg.getString("NA","indics"):100,vref0:null,vref1:null},l&&(n.vref0=this._getDisplayValue(g,!0),n.vref1=this._isSpecificValueOrNotNumeric(g)?this.gclg.getString("NA","indics"):100),u.push(n));i=2===e.blocvar_a.length&&0<=GCO5.core.GcArrayUtil.indexOfByKey(e.blocvar_a,"c_id_typind","I");return t.libgroupvar=i?e.blocvar_a[0].c_lib_court:"",t.v_a=u,t.cols_a=[{c_lib_court:i?e.blocvar_a[1].c_lib_court:e.blocvar_a[0].c_unite||this.gclg.getString("NB"),c_nbdec:0},{c_lib_court:"%",c_nbdec:1}],t},isPublic:function(){return this.dvz_o&&this.dvz_o.c_opened||!this.dvz_o&&this.dashboardData.report&&this.dashboardData.report.c_opened},_getTACSubType:function(t){return"TAC"===t.type&&("LIST_FILTER1"===t.struct?GCO5.model.dashboard.GcDatavizModel.TAC_SUB_TYPE.LIST_FILTER1:"SEL_INDICS"===t.struct?"mods"===t.XAxis?GCO5.model.dashboard.GcDatavizModel.TAC_SUB_TYPE.LIST_MODS:GCO5.model.dashboard.GcDatavizModel.TAC_SUB_TYPE.LIST_INDICS:void 0)}}),GCO5.model.dashboard.GcChapterModel=GCO5.Class.extend({statics:{NAME:"GCO5.model.dashboard.GcChapterModel",PAGE_BREAK_BEFORE_CLASS:"always-pbb",SINGLEBLOCK_DVZ:"singleBlockDvz"},dashboardData:null,curIdChapter:null,curIdReport:null,storeMultiPagesData:!1,gclg:null,dvz_o:null,$container:null,ca:null,cli:null,displayed:null,transitionTiming:null,lastFrame:null,inc:null,selgeo1:null,lastIframeContentHeight:null,lastIframeContentWidth:null,initialize:function(n){this.gclg=GCO5.core.GcLangManager.getInstance(),this._setup(n),this.lastFrame=0,n&&n.callback&&n.context&&($.templates.pageReportSynthTable?n.callback.apply(n.context):$.get(n.urlTableTmpl||"js/tables_tmpl.html",function(t){var e={},i=GCO5.core.GcLangManager.getInstance();$(t).each(function(){this.id&&(e[this.id.split("_")[0]]=i.injectLocaleStrings($(this).html()))}),$.templates(e),$.views.helpers({formatNumber:$.proxy(i.formatNumber,i),proper:GCO5.core.GcStringUtil.proper,isEmpty:GCO5.core.GcStringUtil.isEmpty}),n.callback.apply(n.context)}))},_setup:function(t){this.$container=(t=t||{}).container,this.dashboardData={},this.dvz_o={},this.ca=t.ca,this.transitionTiming=t.transitionTiming,this.lastIframeContentHeight=this.lastIframeContentWidth=0,this.cli=GCO5.core.ClientInfo.getInstance()},genHtmlForBloc:function(t,i,e,n,r,a){var s,o=this,l=t.report.datavizs||t.report.chapters[0].dataviz,c=e?GCO5.core.GcArrayUtil.indexOfByKey(l,"c_id_dataviz",e):0,l=(e=l[c].c_id_dataviz,l[c].blocks),c=l[n?GCO5.core.GcArrayUtil.indexOfByKey(l,"c_id_block",n):0],l=i.closest(".report-container"),h=(0==l.length&&(l=i),new GCO5.model.dashboard.GcDatavizModel({container:l,chapterModel:o})),d=0,u=i.closest(".tab-content");0==o.transitionTiming&&(d=3,u.css("min-height","2000px"),0==o.lastFrame?o.lastFrame=GCO5.core.GcDelayUtil.curFrame()+d:(n=GCO5.core.GcDelayUtil.curFrame()-o.lastFrame-(d+1))<0?(d=-n,o.lastFrame=GCO5.core.GcDelayUtil.curFrame()+d):o.lastFrame=GCO5.core.GcDelayUtil.curFrame()+1),this.kitchenComposingBlocs=o.lastFrame;return h.dashboardData=t,h.curIdDataviz=e,h.getDefFromIdBloc(c.c_id_block,c.c_block_type,function(t){var e={fullHTML:!0,report:!0,timing:GCO5.browser.isKitchen?0:750};i.addClass("dv-"+t.type.toLowerCase()),e.chartOuterHeight=function(){return h._chartOuterHeight.call(h,t.type,t,s)},GCO5.core.GcDelayUtil.callLater(function(){i.is(":visible")?(t.datavizModel=h,t.id_grid_item="singleBlock",s=new GCO5.view.component.D3ChartContainer(i,t,e),h.addSingleBlockToDvzGrid(s),r&&r.apply(a,[s])):console.warn("erreur : tentative de dessin chart dans un container non visible",this._$blocContainer.attr("id"),def_o)},[],d,o),GCO5.core.GcDelayUtil.callLater(function(){i.is(":visible")&&($(document).trigger("enhance"),0==o.transitionTiming&&GCO5.core.GcDelayUtil.curFrame()>o.kitchenComposingBlocs&&u.css("min-height","0"),h.sendMessageToIframe())},[],20+d,o)},this),h},getTerritoryByType:function(t){for(var e in this.dashboardData.territories){e=this.dashboardData.territories[e];if(t&&e.selNum==t)return e}return null},getTerritoryInfo:function(t,e){t=GCO5.core.GcArrayUtil.getSubArray(this.dashboardData.territories,{id:t});return 0==t.length?null:t[0][e]},resetForNewReport:function(){this.curIdChapter=null},_getTerritoryPkByType:function(t,e){for(var i in(e=e||this.dashboardData).territories){i=e.territories[i];if(t&&i.selNum==t)return i.id;if(isRef&&i.type==isRef&&"REF"==isRef)return i.id}return null},_loadPresMapImg:function(t,e,i){var n=t.getSingleCodgeo(),r=$("#presmap",this.$container).find(".presmap-img"),a="GC_make_map.php?width=700&format="+i+"&globe="+e+"&lang="+GCO5.appModel.getLang();r.hide(),r.one("load",function(){r.show()}),n?(a+="&nivgeo="+(n=t.getPkGeo().split("|"))[0]+"&codgeo="+n[1],t.getIdView()&&(a+="&view="+t.getIdView()),r.attr("src",a)):GCO5.appModel.loadMapImageWithSel({view:t.getIdView(),selIds:t.getSelIds(),format:i,globe:e,w:700},function(t){r.attr("src",window.URL.createObjectURL(t))},this)},_loadPresMapImg2:function(t,e,i,n){var r=t.getSingleCodgeo(),a=$("#presmap",this.$container).find(".presmap-img"),s="GC_make_map.php?width=700&format="+i+"&globe="+e+"&lang="+GCO5.appModel.getLang();n&&(s+="&globeLayer="+n),a.hide(),r?(s+="&nivgeo="+(r=t.getPkGeo().split("|"))[0]+"&codgeo="+r[1],t.getIdView()&&(s+="&view="+t.getIdView()),$.get(s,function(t){a.empty().html(t).show()})):GCO5.appModel.loadMapImageWithSel({view:t.getIdView(),selIds:t.getSelIds(),format:i,globe:e,globeLayer:n,w:700},function(t){a.empty().html(t).show()},this)},_updateSelgeo:function(t){var e;t&&t.getSingleCodgeo()&&!t.getIdExtent()&&(e=this.getTerritoryInfo(t.getPkGeo("@"),"view"),t.setExtent(GCO5.appModel.getInfo("infoFromMapName",[e,"id_extent"])))},exportReportDataXlsx:function(t,e,i){var n=this.dashboardData,r=n.report.chapters,s=(r[0].c_id_report,this),n=n.report.datavizs,o=(ndv=n.length,[]);n.forEach(function(t,e){var i,n,r=s.dvz_o[t.c_id_chapter+"*"+t.c_id_dataviz];for(n in r.grid_o){var a=r.grid_o[n];a instanceof GCO5.view.component.D3ChartContainer&&["MAP","TXT"].indexOf(a._def_o.type)<0&&((i=0==a._def_o.type.indexOf("TA")?GCO5.core.GcStringUtil.htmlTableToArray(a._def_o.htmlString):a._getChartData(null,null,null,null,!0)).titleData=a._getTitleData(),i.id_chapter=t.c_id_chapter,o.push(i))}}),this.xlsx("xlsx",o,r,t)},xlsx:function(e,i,n,r){var a=this;if(window.XLSX){var t,s={SheetNames:[],Sheets:{}};for(t in"rtl"===this.gclg.getTextDirection()&&(s.Workbook={Views:[{RTL:!0}]}),n){var o=n[t].c_id_chapter,l=n[t].c_lib.replace(/\//g," - ");r.chapterLib=l;l=(l=(1<n.length?"C"+(+t+1)+" ":"")+l).substring(0,30);s.Sheets[l]=this._getBlocXls(GCO5.core.GcArrayUtil.getSubArray(i,{id_chapter:o}),r),s.SheetNames.push(l)}var c=XLSX.write(s,{bookType:e,bookSST:!1,type:"binary"});saveAs(new Blob([function(t){for(var e=new ArrayBuffer(t.length),i=new Uint8Array(e),n=0,r=t.length;n<r;n++)i[n]=255&t.charCodeAt(n);return e}(c)],{type:"application/octet-stream"}),"data."+e)}else require(["zip_m"],function(t){require(["xlsx_m"],function(t){a.xlsx(e,i,n,r)})})},_getBlocXls:function(t,e){var i,n={},r=0,a={s:{c:0,r:0},e:{c:0,r:0}},s=GCO5.core.GcXlsUtil.addXlsStringLine;for(i in s(a,n,[GCO5.appModel.getLegal("tit_nav")],r++,!0),s(a,n,[e.reportLib+" - "+e.chapterLib],++r,!0),s(a,n,[e.libgeo],++r,!0),r+=2,t){var o=t[i];s(a,n,[o.titleData.title],r++,!0),o.titleData.subTitle&&s(a,n,[o.titleData.subTitle],r++),r++;for(var l=0;l<o.headerLength;l++)s(a,n,o.bodyData[l],r++,!0,null,null,!0);for(var c=l,h=o.bodyData.length;c<h;c++){var d,u=o.bodyData[c],p=-1;for(d in u){p++;var g={v:u[d]},f=XLSX.utils.encode_cell({c:p,r:r});g.t="num"==o.colsdef["col"+ +d]?"n":"s","n"!=g.t||GCO5.core.GcMathUtil.isNumber(g.v)||(g.t="s"),n[f]=g}r++}s(a,n,[o.titleData.source],++r,!1,null,!0),r+=3,a.e.c=Math.max(p,a.e.c),a.e.r=c+1+r}return n["!ref"]=XLSX.utils.encode_range(a),n["!cols"]=[{wch:50},{wch:30},{wch:30},{wch:30},{wch:30},{wch:30}],n},enterReportPrePrintMode:function(t){"1"==GCO5.appModel.getOption("noPresMapInReport")||t||((t=GCO5.appModel.getOption("globeForPrezMap"))?(t=t.split("|"),this._loadPresMapImg2(this.selgeo1,t[0],"html",t[1])):GCO5.appModel.getInfo("aPIKey",["OSP"])?this._loadPresMapImg2(this.selgeo1,"OSP","html"):GCO5.appModel.getInfo("aPIKey",["GM3"])?this._loadPresMapImg2(this.selgeo1,"GM3","html"):GCO5.appModel.getInfo("globeActive",["OSM"])?this._loadPresMapImg2(this.selgeo1,"OSM","html"):this._loadPresMapImg(this.selgeo1,null,"png"))},_getDatavizWithPageBreaks:function(t){var s,o=[],l=this,e=t.dataviz,c=this.constructor.PAGE_BREAK_BEFORE_CLASS;return e.forEach(function(n){n.c_id_chapter=t.c_id_chapter;function r(t,e){t.forEach(function(t){t.children?r.call(l,t.children,e):t.c_id_grid_item==e&&(s=1)})}var i=[],a=[];n.grid.forEach(function(t,e){0<=t.c_css_class.indexOf(c)?(t.c_css_class=t.c_css_class.replace(c,""),0<i.length&&a.push(i),i=[t]):i.push(t)}),0<i.length&&a.push(i);1<a.length?a.forEach(function(t,e){var i=GCO5.core.GcObjectUtil.cloneJson(n);0<e&&(i.c_title=null,i.c_subtitle=null),e<a.length-1&&(i.c_note=null),i.blocks=n.blocks.filter(function(i){if(s=0,t.forEach(function(t,e){r.call(l,t.children,i.c_id_grid_item)}),s)return!0}),i.grid=t,i.c_id_dataviz+="_"+e,o.push(i)}):o.push(n)}),o.forEach(function(t){t.nb_dv=o.length}),o},clearIFrame:function(){this._resizing=!0,$(".report-viewport").css("opacity","0"),$(".iframe-notice-container").css("visibility","hidden");var t={msg:"REPORT_INIT"},t=(this.curIdReport&&(t.chapters=GCO5.appModel.getConcept("report_o")[this.curIdReport].chapters,t.id_chapter=this.curIdChapter?this.curIdChapter.split("|").pop():""),this.cli.postRobotSend("resizeIframe",t),GCO5.core.SystemManager.getInstance());this.$container.empty(),t.freeze("drawReportDv"),t.setFreezeMsg(this.gclg.getString("LOADING_BLOCK","report"))},loadBlockData:function(t,e,i,n,r){var a,s,o,l;t&&(this.dashboardData=t,this.$container.empty(),l=t.report.chapters[0].c_id_chapter,a=t.report.chapters[0].dataviz[0].c_id_dataviz,s=$.render.reportTableStructure(this.ca._viewData),(s=$(s).attr("id",a)).find("header").addClass("print-only"),o=s.find(".report-content-cell"),l=$("<article id ='"+l+"*"+a+"' class='report-container container-fluid'><div id='singleBlock' class='dataviz-container singleBlock' ></div></article>"),o.append(l),this.$container.append(s),this.dvz_o[this.constructor.SINGLEBLOCK_DVZ]=this.genHtmlForBloc(t,l.find(".dataviz-container"),a,t.singleBlock,n,r))},loadData:function(s,t,e,i,n,r,o){if(s){var l,a=(this.dashboardData=s).report.chapters,c=a[0].c_id_report,h=c+"|"+a[0].c_id_chapter,d=this,u=this._getDatavizWithPageBreaks(a[0]),p=(this._updateSelgeo(this.selgeo1=e),this._updateSelgeo(i),this.curIdChapter!=h||t);if(p&&(d.$container.empty(),this.dvz_o={}),1<a.length)for(var g=1;g<a.length;g++){var f=a[g].c_id_chapter,m=this._getDatavizWithPageBreaks(a[g]);m.forEach(function(t){t.c_id_chapter=f,t.nb_dv=a[g].dataviz.length}),u=u.concat(m)}s.report.datavizs=u;function _(){0==--v&&n.apply(r)}var v=l=u.length,y=0,e=d.ca._viewData.selectedChapter,b=("1"!=GCO5.appModel.getOption("noPresMapInReport")&&p&&($("#presmap",d.$container).remove(),d.ca._viewData.printPresMapInReport=!!t,i=$.render.reportTableStructure(d.ca._viewData),(t=$(i).attr("id","presmap")).addClass("print-only"),t.find("header").addClass("print-only"),i=$("<header class='dataviz-header'><h2>"+this.gclg.getString("PRESMAP","report")+"</h2></header>"),$(".report-content-cell",t).attr("align","center").append(i),$img=$(".report-content-cell",t).append("<div class='presmap-img' style='text-align:left;height:623px;width:700px'></div>"),i.width(750),d.$container.append(t),o&&((i=GCO5.appModel.getOption("globeForPrezMap"))?(t=i.split("|"),this._loadPresMapImg2(this.selgeo1,t[0],"html",t[1])):GCO5.appModel.getInfo("aPIKey",["OSP"])?this._loadPresMapImg2(this.selgeo1,"OSP","html"):GCO5.appModel.getInfo("aPIKey",["GM3"])?this._loadPresMapImg2(this.selgeo1,"GM3","html"):GCO5.appModel.getInfo("globeActive",["OSM"])?this._loadPresMapImg2(this.selgeo1,"OSM","html"):this._loadPresMapImg(this.selgeo1,null,"png"))),d.ca._viewData.printPresMapInReport=!1,o?1:GCO5.model.dashboard.GcDatavizModel.BLOC_DISPLAY_DELAY);u.forEach(function(t,e){p&&(d.ca._viewData.selectedChapter=t.c_id_chapter,i=$.render.reportTableStructure(d.ca._viewData),i=$(i).attr("id",t.c_id_dataviz),e<0?i.find("header").addClass("print-final-only"):i.find("header").addClass("print-only"),r=i.find(".report-content-cell"),1<l&&t.c_title&&(!o||1<t.nb_dv||t.c_subtitle)&&(r.append("<header class='dataviz-header'></header>"),r.find("header").append("<h2>"+t.c_title+"</h2>"),t.c_subtitle&&r.find("header").append("<h3>"+t.c_subtitle+"</h3>")),n=$("<article id ='"+t.c_id_chapter+"*"+t.c_id_dataviz+"' class='report-container container-fluid'></article>"),r.append(n),t.c_note&&(r.append("<footer class='dataviz-footer small'></footer>"),r.find("footer").append("<p>"+t.c_note+"</p>")),d.dvz_o[t.c_id_chapter+"*"+t.c_id_dataviz]=new GCO5.model.dashboard.GcDatavizModel({container:n,chapterModel:d,lastDataviz:e==l-1,printAll:o}),d.$container.append(i)),o&&(r=d.$container.width(),n&&n.css("width",r-1+"px"));var i,n,r,a=GCO5.core.SystemManager.getInstance();GCO5.core.GcDelayUtil.callLater(function(){d.dvz_o[t.c_id_chapter+"*"+t.c_id_dataviz]?(o&&(a.setFreezeMsg(this.gclg.getString("DATAVIZ_DRAWING","restit","report")+" "+(e+1)+"/"+l),e+1==l&&a.unFreeze("printAllReport")),d.dvz_o[t.c_id_chapter+"*"+t.c_id_dataviz].loadData(s,!0,_,d,t,p)):console.log("dataviz effacée",t.c_id_dataviz)},[],y*b,d),y+=GCO5.model.dashboard.GcDatavizModel.getNbBlocs(s,t.c_id_chapter+"*"+t.c_id_dataviz)}),d.ca._viewData.selectedChapter=e,this.curIdChapter=h,this.curIdReport=c}},resize:function(t){if(this._resizing)this._resizing=!1;else{var e,i=0,n=0,r=GCO5.core.GcObjectUtil.count(this.dvz_o);for(e in this.dvz_o){var a=this.dvz_o[e];n+=GCO5.model.dashboard.GcDatavizModel.getNbBlocs(this.dashboardData,e),GCO5.core.GcDelayUtil.callLater(a.resize,[++i,r,t],n,a)}}}}),GCO5.model.indics.MapDataset=GCO5.Class.extend({statics:{NAME:"GCO5.model.indics.MapDataset"},map:null,mapIndicModels:null,gclg:null,indicData:null,indicCIData:null,curRef:null,addFid:null,initialize:function(t){this.gclg=GCO5.core.GcLangManager.getInstance(),this.map=t,this.uniqueID="MapdDts"+GCO5.core.GcDelayUtil.curFrame(),this._setup()},getRefList:function(){var t,e=this.mapIndicModels,i=[],n=GCO5.appModel.getInfo("infoFromMapName",[this.map.getName()]),r=n.lib_view.split("|").join(" "),a=n.pkgeo,s=n.id_nivgeo,o=n.id_extent;for(t in i.push({data:s+"|"+o,label:r}),e){var l=e[t],c=e[t].getProp("type"),l=l.getProp("idgeo");"F"==c&&i.push({data:l+"|"+o+"|"+t.split(".").shift(),label:this.gclg.getString("FLUX","concepts")+" - "+t.split(".").shift()}),GCO5.core.GcArrayUtil.indexOfByKey(i,"data",l+"|"+o)<0&&(c=GCO5.appModel.getConcept("nivgeo_o")[l],i.push({data:l+"|"+o,label:c?c.c_lib_nivgeop:l}))}return 0==i.length&&i.push({data:a+"|"+o,label:r}),i},_setup:function(){this.mapIndicModels=this.map.getIndicsModelsIndexed(!0)},buildDatasetFromRef:function(t,e,i){this.curRef=t;var n,r,a=(O=this.map.getSelIds())?O.length:0,s=this.getRefgeoData(),o=this.getMapIndicModels(),l=0,c=0,h=t,d=this.map.getSelgeo();for(p in d&&(h+=d.codgeo+"|"),o)h+=o[p].getPkF1()+o[p].getProp("serie")+"|",o[p].getProp("hasCI")&&(n=!0);if(i!=h){this.indicData=[],this.indicCIData=[];var u="PT"==GCO5.appModel.getConcept("nivgeo_o")[this.curRef.split("|").shift()].c_topo;(new Date).getTime();if(3==t.split("|").length){for(var p in o){M=o[p];break}for(var g=M.getProp("fluxIndices1"),f=M.getProp("fluxIndices2"),m=M.getProp("fluxCodes").length,_=0;_<m;_++){var v,y=g[_],b=f[_];y<0||b<0||(T=[1,s.codgeo[y]+" - "+s.libgeo[y],s.codgeo[b]+" - "+s.libgeo[b]],y=void 0===(v=o[p].getDataById(_))||-9999==v?"NA":this.gclg.formatNumber(v),T.push(y,void 0===v?-9999:v,M.isEstimatedValue(_)),this.indicData.push(T))}}else{var C=this.gclg.nf,x={},w={},S={};for(p in o){var M=o[p];x[p]=M.getProp("type"),w[p]=M.isNumeric(),S[p]=this.gclg["nf"+o[p].getProp("nbDec")]||C}if(e)for(var O,G=0,I=(O=e.getCurrentIdsWithValues()).length;G<I;G++){_=O[G];var T=[c,s.codgeo[_],s.libgeo[_]];for(p in o)if((M=o[p]).isPie())for(var l=0,A=(E=M.getDataById(_)).length;l<A;l++)v=E[l],C&&0<=v?T.push(S[p].format(v),v,!1):T.push("N/A",void 0===v?-9999:v,!1);else v=M.getDataById(_),C&&w[p]&&0<=v?T.push(C.format(v),v,!1):T.push(M.getFormattedDataById(_,!0,v),void 0===v?-9999:v,!1);this.indicData.push(T)}else{var P=0;for(p in o)o[p].valuesDisplayable()&&P++;for(_=0,I=Math.min(s.codgeo.length,4e5);_<I;_++){var T=[c=O&&l<a&&O[l]==_?(l++,1):0,s.codgeo[_],s.libgeo[_]],D=(n&&(r=[]),0);for(p in o)if(o[p].valuesDisplayable())if((M=o[p]).isPie()){for(var E,N=0,G=0,A=(E=M.getDataById(_)).length;G<A;G++)v=E[G],!u||-9999!==v&&"-9999"!==v&&void 0!==v||N++,C&&0<=v?T.push(S[p].format(v),v,M.isEstimatedValue(_)):T.push("N/A",void 0===v?-9999:v,M.isEstimatedValue(_));N==E.length&&D++}else v=M.getDataById(_),C&&w[p]&&0<=v?T.push(S[p].format(v),v,M.isEstimatedValue(_)):T.push(M.getFormattedDataById(_,!0,v),void 0===v?-9999:v,M.isEstimatedValue(_)),!u||-9999!==v&&"-9999"!==v&&null!=v||D++,n&&M.getProp("hasCI")&&r.push(M.getDataICBoundById(_,"lcl"),M.getDataICBoundById(_,"ucl"));u&&D==P||(this.indicData.push(T),n&&this.indicCIData.push(r))}}}(new Date).getTime()}return h},getMapSelectedIds:function(){var t=this.indicData.filter(function(t){return 1==t[0]}).map(function(t){return t[1]}),e=this.getRefgeoData();return t.map(function(t){return e.codgeo.indexOf(t)})},getRefgeoData:function(){var t=this.curRef.split("|");return GCO5.appModel.getRefData(t[0],2<=t.length?t[1]:null)},prepareForXls:function(t,e){var R=(new Date).getTime(),n={},i=0,c=3,h=3,d=this,r={s:{c:0,r:0},e:{c:0,r:0}},a=GCO5.core.GcXlsUtil.addXlsStringLine,s=this.getMapIndicModels(),o=this.getMapIndicModels({onlyValuesExportable:!0}),u=[],p=[],g=[],f=[],m=[],_=[],v=0,k=0;for(x in s)if(s[x].isPie())for(var l=0,y=(P=s[x].getProp("VILibs")).length;l<y;l++)u.push(!1),p.push(!!o[x]),f.push(!1),m.push(null),_.push(!1),v++;else{if(g.push(s[x].getProp("hasCI")?k++:null),u.push(s[x].isZonage()),p.push(!!o[x]),f.push(s[x].isVI()),_.push(s[x].hasEstimatedValues()),s[x].isVI()){var b=s[x].getProp("vIMods"),F=s[x].getProp("vILibs"),C={};for(x in b)C[b[x]]=F[x];m.push(C)}else m.push(null);v++}var x,w=GCO5.appModel.getInfo("infoFromMapName",[this.map.getName(),"c_lib_view"]),S=(a(r,n,[GCO5.appModel.getLegal("tit_nav")],i++,!0),a(r,n,[this.gclg.getString("REFGEO")+this.gclg.getString("P2B")+" "+w.replace("|"," ")],i++,!0),t&&a(r,n,[this.gclg.getString("SELECTION","concepts")+this.gclg.getString("P2B")+" "+this.map.getLibSel()],i++,!0),[this.gclg.getString("CODE"),this.gclg.getString("LABEL")]),M=["",""],V=1,O=[{wch:6},{wch:40}],G="xlsx"==e?"\r\n":null,I=G||" - ";for(x in o){var T,A=s[x].getProp("libIndicWithF1",!0,!1,null,G);if(M.push("Indic"+V+++(s[x].isPie()?" - "+A:"")),s[x].isPie())for(var P,l=0,y=(P=s[x].getProp("VILibs")).length;l<y;l++)S.push(P[l]),O.push({wch:20}),0<l&&M.push(null);else s[x].getProp("hasCI")&&(S.push(A+I+this.gclg.getString("LCL_CI","indics")),O.push({wch:20}),T=M.pop(),M.push(T,null)),S.push(A),O.push({wch:20}),s[x].getProp("hasCI")&&(S.push(A+I+this.gclg.getString("UCL_CI","indics")),O.push({wch:20}),M.push(null)),s[x].hasEstimatedValues()&&(S.push(A+I+this.gclg.getString("EXPORT_ESTIM_LABEL","tables")+" ("+GCO5.view.component.TableView.ESTIMATED_VALUE_SYMBOL+"="+this.gclg.getString("YES2","common")+")"),O.push({wch:20}),M.push(null))}2<M.length&&a(r,n,M,i,!1),a(r,n,S,++i,!0,"w");function D(t,e,i){var n=0;E(e[1],i,n++),E(e[2],i,n++);for(var r,a,s,o,l=0;l<v;l++)p[l]&&(r=(o=c+h*l+1)+1,a=f[l],u[l]&&(r=(o=c+h*l)+2,a=!1),null!=g[l]&&(s=d.indicCIData[t][2*g[l]],E(s,i,n++)),s=e[o],a&&(s=s+" - "+m[l][s]),E(s,i,n++),null!=g[l]&&(o=d.indicCIData[t][2*g[l]+1],E(o,i,n++)),_[l]&&(e[r]&&E(GCO5.view.component.TableView.ESTIMATED_VALUE_SYMBOL,i,n),n++));return n}var E=function(t,e,i){t={v:t},i=XLSX.utils.encode_cell({c:i,r:e});d._reCodeCellValues(t),n[i]=t};if(t){t.sort(function(t,e){return t-e});for(var w=t.length,N=0,y=Math.min(w,1e5);N<y;N++)var U=D(L=t[N],this.indicData[L],++i)}else for(var L=0,y=this.indicData.length;L<y;L++)U=D(L,this.indicData[L],++i);r.e.c=U,r.e.r=i,n["!ref"]=XLSX.utils.encode_range(r);e=(new Date).getTime()-R;return console.log("prepareXLS en: "+e/1e3+" s",GCO5.core.GcDelayUtil.curFrame()),{ws:n,wscols:O}},_reCodeCellValues:function(t){var e=t.v;null==e||-9999==e?t.v=this.gclg.getString("NAMQ","indics"):-99999==e?t.v=this.gclg.getString("NASS","indics"):-999999==e?t.v=this.gclg.getString("NAD0","indics"):-8888==e?t.v=this.gclg.getString("NAOLP","indics"):t.t="number"==typeof e?"n":"boolean"==typeof e?"b":"s"},_getHeaders:function(t,e){var i,n,r,a=[],s=e&&e.forExternalDataSpace,o=(s||(i=GCO5.appModel.getInfo("infoFromMapName",[this.map.getName(),"c_lib_view"]),a.push([GCO5.appModel.getLegal("tit_nav")]),a.push([this.gclg.getString("REFGEO")+this.gclg.getString("P2B")+" "+i.replace("|"," ")]),t&&a.push([this.gclg.getString("SELECTION","concepts")+this.gclg.getString("P2B")+" "+this.map.getLibSel()])),[this.gclg.getString("CODE"),this.gclg.getString("LABEL")]),l=(s&&o.pop(),this.getMapIndicModels(e)),c=2;for(r in l){if(n=l[r].getProp("shortLibIndic"),l[r].getProp("serie")&&(n+=" "+l[r].getProp("serie")),l[r].isPie())for(var h=l[r].getProp("VILibs"),d=0,u=h.length;d<u;d++)o.push(n+" - "+h[d]);else o.push(n);l[r].hasEstimatedValues()&&o.push(n+" - "+this.gclg.getString("EXPORT_ESTIM_LABEL","tables")+" ("+GCO5.view.component.TableView.ESTIMATED_VALUE_SYMBOL+"="+this.gclg.getString("YES2","common")+")"),c++}return a.push(o),a.forEach(function(t,e){t.length<c-1&&(a[e]=a[e].concat(Array(c-t.length+1).join(" ").split("")))}),a},exportDataHtml:function(t,e){var i=this.getRefgeoData(),n=this.getMapIndicModels({onlyValuesExportable:!0}),r=[],a=this.gclg.nf;if(!e)if(t){if(1e3<t.length)return}else if(1e3<i.codgeo.length)return;function s(t,e){for(var i="<tr>",n=0,r=t.length;n<r;n++)i+="<"+e+">"+t[n]+"</"+e+">";return i+"</tr>"}var o=(o='<table class="display dataTable">')+("<thead>"+s(this._getHeaders(t,{onlyValuesExportable:!0}).pop(),"th")+"</thead>")+"<tbody>";if(t){t.sort(function(t,e){return t-e});for(var e=t.length,l=0,c=Math.min(e,1e5);l<c;l++){var h=t[l],r=[i.codgeo[h],i.libgeo[h]];for(p in n)if(n[p].isPie())for(var l=0,d=(g=n[p].getDataById(h)).length;l<d;l++){var u=g[l];a&&0<=u?r.push(a.format(u)):r.push("N/A"),n[p].hasEstimatedValues()&&r.push(n[p].isEstimatedValue(h)?GCO5.view.component.TableView.ESTIMATED_VALUE_SYMBOL:"")}else r.push(n[p].getFormattedDataById(h)),n[p].hasEstimatedValues()&&r.push(n[p].isEstimatedValue(h)?GCO5.view.component.TableView.ESTIMATED_VALUE_SYMBOL:"");o+=s(r,"td")}}else for(h=0,c=Math.min(i.codgeo.length,1e5);h<c;h++){var p,r=[i.codgeo[h],i.libgeo[h]];for(p in n)if(n[p].isPie())for(var g,l=0,d=(g=n[p].getDataById(h)).length;l<d;l++){u=g[l];a&&0<=u?r.push(a.format(u)):r.push("N/A"),n[p].hasEstimatedValues()&&r.push(n[p].isEstimatedValue(h)?GCO5.view.component.TableView.ESTIMATED_VALUE_SYMBOL:"")}else r.push(n[p].getFormattedDataById(h)),n[p].hasEstimatedValues()&&r.push(n[p].isEstimatedValue(h)?GCO5.view.component.TableView.ESTIMATED_VALUE_SYMBOL:"");o+=s(r,"td")}return o+="</tbody></table>"},exportData:function(t,a,s,e){var o,i,n=[],l=3,c=3,h=(e=e||{}).forExternalDataSpace,r=this._getHeaders(t,e),d=(a=a||"\t",n=r.map(function(t){return t.join(a)}),this.getMapIndicModels()),u=this.getMapIndicModels(e),p=[],g=[],f=[],m=0;for(i in d)if(d[i].isPie())for(var _=0,v=d[i].getProp("VILibs").length;_<v;_++)p.push(!1),g.push(!!u[i]),f.push(u[i].hasEstimatedValues()),m++;else p.push(d[i].isZonage()),g.push(!!u[i]),f.push(d[i].hasEstimatedValues()),m++;function y(t){var e=t[1];h||(e+=a+t[2]);for(var i,n,r=0;r<m;r++)g[r]&&(i=(n=c+r*l+1)+1,p[r]&&(i=(n=c+r*l)+2),o=t[n],!GCO5.core.GcMathUtil.isNumericInvalid(o)&&null!==o||(o=s?"":t[n-1]),e+=a+o,f[r]&&(n=t[i]?GCO5.view.component.TableView.ESTIMATED_VALUE_SYMBOL:"",e+=a+n));return e}if(t){t.sort(function(t,e){return t-e});for(var b=t.length,_=0;_<b;_++){var C=t[_],x="";x=y(this.indicData[C]),n.push(x)}}else for(C=0,v=this.indicData.length;C<v;C++){x=y(this.indicData[C]);n.push(x)}return n.join(GCO5.core.ClientInfo.getInstance().newLine())},setMapIndicModels:function(t){this.mapIndicModels=t},getMapIndicModels:function(t){t=t||{};var e,i=this.mapIndicModels,n={},r=this.curRef.split("|"),a=r[0],s=3==r.length,o=s?r[2]:null;for(e in i){var l=i[e];!l.valuesDisplayable()||t.onlyValuesExportable&&!l.valuesExportable()||l.isZonage()&&i[e].getProp("idIndicateur")==this.map.nivgeo||a==l.getProp("idgeo")&&(s&&l.getProp("idDataset")==o||!s&&"F"!=l.getProp("type"))&&(n[e]=l)}return n},getNbIndics:function(){return this.getLibIndics().length},getLibIndics:function(){var t,e=this.getMapIndicModels(),i=[];for(t in e)if(e[t].isPie())for(var n=e[t].getProp("VILibs"),r=0,a=n.length;r<a;r++)i.push(e[t].getProp("libIndicWithF1",!0)+"<br>"+n[r]);else i.push(e[t].getProp("libIndicWithF1",!0,!1,!0));return i},getTypIndics:function(){var t,e=this.getMapIndicModels(),i=[];for(t in e)if(e[t].isPie())for(var n=0,r=e[t].getProp("VILibs").length;n<r;n++)i.push("N");else i.push(e[t].getIndicModel().isQualitative()?"C":"N");return i},getListIndics:function(t){function e(t){return s.gclg.getString(t,"tables")}var i,n=this.getMapIndicModels(t=t||{}),r=[],a=0,s=this;for(i in n){var o,l=[{mod:"*",lib:e("ALL_CATEGS")}].concat(n[i].getRangesInfo());if(n[i].isZonage()&&(o=GCO5.appModel.getRefData(n[i].getProp("idIndicateur"),this.map.getIdExtent()),o=[{codgeo:"*",libgeo:e("ALL_TERRS")},{codgeo:"_",libgeo:e("OUT_OF_SCOPE")}].concat(o.codgeo.map(function(t,e){return{codgeo:t,libgeo:o.libgeo[e]}}))),n[i].isPie()&&t.deployed)for(var c=n[i].getProp("VIMods"),h=n[i].getProp("VILibs"),d=0,u=c.length;d<u;d++)r.push({id:i+"|"+c[d],lib:n[i].getProp("libIndicWithF1",!0)+"<br>"+h[d],num:a++,cat:n[i].getCategory(),scat:n[i].getSuperCategory(),zonrefgeo:o,mim:n[i],m_a:l,selectedMod:"*",selectedCodgeo:"*",selectedPole:"*"});else r.push({id:i,lib:n[i].getProp("libIndicWithF1",!0),num:a++,cat:n[i].getCategory(),scat:n[i].getSuperCategory(),zonrefgeo:o,mim:n[i],m_a:l,selectedMod:"*",selectedCodgeo:"*",selectedPole:"*"})}return r},getEstimatedIndics:function(){var t,e=this.mapIndicModels,i=[];for(t in e)e.hasOwnProperty(t)&&i.push(e[t].getIndicModel().hasEstimatedValues());return i},getData:function(){return this.indicData}}),GCO5.view.component.TableView=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.TableView",SEUIL_RECHLIBGEO_UNACCENT:5e3,ESTIMATED_VALUE_SYMBOL:"*"},$dt_container:null,$wait_msg:null,mapDataset:null,dataTable:null,_inited:null,map:null,_ca:null,_filters_o:null,_nbRows:null,_nbRowsFiltered:null,_nbRowsSelected:null,_fnDtsValuesFilter:null,_lastTableHash:null,_indicData:null,_lastWidth:null,_mapLinked:null,_nbFixedCols:3,_nbColsByIndic:3,initialize:function(t){this.setup(t),this._inited=!0,this._lastWidth=GCO5.browser.width,GCO5.core.ClientInfo.getInstance().isSafari()&&$(".table-buttons").find("#tm_table_xls").hide()},setup:function(t){this._ca=t.ca,this.map=t.map,this._filters_o={},this.$dt_container=$(".datatable",t.ca.getRenderedContent()),this.$wait_msg=$(".wait-table-msg",t.ca.getRenderedContent()),0==this.$dt_container.length?console.error("datatable missing"):(t.mapDataset&&(this.mapDataset=t.mapDataset),t.map&&(this.mapDataset=new GCO5.model.indics.MapDataset(t.map)),this._addListeners(),t.noRender||this.showDefaultDataTable(),$.fn.dataTable.ext.order.intl=function(t,e){var i;window.Intl&&(i=new window.Intl.Collator(t,e),delete(t=$.fn.dataTable.ext.type).order["string-pre"],t.order["string-asc"]=i.compare,t.order["string-desc"]=function(t,e){return-1*i.compare(t,e)})},$.fn.dataTable.ext.order.intl(GCO5.core.GcLangManager.getInstance().getLang()))},setMap:function(t){t&&($.fn.dataTable.ext.search=[],this.mapDataset=new GCO5.model.indics.MapDataset(t),this.$dt_container.is(":visible")&&this.showDefaultDataTable())},getCurRef:function(){var t=this.getRefList(),e=t[t.length-1].data,i=this.map.getEnabledIndicsModelsIndexed();if(1==GCO5.core.GcObjectUtil.count(i)&&2==t.length)return e;i=this._ca.getViewData().selectedTableRef;return 0<=GCO5.core.GcArrayUtil.indexOfByKey(t,"data",i)?i:e},isFluxTable:function(){var t=this._ca.getViewData().selectedTableRef;return!!t&&3==t.split("|").length},showDefaultDataTable:function(){$.fn.dataTable.ext.search=[],this._ca.setObservableArray("tableref_a",this.getRefList(),"selectedTableRef",this.getCurRef())},_addListeners:function(){this._inited||$.observe(this._ca.getViewData(),"selectedTableRef",$.proxy(this.setRef,this))},_getDataForTable:function(){return this.mapDataset.getData()},getData:function(){return this._indicData},setRef:function(){var t=this._ca.getViewData().importedDataset,e=this._ca.getViewData().selectedTableRef,i=this;e&&(GCO5.core.GcDelayUtil.callLater(function(){i._lastTableHash=i.mapDataset.buildDatasetFromRef(e,t,i._lastTableHash)},[],2,this),this.dataTable&&this.clear(),GCO5.core.GcDelayUtil.callLater(this._callDataTable,[],10,this),this._nbRows=null,this.$wait_msg.show())},getRefList:function(){return this.mapDataset.getRefList()},show:function(){this.$dt_container.show(),this.$wait_msg.hide()},hide:function(){this.$dt_container.hide()},getListindics:function(){return this.mapDataset.getListIndics({deployed:!0})},applySelToMap:function(t){var e,i,n;"indicator"==this._ca.getShortName()&&(e=this._getLyName(),i="PT"==GCO5.appModel.getConcept("nivgeo_o")[this.getCurRef().split("|").shift()].c_topo,0==this._nbRowsSelected&&!this.map.getSelIds(e)||!this.dataTable||this.isFluxTable()||(n=this.getSelectedIds(),(n=i?this.mapDataset.getMapSelectedIds():n).join("")!=(this.map.getSelIds(e)||[]).join("")&&(i=n,n=this.map.getLayerByName(e),n=this.map.isSelectionVisible(n,i),this.map.drawSelIds(e,i,!n,null,t))))},_getLyName:function(){var t=this._ca.getViewData().selectedTableRef.split("|").shift(),e=GCO5.appModel.getConcept("nivgeo_o")[t].c_topo;return"PG"==e?this.map.getStatLayerName():t+"_"+{PT:"P",PL:"L"}[e]},_applySelection:function(t,e){var i,n=this.dataTable,r=0,a=this;t&&n.rows({selected:!(r=0)}).deselect(),this._selectingFrom="map",n.order([[0,"desc"],[1,"asc"]]).draw(),GCO5.core.GcDelayUtil.callLater(function(){(i=n.rows(function(t,e,i){return 1==e[0]})).select(),a._updateSummaryInfo({_nbRowsSelected:i[0].length,init:!0})},[],r,this)},_resyncSelection:function(t){var e;this._nbRowsSelected&&(e=this.dataTable,GCO5.core.GcDelayUtil.callLater(function(){e.rows(function(t,e,i){return 1==e[0]}).select()},[],t||10,this))},selectAll:function(){var t=0<this._nbRowsSelected,e=(t&&this.dataTable.rows().deselect(),this);e._selectingFrom="table",GCO5.core.GcDelayUtil.callLater(function(){var t=e.dataTable.rows({search:"applied"}).select();e._updateSummaryInfo({_nbRowsSelected:t[0].length})},[],t?10:0,this)},deselectAll:function(t){0!=this._nbRowsSelected&&this.dataTable&&(this.dataTable.order([1,"asc"]).draw(),this.dataTable.rows().deselect(),this._updateSummaryInfo({_nbRowsSelected:0}))},getSelectedIds:function(){return this.dataTable.rows({selected:!0})[0]},getFilteredIds:function(){return this.dataTable.rows({search:"applied"})[0]},addIndicModel:function(t,e,i){this.dataTable&&(this.applySelToMap({silent:!0}),this.mapDataset.setMapIndicModels(e),i||this._ca.setObservableArray("tableref_a",this.getRefList(),"selectedTableRef",t.getProp("pkgeo"),{forceTrigger:!0}))},removeIndicModel:function(t,e,i){this.syncWithMap(e,i&&i.noRender)},isComposited:function(){var t=this._ca._viewData.selectedRestit;return 1<t.length&&0<=t.indexOf("t")},onBuildInfosel:function(t,e){if(!this.isComposited())return!0;var i,n=this.getData();if(e){if(!GCO5.core.SystemManager.getInstance().isMouseDown()){var r=this.getCurRef().split("|"),a=e.getSelIds(r[0],r[1]).concat();if(n){for(var s,o,l=n.length,c=0;c<l;c++)o=n[c],i||c!=a[0]?(s||0==o[0]||(s=!0),o[0]=0):(s||1==o[0]||(s=!0),o[0]=1,a.shift(),0==a.length&&(i=!0));0<this._nbRowsSelected&&this.dataTable.rows().invalidate(),s&&!GCO5.core.SystemManager.getInstance().isMouseDown()&&GCO5.core.GcDelayUtil.callLater(this._applySelection,[!0],2,this)}}}else if(this._selectingFrom="map",this.deselectAll(!0),n){for(var l=n.length,c=0;c<l;c++)n[c][0]=0;this.dataTable.rows().invalidate()}},syncWithMap:function(t,e){this.mapDataset.setMapIndicModels(t),!e&&this.$dt_container.is(":visible")&&this.showDefaultDataTable(t)},onRemovedFromStage:function(){!this.applySelToMap()&&this._ca.getViewData().importedDataset&&GCO5.core.GcDelayUtil.callLater(this.map.render,[],10,this.map),GCO5.core.GcDelayUtil.callLater(this.clear,[],10,this),$("body").removeClass("largetablo-on")},clear:function(){if(this.dataTable){$.fn.dataTable.ext.search=[],this._nbRowsFiltered=this._nbRows;try{this.dataTable.destroy()}catch(t){}this.dataTable=null,$("thead tr",this.$dt_container).empty(),$("tbody",this.$dt_container).empty(),$(".dataTables_scrollHeadInner, table",this.$dt_container).css("width","auto")}this._indicData=null},hasSel:function(){return 0<this._nbRowsSelected},hasFilter:function(){return this._nbRowsFiltered<this._nbRows},clearFilters:function(){$.fn.dataTable.ext.search=[],this._fnDtsValuesFilter&&$.fn.dataTable.ext.search.push(this._fnDtsValuesFilter),this.dataTable.search("").columns().search("").draw(),this._updateSummaryInfo({_nbRowsFiltered:this._nbRows}),this._filters_o[this.getCurRef()]=null},_updateSummaryInfo:function(t){for(var e in t)this[e]=t[e];this._ca.setObservableProperty("tableInfo",this.getTableSummaryInfo()),this.isComposited()&&"table"==this._selectingFrom&&GCO5.core.GcDelayUtil.callLater(this.applySelToMap,[],10,this);var i=this;GCO5.core.GcDelayUtil.callLater(function(){i._selectingFrom=null},[],5,this)},getFieldIndexFromFieldNum:function(t){return this._nbFixedCols+this._nbColsByIndic*t+1},applyFilters:function(t){$.fn.dataTable.ext.search=[],this._fnDtsValuesFilter&&$.fn.dataTable.ext.search.push(this._fnDtsValuesFilter),this._filters_o[this.getCurRef()]=t;var a=this.getTableNbRows()<GCO5.view.component.TableView.SEUIL_RECHLIBGEO_UNACCENT,e=this;t.forEach(function(n){var r,t;"_sel_"==n.field?(r=0,t=function(t,e,i){if("1"===e[r])return!0}):"codgeo"==n.field?((r=1)==n.type&&(t=function(t,e){if(new RegExp("^"+n.val,"i").test(e[r]))return!0}),2==n.type&&(t=function(t,e){if(new RegExp(n.val,"i").test(e[1]))return!0})):"libgeo"==n.field?(r=2,1==n.type&&(t=function(t,e){var i=new RegExp("^"+n.val,"i");if(a){if(i.test(GCO5.core.GcStringUtil.unaccent(e[r])))return!0}else if(i.test(e[r]))return!0}),2==n.type&&(t=function(t,e){if(new RegExp(n.val,"i").test(e[2]))return!0})):(r=e.getFieldIndexFromFieldNum(n.fieldNum),1==n.type&&(t=function(t,e){return+e[r]>=n.val}),2==n.type&&(t=function(t,e){return+e[r]<=n.val}),3==n.type&&(t=function(t,e){return e[r]==n.val}),4==n.type&&(t=function(t,e){return 0<=n.val.indexOf(e[r])}),5==n.type&&(t=function(t,e){return e[r]==n.val}),6==n.type&&(t=function(t,e){return 0<=n.val.indexOf(e[r])})),$.fn.dataTable.ext.search.push(t)}),this.dataTable.draw(),this._resyncSelection(1),this._updateSummaryInfo({_nbRowsFiltered:null})},getTableNbRows:function(){return null==this._nbRows&&this.dataTable&&(this._nbRows=this.dataTable.rows().count()),this._nbRows},getTableNbFilteredRows:function(){return null==this._nbRowsFiltered&&this.dataTable&&(this._nbRowsFiltered=this.dataTable.rows({search:"applied"}).count()),this._nbRowsFiltered},getTableNbSelectedRows:function(){return null==this._nbRowsSelected&&this.dataTable&&(this._nbRowsSelected=this.dataTable.rows({selected:!0})[0].length),this._nbRowsSelected},getTableSummaryInfo:function(){return{eft:this.getTableNbRows(),selected:this.getTableNbSelectedRows(),filtered:this.getTableNbFilteredRows()}},displayTablePanel:function(t,e){var i,n,r,a=new GCO5.view.component["Table"+t+"Panel"],e={action:"NEW",categ:"panel",container:this.isComposited()?$(".cd-panel.from-right .cd-panel-content"):$(".cd-panel.from-left .cd-panel-content"),map:this.map,tbv:this,hasSel:this.hasSel(),hasFilter:this.hasFilter(),ca:e,isComposited:this.isComposited(),nbObjs:this.getTableNbRows(),nbObjSel:this.getTableNbSelectedRows(),nbObjFilt:this.getTableNbFilteredRows()};"Filter"==t&&(t=this._filters_o[this.getCurRef()],i=t?GCO5.core.GcArrayUtil.toIndexedObj(t,"field"):null,n=this.getListindics(),r={},t&&(n.forEach(function(t){var e=i[t.id];e&&("listMods"==e.condName&&(t.selectedMod="+"),t[e.condName]=e.val)}),t.forEach(function(t){"codgeo"!=t.field&&"libgeo"!=t.field||(r[t.condName]=t.val)})),e.indics=n,e.refgeoFilters=r),GCO5.core.GcDelayUtil.callLater(a.setup,[e],10,a)},_callDataTable:function(){var t=(new Date).getTime(),e=this.isFluxTable(),i=this.mapDataset.getData(),n=e?1:this.mapDataset.getNbIndics(),r="";!this.isComposited()&&(5<n||this.$dt_container.hasClass("collapsed")||this.$dt_container.width()/n<150)&&$("body").addClass("largetablo-on");for(var a=0;a<this._nbColsByIndic*n+this._nbFixedCols;a++)r+="<th></th>";$("thead tr:last-child",this.$dt_container).html(r);$("tfoot tr",this.$dt_container).html(r),this._fnDtsValuesFilter=null;var s=this._getOptions(n,i,!1),o=this.dataTable=this.$dt_container.DataTable(s),s=(o.on("user-select",function(t,e,i,n,r){1==n[0][0].column&&l.$dt_container.hasClass("collapsed")?t.preventDefault():(l._selectingFrom="table",GCO5.core.GcDelayUtil.callLater(l._updateSummaryInfo,[{_nbRowsSelected:null}],5,l))}).on("deselect",function(t,e,i,n){l._selectingFrom||(l._selectingFrom="table"),GCO5.core.GcDelayUtil.callLater(l._updateSummaryInfo,[{_nbRowsSelected:null}],5,l)}),o.on("page.dt",function(){l.$dt_container.closest(".dataTables_scrollBody").animate({scrollTop:0},200),GCO5.core.GcDelayUtil.callLater(l.onResize,[null,!0],1,l),l._resyncSelection()}),this.$dt_container.on("mouseenter","td",function(){o&&null!=o.cell(this).index()&&l.map.displayTooltipOnFid(o.cell(this).index().row,l._getLyName())}),this.$dt_container.on("mouseleave",function(){l.map.displayTooltipOnFid(null,l._getLyName())}),(new Date).getTime()-t),a=(console.log("datatables en: "+s/1e3+" s",GCO5.core.GcDelayUtil.curFrame()),$("tfoot").css("visibility","hidden"),$("tfoot").hide(),0),l=this;GCO5.core.GcDelayUtil.callLater(function(){$("tfoot").css("visibility","visible"),$("thead").css("visibility","visible")},[],8,this),GCO5.core.GcDelayUtil.callLater(this.onResize,[],2,this),this._nbRows=this._nbRowsFiltered=i.length,this.map.getSelIds()&&!e?(this._selectingFrom="table",this._applySelection()):(this._nbRowsSelected=0,this._ca.setObservableProperty("tableInfo",this.getTableSummaryInfo()))},_getOptions:function(t,e,i){for(var o=this,n=this.isFluxTable(),r=GCO5.core.GcLangManager.getInstance(),a=this._getDataTablesOptions(e),s=(a.order=n||!this.hasSel()?[]:[[1,"asc"]],a.columnDefs=[{targets:[0],visible:!1,searchable:!0}],a.columns=[{}],a.columnDefs.push({targets:[1],className:"dt-head-left",searchable:!0},{targets:[2],className:"dt-head-left",searchable:!0}),n?a.columns.push({title:r.getString("ORIGIN")},{title:r.getString("DEST")}):a.columns.push({title:r.getString("CODE")},{title:r.getString("LABEL")}),this.mapDataset.getLibIndics()),l=this.mapDataset.getTypIndics(),c=this.mapDataset.getEstimatedIndics(),h=(this._nbFixedCols=3,this._nbColsByIndic=3,0);h<t;h++){var d=3+3*h,u={targets:[d],orderData:[1+d],className:"N"==l[h]?"dt-right":"dt-left",visible:!0,searchable:!0};c[h]&&(u.createdCell=function(t,e,i,n,r){i[r+2]&&($(t).addClass("estimatedValue"),$(t).html($(t).html()+" "+GCO5.view.component.TableView.ESTIMATED_VALUE_SYMBOL))}),a.columnDefs.push(u),a.columnDefs.push({targets:[1+d],visible:!1,searchable:!0}),a.columnDefs.push({targets:[2+d],visible:!1,searchable:!1,orderable:!1}),a.columns.push({title:s[h]}),a.columns.push({title:""}),a.columns.push({title:""})}return a.infoCallback=function(t,e,i,n,r,a){var s="";return-1<o.mapDataset.getEstimatedIndics().indexOf(!0)&&(s='<span class="estimatedValue">'+GCO5.view.component.TableView.ESTIMATED_VALUE_SYMBOL+" "+GCO5.core.GcLangManager.getInstance().getString("VALUES_ESTIMATED","tables")+"</span> <br/>"),s+=a},a},getDataTable:function(){return this.dataTable},onResize:function(t,e,i){var n,r,a,s;!this.resizing&&this.$dt_container.is(":visible")&&(n=this.$dt_container.closest(".dataTables_wrapper"))&&n.offset()&&(e||this.show(),a=GCO5.browser.height-n.offset().top-10,r=parseFloat($(".dataTables_scrollBody",n).css("max-height")),s=GCO5.browser.isTouch?10:15,a=1==$(".dataTables_paginate",n).length?GCO5.browser.height-$(".dataTables_paginate",n).offset().top-$(".dataTables_paginate",n).height()-s:a-r-$(".dataTables_scrollHead",n).height()-s,s=$(".dataTables_scrollBody",n),$(".dataTables_scrollBody",n).css("max-height",r+a+"px"),GCO5.browser.isFirefox&&s.css("padding-right","5px"),e||this._lastWidth==GCO5.browser.width&&!this.isComposited()&&!i||this.dataTable.columns.adjust().draw(),this._lastWidth=GCO5.browser.width)},buildDatasetFromDp:function(t,e){for(var i=[],n=0,r=t.length;n<r;n++){var a,s=t[n],o=[];for(a in e)o.push(s[e[a].id]);i.push(o)}return i},buildDatasetFromArrays:function(t,e,i){for(var n=[],r=t[e[0].id].length,a=0;a<r;a++){var s=[];if(!i||i[t[e[0].id][a]]){for(var o in e)s.push(t[e[o].id][a]);n.push(s)}}return n},callDataTableFromFreeDataset:function(t,e){for(var i=e.length,n="",r=(new Date).getTime(),a=0;a<i;a++)n+="<th></th>";$("thead tr:last-child",this.$dt_container).html(n);var s=$("tfoot tr",this.$dt_container),s=(s.html(n),s.hide(),this.dataTable=this.$dt_container.DataTable(this._getOptions2(t,e)),GCO5.core.GcDelayUtil.callLater(function(){$("tfoot").css("visibility","visible"),$("thead").css("visibility","visible")},[],8,this),GCO5.core.GcDelayUtil.callLater(this.onResize,[],2,this),(new Date).getTime()-r);console.log("datatables en: "+s/1e3+" s",GCO5.core.GcDelayUtil.curFrame()),this._nbRows=this._nbRowsFiltered=t.length},_getOptions2:function(t,e){for(var i,n=this._getDataTablesOptions(t),r=(n.columnDefs=[],n.columns=[],delete n.select,0);r<e.length;r++)i=r,n.columnDefs.push({targets:[i],className:"l"==e[r].align||0==r?"dt-left":"dt-right",visible:!0,searchable:!0}),n.columns.push({title:e[r].lib});return n},_getDataTablesOptions:function(t){var e=1.5*parseFloat(getComputedStyle(document.body).fontSize)+16+.5,i=GCO5.browser.height-this.$dt_container.offset().top-150,n=(this._indicData=t).length,r=GCO5.core.GcLangManager.getInstance(),a=this.isFluxTable(),i=e*Math.floor(i/e),e=i<n;return{scrollY:i+"px",scrollCollapse:!0,paging:e,scrollX:!1,iDisplayLength:1e4<n&&GCO5.browser.isFirefox?50:100,deferRender:!0,select:!a&&{style:GCO5.browser.isTouch?"multi":"os",info:null},autoWidth:!1,responsive:!0,dom:e?"rtip":"rt",language:{decimal:",",thousands:" ",info:r.getString("ROWS","tables")+" _START_ "+r.getString("TO")+" _END_ "+r.getString("OVER")+" _TOTAL_",select:{rows:""},oPaginate:{sFirst:r.getString("FIRST"),sPrevious:"<",sNext:">",sLast:r.getString("LAST")},oAria:{sSortAscending:": activer pour trier la colonne par ordre croissant",sSortDescending:": activer pour trier la colonne par ordre dé&eacute;croissant"},infoFiltered:""},data:t}}}),GCO5.model.indics.Dataset=GCO5.Class.extend({statics:{NAME:"GCO5.model.indics.Dataset",dts_o:{},tjs_o:{},registerDataset:function(t){GCO5.model.indics.Dataset.dts_o[t.getPk()]=t},registerTJSServers:function(t){var e,i=GCO5.core.GcArrayUtil.toIndexedObj(GCO5.appModel.getConcept("tjs"),"c_id_tjs");for(e in this.tjs_o={},t)this.tjs_o["_tjs_"+e]={tjs_o:i[e],indics:t[e]}},getDataset:function(t){return GCO5.model.indics.Dataset.dts_o[t]},getTJSDataset:function(t){return GCO5.model.indics.Dataset.tjs_o[t]},removeDataset:function(t){delete this.dts_o[t]},getDatasetListByCat:function(t){var e,i=[];for(e in this.dts_o){var n=this.dts_o[e];i.push({data:e,label:n.getName(),id_domaine:"_import",nbIndics:n.getNbIndics()})}return i},exportAllDatasets:function(){var t,e=null;for(t in this.dts_o){var i=this.dts_o[t];(e=e||[]).push({data:t,label:i.getName(),nbIndics:i.getNbIndics(),export_o:i.exportJSON()})}return e},getTree:function(){var t,e,i={c_id_tree:"_import",c_id_theme:"_import",c_lib:GCO5.core.GcLangManager.getInstance().getString("EXTERNAL_DATA","concepts"),c_ordre:-1},n=[],r=0;for(t in this.dts_o)r+=(e=this.dts_o[t]).getNbIndics(),n.push({c_id_theme:t,c_lib:e.getName(),c_id_tree:"_import",indicCount:e.getNbIndics()});for(t in this.tjs_o)r+=(e=this.tjs_o[t]).indics.length,n.push({c_id_theme:t,c_lib:e.tjs_o.c_lib_tjs,c_id_tree:"_import",indicCount:e.indics.length});return 0==r?null:(i.children=n,i.indicCount=r,[i])}},mapName:null,curMapName:null,curNivgeo:null,curIdExtent:null,nivgeo:null,id_extent:null,nivgeos:null,gclg:null,indicData:null,refgeoData:null,columns_a:null,index_o:null,id_dataset:null,libDataset:null,axes:null,mapIndicModels:null,pkFound:null,dp_o:null,lastSerie:null,codgeos_o:null,indexSerie:null,topology:null,initialize:function(t){this.gclg=GCO5.core.GcLangManager.getInstance(),this._setup(t)},getTopology:function(){return this.topology},getData:function(t){return this.dp_o[t||this.curNivgeo]},getInitialData:function(){return this.dp_o[this.nivgeo]},getName:function(){return this.libDataset},setName:function(t){this.libDataset=t},getPk:function(){return this.id_dataset},getIdExtent:function(){return this.id_extent},getCurMapName:function(t){return this.curMapName},setCurMapName:function(t){if(this.curMapName!=t){this.curMapName=t;var e,t=GCO5.appModel.getInfo("infoFromMapName",[t]);for(e in this.curNivgeo=t.c_id_nivgeo,this.curIdExtent=t.c_id_extent,this.mapIndicModels)this.mapIndicModels[e].clearComputedData();this.dp_o&&this.dp_o[this.curNivgeo]&&delete this.dp_o[this.curNivgeo][0].__rowid__}},getIndics:function(){return this.mapIndicModels},getMapIndicModel:function(t){return this.mapIndicModels[t]},exportJSON:function(){return{id_extent:this.id_extent,nivgeo:this.nivgeo,mapName:this.mapName,libDataset:this.libDataset,id_dataset:this.id_dataset,ngcRows_a:this._ngcRows,index_o:this.index_o,axes:this.axes,indexSerie:this.indexSerie,lastSerie:this.lastSerie,topology:this.topology,dp_o:this.dp_o}},_setup:function(t){var e;t&&(t.nivgeo?(this.nivgeo=t.nivgeo,this.id_extent=t.id_extent):t.mapName&&(e=GCO5.appModel.getInfo("infoFromMapName",[t.mapName]),this.nivgeo=e.c_id_nivgeo,this.id_extent=e.c_id_extent),this.curNivgeo=this.nivgeo,this.curMapName=this.mapName=t.mapName,this.curIdExtent=this.id_extent,this.topology=t.topology||"PG",this.nivgeos=[this.nivgeo],(e=GCO5.core.GcArrayUtil.getColumnByKey(GCO5.appModel.getInfo("surNivgeos",[this.nivgeo]),"id_nivgeo"))&&(this.nivgeos=this.nivgeos.concat(e)),t.mapDataset&&(this.dp_o[this.nivgeo]=t.mapDataset.getData()),this.refgeoData=GCO5.appModel.getRefData(this.nivgeo,this.id_extent),this.axes=[],this.index_o={})},getNivgeos:function(){return this.nivgeos},getAxis:function(t){t=GCO5.core.GcArrayUtil.getSubArray(this.axes,{type:t});return 0==t.length?null:t[0]},setAxis:function(t,e,i){var n=GCO5.core.GcArrayUtil.getSubArray(this.axes,{type:e});0==n.length?this.axes.push({id:t,type:e,values:i}):(n[0].id=t,n[0].values=i)},getTemporalAxis:function(){return this.getAxis("T")},setTemporalAxis:function(t,e){this.setAxis(t,"T",e)},getFilterAxis:function(){return this.getAxis("F")},setFilterAxis:function(t,e){this.setAxis(t,"F",e)},getColDataById:function(t,e){parseFloat(t);var i=this.index_o[this.curMapName],n=this.dp_o[this.curNivgeo],i=i?i[t]:t;return-1==i?null:n[i][e]},checkForPk:function(t){for(var e=this.dp_o[this.curNivgeo],i=e.length,n=t.length,r={},a=[],s=0;s<i;s++){for(var o=e[s],l="",c=0;c<n;c++)l+=String(o[t[c]]);if(a.hasOwnProperty(l))return r[l]=1,{status:"ko",row:o};a[l]=1}return{status:"ok"}},getRefgeoReverseIndex:function(t){var e=this.index_o[this.curMapName],i=this.getTemporalAxis(),n="PT"==this.topology;if(!e||t&&t!=this.indexSerie){n=n?this.refgeoData:GCO5.appModel.getRefData(this.curNivgeo,this.curIdExtent);if(!n)return null;var r=this.getData(this.curNivgeo),n=n.libgeo.length,e=this._indexRowid(r,n,i?i.id:null,t||this.lastSerie||(i?i.values[0]:null));t&&(this.indexSerie=t),this.index_o[this.curMapName]=e}return e},isXYMode:function(){return"PT"===this.topology},getCodgeosIndex:function(){var t=this.isXYMode()?this.refgeoData:GCO5.appModel.getRefData(this.curNivgeo,this.curIdExtent),i={};return t&&t.codgeo.forEach(function(t,e){i[t]=e}),i},_indexRowid:function(t,e,i,n,r){r=r||"__rowid__";this.topology;t[0].hasOwnProperty(r)||(a=this.getCodgeosIndex(),t.forEach(function(t,e){t.__rowid__=a[t.__idgeo__],void 0===t.__rowid__&&(s=!0)}),s&&(this.dp_o[this.curNivgeo]=t=t.filter(function(t){return void 0!==t.__rowid__}))),n&&((o={})[i]=n==parseFloat(n)?parseFloat(n):[n,parseFloat(n)],t=GCO5.core.GcArrayUtil.getSubArray(t,o));for(var a,s,o,l=new Int32Array(e),c=(t.length,0);c<e;c++)l[c]=-1;return n?t.forEach(function(t){l[t[r]]=t.__rownum__}):t.forEach(function(t,e){l[t[r]]=e}),l}}),GCO5.model.indics.DatasetImported=GCO5.model.indics.Dataset.extend({statics:{NAME:"GCO5.model.indics.DatasetImported",nbImports:0,BEFORE_ADD_INDICS:"addInds",importJSON:function(t,e){var i=new GCO5.model.indics.DatasetImported(t);return i.columns_a=t.columns_a,i.dp_o=t.dp_o,i._status=1,i._ngcRows=t.ngcRows_a,i.axes=t.axes,i.indexSerie=t.indexSerie,i.lastSerie=t.lastSerie,"PT"==i.getTopology()&&e&&e[t.id_dataset]&&(i.refgeoData=e[t.id_dataset],GCO5.appModel.registerRefData(t.id_dataset,t.id_extent,{territories:i.refgeoData})),i._buildMapIndicModels(),i},updateImprtCpt:function(t){isNaN(t)||(this.nbImports=Math.max(+t,this.nbImports))}},gcsm:GCO5.core.SystemManager.getInstance(),crlf:null,pasted_a:null,_status:null,_idComputedIndic:null,_reportMsg:null,_reportMsgShort:null,_ngcRows:null,_selgeoOnly:null,_longLat:null,refMap:null,columns_a:null,newcol_o:null,_delimColumns:null,_setup:function(t){this._super(t),this._status=0,this._delimColumns="\t",this.codgeos_o=this.getCodgeosIndex(),this.id_dataset=t.idDataset||t.id_dataset||"_import"+ ++this.constructor.nbImports,this.libDataset=t.libDataset||this.gclg.getString("DATASET","concepts")+" "+this.constructor.nbImports,GCO5.model.indics.Dataset.registerDataset(this)},exportJSON:function(){var t,e=this._super(),i=(e.columns_a=GCO5.core.GcObjectUtil.cloneJson(this.columns_a),GCO5.core.GcArrayUtil.toIndexedObj(e.columns_a,"pk"));for(t in this.mapIndicModels){var n=this.mapIndicModels[t],r=n.getIndicModel(),a=r.getProp("idIndicateur"),s=i[a];s||((s={pk:a}).type=n.isChoroNum()?"D":"N",e.columns_a.push(s)),s.lib_indicateur=r.getProp("libIndic"),s.lib_indicateur_court=r.getProp("shortLibIndic"),s.prec=r.getProp("nbDec"),s.unit=r.getProp("unit"),s.frm_type=r.getProp("formulaType"),s.vars_a=r.getProp("vars"),s.VIlibs=r.getProp("VILibs"),s.nbvars=r.getProp("nbVars"),s.colf=r.getProp("hexColors"),s.c_topo=r.getProp("topology"),s.idSymbLayer=r.getProp("idSymbLayer"),s.view=r.getProp("view"),n.isChoroVI()&&delete s.codes_a,delete s.val_a}return e},destroy:function(){this.constructor.nbImports--},getNonGeocodRows:function(){return this._ngcRows},getNewComputedIndicPk:function(){return this._idComputedIndic||(this._idComputedIndic=0),"_composite_pk"+ ++this._idComputedIndic},getCurrentMapData:function(){var t,e=this.getTemporalAxis(),i=this.getData();return e&&((t={})[e.id]=[e.values[0],parseFloat(e.values[0])],i=GCO5.core.GcArrayUtil.getSubArray(i,t)),i},getImportReport:function(){return this._reportMsg},getImportReportShort:function(){return this._reportMsgShort},zoomOnCurrentIdsWithValues:function(t){var e=this.getCurrentMapData(),i=this.refgeoData.codgeo.length;e.length/i<.1&&"PT"!=this.topology&&t.zoomOnFeatureId(null,GCO5.core.GcArrayUtil.getColumnByKey(e,"__rowid__"))},getCurrentIdsWithValues:function(){var t=this.getCurrentMapData();return GCO5.core.GcArrayUtil.getColumnByKey(t,"__rowid__")},_testCSVDelims:function(t,e,i){return this._testCSVDelim(t,e,i,";")||this._testCSVDelim(t,e,i,",")},_testCSVDelim:function(t,e,i,n){for(var r,a,s,o=!1,l=0;l<i;l++)r=t[l].split(n),a?1<r.length&&a<=r.length&&(o=!0):a=r.length;return!!o&&(s=new RegExp('""',"g"),t.length<5e4&&(e=e.replace(s,"'")),s=new RegExp('"',"g"),{pasted_a:(e=e.replace(s,"")).split(this.crlf),delimDec:".",delimColumns:n})},checkPastedData:function(t,e){var i=t.indexOf("\r\n"),n=(this.crlf=0<=i?"\r\n":0<=t.indexOf("\r")?"\r":"\n",e),r=(0<t.indexOf(" ")&&(i=new RegExp(" ","g"),t=t.replace(i," ")),this.pasted_a=t.split(this.crlf)),i=this.gclg.formatNumber(r.length,0,!0)+" "+this.gclg.getString("ROWS","tables")+"\r"+r.slice(0,8).join("\r"),a=Math.min(20,r.length-1),s=0;if(t.indexOf("\t")<0&&((t=this._testCSVDelims(r,t,a))&&t.delimColumns&&(this.pasted_a=r=t.pasted_a,this._delimColumns=t.delimColumns,n=e=t.delimDec)),"PT"==this.topology){for(var o=0,l=0,c=0,n=e||this.gclg.get_delim_dec(),h=this.gclg.get_delim_mil_raw(),d=1;d<a;d++){(l+=0<=(g=r[d].split(this._delimColumns))[0].indexOf("."))&&","==n&&(n=".");var u=this._corrNumber(g[0],h,n).v,p=this._corrNumber(g[1],h,n).v;isNaN(u)||isNaN(p)||(o++,0<d&&Math.abs(u)<=180&&Math.abs(p)<=180&&c++)}return o/a<.1?{msg:this.gclg.getString("ERROR")+this.gclg.getString("P2B")+" "+this.gclg.getString("ERR_LINE12_XY","pilotage","externaldata")+i,delimCol:this._delimColumns,delimDec:n}:(this._longLat=.1<c/a,this._status=1,{msg:i,delimCol:this._delimColumns,delimDec:n})}this.refgeoData.codgeo.length;var g,f=(g=r[0].split(this._delimColumns)).length;for(d=1;d<a;d++){if((g=r[d].split(this._delimColumns)).length!=f)return{msg:this.gclg.getString("ERROR")+this.gclg.getString("P2B")+" "+"\r"+this.gclg.getString("ERR_COLNAMES_CRLF","pilotage","externaldata"),delimCol:this._delimColumns,delimDec:n};this.codgeos_o.hasOwnProperty(g[0].trim())&&s++}if(s/a<.1){for(a=r.length-1,d=s=0;d<a;d++)g=r[d].split(this._delimColumns),this.codgeos_o.hasOwnProperty(g[0].trim())&&s++;if(s/a<.1)return{msg:this.gclg.getString("ERROR")+this.gclg.getString("P2B")+" "+this.gclg.getString("CODES")+" "+GCO5.appModel.getInfo("libNivgeo",[this.nivgeo,!0,!0])+" "+this.gclg.getString("NON_GEOCOD","pilotage","externaldata")+"."+"\r"+this.gclg.getString("SELECT_PROPER_NIVGEO","pilotage","externaldata")+"\r"+i,delimCol:this._delimColumns,delimDec:n}}return this._status=1,{msg:i,delimCol:this._delimColumns,delimDec:n}},isValid:function(){return!!this._status},parsePastedData:function(t){var e=this.isXYMode()?this._getColumnsXY(this.pasted_a):this._getColumns(this.pasted_a),i=t.delimDec,n=t.epsg;if(t.map&&(this.refMap=t.map),"ko"==e.status)return this.pasted_a=null,{status:"ko",errMsg:e.txt};function r(t){return a.gclg.getString(t,"pilotage","externaldata")}var t=this._readAndAnalyzeData(this.pasted_a,e.columns_a,e.rowIndex,i,n),a=this;if("ko"==t.status)return this.pasted_a=null,t;var i=this.gclg.getString("P2B"),n=t.impRows_a.length,s=t.ngcRows_a.length,i=(this._reportMsg=r("NB_ROWS_IMPORTED")+i+" "+this.gclg.formatNumber(n+s,0,!0)+"<br>"+r("NB_ROWS_NON_GEOCODED")+i+" "+this.gclg.formatNumber(s,0,!0)+"<br>"+r("SUCCESS_RATE")+i+" "+this.gclg.formatNumber(100*n/(n+s),1,!0)+" %",this._reportMsgShort=r("ROWS_GEOCODED")+i+" "+this.gclg.formatNumber(n,0,!0)+", "+this.gclg.getString("WHICH_IS")+" "+this.gclg.formatNumber(100*n/(n+s),0,!0)+" % "+r("FROM_PASTED_DATA"),this.dp_o={},this.dp_o[this.nivgeo]=t.impRows_a,this._ngcRows=t.ngcRows_a,this.columns_a=e.columns_a,this._validateFieldsType(t.impRows_a,this.columns_a));return i&&"ko"==i.status&&(t=i),this.pasted_a=null,t},getNumericFields:function(){return this.columns_a.filter(function(t){return"C"!=t.type&&GCO5.core.GcStringUtil.isEmpty(t.axe)}).map(function(t){return{data:t.pk,type:t.type}})},getFieldInfo:function(e){var t=this.columns_a.filter(function(t){return t.pk==e});return 1==t.length?t[0]:null},_getColumns:function(t){for(var e=t.length,i=[],n=0,r=-1,a=1;0==n&&r<e;)if(""!=t[++r]){for(var s,o=(s=t[r].split(this._delimColumns)).length,l=0;l<o;l++){var c=GCO5.core.GcStringUtil.validColName(s[l]);if(GCO5.core.GcMathUtil.isNumber(c)||GCO5.core.GcMathUtil.isNumber(c.substr(0,1))&&1==o){if(1<o)return{status:"ko",txt:this.gclg.getString("ERR_COLNAMES_MISSING","pilotage","externaldata")};a=0}c=c.trim(),i.push({pk:0==l?"__idgeo__":c,type:0==l?"C":"N",type2:"",type0:"",typind_a:[],nbcar:0,prec:0,nbcarmin:Number.POSITIVE_INFINITY,lastValNumIndex:-1,minth:Number.POSITIVE_INFINITY,maxth:Number.NEGATIVE_INFINITY,validName:1,ecrase:0,codgeo:Number(0==l),nbtype2:0,anulls0:[],anulls_o:{},nbNulls:0,source:"",lib_indicateur:s[l].trim(),lib_indicateur_court:s[l].trim(),unit:"",cat:null,typind:null,VImods:null,VIcols:null,VIlibs:null})}n=1}return{status:"ok",columns_a:i,rowIndex:a}},_getColumnsXY:function(t){for(var e=t.length,i=[],n=0,r=-1,a=1;0==n&&r<e;)if(""!=t[++r]){for(var s,o=(s=t[r].split(this._delimColumns)).length,l=0;l<o;l++){var c=GCO5.core.GcStringUtil.validColName(s[l]);if(GCO5.core.GcMathUtil.isNumber(c)||GCO5.core.GcMathUtil.isNumber(c.substr(0,1))&&1==o){if(1<o)return{status:"ko",txt:this.gclg.getString("ERR_COLNAMES_MISSING","pilotage","externaldata")};a=0}c={pk:c=c.trim(),type:2==l?"C":"N",axe:l<=2?"G":null,nbcar:0,prec:0,type2:"",minth:Number.POSITIVE_INFINITY,maxth:Number.NEGATIVE_INFINITY,lastValNumIndex:-1,validName:1,ecrase:0,codgeo:0,nbtype2:0,anulls0:[],anulls_o:{},anulls:[],nulls:"",source:"",lib_indicateur:c,lib_indicateur_court:c,unit:"",cat:null,typind:null,VImods:null,VIcols:null,VIlibs:null,idSymbLayer:this.getPk(),c_topo:"PT"};0==l&&(c.pk="__x__"),1==l&&(c.pk="__y__"),3==o&&2==l?c.pk="__libgeo__":3<o&&(2==l&&(c.pk="__idgeo__"),3==l&&(c.pk="__libgeo__",c.type="C",c.axe="G")),i.push(c)}n=1}return{status:"ok",columns_a:i,rowIndex:a}},_computeBbox:function(t){this.tjs_pt_bbox.West=Math.min(this.tjs_pt_bbox.West,t.x),this.tjs_pt_bbox.East=Math.max(this.tjs_pt_bbox.East,t.x),this.tjs_pt_bbox.South=Math.min(this.tjs_pt_bbox.South,t.y),this.tjs_pt_bbox.North=Math.max(this.tjs_pt_bbox.North,t.y)},_readAndAnalyzeData:function(t,e,i,n,r){for(var a,s,o,l,c,h=n||this.gclg.get_delim_dec(),d=this.gclg.get_delim_mil_raw(),u=0,p=[],g=[],f={},m=[],_=t.length,v=e.length,y=this.refgeoData.libgeo,b=this.isXYMode(),C=(b&&(l={},c=new((n=GCO5.model.maps.AProj4.PROJ_FAM["e"+r])?GCO5.model.maps["Proj4"+n]:GCO5.model.maps.AProj4)(r),this.tjs_pt_a=[],this.tjs_pt_bbox={West:180,South:180,East:-180,North:-180}),","==h&&","==d&&(d=" "),i);C<_;C++){var x=t[C];if(""!==x.trim()){for(var w=x.split(this._delimColumns),S={},M=!1,O=0;O<v;O++){var G=w[O].trim(),I=e[O],T=I.pk;if(b&&O<=2)0==O?w[0]+""+w[1]!=""&&(l.x=this._corrNumber(w[0],d,h).v,l.y=this._corrNumber(w[1],d,h).v,A=l,this._longLat?(this._computeBbox(l),A=c.longLat_to_LocalProj(l.x,l.y)):this._computeBbox(c.localProj_to_LongLat(A.x,A.y)),this.tjs_pt_a.push({__idgeo__:w[2],x:A.x,y:A.y}),S.__x__=A.x,S.__y__=A.y,M=!0):2==O&&((a=G.length)>I.nbcar&&(I.nbcar=a),void 0!==m[s="s"+(S[T]=G)]?f[s]=1:m[s]=1,u++,M=!0);else if(0==O){(a=G.length)>I.nbcar&&(I.nbcar=a),S[T]=G;var A=this.codgeos_o[G];0<=A?(S.__rowid__=A,void 0!==m[s="s"+G]?f[s]=1:m[s]=1,S.__libgeo__=G+" - "+y[A],u++,M=!0):S.__libgeo__=G}else if("N"==I.type)1==(o=this._isChar(G,d,h))?(I.type="C",(a=G.length)>I.nbcar&&(I.nbcar=a),a<I.nbcarmin&&(I.nbcarmin=a),G<I.minth&&(I.minth=G),G>I.maxth&&(I.maxth=G),S[T]=G):-1===o?(S[T]=M?-9999:" ",I.nbNulls++):(N=this._corrNumber(G,d,h),I.unit=N.unit,(a=N.nd)>I.prec&&(I.prec=a),(L=N.v)<I.minth&&(I.minth=L),L>I.maxth&&(I.maxth=L),S[T]=L,I.lastValNumIndex=u-1);else if("C"==I.type)if((a=G.length)>I.nbcar&&(I.nbcar=a),a<I.nbcarmin&&(I.nbcarmin=a),o=this._isChar(G,d,h),b&&2==O)S[T]=G;else if(0===o){if(""==I.type2)for(var P=I.lastValNumIndex+1;P<u-1;P++){var D=p[P],E=D[T];"0"!=String(E).substr(0,1)&&(I.anulls_o[E]||(I.anulls_o[E]=0),I.anulls_o[E]++,D[T]=-9999,D[T+"_orig"]=E,0)}""!=G&&(I.type2="N");var N=this._corrNumber(G,d,h),L=(I.prec=Math.max(I.prec,N.nd),I.unit=N.unit,Number(N.v));N.empty;I.minth=Math.min(I.minth,L),I.maxth=Math.max(I.maxth,L),I.lastValNumIndex=u-1,S[T]=""===N.v?null:L}else-1===o?(S[T]=null,I.nbNulls++):"N"==I.type2?"0"!=String(E).substr(0,1)?(I.anulls_o[G]||(I.anulls_o[G]=0),I.anulls_o[G]++,S[T]=-9999,S[T+"_orig"]=G):S[T]=G:(S[T]=G,(I.minth===Number.POSITIVE_INFINITY||G<I.minth)&&(I.minth=G),(I.maxth===Number.NEGATIVE_INFINITY||G>I.maxth)&&(I.maxth=G))}(M?p:g).push(S)}}0<GCO5.core.GcObjectUtil.count(f)?e[0].doublons=1:this.pkFound=!0,b||p.sort(function(t,e){return t.__rowid__-e.__rowid__});n=this.gclg.getString("SELECTION","concepts");return this.newcol_o={VIcols:null,VIlibs:null,VImods:null,anulls0:[],anulls_o:{},cat:null,codgeo:0,ecrase:0,efts:{X:p.length},lastValNumIndex:-1,lib_indicateur:n,lib_indicateur_court:n,maxth:"X",minth:"X",mods:["X"],nbNulls:0,nbcar:0,nbcarmin:1/0,nbtype2:0,pk:"selcodgeos",prec:0,source:"",type:"C",type0:"N",type2:"",typind:"I",typind_a:["I"],unit:"",validName:1},1==v&&(this._selgeoOnly=!0,e.push(this.newcol_o),p.forEach(function(t){t.selcodgeos="X"})),2==v&&(this.impRows_a=p),{impRows_a:p,ngcRows_a:g,columns_a:e,status:"ok"}},_buildPointRefData:function(t){for(var e,i=[],n=[],r=[],a=[],s=t.length,o={},l=this.refMap.getWtoSMatrix0(),c={},h=[],d=0;d<s;d++){var u=t[d];c[u.__idgeo__]=u}for(e in c)h.push(e);for(e in h.sort(),h)u=c[h[e]],o.x=u.__x__,o.y=u.__y__,o=l.transformPoint(o.x,o.y),i.push(Math.round(100*o.x)/100),n.push(Math.round(100*o.y)/100),r.push(u.__idgeo__),a.push(u.__libgeo__);var p=this.refMap.getStatLayer().getTopoModel(),p=GCO5.core.GcObjectUtil.cloneJson(p.params),p=(p.mult_xy=1,p.topo="P",p.nbObjs=r.length,{x:i,y:n,codgeo:r,libgeo:a,codgeo_a:r,libgeo_a:a,pt:{x:i,y:n},params:p});GCO5.appModel.registerRefData(this.getPk(),this.refMap.getIdExtent(),{territories:p}),this.refgeoData=p},isSelgeoOnly:function(){return!0===this._selgeoOnly},_validateFieldsType:function(t,e){for(var i=t.length,n=[],r=(e[0].axe="G","PT"==this.topology),a={},s=1;s<e.length;s++){var o=e[s],l=o.pk;if(a[l])return{status:"ko",errMsg:this.gclg.getString("THE_COL","pilotage","externaldata")+" '"+l+"' "+this.gclg.getString("IS_REPEATED","pilotage","externaldata")};if(a[l]=1,o.type0=o.type,0<o.prec&&"N"==o.type&&(o.type="D"),o.nbNulls>=i)o.empty=!0;else{if("N"==o.type2){o.nbtype2=GCO5.core.GcObjectUtil.sum(o.anulls_o);var c=GCO5.core.GcObjectUtil.count(o.anulls_o);if(100*o.nbtype2/i<30&&c<3&&0<c||1==c)0<o.prec?o.type="D":o.type="N",o.anulls0=GCO5.core.GcObjectUtil.keys(o.anulls_o),o.nbcar=200;else{n.push(l),o.type="C",o.anulls0=[];for(var h=0;h<i;h++){var d=t[h];null==d[l]&&(d[l]=d[l+"_orig"])}}}if("C"==o.type&&"__idgeo__"!=l&&"__libgeo__"!=l){var u,p=String(o.minth),g=(u=GCO5.core.GcArrayUtil.getUniqueValues(t,"S",o.pk,null,!0)).a.filter(function(t){return-9999!=t&&null!==t}),f=u.s;if(!this.getTemporalAxis()&&e[0].doublons&&2<=p.length&&p.length==String(o.maxth).length&&g.length<100&&this._testTemporalAxis(e[0].pk,o,g),"T"!=o.axe){var m,_=0;for(m in g)this.codgeos_o.hasOwnProperty(g[m])&&_++;var v,c=.5<_/g.length;!c&&.8<g.length/i&&20<i&&(o.libsuspected=!0),o.typind=g.length<10||!c?"I":"O",o.typind_a="N"==o.type0?["I","R"]:c?["I","O"]:["I"],c&&20<g.length&&(o.typind_a=["O"]),o.mods=g,o.efts=f,c&&g.length<=20&&(v=this,o.VIlibs=o.mods.map(function(t){return v.refgeoData.libgeo[v.codgeos_o[t]]}))}}"N"==o.type&&(!r||2<=s)&&((p=String(o.minth)).length==String(o.maxth).length&&"0"!=p?(g=(u=GCO5.core.GcArrayUtil.getUniqueValues(t,"S",o.pk,null,!0)).a,f=u.s,!this.getTemporalAxis()&&(e[0].doublons||1==g.length)&&2<=p.length&&g.length<100&&this._testTemporalAxis(e[0].pk,o,g),"T"!=o.axe&&g.length<100&&(g.length/i<.5?(o.type="C",o.typind="I",o.mods=g,o.efts=f,o.typind_a=["I","R","C"]):(o.typind="R",o.mods=g,o.typind_a=["R","C","I"]))):(o.cat=GCO5.model.indics.MapIndicModel.SYMB_GRAD,o.typind="R",o.typind_a=["C","R"])),"D"==o.type&&(o.cat=r?GCO5.model.indics.MapIndicModel.SYMB_PTCHORO:GCO5.model.indics.MapIndicModel.CHORO_NUM,o.typind="C",o.typind_a=["C","R"])}}if(!this.getTemporalAxis()&&e[0].doublons)return{status:"ko",errMsg:this.gclg.getString("ERR_DBLS","pilotage","externaldata")};(r="PT"==this.topology)&&(this._addPresenceField(e,t),this._buildPointRefData(t));var y=this.refgeoData.libgeo.length,b=t.length,C=this.getTemporalAxis();if(C)for(h=0;h<b;h++)t[h].__rownum__=h;this.index_o[this.curMapName]=this._indexRowid(t,y,C?C.id:null,C?C.values[0]:null)},_addPresenceField:function(t,e){var i=t.filter(function(t,e){return!t.axe&&!t.libsuspected&&!t.empty}),n=this.newcol_o;0==i.length&&(n.pk="presence",n.idSymbLayer=this.getPk(),n.c_topo="PT",n.lib_indicateur=n.lib_indicateur_court="Présence",t.push(n),e.forEach(function(t){t.presence="X"}))},setSerie:function(t){var e=GCO5.appModel.getRefData(this.curNivgeo,this.curIdExtent),e=e?e.libgeo.length:0,i=this.getTemporalAxis();this.lastSerie=t,0<e&&(this.index_o[this.curMapName]=this._indexRowid(this.getData(),e,i.id,t))},getSerie:function(){return this.lastSerie},_testTemporalAxis:function(t,e,i){t=this.checkForPk([t,e.pk]);return"ok"==t.status?(this.setTemporalAxis(e.pk,i.sort().reverse().map(function(t){return String(t)})),e.axe="T",e.type="C",e.typind_a="N"==e.type0?["I","R"]:["I","O"],e.nbcar=i.reduce(function(t,e){return String(e).length>t?String(e).length:t},0),this.pkFound=!0):console.log("_testTemporalAxis KO",e.pk),t},updMapIndicModel:function(t){this.mapIndicModels[t.getPk()]=t},deleteMapIndicModel:function(t){delete this.mapIndicModels[t.getPk()],GCO5.core.GcArrayUtil.deleteItemByKey(this.columns_a,"pk",t.getProp("idIndicateur"))},getUsableNivgeos:function(){var t,e=[];for(t in this.mapIndicModels)var i=this.mapIndicModels[t].getProp("nivgeos"),e=e.concat(i);return GCO5.core.GcArrayUtil.getUniqueValues(e)},_buildMapIndicModels:function(t){var e,i=[],n=0,r=(this.mapIndicModels={},this.isXYMode());for(e in 2==this.columns_a.length&&this.columns_a[1].libsuspected&&(this._selgeoOnly=!0,this.columns_a=[this.columns_a[0]].concat([this.newcol_o]),this.impRows_a.forEach(function(t){t.selcodgeos="X"})),this.columns_a){var a,s,o=this.columns_a[e];o.axe||o.libsuspected||o.empty||(a=GCO5.core.GcObjectUtil.cloneJson(o),s=0,"C"==o.type?("I"==o.typind?this._addVIAttributes(a):this._addOursinsAttributes(a),s=1):"D"==o.type?(this._addChoroNumAttributes(a),s=1):"N"==o.type&&(this._addSymbGradAttributes(a),s=1),s&&(a.distrib_o||(a.distrib_o={eftnullsth:a.nbNulls,minth:o.minth,maxth:o.maxth}),i.push({im:this._createIndicModel(a),ordre:n++,pk:a.pk})))}i.sort(function(t,e){return t.ordre-e.ordre});var l,c=this.getPk();r&&((l={})[c+"_P"]=GCO5.appModel.getRefData(c,this.refMap?this.refMap.getIdExtent():this.id_extent));for(var h=0;h<i.length;h++){var d=this.mapIndicModels[i[h].im.getPk()]=new GCO5.model.indics.MapIndicModel(i[h].im);r&&GCO5.appModel.getPointLayerDef(d,l,this.refMap?this.refMap.getName():this.mapName)}t&&($(t).triggerHandler(this.constructor.BEFORE_ADD_INDICS,[{dts:this}]),t.addThemes(this.mapIndicModels))},reBuildMapIndicModel:function(t,e,i){var n=this.getFieldInfo(t),t=!0;if(i)for(var r in i)n.hasOwnProperty(r)&&(n[r]=i[r]);"I"==e?this._addVIAttributes(n):"O"==e?this._addOursinsAttributes(n):"C"==e?this._addChoroNumAttributes(n):"R"==e?this._addSymbGradAttributes(n):t=!1;var a,e="PT"==this.topology,s=this.getPk();if(e&&((a={})[s+"_P"]=GCO5.appModel.getRefData(s,this.refMap?this.refMap.getIdExtent():this.id_extent)),t)return s=this._createIndicModel(n),t=new GCO5.model.indics.MapIndicModel(s),e&&GCO5.appModel.getPointLayerDef(t,a,this.refMap?this.refMap.getName():this.mapName),this.mapIndicModels[s.getPk()]=t},reloadThemes:function(t){if(this.mapIndicModels){for(var e in $(t).triggerHandler(this.constructor.BEFORE_ADD_INDICS,[{dts:this}]),this.mapIndicModels)this.mapIndicModels[e].enable();t.addThemes(this.mapIndicModels)}else this._buildMapIndicModels(t)},getNbIndics:function(){return GCO5.core.GcObjectUtil.count(this.mapIndicModels)},loadInMap:function(t){return this.mapIndicModels||this._buildMapIndicModels(t),this.mapIndicModels},_createIndicModel:function(t){var e=this.getTemporalAxis(),i=(t.idDataset=t.c_id_dataset=this.getPk(),e&&(t.serie=e.values[0],this.getTemporalAxis(),this.lastSerie||(this.lastSerie=t.serie),t.series=e.values.concat().sort(),t.data_series=t.series.concat()),GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("views"),{c_id_extent:this.id_extent}).map(function(t){return t.id_nivgeo}),t.nivgeos="C"==t.typind&&t.frm_type||"R"==t.typind?this.nivgeos:[this.nivgeo],"PT"==this.topology&&(t.nivgeos=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("views"),{c_id_extent:this.id_extent}).map(function(t){return t.id_nivgeo})),t.views=t.c_id_views=GCO5.appModel.getInfo("mapNamesFromNivgeos",[t.nivgeos,this.id_extent,"id_view"]),t.view=this.refMap?this.refMap.getName():this.mapName,t.nivgeo=this.nivgeo,t.id_extent=this.id_extent,t.source=t.source||"",t.precisions="",t.unit=t.unit||"",t.libIndic=t.lib_indicateur||t.libIndic||t.pk,t.shortLibIndic=t.lib_indicateur_court||t.shortLibIndic||t.pk,t.idIndicateur=t.pk,t.dataSource=t.dataSource||"col",GCO5.appModel.getInitKey("nivgeo_o")),e=(t.libnivgeos=t.nivgeos.map(function(t){return i[t].c_lib_nivgeo}).join(", "),new GCO5.model.indics.IndicModel(t,"GcIndicModelImported")),t=GCO5.core.GcArrayUtil.indexOfByKey(this.columns_a,"pk",t.pk);return 0<=t&&this._updateColumnType(this.columns_a[t],e),e},_updateColumnType:function(t,e){e.isAdditive()?t.type="N":e.isRatio()?t.type="D":t.type="C"},_addOursinsAttributes:function(t){t.cat=GCO5.model.indics.MapIndicModel.SYMB_OURSINS,t.typind="O",t.nbdec=0,t.colf=["#ff0000"],t.codgeos_o=this.codgeos_o},_addSymbGradAttributes:function(t,e){t.cat=GCO5.model.indics.MapIndicModel.SYMB_GRAD,t.typind="R",t.nbdec=Math.min(2,t.prec),t.falpha=70,t.colf||(t.colf=null!=t.minth&&t.minth<0?["#ff0000","#0000ff"]:["#5C85CC"]),e&&!t.vars_a&&(t.nbvars=2,t.vars_a=t.VImods=t.VIlibs=t.colf=[]),t.nivgeos=this.nivgeos,t.views=t.c_id_views=GCO5.appModel.getInfo("mapNamesFromNivgeos",[t.nivgeos,this.id_extent,"id_view"])},_addChoroNumAttributes:function(t){var e="PT"==this.topology;t.cat=e?GCO5.model.indics.MapIndicModel.SYMB_PTCHORO:GCO5.model.indics.MapIndicModel.CHORO_NUM,t.typind="C",t.nbClasses=5,t.meth="quant",t.nbdec=Math.min(3,t.prec),!isNaN(t.maxth)&&1e3<t.maxth&&(e=(+t.maxth.toPrecision(3)+"").split("."),t.nbdec=2==e.length?e[1].length:0),t.colf=null,t.idColFam=t.c_id_colfam=GCO5.model.indics.MapIndicModel[t.minth<0?"DEFAULT_COLFAM_DIVERGING":"DEFAULT_COLFAM_ORDERED"]},_addVIAttributes:function(t){var e,i="PT"==this.topology;t.cat=i?GCO5.model.indics.MapIndicModel.SYMB_PTVI:GCO5.model.indics.MapIndicModel.CHORO_VI,t.typind="I",t.VImods=t.classes=t.mods.concat().sort();for(var n=0;n<t.VImods.length;n++)if("null"==t.VImods[n]){e=!0;break}e&&t.VImods.splice(n,1),t.VIlibs||(t.VIlibs=t.VImods.concat()),t.VIcols||(t.VIcols=t.colf||GCO5.model.indics.MapIndicModel[i?"COLFPTVI":"COLFVI"].slice(0,t.VImods.length)),t.mods_o={},t.symbs=[],t.sizes=[];for(var r=0;r<t.VImods.length;r++)t.mods_o[String(t.VImods[r])]=t.VIlibs[r],t.symbs[r]="cc",t.sizes[r]=5;t.distrib_o={eftnullsth:t.nbNulls};var a,s=[];for(a in t.efts)s.push({code:a,eft:t.efts[a]});t.distrib_o.frequences=s},_isChar:function(t,e,i){if(null==t||""===t||""===String(t).trim())return-1;var n=t.substr(0,1);if("$"===n||"£"===n)t=t.substr(1);else{if("A"<=n&&"-"!=n)return 1;if("0"===n&&1<t.length&&t.substr(1,1)!==i)return 1}"%"!==(n=t.substr(-1,1))&&"€"!=n||(t=t.substr(0,t.length-1));n=Number(t);return n<=0||0<n?0:(t=t.replace(/ /g,""),0<=(t="."===i?t.replace(/,/g,""):t).indexOf(",")&&((n=Number(t.replace(/,/g,".")))<=0||0<n)||(n=Number(t))<=0||0<n?0:1)},_corrNumber:function(t,e,i){var n,r=t.substr(0,1),a="",r=("$"!==r&&"£"!==r||(a=r,t=t.substr(1)),"%"!==(r=t.substr(-1,1))&&"€"!==r||(t=t.substr(0,t.length-1),a=r),Number(t));if((r<=0||0<r)&&(0|r)===r)return{v:r,nd:0,unit:a};if(r<=0||0<r)return(0|r)===r?{v:r,nd:0,unit:a}:{v:r,nd:(n=t.split("."))[1].length,unit:a};if((r=this._deFormat(t,e,i))<=0||0<r)return{v:r,nd:1==(n=t.split(i)).length?0:n[1].length,unit:a};e=parseFloat(t.replace(/,/g,"."));return n=t.split("."),e<=0||0<e?{v:e,nd:1==n.length?0:n[1].length,unit:a}:{v:t,nd:-1,unit:a}},_deFormat:function(t,e,i,n){var r=String(t).split(e).join("");return""==(r=(r="."!=i?r.split(i).join("."):r).trim())?"":(isNaN(r)&&null==n&&(r=this._deFormat(t,e,i="."==i?",":".",1)),isNaN(r)?r:parseFloat(r))},agreg:function(t){GCO5.appModel.loadRelationRefData(this.agreg2,this,this.nivgeo,this.id_extent,t)},agreg2:function(t,e){var i={},n=this.getData(this.nivgeo),r=n.length,a=this.getTemporalAxis(),s=a?a.id:null,o=t[e],l=(t.codgeo.forEach(function(t,e){i[t]=o[e]}),[]),c=[],h=[];this.columns_a.forEach(function(t){t.axe||"N"!=t.type||l.push(t.pk)});for(var d=0;d<r;d++){var u,p,g=n[d];(o=i[g.__idgeo__])&&void 0!==g.__rowid__&&(u=(s?g[s]+"|":"")+o,(p=c[u])?l.forEach(function(t){-9999!=g[t]&&(p[t]+=+g[t])}):(h.push(c[u]=p={__idgeo__:o}),s&&(p[s]=g[s]),l.forEach(function(t){-9999!=g[t]?p[t]=+g[t]:p[t]=0})))}h.sort(function(t,e){return t.__idgeo__-e.__idgeo__}),h.forEach(function(t,e){t.__rownum__=e}),this.dp_o[e]=h},tryDisplayIndicOnMap:function(t,e,i){var n,r=this.mapIndicModels[t],a=this,t=r.getProp("nivgeos"),s=e.getName(),o=r.getIndicModel().getViewsCompatible();return i=i||{render:!0},o&&o.indexOf(s)<0&&(o=t[0],t=GCO5.appModel.getInfo("infoFromMapName",[s,"id_extent"]),s=(s=GCO5.appModel.getInfo("mapNameFromNivgeo",[o,t]))||GCO5.appModel.getInfo("mapNameFromNivgeo",[o])),e.getName()!=s?{action:"loadNewMap",mapName:s}:(n=e.nivgeo,this.getData(n)?(r.getIndicModel().setNivgeo(n),this.setCurMapName(s),e.addTheme(r,i)):GCO5.appModel.loadRelationRefData(function(t){a.agreg2(t,n),a.setCurMapName(s),e.addTheme(r,i)},a,a.nivgeo,e.getIdExtent(),n),{action:"none"})},prepareBeforeNewMap:function(n,r,a,s,o){var l=GCO5.appModel.getInfo("infoFromMapName",[a,"nivgeo"])||GCO5.appModel.getInfo("infoFromMapName",[a,"id_nivgeo"]),c=this;this.getData(l)?(this.setCurMapName(a),GCO5.appModel.loadMapViewModel(n,r,a,o,s)):0<=this.nivgeos.indexOf(l)?GCO5.appModel.loadRelationRefData(function(t){c.agreg2(t,l),c.setCurMapName(a);var e,i={};for(e in s)s[e].isAgregable()&&(i[e]=s[e]);GCO5.appModel.loadMapViewModel(n,r,a,o,i)},c,this.nivgeo,this.id_extent,l):GCO5.appModel.loadMapViewModel(n,r,a,o,s)}}),GCO5.model.maps.RefgeoCacheModelV5=GCO5.Class.extend({statics:{NAME:"GCO5.model.maps.RefgeoCacheModelV5",instance:null,getInstance:function(){return null==GCO5.model.maps.RefgeoCacheModelV5.instance&&(GCO5.model.maps.RefgeoCacheModelV5.instance=new GCO5.model.maps.RefgeoCacheModelV5),GCO5.model.maps.RefgeoCacheModelV5.instance}},refgeo_o:null,initialize:function(){this._setup()},_setup:function(){this.refgeo_o={}},registerData:function(t,e,i){this.refgeo_o[e?t+"|"+e:t]=i},getData:function(t,e,i){var n,r=this.refgeo_o[e?t+"|"+e:t];return r&&i&&i.fullArray?(n=["codgeo","libgeo"],r.nivgeoTabVars&&(n=n.concat(GCO5.core.GcArrayUtil.getColumnByKey(r.nivgeoTabVars,"c_varname"))),r.territories.codgeo.map(function(t,e){var i={};return n.forEach(function(t){i[t]=r.territories[t][e]}),i})):r},checkMD5:function(t,e,i){if(!i)return!0;t=this.getData(t,e);return!!t&&t.territories.ctrlCodesMD5==i},getCodgeoById:function(t,e,i){t=this.getData(t,e);if(!t)return null;e=t.territories;return e&&e.codgeo?e.codgeo[i]:null},getLibgeoById:function(t,e,i){t=this.getData(t,e);if(!t)return null;e=t.territories;return e&&e.libgeo?e.libgeo[i]:null}}),GCO5.model.GcDBModelV5=GCO5.Class.extend({statics:{NAME:"GCO5.model.GcDBModelV5"},gcsm:null,dpinit:null,topoCacheModel:null,refgeoCacheModel:null,serverProxy:null,filter1_o:{},filter0_o:{},colors_o:{},_dpindics:null,_hasMultipleObs:null,_hasReports:null,_hasZonages:null,_hasExternalData:null,destroy:function(){this.serverProxy=null},initialize:function(t,e){this.gcsm=GCO5.core.SystemManager.getInstance(),this.gclg=GCO5.core.GcLangManager.getInstance(),this.cli=GCO5.core.ClientInfo.getInstance(),this.refgeoCacheModel=GCO5.model.maps.RefgeoCacheModelV5.getInstance(),e&&(this.serverProxy=e.serverProxy,this.serverProxy&&this.serverProxy.setGcModel(this)),this._setup(t,e)},hasReports:function(){var t;return null==this._hasReports&&(t=this.getConcept("widgets").filter(function(t){return"RE"==t.c_id_context&&"CU"==t.c_widget_type}),this._hasReports=0<t.length&&0<this.getConcept("reports").length),!0===this._hasReports},hasMultipleObs:function(){var t;return null==this._hasMultipleObs&&(t=this.getConcept("obs").filter(function(t){return 1===t.c_published}),this._hasMultipleObs=1<t.length),!0===this._hasMultipleObs},getCurrentObs:function(){return GCO5.initInfo.obs&&this.hasMultipleObs()?GCO5.initInfo.obs:"main"},hasZonages:function(){var t;return null==this._hasZonages&&(t=this.getConcept("widgets").filter(function(t){return"ZO"==t.c_id_context&&"CU"==t.c_widget_type}),this._hasZonages=0<t.length),!0===this._hasZonages},hasExternalData:function(){var t;return null==this._hasExternalData&&(t=this.getConcept("widgets").filter(function(t){return"DI"==t.c_id_context&&"CU"==t.c_widget_type}),this._hasExternalData=0<t.length),!0===this._hasExternalData},getOption:function(t){return this.dpinit.option_o[t]},setOption:function(t,e){this.dpinit.option_o[t]=e},getUserIsLogged:function(){return!!this.dpinit.userInfos&&"geoclip_user"!=this.dpinit.userInfos.id},getUserLib:function(){return this.dpinit.userInfos?this.dpinit.userInfos.lib:null},getReportsCompatibleWithSelgeo:function(e){var t=this.getConcept("report");return t&&e?t.filter(function(t){return e&&e.isCompatibleWithNivgeo(t.c_id_nivgeo)&&!(0==t.c_selmult&&null===e.getSingleCodgeo())}):[]},getHomePageHtml:function(t){var i,r,a,s,o,e=t&&t.homepageGrid?t.homepageGrid:this.getConcept("homepageGrid"),l=GCO5.core.GcArrayUtil.toIndexedObj(t&&t.widgets?t.widgets:this.getConcept("widgets"),"c_id_section"),n=$("<div class='homePage'></div>"),c=this,h=0,d={large:"lg",medium:"md",small:"sm",xlarge:"xl",print:"pr"},u=function(t,n){t.forEach(function(e){r=$("<div id='"+e.c_id_section+"_"+e.c_path+"'></div>"),a="",s=[],o=[],GCO5.core.GcStringUtil.isEmpty(e.c_class)||(a=e.c_class),e.c_id_breakpoint.forEach(function(t){a.indexOf("row")<0?s.push("col-"+d[t]+"-"+Math.round(12*e.c_size[t]/100)):s.push(d[t]+"-"+Math.round(12*e.c_size[t]/100)),o.push(1==e.c_visibility[t]?"":"d-"+d[t]+"-none"),o.push((1==e.c_visibility[t]?"visible-":"hidden-")+d[t])}),r.addClass(a+" "+s.join(" ")+" "+o.join(" ")).appendTo(n);var t,i=l[e.c_id_section];i?(t=c.getWidgetNode(GCO5.core.GcObjectUtil.cloneJson(i)))?(t.appendTo(r),(t.hasClass("SL")||t.hasClass("FO"))&&r.css("cssText","padding:0"),t.hasClass("BG")&&(r.css("cssText","padding:0;margin:0"),r.attr("title",i.c_title)),(t.hasClass("widget-link")||t.hasClass("TA"))&&t.attr("tabindex",h),"CU"==i.c_widget_type&&r.attr("title",c.gclg.getString("GO_TO_WORKSPACE_"+i.c_id_context)),"MA"==i.c_widget_type&&r.attr("title",c.gclg.getString("GO_TO_THIS_MAP","home")),"ER"==i.c_widget_type&&r.attr("title",c.gclg.getString("GO_TO_THIS_REPORT","home"))):r.closest(".row").remove():(r.addClass("section"),e.children&&u.call(c,e.children,r))})};return e.forEach(function(e){i=$("<div id='"+e.c_id_section+"_"+e.c_path+"'></div>"),a="section ",s=[],o=[],GCO5.core.GcStringUtil.isEmpty(e.c_class)||(a+=e.c_class),e.c_id_breakpoint.forEach(function(t){0<=a.indexOf("row")?s.push(d[t]+"-"+Math.round(12*e.c_size[t]/100)):s.push("col-"+d[t]+"-"+Math.round(12*e.c_size[t]/100)),o.push(1==e.c_visibility[t]?"":"d-"+d[t]+"-none"),o.push((1==e.c_visibility[t]?"visible-":"hidden-")+d[t])}),i.addClass(a+" "+s.join(" ")+" "+o.join(" ")).appendTo(n),e.children&&u.call(c,e.children,i)}),n.html()},getWidgetNode:function(t){var e=t.c_widget_type;if("BA"==e)return null;var i=$("<div id='"+t.c_id_widget+"' class='widget "+(t.c_class||"")+" "+e+"'></div>"),n="CU"==e?"height:calc(100% - 10px)":"",r=(GCO5.core.GcStringUtil.isEmpty(t.c_bg_color)||(n+=";background-color:"+t.c_bg_color),t.c_id_dataset+"."+t.c_id_indicateur),n=(i.css("cssText",n),this),a=("CU"==e&&i.addClass("widget-link").attr("role","link").attr("data-cu",{IN:"indicator",ZO:"zonage",RE:"report",DI:"externaldata"}[t.c_id_context]),"TX"!=e||GCO5.core.GcStringUtil.isEmpty(t.c_url)||(i.addClass("widget-link").attr("role","link").attr("data-url",t.c_url),t.c_url_lib&&i.attr("title",t.c_url_lib)),"MA"==e&&(i.addClass("widget-link").attr("data-cu","indicator").attr("role","link").attr("data-indic",r),t.c_title=this.cli.htmlEncode(t.c_title),GCO5.core.GcStringUtil.isEmpty(t.c_id_view)||i.attr("data-view",t.c_id_view),GCO5.core.GcStringUtil.isEmpty(t.c_content)&&(t.c_content=n.gclg.getString("GO_TO_THIS_INDIC","home")||""),t.c_content+="<br><i class='small'>"+(n.gclg.getString("P2")?n.gclg.getString("SOURCE","indics")+n.gclg.getString("P2")+" ":"")+t.data.source+"</i>",t.data.zonrefData&&!GCO5.core.GcMathUtil.isInvalid(t.data.zonrefData.valref)&&(t.c_title+="<br>"+t.data.zonrefData.libref+(n.gclg.getString("P2")||" :")+" "+this.gclg.formatNumber(t.data.zonrefData.valref,t.data.nbdec),GCO5.core.GcStringUtil.isEmpty(t.data.unite)||(t.c_title+=" "+t.data.unite)),GCO5.core.GcStringUtil.isEmpty(t.c_img)&&(n="GC_make_map.php?lang="+this.gclg.getLang()+"&cosmetics=0&width=170&height=151&indics="+r,GCO5.core.GcStringUtil.isEmpty(t.c_id_view)||(n+="&view="+t.c_id_view),m=$("<img width='170' height='151' alt='' src='"+n+"'>"))),"ER"==e&&(i.addClass("widget-link").attr("data-cu","report").attr("role","link").attr("aria-label",this.cli.htmlEncode(t.c_subtitle)).attr("data-report",t.c_id_report).attr("data-chapter",t.c_id_chapter),t.c_codgeo&&t.c_id_nivgeo&&i.attr("data-codgeo",t.c_codgeo).attr("data-nivgeo",t.c_id_nivgeo)),GCO5.initInfo.assetsDir+"/");if("SL"==e||"BG"==e||GCO5.core.GcStringUtil.isEmpty(t.c_img)||(m=$("<img alt='' src='"+a+t.c_img+"'>")),"BG"==e){i.addClass("widget-text");var r="slide",s=(0==t.c_img.indexOf("bghome800")&&(r+=" bghome"),0<t.c_img.toLowerCase().indexOf(".png")&&(r+=" png"),$("<div class='"+r+"'></div>"));t.c_img.indexOf("bghome800")<0&&s.css("background-image","url('"+a+t.c_img+"')"),s.attr("alt",t.c_title),i.append(s)}else if("SL"==e){i.addClass("widget-text").attr("data-custompattern","carrousel").attr("data-play","auto").attr("data-playmode","restart").attr("data-tabs","dots"),t.c_title=this.cli.htmlEncode(t.c_title),t.c_subtitle=this.cli.htmlEncode(t.c_subtitle),t.c_content=this.cli.htmlEncode(t.c_content);for(var o=(t.c_title||"").split("|"),l=(t.c_subtitle||"").split("|"),c=(t.c_content||"").split("|"),h=(t.c_img||"").split("|"),d=(t.c_fg_color||"").split("|"),u=0;u<o.length;u++){(s=$("<div class='slide'></div>")).css("background-image","url('"+a+h[u]+"')");var p=$("<div class='slide-caption slide-left'></div>");p.css("cssText","color:"+d[u]+"!important"),$("<span>"+o[u]+"</span>").appendTo(p),$("<h2>"+l[u]+"</h2>").appendTo(p),$("<p class='mtn'>"+c[u]+"</p>").appendTo(p),s.append(p),i.append(s)}}else if("NE"==e){GCO5.core.GcStringUtil.isEmpty(t.c_title)||$("<h2>"+t.c_title+"</h2>").appendTo(i),GCO5.core.GcStringUtil.isEmpty(t.c_subtitle)||$("<h3>"+this.cli.htmlEncode(t.c_subtitle)+"</h3>").appendTo(i);for(u=0;u<t.data.length;u++){var g=t.data[u],f=$("<div>"+(GCO5.core.GcStringUtil.isEmpty(g.c_lib_long)?g.c_lib_news:g.c_lib_long)+"</div>");GCO5.core.GcStringUtil.isEmpty(g.c_id_dataset)?GCO5.core.GcStringUtil.isEmpty(g.c_id_news)||f.addClass("widget-link NE").attr("data-cu","news").attr("data-news",g.c_id_news):(f.addClass("widget-link NE").attr("data-cu","indicator").attr("data-indic",g.c_id_dataset+"."+g.c_id_indicateur),GCO5.core.GcStringUtil.isEmpty(g.c_id_view)||f.attr("data-view",g.c_id_view)),f.appendTo(i)}}else{"MA"!=e&&i.addClass("widget-text"),!m||"MA"!=e&&"CU"!=e&&"ER"!=e||m.appendTo(i);var m,n=i;"MA"!=e&&"ER"!=e||(n=$("<div></div>")).appendTo(i),GCO5.core.GcStringUtil.isEmpty(t.c_title)||(n.hasClass("h1-like")?$("<h1>"+GCO5.core.GcStringUtil.toHTmlWithSingleBr(this.cli.htmlEncode(t.c_title))+"</h1>"):$("<h2>"+GCO5.core.GcStringUtil.toHTmlWithSingleBr(this.cli.htmlEncode(t.c_title.replace("<br>","\r")))+"</h2>")).appendTo(n),GCO5.core.GcStringUtil.isEmpty(t.c_subtitle)||$("<h3>"+this.cli.htmlEncode(t.c_subtitle)+"</h3>").appendTo(n),"TA"==e&&$("<div class='wordcloudSet'></div>").attr("aria-label","wordCloud").appendTo(i),GCO5.core.GcStringUtil.isEmpty(t.c_content)||(r=this.cli.purifyHTML(t.c_content),m=$("<div>"+GCO5.core.GcStringUtil.toHTmlWithSingleBr(r)+"</div>"),this._identifyHTMLPattern(m,n,i.hasClass("widget-text"))||m.appendTo(n))}return i},_identifyHTMLPattern:function(t,e,i){return!!i&&(2==t.children().length&&1==t.children().first().children().length&&1==t.children().first().find(">a>img").length&&(t.css("display","flex").css("align-items","center"),t.children().first().css("flex","0 0 auto"),t.children().eq(1).css("margin","0 0 0 10px"),t.appendTo(e),!0))},getLegal:function(t){var e=GCO5.core.GcArrayUtil.toIndexedObj(this.dpinit.legals,"c_cle");return e[t]?e[t].c_lib:null},_setup:function(e,t){t&&this._addProxyFunctions(t),this.dpinit=e=e.content,e.extents=e.extents.filter(function(t){return 0<=GCO5.core.GcArrayUtil.indexOfByKey(e.views,"c_id_extent",t.c_id_extent)});for(var i=["nivgeo","extent","dataset","view","tree","globe","zonref","nomenc"],n={},r=this,a=0;a<i.length;a++)e[i[a]+"s"]&&(e[i[a]+"_o"]=GCO5.core.GcArrayUtil.toIndexedObj(e[i[a]+"s"],"c_id_"+i[a]));e.option_o={},e.options&&e.options.forEach(function(t){e.option_o[t.c_id_option]=t.c_val}),e.report_o={},e.reports&&e.reports.forEach(function(t){e.report_o[t.c_id_report]=t}),e.datasets&&e.datasets.forEach(function(t,e){for(var i in t.axis){i=t.axis[i];"T"==i.type&&(t.varserie=i.name,t.series=i.mods.sort()),"F"==i.type&&(t.filter1=i.name)}}),e.views.forEach(function(t,e){for(var i in t)t[i.substr(2)]=t[i];t.pk=t.c_id_view,n[t.c_id_view]=t.pk}),e.viewLayers&&e.viewLayers.forEach(function(t,e){t.cle=n[t.c_id_view],t.type_layer=t.c_id_layer.split("_").pop(),t.c_cols=t.c_cols?t.c_cols.split("|"):null,t.c_eps=t.c_eps?t.c_eps.split("|"):null}),e.nivgeos.forEach(function(t){t.count=r.getMaxNbobjsForNivgeo(t.c_id_nivgeo)}),e.colors&&this.registerColorFams(null,e.colors),e.trees&&0<e.trees.length?(t=this.cli.checkAndCleanState($.bbq.getState()),this.buildDomainTree(t.tree||e.trees[0].c_id_tree)):this.dpinit.dom_o={}},_proxyInfo:function(t,e,i){i+=GCO5.core.GcStringUtil.proper(t,!0),t=this[i];return t?t.apply(this,e):(console.error("function gcDBModel."+i+" missing"),null)},_addProxyFunctions:function(t){var e,i=this,n=(t.testInfo=function(t,e){return i._proxyInfo(t,e,"is")},t.getInfo=function(t,e){return i._proxyInfo(t,e,"get")},["getPointLayerDef","registerRefData","getRefData","getInitKey","getConcept","registerColorsFam","registerFilter1Data","registerFilter0Data","isDivergingColfam","checkFiltNivgeoFromNivgeo","checkRefgeo","getOption","setOption","getLegal","buildDomainTree","getFirstAdminLayerName","clearTopoModel","extendMapDefsWithIndicModel","updateRefDataWithTopology","getIndicsFromImportedDataset","hasMultipleObs","getCurrentObs","hasReports","hasZonages","hasExternalData","isLineOrPtLayer"]);for(r in n)t[e=n[r]]=$.proxy(this[e],this);if(this.serverProxy)for(var r in n=["loadLayers","loadRefData","loadIndicData","loadMapIndic","loadMapViewModel","loadFreeMapModel","addMapLayer","loadFullIndicInfo","loadColData","loadStudy","loadWMSCap","searchIndicsByKey","loadThemeStatsForNivgeos","searchGeoByKey","searchGeoByCodgeo","getIndicsByTypind","getFilter0List","loadRelationRefData","loadFilterData","loadColorsFamData","loadIndicModels","loadReportChapterData","loadReportBlockData","searchSurroundGeo","getObjsInZone","getListIndics","loadZonComp","getPageContent","loadIsochroneSelIds","loadIsochroneLayer","getTJSThemes","loadMapImageWithSel","loadInfosel","loadDashboard","login","logout","getZonsAroundPosition","exportSeries","resetPassword","sendNewPassword"])t[e=n[r]]=$.proxy(this.serverProxy[e],this.serverProxy)},getDatasetAxis:function(t){return this.getInitKey("dataset_o")[t].axis},getIndicsMetaData:function(t,e){if(!t||this._dpindics&&this._dpindics.source[t]==e)return this._dpindics?this._dpindics.data:null},registerIndicsMetaData:function(t,e){this._dpindics={data:t,source:e},this.extendIndicInfo()},getIndicMetaData:function(t){if(!this.getIndicsMetaData())return null;t=GCO5.core.GcArrayUtil.getSubArray(this.getIndicsMetaData().indics,{c_id_dataset:[t.getProp("idDataset")],c_id_indicateur:[t.getProp("idIndic")]});return 0<t.length?t[0]:null},registerColorFams:function(t,e){var i=this.colors_o;t?i[t]=e:e.forEach(function(t,e){i[t.c_typ_pal]||(i[t.c_typ_pal]=[]),i[t.c_typ_pal].push(t)})},getColorFams:function(t){return this.colors_o[t]},getColorFamInfo:function(t,e){e=GCO5.core.GcArrayUtil.getSubArray(this.getColorFams(e),{c_id_colfam:t});return 0<e.length?e[0]:null},registerFilter1Data:function(t,e){this.filter1_o[t]=e},getFilter1Data:function(t){return this.filter1_o[t]},registerFilter0Data:function(t,e){this.filter0_o[t]=e},getFilter0Data:function(t){return this.filter0_o[t]},getConcept:function(t){return this.dpinit[t]||this.dpinit[t+"s"]},getInitKey:function(t){return t?this.dpinit[t]:this.dpinit},buildDomainTree:function(t){this.dpinit.curTree=t=t||"A01";var n,e=this.getConcept("tree"),r=[],a=[],t=GCO5.core.GcArrayUtil.indexOfByKey(e,"c_id_tree",t),s=function(t,e,i){t.forEach(function(t){n={data:t.c_id_theme,label:t.c_lib,nbIndics:t.indicCount,id_parent:e},i&&(n.id_domaine=i),(e?r:a).push(n),e||t.children||(r.push(n),a.push(n)),t.children&&s(t.children,t.c_id_theme,e?i:t.c_id_theme)})},t=(s(e[t].themes),0==r.length);return this.dpinit.doms=a,this.dpinit.themes=t?a:r,this.dpinit.dom_o=GCO5.core.GcArrayUtil.toIndexedObj(this.dpinit.doms,"data"),this.dpinit.theme_o=t?this.dpinit.dom_o:GCO5.core.GcArrayUtil.toIndexedObj(r,"data"),e},isDivergingColfam:function(t){t=this.getColorFamInfo(t,"C");if(t)return 1==t.c_diverging},getHexColorsFromColFam:function(t,e,i){var n={},t=(e||console.error("typ_pal manquant"),t&&(n.c_id_colfam=t),GCO5.core.GcArrayUtil.getSubArray(this.getColorFams(e),n));return 0==t.length?null:i&&0<t.length?GCO5.core.GcArrayUtil.getSubArray(t[0].styles,i):t[0].styles.sort(function(t,e){return t.c_ncols-e.c_ncols})},getAPIKey:function(t){var e=this.getConcept("globe_o");return!e[t]||GCO5.core.GcStringUtil.isEmpty(e[t].c_apikey)?null:e[t].c_apikey},getGlobeActive:function(t){var e=this.getConcept("globe_o");return!!e[t]&&!!e[t].c_active},getTagSample:function(){for(var t=this.getInitKey("tags_lib_a"),e=[],i=0;i<t.length;i++){var n=t[i].toLowerCase();if(n.length<=6&&GCO5.core.GcStringUtil.unaccent(n)==n&&e.push(n.toLowerCase()),2==e.length)break}return e.join(", ")},getReportPages:function(t,e,i){var n,r=GCO5.core.GcArrayUtil.toIndexedObj(this.getInitKey("report_a"),"id_rep");for(n in this.getInitKey("page_a")){var a=this.getInitKey("page_a")[n];r[a.id_rep]&&(a.lib_rep=r[a.id_rep].label,a.id_nivgeobase=r[a.id_rep].id_nivgeo)}for(var s=this.getInitKey("page_a"),o=[],l=0;l<s.length;l++){var c=this.getInitKey("report_nivgeos")[s[l].id_rep];c&&(c=c.split("|"),t&&c.indexOf(t)<0||e&&s[l].id_rep!=e||i&&"0"==s[l].init||o.push(s[l]))}return o},getInfoFromMapName:function(t,e,i){i=i||"pk";var n=GCO5.core.GcArrayUtil.indexOfByKey(this.getConcept("view"),i,t);if(0<=n){n=this.getConcept("view")[n];if(!e)return n.pkgeo=this.getInfoFromMapName(t,"pkgeo",i),n;if("pkgeo"==e)return n.id_nivgeo+"|"+n.id_extent;t=$.trim(n[e]);return"filt_nivgeo"!=e&&""==t?null:t}return null},getFirstIdExtentFromNivgeo:function(t){var e=this.getConcept("view"),t=GCO5.core.GcArrayUtil.indexOfByKey(e,"id_nivgeo",t);return!(0<=t)||""==(e=GCO5.core.GcStringUtil.trim(e[t].id_extent))?null:e},checkIdExtentFromNivgeo:function(t,e){t=t||"";e=GCO5.core.GcArrayUtil.getSubArray(this.getConcept("view"),{id_nivgeo:e});return 0<=(e=GCO5.core.GcArrayUtil.getColumnByKey(e,"id_extent")).indexOf(t)?t:e[0]},getSurNivgeos:function(t,e){var i,n=[],r=this.getInitKey("nivgeo_o");this.getZonRefInfo();for(i in r)r[i].c_nivgeos_inf&&0<=r[i].c_nivgeos_inf.indexOf(t)&&n.push({pk:i,id_nivgeo:i,count:r[i].count||0,lib_nivgeo:r[i].c_lib_nivgeo});return GCO5.core.GcArrayUtil.sortOn(n,["count"],[GCO5.core.GcArrayUtil.NUMERIC]),0<n.length?n:null},isNivgeo:function(t){return 0<=GCO5.core.GcArrayUtil.indexOfByKey(this.getInitKey("nivgeo_a"),"pk",t)},getNivgeoFromFiltNivgeo:function(t){t=GCO5.core.GcArrayUtil.indexOfByKey(this.getInitKey("view_a"),"filt_nivgeo",t);return 0<=t?this.getInitKey("view_a")[t].id_nivgeo:null},getDomFromThm:function(t){var e,i=this.getInitKey("theme_o");return 0==t.indexOf("_import")||0==t.indexOf("_tjs_")?{dom:"_import",thm:t}:(e=Array.isArray(t)?(t=(e=t.filter(function(t){return i[t]}))[0],0<e.length?i[e[0]]:null):i[t])?{dom:e.id_domaine,thm:t}:null},getLibThm:function(t){t=this.getInitKey("theme_o")[t];return t?t.label:""},getLibDom:function(t){t=this.getInitKey("dom_o")[t];return t?t.label:""},getZonRefInfo:function(t){return[]},getZonRefInfoCompatibleWithReport:function(t){var e=this.getZonRefInfo(),t=GCO5.core.GcArrayUtil.getSubArray(this.getInitKey("report_a"),{id_rep:t});if(0==t.length)return null;for(var i=this.getSurNivgeos(t[0].id_nivgeo,!0),n=[],r=0;r<e.length;r++){var a=e[r];0<=GCO5.core.GcArrayUtil.indexOfByKey(i,"id_nivgeo",a.nivgeo)&&n.push(a)}return n},isLineOrPtLayer:function(t){if(!t)return!1;t=t.split("_"),t.pop(),t=this.getInitKey("nivgeo_o")[t.join("_")];return!!t&&("PT"==t.c_topo||"PL"==t.c_topo)},getLibSymb:function(t){t=GCO5.core.GcArrayUtil.getSubArray(this.getInitKey("symb_a"),{id_symb:[t]});return 1==t.length?t[0].lib_symb:null},getSubNivgeos:function(t,e,i){var n,r=[],a=this.getInitKey("nivgeo_o");for(n in a)a[n].c_nivgeos_sup&&0<=a[n].c_nivgeos_sup.indexOf(t)&&n!=t&&r.push({nivgeo:n,count:a[n].count||0});return GCO5.core.GcArrayUtil.sortOn(r,["count"],[GCO5.core.GcArrayUtil.NUMERIC]),r},getReportsCompatibleWithNivgeo:function(t){var e,i=this.getSubNivgeos(t,null,!0),n=[];for(e in i=[{nivgeo:t}].concat(i)){var r,t=i[e].nivgeo;for(r in this.getInitKey("report_a")){var a=this.getInitKey("report_a")[r];a.id_nivgeo==t&&n.push(a)}}return n},getViewsCompatibleWithNivgeoSel:function(t){var e,i=this.getSubNivgeos(t),n=[],r=this.getConcept("view");for(e in i){var a,t=i[e].nivgeo;for(a in r){var s=r[a];s.id_nivgeo==t&&n.push(s)}}return n},getNivgeosSearchCompatibleWithNivgeos:function(t,e){var i,n=Array.isArray(t)?t.concat():[t];for(i in t){var r=t[i],r=GCO5.core.GcArrayUtil.getColumnByKey(this.getSurNivgeos(r,!0),"id_nivgeo");!e&&r&&(n=n.concat(r))}return GCO5.core.GcArrayUtil.getDistinctValues(n)},getLibNivgeo:function(t,e,i,n){var r,a=this.getInitKey("nivgeo_o");if(a[t]){if("string"!=typeof(r=i?a[t].c_lib_nivgeop:a[t].c_lib_nivgeo))return"";if(e)return r.toLowerCase();i=a[t].c_fwk_date;return!n&&!GCO5.core.GcStringUtil.isEmpty(i)&&r.indexOf(i)<0&&(r+=" "+i),r}return 0<(a=GCO5.core.GcArrayUtil.getSubArray(this.getInitKey("zonage_a"),{nivgeo:[t]})).length?(r=a[0].lib_zonage,e?r.toLowerCase():r):(r=this.getSymbLayerFullName(t))?e?r.toLowerCase():r:void 0},getMapNameFromNivgeo:function(t,e,i){t=this.getMapNamesFromNivgeo(t,e,i);return 0<t.length?t[0]:null},getMapNamesFromNivgeos:function(t,e,i){var n,r=[];for(n in t)r=r.concat(this.getMapNamesFromNivgeo(t[n],e,i));return r},getMapNamesFromNivgeo:function(t,e,i){i=i||"pk";t={id_nivgeo:Array.isArray(t)?t:[t]},GCO5.core.GcStringUtil.isEmpty(e)||(t.id_extent=[e]),e=GCO5.core.GcArrayUtil.getSubArray(this.getConcept("view"),t);return GCO5.core.GcArrayUtil.getColumnByKey(e,i)},getIdViewFromMapName:function(t){return this.getInfoFromMapName(t,"id_view")},getMapNameFromIdView:function(t){return this.getInfoFromMapName(t,"pk","id_view")},getLayerHash:function(t){t=GCO5.core.GcArrayUtil.getSubArray(this.getConcept("viewLayers"),{c_id_layer:[t]});return 0<t.length?t[0].hash:null},getViewDef:function(t,e){var e=e?GCO5.core.GcArrayUtil.getSubArray(this.getConcept("view"),{id_nivgeo:e}):this.getConcept("view"),i=GCO5.core.GcArrayUtil.getSubArray(this.getConcept("viewLayers"),{cle:[t]}).sort(function(t,e){return t.c_ordre-e.c_ordre}),n=[],r=[],a=[];return i.forEach(function(t){("Z"==t.c_purpose?n:"H"==t.c_purpose?r:a).push(t)}),{params:GCO5.core.GcArrayUtil.getSubArray(this.getConcept("view"),{pk:[t]})[0],layers:a,zonages:n,views:e,tiles:this.getTileRasterList(t),habill:r}},getFirstAdminLayerName:function(t){var e,i=this.getViewDef(t).habill;for(e in i){var n=i[e];if(1==n.c_visinit&&"_L"==n.c_id_layer.substr(-2,2)){if(0==n.c_cols||Array.isArray(n.c_cols)&&1==n.c_cols.length&&GCO5.core.GcMathUtil.isGray(n.c_cols[0]))return n.c_id_layer;break}}return null},getRefData:function(t,e,i,n){i=i||"territories";t=this.refgeoCacheModel.getData(t,e,n);return t?"*"==i?t:t[i]:null},getRefTabVars:function(t,e){var i=GCO5.core.GcArrayUtil.getSubArray(this.getConcept("nivgeosTabVars"),{c_id_nivgeo:t});return this.getRefData(t,e,"nivgeoTabVars")||i},updateRefDataWithTopology:function(t){var e;if(t&&t.lyStat)return e=this.getRefData(t.nivgeo,t.getIdExtent()),e&&!e.neighbours&&(t=t.lyStat.topoModel,e.neighbours=t.getNeighbours(),e.areas=t.getAreas(),e.ctrX=t.getCtrX(),e.ctrY=t.getCtrY(),e.lyEchelle=t.getParams().echelle,e.lyAvgRadius=t.getAvgRadius(),e.precision=t.getPrecisionFactor(),e.islands_a=t.islands_a,e.edges_a=t.edges_a,e.multrings_a=t.multrings_a,e.withholes_a=t.withholes_a,e.neighbours1_a=t.neighbours1_a),e},getMenuResource:function(t){var e={};return e.login=!0===this.dpinit.authPanel,e.news=!this.dpinit.hasOwnProperty("hasNews")||!0===this.dpinit.hasNews,t?e[t]:e},getRefDataFromMapName:function(t,e){return this.getRefData(this.getInfoFromMapName(t,"id_nivgeo",e),this.getInfoFromMapName(t,"id_extent",e),"*")},registerRefData:function(t,e,i){this.refgeoCacheModel.registerData(t,e,i);e=this.getConcept("nivgeo_o");!e[t]&&(i=GCO5.model.indics.Dataset.getDataset(t))&&(e[t]={c_id_nivgeo:t,c_lib_nivgeo:i.getName(),c_lib_nivgeop:i.getName(),c_topo:i.getTopology()})},getLayersToLoadFromMapView:function(t,e){for(var i=this.getViewDef(t),n=i.layers,r=[],a=0;a<n.length;a++){var s=n[a];r.push({name:s.c_id_layer,refgeo:Number("S"==s.c_purpose)})}for(n=GCO5.core.GcArrayUtil.getSubArray(i.habill,{c_visinit:[1,"1"],cle:[t]}),a=0;a<n.length;a++){s=n[a];r.push({name:s.c_id_layer,refgeo:0})}if(e)for(var o in e)e[o].isMapIndicModel&&e[o].isEnabled()&&(e[o].applyToPolygons()||(o=e[o].getLayerName(),r.push({name:o,refgeo:0})));return r},getLayersLoadedForMapView:function(t,e,i){for(var n=this.getViewDef(t),r=n.layers,a=[],s=0;s<r.length;s++){var o,l,c,h,d=r[s];e&&!e[d.c_id_layer]?console.error("couche non chargée",d.c_id_layer):(u={name:d.c_id_layer,purpose:d.c_purpose},"S"==d.c_purpose&&(u.stat=1,c&&(u.agreg=c),o=u,l=s),"1"==d.contforstat&&(o.agreg=d.c_id_layer,c=d.c_id_layer),"P"==d.type_layer?u.styles={topo:d.type_layer,symbol:"cc",fill:"none",lineWidth:1,strokeStyle:"#333",cityGroup:!0,zoomMinPct:parseFloat(d.c_szoom1),zoomMaxPct:parseFloat(d.c_szoom2)}:(u.styles={topo:d.type_layer,lineWidth:d.c_eps,zoomMinPct:d.c_szoom1,zoomMaxPct:d.c_szoom2,cols:d.c_cols,colf:d.c_colf,alphaf:d.c_alphaf,fillAlpha:d.c_alphaf/100,fillStyle:d.c_colf||"#CCC",strokeStyle:d.c_cols||"#CCC"},1==u.stat&&(u.styles.selectable=!0),""!=d.c_alphas&&"100"!=d.c_alphas&&(h=GCO5.core.GcMathUtil.hexToBin(d.c_cols),u.styles.strokeStyle="rgba("+(h>>16&255)+","+(h>>8&255)+","+(255&h)+", "+parseFloat(d.c_alphas)/100+")")),a.push(u))}o||console.log("erreur defstat_o vide",r,a);for(var u,p,r=GCO5.core.GcArrayUtil.getSubArray(n.habill,{c_visinit:[1,"1"],cle:[t]}),g=[],s=0;s<r.length;s++)"V"!=(d=r[s]).source&&(u={name:d.c_id_layer,purpose:d.c_purpose,styles:{topo:d.c_id_layer.split("_").pop(),lineWidth:d.c_eps,ordre:parseFloat(d.c_ordre),vartype:d.c_vartype,visinit:parseFloat(d.c_visinit),strokeStyle:d.c_cols,fillStyle:d.c_colf,fillAlpha:d.c_alphaf/100,purpose:d.c_purpose}},"H"==d.c_purpose&&"L"==u.styles.topo&&1==u.styles.visinit&&(u.styles.zoomMinPct=d.c_szoom1,u.styles.zoomMaxPct=d.c_szoom2),"H"==d.c_purpose&&"P"==u.styles.topo&&(u.styles.symbol="sq",u.styles.fillStyle=[d.c_cols],u.styles.size=+d.c_eps,u.styles.noEtiq=!0),g.push(u));if(i)for(var f in i)i[f].isMapIndicModel&&(i[f].applyToPolygons()?(o.mapIndicModels||(o.mapIndicModels={}),o.mapIndicModels[f]=i[f]):(p=i[f].getLayerName(),u=this._getPointOrLineLayerDef(i[f],p),g.push(u)));0<g.length&&(a=a.slice(0,l+1).concat(g).concat(a.slice(l+1)));var m=GCO5.model.maps.RefgeoCacheModelV5.getInstance(),_=this.isEpsgMobile3857(t),v=this.getHtml5Epsg(t);for(f in a){a[f].isEpsgMobile3857=_,a[f].epsg=v,a[f].ba=e[a[f].name],a[f].tm=this.getTopoModel(a[f].name,a[f]);var y=GCO5.core.GcObjectUtil.getFirstVal(a[f].mapIndicModels);y&&!y.applyToPolygons()&&this._getPointOrLineLayerDef(y,a[f].name),1!=a[f].stat&&!a[f].mapIndicModels||a[f].tm.getCodgeos()||(1==a[f].stat?(y=this.getRefDataFromMapName(t),a[f].tm.addRefgeo(y.territories,y.nivgeoTabVars)):a[f].tm.addRefgeo(m.getData(GCO5.core.GcObjectUtil.getFirstKey(a[f].mapIndicModels))))}return a},checkRefgeo:function(t,e){var i=this.getInfoFromMapName(t,"id_nivgeo","id_view"),t=this.getInfoFromMapName(t,"id_extent","id_view");return this.refgeoCacheModel.checkMD5(i,t,e)},getHtml5Epsg:function(t){return this.getInfoFromMapName(t,"c_epsg")+""},getLayersDefinitions:function(t,e,i){var n,r,a=i?this.getHtml5Epsg(i):"3857";for(r in t){var s=t[r];s.isEpsgMobile3857=!0,s.epsg=a,s.ba=e[s.name],s.tm=this.getTopoModel(s.name,s),s.stat="S"==s.purpose?1:0,1!=s.refgeo||s.tm.getCodgeos()||s.tm.addRefgeo(this.getRefData(s.name)),n="P"==s.type_layer?{symbol:"cc",fill:"none",lineWidth:1,strokeStyle:"#333",cityGroup:!0,size:2.5}:{alphaf:100,fillAlpha:1,strokeStyle:"Z"==s.purpose?"#C00":"#CCC"},s.styles=GCO5.core.GcObjectUtil.defaults(s.styles||{},n),s.styles.topo=s.type_layer,1==s.stat&&(s.styles.selectable=!0),"Z"==s.purpose&&(s.styles.zon=s.styles.rovable=!0)}},getMapViewDefinition:function(t,e,i){var e=this.getLayersLoadedForMapView(t,e,i),n=this.getViewDef(t),r=n.params,a={lyStatOpacity:1,colbg:r.c_colbg,zoomOut:r.c_scalemap/100,roundCoord:!1,citiesVisible:!0},s=this.getRefData(r.id_nivgeo,r.id_extent);return{layers:e,styles:a,mapName:t,nivgeo:r.id_nivgeo,libNivgeo:this.getLibNivgeo(r.id_nivgeo,!0,!1),libView:r.lib_view,filt_nivgeo:r.filt_nivgeo,id_extent:r.id_extent,refgeoData:s,viewdef_o:n,mapIndicModels:i}},_getPointOrLineLayerDef:function(t,e,i){t&&(e=t.getLayerName(),n=t.getPk());var n,r={name:e,styles:{noEtiq:!0,topo:e.substr(e.length-1),ordre:17,strokeStyle:"#999",fill:"none",symbol:"cc",lineWidth:1}},i=(i&&GCO5.core.GcObjectUtil.extend(r,i),t&&(t.applyToLines()&&(r.styles.lineWidth=t.getMeta("sizes"),r.styles.strokeStyle=t.getMeta("colf"),r.styles.vartype="codes"),r.mapIndicModels||(r.mapIndicModels={}),(r.mapIndicModels[n]=t).setLayerDef(r)),this.getTopoModel(e));return i&&t&&(n=e.substr(0,e.length-2),e=this.getInfoFromMapName(t.getProp("view"),"id_extent"),t=this.getRefData(n,e,"*"),i.addRefgeo(t.territories,t.nivgeoTabVars)),r},getPointLayerDef:function(t,e,i,n){var r=t?t.getLayerName():GCO5.core.GcObjectUtil.getFirstKey(e),a=this.getHtml5Epsg(i),i=this.isEpsgMobile3857(i),e=this.getTopoModel(r,{name:r,ba:e[r],isEpsgMobile3857:i,epsg:a}),i=this._getPointOrLineLayerDef(t,r,n);return i.zOrder=parseFloat(i.styles.ordre),i.tm=e,i},getNivgeoTopology:function(t){t=this.getConcept("nivgeo_o")[t];return t?t.c_topo:null},getIsoLayerLoaded:function(t,e,i){return{name:e,zOrder:100,tm:this.getTopoModel(e,{name:e,ba:i[e],isEpsgMobile3857:this.isEpsgMobile3857(t),epsg:this.getHtml5Epsg(t)}),purpose:"H",styles:{zon:!0,rovable:!0,lineWidth:1,ordre:0,strokeStyle:"#00f"}}},getHabillLayerLoaded:function(t,e,i,n){var r,a,s=this.getViewDef(t),o=this.isEpsgMobile3857(t),l=this.getHtml5Epsg(t),c=this.getInfoFromMapName(t,"id_extent","id_view"),i=this.getTopoModel(e,{name:e,ba:i[e],isEpsgMobile3857:o,epsg:l});return n?(r=s.zonages,r=GCO5.core.GcArrayUtil.getSubArray(r,{cle:[t],c_id_layer:[e]}),i.getLibgeos()||i.addRefgeo(this.getRefData(e,c)),a={name:e,tm:i,is_partition:r[0].c_is_partition,styles:{zon:!0,rovable:!0,lineWidth:1,strokeStyle:"#c00",topo:"DR"}},r[0].c_cols&&Array.isArray(r[0].c_cols)&&(a.styles.strokeStyle=r[0].c_cols[0]),""+a.is_partition!="1"&&(a.styles.fillStyle="rgba(100,100,100,0.15)")):(a={name:e,zOrder:(o=(r=GCO5.core.GcArrayUtil.getSubArray(s.habill,{cle:[t],c_id_layer:[e]}))[0]).c_ordre,tm:i,purpose:o.c_purpose,styles:{lineWidth:o.c_eps,ordre:o.c_ordre,strokeStyle:o.c_cols,purpose:o.c_purpose,fillStyle:o.c_colf,fillAlpha:o.c_alphaf/100,vartype:o.c_typologie}},"_P"==e.substr(-2,2)&&(a.styles.symbol="sq",a.styles.size=+o.c_eps,a.styles.fillStyle=o.c_cols,a.styles.noEtiq=!0),"_P"==e.substr(-2,2)&&o.symbol&&(a.styles.fillStyle=o.symbol.colf,a.styles.symbol=o.symbol.sh,a.styles.size=o.symbol.sz,a.styles.strokeStyle=null,a.styles.noEtiq=!0)),a},getTopoModel:function(t,e){this.topoCacheModel||(this.topoCacheModel=new GCO5.model.maps.TopoCacheModel);var i=this.topoCacheModel.getTopoModel(t);return!i&&e&&(i=new GCO5.model.maps.GcTopoModel(e),this.topoCacheModel.registerTopoModel(t,i)),i},clearTopoModel:function(t){this.topoCacheModel&&this.topoCacheModel.clearTopoModel(t)},getStatLayerNameFromIdView:function(t){t=GCO5.core.GcArrayUtil.getSubArray(this.getConcept("viewLayer"),{c_id_view:t,c_purpose:"S"});return 1==t.length?t[0].c_id_layer:null},getNivgeoFromLayerName:function(t,e,i){if(!t)return null;var n={c_id_layer:[t]},e=(e&&(n.c_purpose=["S"]),i&&(n.c_id_view=[i]),GCO5.core.GcArrayUtil.getSubArray(this.getConcept("viewLayer"),n)),n=0<e.length?e[0].c_id_nivgeo:null;return n||(n=t.substr(0,t.length-2),this.getInitKey("nivgeo_o")[n]?n:this.getInfoFromMapName(i,"c_id_nivgeo"))},getTileRasterList:function(t){if(!GCO5.view.component.ARasterProvider)return[];var e=this,i=this.getConcept("globes").filter(function(t){return["WMS","WMTS"].indexOf(t.c_web_service)<0||0<=GCO5.core.GcArrayUtil.indexOfByKey(e.getConcept("globesLayers"),"c_id_globe",t.c_id_globe)});return GCO5.view.component.ARasterProvider.getDefsFromApiList(i,this.getConcept("globesLayers"),[],!this.isEpsgMobile3857(t))},isEpsgMobile3857:function(t){t=this.getEpsgMobile(t);return GCO5.core.GcStringUtil.isEmpty(t)||"3857"==t},getEpsgMobile:function(t){return t?this.getInfoFromMapName(t,"epsg"):$.trim(this.getConcept("view")[0].epsg)},addGcVectInfo:function(t){GCO5.core.GcObjectUtil.clean(t),t.provider="GeoclipProvider",t.service="Vect",t.format="gvf/amf",t.typLayer="V"},getInfoselVariables:function(t,e){var i,n={},r="",a={},s=t.indicModels.length,o=!1;for(l in t.indicModels)(i=t.indicModels[l]).getProp("hasCI")&&(o=!0),n["nivgeo"+(r=0==l&&2==s?"2":"")]=i.getProp("idgeo"),n["view"+r]=t.id_view,t.indicModels[l].applyToPolygons(),t.selgeo.getSingleCodgeo()&&t.nivgeosel!=t.selgeo.nivgeo?n["codgeo"+r]=t.selgeo.getSingleCodgeo():a["selids"+r]=t.selgeo.getSelIds(t.id_nivgeo,t.id_extent).join(",");if((o||GCO5.appModel.getOption("defaultSpineChart"))&&(n.distributions="1"),t.indicModels){var l,c=0;for(l in t.indicModels){var r=1==++c&&2==s?"2":"",h=t.indicModels[l],d=(n["dataset"+r]=h.getProp("idDataset"),n["indic"+r]=h.getProp("idIndic"),[]);h.getProp("filter0")&&d.push(h.getProp("filter0")+"="+h.getProp("f0Code")),h.getProp("filter1")&&d.push(h.getProp("filter1")+"="+h.getProp("f1Code")),0<d.length&&(n.filters=d.join(","))}}return t.indicModels&&0==t.indicModels.length&&(n.nivgeo=t.id_nivgeo,n.view=t.id_view,t.selgeo.getSingleCodgeo()&&t.nivgeosel!=t.selgeo.nivgeo?n.codgeo=t.selgeo.getSingleCodgeo():a.selids=t.selgeo.getSelIds(t.id_nivgeo,t.id_extent).join(",")),{variablesGet:n,variablesPost:a}},getMaxNbobjsForNivgeo:function(t){t={c_purpose:["S"],c_id_view:this.getMapNamesFromNivgeo(t,null,"id_view")},t=GCO5.core.GcArrayUtil.getSubArray(this.getConcept("viewLayer"),t);return 0==t.length?0:t.reduce(function(t,e){return Math.max(t,e.c_nbobj)},0)},getIndicsFromImportedDataset:function(t){if(0==t.indexOf("_import")){var e=(r=GCO5.model.indics.Dataset.getDataset(t)).getIndics(),i=[];for(a in e){var n={pk:(s=e[a]).getPk(),c_id_dataset:s.getProp("idDataset"),idIndicateur:s.getProp("idIndicateur"),shortLibIndic:s.getProp("shortLibIndic"),libIndic:s.getProp("libIndic"),descIndicateur:s.getProp("descIndicateur"),source:s.getProp("source"),series:s.getProp("series"),nivgeos:s.getProp("nivgeos"),c_id_views:s.getProp("views"),c_topo:s.getProp("topology"),c_id_typind:s.getProp("type"),libnivgeos:s.getProp("nivgeosLib")};i.push(n)}}else if(0==t.indexOf("_tjs_")){var r,a,i=[];for(a in(r=GCO5.model.indics.Dataset.getTJSDataset(t)).indics){for(var s=new GCO5.model.indics.IndicModel(r.indics[a]),o=((n={c_tjs_dataset:t.substr(5),c_tjs_server:t.substr(5),pk:s.getPk(),c_id_dataset:s.getProp("idDataset"),c_id_indicateur:s.getProp("idIndicateur"),shortLibIndic:s.getProp("shortLibIndic"),c_lib_indicateur_court:s.getProp("shortLibIndic"),libIndic:s.getProp("libIndic"),descIndicateur:s.getProp("descIndicateur"),source:s.getProp("source"),series:s.getProp("series"),varserie:s.getProp("varSerie"),nivgeos:s.getProp("nivgeos"),c_id_view:s.getProp("views"),c_id_views:s.getProp("views"),c_topo:s.getProp("topology"),c_id_typind:s.getProp("type"),libnivgeos:s.getProp("nivgeosLib"),viewsFrameworks:s.getProp("viewsFrameworks")}).series&&(n.serie=n.series.concat().pop()),n.nivgeos),l=[],c=[],h=this.getInitKey("nivgeo_o"),d=0,u=o.length;d<u;d++){var p=o[d];h.hasOwnProperty(p)&&(p={pk:p,lib_nivgeo:h[p].c_lib_nivgeo,lib_nivgeop:h[p].c_lib_nivgeop,count:this.getMaxNbobjsForNivgeo(p)},l.push(p),c.push(p))}var g={seuilGraph:GCO5.model.proxy.AppProxy.SEUIL_GRAPH,firstMapableNivgeo:GCO5.initInfo.firstMapableNivgeo}.firstMapableNivgeo;this.getInitKey("dataset_o");GCO5.core.GcArrayUtil.sortOn(l,["count"],[GCO5.core.GcArrayUtil.NUMERIC]),GCO5.core.GcArrayUtil.sortOn(c,["count"],[GCO5.core.GcArrayUtil.NUMERIC]),n.nivgeos_a=GCO5.core.GcArrayUtil.getColumnByKey(l,"pk"),n.nivgeoslib_a=GCO5.core.GcArrayUtil.getColumnByKey(l,"lib_nivgeo"),n.nivgeoslibp_a=GCO5.core.GcArrayUtil.getColumnByKey(l,"lib_nivgeop"),n.libnivgeos=n.nivgeoslib_a.concat().reverse().join(", "),n.lastNivgeo=n.nivgeos_a[0],""!=g&&0<=n.nivgeos_a.indexOf(g)&&(n.lastNivgeo=g),n.nivgeosg_a=GCO5.core.GcArrayUtil.getColumnByKey(c,"pk"),n.nivgeosglib_a=GCO5.core.GcArrayUtil.getColumnByKey(c,"lib_nivgeo"),"I"==n.c_typind&&(n.surnivgeos_a=this.getSurNivgeos(o[0],!1)||[],n.surnivgeos0_a=GCO5.core.GcArrayUtil.getColumnByKey(n.surnivgeos_a,"pk"),n.surnivgeoslib_a=GCO5.core.GcArrayUtil.getColumnByKey(n.surnivgeos_a,"lib_nivgeo")),i.push(n)}}return i},getIsFunctionAuthorized:function(t){t=GCO5.core.GcArrayUtil.getSubArray(this.getInitKey("profilFunctions"),{c_id_function:t});return 0==t.length||1==t[0].c_authorized},getDatasetFilter0:function(t){var e=this.getInitKey("dataset_o");if(!t)return null;e=e[t].axis.filter(function(t){return"E"==t.type});return 1==e.length&&e[0].name},extendIndicInfo:function(t,e){if(!t){if(!this.getIndicsMetaData())return;t=this.getIndicsMetaData().indics}var i=(e=e||{seuilGraph:GCO5.model.proxy.AppProxy.SEUIL_GRAPH,firstMapableNivgeo:GCO5.initInfo.firstMapableNivgeo}).firstMapableNivgeo,n=this.getInitKey("dataset_o");for(h in t){for(var r=t[h],a=n[r.c_id_dataset],s=(!e.isTJS&&a?(a.varserie&&(r.varserie=a.varserie,r.series=a.series),a.filter1&&(r.filter1=a.filter1)):1==(a=GCO5.core.GcArrayUtil.getSubArray(e.dtsAxis,{type:"T"})).length&&(r.varserie=a[0].name,r.series=a[0].mods,r.data_series=r.series.concat().reverse(),r.serie=r.series[0]),r.pk=r.c_id_dataset+"."+r.c_id_indicateur,r.ordre=h,r.shortLibIndic=r.c_lib_indicateur_court,r.libIndic=r.c_lib_indicateur,r.c_id_views=r.c_id_view.concat(),r.nivgeos),o=[],l=[],c=this.getInitKey("nivgeo_o"),h=0,d=s.length;h<d;h++){var u=s[h];c.hasOwnProperty(u)&&(u={pk:u,lib_nivgeo:c[u].c_lib_nivgeo,lib_nivgeop:c[u].c_lib_nivgeop,count:this.getMaxNbobjsForNivgeo(u)},o.push(u),u.count<e.seuilGraph&&l.push(u))}GCO5.core.GcArrayUtil.sortOn(o,["count"],[GCO5.core.GcArrayUtil.NUMERIC]),GCO5.core.GcArrayUtil.sortOn(l,["count"],[GCO5.core.GcArrayUtil.NUMERIC]),r.nivgeos_a=GCO5.core.GcArrayUtil.getColumnByKey(o,"pk"),r.nivgeoslib_a=GCO5.core.GcArrayUtil.getColumnByKey(o,"lib_nivgeo"),r.nivgeoslibp_a=GCO5.core.GcArrayUtil.getColumnByKey(o,"lib_nivgeop"),r.libnivgeos=r.nivgeoslib_a.concat().reverse().join(", "),r.lastNivgeo=r.nivgeos_a[0],""!=i&&0<=r.nivgeos_a.indexOf(i)&&(r.lastNivgeo=i),r.nivgeosg_a=GCO5.core.GcArrayUtil.getColumnByKey(l,"pk"),r.nivgeosglib_a=GCO5.core.GcArrayUtil.getColumnByKey(l,"lib_nivgeo"),"I"==r.c_typind&&(r.surnivgeos_a=this.getSurNivgeos(s[0],!1)||[],r.surnivgeos0_a=GCO5.core.GcArrayUtil.getColumnByKey(r.surnivgeos_a,"pk"),r.surnivgeoslib_a=GCO5.core.GcArrayUtil.getColumnByKey(r.surnivgeos_a,"lib_nivgeo"))}return t},getLayerFullName:function(t,e){var i=this.getSymbLayerFullName(t);if(i)return i;i=GCO5.core.GcArrayUtil.getSubArray(this.getConcept("viewLayers"),{c_id_layer:t,cle:[e]});return 0<i.length&&i[0].c_lib_layer||t},getSymbLayerFullName:function(t){if(!t)return null;t=GCO5.core.GcArrayUtil.getSubArray(this.getInitKey("symb_a"),{id_symb:[t,t.substr(0,t.length-2)]});return 1==t.length?t[0].lib_symb:null},getDatasetInfo:function(t,e){var i=this.getInitKey("dataset_a"),t=GCO5.core.GcArrayUtil.indexOfByKey(i,"data",t);return t<0?null:GCO5.core.GcStringUtil.trim(i[t][e])},getTestChangeMapOnZoom:function(t,e,i){var n,r,a,s=this.getViewDef(t).views,o=GCO5.core.GcArrayUtil.getSubArray(s,{pk:[t]}),l=parseFloat(o[0].zoomgroup),c=o[0].seuilzoommin;o[0].seuilzoommax;for(a in o=GCO5.core.GcArrayUtil.getSubArray(s,{zoomgroup:[l,String(l)]})){var h,d=o[a].seuilzoommin,u=o[a].seuilzoommax;$.isNumeric(d)&&$.isNumeric(d)&&$.isNumeric(c)&&parseFloat(d)<=e&&parseFloat(u)>=e&&parseFloat(d)>parseFloat(c)&&(n=o[a].pk,r=o[a].id_nivgeo),o[a].pk==i&&(h=e<u)}return h&&(i=t),!n||h?null:{newMapName:n,newNivgeo:r,lastMapNameBeforeChangeView:i}},getEssentialFlag:function(e){var t=this.getConcept("typinds").ESSENTIAL,i=this.getConcept("trees").filter(function(t){return t.c_id_tree==e});return 0!=i.length&&(0<t&&.02<(i[0].indicCount-t)/i[0].indicCount)},getTreeType:function(t){var e=this.getConcept("tree_o");return t&&e[t]?"__KEYWORD__"==t?"T":e[t].c_type_tree:null},getTreesFromThemes:function(e){var t=this.getConcept("tree"),i=function(t){return t.some(function(t){return 0<=e.indexOf(t.c_id_theme)||!!t.children&&i(t.children)})};return t.filter(function(t){return i(t.themes)}).map(function(t){return t.c_id_tree})},getFilteredDomTree:function(t,e){var i=t.length,n=[],r={},a={},s=this,o=this.getConcept("tree");e&&e.tag&&this.buildDomainTree(o[0].c_id_tree);for(var l=0;l<i;l++){var c=t[l],h=c.pk=c.c_id_dataset+"."+c.c_id_indicateur;c.shortLibIndic=c.c_lib_indicateur_court,c.libIndic=c.c_lib_indicateur,r[h]||(c.c_id_theme.forEach(function(t,e){var i;a[t]||(a[t]=0),a[t]++,s.dpinit.theme_o[t]&&(i=s.dpinit.theme_o[t].id_parent,a[i]||(a[i]=0),a[i]++,s.dpinit.theme_o[t].id_domaine,(i=(t=s.dpinit.theme_o[i])?t.id_parent:null)&&(a[i]||(a[i]=0),a[i]++))}),r[h]=1,n.push(c))}var d=this.getInitKey("curTree"),d=GCO5.core.GcArrayUtil.indexOfByKey(o,"c_id_tree",d),u=function(t){t.forEach(function(t){t.indicCount=a[t.c_id_theme]||0,t.children&&(u(t.children),t.children=t.children.filter(function(t){return 0<t.indicCount}))})},d=o[d].themes;return e&&e.tag&&(d=o[0].themes),u(e=GCO5.core.GcObjectUtil.cloneJson(d)),{dom_a:e.filter(function(t){return 0<t.indicCount}),i_a:t}},getStatLayerFromMapName:function(t){t={couche_stat:[1,"1"],onglet:[this.getIdViewFromMapName(t)]};return GCO5.core.GcArrayUtil.getSubArray(this.getInitKey("viewly_a"),t)[0].layer}}),GCO5.model.GcPHPServerV5=GCO5.Class.extend({statics:{NAME:"GCO5.model.GcPHPServerV5"},gcsm:null,gcModel:null,initialize:function(t){this.gcsm=GCO5.core.SystemManager.getInstance(),this._setup(t)},_setup:function(t){this.gcModel=t},setGcModel:function(t){this.gcModel=t},generateUrl:function(t,e){var i,n=0;for(i in e)t+=(0===n?"?":"&")+i+"="+e[i],n++;return GCO5.appModel.hasMultipleObs()&&(t+=(0===n?"?":"&")+"obs="+GCO5.initInfo.obs),t},addProdHash:function(t){return t&&0<t.indexOf(".php")&&GCO5.initInfo.prodHash&&(t+="&prodhash="+GCO5.initInfo.prodHash),t},getPageContent:function(i,n,r,a,s){var o=this,t=(this.gcsm.freeze("page"),this.generateUrl("GC_page.php",{lang:this.getLang(),type:r}));$.getJSON(t,function(t){o.gcsm.unFreeze("page");var e=t.content.page&&0<t.content.page.length?t.content.page[0]:null;!a&&"A"==r&&0<t.content.page.length&&(a=e.c_id_page),e&&["c_abstract","c_content"].forEach(function(t){e[t]=GCO5.core.ClientInfo.getInstance().purifyHTML(e[t])}),i&&i.apply(n,[t.content,a,s])})},loadFreeMapModel:function(e,i,n,t,r){if(!n||!n.layers)return!1;var a,s=n.layers,o=n.extent,l=n.idView,c=this;for(a in s)s[a].refgeo="S"==s[a].purpose||"Z"==s[a].purpose;n.idView||(l=n.idView="map1");var h,d=this.gcModel.getMapNameFromIdView(n.idView),u={lyStatOpacity:1,colbg:"#DBE8FC",zoomOut:.95,roundCoord:!1,citiesVisible:!0},p=((h=d?this.gcModel.getViewDef(d).params:h)&&(u.colbg=h.colbg),GCO5.core.GcObjectUtil.defaults(n.styles||{},u));c.loadLayers(function(t){c.gcModel.getLayersDefinitions(s,t,d);t={layers:s};t.extent=o,t.styles=p,h&&(t.nivgeo=h.nivgeo,t.filt_nivgeo=h.filt_nivgeo,t.libNivgeo=c.gcModel.getLibNivgeo(h.nivgeo,!0,!1)),$.extend(!0,t,n),e.apply(i,[t])},c,s,!0,l,"map",null,t,r)},loadMapViewModel:function(i,n,r,a,e,s,o,l){var c=this,t=this.gcModel.getViewDef(r),h=t.params?t.params.id_view:null,d=t.params?t.params.id_nivgeo:null;if(10<=(l=void 0===l?0:l))throw new Error("[DEBUG] loadMapViewModel : too much call!!! "+l);if(e&&l<10){var u,p,g,f,m,_=[],v={};for(u in e)(y=e[u]).onImportedData()?y.getIndicModel().setProp("nivgeo",d):y.isIndicModel&&!y.isMetaDataLoaded()?_.push(y):y.getProp("invalid")?(delete e[u],console.warn("indicateur en erreur ",u,e[u])):v[u]=y;if(0<_.length)return p=_.length,g=0,m=function(t){p--,g++,v[t.getPk()]=t,0==p?(r||(t=t.getProp("views"))&&(r=t[0]),l++,c.loadMapViewModel(i,n,r,a,v,s,o,l)):c.loadFullIndicInfo(m,this,_[g])},void this.loadFullIndicInfo(m,this,_[0]);for(u in _=[],v={},e){var y,b,C=(y=e[u]).isIndicModel?y:y.getIndicModel();y.getProp("nivgeos").indexOf(d)<0||((b=C.getViewsCompatible())&&b.indexOf(r)<0||(C.hasDataForMapName(r)||y.onImportedData()||_.push(C),v[u]=y))}if(0<_.length)return p=_.length,g=0,f={id_view:h,dest:"newIndic"},m=function(t,e){p--,g++,(y=v[e.getPkF1()])&&e!==y?y.isMapIndicModel&&y.updateAfterChangeView():v[e.getPkF1()]=new GCO5.model.indics.MapIndicModel(e),0==p?(l++,c.loadMapViewModel(i,n,r,a,v,s,o,l)):c.loadIndicData(m,this,_[g],f)},void this.loadIndicData(m,this,_[0],f);e=v}var x=function(t){t=c.gcModel.getMapViewDefinition(r,t,e);t.extent=a,s&&$.extend(!0,t,s),i&&i.apply(n,[t])};!function(){var t=c.gcModel.getLayersToLoadFromMapView(r,e);c.loadLayers(x,c,t,!0,h,"map",null,o)}.apply(this)},loadMapIndic:function(n,r,t,a,s,o){var l=a.getName(),c={id_view:this.gcModel.getInfoFromMapName(l,"id_view"),dest:"newIndic"},h=this;this.loadFullIndicInfo(function(t){var e,i=t.getViewsCompatible(s);i&&i.indexOf(l)<0?n&&((e={})[t.getPk()]=t,n.apply(r,[t,i,e])):h.loadMapIndicResources(a,n,r,t,c,o)},this,t)},loadFullIndicInfo:function(i,n,r){if(r.isExternalTJS())i&&i.apply(n,[r,this.gcModel.getIndicsMetaData()]);else{var a,s,t=this.gcModel.getIndicMetaData(r);if(t)return r.updateWithServerMetaData(t),void(i&&i.apply(n,[r,this.gcModel.getIndicsMetaData()]));r.onImportedData()?i&&i.apply(n,[r,{indics:this.gcModel.getIndicsFromImportedDataset(r.getProp("idDataset"))}]):(this.gcsm.freeze("fullindicinfo"),t={lang:(a=this).getLang()},"N"==GCO5.appModel.getInfo("treeType",[r.getOption("tree")])?(t.theme="t"+r.getProp("f1Code")+"@"+r.getOption("tree"),t.tree=r.getOption("tree")):(t.indic=r.getProp("idIndic"),t.dataset=r.getProp("idDataset")),s=this.generateUrl("GC_listIndics.php",t),s=this.addProdHash(s),$.getJSON(s,function(t){if(a.gcsm.unFreeze("fullindicinfo"),t.errors)throw"L'indicateur demandé n'est pas disponible : "+r.getProp("idDataset")+"."+r.getProp("idIndic");0===t.content.indics.length&&console.warn("no indicator found at url "+s),a.gcModel.extendIndicInfo(t.content.indics);var e=(t.content.filterParams||t.header.params).theme;a.gcModel.registerIndicsMetaData(t.content,{id_theme:e}),r&&(t=a.gcModel.getIndicMetaData(r))&&r.updateWithServerMetaData(t),i&&i.apply(n,[r,a.gcModel.getIndicsMetaData()])}))}},loadLayers:function(h,d,t,u,p,g,f,m,_){var v=this,y=t.length,b={},C={},x=(m=GCO5.initInfo.hasOwnProperty("canLoadGzLayers")&&1==GCO5.initInfo.canLoadGzLayers&&(GCO5.browser.isChrome||GCO5.browser.isIOSSafari),_=_||"",v.gcModel.getInfoFromMapName(p,"id_nivgeo","id_view")),w=("addLayer"==g&&(x=null),v.gcModel.getInfoFromMapName(p,"id_extent","id_view")),S=(u&&y++,!1);$.each(t,function(t,e){var i=e.name;u&&!S&&1==e.refgeo&&v.gcModel.getRefData(x||i,w)&&(S=!0,--y)}),$.each(t,function(t,e){var i,n=e.name,r=v.gcModel.getTopoModel(n);if(!r||"P"==r.getTopology()&&v.gcModel.isLineOrPtLayer(n)||"L"==r.getTopology()&&v.gcModel.isLineOrPtLayer(n)||u&&!S&&1==e.refgeo||(b[n]=r,!(0<--y))){if(!!p&&v.gcModel.isLineOrPtLayer(n)&&0<y){var a,s={},o=(s.extent=w,n.substr(0,n.length-2)),l="GC_refdata.php?nivgeo="+o+"&view="+p+"&lang="+v.getLang(),l=v.addProdHash(l);for(a in s)l+="&"+a+"="+s[a];v.gcModel.clearTopoModel(n);var c=n.substr(n.length-1);if("L"==c&&y++,$.getJSON(l,function(t){v.gcsm.unFreeze("REF_DATA");var e=t.content.territories;if(v.gcModel.registerRefData(o,w,t.content),"P"==c){for(var i=(b[t.header.params.nivgeo+"_P"]=e).x.length,n=t.content.layer.c_precxy,r=0;r<i;r++)e.x[r]/=n,e.y[r]/=n;e.codgeo_a=e.codgeo,e.libgeo_a=e.libgeo,e.pt={x:e.x,y:e.y},e.params=t.content.params,e.params900913=t.content.params900913,e.params.mult_xy=1}0==--y&&h&&h.apply(d,[b,g,f])}),"P"==c)return}if("_E"==n.substr(-2,2))return i=m?_+"maps/"+n+".gz?v="+GCO5.initInfo.jsversion:"GC_layer.php?layer="+n,void $.getJSON(i,function(t){b[t.params.layer]=t,--y<=0&&h&&h.apply(d,[b,g])}).fail(function(){--y<=0&&h&&h.apply(d,[b,g])});0==y?h&&h.apply(d,[b,g]):(r=v.gcModel.getLayerHash(n),i=m?_+"maps/"+n+".gz?v="+GCO5.initInfo.jsversion:"GC_layer.php?layer="+n+(r?"&hash="+r:""),C[n]=new XMLHttpRequest,C[n].open("GET",i,!0),C[n].responseType="arraybuffer",C[n].timeout=0,C[n].onload=function(t){t=t.target.response;t&&(b[n]=t,0==--y&&h&&h.apply(d,[b,g,f]))},C[n].send(null),u&&!S&&1==e.refgeo&&((r=n.split("_")).pop(),e=r.join("_")+"_refgeo.gz",i=x?v.addProdHash("GC_refdata.php?nivgeo="+x+"&extent="+w+"&lang="+v.getLang()):_+"maps/"+e,x||(i="GC_layer.php?refgeo=1&layer="+n),$.getJSON(i,function(t){t.hasOwnProperty("errorMsg")||(v.gcModel.registerRefData(x||n,w,x?t.content:{territories:t}),t.layer=n),0==--y&&h&&h.apply(d,[b,g,f])})))}})},loadColorsFamData:function(e,i,n,r){var t=this.gcModel.getColorFams(n);if(t&&2<t.length)return e?void e.apply(i,r):t;this.gcsm.freeze("COLOR_DATA");var t="GC_color.php?typ_pal="+n+"&lang="+this.getLang(),a=this,t=this.addProdHash(t);$.getJSON(t,function(t){a.gcsm.unFreeze("COLOR_DATA");t=t.content.ColorsFam;a.gcModel.registerColorFams(n,t),e&&e.apply(i,r)})},loadFilterData:function(n,r,a){var s=this;if(this.gcModel.getFilter1Data(a))return n?void n.apply(r,[]):this.gcModel.getFilter1Data(a,id_dataset);this.gcsm.freeze("NOMENC_DATA");var t="GC_nomenc.php?nomenc="+a+"&lang="+this.getLang(),t=this.addProdHash(t);$.getJSON(t,function(t){s.gcsm.unFreeze("NOMENC_DATA");var e,i=a.split("|");for(e in i)s.gcModel.registerFilter1Data(i[e],t.content[i[e]]);n&&n.apply(r,[])})},loadRefData:function(e,i,n,r,t){var a=this,s=this.gcModel.getRefData(n,r);if(s)return e?void e.apply(i,[s]):s;this.gcsm.freeze("REF_DATA");s="GC_refdata.php?nivgeo="+n+"&lang="+this.getLang(),s=a.addProdHash(s);r&&(s+="&extent="+r),t&&(s+="&view="+t),$.getJSON(s,function(t){a.gcsm.unFreeze("REF_DATA"),a.gcModel.registerRefData(n,r,t.content),e&&e.apply(i,[t.content])})},loadRelationRefData:function(e,i,t,n,r){var a,s=this.gcModel.getRefData(t,n);s&&s.hasOwnProperty(r)?e&&e.apply(i,[s,r]):((a=this).gcsm.freeze("REF_DATA"),t="GC_refdata.php?nivgeo="+t+"&extent="+n+"&nivgeosup="+r+"&lang="+this.getLang(),t=this.addProdHash(t),$.getJSON(t,function(t){a.gcsm.unFreeze("REF_DATA"),s[r]=t.content.territories[r],e&&e.apply(i,[s,r])}))},getIndicURL:function(t,e){t=t.getServerRequestVars(e),t.lang=this.getLang(),e=this.generateUrl("GC_indic.php",t);return this.addProdHash(e)},loadMapIndicResources:function(n,r,a,t,e,s){var o,l=this;if(n)return o=function(t){l.gcModel.getPointLayerDef(s,t,n.getName()),r&&r.apply(a,[s])},void this.loadIndicData(function(t,e){e.hasValidData()||e.getProp("filter1");var i,e=(s=s||new GCO5.model.indics.MapIndicModel(e)).getLayerName();e&&!n.hasLayer(e)?(i=n.getName(),GCO5.appModel.loadLayers(o,l,[{name:e,refgeo:0}],0,i,"addIndicLayer",s)):r&&r.apply(a,[s])},this,t,e,"");this.loadIndicData(r,a,t,e,"")},loadIndicData:function(e,i,n,r,t){var a,s,o,l,c,h,d=this;n&&n.isIndicModel&&!n.isMetaDataLoaded()?console.error("loadIndicData","metadata incomplet"):n&&n.onImportedData()?e&&e.apply(i,[null,n]):(r&&(r.id_view?(r.nivgeo=this.gcModel.getInfoFromMapName(r.id_view,"id_nivgeo","id_view"),r.id_extent=this.gcModel.getInfoFromMapName(r.id_view,"id_extent","id_view")):n.getProp("nivgeo")&&!n.getProp("idExtent")&&(r.id_extent=this.gcModel.getFirstIdExtentFromNivgeo(r.nivgeo||n.getProp("nivgeo")))),a=r.nivgeo||n.getProp("nivgeo"),s=n?this.getIndicURL(n,r):null,o=r.sng_a?r.sng_a[0].id_nivgeo:null,r.surNivgeo&&(o=r.surNivgeo),n&&n.getProp("filter1"),(l=o||a)?d.gcModel.getRefData(l,r.id_extent)?s?(this.gcsm.freeze("INDIC_DATA"),$.getJSON(s,function(t){d.gcsm.unFreeze("INDIC_DATA"),t.dest=r.dest,(t.filt_o=r)&&"anim"==r.serie||n.updateWithServerFullData(t),e&&e.apply(i,[t,n,r])})):e&&e.apply(i,[{dest:r.dest,filt_o:r,nivgeo:r.nivgeo}]):(c="GC_refdata.php?nivgeo="+l+"&lang="+this.getLang(),c=this.addProdHash(c),h=r.id_extent,r.id_extent&&!o&&(c="GC_refdata.php?nivgeo="+a+"&lang="+this.getLang(),c=this.addProdHash(c),c+="&extent="+r.id_extent),this.gcsm.freeze("INDIC_DATA",t),$.getJSON(c,function(t){d.gcModel.registerRefData(l,h,t.content),s?$.getJSON(s,function(t){d.gcsm.unFreeze("INDIC_DATA"),t.dest=r.dest,t.filt_o=r,n.updateWithServerFullData(t),e&&e.apply(i,[t,n,r])}):(d.gcsm.unFreeze("INDIC_DATA"),e&&e.apply(i,[{dest:r.dest,filt_o:r,nivgeo:a}]))})):e&&e.apply(i,[{dest:r.dest}]))},loadColData:function(i,n,t,r){for(var e,a=this,s=(this.gcsm.freeze("COLDATA"),"view="+t.idView+"&dataset="+t.idDataset+"&indic="+t.idIndic),o=(t.axis&&(s+="&axis="+t.axis),[]),l=0;l<t.vars_a.length;l++)e=s+"&vars="+t.vars_a[l].split("+").join("%2B"),o.push(e);var c=o.length,h={};$.each(o,function(e,t){$.getJSON("GC_coldata.php?"+t,function(t){c--,h["var"+(e+1)]=t.content[t.header.params.vars],0==c&&(a.gcsm.unFreeze("COLDATA"),i&&i.apply(n,[h,r]))})})},loadStudy:function(e,i,t){var n,r;void 0!==t?((n=new XMLHttpRequest).open("GET","GC_loadStudy.php?id_study="+t+"&js=1",!0),n.responseType="blob",n.timeout=0,n.onload=function(t){t=t.target.response;t&&e&&e.apply(i,[t])},n.send(null)):(this.gcsm.freeze("loadStudy"),r=this,$.getJSON("GC_loadStudy.php",function(t){r.gcsm.unFreeze("loadStudy"),e&&e.apply(i,[t])}))},loadWMSCap:function(t,e,i,n,r,a,s,o){var l,c=this,h={},d="GET";this.gcsm.freeze("WMS"),".xml"===t.substr(-4,4).toLowerCase()?l=t:r.services[0].useProxy?(h={globe:e.globe,layer:e.layer},l="GC_getcapabilities.php",d="POST"):(-1===(l=t.split("|")[0]).indexOf("?")?l+="?":"?"!=l.substr(-1,1)&&"&"!=l.substr(-1,1)&&(l+="&"),l+="service="+(n?"WMTS":"WMS")+"&REQUEST=GetCapabilities"),$.ajax({type:d,url:l,data:h,dataType:"xml",success:function(t){c.gcsm.unFreeze("WMS"),a&&a.apply(s,[t,o])}})},loadZonComp:function(e,i,t){var n=this,t=(this.gcsm.freeze("zoncomp"),"GC_zonagecomp.php?zon1="+t.zon1+"&zon2="+t.zon2+"&view="+t.idView),t=this.addProdHash(t);$.getJSON(t,function(t){n.gcsm.unFreeze("zoncomp"),e&&e.apply(i,[{compare_a:t.content.compare}])})},searchGeoByCodgeo:function(e,i,t,n){var r=this,n=(this.gcsm.freeze("searchGeoByCodgeoFid"),"GC_infoTerr.php?codgeo="+n+"&nivgeo="+t),n=this.addProdHash(n);$.getJSON(n,function(t){r.gcsm.unFreeze("searchGeoByCodgeoFid"),e&&e.apply(i,[{rech_a:t.content.infosTerr}])})},searchGeoByKey:function(o,l,c,t,e,i){var h=this,n=(this.gcsm.freeze("searchGeoByKey"),c=GCO5.core.GcStringUtil.unaccent(c),{type:"key",key:encodeURIComponent(c),lang:this.getLang()}),e=("*"!=e&&(n.topo="PG"),t&&(n.view=t),i&&(n.report="1"),this.generateUrl("GC_rech.php",n)),e=this.addProdHash(e);$.getJSON(e,function(t){h.gcsm.unFreeze("searchGeoByKey");var e,i=h.gcModel.getInitKey("nivgeo_o"),n=t.content.terrList,r=[];for(e in n){var a=n[e],s=a.nivgeo;i.hasOwnProperty(s)&&(a.lib_nivgeo=i[s].c_lib_nivgeo,a.nivgeo=s,r.push(a))}o&&o.apply(l,[{rech_a:r},c])})},searchSurroundGeo:function(e,i,t){var n,r="GC_rech.php",a={type:"sup",nivgeo:t.nivgeo,lang:this.getLang()};t.idView&&(a.view=t.idView),t.selIds&&(1<t.selIds.length||null==t.codgeo)?(url=this.generateUrl(r,a),url=this.addProdHash(url),n={selids:t.selIds.join(",")},$.ajax({type:"POST",url:url,data:n,dataType:"json",success:function(t){e&&e.apply(i,[{rech_a:t.content.terrList}])}})):(a.codgeo=t.codgeo,url=this.generateUrl(r,a),url=this.addProdHash(url),$.getJSON(url,function(t){e&&e.apply(i,[{rech_a:t.content.terrList}])}))},getObjsInZone:function(e,i,n,r){var t={lang:this.getLang(),nivgeo:n.nivgeo,type:"inf"};t.nivgeosup=n.nivgeosup,t.codgeosup=n.codgeosup,n.id_extent&&(t.extent=n.id_extent),n.idView&&(t.view=n.idView),url=this.generateUrl("GC_rech.php",t),url=this.addProdHash(url),$.getJSON(url,function(t){t.def_o=n,e&&e.apply(i,[t.content,r])})},_hasThemeFilterOnly:function(t){if(t&&t.theme&&!(t.essential||t.nivgeo||t.key||t.typind))return!0},_hasTypindFilterOnly:function(t){if(t&&t.typind&&1==GCO5.core.GcObjectUtil.count(t))return!0},getListIndics:function(i,n,r){if(this._hasThemeFilterOnly(r)){var t=this.gcModel.getIndicsMetaData("id_theme",r.theme);if(t)return void(i&&i.apply(n,[t,r.theme]))}var a,e,s=this,o=(r.tjs?a=!0:(delete r.datasetTJS,delete r.tjs),{lang:this.getLang()});for(e in r)["tag","typind","essential","nivgeo","theme","key","tree","view","tjs","datasetTJS"].indexOf(e)<0&&console.error("listIndics paramètre "+e),"key"==e&&(r[e]=GCO5.core.GcStringUtil.unaccent(r[e])),o[e]=encodeURIComponent(r[e]);this.gcsm.freeze("getListIndics");t=this.generateUrl("GC_listIndics.php",o),t=this.addProdHash(t);$.getJSON(t,function(t){s.gcsm.unFreeze("getListIndics");var e=a?{isTJS:a,dtsAxis:t.content.dataset.axis}:null;s.gcModel.extendIndicInfo(t.content.indics,e),s._hasThemeFilterOnly(r)&&s.gcModel.registerIndicsMetaData(t.content,{id_theme:r.theme}),s._hasTypindFilterOnly(r)&&s.gcModel.registerIndicsMetaData(t.content,{id_theme:r.typind}),i&&i.apply(n,[t.content,r])})},loadReportBlockData:function(e,i,t,n,r){var a=this,t=(this.gcsm.freeze("report"),{lang:this.getLang(),block:t});n.getSingleCodgeo()?(t.nivgeo=n.nivgeo,t.codgeo=n.codgeo):(t.nivgeo=n.nivgeo,n.getIdView()?t.view=n.getIdView():n.getIdExtent()&&(t.extent=n.getIdExtent()),t.title=encodeURI(GCO5.core.GcStringUtil.htmlDecode(n.getLibgeo()||n.getLibSelExtended()))),r&&this._completeSelgeoRequestVars(r,t,{},"2"),url=this.generateUrl("api/v1/functions/GC_API_getBlockInfos.php",t),url=this.addProdHash(url),$.getJSON(url,function(t){a.gcsm.unFreeze("report"),i&&i.apply(e,[t.content])})},loadReportChapterData:function(e,n,r,a,s,o,l,c,t){var h,d=this,i=(this.gcsm.freeze("report"),{lang:this.getLang(),report:r}),u={},p=this.gcModel.getConcept("report_o")[r],g=this.gcModel.getConcept("nivgeo_o"),f=p.reportAxis.filter(function(t){return"G"===t.c_type_axis&&t.c_id_variable&&g[t.c_id_variable]&&"R"===t.c_util});if(0<f.length&&!t)return h=GCO5.core.GcArrayUtil.getColumnByKey(f,"c_id_variable"),t={idView:s.getIdView(),codgeo:s.codgeo,nivgeo:s.nivgeo,selIds:s.getSelIds()},void this.searchSurroundGeo(function(t){var t=t.rech_a.filter(function(t){return 0<=h.indexOf(t.nivgeo)}),i={};h.forEach(function(t,e){i[t]=e}),t.sort(function(t,e){return i[t.nivgeo]-i[e.nivgeo]}),0<t.length&&(l=new GCO5.model.maps.SelGeo(t[0])),1<t.length&&(c=new GCO5.model.maps.SelGeo(t[1])),d.loadReportChapterData(e,n,r,a,s,o,l,c,!0)},this,t);a&&(i.chapter=a),s.getSingleCodgeo()?(i.nivgeo=s.nivgeo,i.codgeo=s.codgeo):(i.nivgeo=s.nivgeo,s.getIdView()?i.view=s.getIdView():s.getIdExtent()&&(i.extent=s.getIdExtent()),i.title=encodeURI(GCO5.core.GcStringUtil.htmlDecode(s.getLibgeo()||s.getLibSelExtended())),u.selids=s.getSelIds().join(",")),o&&this._completeSelgeoRequestVars(o,i,u,"2"),l&&this._completeSelgeoRequestVars(l,i,u,"3"),c&&this._completeSelgeoRequestVars(c,i,u,"4");f=this.generateUrl("GC_report.php",i);s.getSingleCodgeo()&&(o&&o.getSingleCodgeo()||!o)&&(t=(p=this.gcModel.getConcept("report_o")[r]).reportAxis.filter(function(t){return"G"==t.c_type_axis&&"E"==t.c_util}),i=p.reportAxis.filter(function(t){return"G"==t.c_type_axis&&"R"==t.c_util}),p=1==t.length?t[0].c_id_zonref:null,t=1==i.length?i[0].c_id_zonref:null,p&&t&&(p=this.gcModel.getConcept("zonref_o")[p],t=this.gcModel.getConcept("zonref_o")[t],i=p.c_id_nivgeo==s.nivgeo&&p.c_zonref_def==s.codgeo,p=!o||t.c_id_nivgeo==o.nivgeo&&t.c_zonref_def==o.codgeo,i&&p&&(f=this.addProdHash(f)))),GCO5.core.GcObjectUtil.isEmpty(u)?$.get(f,function(t){d.gcsm.unFreeze("report"),n&&n.apply(e,[t.content])}):$.post(f,u,function(t){d.gcsm.unFreeze("report"),n&&n.apply(e,[t.content])})},_completeSelgeoRequestVars:function(t,e,i,n){t.getSingleCodgeo()?(e["nivgeo"+n]=t.nivgeo,e["codgeo"+n]=t.codgeo):(e["nivgeo"+n]=t.nivgeo,e["view"+n]=t.getIdView(),e["title"+n]=encodeURI(t.getLibgeo()||t.getLibSelExtended()),i["selids"+n]=t.getSelIds().join(","))},loadMapImageWithSel:function(t,e,i){var n="GC_make_map.php?lang="+this.getLang()+"&format="+t.format+"&view="+t.view+"&width="+t.w+"&globe="+t.globe,r=(t.globeLayer&&(n+="&globeLayer="+t.globeLayer),GCO5.core.GcStringUtil.isEmpty(t.codgeo)||(n+="&codgeo="+t.codgeo),new XMLHttpRequest);r.open("POST",n,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.responseType="png"==t.format?"blob":"text",r.timeout=0,r.onload=function(t){e&&e.apply(i,[this.response])},r.send(t.selIds?"selids="+t.selIds:null)},getTJSThemes:function(e,i,t,n){var r=this,t=(this.gcsm.freeze("getTJSThemes"),"GC_getThemes.php?type=T&lang="+this.getLang()+"&id_tjs="+t);$.getJSON(t,function(t){r.gcsm.unFreeze("getTJSThemes"),e&&e.apply(i,[t.content])})},loadIsochroneSelIds:function(e,i,t,n,r,a,s,o){if(s=s||{},isNaN(n)||isNaN(r)||isNaN(a)||!t)return!1;var l=s.isoGraph,c=s.isoMethod,h=s.isoReverse,s=s.noToll?"Toll":null,d=this,t=(this.gcsm.freeze("loadIsochrone"),"GC_isochrone.php?view="+t+"&x="+n+"&y="+r+"&method="+c+"&reverse="+h+"&graph="+l);s&&(t+="&exclusion="+s),t+="time"==c?"&time="+a:"&distance="+a,o&&(t+="&epsg="+o),$.getJSON(t,function(t){d.gcsm.unFreeze("loadIsochrone"),e&&e.apply(i,[t.content])})},loadIsochroneLayer:function(e,i,t,n,r,a,s,o){if(s=s||{},isNaN(n)||isNaN(r)||isNaN(a)||!t)return!1;var l=s.isoGraph,c=s.isoMethod,h=s.isoReverse,s=s.noToll?"Toll":null,t="GC_isochrone.php?layer=1&view="+t+"&x="+n+"&y="+r+"&method="+c+"&reverse="+h+"&graph="+l,d=(s&&(t+="&exclusion="+s),t+="time"==c?"&time="+a:"&distance="+a,o&&(t+="&epsg="+o),{}),n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.timeout=0,n.onload=function(t){t=t.target.response;t&&(d.isochrone_DR=t,e&&e.apply(i,[d]))},n.send(null)},loadInfosel:function(a,s,o){var t,l=this,e=this.gcModel.getInfoselVariables(a,this.getLang()),i=(this.gcsm.freeze("INFOSEL"),"GC_infosel.php?lang="+this.getLang()+(a.mim?"":"&allindics=0"));for(t in e.variablesGet)i+="&"+t+"="+e.variablesGet[t];responseCreator=function(t){l.gcsm.unFreeze("INFOSEL");var e,i={params:t.header.params,dest:a.dest,typsel:a.typsel};for(e in i.params||(i.params={}),i.params.def_o=a,t.content)i[e]=t.content[e];var n={},r=0;t.content.territories&&t.content.territories.forEach(function(t,e){"REF"==t.type&&(t.typeVal="valRef"+ ++r),"SELGEO"==t.type&&(t.typeVal="valSel",i.selgeoPk=t.id),n[t.id]=t.typeVal}),i.ref_o=n,s&&s.apply(o,[i])},0===Object.keys(e.variablesPost).length&&e.variablesPost.constructor===Object?$.get(i,{},responseCreator,"json"):$.post(i,e.variablesPost,responseCreator,"json")},login:function(e,i,n){var r=this,t={};t.login=n.user,t.password=n.pwd,this.gcsm.freeze("LOGIN"),$.post("GC_login.php",t,function(t){t.dest=n.dest,r.gcsm.unFreeze("LOGIN"),e&&e.apply(i,[t])},"json")},logout:function(e,i,t){var n=this;this.gcsm.freeze("LOGOUT"),$.get("GC_logout.php",function(t){n.gcsm.unFreeze("LOGOUT"),e&&e.apply(i,[t])},"json")},resetPassword:function(e,i,t){var n=this;this.gcsm.freeze("EMAIL"),$.get("./GC_sendEmailResetPwd.php?email="+t.email,function(t){n.gcsm.unFreeze("EMAIL"),e&&e.apply(i,[t])},"json")},sendNewPassword:function(e,i,t){var n=this;this.gcsm.freeze("newPassword"),$.post("./GC_resetPassword.php",t,function(t){n.gcsm.unFreeze("newPassword"),e&&e.apply(i,[t])})},getZonsAroundPosition:function(e,i,t){var n,r={lang:this.getLang()},a=this;a.gcModel.getConcept("nivgeo")[0].pk;for(n in t)t[n]&&(r[n]=t[n]);this.gcsm.freeze("GEOLOC");var s=this.generateUrl("GC_rech.php",r),s=this.addProdHash(s);$.getJSON(s,function(t){a.gcsm.unFreeze("GEOLOC"),e&&e.apply(i,[{rech_a:t.content.terrList||null},"geoloc"])})},getLang:function(){return GCO5.core.GcLangManager.getInstance().getLang()}}),GCO5.model.maps.SelGeo=GCO5.Class.extend({statics:{NAME:"GCO5.model.maps.SelGeo",POINT:"point",LINE:"line",POLYGON:"polygon",selgeo_o:{},geoinited:!1,SEL_STROKE_COLOR:"#f00",hasSavedSels:function(){var t=GCO5.core.ClientInfo.getInstance(),e=t.readFromSessionStorage("curSelgeo"),t=t.readFromLocalStorage("selgeo_a");return e&&0<e.length||t&&0<t.length},clearSession:function(){GCO5.core.ClientInfo.getInstance().removeItemFromSessionStorage("curSelgeo")},getcurSelgeo:function(){var t=GCO5.core.ClientInfo.getInstance().readFromSessionStorage("curSelgeo");return(t=t?JSON.parse(t):null)?new GCO5.model.maps.SelGeo(t):null},cloneSelgeo:function(t){GCO5.model.maps.SelGeo.getcurSelgeo();return GCO5.model.maps.SelGeo.registerCurSelGeo(t),GCO5.model.maps.SelGeo.getcurSelgeo()},registerCurSelGeo:function(t){t?t.sessionRegister():GCO5.model.maps.SelGeo.clearSession()},getSavedSels:function(t,e){var i,n=GCO5.core.ClientInfo.getInstance().readFromSessionStorage("curSelgeo"),r=(n=n?JSON.parse(n):null,(r=GCO5.core.ClientInfo.getInstance().readFromLocalStorage("selgeo_a"))?JSON.parse(r):[]);e&&(i=GCO5.appModel.getInfo("surNivgeos",[e,!0]));for(var a=[],s=0;s<r.length;s++){var o=r[s];t&&o.nivgeo+"|"+o.codgeo==t.getPkGeo()||e&&o.nivgeo!=e&&!(0<=GCO5.core.GcArrayUtil.indexOfByKey(i,"id_nivgeo",o.nivgeo))||a.push(o)}return a},getSelsCompatibleWithNivgeos:function(t,e,i){for(var n=i?[i]:GCO5.model.maps.SelGeo.getSavedSels(),r=[],a=0;a<n.length;a++){var s=n[a].nivgeo,o=GCO5.appModel.getInfo("subNivgeos",[s]);(0<=t.indexOf(s)||!e&&0<GCO5.core.GcArrayUtil.intersection(o,t).length)&&r.push(n[a])}return r},getViewsCompatibleWithSel:function(t,e){var i=[];if("##"==t.codgeo.substr(0,2))var n=t.nivgeo,r=t.id_extent,i=GCO5.appModel.getInfo("mapNamesFromNivgeo",[n,r]);else{var a=GCO5.appModel.getInfo("subNivgeos",[t.nivgeo,e]);(!e||0<=e.indexOf(t.nivgeo))&&a.push({count:1,nivgeo:t.nivgeo});for(var s=0;s<a.length;s++){var n=a[s].nivgeo,r=t.id_extent,o=GCO5.appModel.getInfo("mapNamesFromNivgeo",[n,r]);i=i.concat(o)}}return i},readPosition:function(e,i){var n=GCO5.core.SystemManager.getInstance();Modernizr.geolocation&&!GCO5.model.maps.SelGeo.geoinited?(n.freeze("geolocation"),GCO5.browser.isFirefox&&n.unFreeze("geolocation",500),navigator.geolocation.getCurrentPosition(function(t){t=t.coords;GCO5.model.maps.SelGeo._getZonsAroundPosition(e,i,t.latitude,t.longitude),n.unFreeze("geolocation"),GCO5.model.maps.SelGeo.geoinited=t},function(t){console.log("error selgeo getCurrentPosition "+t.code),n.unFreeze("geolocation"),GCO5.model.maps.SelGeo._getZonsAroundPosition(e,i)},{maximumAge:0,timeout:5e3})):(GCO5.model.maps.SelGeo._getZonsAroundPosition(e,i,GCO5.model.maps.SelGeo.geoinited.latitude,GCO5.model.maps.SelGeo.geoinited.longitude),n.unFreeze("geolocation"))},_getZonsAroundPosition:function(t,e,i,n){t.apply(e,[i?{lat:i,lng:n,type:"position"}:null])}},nivgeo:null,id_extent:null,libgeo:null,id:null,codgeo:null,selIds_o:null,isSelgeo:null,styles:null,initialize:function(t){t&&this.update(t)},setStyles:function(t,e){e?this.styles[e]=t:t&&(this.styles=t)},getStyles:function(){return this.styles},setDefaultStyles:function(){return this.styles={strokeStyle:this.constructor.SEL_STROKE_COLOR,fillUniqueSel:GCO5.view.component.LayerView.SELCOLOR1}},getIdExtent:function(){return this.id_extent},update:function(t){this.nivgeo=t.nivgeo,this.id_extent=t.id_extent,this.libgeo=t.libgeo||"",this.id=t.hasOwnProperty("id")?t.id:null,this.codgeo=t.hasOwnProperty("codgeo")?t.codgeo:null,this.isSelgeo=!0,this.styles=t.styles||this.setDefaultStyles();var e,i,n,r=t.nivgeo+"|"+t.id_extent;this.selIds_o={},t.selIds&&(this.selIds_o[r]=t.selIds),t.selIds&&(e=t.selIds[0],i=GCO5.model.maps.RefgeoCacheModelV5.getInstance(),t.codgeo||(n=i.getCodgeoById(t.nivgeo,t.id_extent,e))&&(1==t.selIds.length?this.codgeo=n:this.libgeo2=i.getLibgeoById(t.nivgeo,t.id_extent,e))),t.selIds&&1==t.selIds.length&&this.codgeo?this.id=e:t.selIds?this.codgeo=this._hashSel(r,t.selIds):t.hasOwnProperty("selIds_o")&&(this.selIds_o=t.selIds_o)},getLibgeo:function(){return""+(this.libgeo||this.getSingleCodgeo()||"")},setLibgeo:function(t){this.libgeo=t},setExtent:function(t){this.id_extent=t},getLibNivgeo:function(t,e){return GCO5.appModel.getInfo("libNivgeo",[this.nivgeo,t,e])},getLibSelExtended:function(t,e,i,n){void 0===n&&(n=!0);var r=this.getSelIds(),a=GCO5.core.GcLangManager.getInstance(),r=r?r.length:0,s=a.formatNumber(r),o=this.getSingleCodgeo(),n=this.getLibNivgeo(n,!o),l=this.libgeo||(1<r?s+" "+n:o);return i&&(l="<b>"+l+"</b>"),t&&(o&&e?l+=" ("+n+a.getString("P2")+" "+o+")":n&&(i=(1<r?s+" ":"")+n).toLowerCase().indexOf(l.toLowerCase())<0&&(l+=" ("+i+")")),l},getDataNivgeo:function(t){t||(e=this.getNivgeo()+"|"+this.getIdExtent(),t=this.selIds_o&&this.selIds_o[e]?e:GCO5.core.GcObjectUtil.getFirstKey(this.selIds_o),e=!0);var e,i,n={};for(i in this)$.isFunction(this[i])||"selIds_o"==i||"statics"==i||(n[i]=this[i]);return!this.selIds_o||!this.selIds_o[t]||e&&this.getSingleCodgeo()||(n.selIds=this.selIds_o[t]),n},getNivgeo:function(){return this.nivgeo},getData:function(){var t,e={};for(t in this)$.isFunction(this[t])||"statics"==t||(e[t]=this[t]);return e},isCompatibleWithNivgeo:function(t){var e=[{nivgeo:this.nivgeo}].concat(GCO5.appModel.getInfo("subNivgeos",[this.nivgeo]));return 0<=GCO5.core.GcArrayUtil.indexOfByKey(e,"nivgeo",t)},getSelIdsFirstKey:function(){return GCO5.core.GcObjectUtil.getFirstKey(this.selIds_o)},getSelIdsCompact:function(){var t,e,i=Number.POSITIVE_INFINITY;for(e in this.selIds_o)this.selIds_o[e].length<i&&(i=this.selIds_o[e].length,t=e);if(t){var n={nivgeo:t,selIds:this.selIds_o[t]};if(GCO5.appModel.testInfo("nivgeo",[t])||(n.filt_nivgeo=t,n.nivgeo=GCO5.appModel.getInfo("nivgeoFromFiltNivgeo",[t])),n.nivgeo)return n}return null},isNotEmptyFor:function(t,e){t=t+"|"+e;return this.getSingleCodgeo()&&t==this.nivgeo+"|"+this.id_extent||this.selIds_o&&this.selIds_o[t]&&0<this.selIds_o[t].length},getSelIds:function(e,t,i,n,r){var a=this,s=e+"|"+t;if(e||(o=this.getNivgeo()+"|"+this.getIdExtent(),s=this.selIds_o&&this.selIds_o[o]?o:GCO5.core.GcObjectUtil.getFirstKey(this.selIds_o)),this.selIds_o&&this.selIds_o[s])return i&&i.apply(n,[r,this.selIds_o[s].length]),this.selIds_o[s];if((!s||s==this.nivgeo+"|"+this.id_extent)&&null!=this.id)return i&&i.apply(n,[r,1]),[this.id];var o=GCO5.appModel.getInfo("viewsCompatibleWithNivgeoSel",[this.nivgeo]),l=GCO5.appModel.getRefData(e,t);if(this.nivgeo===e&&s&&null==this.id&&l){for(var c=l.codgeo.length,h=0;h<c;h++)if(l.codgeo[h]===this.codgeo){this.id=h,t&&(this.id_extent=t);break}return i&&i.apply(n,[r,1]),[this.id]}if(s&&i&&(0<=GCO5.core.GcArrayUtil.indexOfByKey(o,"id_nivgeo",e)||"PT"==GCO5.appModel.getInfo("NivgeoTopology",[e]))){var d={nivgeosup:this.nivgeo,fidsup:this.id,id_extent:t||this.id_extent,nivgeo:e,libgeo:this.libgeo};if(r&&r.idView&&(d.idView=r.idView),this.getSingleCodgeo())d.codgeosup=this.codgeo;else{if(this.selIds_o[this.nivgeo]){var u=this.selIds_o[this.nivgeo].join(",");if(100<u.length)return i.apply(n,[r,0]),null}d.fidsup=u}return GCO5.appModel.getObjsInZone(function(t){!d.id_extent&&t.idView&&(a.id_extent=d.id_extent=GCO5.appModel.getInfo("infoFromMapName",[t.idView,"id_extent"])),a.updateSelIds(e,d.id_extent,t.terrList),i.apply(n,[r,t.terrList?t.terrList.length:0])},this,d),null}return i&&i.apply(n,[r,0]),null},isCompatibleWithMapView:function(t){return 0<=GCO5.model.maps.SelGeo.getViewsCompatibleWithSel(this).indexOf(t)},updateSelIds:function(t,e,i,n,r){this.selIds_o||(this.selIds_o={}),i=i||[];var a,s=t+"|"+e,o=(this.selIds_o[s],GCO5.model.maps.RefgeoCacheModelV5.getInstance()),l=i[0];return 1!=i.length||r||(a=o.getCodgeoById(t,e,l))&&(r=a),1==i.length&&r?(this.codgeo=r,this.id=l,this.nivgeo=t,this.id_extent=e,delete this.selIds_o[s],this.libgeo=n):(this.selIds_o[s]=i,this.libgeo2=o.getLibgeoById(t,e,l),(n&&this.libgeo!=n||!n)&&(this.codgeo=this._hashSel(s,i),this.id_extent=e,n&&(this.libgeo=n),this.id=null,this.nivgeo=t)),this},getSingleCodgeo:function(){return this.codgeo&&"##"!=this.codgeo.substr(0,2)?this.codgeo:null},getPkGeo:function(t){return this.nivgeo+(t=t||"|")+this.codgeo},sessionRegister:function(){try{GCO5.core.ClientInfo.getInstance().writeToSessionStorage("curSelgeo",JSON.stringify(this.getData()))}catch(t){alert(t)}return!0},localStorageTestSave:function(t,e){var i;return!!GCO5.core.ClientInfo.getInstance().localStorageSupported()&&(i=(i=GCO5.core.ClientInfo.getInstance().readFromLocalStorage("selgeo_a"))?JSON.parse(i):[],i=GCO5.core.GcArrayUtil.getSubArray(i,{codgeo:[this.codgeo],nivgeo:[this.nivgeo]}),t.apply(e,[0==i.length?"yes":"no"]),!0)},localStorageSave:function(){var t=GCO5.core.ClientInfo.getInstance().readFromLocalStorage("selgeo_a");(t=t?JSON.parse(t):[]).unshift(this.getDataNivgeo()),GCO5.core.ClientInfo.getInstance().writeToLocalStorage("selgeo_a",JSON.stringify(t))},getSubNivgeos:function(){return GCO5.core.GcArrayUtil.getColumnByKey(GCO5.appModel.getInfo("subNivgeos",[this.nivgeo]),"nivgeo").concat([this.nivgeo])},getIdView:function(){return GCO5.appModel.getInfo("mapNameFromNivgeo",[this.nivgeo,this.id_extent])},getTopology:function(){var t=GCO5.appModel.getConcept("nivgeo_o")[this.nivgeo];return t?t.c_topo:null},clear:function(){for(var t in this)$.isFunction(this[t])||(this[t]=null)},isEmpty:function(){return null==this.nivgeo},_hashSel:function(t,e){return"##"+t+GCO5.core.GcStringUtil.hashCode2(e)}}),GCO5.model.indics.IndicModel=GCO5.Class.extend({statics:{NAME:"GCO5.model.indics.IndicModel",ADDITIVE:"addit",RATIO:"ratio",CHARUNORD:"charunord",CHARORD:"charord",cat_o:null,providers:["GcIndicModelV3","GcIndicModelImported","GcIndicModelV5"]},isIndicModel:null,_provider:null,providerIndicModel:null,gclg:null,childAssocIndicModel:null,parentAssocIndicModel:null,options:null,initialize:function(t,e){this.options={},e=(e=e||0!=t.c_id_dataset.indexOf("_import")?e:"GcIndicModelImported")||"GcIndicModelV"+(GCO5.initInfo.version||"3"),this.constructor.providers.indexOf(e)<0?console.error("IndicProvider "+e+" inconnu"):(this._provider=e,this.gclg=GCO5.core.GcLangManager.getInstance(),this._setup(t,e))},clone:function(){var t=new GCO5.model.indics.IndicModel(this.providerIndicModel.cloneRawInfo(),this._provider);return t.providerIndicModel.status=this.providerIndicModel.status,t},setOption:function(t,e){this.options[t]=e},getOption:function(t){return this.options[t]},_setup:function(t){this.providerIndicModel=new GCO5.model.indics[this._provider](t,this),this.isIndicModel=!0,t.assocIndicModel&&(this.assocIndicModel=t.assocIndicModel),this._addProxyFunctions()},onImportedData:function(){return"GcIndicModelImported"==this._provider},getDataset:function(){return this.providerIndicModel.getDataset()},getMappingCategory:function(){var t,e=GCO5.model.indics.MapIndicModel;return this.applyToPolygons()?t=this.isAdditive()?this.isBiLoc()?e.SYMB_FLUX:e.SYMB_GRAD:this.isRatio()?e.CHORO_NUM:this.isBiLoc()?e.SYMB_OURSINS:e.CHORO_VI:this.applyToPoints()?(t=this.isAdditive()?e.SYMB_GRAD:this.isRatio()?e.SYMB_PTCHORO:e.SYMB_PTVI,this.isBiLoc()&&(t=this.isAdditive()?e.SYMB_FLUX:e.SYMB_OURSINS)):this.applyToLines()&&(t=e.SYMB_LNVI),t},getMappingSuperCategory:function(){return GCO5.model.indics.MapIndicModel.getScatFromCat(this.getMappingCategory())},getProp:function(t,e,i,n,r){t="get"+GCO5.core.GcStringUtil.proper(t,!0);return this[t]?this[t](e,i,n,r):this.providerIndicModel[t]?this.providerIndicModel[t](e,i,n,r):void console.error("IndicProvider getProperty error "+t+" inconnu")},_addProxyFunctions:function(){var t,e=["getPk","updateWithServerMetaData","updateWithServerFullData","getServerRequestVars","isZonage","isModActive","clearComputedData","setSelectionInfo","hasValidData","isPie","isTJS","clearAnimData","isExternalTJS","getDataById","isEstimatedValue","hasEstimatedValues","getDataICById","getDataICBoundById","getFormattedDataById","getFormattedDataByData","getKey","getStat","setNivgeo","setAnimData","getValues","setNbDec","setF0Code","setF0Lib","setSerie","setProp","valuesDisplayable","valuesExportable","getZonageInfoById","getHexColForModIndex","getSubNivgeos","setSurNivgeo","cloneRawInfo","setTJSServer"];for(t in e){var i=e[t];this[i]=$.proxy(this.providerIndicModel[i],this.providerIndicModel)}},getExtendedPk:function(){return this.getPkF1()+"|"+this.getProp("idgeo")},getPkF1:function(){var t=this.getPk();return GCO5.core.GcStringUtil.isEmpty(this.getProp("f1Code"))||(t+="|"+this.getProp("f1Code")),t},getPkF1Safe:function(){return this.getPkF1().replace(".","_").replace("|","_")},getNivgeosArray:function(){return this.getProp("nivgeos").map(function(t){return{data:t,label:GCO5.appModel.getInfo("libNivgeo",[t])}}).reverse()},buildIndicAssocModel:function(t){var e=this.providerIndicModel.getIdIndicAssoc();if(GCO5.core.GcStringUtil.isEmpty(e))return null;t=t||{c_id_indicateur:e,c_id_dataset:this.getProp("idDataset")};e=this.getProp("serie");return e&&(t.serie=e),this.linkAssocModel(new GCO5.model.indics.IndicModel(t))},linkAssocModel:function(t){return!t&&this.assocIndicModel&&(this.assocIndicModel.assocIndicModel=null),(this.assocIndicModel=t)&&(t.assocIndicModel=this),t},getAssocModel:function(){return this.assocIndicModel},hasSerieChartableSelectionInfo:function(){if(!this.valuesDisplayable())return!1;var e,i,t=this.getProp("selectionInfo");return!!(t&&t.dts&&this.getProp("serie"))&&(i=e=0,t.dts.forEach(function(t){e++,GCO5.core.GcMathUtil.isInvalid(t.valSel)&&i++}),i<e)},hasDataForMapName:function(t){return!!this.isFullyLoaded()&&(this.applyToPoints()||this.applyToLines()?t==this.getProp("view"):(this.applyToPolygons()&&(i=this.getProp("nivgeo"),e=this.getProp("idExtent"),i=GCO5.appModel.getInfo("mapNamesFromNivgeo",[i,e])),0<=i.indexOf(t)));var e,i},getIdView:function(){return GCO5.appModel.getInfo("mapNameFromNivgeo",[this.getProp("nivgeo"),this.getProp("idExtent"),"id_view"])},getExtents:function(){var t,e=GCO5.appModel.getConcept("extent_o"),i=[],n={};for(t in this.getViewsCompatible().forEach(function(t){t=GCO5.appModel.getInfo("infoFromMapName",[t,"id_extent"]);t&&(n[t]=1)}),n)i.push(e[t]);return i},getExtentsLib:function(){return this.getExtents().map(function(t){return t.c_lib_extent}).join(", ")},getViewsCompatible:function(e){if(!this.isMetaDataLoaded())return!1;var t=this.getProp("views");if(""==t.join("")&&this.isTJS())for(var i in t=[],this.getProp("viewsFrameworks"))t.push(i);return t=e&&e.id_extent?t.filter(function(t){return(!e.id_view||t==e.id_view)&&GCO5.appModel.getInfo("infoFromMapName",[t,"id_extent"])==e.id_extent}):t},getF1Lib:function(t){var e=this.getProp("filter1Array"),t=GCO5.core.GcArrayUtil.indexOfByKey(e,"id",t||this.getProp("f1Code"));return e&&0<=t?e[t].lib:null},getLibIndicWithF1:function(t,e,i,n){var e=e?this.getProp("libIndic"):this.getProp("shortLibIndic"),r=this.getProp("f1Lib"),a=" - ",n=(n&&(a=n),this.getProp("serie")),s=this.getProp("F0Lib");return(e=s&&i?s+" - "+e:e)+(n&&t?" "+n:"")+(r?a+r:"")},isPreSorted:function(){return null!=this.getProp("sortedIndices")},hasRefValues:function(){return!!this.getProp("dpValRef")},isBiLoc:function(){return 2===this.getProp("nbGeoDims")},hasFormula:function(){return!GCO5.core.GcStringUtil.isEmpty(this.getProp("formula"))},hasDivergingColorPalette:function(){return GCO5.appModel.testInfo("divergingColfam",[this.getIdColorFamily()])},applyToLines:function(){return"PL"==this.providerIndicModel.getTopology()},applyToPolygons:function(){return"PG"==this.providerIndicModel.getTopology()},applyToPoints:function(){return"PT"==this.providerIndicModel.getTopology()},isAdditive:function(){return this.providerIndicModel.nature==this.constructor.ADDITIVE},isAgregable:function(){return this.isRatio()&&this.hasFormula()||this.isAdditive()},isRatio:function(){return this.providerIndicModel.nature==this.constructor.RATIO},isCharUnord:function(){return this.providerIndicModel.nature==this.constructor.CHARUNORD},isCharOrd:function(){return this.providerIndicModel.nature==this.constructor.CHARORD},isQualitative:function(){return this.isCharUnord()||this.isCharOrd()},isPolygonVI:function(){return this.providerIndicModel.nature?this.isQualitative()&&this.applyToPolygons()&&!this.isBiLoc():"I"==this.getProp("type")},isNumeric:function(){return(this.isAdditive()||this.isRatio())&&!this.hasMultVars()},isPie:function(){return this.isAdditive()&&this.hasMultVars()},isOursins:function(){return this.isCharUnord()&&this.isBiLoc()},isFlux:function(){return this.isAdditive()&&this.isBiLoc()},isTypoPole:function(){return this.providerIndicModel.isTypoPole()},isFullyLoaded:function(){return 3==this.providerIndicModel.status},isMetaDataLoaded:function(){return 2<=this.providerIndicModel.status&&null!=this.getProp("nivgeo")},hasMultiplePeriods:function(){var t=this.getProp("dataSeries");return t&&1<t.length},getNbPeriods:function(){var t=this.getProp("dataSeries");return t?t.length:0},hasMultVars:function(){return 1<this.getProp("nbVars")},isNonAdditiveNonAgreg:function(t){return this.isRatio()&&!this.hasFormula()},getData:function(t){return this.getKey(t)},destroy:function(){},checkSeriesValues:function(t,e){this.getProp("series");var i=this.getProp("dataSeries")||this.getProp("series");t.length;return i.join("")!=t.concat().sort().join("")&&{serie_a:i.sort(),serie:this.getProp("serie")}},checkFilter1Values:function(t,e){var i=this.getProp("dataFilter1"),n=t.length;return!!(i&&0<i.length&&n!=i.length)&&{f1_a:t.filter(function(t){return 0<=i.indexOf(t.id)}),f1code:this.getProp("f1Code")}},getActualFilter1Array:function(){var t=this.getProp("filter1Array"),e=this.checkFilter1Values(t);return e?e.f1_a:t},getLayerName:function(){return this.applyToPoints()?this.getProp("idSymbLayer")+"_P":this.applyToLines()?this.getProp("idSymbLayer")+"_L":null},getFormattedValue:function(t,e,i){if(!this.valuesDisplayable())return null;var n,r=this.getProp("unit"),a=this.getProp("nbDec");return this.isNumeric()&&GCO5.core.GcMathUtil.isInvalid(t)?n=t==GCO5.core.GcMathUtil.SPECIFIC_VALUE.SECRET?this.gclg.getString("NASS","indics"):t==GCO5.core.GcMathUtil.SPECIFIC_VALUE.DIV0?this.gclg.getString("NAD0","indics"):this.gclg.getString("NA","indics"):this.isNumeric()||this.isPie()?(n=this.gclg.formatNumber(t,a,i),e&&r&&""!=r&&(n+=(i?" ":"&nbsp;")+r)):n=t,n},getFormattedValrefs:function(){var t=this.getProp("valRefs"),e=this.getProp("unit"),i=this.getProp("nbDec"),n="";if(t&&t.valref_a&&t.libref_a&&1<t.valref_a.length)for(var r=1;r<t.valref_a.length;r++){var a=t.valref_a[r];void 0===a||GCO5.core.GcMathUtil.isInvalid(a)||(n+="<br>"+t.libref_a[r]+this.gclg.getString("P2")+" "+this.gclg.formatNumber(a,i),""!=e&&(n+=" "+e))}return n},getTerrRefs:function(){return this.getProp("dpValRef")}}),GCO5.model.indics.GcIndicModelV5=GCO5.Class.extend({statics:{NAME:"GCO5.model.indics.GcIndicModelV5"},status:null,nbGeoDims:null,nature:null,info_indic:null,invalid:null,gclg:null,selectionInfo:null,indicModel:null,initialize:function(t,e){if(!t.hasOwnProperty("c_id_dataset")||!t.hasOwnProperty("c_id_indicateur"))throw console.log(t),"invalid GcIndicModel";this.status=1,this.gclg=GCO5.core.GcLangManager.getInstance(),this.info_indic=t,this.indicModel=e,t.hasOwnProperty("c_lib_indicateur_court")&&(this._categorize(),this.status=2)},getMapParams:function(){return this.info_indic.mapParams},getInvalid:function(){return 1===this.invalid},getSelectionInfo:function(){return this.selectionInfo},getTxtTabVars:function(){return this.selectionInfo?this.selectionInfo.txtTabVars:null},cloneRawInfo:function(){return GCO5.core.GcObjectUtil.clone(this.info_indic)},_categorize:function(){var t=this.getType(),e=(this.nbGeoDims="F"==t||"O"==t?2:1,GCO5.model.indics.IndicModel),e={I:e.CHARUNORD,Z:e.CHARUNORD,C:e.RATIO,O:e.CHARUNORD,R:e.ADDITIVE,F:e.ADDITIVE};this.nature=e[t]},getTopology:function(){return this.info_indic.c_topo},getIdThemes:function(){return this.info_indic.c_id_theme},getLibThemes:function(){if(this.indicModel.isTJS())return[{id_theme:this.info_indic.c_id_dataset,lib_theme:this.info_indic.c_lib_dataset}];var e=GCO5.appModel.getInitKey("theme_o");return this.getIdThemes().map(function(t){return e[t]?{id_theme:t,lib_theme:e[t].label}:null}).filter(function(t){return!!t})},getNbGeoDims:function(){return this.nbGeoDims},getFormula:function(){return this.info_indic.frm_type?this.info_indic.frm_type.type:null},getFormulaType:function(){return this.info_indic.frmType},getIdReport:function(){return this.report},getType:function(){return this.info_indic.c_id_typind},getIdIndicAssoc:function(){return this.info_indic.c_indic_assoc},getFormulaStructure:function(){var t,e=this.info_indic.frmType;return e&&((t={}).typFrm=e.type,"p1*var1/var2"==t.typFrm&&(t.typFrm="p1*var1/var2+p2"),t.var1=e.var1,t.var2=e.var2,t.multFrm=e.p1||1,t.constFrm=e.p2||0,e.var3&&(t.var3=e.var3),e.var4&&(t.var4=e.var4),e.p3&&(t.powerFrm=e.p3)),t},getSymbFillActive:function(){return"cc"!=this.info_indic.c_shape&&"es"!=this.info_indic.c_shape},getSymbShape:function(){return this.info_indic.c_shape},getDrawSymbsAsc:function(){return this.info_indic.c_drawsymbs_asc},getShowArrow:function(){return"1"==this.info_indic.c_show_arrow},getFluxCurveLevel:function(){return this.info_indic.c_curve_level},getNbVars:function(){return this.info_indic.nbVars||1},getNbClasses:function(){return this.info_indic.discr_o.nclasses},getSeuils:function(){return this.info_indic.discr_o&&this.info_indic.discr_o.seuils?this.info_indic.discr_o.seuils:null},getSeuilsinf:function(){return this.info_indic.discr_o.seuilsinf},isZonage:function(){return"Z"==this.getType()},getControlMetaData:function(){var e=GCO5.appModel.getConcept("view_o"),i=GCO5.appModel.getConcept("nivgeo_o"),t=GCO5.appModel.getConcept("extent_o"),n=this.getViews().map(function(t){return{id_view:t,id_extent:e[t].c_id_extent,lib_view:e[t].c_lib_view.replace(/\|/g," "),ordre:e[t].ordre}}),r=this.getNivgeos().map(function(t){return{id_nivgeo:t,lib_nivgeo:i[t].c_lib_nivgeo}}),a=this.getDataSeries();return{views:n.sort(function(t,e){return t.ordre-e.ordre}),nivgeos:r,series:a?a.reverse():null,typind:this.getType(),id_view:this.getView(),serie:this.getSerie(),extent_o:t,libIndic:this.getLibIndic(),shortLibIndic:this.getShortLibIndic(),source:this.getSource(),precisions:GCO5.core.GcStringUtil.toHTmlWithSingleBr(this.getPrecisions()),limitUtil:GCO5.core.GcStringUtil.toHTmlWithSingleBr(this.getLimitUtil()),descIndicateur:GCO5.core.GcStringUtil.toHTmlWithSingleBr(this.getDescIndicateur())}},getLibgeoMin:function(){var t=this.getStat("minimum");return t?t.libgeo?t.libgeo+" - "+t.codgeo:t.codgeo:null},getLibgeoMax:function(){var t=this.getStat("maximum");return t?t.libgeo?t.libgeo+" - "+t.codgeo:t.codgeo:null},getSubNivgeos:function(t){var e=this.info_indic.surnivgeos0_a||this.info_indic.nivgeos,e=GCO5.core.GcArrayUtil.getColumnByKey(GCO5.appModel.getInfo("subNivgeos",[t,e]),"nivgeo");return 0==e.length?t:e.join("|")},getSurNivgeos:function(){return this.info_indic.surnivgeos0_a},getSurNivgeosLib:function(){return this.info_indic.surnivgeoslib_a},getAbsoluteMaximum:function(){var t=this.getFirstDistribInfo();return Math.max(t.maxth,-t.minth)},getFirstDistribInfo:function(){return this.info_indic.distrib_o},getFirstDiscretizationInfo:function(){var t=this.info_indic.discr_o;if(!(t=t||(this.info_indic.discr_o={})).efts){for(var e=[],i=0;i<12;i++)e[i]=0;if(!t.codes&&1==t.nclasses){t.codes=[];for(var n=this.info_indic.distrib_o.eftth,i=0;i<n;i++)t.codes.push(0)}for(var r=t.codes,n=r.length,i=0;i<n;i++)e[r[i]]++;t.efts=e}return this.info_indic.discr_o},getKValref:function(){return this.info_indic.discr_o&&this.info_indic.discr_o.hasOwnProperty("k_valref")?this.info_indic.discr_o.k_valref:-1},getPk:function(){var t=this.info_indic;return t.indic||(t.indic=t.c_id_dataset+"."+t.c_id_indicateur),t.indic},getIdIndic:function(){return this.info_indic.c_id_indicateur},getIdIndicateur:function(){return this.getIdIndic()},getDataset:function(){return null},getIdDataset:function(){return this.info_indic.c_id_dataset},getLibIndic:function(){return this.info_indic.c_lib_indicateur},getShortLibIndic:function(){return this.info_indic.c_lib_indicateur_court},getSource:function(){return this.info_indic.c_source},getPrecisions:function(){return GCO5.core.GcStringUtil.htmlDecode(this.info_indic.c_precisions)},getLimitUtil:function(){return GCO5.core.GcStringUtil.htmlDecode(this.info_indic.c_limutil_indicateur)},getDescIndicateur:function(){return GCO5.core.GcStringUtil.htmlDecode(this.info_indic.c_desc_indicateur||this.info_indic.c_definition)},getURLIndicateur:function(){return this.info_indic.c_url_indicateur},getURLLogo:function(){return this.info_indic.c_url_logo},getURLTextIndicateur:function(){return GCO5.core.GcStringUtil.isEmpty(this.info_indic.c_urllib_indicateur)?this.info_indic.c_url_indicateur:this.info_indic.c_urllib_indicateur},getURLData:function(){return this.info_indic.c_url_data},getURLTextData:function(){return GCO5.core.GcStringUtil.isEmpty(this.info_indic.c_urllib_data)?this.info_indic.c_url_data:this.info_indic.c_urllib_data},getFormulaLib:function(){return this.info_indic.c_formula_indicateur},getIdSymbLayer:function(){return this.info_indic.c_id_symb},getIdgeo:function(){return this.getIdSymbLayer()||this.getNivgeo()},getPkgeo:function(){this.getIdgeo();return(this.getIdSymbLayer()||this.getNivgeo())+"|"+this.getIdExtent()},getFluxIndices1:function(){return this.info_indic.distrib_o.indices1},getFluxIndices2:function(){return this.info_indic.distrib_o.indices2},getFluxCodes:function(){return this.info_indic.discr_o.codes},getAlphas:function(){return GCO5.core.GcArrayUtil.getColumnByKey(this.info_indic.colorPalette,"alphas").map(function(t){return+t/100})},getEps:function(){return GCO5.core.GcArrayUtil.getColumnByKey(this.info_indic.colorPalette,"size")},getSizes:function(){return GCO5.core.GcArrayUtil.getColumnByKey(this.info_indic.colorPalette,"size")},getSymbs:function(){return this.info_indic.colorPalette&&"PL"==this.getTopology()?GCO5.core.GcArrayUtil.repeat("line",this.info_indic.colorPalette.length):GCO5.core.GcArrayUtil.getColumnByKey(this.info_indic.colorPalette,"symb")},getVars:function(){return this.getVIMods()},getVIMods:function(){var t=this.info_indic.classes;return t?Array.isArray(t)?t:t.split("|"):this.info_indic.vars||null},getPieVars:function(){return this.info_indic.vars},isPie:function(){var t=GCO5.model.indics.IndicModel;return this.nature==t.ADDITIVE&&(this.info_indic.isPie||1<this.getNbVars())},isModActive:function(t){return!this.info_indic.modsactive||this.info_indic.modsactive["c"+(t+1)]},getVILibs:function(){var t=this.info_indic.classeslib||this.info_indic.c_classeslib;return t?Array.isArray(t)?t:t.split("|"):null},getDiscretizeMethod:function(){return this.info_indic.discr_o.method},getPieSumVars:function(){var t=this.getDpValRef()[0].values,e=this.getDataSeries(),e=e?e.length:0;this.getVIMods();return 0==e?t[0]:t},getSerie:function(){return GCO5.core.GcStringUtil.nullIfEmpty(this.info_indic.serie)},getVarSerie:function(){return GCO5.core.GcStringUtil.nullIfEmpty(this.info_indic.varserie)},getFilter1:function(){var t=GCO5.core.GcStringUtil.nullIfEmpty(this.info_indic.filter1);return t=!t&&this.getF1Code()?GCO5.appModel.getInfo("datasetInfo",[this.getIdDataset(),"filter1"]):t},getF1Code:function(){return GCO5.core.GcStringUtil.nullIfEmpty(this.info_indic.f1code)},getFilter1Array:function(){var e=this.getDataFilter1(),t=GCO5.appModel.getInfo("filter1Data",[this.info_indic.filter1]);return t=e?t.filter(function(t){return 0<=e.indexOf(t.id)}):t},getFilter0:function(){var t=GCO5.core.GcStringUtil.nullIfEmpty(this.info_indic.filter0);return t=!t&&this.getF0Code()?GCO5.appModel.getInfo("DatasetFilter0",[this.getIdDataset()]):t},getF0Code:function(){return Array.isArray(this.info_indic.f0code)?this.info_indic.f0code.join("|"):"*"==this.info_indic.f0code?null:GCO5.core.GcStringUtil.nullIfEmpty(this.info_indic.f0code)},getF0Lib:function(){return GCO5.core.GcStringUtil.nullIfEmpty(this.info_indic.f0lib)},getStat:function(t){var e=this.info_indic.distrib_o;return e?e[t]:null},getHistoVals:function(){return this.info_indic.h},getNotNullIndices:function(r){if(r){var a,s,o,l,c,h=r.skipCodgeoPattern,t=r.opti,d=GCO5.appModel.getInfo("infoFromMapName",[this.getView()]),d=GCO5.appModel.getRefData(d.c_id_nivgeo,d.c_id_extent),h=h?GCO5.core.GcStringUtil.repeat(h,d.codgeo[0].length):null,u=this.getValues(),e=(u.length,this.getSortedIndices()),p=0,g=900*r.rx,i=e.reduce(function(t,e,i){var n=u[e];return GCO5.core.GcMathUtil.isInvalid(n)||h&&d.codgeo[e]==h||(l=0==i?(a=r.x[e],s=r.y[e],o=n,0):(i=Math.sqrt(Math.pow(a-r.x[e],2)+Math.pow(s-r.y[e],2)),n/o*Math.pow(1/(1+i/g),.25)),c=p+=l,t.push({id:e,x:r.x[e],y:r.y[e],v:n,score:l,cumul:c})),t},[]);if(!(0==i.length||i.length>e.length/2)){if(!t)return i;e=i.sort(function(t,e){return e.score-t.score}).filter(function(t){return t.cumul/p<.95}).map(function(t){return t.id}).sort(function(t,e){return t-e});return 0==e.length?i.map(function(t){return t.id}):e}}},getHistoLissVals:function(){return this.info_indic.liss},getAssocRIndics:function(t){return this.info_indic.rIndics_a},getIdExtent:function(){return this.info_indic.id_extent},getFiltViews:function(){return this.getViews()},setNivgeo:function(t){this.info_indic.nivgeo=t},setIdExtent:function(t){this.info_indic.id_extent=t},getNivgeo:function(){var t=this.info_indic,e=GCO5.initInfo.firstMapableNivgeo,i=(t.nivgeosg_a&&0<t.nivgeosg_a.length?t.nivgeosg_a:t.nivgeos_a)[0];return""!=e&&t.nivgeosg_a&&0<=t.nivgeosg_a.indexOf(e)&&(i=e),t.nivgeo||(t.nivgeo=t.nivgeosg_a&&0<t.nivgeosg_a.length||t.nivgeos_a&&0<t.nivgeos_a.length?i:null),t.nivgeo},getNivgeos:function(){return this.info_indic.nivgeos_a||this.info_indic.nivgeos},getViews:function(){return this.info_indic.c_id_views.concat()},getViewsFrameworks:function(){var t=this.info_indic.viewsFrameworks;return t?GCO5.core.GcObjectUtil.clone(t):null},getDatasetTJSExtended:function(t){if(this.info_indic.datasetTJSExtended)return this.info_indic.datasetTJSExtended;var e=this.getViewsFrameworks();return(e=e&&e[t])?this.info_indic.datasetTJSExtended=e.dataset:null},getFrameworkTJS:function(t){var e=this.getViewsFrameworks();return(e=e&&e[t])?e.framework:null},getDatasetTJS:function(){return this.info_indic.c_tjs_dataset},getTJSURL:function(){return this.info_indic.c_tjs_url},getView:function(){return this.info_indic.c_id_view},getGraphsCompatibleNivgeos:function(){return this.info_indic.nivgeosg_a},getHighIsGood:function(){return 0==this.info_indic.c_highisbad},getNivgeosLib:function(){return this.info_indic.libnivgeos},getSurNivgeo:function(){return this.info_indic.surNivgeo},setSurNivgeo:function(t){this.info_indic.surNivgeo=t},getSortedNivgeosLib:function(){return this.info_indic.nivgeoslib_a},getSortedNivgeosLibP:function(){return this.info_indic.nivgeoslibp_a},getThemesLib:function(){return this.info_indic.nivgeo},getSeries:function(){var t=this.info_indic.series;return t?t.concat().sort():null},getEftsFromAnimDp:function(t){return this.info_indic.animEfts},getDataSeriesFromAnimDp:function(t){var e=this.getAnimData();return e?GCO5.core.GcObjectUtil.keys(e).sort():this.getDataSeries({anim:!0})},getDataSeries:function(t){var e=this.info_indic.data_series;if(!e)return null;Array.isArray(e)||(e=e.split("|"));var i,n,r=GCO5.view.component.AThemeView.MAX_ANIM_PERIODS,a=e.length-r;return t&&t.anim&&e.length>r&&((t=t.serie0?e.indexOf(t.serie0):e.length-1)<=e.length-1-r&&(n=e.length-1-(i=t),a=i>=Math.ceil(r/2)&&n>=Math.ceil(r/2)?t-Math.ceil(r/2):i<Math.ceil(r/2)?0:e.length-1-r),e=e.slice(a,a+r)),e.concat()},getDataSeriesShortList:function(t,e){t=t||10;var i=this.getDataSeries();return e||i.reverse(),i.length<t?i.join(", "):i[0]+"..."+i[i.length-1]},getDataFilter1:function(){var t=this.info_indic.data_filter1;return t?GCO5.core.GcObjectUtil.cloneJson(t):null},getSerieRef:function(){return this.info_indic.serieref},getFSeries:function(){return this.info_indic.fseries},getUnit:function(){return this.info_indic.c_unite},getDivergingValue:function(){return this.info_indic.distrib_o.diverging_value},setUnit:function(t){this.info_indic.c_unite=t},setLibIndic:function(t){this.info_indic.libIndic=t},getNbDec:function(){var t,e,i;return this.indicModel.isTJS()&&(t=this.getFirstDistribInfo(),e=GCO5.core.GcMathUtil.countDecimals(t.maxth),i=GCO5.core.GcMathUtil.countDecimals(t.minth),1==Math.max(i,e)&&(2<Math.abs(t.minth)||2<Math.abs(t.maxth))&&(this.info_indic.c_nbdec=1)),this.info_indic.c_nbdec},getDisperseRadius:function(){return this.info_indic.c_disperse||0},setNbDec:function(t){this.info_indic.c_nbdec=t},valuesDisplayable:function(){return 2!=this.info_indic.c_diff_level},valuesExportable:function(){return GCO5.appModel.getInfo("IsFunctionAuthorized",["expdata"])&&(0==this.info_indic.c_diff_level||null==this.info_indic.c_diff_level)},getFilteredMods:function(){return GCO5.core.GcArrayUtil.getColumnByKey(this.info_indic.filteredMods,"id")},getIndices:function(){return this.info_indic.distrib_o.indices},getIdColorFamily:function(){var t,e,i=this.getFirstDistribInfo(),n=this.getDivergingValue();return isNaN(n)&&(n=0),i.minth<n&&!1===GCO5.appModel.isDivergingColfam(this.info_indic.c_id_colfam)&&(n=this.getFirstDiscretizationInfo(),t=GCO5.model.indics.Distrib.getClassesGroups(n.seuils,0,i.minth,i.maxth,n.seuilsinf),this.info_indic.c_id_colfam=GCO5.model.indics.MapIndicModel.getDefaultDivergingColFam(),e=new GCO5.model.indics.MapIndicModel(this.indicModel),this.info_indic.colorPalette=n.colorPalette=e._findColorPalette(this.info_indic.c_id_colfam,n.nclasses,i.diverging,t.nclassesneg,t.nclasseneutre,t.nclassespos)),this.info_indic.c_id_colfam},getIdColFam:function(){return this.info_indic.c_id_colfam},getTotValues:function(){return this.getValues("*")},getDefaultChoroCodes:function(){var t,e=this.getType();return t="C"!=e&&"I"!=e&&"Z"!=e?t:(this.info_indic.discr_o||this.info_indic.distrib_o).codes},getFillOpacity:function(){return parseFloat(null==this.info_indic.c_falpha?this.isPie()?100:70:this.info_indic.c_falpha)/100},getAnimData:function(){return this.info_indic.animData},clearAnimData:function(){this.info_indic.animData=null,this.info_indic.animEfts=null},setAnimData:function(t){var e=this.getType();"C"==e&&(this.info_indic.animData=t.content.discretization.codes),"I"==e&&(this.info_indic.animData=t.content.distribution.codes),"R"==e&&(this.info_indic.animData=t.content.distribution.values),"C"==e&&(this.info_indic.animEfts=t.content.discretization.efts)},getEftNivgeoCodes:function(){return this.info_indic.eftnivgeocode_a},getZonageInfoById:function(t){return{codgeo:this.info_indic.codgeo[i],libgeo:this.info_indic.libgeo[i],valeur:this.info_indic.eftcodgeo[i],id:t}},getSortedIndices:function(){return this.info_indic.distrib_o.sortIndices},getHexColForModIndex:function(t){return 0<=t?GCO5.core.GcMathUtil.binToHex(this.info_indic.col[t]):null},getHexVIColsMap:function(){var i={},t=this.getType();if("PT"==this.getTopology())(this.info_indic.colorPalette||(this.info_indic.discr_o?this.info_indic.discr_o.colorPalette:null)).forEach(function(t,e){i[0]="#f0f0f0",i[String(e+1)]=t.hasOwnProperty("col")?t.col:t});else if("PL"==this.getTopology())this.info_indic.colorPalette.forEach(function(t,e){i[0]="#f0f0f0",i[String(e+1)]=t.col});else if("I"==t||"Z"==t)this.info_indic.colorPalette.forEach(function(t,e){i[0]="#f0f0f0",i[String(e+1)]=t});else if(this.isPie())this.info_indic.colorPalette.forEach(function(t,e){i[0]="#f0f0f0",i[String(e+1)]=t});else{if(!this.info_indic.col)return null;this.info_indic.col.forEach(function(t,e){i[0]="#f0f0f0",i[String(e+1)]=GCO5.core.GcMathUtil.binToHex(t)})}return i},getHexColors:function(){var t,e=this.getType(),i=this.getTopology();return 0<=["PT","PL"].indexOf(i)&&"I"==e||"F"==e?t=GCO5.core.GcArrayUtil.getColumnByKey(this.info_indic.colorPalette,"col"):this.info_indic.colorPalette?(t=this.info_indic.colorPalette,"R"==e&&this.getFirstDistribInfo().minth<0&&1==t.length&&(this.info_indic.c_id_colfam=GCO5.model.indics.MapIndicModel.DEFAULT_COLFAM_SOLDE,t=GCO5.appModel.getInfo("hexColorsFromColFam",[this.info_indic.c_id_colfam,"R"])[0].c_coldef)):this.info_indic.discr_o&&(t=this.info_indic.discr_o.colorPalette),t=t||["#f00"]},getHTMLFromTheme:function(){return this.info_indic.htmllib_fromtheme},getHTMLFromTags:function(){return this.info_indic.htmltags},getStatData:function(){return 0<=["C","R"].indexOf(this.getType())?this.getValues("*"):null},getValues:function(t){var e,i,n=this.getType(),r=this.info_indic.distrib_o;return"C"==n?i=r.values:"R"==n?(e=r.values,i=this.isPie()?null==t||"*"==t?e.totvars:e[this.info_indic.vars[t]]:e):0<=["I","O","Z"].indexOf(n)?i=r.codes:"F"==n&&(i=this.info_indic.valeur),i},getKey:function(t){return this.info_indic[t]},_getHtmlTags:function(t){if(GCO5.core.GcStringUtil.isEmpty(t))return null;for(var e=t.split("|"),i=[],n=0;n<e.length;n++)i.push("<a data-pk='"+e[n]+"' href='javascript:void(0)'>"+e[n]+"</a>");return i.join(", ")},updateWithServerMetaData:function(t){var e,i=this.info_indic;for(e in t)["serie","f1code"].indexOf(e)<0&&(i[e]=t[e]);this.status=2,this._categorize()},getZonageChoroCodesFiltered:function(i){var n=[],t=this.info_indic,r=t.distrib_o.ref;return r.codgeo.forEach(function(t,e){n[e]=1==i[t]?r.typo4c[e]+1:0}),t.distrib_o.indices.map(function(t){return-9999===t?0:n[t]})},hasValidData:function(){return 0<this.info_indic.distrib_o.eftvalth},updateWithServerFullData:function(t){3==this.status&&this.getFilter1()&&this.getF1Code()!=t.content.options.axisFilters[this.getFilter1()]&&(this.invalid=1);var e,i=this.info_indic,n=this,r=this.getType(),a=("PG"!=this.getTopology()||GCO5.appModel.checkRefgeo(t.content.indic.c_id_view,t.content.options.ctrlCodesMD5)||"PG"!=this.getTopology()||console.warn("md5 refgeo incorrect",t.content.options.ctrlCodesMD5),t.content);for(e in a.indic)i[e]=a.indic[e];this.indicModel.isTJS()&&(a.dataset.c_source&&(i.c_tjs_mention=a.dataset.c_source),a.dataset.c_lib_dataset&&(i.c_lib_dataset=a.dataset.c_lib_dataset)),i.discr_o=a.discretization,i.distrib_o=a.distribution,(i.desc_indicateur||i.precisions)&&(i.desc_indicateur=GCO5.core.GcStringUtil.prettyHTML(i.desc_indicateur),i.precisions=GCO5.core.GcStringUtil.prettyHTML(i.precisions)),a.indic.c_id_view&&(t=GCO5.appModel.getInitKey("view_o")[a.indic.c_id_view],this.info_indic.nivgeo=t.id_nivgeo,this.info_indic.id_extent=t.id_extent),i.htmltags=this._getHtmlTags(i.tags);var o,l,s,c,h,d,u=this.getVarSerie(),p=this.getHasCI();if(this.isZonage()){var g=[],f=[],m=a.distribution.ref,_=[];m.codgeo.forEach(function(t,e){g[e]=m.typo4c[e]+1,f[e]=t,_[e]={codgeo:t,libgeo:m.libgeo[e],eft:m.eft[e]}}),a.distribution.codes=a.distribution.indices.map(function(t){return g[t]}),GCO5.appModel.registerRefData(this.getIdIndic(),this.getIdExtent(),{territories:m}),i.distrib_o.frequences=_.sort(function(t,e){return e.eft-t.eft})}else if("I"==r){i.mods_o={},i.modsl_o={};for(var v=this.getVIMods(),y=this.getVILibs(),b=0;b<v.length;b++){var C=v[b],x=y[b];i.mods_o[C]=x,i.modsl_o[C]=C.length<4&&C!=x&&x.length>C.length&&0!==x.indexOf(C)?C+" - "+x:x}this.isTypoPole()&&(i.distrib_o.nb_poles=i.distrib_o.nbPolesTypo)}else if("R"==r){if(1<i.nbVars){i.totvars=a.distribution.values.totvars;for(var w=0;w<i.nbVars;w++)i[i.vars[w]]=a.distribution.values[i.vars[w]]}}else"O"==r&&(i.distrib_o.nb_poles=i.distrib_o.frequences.length);a.options.axisAvailableMods&&(0<a.dataset.axis.length&&(0<(t=GCO5.core.GcArrayUtil.getSubArray(a.dataset.axis,{type:"T"})).length&&(this.info_indic.varserie=t[0].name,this.info_indic.series=t[0].mods),0<(t=GCO5.core.GcArrayUtil.getSubArray(a.dataset.axis,{type:"F"})).length&&(this.info_indic.filter1=t[0].name)),this.getFilter0()&&(this.info_indic.f0code=a.options.axisFilters[this.getFilter0()]),this.getFilter1()&&(this.info_indic.data_filter1=a.options.axisAvailableMods[this.getFilter1()],this.info_indic.f1code=a.options.axisFilters[this.getFilter1()]),this.getVarSerie()&&(this.info_indic.serie=a.options.axisFilters[this.getVarSerie()],this.info_indic.data_series=a.options.axisAvailableMods[this.getVarSerie()])),"I"!=r&&a.zonrefs&&0<a.zonrefs.length?(o=[],n.getFilter1()&&((l={})[n.getFilter1()]=n.getF1Code()),a.zonrefs.forEach(function(t){var a,s;t.values.forEach(function(t){void 0===t.v&&(t.v=t.hasOwnProperty("totvars")?t.totvars:t[n.getIdIndic()]),u&&(t.gc_serie=t[u]),p&&(t.v_lcl=t[n.getIdIndic()+"_lcl"],t.v_ucl=t[n.getIdIndic()+"_ucl"])}),n.getFilter1()&&(t.values=GCO5.core.GcArrayUtil.getSubArray(t.values,l)),n.isPie()&&u&&(a=n.getPieVars(),s=[],t.values.forEach(function(t){for(var e=0,i=0;i<a.length;i++){var n=a[i],r=(e+=t[n],{gc_serie:t[u],v:e});r[u]=t[u],r.code=n,r.v0=t[n],s.push(r)}})),n.info_indic.filter1&&(t.values=t.values.filter(function(t){return t[n.info_indic.filter1]==n.info_indic.f1code})),o.push({zonref:t.zonref.c_id_zonref,libref:t.zonref.c_lib_zonref[n.gclg.getLang()],pkgeoref:t.zonref.c_id_nivgeo+"|"+t.zonref.c_zonref_def,values:t.values,valuesExploded:s})}),this.info_indic.dpValref=o):"I"==r||"Z"==r||"O"==r?(t=i.distrib_o.frequences,s=i.distrib_o.evolFrequences,c=t.length,"O"!=r&&!this.isTypoPole()||(c=s?s[s.length-1].nbpoles:i.distrib_o.nb_poles),t&&0<t.length&&(t[0].hasOwnProperty(u)?(d=t[h=0][u],t.forEach(function(t,e){t[u]!=d&&(h=0,d=t[u]),t[u]&&(t.gc_serie=t[u],t.v=h+=t.eft,t.v0=t.eft)}),this.info_indic.dpValref=[{zonref:"99",libref:this.gclg.getString("ENS"),pkgeoref:"99",values:t,valuesExploded:t,nbpoles:c}]):this.info_indic.dpValref=[{zonref:"99",libref:this.gclg.getString("ENS"),pkgeoref:"99",values:t,nbpoles:c}]),("O"==r||this.isTypoPole())&&this.info_indic.dpValref&&(this.info_indic.dpValref[0].values2=i.distrib_o.evolFrequences)):"F"==r&&(this.info_indic.dpValref=[{zonref:"99",libref:this.gclg.getString("ENS"),pkgeoref:"99",values:i.distrib_o.poles}]),this.status=3},getDpValRef:function(){return this.info_indic.dpValref},getRefLib:function(){var t=this.getDpValRef(),e=GCO5.appModel.getInfo("infoFromMapName",[this.getView(),"c_id_zonref"]),e=GCO5.core.GcArrayUtil.indexOfByKey(t,"zonref",e);return e<0&&(e=0),t&&0!=t.length?t[e].libref:null},getValRef:function(e){var i,t=this.getDpValRef(),n=GCO5.appModel.getInfo("infoFromMapName",[this.getView(),"c_id_zonref"]),n=GCO5.core.GcArrayUtil.indexOfByKey(t,"zonref",n);if(n<0&&(n=0),this.isZonage())return t[n].nbpoles;if("O"==this.getType())return t?t[n].nbpoles:0;if(this.isTypoPole())return r=t[n].nbpoles,e=e||this.getSerie(),i=this.getVarSerie(),e&&i&&t[n].values2?t[n].values2.filter(function(t){return t[i]===e})[0].nbpoles:r;if(!t||0==t.length||"I"==this.getType()||"Z"==this.getType()||"F"==this.getType()||0==t[n].values.length)return null;var r=t[n].values;return(e=e||this.getSerie())?(t=GCO5.core.GcArrayUtil.indexOfByKey(r,"gc_serie",e))<0?null:r[t].v:r[0].hasOwnProperty("v")?r[0].v:r[0]},getRefMention:function(t,e,i,n){var r=this.getNivgeo(),r=GCO5.appModel.getInfo("libNivgeo",["PT"==this.getTopology()?this.getIdSymbLayer():r,!0,!0]),a=this.getVIMods(),s=this.info_indic.distrib_o.frequences,o=i?"<b class='big'>":"",l=i?"</b>":"";if("F"==this.getType())return null;if(this.isZonage())return this.gclg.getString("ENS")+this.gclg.getString("P2B")+" "+o+this.gclg.formatNumber(this.getValRef(),0,e)+l+" "+GCO5.appModel.getInfo("libNivgeo",[this.getIdIndicateur(),!0,!0]);if("I"==this.getType()&&!this.isTypoPole()){var c,h=this.getSerie();if(0==s.length)return null;if(0==(c=h?GCO5.core.GcArrayUtil.getSubArray(s,{gc_serie:h}):s.concat()).length)return null;if(0==(c=c.filter(function(t){return isNaN(t.code)||!GCO5.core.GcMathUtil.isInvalid(+t.code)})).length)return null;c.sort(function(t,e){return e.eft-t.eft});var d=c.reduce(function(t,e){return t+e.eft},0),u=i?"":this.gclg.getString("ENS")+this.gclg.getString(e?"P2B":"P2")+"&nbsp;";return u=(u+=GCO5.core.GcStringUtil.htmlEncode(this.info_indic.mods_o[c[0].code])+this.gclg.getString("P2B")+" ")+(o+this.gclg.formatNumber(c[0].eft)+" "+r),i&&("I"==this.getType()||"Z"==this.getType()||1<a.length)&&(u+=", "+this.gclg.formatNumber(100*c[0].eft/d,1)+"&nbsp;% "+this.gclg.getString("FROM_ENS")),u+=l,h&&(u+=" ("+this.gclg.getString("FOR")+" "+h+")"),u}if("O"==this.getType())return u=this.gclg.getString("ENS")+this.gclg.getString("P2B")+" "+o+this.gclg.formatNumber(this.getValRef(),0,e)+l+" pôles",i&&(u+=", "+this.gclg.getString("FIRST_POLE","indics")+this.gclg.getString("P2B")+" "+s[0].libgeo+", "+this.gclg.formatNumber(s[0].eft)+" "+r),u;u=n?"":this.getRefLib()+this.gclg.getString(e?"P2B":"P2")+" ",a=this.getValRef();return GCO5.core.GcMathUtil.isInvalid(a)?GCO5.core.GcStringUtil.isEmpty(this.getRefLib())?"":u+this.gclg.getString("NA","indics"):(u+=o+this.gclg.formatNumber(this.getValRef(),this.getNbDec(),!0),t&&this.getUnit()&&(u+=(e?" ":" ")+this.getUnit()),u+=l,h&&(u+=" ("+this.gclg.getString("FOR")+" "+h+")"),u)},isTypoPole:function(){return"I"===this.getType()&&"pole"===this.info_indic.c_id_colfam},getSelMention:function(t,e,i,n){var t=this.getValSelFormatted(t,e),r=i?"<b class='big'>":"",i=i?"</b>":"";return t?(n=$.trim(n||this.gclg.getString("SELECTION","concepts")),GCO5.core.GcObjectUtil.isEmpty(n)||(n+=this.gclg.getString(e?"P2B":"P2")+" "),n+r+t+i):null},getRefMention2:function(t){return this.getRefMention(t,!1,!0)},getSelMention2:function(t,e,i){if(!GCO5.core.GcObjectUtil.isEmpty(this.selectionInfo)&&!GCO5.core.GcMathUtil.isInvalid(this.selectionInfo.valSel))return this.getSelMention(t,e,!0,i)},getValSelFormatted:function(t,e,i){if(!GCO5.core.GcObjectUtil.isEmpty(this.selectionInfo)&&this.valuesDisplayable()){var n=this.getSerie(),r=GCO5.core.GcStringUtil.toHTmlWithBr,a=i?"<b class='big'>":"",i=i?"</b>":"",s=(GCO5.appModel.getInfo("libNivgeo",[this.getNivgeo()]),GCO5.appModel.getInfo("libNivgeo",["PT"==this.getTopology()?this.getIdSymbLayer():this.getNivgeo(),!0,!0])),o=this.selectionInfo.dts,l=this.selectionInfo.dtscumul;if("O"==this.getType()){if(0==o.length)return"N/A";var c=a+this.gclg.formatNumber(o[o.length-1].nbpoles)+i+" pôles";c+=", "+this.gclg.getString("FIRST_POLE","indics")+this.gclg.getString("P2B")+" "+l[0].libgeo+", "+this.gclg.formatNumber(l[0].eft)+" "+s}else if(this.isZonage()){if(o&&0==o.length)return a+this.gclg.formatNumber(this.selectionInfo.nbObjs)+i+" "+GCO5.appModel.getInfo("libNivgeo",[this.getIdIndicateur(),!0,!0]);if(!o||1==o.length&&1==o[0].eft)return this.selectionInfo.valSelFormatted;c=a+this.gclg.formatNumber(o.length)+i+" "+GCO5.appModel.getInfo("libNivgeo",[this.getIdIndicateur(),!0,!0])}else if("I"==this.getType()){if(0==o.length)return"N/A";h=o.concat().sort(function(t,e){return e.eft-t.eft}),n?(h=GCO5.core.GcArrayUtil.getSubArray(h,{gc_serie:n}),c=1==this.selectionInfo.nbObjs?0==h.length?"NA":this.info_indic.mods_o[h[0].code]:this.info_indic.mods_o[h[0].code]+this.gclg.getString("P2B")+" "+this.gclg.formatNumber(h[0].eft)+" "+s):1==this.selectionInfo.nbObjs&&(c=this.info_indic.mods_o[this.selectionInfo.valSel]),e||(c=r(c))}else{l=this.getKey("c_nbdec"),a="",i=e?" ":"&nbsp;";if(this.selectionInfo.valSel_lcl&&(a=(e?"\n":"<br>")+"("+this.gclg.getString("CI")+i+"= ["+this.gclg.formatNumber(this.selectionInfo.valSel_lcl,l,e)+i+";"+i+this.gclg.formatNumber(this.selectionInfo.valSel_ucl,l,e)+"])"),!n||"F"==this.getType()||this.isPie()&&!n)return GCO5.core.GcMathUtil.isInvalid(this.selectionInfo.valSel)?"N/A":this.indicModel.getFormattedValue(this.selectionInfo.valSel,t,e)+a;var h=GCO5.core.GcArrayUtil.getSubArray(o,{gc_serie:n});if(this.isPie())return 0<h.length?(s=h.reduce(function(t,e){return t+e.v0},0),this.indicModel.getFormattedValue(s,t,e)):null;c=0<h.length?this.indicModel.getFormattedValue(h[0].valSel,t,e)+a:null}return c}},setSelectionInfo:function(n,t,e){var a,i,s,r,o,l,c,h,d,u,p,g,f,m,_,v,y,b,C,x,w,S,M;this.selectionInfo={},n&&"delsel"!=n.from&&(t?this.selectionInfo=n:(this.getHasCI(),t=n.data[(s=this).getIdDataset()],r={},o=[],c=this.getSerie(),h=this.getVarSerie(),d=this.getIdIndic(),u=this.getFilter1(),S=GCO5.core.GcArrayUtil.getSubArray(n.indicateurs,{c_id_dataset:this.getIdDataset(),c_id_indicateur:this.getIdIndic()}),p=(S=1==S.length?S[0]:null)&&!GCO5.core.GcStringUtil.isEmpty(S.c_formule_lcl),n.territories.forEach(function(t){"SELGEO"==t.type&&(a=t.id),"REF"!=t.type||i||(i=t.id)}),t&&"F"!=this.getType()&&((S=n.data[this.getPk()])?(o="F"!=this.getType()&&Array.isArray(S)?GCO5.core.GcArrayUtil.getSubArray(S,{territory:a}):S[a],"O"==this.getType()?(v=o.frequences,o=o.evolFrequences):"F"==this.getType()?y=o.entrants[0].value:this.isZonage()?v=o:(u&&((m={})[s.getFilter1()]=s.getF1Code(),o=GCO5.core.GcArrayUtil.getSubArray(o,m)),c&&0<o.length?(f=o[g=0][h],o.forEach(function(t,e){t[h]!=f&&(g=0,f=t[h]),t[h]&&(t.gc_serie=t[h],t.v=g+=t.eft,t.v0=t.eft)}),v=o,this.isPie()&&(l={},o.forEach(function(t,e){t.gc_serie==c&&(l[n.ref_o[t.territory]]=t.v)}),y=l.valSel)):(l={},t.forEach(function(t,e){l[n.ref_o[t.territory]]=t[d]}),y=l.valSel,b=l.valRef1,this.isPie()&&t.forEach(function(t,e){t.territory==a&&(y=t[s.getIdIndic()+"_totvars"])}),C=this.indicModel.getFormattedValue(b)))):(u&&((m={})[s.getFilter1()]=s.getF1Code(),t=GCO5.core.GcArrayUtil.getSubArray(t,m)),h?(this.isPie()?(_=this.getPieVars(),v=[],t.forEach(function(t,e){var i=0;if(t.territory==a){t.v=t.valSel=t[s.getIdIndic()+"_totvars"],t.gc_serie=t[h],o.push(t),t[h]==c&&(y=t.v);for(e=0;e<_.length;e++){var n=_[e],r=(i+=+t[n],{gc_serie:t[h],v:i});r[h]=t[h],r.code=n,r.v0=t[n],v.push(r)}}})):t.forEach(function(t,e){var i=t[h];(l=r[i])||o.push(l=r[i]={gc_serie:i}),l[n.ref_o[t.territory]]=t[d],p&&(l[n.ref_o[t.territory]+"_lcl"]=t[s.getIdIndicateur()+"_lcl"],l[n.ref_o[t.territory]+"_ucl"]=t[s.getIdIndicateur()+"_ucl"])}),o.sort(function(t,e){return t.gc_serie>e.gc_serie?1:-1})):(l={},t.forEach(function(t,e){l[n.ref_o[t.territory]]=t[d],p&&(l[n.ref_o[t.territory]+"_lcl"]=t[s.getIdIndicateur()+"_lcl"]),p&&(l[n.ref_o[t.territory]+"_ucl"]=t[s.getIdIndicateur()+"_ucl"])})),(l=h?r[this.getSerie()]:l)&&(y=l.valSel,b=l.valRef1,C=this.indicModel.getFormattedValue(b),!p||GCO5.core.GcMathUtil.isInvalid(l.valSel_lcl)||GCO5.core.GcMathUtil.isInvalid(l.valSel_ucl)||(x=l.valSel_lcl,w=l.valSel_ucl)),v=v||o,M=0<(S=GCO5.core.GcArrayUtil.getSubArray(n.territories,{typeVal:"valRef1"})).length?S[0].title:null),this.selectionInfo={valSel:y,valRef:b,valRefFormatted:C,nbObjs:e,valRefLib:M,dts:o,dtscumul:v,valSel_lcl:x,valSel_ucl:w,txtTabVars:n.txtTabVars},this.selectionInfo.valSelFormatted=this.getValSelFormatted())))},getServerRequestVars:function(t){var e={},i=(e.indic=this.getIdIndic(),e.dataset=this.getIdDataset(),this.indicModel.getOption("tree")),i=(i&&GCO5.appModel.getConcept("tree_o")[i]&&"N"==GCO5.appModel.getConcept("tree_o")[i].c_type_tree&&(e.tree=i),e.view=t.id_view,this.indicModel.isTJS()&&(this.getDatasetTJSExtended(t.id_view),this.getTJSServer()&&(e.tjs=this.getTJSServer())),[]);return!this.getFilter1()||null==t.f1code&&null==this.getF1Code()||i.push(this.getFilter1()+"="+(t.f1code||this.getF1Code())),!this.getFilter0()||null==t.f0code&&null==this.getF0Code()||i.push(this.getFilter0()+"="+(t.f0code||this.getF0Code())),t.nbClasses&&(e.nbclasses=t.nbClasses),this.getVarSerie()&&("anim"==t.serie?(e.allseriesfilters=this.getVarSerie(),t.seuils?e.seuils=t.seuils.join(","):this.getSeuils()&&(e.seuils=this.getSeuils().join(",")),t.series&&i.push(this.getVarSerie()+"="+t.series)):(t.serie||this.getSerie())&&i.push(this.getVarSerie()+"="+(t.serie||this.getSerie()))),0<i.length&&(e.filters=i.join(",")),t.surNivgeo?e.surnivgeo=t.surNivgeo:t.sng_a&&(e.surnivgeo=t.sng_a[0].id_nivgeo),e},getDataICById:function(t){parseFloat(t),this.getType();var e=this.info_indic.distrib_o;if(!e.values_lcl||!e.values_ucl)return null;var i=e.values_lcl[t],e=e.values_ucl[t],t=this.getKey("c_nbdec");return GCO5.core.GcMathUtil.isInvalid(i)||GCO5.core.GcMathUtil.isInvalid(e)?null:this.gclg.formatNumber(i,t)+" ; "+this.gclg.formatNumber(e,t)},getDataICBoundById:function(t,e,i){parseFloat(t);e=this.info_indic.distrib_o["values_"+(e=e||"lcl")];if(!e)return null;e=e[t],t=this.getKey("c_nbdec");return GCO5.core.GcMathUtil.isInvalid(e)?null:i?this.gclg.formatNumber(e,t):e},getHasCI:function(){var t=this.info_indic.distrib_o;return!(!t||!t.values_ucl)},getCtrX:function(){var t=this.info_indic.distrib_o,e="O"==this.getType()?"x":"x2";return!(!t||!t[e])&&t[e]},getCtrY:function(){var t=this.info_indic.distrib_o,e="O"==this.getType()?"y":"y2";return!(!t||!t[e])&&t[e]},getDataById:function(t){var e,i,n,r=parseFloat(t),a=this.getType(),s=this.info_indic.distrib_o;if("I"==a||"Z"==a){if(this.isZonage())return n=GCO5.appModel.getRefData(this.getIdIndicateur(),this.getIdExtent()),-9999===(e=s.indices[t])?null:n.codgeo[e];e=0!=(e=s.codes[t])&&(i=this.getVIMods())?i[e-1]:null}else if("C"==a)e=s.values[t];else if("R"==a){var o,l=this.getKey("nbVars"),c=this.getKey("vars");if(0==l)return null;if(1==l)o=s.values[t];else{for(var h={},d=[],u=0;u<l;u++){var p=c[u],g=s.values[p][r];h[p]=g,d.push(g)}o=d}null!=o&&(e=o)}else"O"==a?e=(i=s.indices[t])<0?(e=s.libpole[t])||null:(n=GCO5.appModel.getRefData(this.getNivgeo(),this.getIdExtent())).codgeo[i]:"F"==a&&(e=null===t?null:this.info_indic.distrib_o[this.info_indic.c_id_indicateur][t]);return e},isEstimatedValue:function(t){var e,i=parseFloat(t),n=this.getType(),r=this.info_indic.distrib_o;if(!r.values_estimated)return!1;if("I"==n||"Z"==n||"O"==n)e=!1;else if("C"==n)e=Boolean(r.values_estimated[t]);else if("R"==n){var a=this.getKey("nbVars"),s=this.getKey("vars");if(0==a)return!1;if(1==a)e=Boolean(r.values_estimated[t]);else{for(var o=!1,l=0;l<a;l++){var c=s[l];if(Boolean(r.values_estimated[c][i])){o=!0;break}}e=o}}else e=!1;return e},hasEstimatedValues:function(){return void 0!==this.info_indic.distrib_o.values_estimated},getFormattedDataById:function(t,e,i){var n,r,a,s,o,l=this.getType();if(void 0!==i&&parseFloat(t),"C"==l)return null==(a=void 0!==i?i:this.getDataById(t))||-9999==a?this.gclg.getString("NAMQ","indics"):-99999==a?this.gclg.getString("NASS","indics"):-999999==a?this.gclg.getString("NAD0","indics"):-8888==a?this.gclg.getString("NAOLP","indics"):(n=this.gclg.formatNumber(a,this.getKey("c_nbdec"),!1,!1,!0),e||GCO5.core.GcStringUtil.isEmpty(this.getUnit())||(n+=" "+this.getUnit()),n);if("R"!=l)return"I"==l?null==(a=void 0!==i?i:this.getDataById(t))||-8888==a||-9999==a||-99999==a||-999999==a?this.gclg.getString("NAMQ","indics"):this.getKey("modsl_o")[a]:"O"==l?(a=void 0!==i?i:this.getDataById(t))?(r=this.getFirstDistribInfo().indices[t],o=GCO5.core.GcStringUtil.proper(this.gclg.getString("POLE","indics"))+this.gclg.getString("P2")+" ",r<0&&a?o+a:o+a+" - "+(s=GCO5.appModel.getRefData(this.getNivgeo(),this.getIdExtent())).libgeo[r]):this.gclg.getString("NAMQ","indics"):"F"==l?(a=void 0!==i?i:this.getDataById(t),this._getFluxRovData(t,a)):this.isZonage()?(s=GCO5.appModel.getRefData(this.getIdIndicateur(),this.getIdExtent()),-9999===(o=this.info_indic.distrib_o.indices[t])?this.gclg.getString("NAZON","indics"):s.codgeo[o]+" - "+s.libgeo[o]):n;if(a=void 0!==i?i:this.getDataById(t),Array.isArray(a)){for(var c=[],h=this.getKey("classeslib"),d=a.length,u=0;u<d;u++)0!=a[u]&&-9999!=a[u]&&c.push(" "+(h[u]||"v"+u)+this.gclg.getString("P2")+" "+(-9999==a[u]?this.gclg.getString("NAMQ","indics"):this.gclg.formatNumber(a[u],this.getKey("c_nbdec"),!1))+" ");0==c.length&&c.push(this.gclg.getString("NODATA")),n=c.join("<br>")}else{if(-9999==a||-999999==a)return this.gclg.getString("NAMQ","indics");if(-99999==a)return this.gclg.getString("NASS","indics");if(-8888==a)return this.gclg.getString("NAOLP","indics");n=this.gclg.formatNumber(a,this.getKey("c_nbdec"),!1,!1,!0),e||GCO5.core.GcStringUtil.isEmpty(this.getUnit())||(n+=" "+this.getUnit())}return n},_getFluxRovData:function(t,e){if(null===t)return null;var i=GCO5.appModel.getRefData(this.getIdgeo(),this.getIdExtent()),n=i.libgeo,i=i.codgeo,r=this.getStat("indices1"),a=this.getStat("indices2"),r=r[t],a=a[t],s=this.getFirstDistribInfo(),e=this.gclg.formatNumber(e,this.getKey("c_nbdec"),!1,!1,!0);return s.indices2[t]<0?n[r]+" => "+s.libpole2[t]+" = "+e:i[r]+" - "+n[r]+" => "+i[a]+" - "+n[a]+" = "+e},_getDataCell:function(t,e){return this.getKey(t)?this.getKey(t)[e]:null},destroy:function(){},setSerie:function(t,e){this.info_indic.serie!=t&&(this.status=2),e&&e.fromAnim&&(this.status=3),this.info_indic.serie=t},setF0Code:function(t,e){this.info_indic.f0code!=t&&(this.status=2),this.info_indic.f0code=t},setF0Lib:function(t){this.info_indic.f0lib=t},setTJSServer:function(t){this.info_indic.c_tjs_server=this.info_indic.TJSServer=t},getTJSServer:function(t){return this.info_indic.c_tjs_server},getTJSMention:function(t){return this.info_indic.c_tjs_mention},getTJSServerGeoclipURL:function(){if(!this.isTJS())return null;var t=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("tjs"),{c_id_tjs:this.info_indic.c_tjs_server});return!t||1!=t.length||t[0].c_tjs.indexOf("GC_tjs.php")<0?null:t[0].c_tjs.split("GC_tjs.php")[0]},isTJS:function(){return"tjs_"==this.getIdDataset().substr(0,4)},isExternalTJS:function(){return null!=this.getTJSServer()}}),GCO5.model.indics.GcIndicModelImported=GCO5.Class.extend({statics:{NAME:"GCO5.model.indics.GcIndicModelImported"},status:null,nbGeoDims:null,nature:null,info_indic:null,dataset:null,selectionInfo:null,gclg:null,initialize:function(t){if(!t.hasOwnProperty("idDataset")||!t.hasOwnProperty("pk"))throw"invalid GcIndicModel";this.status=1,this.gclg=GCO5.core.GcLangManager.getInstance(),this.info_indic=t,this.dataset=GCO5.model.indics.Dataset.getDataset(t.idDataset),t.hasOwnProperty("shortLibIndic")&&(this._categorize(),this.status=3)},getMapParams:function(){return this.info_indic.mapParams},cloneRawInfo:function(){return GCO5.core.GcObjectUtil.clone(this.info_indic)},_categorize:function(){var t=this.getType(),e=(this.nbGeoDims="F"==t||"O"==t?2:1,{I:(cl=GCO5.model.indics.IndicModel).CHARUNORD,C:cl.RATIO,O:cl.CHARUNORD,R:cl.ADDITIVE,P:cl.CHARUNORD,L:cl.CHARUNORD,CP:cl.CHARORD,F:cl.ADDITIVE});this.nature=e[t]},getTopology:function(){return this.info_indic.c_topo||"PG"},getDataICById:function(t){return null},hasValidData:function(){return!0},getSymbs:function(){return this.info_indic.symbs},getLimitUtil:function(){return null},getSelectionInfo:function(){return this.selectionInfo},setSelectionInfo:function(t,e){this.selectionInfo={}},isTypoPole:function(){return!1},getSelMention:function(t,e,i,n){return null},getFormulaLib:function(){return null},getFilter1Array:function(){return null},getIdThemes:function(){return this.getIdDataset()},getLibThemes:function(){return[{id_theme:this.info_indic.idDataset,lib_theme:this.dataset.libDataset}]},getNbGeoDims:function(){return this.nbGeoDims},getFormulaType:function(){return this.info_indic.frm_type},getIdReport:function(){return this.report},getHighIsGood:function(){return!0},getType:function(){return this.info_indic.typind},getFormula:function(){return this.info_indic.frm_type?this.info_indic.frm_type.type:null},getHasCI:function(){return!1},getFormulaStructure:function(){var t,e=this.info_indic.frm_type;return e&&((t={}).typFrm=e.type,t.var1=e.var1,t.var2=e.var2,t.multFrm=e.p1,t.constFrm=e.p2,e.var3&&(t.var3=e.var3),e.var4&&(t.var4=e.var4),e.p3&&(t.powerFrm=e.p3)),t},getNbVars:function(){return this.info_indic.nbvars||1},getNbClasses:function(){return this.info_indic.nbClasses},getHexColors:function(){var t,e=this.getType();if("P"==e)t=(t=this.info_indic.col).map(function(t){return"#"+t.substring(2)});else{if("C"==e&&this.info_indic.colf)return this.info_indic.colf;"I"==e&&this.info_indic.VIcols?t=this.info_indic.VIcols:("R"==e&&this.info_indic.hasOwnProperty("colf")||"O"==e)&&(t=this.info_indic.colf)}return t},getSizes:function(){return this.info_indic.sizes},getSeuils:function(){return this.info_indic.seuils},getSeuilsinf:function(){return this.info_indic.seuilsinf},isZonage:function(){return"_zon_"===this.getIdDataset()},getAbsoluteMaximum:function(){var t=this.getFirstDistribInfo();return t?Math.max(t.maxth,-t.minth):null},getLibgeoMin:function(){return this.info_indic.libgeominth},getLibgeoMax:function(){return this.info_indic.libgeomaxth},getSubNivgeos:function(t){var e=this.info_indic.surnivgeos0_a||this.info_indic.nivgeos,e=GCO5.core.GcArrayUtil.getColumnByKey(GCO5.appModel.getInfo("subNivgeos",[t,e]),"nivgeo");return 0==e.length?t:e.join("|")},getSurNivgeos:function(){return this.info_indic.surnivgeos_a},getSurNivgeosLib:function(){return this.info_indic.surnivgeoslib_a},getFirstDistribInfo:function(){return this.info_indic.distrib_o},getFirstDiscretizationInfo:function(){return this.info_indic.discr_o},getKValref:function(){return this.info_indic.discr_o&&this.info_indic.discr_o.hasOwnProperty("k_valref")?this.info_indic.discr_o.k_valref:-1},getCtrX:function(){return!1},getCtrY:function(){return!1},getPk:function(){var t=this.info_indic;return t.indic||(t.indic=t.idDataset+"."+t.idIndicateur),t.indic},getIdIndic:function(){return this.info_indic.pk},getIdIndicateur:function(){return this.info_indic.pk},getIdDataset:function(){return this.info_indic.idDataset},getDataset:function(){return this.dataset},getLibIndic:function(){return this.info_indic.libIndic},getShortLibIndic:function(){return this.info_indic.shortLibIndic},getSource:function(){return this.info_indic.source},getPrecisions:function(){return this.info_indic.precisions},getDescIndicateur:function(){var t=GCO5.appModel.getLegal("tx_reserve_import");return t=GCO5.core.GcStringUtil.isEmpty(t)?this.gclg.getString("IMPORT_USER_WARNING","print"):t},getURLIndicateur:function(){return null},getURLTextIndicateur:function(){return null},getURLLogo:function(){return null},getURLData:function(){return null},getURLTextData:function(){return null},getIdSymbLayer:function(){return this.info_indic.idSymbLayer},getIdgeo:function(){return this.getIdSymbLayer()||this.getNivgeo()},getPkgeo:function(){var t=this.getIdgeo(),e=this.getFiltNivgeo();return GCO5.core.GcStringUtil.isEmpty(e)||(t+="|"+e),t},getVIMods:function(){return this.getKey("VImods")},getVILibs:function(){return this.getKey("VIlibs")},isPie:function(){var t=GCO5.model.indics.IndicModel;return this.nature==t.ADDITIVE&&1<this.getNbVars()},isModActive:function(t){return!this.info_indic.modsactive||this.info_indic.modsactive["c"+(t+1)]},getDiscretizeMethod:function(){return this.info_indic.meth},getPieSumVars:function(){return this.info_indic.sumvars},getSerie:function(){return GCO5.core.GcStringUtil.nullIfEmpty(this.info_indic.serie)},getVarSerie:function(){return GCO5.core.GcStringUtil.nullIfEmpty(this.info_indic.varserie)},getFilter1:function(){return null},getF1Code:function(){return null},getFilter0:function(){return null},getF0Code:function(){return null},getF0Lib:function(){return null},getStat:function(t){var e=this.info_indic.distrib_o;return e?e[t]:null},getHistoVals:function(){return this.info_indic.h},getNotNullIndices:function(){return this.info_indic.notNullIndices},getHistoLissVals:function(){return this.info_indic.liss},getIdIndicAssoc:function(){return this.info_indic.indic_assoc},getAssocRIndics:function(t){return this.info_indic.rIndics_a},getIdExtent:function(){return this.info_indic.id_extent},getFiltViews:function(){return this.info_indic.filt_views?this.info_indic.filt_views.split("|"):[]},setNivgeo:function(t){this.info_indic.nivgeo=t},setIdExtent:function(t){this.info_indic.id_extent=t},getNivgeo:function(){return this.info_indic.nivgeo},getNivgeos:function(){return this.info_indic.nivgeos},getViews:function(){return this.info_indic.views},getViewsFrameworks:function(){return null},getView:function(){return this.info_indic.view},getDatasetTJS:function(){return null},getTJSURL:function(){return null},getGraphsCompatibleNivgeos:function(){return this.info_indic.nivgeosg_a},getNivgeosLib:function(){return this.info_indic.nivgeos.map(function(t){return GCO5.appModel.getInfo("libNivgeo",[t])}).join(", ")},getSurNivgeo:function(){return this.info_indic.surNivgeo},setSurNivgeo:function(t){this.info_indic.surNivgeo=t},getSortedNivgeosLib:function(){return this.info_indic.nivgeoslib_a},getSortedNivgeosLibP:function(){return this.info_indic.nivgeoslibp_a},getThemesLib:function(){return this.info_indic.nivgeo},getSeries:function(){var t=this.info_indic.series;return t&&t.concat()},getDataSeriesFromAnimDp:function(t){return this.getDataSeries({anim:!0})},getEftsFromAnimDp:function(t){return null},setSerie:function(t){this.dataset.setSerie(t),this.info_indic.serie=t,this.clearComputedData()},clearComputedData:function(){if(this.info_indic.sortedIndices=null,this.info_indic.totval_a=null,this.info_indic.val_a=null,this.info_indic.codes_a=null,this.info_indic.distrib_o={},this.isPie()){var t,e=this.info_indic.vars_a;for(t in e)this.info_indic[e[t]]=null}},getDataSeries:function(t){var e=this.info_indic.data_series;return(e=e&&t&&t.anim&&e.length>GCO5.view.component.AThemeView.MAX_ANIM_PERIODS?e.slice(e.length-GCO5.view.component.AThemeView.MAX_ANIM_PERIODS,e.length):e)&&e.concat()},getDataFilter1:function(){return this.info_indic.data_filter1},getSerieRef:function(){return this.info_indic.serieref},getFSeries:function(){return this.info_indic.fseries},getUnit:function(){return this.info_indic.unit},getDivergingValue:function(){return this.info_indic.diverging_val},setProp:function(t,e){var i="set"+GCO5.core.GcStringUtil.proper(t,!0);this[i]?this[i](e):this.info_indic.hasOwnProperty(t)?this.info_indic[t]=e:console.error("IndicModelImported setProperty error "+i+" inconnu")},setUnit:function(t){this.info_indic.unit=t},setNbDec:function(t){this.info_indic.nbdec=t},getSymbFillActive:function(){return 1},getSymbShape:function(){return"sp"},getDrawSymbsAsc:function(){return 1},getNbDec:function(){return this.info_indic.nbdec},getDisperseRadius:function(){return this.info_indic.disperse||0},valuesDisplayable:function(){return!0},valuesExportable:function(){return!0},getValRef:function(){return this.info_indic.valref},getValRefs:function(){return this.info_indic.valref_o},getDpValRef:function(){return this.info_indic.dpvalref0_a},getIdColorFamily:function(){return this.info_indic.idColFam},getTotValues:function(){return this.getValues("*")},getDefaultChoroCodes:function(){var t,e=this.getType();return"I"==e&&(t=this.getKey("codes_a")||this.getVICodes()),"C"==e?this.getKey("codes_a"):t},getIndices:function(){if(!this.info_indic.indices){var t,e=this.getIdIndicateur(),i=this.dataset.getData(),n=this.dataset.getRefgeoReverseIndex(),r=(n||i).length,a=new Int32Array(r),s=null!=n,o=this.info_indic.codgeos_o;0==GCO5.core.GcObjectUtil.count(o)&&(o=this.info_indic.codgeos_o=this.dataset.getCodgeosIndex());for(var l=0;l<r;l++)(t=s?n[l]:l)<0?a[l]=-1:(t=i[t][e],a[l]=o.hasOwnProperty(t)?o[t]:-1);this.info_indic.indices=a}return this.info_indic.indices},getSortedIndices:function(){if(!this.info_indic.sortedIndices){for(var t,e,i=this.getIdIndicateur(),n=this.dataset.getData(),r=this.dataset.getRefgeoReverseIndex(),a=(r||n).length,s=[],o=null!=r,l=this.isPie(),c=(l?e=this.getTotValues():this.getValues(),!!this.info_indic.val_a),h=0;h<a;h++)(t=o?r[h]:h)<0?s[h]={id:h,v:0}:(t=l?e[h]:c?this.info_indic.val_a[h]:n[t][i],s[h]={id:h,v:-9999==t||-99999==t?0:Math.abs(t)});s.sort(function(t,e){return e.v-t.v}),this.info_indic.sortedIndices=GCO5.core.GcArrayUtil.getColumnByKey(s,"id")}return this.info_indic.sortedIndices},getVICodes:function(){for(var t,e=this.getIdIndicateur(),i=this.dataset.getData(),n=this.dataset.getRefgeoReverseIndex(),r=(n||i).length,a=[],s=null!=n,o={},l=0,c=this.getKey("VImods"),h=0;h<c.length;h++)o[c[h]]=h+1;for(h=0;h<r;h++)(t=s?n[h]:h)<0?(a[h]=0,l++):null==(t=i[t][e])||""==t||"-9999"==t?(l++,a[h]=0):a[h]=o[t];return this.info_indic.distrib_o.eftallnath=l,this.info_indic.distrib_o.eftvalth=r-l,this.info_indic.codes_a=a},getFillOpacity:function(){return null==this.info_indic.falpha?.7:parseFloat(this.info_indic.falpha)/100},getAnimData:function(){return this.info_indic.animData},setAnimData:function(t){this.info_indic.animData=t},clearAnimData:function(){this.info_indic.animData=null},getEftNivgeoCodes:function(){return this.info_indic.eftnivgeocode_a},getHexColForModIndex:function(t){return 0<=t?GCO5.core.GcMathUtil.binToHex(this.info_indic.col[t]):null},getZonRef:function(){return this.info_indic.valref},getRefLib:function(){return this.info_indic.reflib||this.info_indic.valreflib},getRefMention:function(t,e){if(!this.getValRef())return null;var i=this.getRefLib()+this.gclg.getString("P2B")+" "+this.gclg.formatNumber(this.getValRef(),this.getNbDec(),!0);return t&&this.getUnit()&&(i+=" "+this.getUnit()),i},getValSelFormatted:function(t,e,i){return null},getHTMLFromTheme:function(){return this.info_indic.htmllib_fromtheme},getHTMLFromTags:function(){return this.info_indic.htmltags},getStatData:function(){return 0<=["C","R"].indexOf(this.getType())?this.getValues("*"):null},getVars:function(){return this.info_indic.vars_a||this.getKey("VImods")},getColData:function(t,e){for(var i,n=this.dataset.getData(),r=this.dataset.getRefgeoReverseIndex(e||this.getSerie()),a=(r||n).length,s=[],o=null!=r,l=0;l<a;l++)(i=o?r[l]:l)<0?s[l]=-9999:(i=n[i],s[l]=i[t]);return{var1:s}},getValues:function(t,e){var i=this.getIdIndicateur(),n=this.dataset.getData(),r=this.dataset.getRefgeoReverseIndex(e||this.getSerie()),a=(r||n).length,s=[],o=null!=r;if(this.info_indic.distrib_o||(this.info_indic.distrib_o={}),r){var l=this.info_indic.distrib_o,c=l.hasOwnProperty("minth"),h=(c||(l.nv_neg=0,l.minth=Number.POSITIVE_INFINITY,l.maxth=Number.NEGATIVE_INFINITY),0),d=this.getFormulaStructure();if("PT"==this.getTopology()&&!d&&!this.isPie()){if("I"==this.getType()){var u=this.getVIMods(),p={},g=[];for(y in u)p[u[y]]=+y+1;for(var f=0;f<a;f++){var m=o?r[f]:f,_=s[f]=n[m][i];GCO5.core.GcStringUtil.isEmpty(_)?(h++,g[f]=0):g[f]=p[_]}l.codes=g}else for(f=0;f<a;f++)m=o?r[f]:f,s[f]=n[m][i],l.minth>s[f]&&(l.minth=s[f]),l.maxth<s[f]&&(l.maxth=s[f]);return c||(l.eftallnath=h,l.eftvalth=a-h),this.info_indic.val_a=s,"I"==this.getType()?g:s}if("*"==t){if(!this.info_indic.totval_a){for(var v=this.info_indic.vars_a,f=0;f<a;f++)if((m=o?r[f]:f)<0&&h++,m<0)s[f]=-9999;else{for(var y in s[f]=0,v){var b=n[m][v[y]];if(-9999==b){s[f]=-9999;break}s[f]+=b}c||(l.minth>s[f]&&(l.minth=s[f]),l.maxth<s[f]&&(l.maxth=s[f]),s[f]<0&&l.nv_neg++)}this.info_indic.totval_a=s}return this.info_indic.totval_a}if(this.isPie()){for(f=0;f<a;f++)(m=o?r[f]:f)<0?(s[f]=-9999,c||h++):s[f]=n[m][t];return this.info_indic[t]=s}if(!this.info_indic.val_a||e){if(d){if("p1*var1/var2+p2"==d.typFrm)for(f=0;f<a;f++)(m=o?r[f]:f)<0?(s[f]=-9999,c||h++):0==(C=n[m])[d.var2]?s[f]=-999999:s[f]=d.multFrm*C[d.var1]/C[d.var2]+d.constFrm;if("p1*(var1-var2)/var3"==d.typFrm){for(f=0;f<a;f++)(m=o?r[f]:f)<0?(s[f]=-9999,c||h++):0==(C=n[m])[d.var3]?s[f]=-999999:(s[f]=d.multFrm*(C[d.var1]-C[d.var2])/C[d.var3]+d.constFrm,c||(l.minth>s[f]&&(l.minth=s[f]),s[f]<0&&l.nv_neg++));c||(l.nv_neg=l.minth<0?1:0,l.nv_pos=a-h-l.nv_neg,this.info_indic.distrib_o=l)}if("p1*var1+p2"==d.typFrm)for(f=0;f<a;f++)(m=o?r[f]:f)<0?(s[f]=-9999,c||h++):(C=n[m],s[f]=d.multFrm*C[d.var1]+d.constFrm);if("var1-var2"==d.typFrm){for(f=0;f<a;f++)(m=o?r[f]:f)<0?(s[f]=-9999,c||h++):(C=n[m],s[f]=C[d.var1]-C[d.var2],c||(l.minth>s[f]&&(l.minth=s[f]),l.maxth<s[f]&&(l.maxth=s[f]),s[f]<0&&l.nv_neg++));c||(l.nv_pos=a-h-l.nv_neg,this.info_indic.distrib_o=l)}if("var1+var2"==d.typFrm){for(var C,f=0;f<a;f++)(m=o?r[f]:f)<0?(s[f]=-9999,c||h++):(C=n[m],s[f]=C[d.var1]+C[d.var2],c||(l.minth>s[f]&&(l.minth=s[f]),l.maxth<s[f]&&(l.maxth=s[f]),s[f]<0&&l.nv_neg++));c||(l.nv_neg=l.minth<0?1:0,this.info_indic.distrib_o=l)}}else for(f=0;f<a;f++)m=o?r[f]:f,!c&&m<0&&h++,s[f]=m<0?-9999:n[m][i];this.info_indic.val_a=s}return c||(l.eftallnath=h,l.eftvalth=a-h),this.info_indic.val_a}},getKey:function(t){var e=this.info_indic[t];return!e&&this.isPie()&&0<=this.info_indic.vars_a.indexOf(t)?this.getValues(t):e},_getHtmlTags:function(t){if(GCO5.core.GcStringUtil.isEmpty(t))return null;for(var e=t.split("|"),i=[],n=0;n<e.length;n++)i.push("<a data-pk='"+e[n]+"' href='javascript:void(0)'>"+e[n]+"</a>");return i.join(", ")},getDataById:function(t){if(this.isPie()){var e,i,n=this.info_indic.vars_a,r=this.dataset.getData(),a=this.dataset.getRefgeoReverseIndex(),s=null!=a;if(!s)return;if((i=s?a[t]:t)<0)for(var o in e=[],n)e.push(-9999);else for(var o in e=[],n)e.push(r[i][n[o]]);return e}s=this.info_indic.codes_a,a=this.info_indic.VImods;return this.info_indic.val_a||this.getValues(),this.info_indic.val_a?this.info_indic.val_a[t]:this.info_indic.codes_a?0==s[t]?-9999:a[s[t]-1]:null},isEstimatedValue:function(t){return!1},hasEstimatedValues:function(){return!1},getDataSource:function(){return this.info_indic.dataSource},getFormattedDataById:function(t,e,i,n){var r,a=n,n=this.getType(),s=(parseFloat(t),this.gclg);if("I"==n||"P"==n){if(null==(o=this.getDataById(t))||-8888==o||-9999==o||-99999==o||-999999==o)return s.getString("VALMQ","indics");r=this.getKey("mods_o")[o]}else if("C"==n){if(null==(o=this.getDataById(t))||-9999==o)return s.getString("NAMQ","indics");if(-99999==o)return s.getString("NASS","indics");if(-999999==o)return s.getString("NAD0","indics");if(-8888==o)return s.getString("NAOLP","indics");r=s.formatNumber(o,this.getNbDec(),!1),this.getKey.ci&&(r+=" ( CI"+s.getString("P2")+" "+this._getDataCell("lcl",t)+" - "+this._getDataCell("ucl",t)+" )"),e||GCO5.core.GcStringUtil.isEmpty(this.getUnit())||(r+=" "+this.getUnit())}else if("R"==n){var o=this.getDataById(t),l=[],c=this.getKey("VIlibs");if(Array.isArray(o)){for(var h=o.length,d=0;d<h;d++)l.push(" "+(c[d]||"v"+d)+s.getString("P2")+" "+this.formatRnullValues(s,o[d],e,a)+" ");r=l.join("<br>")}else r=this.formatRnullValues(s,o,e)}else if("O"==n)return GCO5.core.GcStringUtil.proper(s.getString("POLE"))+s.getString("P2")+" "+this.getDataById(t);return r},formatRnullValues:function(t,e,i,n){return e<=0||0<e?-9999==e||-999999==e?n?t.getString("NA","indics"):t.getString("NAMQ","indics"):-99999==e?n?t.getString("NA","indics"):t.getString("NASS","indics"):-8888==e?n?t.getString("NA","indics"):t.getString("NAOLP","indics"):(s=t.formatNumber(e,this.getKey("nbdec"),!1),i||GCO5.core.GcStringUtil.isEmpty(this.getKey("unit"))||(s+=" "+this.getKey("unit")),s):null},_getDataCell:function(t,e){return this.getKey(t)?this.getKey(t)[e]:null},getTJSMention:function(){return null},isTJS:function(){return!1},isExternalTJS:function(){return!1},destroy:function(){}}),GCO5.model.indics.Distrib=GCO5.Class.extend({statics:{NAME:"GCO5.model.indics.Distrib",JENKS:"jenks",QUANT:"quant",KMEANS:"kmeans",STD:"std",STDLOG:"stdlog",NESTED:"nested",MANU:"manu",SAMPLING_LIMIT:1e3,getClassesGroups:function(t,e,i,n,r){for(var a,s,o=0,l=0,c=0,h=0;h<t.length;h++)0<h&&r[h]==e&&t[h-1]==e&&0==e?l++:0<h&&r[h]>e&&t[h-1]<e?(s=r[h]-t[h-1],a=(e-t[h-1])/s,s=(r[h]-e)/s,.2<a&&.2<s?l++:a<.2?o++:c++):r[h]<=e&&i<e&&(r[h]!=e||r[h]!=t[h-1])&&c++,(r[h]>e||r[h]==e&&i==e||r[h]==e&&r[h]==t[h-1])&&o++,t[h]==i&&(t[h]+=1e-5),t[h]==n&&(t[h]-=1e-5);return e<n&&0==l&&o++,n<e&&0==l&&c++,{nclassesneg:c,nclasseneutre:l,nclassespos:o,seuils:t}}},precision:null,values:null,va_dp:null,na_dp:null,curSortField:null,valref:null,valsorted:null,analyse_o:null,discr_o:null,refgeo_o:null,var1_a:null,var2_a:null,var3_a:null,curColInd:null,divergingValue:null,lastSortVariable:null,initialize:function(t,e,i){if(this.precision=(e=e||{}).hasOwnProperty("precision")?e.precision:1,this.valref=e.valref?+e.valref:null,this.divergingValue=e.divergingValue||0,this.valsorted=e.presorted||!1,this.curSortField=this.valsorted?"val":null,this.analyse_o={},this.discr_o={},this.curColInd="v",i&&(this.analyse_o[i.ind]=i),t&&0<t.length&&(null==t[0]||"object"!=typeof t[0])&&!this.valsorted){this.values=[];for(var n=t.length,r=0;r<n;r++)this.values.push({id:r,v:t[r]})}else this.values=t},hasColData:function(t){return null!=this[t+"_a"]},setColData:function(t){this.var1_a=t.var1,this.var2_a=t.var2,t.var3&&(this.var3_a=t.var3)},registerTopology:function(t){this.refgeo_o=t},discretize:function(t){var e=this.constructor,i=t.ind,n=(t.meth||(t.meth=e.QUANT),""),r=(this._subsetOnSelection=!1,t.calcBreaksOnSel&&(n="__sel__",this.vasel_dp||this._computeOnSelection(t.selIds),this._subsetOnSelection=!0),"liss"==t.treatment?(this.liss(1,t.frm_o),i="vliss"+t.lissIntensity):"dem"==t.treatment&&(this.dem(t.frm_o),i="dem"),i=i||"v",this.discr_o[i+n]),r=(this.va_dp&&this.curColInd!=i&&(this.va_dp.sort(function(t,e){return t[i]-e[i]}),this.lastSortVariable=i),this.curColInd=i+n,!this._subsetOnSelection&&r&&r.nclasses==t.nbClasses&&r.meth==t.meth&&r.codes,this.analyse_o[i+n]||this.getStatisticalAnalysis(i));return t.meth==e.QUANT?this._quantilizeWithConstraints(r,t.nbClasses,t.includeValref):t.meth==e.STD?this._gen_seuils_std(r,t.nbClasses,t.includeValref):t.meth==e.NESTED?this._gen_seuils_emboit(r,t.nbClasses,t.includeValref):t.meth==e.JENKS?this._gen_seuils_jenks(r,t.nbClasses):t.meth==e.KMEANS?this._gen_seuils_kmeans(r,t.nbClasses):t.meth==e.MANU?this._gen_seuils_manu(r,t.seuils):void console.warn(t.meth)},getStatisticalAnalysis:function(i){var t=this.values,e=[],n=t.length,r=0,a=0,s=0,o=0,l=0,c=0,h=0,d=0,u=0,p=0,g=Number.NEGATIVE_INFINITY,f=-1,m=-1,_=0,v=Math.pow(10,this.precision),R=null!=this.valref&&GCO5.core.GcMathUtil.isNumber(this.valref),y=Math.round(v*this.valref)/v,b=Math.round(v*this.divergingValue)/v,k=(i=i||"v",this.valsorted||"v"!=i||(t.sort(function(t,e){return t[i]-e[i]}),this.valsorted=!0),n<5e3);if(-9999===(M=Math.round(v*t[n-1][i])/v)||-8888==M||-99999==M||-999999==M||""===$.trim(M))return[];var C,x,w,F=!1,V=("dem"==i&&(b=y=0),0==i.indexOf("vliss"));if(this.va_dp){this._subsetOnSelection?(n=(e=this.vasel_dp).length,e.sort(function(t,e){return t[i]-e[i]})):(e=this.va_dp,this.lastSortVariable!=i&&(e.sort(function(t,e){return t[i]-e[i]}),this.lastSortVariable=i));var U=n=e.length,S=e[0][i];if(V&&-999999===S){for(G=0;-999999==e[G][i]&&G<U-1;)G++;S=e[G][i]}for(var M=Math.round(v*e[n-1][i])/v,O=S<=b&&b<=M,G=0;G<U;G++){r=(L=e[G]).id;V&&-999999==L[i]?d++:(p+=T=Math.round(v*L[i])/v,g===Number.NEGATIVE_INFINITY?(g=T,a++):g===T&&a++,k&&T!==w&&_++,O&&b<=T&&(f<0&&(f=G,0),T===b?o++:O=!1),T<0?l++:0<T&&c++,R&&m<0&&y<=T&&(m=G),w=T)}}else{this.na_dp=[];var I=0,B=-8888<t[0][i]&&null!==t[0][i];for(L=t[I];-9999==L[i]||-8888==L[i]||null===L[i];)u++,L.c=0,L.tv=0,L.tlogv=0,this.na_dp.push(L),L=t[++I];for(0<u&&(B=!0),O=t[I][i]<=b&&b<=t[n-1][i],x=I;x<n;x++){var T=(L=t[x])[i];if(F)T=Math.round(v*T)/v;else{if(B?(C=0,T=Math.round(v*T)/v,g===Number.NEGATIVE_INFINITY&&(g=T)):0===I?-9999==T||-8888==T||null===T?(u++,C=1):-99999==T?(h++,C=1):-999999==T?(d++,C=1):(C=0,p+=T=Math.round(v*T)/v,g===Number.NEGATIVE_INFINITY&&(g=T)):(C=0,p+=T=Math.round(v*T)/v,g===Number.NEGATIVE_INFINITY&&(g=T)),1===C){L.c=0,L.tv=0,L.tlogv=0,this.na_dp.push(L);continue}g!==Number.NEGATIVE_INFINITY&&(g===T?a++:-8888<T&&(F=!(C=0)))}1!==C&&(p+=T),k&&T!=w&&_++,O&&b<=T&&(f<0&&(f=r,0),T===b?o++:O=!1),(L[i]=T)<0?l++:0<T&&c++,R&&m<0&&y<=T&&(m=r),w=T,e.push(L),r++}if(M!=g)for(x=n-1,T=M;T===M;)T=Math.round(v*t[--x][i])/v,s++;this.va_dp=e}var A,S=u+h+d,z=p/(A=n-S),j=Math.round(5e-4*A),H=Math.round(.005*A),P=Math.floor(.5*(A-1))+1,D=Math.max(1,Math.min(a+j,A-1)),j=Math.min(A-1,Math.max(0,A-s-j)),W=Math.min(a+H,A-1),H=Math.min(Math.max(0,A-s-H),A-1),P=Math.min(P,A-1),E={},N=0;if("v"==i){for(r=0;r<A;r++)N+=Math.pow(e[r].v-z,2);E.stdevth=Math.sqrt(N/A)}else{for(r=0;r<A;r++){var L=e[r];N+=Math.pow(L[i]-z,2)}E.stdevth=Math.sqrt(N/A)}E.stdevth=Math.round(v*E.stdevth)/v,E.nv_min=a,E.nv_max=s,E.nv_neg=l,E.nv_pos=c,E.nv_diverging=o,E.i_diverging=f,E.i_mediane=P,E.i_valref=m,E.decile1=e[D][i],E.decile2=e[j][i],E.decile01=e[W][i],E.decile99=e[H][i],E.mediane=0<e.length&&0<=P?A%2==0?(e[P][i]+e[P-1][i])/2:e[P][i]:null,E.nb_distinct_values=_,E.minth=g,E.maxth=M,E.avgth=z,E.sumth=p,E.eftvalth=A,E.eftth=n,E.eftnath=u,E.eftallnath=S,E.eftssth=h,E.eftdiv0th=d,E.ind=i,E.distribInfoComplete=!0,E.diverging=0<f,E.diverging_value=b;D="";return this._subsetOnSelection&&(D="__sel__"),this.analyse_o[i+D]=E},_quantilizeWithConstraints:function(t,e,i){for(var n=t,R=this.constructor,r=this.va_dp,a=(this._subsetOnSelection&&(r=this.vasel_dp),n.eftvalth),s=n.nv_min,o=n.nv_max,l=n.nv_diverging,c=n.i_diverging,h=n.i_valref,d=t.ind,u=i,p=n.diverging_value,k=GCO5.core.GcMathUtil.isNumber(p)&&n.minth<p,F=(50==p&&(u=i=!1),this.valref),V=GCO5.core.GcMathUtil.isNumber(F),g=0,f=a,m=e,_=[],v=[],y=[],b=[],C=-1,x=[],w=0;w<20;w++)x[w]=0;0<t.nb_distinct_values&&t.nb_distinct_values<e?e=t.nb_distinct_values:0<a&&a<e&&(e=a);var S=a/e,M=!1,O=!1;if(e==t.nb_distinct_values){for(var U,G=x[0]=1,$=r.length-o+1,I=s;I<$;I++)U==r[I][d]?(x[G]++,r[I-1].c=G):(_.push(r[I][d]),y.push(I-1),v.push(r[I-1][d]),x[G]++,U=r[I][d],r[I-1].c=G++,V&&0==C&&F<=U&&(C=G-1));for(r[$-1].c=e,x[G]++,e=_.length+1,(_[N=0]<0||r[0][d]<0)&&N++,I=0;I<_.length;I++)_[I]<=0&&N++;E=e-N}else{(5<s&&.7*S<=s||S<s&&100<n.eftvalth)&&(f-=g=s,m--,M=!0),(5<o&&.7*S<=o||S<o&&100<n.eftvalth)&&(f-=o,m--,O=!0);var T,A,B,z,P,D,S=f/m,E=m,N=0,L=(k&&(T=!1,0<c&&n.maxth>p?(.7*S<=l&&"dem"!=d&&(T=!0,m--,E--),0==(A=Math.round((c-g)/S))?g<c&&(A++,E=m-(N=1)):A==m?c<g+f&&(A--,N=m-1,E=1):(B=(c-g)/(N=A),z=(f-c+g)/(E=m-A),1==N&&3<=E&&1.2*S<B&&(N=A=2,E--),1==E&&3<=N&&1.2*S<z&&(N=A=N-1,E++))):n.maxth<=p&&(N=m,E=0)),2<=N&&(L=this._quantilize(r.slice(g,c),N,d,u,h-g,c,h)),2<=E&&(f=r.length-(t=k&&0<c?T?c+l:c:M?s:0),O&&(f-=o),P=this._quantilize(r.slice(t,t+f),E,d,u,h-t,c,h)),M&&(D=Math.min(s,r.length-1),_.push(r[D][d]),y.push(D),b.push(D-1),v.push(r[D-1][d])),L?(_=_.concat(L.seuils),y=y.concat(L.i_seuils),b=b.concat(L.i_seuils_inf),v=v.concat(L.seuils_inf),0<c&&(_.push(p),y.push(c),b.push(c-1),v.push(r[c-1][d])),0<=L.k_valref&&(C=L.k_valref),M&&N++):0<A&&(_.push(p),y.push(c),b.push(c-1),v.push(r[c-1][d])),T&&(_.push(r[c+l][d]),y.push(c+l),b.push(c-1),v.push(p)),P&&(_=_.concat(P.seuils),y=y.concat(P.i_seuils),b=b.concat(P.i_seuils_inf),v=v.concat(P.seuils_inf),0<=P.k_valref&&(C=P.k_valref+N)),O&&(D=Math.min(o,r.length-1),_.push(r[a-D][d]),y.push(a-D),b.push(a-D-1),v.push(r[a-D-1][d]),E++),""),I=(this._subsetOnSelection&&(r=this.va_dp,L="__sel__"),a=r.length,0),j=r[0][d];for(x[0]=n.eftallnath,w=0;w<a;w++)r[w][d]>=j&&(j=I<_.length?_[I]:Number.POSITIVE_INFINITY,I++),x[r[w].c=I]++}m=e-E-N,V&&0<=C&&(!k||c<h)&&(C+=m),n.k_valref=C,g=this._getDiscretisationCodes();return this.discr_o[d+L]={seuils:_,seuilsinf:v,indices:y,indicesinf:b,nclasses:e,meth:R.QUANT,codes:g,efts:x,ind:d,nclasses_quant_inf:N,nclasses_quant_sup:E,nclasseneutre:m,hasplage_min:M,hasplage_max:O,k_valref:C,includeValref:i,pasInf:B,pasSup:z,pas:S}},_computeOnSelection:function(t){this.analyse_o.v||this.getStatisticalAnalysis();var e=(new Date).getTime(),i=this.va_dp.length,n=(this.vasel_dp=[],0);this.va_dp.sort(function(t,e){return t.id-e.id});for(var r=0;r<i;r++){var a=this.va_dp[r];a.id==t[n]&&(this.vasel_dp.push(a),n++)}var s=this.curColInd;this.va_dp.sort(function(t,e){return t[s]-e[s]}),this.lastSortVariable=s,this.vasel_dp.sort(function(t,e){return t[s]-e[s]}),(new Date).getTime()},dem:function(t){this.analyse_o.v||this.getStatisticalAnalysis();(new Date).getTime();for(var e=null!=this.var3_a,i=(t.typFrm,this.va_dp.length),n=this.valref/t.multFrm,r=this.refgeo_o.areas,t=this.refgeo_o.precision,t=this.refgeo_o.lyEchelle*t,a=Math.pow(t,2),s=0;s<i;s++){var o,l=this.va_dp[s],c=l.id,h=this.var1_a[c],d=this.var2_a[c],u=Math.abs(a*r[c]/1e6),c=(e&&(o=this.var3_a[c]),e?h-d:h),c=e?(c-n*o)/u:(c-n*d)/u;l.dem=c}(new Date).getTime()},getRepartDp:function(){this.analyse_o.v||this.getStatisticalAnalysis();var t=this.va_dp.concat();return"v"!=this.curColInd&&t.sort(function(t,e){return t.v-e.v}),t.forEach(function(t,e){t.rowId=e}),t},liss:function(t,e){this.analyse_o.v||this.getStatisticalAnalysis();for(var i,n=(new Date).getTime(),r=1,a=null!=this.var3_a,s=("var1-var2"==e.typFrm?r=2:"p1*(pow(var1/var2,p3)-1)"==e.typFrm?r=3:"p1*(var1/var2)/(var3/var4)+p2"==e.typFrm?r=4:"p1*(var1-var2)/var3"==e.typFrm?r=5:"var1+var2"==e.typFrm&&(r=6),this.va_dp.length),o=this.values.length,l=this.refgeo_o.lyEchelle,c=Math.pow(l,2),l=this.refgeo_o.lyAvgRadius,h=l*l,d=new Uint32Array(o),u=new Uint32Array(o),p=(a&&(i=new Uint16Array(o)),this.refgeo_o.precision),g=this.refgeo_o.ctrX,f=this.refgeo_o.ctrY,m=this.refgeo_o.neighbours,_=0;_<s;_++){var v=(T=this.va_dp[_]).id,y=+this.var1_a[v],b=+this.var2_a[v],C=(a&&(A=+this.var3_a[v]),m[v]),x=p*g[v],w=p*f[v];if(null!=C)for(var S=C.length,M=0,O=0;O<S;O++){E=1/(1+(E=c*((P=p*g[M=C[O]]-x)*P+(D=p*f[M]-w)*D))/h*.75);var G=this.var1_a[M],I=this.var2_a[M];-9999!=G&&-8888!=G&&(y+=E*G,b+=E*I,a&&(A+=E*this.var3_a[M]))}d[v]=y,u[v]=b,a&&(i[v]=A),1==r?T.vliss1=0==b?-999999:e.multFrm*y/b+e.constFrm:3==r?T.vliss1=0==b?-999999:e.multFrm*(Math.pow(y/b,e.powerFrm)-1):5==r&&(T.vliss1=e.multFrm*(y-b)/A)}for(_=0;_<s;_++){var T,A,y=d[v=(T=this.va_dp[_]).id],b=u[v],C=(a&&(A=i[v]),m[v]),x=p*g[v],w=p*f[v];if(null!=C)for(var P,D,E,S=C.length,M=0,O=0;O<S;O++)y+=(E=1/(1+(E=c*((P=p*g[M=C[O]]-x)*P+(D=p*f[M]-w)*D))/h*.75))*d[M],b+=E*u[M],a&&(A+=E*i[M]);1==r?T.vliss2=0==b?-999999:e.multFrm*y/b+e.constFrm:3==r?T.vliss2=0==b?-999999:e.multFrm*(Math.pow(y/b,e.powerFrm)-1):5==r&&(T.vliss2=e.multFrm*(y-b)/A)}l=(new Date).getTime()-n;console.log("lissage  en : "+l+" ms",GCO5.core.GcDelayUtil.curFrame())},_quantilize:function(t,e,i,n,r,a,s){var o,l=t.length,c=this.valref,h=[],d=[],u=[],p=[],g=0,f=a==s,c=GCO5.core.GcMathUtil.isNumber(c)&&n&&r<l&&(0<r||f),m=l/e,_=GCO5.core.GcArrayUtil.getQuantilesIndices(l,e),v=(_.shift(),-1);if(c&&f&&(v=0),c){for(g=0;g<_.length;g++)v<0&&Math.abs(_[g]-r)<=Math.round(m/2)&&(v=g+1);if(g=_.length-1,v<0&&r>_[g]&&r-_[g]<=Math.round(m/2)&&(v=g+1),a<s&&v==e&&v--,s<a&&a-s<m/2&&v--,0<=a&&a<s&&s-a<m/2&&v++,0!=v||f||v++,m=(_[v-1]=r)/v,1<v&&2<m)for(var y=0,g=1;g<v;g++){var b=_[g-1]=Math.floor(g*m)-1;if(t[y][i]==t[b][i]){for(;t[b][i]==t[y][i]&&b<l;)b++;_[g-1]=y=b}}if(m=(l-r-1)/(e-v),v<e-1&&2<m)for(m=(l-r-1)/(e-v),g=1;g<e-v;g++)_[v+g-1]=r+Math.floor(g*m)-1}for(g=1;g<e;g++)if(!(g>_.length)){var C=_[g-1],x=t[C][i];if(1<=h.length&&x==h[h.length-1]){for(w=1;C+w<l&&t[C+w][i]==x;)w++;C+w<t.length&&(h.push(t[C+w][i]),u.push(o=C+w),p.push(--o),d.push(t[o][i]),g<e-1&&_[g]<=C+w&&(_[g]=C+w+1))}else{for(var w=1;w<C&&t[C-w][i]==x;)w++;w--,h.push(x),u.push(o=C-w),p.push(--o),d.push(t[o][i])}}GCO5.core.GcArrayUtil.getUniqueValues(h,"N").length;return n&&0<v&&(h[v-1]=this.valref),{seuils:h,i_seuils:u,i_seuils_inf:p,seuils_inf:d,k_valref:v}},_get_average_on_range:function(t,e,i,n,r,a){var s=t.length,o=0,l=0,c=n!=r;if(a)for(var h=0;h<s;h++){var d=t[h][e];(!c||n<=d&&d<=r)&&(o+=Math.log(d-i+1),l++)}else for(h=0;h<s;h++)d=t[h][e],(!c||n<=d&&d<=r)&&(o+=d,l++);return o/l},_gen_seuils_emboit:function(t,e,i,n){var r,a,s,o=this.constructor,l=this.va_dp,c=t.minth,h=t.maxth,d=this.valref,u=(l.length,[]),p=(i&&GCO5.core.GcMathUtil.isNumber(d)?(a=d,n&&(a=Math.log(a-c+1)),r=8==e?4:2):a=this._get_average_on_range(l,"v",c,0,0,n),u[0]=a,4<=e&&(i=this._get_average_on_range(l,"v",c,c,a,n),d=this._get_average_on_range(l,"v",c,a,h,n),u.unshift(i),u.push(d),8==e&&(i=this._get_average_on_range(l,"v",c,c,u[0],n),d=this._get_average_on_range(l,"v",c,u[0],a,n),e=this._get_average_on_range(l,"v",c,a,u[2],n),a=this._get_average_on_range(l,"v",c,u[2],h,n),u=[i,u[0],d,u[1],e,u[2],a])),Math.pow(10,this.precision));for(s in u)u[s]=Math.round(p*u[s])/p;return this.discr_o.v=this._getSeuilsInfo(t,"v",u,o.NESTED_MEANS),this.discr_o.v.codes=this._getDiscretisationCodes(),void 0!==r&&(this.discr_o.v.k_valref=r),this.discr_o.v},_gen_seuils_std:function(t,e,i,n){var r,a=this.constructor,s=t,o=this.va_dp,l=s.minth,c=s.maxth,h=this.valref,d=[],u=c-l,p=s.stdevth,g=(i&&GCO5.core.GcMathUtil.isNumber(h)?(r=h,n&&(r=Math.log(r-l+1))):r=this._get_average_on_range(o,"v",l,0,0,n),p),f=0,m=0;if(s.k_valref=-1,e%2==0){if(e>Math.floor(u/g)||r-(e/2-1)*g<l||c<r+(e/2-1)*g)for(;m++<10&&(e>Math.floor(u/g)||r-(e/2-1)*g<l||c<r+(e/2-1)*g);)g/=2;for(d[e/2-1]=r,f=1;f<e/2;f++)d[e/2-1-f]=r-f*g,d[e/2-1+f]=r+f*g;i&&(s.k_valref=e/2)}if(e%2==1){if(e>Math.floor(u/g)||r-((e-1)/2-.5)*g<l||c<r+((e-1)/2-.5)*g)for(;m++<10&&(e>Math.floor(u/g)||r-((e-1)/2-.5)*g<l||c<r+((e-1)/2-.5)*g);)g/=2;for(f=1;f<=(e-1)/2;f++)d[(e-1)/2-f]=r-(f-.5)*g,d[(e-1)/2+f-1]=r+(f-.5)*g}var _=Math.pow(10,this.precision);if(n)for(f=0;f<e-1;f++)d[f]=Math.exp(d[f])+l-1;else for(f=0;f<e-1;f++)d[f]=Math.round(d[f]*_)/_;return this.discr_o.v=this._getSeuilsInfo(t,"v",d,a.STD),this.discr_o.v.codes=this._getDiscretisationCodes(),this.discr_o.v.includeValref=!0,this.discr_o.v},_gen_seuils_manu:function(t,e){var i=this.constructor;return this.discr_o.v=this._getSeuilsInfo(t,"v",e,i.MANU),this.discr_o.v.codes=this._getDiscretisationCodes(),this.discr_o.v},_getSeuilsInfo:function(t,e,i,n,r){for(var a=this.va_dp,s=a.length,o=1,l=[],c=[],h=i.length+1,d=i.concat([a[s-1][e]+1]),u=d.shift(),p=[],g=0;g<20;g++)p[g]=0;if(p[0]=t.eftallnath,"manu"==n){for(var f=-1,g=0;g<i.length;g++)i[g]=+i[g],-1==f&&i[g]>=a[0][e]&&(f=g),0<g&&l.push(i[g-1]);for(l.push(i[g-1]),u=(d=i.slice(f,i.length-f)).shift(),o=f+1,g=0;g<s;g++){if(u<=(m=a[g][e]))for(0<o&&0<g&&(l[o-1]=a[g-1][e]);u<=m&&o<h;)0<d.length&&(u=d.shift()),o++,c.push(g);p[a[g].c=o]++}}else{u==t.minth&&(u=a[t.nv_min][e]);for(g=0;g<s;g++){var m=a[g][e];if(u<=m&&0<g){if((u=d.shift())<=m&&(i[o-1]=a[g-1][e],!r))return this._getSeuilsInfo(t,e,i,n,!0);i[o-1]=m,c.push(g),l.push(a[g-1][e]),o++}p[a[g].c=o]++}}return{i_seuils:c,seuils:i,seuilsinf:l,nclasses:(c.length,h),efts:p,meth:n,ind:e}},_gen_seuils_jenks:function(t,e){var i,n=this.va_dp,r=t.nv_min,a=n.length,s=1,o=Math.floor(a/e),l=this.constructor,c=t.ind,o=5<r&&.7*o<=r||o<r;if(a>l.SAMPLING_LIMIT){for(var h=l.SAMPLING_LIMIT,d=GCO5.core.GcMathUtil.getSimpleHaltonSequenceb2(h),u=new Array(h),p=new Array(h),g=a-1,f=0;f<h;f++)i=u[f]=n[Math.round(g*d[f])][c],p[f]=i*i;u.sort(function(t,e){return t-e}),p.sort(function(t,e){return t-e}),a=h}else o&&(e--,n=n.slice(r)),a=n.length;for(var m=new Array(e+1),_=new Array(e+1),v=(m[0]=new Array(a+1),_[0]=new Array(a+1),m[1]=new Array(a+1),_[1]=new Array(a+1),_[m[1][1]=1][1]=0,_[1]),f=2;f<=a;f++)v[f]=Number.POSITIVE_INFINITY;for(s=2;s<=e;s++)m[s]=m[1].concat(),_[s]=_[1].concat(),_[s].fixed=m[s].fixed=!0;if(u)for(var y=2;y<=a;y++){for(var b,C=0,x=0,w=0,S=y;0<--S;)for(C+=u[S],i=(x+=p[S])-C*C/++w,s=2;s<=e;s++){var v=_[s],M=i+_[s-1][S];v[y]>=M&&(m[s][y]=S+1,v[y]=M)}C+=u[0],i=(x+=p[0])-C*C/y,_[m[1][y]=1][y]=i}else for(y=2;y<=a;y++){for(var O,G,C=x=w=0,S=1;S<=y;S++)if(i=(x+=(b=n[G=(O=y-S+1)-1][c])*b)-(C+=b)*C/++w,0!=G)for(s=2;s<=e;s++)v=_[s],M=i+_[s-1][G],v[y]>=M&&(m[s][y]=O,v[y]=M);_[m[1][y]=1][y]=i}var I=[],T=[],A=(I[e-1]=u?u[a-1]:n[a-1][c],a);for(s=e;2<=s;s--){var P=m[s][A]-2;I[s-2]=u?u[P]:n[P][c],T[s-2]=P,A=m[s][A]-1}I.pop(),o&&!d&&(I.unshift(n[0][c]),T.unshift(r));var D,E=Math.pow(10,this.precision);for(D in I)I[D]=Math.round(E*I[D])/E;return this.discr_o[c]=this._getSeuilsInfo(t,c,I,l.JENKS),this.discr_o[c].codes=this._getDiscretisationCodes(),this.discr_o[c]},_gen_seuils_kmeans:function(t,e){for(var i,n=this.constructor,r=this.va_dp,a=(t.minth,t.maxth,r.length),s=1,o=Math.floor(a/e),l=[],c=[],h=[],d=[],u=[],p=[],g=h[c[l[0]=0]=0]=0;g<a;g++){var f=r[g].v;g==s*o&&s<e?(u.push(g),p.push(f),l[s-1]=h[s-1]/c[s-1],h[s]=f,c[s]=1,s++):(h[s-1]+=f,c[s-1]++),d[g]=s-1}l[e-1]=h[e-1]/c[e-1];for(g=1;g<e;g++){if(l[g]==i){var m=!0,_=g-1;h[_]+=h[g],c[_]+=c[g],c[g]=0,l[_]=h[_]/c[_],u[_]=u[g],u[g]=g+1<e-1?Math.round((u[g+1]+u[g])/2):Math.round((a+u[g])/2);break}i=l[g]}if(m){h[g]=0,c[g]=0;for(var v=u[g-2];v<u[g-1];v++)d[v]=g-1;for(v=u[g-1];v<u[g];v++)h[g]+=r[v].v,c[g]++,d[v]=g;for(h[g+1]-=h[g],c[g+1]-=c[g],g=0;g<e;g++)l[g]=h[g]/c[g]}for(var y=!0,b=0,C=[],x=[],g=0;g<e;g++)C[g]=1,x[g]=0;for(g=0;g<a;g++){var w=d[g],f=r[g].v;w<e-1&&(v=f-l[w])>l[w+1]-f?(d[g]=w+1,h[w+1]+=f,h[w]-=f,c[w+1]++,c[w]--,u[w]--):0<w&&v>f-l[w-1]&&(d[g]=w-1,h[w-1]+=f,h[w]-=f,c[w-1]++,c[w]--,u[w-1]++)}for(g=0;g<e;g++)l[g]=h[g]/c[g],g<e-1&&(p[g]=(r[u[g]].v+r[u[g]-1].v)/2);for(;y&&b++<50;){var S=p.concat();for(g=0;g<=e-2;g++)p[g]=(l[g]+l[g+1])/2;for(y=!1,g=0;g<e-1;g++){var M=0,O=0;if(p[g]>S[g]){y=!0,s=1;for(var G,I=0;u[g]+s-1<a&&(G=r[u[g]+s-1].v)<p[g]&&I++<1e4;)O+=G,M++,s++}else if(p[g]<S[g])for(y=!0,s=1,I=0;u[g]>=s&&(G=r[u[g]-s].v)>=p[g]&&I++<1e4;)O-=G,M--,s++;1<s&&(h[g]+=O,c[g]+=M,h[g+1]-=O,c[g+1]-=M,u[g]+=M,l[g]=h[g]/c[g],l[g+1]=h[g+1]/c[g+1])}for(h[e-1]=0,c[e-1]=0,s=u[e-2];s<a;s++)h[e-1]+=r[s].v,c[e-1]++;l[e-1]=h[e-1]/c[e-1]}for(g=0;g<e-1;g++)p[g]=(l[g]+l[g+1])/2;var T,A=Math.pow(10,this.precision);for(T in p)p[T]=Math.round(A*p[T])/A;return this.discr_o.v=this._getSeuilsInfo(t,"v",p,n.KMEANS),this.discr_o.v.codes=this._getDiscretisationCodes(),this.discr_o.v},_getDiscretisationCodes:function(){var t=this.va_dp.concat(this.na_dp);return t.sort(function(t,e){return t.id-e.id}),GCO5.core.GcArrayUtil.getColumnByKey(t,"c")},getDiscretisationInfo:function(){return this.discr_o[this.curColInd]},getAnalyzeInfo:function(){return this.analyse_o[this.curColInd]},getCurColInd:function(){return this.curColInd}}),puremvc.define({name:"GCO5.ApplicationFacade",parent:puremvc.Facade},{startup:function(){this.initialized||(this.initialized=!0,this.registerCommand(GCO5.AppConstants.STARTUP,GCO5.controller.command.StartupCommand),this.sendNotification(GCO5.AppConstants.STARTUP))}},{getInstance:function(t){var e=puremvc.Facade.instanceMap;return(instance=e[t])?instance:e[t]=new GCO5.ApplicationFacade(t)},NAME:"O5"}),puremvc.define({name:"GCO5.controller.command.StartupCommand",parent:puremvc.SimpleCommand},{execute:function(t){this.facade.registerProxy(new GCO5.model.proxy.AppProxy),this.facade.registerMediator(new GCO5.view.mediator.AppMediator)}}),puremvc.define({name:"GCO5.model.proxy.AppProxy",parent:puremvc.Proxy},{serverProxy:null,gcDBModel:null,gcsm:null,gclg:null,cli:null,breakPoints:null,setup:function(){this.gcsm=GCO5.core.SystemManager.getInstance(),this.gclg=GCO5.core.GcLangManager.getInstance(),this.cli=GCO5.core.ClientInfo.getInstance();var e=this,t=(this._setScreenBreakPoints(),this.serverProxy=new GCO5.model["GcPHPServerV"+GCO5.initInfo.version](this),"GC_init.php?lang="+this.gclg.getLang()+"&obs="+GCO5.initInfo.obs),t=this.serverProxy.addProdHash(t);$.getJSON(t,function(t){e.gcDBModel=new GCO5.model["GcDBModelV"+GCO5.initInfo.version](t,e),e.sendNotification(GCO5.model.proxy.AppProxy.FULLINITINFO_LOADED,t)})},getLang:function(){return GCO5.core.GcLangManager.getInstance().getLang()},_setScreenBreakPoints:function(){this.breakPoints={w:{tiny:543,small:900,medium:991,large:1199},h:{tiny:543,small:900,medium:991,large:1199}}},getMainComponents:function(){return["indicator","externaldata","home","news","report","zonage","article","favs","prefs","help","contact","resetpassword"]},getTypindList:function(e){function t(t){return i.gclg.getString(t,"pilotage","indicator")}var i=this;return[{data:"",label:t("TYPIND_ALL")},{data:"PIE",label:t("TYPIND_PIE")},{data:"C",label:t("TYPIND_CHORO")},{data:"RC",label:t("TYPIND_RC")},{data:"F",label:t("TYPIND_FLUX")},{data:"O",label:t("TYPIND_OURSINS")},{data:"PT",label:t("TYPIND_POINTS")},{data:"PL",label:t("TYPIND_LINS")},{data:"R",label:t("TYPIND_RONDS")},{data:"SOLDE",label:t("TYPIND_SOLDES")},{data:"I",label:t("TYPIND_TYPO")},{data:"Z",label:t("TYPIND_ZON")}].filter(function(t){return(""==t.data||i.gcDBModel.getConcept("typinds").hasOwnProperty(t.data))&&(!e||e.indexOf(t.data)<0)})},getMapMenu:function(e){function t(t){return i.gclg.getString(t,"restit_menus","main")}var i=this,n=[{id:"Search",show:"IE",label:this.gclg.getString("SEARCH"),title:t("MENU_SEARCHGEO_TITLE")},{id:"Layers",show:"IRZE",label:t("MENU_ADDLAYERS"),title:t("MENU_ADDLAYERS_TITLE")},{id:"Select",show:"I",label:this.gclg.getString("SELECT")},{id:"Export",show:"IZE",label:t("MENU_EXPORT"),title:t("MENU_EXPORT_TITLE")}].filter(function(t){return!e||0<=t.show.indexOf(e.substr(0,1).toUpperCase())});return n.push({id:"Etiq",label:t("MENU_ETIQS")}),this.cli.isTinyWidthScreen()||"report"==e||n.push({id:"Print",label:this.gclg.getString("PRINT"),title:t("MENU_PRINT_TITLE")}),n},getReportMenu:function(){function t(t){return e.gclg.getString(t,"restit_menus","main")}var e=this,i=[];return this.cli.isTinyWidthScreen()||(i.push({id:"Print",label:this.gclg.getString("PRINT"),title:t("MENU_PRINT_TITLE")}),this.cli.isInIframe()||i.push({id:"PrintAll",label:this.gclg.getString("PRINT_ALL","restit","report"),title:t("MENU_PRINT_TITLE")}),i.push({id:"ExportAll",label:this.gclg.getString("EXPORT_DATA","tables"),title:this.gclg.getString("MENU_EXPORT_DATA_TITLE","restit","report")})),i},getTabMenu:function(){function t(t){return i.gclg.getString(t,"restit","indicator")}function e(t){return i.gclg.getString(t,"concepts").toUpperCase()}var i=this;return[{id:"m2",label:t("TABS_2MAPS")},{id:"mt",label:t("TABS_MAP_TABLE")},{id:"mf",label:t("TABS_MAP_SYNTH")},{id:"mtf",label:e("MAP")+" + "+e("TABLE")+" + "+e("SYNTH"),class:"medium-hidden"}]},getTableMenu:function(t,e){var i=[{id:"Export",label:this.gclg.getString("EXPORT")},{id:"Print",label:this.gclg.getString("PRINT")}];return GCO5.browser.isIOS&&i.shift(),(e||this.cli.isTinyWidthScreen())&&i.pop(),t||i.unshift({id:"Filter",label:this.gclg.getString("FILTER")}),i},getFicMenu:function(){var t=[{id:"Export",label:this.gclg.getString("EXPORT")}];return this.cli.isTinyWidthScreen()||t.push({id:"Print",label:this.gclg.getString("PRINT")}),t},loadReportPageData:function(e,i,t){$.getJSON("tests/data/"+t+".json",function(t){i&&i.apply(e,[t])})}},{NAME:"AppProxy",FULLINITINFO_LOADED:"fullinitInfoLoaded"}),GCO5.core.GcComponentUtil={setupAndShowComponent:function(t,e){var i=GCO5.core.SystemManager.getInstance(),n=(e.categ||(e.categ="main"),i.getActiveComponent(e.categ)),r=window.location.href,a=GCO5.core.ClientInfo.getInstance().removeURLParameter(r,"redirect"),r=(a!==r&&window.history.replaceState(window.history.state,"",a),t.getName().substr(0,t.getName().length-9).toLowerCase());"app"==r||i.historyBrowsing||n&&t.getName()==n.getName()||$.bbq.pushState({c:r}),n&&(e.previousActiveComponentName=n.getName(),n.hide()),t.setup(e)},displaySlidingPanel:function(e,t){t=t||"left",$(".cd-panel").on("click",function(t){($(t.target).is(".cd-panel")||$(t.target).is(".cd-panel-close"))&&($(".cd-panel").removeClass("is-visible"),$(document).triggerHandler(GCO5.view.component.AppComponent.CLOSE_PANEL),t.preventDefault(),$(document).off("keydown"),$(".cd-panel").off("click"),$(e).focus(),GCO5.core.SystemManager.getInstance().setActivePanel(null))}),$(document).on("keydown",function(t){27==t.keyCode&&$(".cd-panel").trigger("click")}),$(".cd-panel.from-"+t).addClass("is-visible"),GCO5.core.GcDelayUtil.callLater(function(){$(".cd-panel-close").focus()},[],2)},enhanceSliderEvents:function(t){t.on("mousedown mouseup",function(t){"mousedown"==t.type&&$(this).on("mousemove",function(t){$(this).trigger("change")}),"mouseup"==t.type&&$(this).off("mousemove")})},animateCollapsibleSet:function(n,r){$(n).on("click",".ui-collapsible-heading-toggle",function(t){var e,i=$(this).closest(".ui-collapsible");i.hasClass("ui-collapsible-collapsed")?(i.removeClass("ui-collapsible-collapsed"),n.trigger("collapsibleexpand",i),e=i.siblings(".ui-collapsible:not(.ui-collapsible-collapsed)"),$(">.ui-collapsible-content:not(.ui-collapsible-content-collapsed)",e).slideUp(r?0:"fast",function(){$(this).attr("aria-hidden","true").addClass("ui-collapsible-content-collapsed"),$(this).closest(".ui-collapsible").addClass("ui-collapsible-collapsed")}),$(">.ui-collapsible-content",i).slideDown(r?0:"fast",function(){$(this).attr("aria-hidden","false").removeClass("ui-collapsible-content-collapsed")})):(i.addClass("ui-collapsible-collapsed"),n.trigger("collapsiblecollapse",i),$(">.ui-collapsible-content",i).slideUp(r?0:"fast",function(){$(this).attr("aria-hidden","true").addClass("ui-collapsible-content-collapsed")})),$(this).attr("aria-expanded",!i.hasClass("ui-collapsible-collapsed"))})},enable:function(t){t.removeAttr("disabled")},disable:function(t){t.attr("disabled",!0)}},GCO5.view.component.AComponent=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.AComponent",LOAD_COMPONENT:"loadComp"},_$renderedContent:null,_$container:null,_categ:null,_action:null,_viewData:null,inited:null,_ca:null,_hasListeners:null,gcsm:GCO5.core.SystemManager.getInstance(),gclg:GCO5.core.GcLangManager.getInstance(),cli:GCO5.core.ClientInfo.getInstance(),_loadpage_o:null,lastWidth:null,historyBrowsing:null,resizing:null,dataDef_o:null,_showAlphaInColPicker:null,_preferredColorFormat:"hex",initialize:function(){},isVisible:function(){return this.getRenderedContent().is(":visible")},goToMainContent:function(){},_reinitComponent:function(t){},setup:function(t){if(!t)return!1;(this.dataDef_o=t).container?this._$container=t.container:(e=this.gcsm.getActiveComponent(t.categ),this._$container=e&&e.getRenderedContent()?e.getRenderedContent().parent():$("body")),t.categ||(t.categ="main"),t.action||(t.action="NEW"),this._categ=t.categ,this._action=t.action;var e=this.getRenderedContent(),i=t.id&&0==t.id.indexOf("home");"RECALL"!=t.action||i?"NEW"==t.action||i?(this._initComponent(t),e&&"panel"!=t.categ&&e.remove(),this._prepareViewData(t),this._renderViewData()):"UPDATE"==t.action&&this._updateViewData(t):(0==e.closest("html").length&&this._$container.append(e),e.hide()),this._initSubComponentsAndEnhance(t),this._onAddedToStage(t)},getElementById:function(t,e){return $("#"+t,this._$container)},_renderViewData:function(){var t=(t=this.getName()).substr(0,1).toLowerCase()+t.substr(1),e="' data-role='component'";"main"==this._categ?(e+=" class='cu-component'",this._$renderedContent=$("<main role='main' id='"+t+e+"></main>").appendTo(this._$container)):this._$renderedContent=$("<section id='"+t+e+"></section>").appendTo(this._$container),$.render[this.getName()].link(this._$renderedContent,this._viewData)},resetTemplate:function(){$.render[this.getName()].link(this._$renderedContent,this._prepareViewData()),this._addListeners(),this._initSubComponentsAndEnhance()},_registerComponent:function(){this.gcsm.setActiveComponent(this,this._categ),this.gcsm.statTrack(this._action)},getName:function(){return this.constructor.NAME.split(".").pop()},getShortName:function(){return this.getName().substr(0,this.getName().length-9).toLowerCase()},getRenderedContent:function(){return this._$renderedContent},setRenderedContent:function(t){this._$renderedContent=t},onHashChange:function(t){this.gcsm.registerHistoryBrowsing()},syncViewData:function(t){for(var e in t)this._viewData.hasOwnProperty(e)&&$.observable(this._viewData).setProperty(e,t[e])},isActive:function(){return!!this._$renderedContent&&(0!==this._$renderedContent.closest("html").length&&"block"==this._$renderedContent.css("display"))},getLastWidth:function(t){return this.lastWidth},_onAddedToStage:function(t){this._hasListeners||(this._addListeners(),this._hasListeners=!0),this.lastWidth=GCO5.browser.width,this.inited||this._fireInitEvents(t),this.inited=!0,this.show(),this.afterShow(),"main"==this._categ&&$("body").removeClass("textComponent restitCompositeMode restitCompositeMode2 restit-c2")},afterShow:function(){$(window).scrollTop(0),"main"==this._categ&&$("body").removeClass("no100vh"),this.updateAppTitle()},show:function(t){this.getRenderedContent().show(),this._registerComponent()},hide:function(){this._onRemovedFromStage(),this.getRenderedContent().hide()},_onRemovedFromStage:function(){},_removeListeners:function(){this._hasListeners=!1},_addListeners:function(){},beforeComponentHide:function(t){this.lastWidth=GCO5.browser.width},onComponentShow:function(t){},onPanelOpen:function(t){},onPanelClose:function(t){},_setComponentData:function(t){},updateData:function(t){},destroy:function(){this._onRemovedFromStage()},destroyComponent:function(){null!=this._$renderedContent&&this._$renderedContent.remove(),this.inited=!1},detachPage:function(){null!=this._$renderedContent&&this._$renderedContent.detach()},getRenderedContentHeight:function(){var t=this._$renderedContent.attr("id");return GCO5.browser.height-$("#"+t+"Footer",this._$renderedContent).height()-$("#"+t+"Header",this._$renderedContent).height()},toHomePage:function(){},_fireInitEvents:function(t){this._ca||(this._ca=this),0<=["home","cloud"].indexOf(t.from)&&this.cli.isSmallWidthScreen()&&this._$renderedContent.addClass("pilotage-only")},_getURLState:function(){var t,e=$.bbq.getState();for(t in e)if(!1===this.cli.isValidHashParam(e[t])){e={};break}return e},_prepareViewData:function(t){},_updateViewData:function(t){},_initComponent:function(t){},_initSubComponentsAndEnhance:function(t){t&&"RECALL"==t.action||(t=this._$renderedContent,$(".js-tabs",t).accessibleTabsAria(),$(".js-accordion",t).accessibleAccordionAria(),$(".js-expandmore",t).accessibleHideShowAria(),$("[data-menu]",t).menu(),$("[data-menu-trigger]",t)["menu-trigger"]())},setObservableProperty:function(t,e,i){var n=i&&i.noTrigger,r=i&&i.forceTrigger;n&&(this._viewData.noTrigger=!0),r&&(this._viewData.forceTrigger=!0,this._viewData[t]=null),i&&i.ns?($.observable(i.ns,this._viewData).setProperty(t,e),this._viewData.noTrigger=!0,this._viewData[t]=null,$.observable(this._viewData).setProperty(t,e),this._viewData.noTrigger=!1):$.observable(this._viewData).setProperty(t,e),n&&(this._viewData.noTrigger=!1),this._viewData.forceTrigger=!1},setObservableProperties:function(t,e){e=e&&e.noTrigger;e&&(this._viewData.noTrigger=!0),$.observable(this._viewData).setProperty(t),e&&(this._viewData.noTrigger=!1)},setObservableArray:function(t,e,i,n,r){var a=r&&r.noTrigger;i?this.setObservableProperty(i,null):a&&(this._viewData.noTrigger=!0),$.observable(this._viewData[t]).refresh(e),i?this.setObservableProperty(i,n,r):a&&(this._viewData.noTrigger=!1)},getViewData:function(){return this._viewData},getSaveState:function(){return{}},configureSlidingPanelHeader:function(t){this._$container.closest("section").find("h1").text(t),this._$container.closest("section").find("header .cd-panel-close").attr("aria-label",this.gclg.getString("CLOSE_PANEL")+" "+t+". "+this.gclg.getString("CLOSE_PANEL_HINT"))},updateAppTitle:function(){var t=GCO5.appModel.getLegal("tit_nav"),e=this._$renderedContent.find("h1").text();"main"==this._categ&&(document.title="home"==this.getShortName()?t:t+" - "+e)},close:function(){},_initColPickers:function(){this._super(),$(".colpicker",this._$container).spectrum({type:"color",showInput:!0,containerClassName:"full-spectrum",replacerClassName:"full-spectrum",hideAfterPaletteSelect:!0,showPalette:!0,showAlpha:this._showAlphaInColPicker||!1,palette:[["#000000","#434343","#666666","#999999","#b7b7b7","#cccccc","#d9d9d9","#efefef","#f3f3f3","#ffffff"],["#980000","#ff0000","#ff9900","#ffff00","#00ff00","#00ffff","#4a86e8","#0000ff","#9900ff","#ff00ff"],["#e6b8af","#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d9ead3","#c9daf8","#cfe2f3","#d9d2e9","#ead1dc"],["#dd7e6b","#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#a4c2f4","#9fc5e8","#b4a7d6","#d5a6bd"],["#cc4125","#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6d9eeb","#6fa8dc","#8e7cc3","#c27ba0"],["#a61c00","#cc0000","#e69138","#f1c232","#6aa84f","#45818e","#3c78d8","#3d85c6","#674ea7","#a64d79"],["#85200c","#990000","#b45f06","#bf9000","#38761d","#134f5c","#1155cc","#0b5394","#351c75","#741b47"],["#5b0f00","#660000","#783f04","#7f6000","#274e13","#0c343d","#1c4587","#073763","#20124d","#4c1130"]],preferredFormat:this._preferredColorFormat})}}),GCO5.view.component.APanel=GCO5.view.component.AComponent.extend({statics:{NAME:"GCO5.view.component.APanel"},_map:null,_ca:null,_caName:null,_initComponent:function(t){this._map=t.map,this._ca=t.ca,t.ca&&(this._caName=t.ca.getName()),this.gcsm.setActivePanel(this)},_addListeners:function(){var t=GCO5.view.component.AppComponent.CLOSE_PANEL;$(document).off(t),$(document).one(t,$.proxy(this._destroy,this))},_destroy:function(t){this._$renderedContent.remove(),window.scrollTo(0,0)},close:function(){$(".cd-panel").trigger("click")},onBuildInfosel:function(t){},_renderViewData:function(){var t=(t=this.getName()).substr(0,1).toLowerCase()+t.substr(1);this._$renderedContent=$("<section id='"+t+"' data-role='component' class='no-display'></section>").appendTo(this._$container),$.render[this.getName()].link(this._$renderedContent,this._viewData)}}),GCO5.view.component.AppComponent=GCO5.view.component.AComponent.extend({statics:{NAME:"GCO5.view.component.AppComponent",POSTROBOT_MSG:"PostRobot_messages",CLOSE_PANEL:"closePn"},setup:function(){(GCO5.topApp=this)._prepareViewData(),GCO5.core.GcObjectUtil.isEmpty(GCO5.appModel.getOption("TAWKTO_KEY"))&&GCO5.core.GcObjectUtil.isEmpty(GCO5.appModel.getOption("CK_KEY"))?$.render.AppComponent.link($("body"),this._viewData):($("body").find(".splashscreen").remove(),$("body").find("style").remove(),$("body").append($.render.AppComponent(this._viewData))),this._addListeners(),this._initSubComponentsAndEnhance(),this._fireInitEvents()},_prepareViewData:function(t){this._viewData={lang_a:GCO5.appModel.getConcept("lang"),lang:GCO5.appModel.getLang(),articles_a:GCO5.appModel.getInitKey("articles"),obs_a:GCO5.appModel.getInitKey("obs"),displayCookiePanel:GCO5.initInfo.displayCookiePanel&&GCO5.core.GcObjectUtil.isEmpty(GCO5.appModel.getOption("CK_KEY"))}},_fireInitEvents:function(){this.gcsm.registerHistoryBrowsing(),window.scrollTo(0,0),$(window).trigger("hashchange"),this._updateBodyClasses(),GCO5.browser.isFirefox||$("html").addClass("noff")},_initSubComponentsAndEnhance:function(t){this._initMegaMenu(),GCO5.core.GcDelayUtil.callLater(function(){$(document).trigger("enhance")},[],20,this)},_closeMegaMenu:function(){$("#megamenu li").trigger(jQuery.Event("keydown",{keyCode:27,which:27}))},_addListeners:function(){var r=this;$(".exitiframe").on("click",function(t){window.open(GCO5.core.ClientInfo.getInstance().getUrlWithoutQueryString2())}),$(".skip-links").on("click","a",function(t){r.gcsm.getActiveComponent().goToMainContent()}),$(".accept-cookie").on("click",function(t){r.cli.acceptCookie()}),$(".dismiss-cookie").on("click",function(t){r.cli.dismissCookie()}),$(".grid_btn").on("click",function(t){var e=new GCO5.view.component.MenuPanel;GCO5.core.GcDelayUtil.callLater(GCO5.core.GcComponentUtil.displaySlidingPanel,[t.target],5,r),GCO5.core.GcDelayUtil.callLater(function(){e.setup({action:"NEW",categ:"panel",container:$(".cd-panel-content")})},[],30,r)});new Hammer($(".backhome").get(0)).on("press",function(t){r.cli.reloadAndReinit()});var i=GCO5.appModel.getOption("backUrl"),t=this.gclg.getString("BACK_HOME2","topmenu"),n=(i&&$(".backhome").attr("title",i+"\n"+t).attr("aria-label",i+" "+t),$(".backhome").on("click",function(t){if(t.originalEvent&&t.originalEvent.ctrlKey)return t.preventDefault(),void r.cli.reloadAndReinit();$("#megamenu .mainComp").removeAttr("aria-current").parent().removeClass("selected"),i?location.assign(i):$(r.gcsm.getComponent("app")).triggerHandler(GCO5.view.component.AComponent.LOAD_COMPONENT,{id:"home",categ:"main"})}),$("body > header").on("click","#megamenu .mainComp",function(t){r._closeMegaMenu();var e=$(t.currentTarget).data("pk");"home"==e&&i?location.assign(i):($("#megamenu .mainComp").removeAttr("aria-current").parent().removeClass("selected"),$(t.currentTarget).attr("aria-current","page").parent().addClass("selected"),r.loadMainComponent(e))}),$("body > header").on("click","#megamenu .subObsEntry",function(t){r._closeMegaMenu();var t=$(t.currentTarget).data("pk").split("@"),e=t[0],i=t[1];"obs"===e&&(t=GCO5.appModel.getInitKey("obs").find(function(t){return t.c_id_obs===i}),location=null===t.c_preferred_url?"?obs="+t.c_id_obs:t.c_preferred_url)}),$("body > header").on("click","#megamenu .panel",function(t){r._closeMegaMenu();function e(){GCO5.core.GcDelayUtil.callLater(GCO5.core.GcComponentUtil.displaySlidingPanel,[t.target],5,r),GCO5.core.GcDelayUtil.callLater(function(){n.setup({action:"NEW",categ:"panel",container:$(".cd-panel-content")})},[],30,r)}var i=$(t.currentTarget).data("pk"),n=new GCO5.view.component[GCO5.core.GcStringUtil.proper(i)+"Panel"];"favs"!=i||window.JSZip?e.apply(r):(r.gcsm.freeze("favs"),require(["favs_m"],function(t){r.gcsm.unFreeze("favs"),t.initialize(),e.apply(r)}))}),$("body > header").on("click","#megamenu :not(.mainComp)",function(t){r._closeMegaMenu()}),$(window).on("hashchange",function(t){var e=r.cli.checkAndCleanState($.deparam.fragment());if(e.block&&r.cli.isInIframe()&&$("body").addClass("single-dvz-block"),!GCO5.core.GcObjectUtil.isEmpty(e)||GCO5.core.GcObjectUtil.isEmpty($.deparam.fragment())){var i=e.c,n=(!GCO5.core.GcStringUtil.isEmpty(i)||GCO5.core.GcStringUtil.isEmpty(GCO5.initInfo.indics)||(i="indicator"),!GCO5.core.GcStringUtil.isEmpty(i)&&"app"!=i||(i="home"),r.gcsm.getActiveComponent());if(n)if(!1===n.onHashChange(e))return;n&&i==n.getShortName()||($("body").hasClass("pre-print")&&n._onExitPrint&&n._onExitPrint(),r.loadMainComponent(i)),r._updateCurrentUrl()}}),$(".switchLang").on("click",function(t){location.assign($(this).data("href"))}),new Hammer.Manager($(".cd-panel").get(0),{touchAction:"pan-x pan-y"}));n.add(new Hammer.Pinch({enable:!0}));$(["Pinch","PinchEnd","PinchCancel"]).each(function(t){var e=this.toLowerCase();n.on(e,function(t){return!(0<=t.type.indexOf("pinch"))||(t.preventDefault(),!1)})}),this._addPostRobotListeners()},_addPostRobotListeners:function(){var i=this.constructor,n=this;[{msg:"exportMapImg",scope:"Indicator"},{msg:"changeMapView",scope:"Indicator"},{msg:"zoomOnFullExtent",scope:"Indicator"},{msg:"clearSelection",scope:"Indicator"},{msg:"printMap",scope:"Indicator"},{msg:"printChapter",scope:"Report"},{msg:"changeChapter",scope:"Report"},{msg:"exportReportData",scope:"Report"}].forEach(function(e){postRobot.on(e.msg,function(t){e.data=t.data,$(n).triggerHandler(i.POSTROBOT_MSG,e)})})},setMenuActiveState:function(t){var e=t.split("@"),i="";1<e.length&&(i=e[0]+"@",t=e[1]),$("#megamenu .nav-item > a").removeClass("selected"),$("#megamenu .nav-item > a[data-pk='"+t+"']").addClass("selected"),$("#megamenu li.selected > a[data-pk='"+i+"*']").removeClass("selected"),$("#megamenu li > a[data-pk='"+t+"']").parent().addClass("selected")},setObsMenuActive:function(t){$("#megamenu .obsMenu li.subObsEntry.selected[data-pk='obs@*']").removeClass("selected"),$("#megamenu .obsMenu li.subObsEntry[data-pk='obs@"+t+"']").addClass("selected")},loadMainComponent:function(t,e){var t=t.split("|"),i=t[0],t=2==t.length?t[1]:null;GCO5.appModel.getMainComponents().indexOf(i)<0||((e=e||{}).id=i,e.id_page=t,t=this.cli.checkAndCleanState($.deparam.fragment()),"article"==i&&!e.id_page&&t.page&&(e.id_page=t.page),GCO5.core.GcDelayUtil.callLater(function(){$(this).triggerHandler(GCO5.view.component.AComponent.LOAD_COMPONENT,e)},[],5,this))},_updateCurrentUrl:function(){var t=GCO5.appModel.getConcept("lang"),n=GCO5.appModel.getLang(),r=this;t.forEach(function(t,e){var i;t.c_id_lang!=n&&(i=$("#switchLang"+t.c_id_lang),t=r.cli.getUrlForNewLang(t.c_id_lang),i.data("href",t))})},_updateBodyClasses:function(){$("body").removeClass("pil-small pil-large"),1600<=GCO5.browser.width?$("body").addClass("pil-large"):900<=GCO5.browser.width&&$("body").addClass("pil-small")},onResize:function(t,e){var i;this._resizing||(GCO5.core.GcDelayUtil.callLater(this._updateBodyClasses),GCO5.browser.isTouch||window.scrollTo(0,1),(i=this)._resizing=!0,GCO5.core.GcDelayUtil.callLater(function(){i._resizing=!1},[],20,this),this._initMegaMenu())},_initMegaMenu:function(){var t;this._viewData&&($("#megamenu").remove(),t=$.render.pageAppMegaMenu(this._viewData),$(".skip-links","body > header").after(t),$("#megamenu").accessibleMegaMenu({uuidPrefix:"accessible-megamenu",menuClass:"nav-menu",topNavItemClass:"nav-item",panelClass:"sub-nav",panelGroupClass:"sub-nav-group",hoverClass:"hover",focusClass:"focus",openClass:"open"}),$(".sub-nav li",$("#megamenu")).on("click",function(t){$(t.target).find("a").trigger("click")}),(t=this.gcsm.getActiveComponent("main"))&&GCO5.core.GcDelayUtil.callLater(this.setMenuActiveState,[t.getShortName()],1),GCO5.appModel.getInfo("userIsLogged")&&$(".user-logged").html(GCO5.core.GcObjectUtil.isEmpty(GCO5.initInfo.libUser)?GCO5.appModel.getInfo("userLib"):GCO5.initInfo.libUser),GCO5.appModel.hasMultipleObs()&&(t=GCO5.appModel.getCurrentObs(),GCO5.core.GcDelayUtil.callLater(this.setObsMenuActive,[t],1)))}}),puremvc.define({name:"GCO5.view.mediator.AppMediator",parent:puremvc.Mediator},{gcsm:null,cli:null,onRegister:function(){this.gcsm=GCO5.core.SystemManager.getInstance(),this.cli=GCO5.core.ClientInfo.getInstance();var t=new GCO5.view.component.AppComponent;this.setViewComponent(t),this.gcsm.setAppComponent(t),this.addListeners(t),GCO5.model.maps.SelGeo.clearSession(),(GCO5.appModel=this.facade.retrieveProxy("AppProxy")).setup()},_initAppView:function(){this.viewComponent.setup({categ:"topApp"})},listNotificationInterests:function(){return[GCO5.model.proxy.AppProxy.FULLINITINFO_LOADED,GCO5.AppConstants.ON_RESIZE]},handleNotification:function(t){var e=t.getName(),i=t.getBody(),n=this.viewComponent;switch(e){case GCO5.model.proxy.AppProxy.FULLINITINFO_LOADED:this._init_jsrender(),GCO5.core.GcDelayUtil.callLater(this._initAppView,[],12,this);break;case GCO5.AppConstants.ON_RESIZE:n.onResize(i)}},addListeners:function(n){var r=this;$(n).on(GCO5.view.component.AComponent.LOAD_COMPONENT,function(t,e){var i;e.src||(e.src="app"),n.setMenuActiveState(e.id),0==e.id.indexOf("home")?(e.action||(e.action=r.facade.hasMediator("HomeMediator")?"RECALL":"NEW"),r.facade.registerMediator(new GCO5.view.mediator.HomeMediator),r.sendNotification(GCO5.AppConstants.INIT_COMPONENT,e)):(i=GCO5.core.GcStringUtil.proper(e.id)+"Mediator",r.facade.hasMediator(i)?(r.gcsm.unFreeze(e.id),e.action="RECALL",r.sendNotification(GCO5.AppConstants.INIT_COMPONENT,e)):(r.gcsm.freeze(e.id),require([e.id+"_m"],function(t){r.gcsm.unFreeze(e.id),t.initialize(),r.facade.registerMediator(new GCO5.view.mediator[i]),r.sendNotification(GCO5.AppConstants.INIT_COMPONENT,e)})))}),$(n).on(GCO5.view.component.AppComponent.POSTROBOT_MSG,function(t,e){r.sendNotification(GCO5.AppConstants.POSTROBOT_IN_MSG,e)})},_init_jsrender:function(){function e(){t.sendNotification(GCO5.AppConstants.BEFORE_PRINT)}var t=this,i=GCO5.appModel.gcDBModel,n=GCO5.core.GcLangManager.getInstance(),r=this.cli;$.views.helpers({formatNumber:$.proxy(n.formatNumber,n),lg_de_en:function(){return 0<=["de","en"].indexOf(n.getLang())},proper:GCO5.core.GcStringUtil.proper,toHTmlWithBr:GCO5.core.GcStringUtil.toHTmlWithBr,toHTmlWithSingleBr:GCO5.core.GcStringUtil.toHTmlWithSingleBr,isEmpty:GCO5.core.GcStringUtil.isEmpty,getOption:$.proxy(GCO5.appModel.getOption,GCO5.appModel),isAndroid:function(){return GCO5.browser.isAndroid},isIOS:function(){return GCO5.browser.isIOS},isTiny:function(){return r.isTinyWidthScreen()},isInIframe:function(){return r.isInIframe()},isWithoutPilotagePanel:function(){return r.isWithoutPilotagePanel()},isIPEmc3:function(){return"1"==GCO5.initInfo.ip_emc3},isLocalhost:function(){return r.isLocalhost()},hasReports:function(){return GCO5.appModel.hasReports()},hasMultipleObs:function(){return GCO5.appModel.hasMultipleObs()},hasZonages:function(){return GCO5.appModel.hasZonages()},hasExternalData:function(){return GCO5.appModel.hasExternalData()},isLocalEmc3:function(){return"1"==GCO5.initInfo.local_emc3},hasNews:function(){return GCO5.appModel.getInfo("menuResource",["news"])},hasLogin:function(){return GCO5.appModel.getInfo("menuResource",["login"])},isLogged:function(){return GCO5.appModel.getInfo("userIsLogged")},getArticle:function(){return null},getLibNivgeo:$.proxy(i.getLibNivgeo,i),getLibView:function(t){t=GCO5.appModel.getInfo("infoFromMapName",[t,"c_lib_view"]);return t?t.replace("|"," "):""},getLang:GCO5.appModel.getLang,getURLHashOnly:function(){return r.getUrlWithoutQueryString2()},getPreviousIcon:function(){return n.getTextDirection()===GCO5.core.GcLangManager.TEXT_DIRECTION_RTL?5:0},getNextIcon:function(){return n.getTextDirection()===GCO5.core.GcLangManager.TEXT_DIRECTION_RTL?0:5}}),$.views.converters({not:function(t){return!t},intToStr:function(t){return""+t},strToInt:function(t){return parseInt(t)}});window.matchMedia&&window.matchMedia("print").addListener(function(t){t.matches&&e()}),window.onbeforeprint=e}},{NAME:"AppMediator"}),GCO5.view.component.HomeComponent=GCO5.view.component.AComponent.extend({statics:{NAME:"GCO5.view.component.HomeComponent"},_initComponent:function(t){},_prepareViewData:function(t){var e=GCO5.appModel.getInfo("homePageHtml");this._viewData={appTitle:GCO5.appModel.getLegal("tit_nav"),homeHtml:e}},_fireInitEvents:function(){},goToMainContent:function(){$(".CU",this._$renderedContent).first().focus()},_onAddedToStage:function(t){this._super(t),$("body").addClass("no100vh"),this._testIfWordCloud(),this.cli.clearHash(["c","lang"]),$("img[usemap]").rwdImageMaps()},_testIfWordCloud:function(){var t=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("widget"),{c_widget_type:"TA"});1==t.length&&this._buildWordCloud(t[0].data.Tag)},_registerComponent:function(){this.setRenderedContent($("#homeComponent")),this.gcsm.setActiveComponent(this,"main"),this._super()},_stopCarrousel:function(){var t=$(".carrousel-playpause",this._$renderedContent).find("button");0==t.data("stop")&&t.get(0).click()},_onRemovedFromStage:function(){this._stopCarrousel(),this._super()},_initSubComponentsAndEnhance:function(t){this.inited&&$(".SL",this._$renderedContent).attr("data-play","demand");for(var e=document.querySelectorAll('[data-custompattern="carrousel"]'),i=0;i<e.length;i++)createCarrousel(e[i])},_addListeners:function(){var h=this;$("body").on("mousedown keydown",".widget-link",function(t){var e,i,n,r,a,s,o,l,c=t.keyCode||t.which;"keydown"==t.type&&"13"!=c&&"32"!=c||"mousedown"==t.type&&2==t.button||(t.preventDefault(),c=$(this).attr("data-cu"),t=$(this).attr("data-indic"),e=$(this).attr("data-view"),i=$(this).attr("data-news"),n=$(this).attr("data-nivgeo"),r=$(this).attr("data-codgeo"),a=$(this).attr("data-chapter"),s=$(this).attr("data-report"),o=$(this).attr("data-url"),c?(l={id:c,categ:"main",from:"home"},e&&(l.mapName=e),i&&(l.id_new=i),t&&(c=t.split("."),l.indicModel=new GCO5.model.indics.IndicModel({c_id_dataset:c[0],c_id_indicateur:c[1]})),r&&n&&(l.selgeo=new GCO5.model.maps.SelGeo({codgeo:r,nivgeo:n})),GCO5.core.GcStringUtil.isEmpty(a)||(l.chapter=a),GCO5.core.GcStringUtil.isEmpty(s)||(l.report=s),GCO5.core.GcDelayUtil.callLater(function(){$(GCO5.topApp).triggerHandler(GCO5.view.component.AComponent.LOAD_COMPONENT,l)},[],1,h)):$(this).hasClass("widget-text")&&!GCO5.core.GcStringUtil.isEmpty(o)&&(0==o.indexOf("http")?window.open(o):location.assign(o)))})},onResize:function(t,e){var i;$el=$(".row.mw1140p"),GCO5.browser.isIE&&!GCO5.browser.isEdge&&0<$(".row.mw1140p").find(".CU").length&&(i=Math.max(0,.5*($("body").innerWidth()-1140-30)),$el.css("padding-left",i+"px"),$el.css("padding-right",i+"px")),this._testIfWordCloud()},_buildWordCloud:function(t){for(var e in this.tags_lib_a=[],this.tags_pond_a=[],t)this.tags_lib_a.push(e),this.tags_pond_a.push(t[e]);this._drawWordCloud()},_drawWordCloud:function(){var o=this,t=$(".wordcloudSet",this._$renderedContent);if(0==t.children().length&&$("<div class='wordcloud'> <svg><g></g></svg> </div>").appendTo(t),t.is(":visible")){d3.scaleOrdinal(d3.schemeCategory20);for(var e=t.width(),t=t.height(),t=Math.max(t,300),i=this.tags_pond_a,l="Lato",n=10,r=e<400?35:t<600?70:100,a=(e<300&&(n=5,r=20),12<this.tags_lib_a[0].length&&100==r&&(r=Math.min(100,50*e/500/(this.tags_lib_a[0].length/13))),n=10,r=50,d3.scaleSqrt().range([n,r])),s=(a.domain([i[i.length-1]||1,i[0]]),[]),c=e<400?40:Math.min(this.tags_lib_a.length,80),h=0;h<c;h++)s.push({text:this.tags_lib_a[h],size:~~a(this.tags_pond_a[h])});n=null!=this.cloudLayout;o._cloudWidth=e,o._cloudHeight=t,n?this.cloudLayout.stop().size([e,t]).words(s).start():this.cloudLayout=d3.layout.cloud().size([e,t]).timeInterval(10).padding(2).rotate(0).font(l).fontWeight("700").fontSize(function(t){return t.size}).on("end",function(t,e){var i=o._cloudWidth,n=o._cloudHeight,r=e[0].x-(i-e[1].x),a=e[0].y-(n-e[1].y),s={id:"indicator",categ:"main",from:"cloud"},r=e?i/2-r/2:i/2,a=e?n/2-a/2:n/2,e=e?Math.min(i/(e[1].x-e[0].x),n/(e[1].y-e[0].y)):1;d3.select(".wordcloud").selectAll("text").remove(),d3.select(".wordcloud").select("svg").attr("width",i).attr("height",n).select("g").attr("transform","translate("+r+","+a+")scale("+e+")").selectAll("text").data(t,function(t){return t.text}).enter().append("text").on("click",function(t){s.tag=t.text,GCO5.core.GcDelayUtil.callLater($(GCO5.topApp).triggerHandler,[GCO5.view.component.AComponent.LOAD_COMPONENT,s],10,$(GCO5.topApp))}).style("font-size",function(t){return t.size+"px"}).style("font-family",l).attr("text-anchor","middle").attr("transform",function(t){return"translate("+[t.x,t.y]+") rotate("+t.rotate+")"}).text(function(t){return t.text}).append("svg:title").text(o.gclg.getString("TAG_SELECT_HINT","home")),$(".wordcloudSet",this.page).fadeTo(400,1)}).words(s).start()}}}),puremvc.define({name:"GCO5.view.mediator.HomeMediator",parent:puremvc.Mediator},{gcsm:null,onRegister:function(){var t=new GCO5.view.component.HomeComponent;this.setViewComponent(t),this.addListeners(t)},listNotificationInterests:function(){return[GCO5.AppConstants.INIT_COMPONENT,GCO5.AppConstants.ON_RESIZE]},handleNotification:function(t){var e=t.getName(),i=t.getBody(),n=this.viewComponent;switch(e){case GCO5.AppConstants.INIT_COMPONENT:0==i.id.indexOf("home")&&this.initComponent(i);break;case GCO5.AppConstants.ON_RESIZE:n.isVisible()&&n.onResize(i)}},initComponent:function(t){GCO5.core.GcComponentUtil.setupAndShowComponent(this.viewComponent,t)},addListeners:function(t){}},{NAME:"HomeMediator"}),puremvc.define({name:"GCO5.view.mediator.DatavizMediator",parent:puremvc.Mediator},{initComponent:function(t){GCO5.core.GcComponentUtil.setupAndShowComponent(this.viewComponent,t)},onRegister:function(){var t=new GCO5.view.component.DatavizComponent;this.setViewComponent(t),this.addListeners(t)},listNotificationInterests:function(){return[GCO5.AppConstants.INIT_COMPONENT,GCO5.AppConstants.ON_RESIZE]},handleNotification:function(t){var e=t.getName(),i=t.getBody(),n=this.viewComponent;switch(e){case GCO5.AppConstants.INIT_COMPONENT:"dataviz"==i.id&&this.initComponent(i);break;case GCO5.AppConstants.ON_RESIZE:n.isVisible()&&n.onResize()}},addListeners:function(t){}},{NAME:"DatavizMediator"}),GCO5.view.component.ZonageComponent=GCO5.view.component.AComponent.extend({statics:{NAME:"GCO5.view.component.ZonageComponent",CHANGE_MAPVIEW:"chgmv",CHANGE_INDIC:"chgind"},tableView:null,map:null,_waitingForFirstMapRendered:!0,_mapRendering:null,_fireInitEvents:function(t){var e=this._getURLState(),i="englozon";e.a&&(i=e.a),this.setObservableProperty("selectedView",this._viewData.selectedView0,{ns:"internal"}),this.setObservableProperty("selectedAction",i,{noTrigger:!0}),this._getZonIndics(),this.__setMapDimensions(this.map,!0),this._super(t)},sortViewsByNivgeo:function(t){var r=GCO5.appModel.getConcept("nivgeo_o"),a=GCO5.appModel.getConcept("view_o");return t.concat().sort(function(t,e){var t=a[t].c_id_nivgeo,i=r[t].c_nivgeos_inf,e=a[e].c_id_nivgeo,n=r[e].c_nivgeos_inf;return 0<=(i||[]).indexOf(e)?1:0<=(n||[]).indexOf(t)?-1:(i||[]).length>(n||[]).length?1:0})},saveState:function(t){return{}},getSaveState:function(){return{fav:0,study:0,url:0}},afterShow:function(){this._super(),this.alignFormLabels(".labelgroup")},goToMainContent:function(){$('[data-link="selectedAction"]',this._$renderedContent).focus()},_renderViewData:function(){this._super(),GCO5.core.GcComponentUtil.animateCollapsibleSet($("#zn_rech_geo",this._$renderedContent))},_prepareViewData:function(t){GCO5.core.GcObjectUtil.defaults(this,GCO5.view.component.MapIndicatorCommon);function e(t){return r.gclg.getString(t,"pilotage","zonage")}var r=this,a=this._viewData=this._getBaseViewData("zonage"),i=[{data:"englozon",label:e("WHICH_ZONINGS_COVER")},{data:"comparzon",label:e("COMPARE_ZONINGS")}],i={cp:"zon",filter0_a:[{data:"all",label:e("IN_THEIR_TOTALITY")},{data:"intersect",label:e("PARTIALLY_OR_TOTALLY"),suffix:{pluriel:!1},hideExceptDeborde:!0},{data:"fragmented",label:e("DIVIDED_BY"),suffix:{pluriel:!0}},{data:"included",label:e("TOTALLY_INCLUDED"),suffix:{pluriel:!1}},{data:"outside",label:e("OUTSIDE"),suffix:{pluriel:!0},hideExceptDeborde:!0},{data:"includex",label:e("INCLUDING_X"),suffix:{pluriel:!0}},{data:"smaller",label:e("INCLUDED_INTO"),suffix:{pluriel:!1}},{data:"equal",label:e("EQUAL_TO"),suffix:{pluriel:!1}}],filter_a:[],selectedRestit:"m",action_a:i,listZonIndics:[],selectedAction:"",selectedZon1:"",selectedZon2:"",rechgeo_a:[],nivgeo_a:[],zonsup_a:[],mapVisibility:!0,territoryTargeted:null,selectedFilter:"all",nbZon1:0,zon1DebordeZon2:!1,zon2Displayed:!0,selectedNivgeoSup:null,selectedZonTypo4c:null,selectedZonLayerName:null,selectedTableType:"allzon1",tablemenu_a:GCO5.appModel.getTableMenu(!0,!0),tablemenu2_a:GCO5.appModel.getTableMenu(!0,!0),mapnivgeo:"",comparezon:"",collapsibleRechGeoVisible:function(){return"position"!=this.mode},getEchos:function(){return a.rechgeo_a.filter(function(t){return t.id_view==a.id_view||1==t.inView})},search:function(){r._onSearchGeo({path:"searchStr",value:a.searchStr})},readPosition:function(){GCO5.model.maps.SelGeo.readPosition(r._readPosition,r)},displayReport:function(){$("#zon_report",r._$renderedContent).trigger("click")},saveResult:function(){console.log("saveResult")},intervert:function(){r.setObservableArray("filter_a",[]);var e=this.selectedZon1,t=r.map.getIndicsModelsIndexed()["_zon_."+this.selectedZon2];t&&(r.map.enableTheme(t),r.setObservableProperty({libIndic1:t.getProp("libIndic")})),r.setObservableProperty("selectedZon1",this.selectedZon2,{noTrigger:!0}),GCO5.core.GcDelayUtil.callLater(function(){var t=a.getZonsIndics2();0<=GCO5.core.GcArrayUtil.indexOfByKey(t,"c_id_indicateur",e)&&r.setObservableProperty("selectedZon2",e)},[],20,r),t&&(r.setObservableProperty("nbZon1All",t.getProp("firstDistribInfo").frequences.length),this.zonMim=t)},getZonsIndics1:function(){var t=GCO5.core.GcArrayUtil.getColumnByKey(this.listZonIndics,"c_id_indicateur");return this.listZonIndics.filter(function(i){var n=GCO5.core.GcArrayUtil.getColumnByKey(GCO5.appModel.getInfo("SubNivgeos",[i.c_id_indicateur]),"nivgeo");return n.push(i.c_id_indicateur),0<t.filter(function(t){var e=GCO5.core.GcArrayUtil.getColumnByKey(GCO5.appModel.getInfo("SubNivgeos",[t]),"nivgeo");return t!=i.c_id_indicateur&&0<GCO5.core.GcArrayUtil.intersection(n,e).length}).length})},getZonsIndics2:function(){var i=GCO5.core.GcArrayUtil.getColumnByKey(GCO5.appModel.getInfo("SubNivgeos",[this.selectedZon1]),"nivgeo");return i.push(this.selectedZon1),this.listZonIndics.filter(function(t){var e=GCO5.core.GcArrayUtil.getColumnByKey(GCO5.appModel.getInfo("SubNivgeos",[t.c_id_indicateur]),"nivgeo");return e.push(t.c_id_indicateur),0<GCO5.core.GcArrayUtil.intersection(i,e).length}).filter(function(t){var e=r._getSubMapView(a.selectedZon1,t.c_id_indicateur,null,!0);if(e){var i=0<e.length?e.pop():null;if(0<GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("viewLayers"),{cle:i,c_purpose:["Z"],c_id_nivgeo:t.c_id_indicateur}).length)return!0;if(0<e.length)for(var n in e.reverse())if(0<GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("viewLayers"),{cle:e[n],c_purpose:["Z"],c_id_nivgeo:t.c_id_indicateur}).length)return!0}return!1})}};i.collapsibleRechGeoVisible.depends="mode",i.getZonsIndics1.depends="listZonIndics.**",i.getZonsIndics2.depends=["selectedZon1","selectedExtent"],GCO5.core.GcObjectUtil.extend(this._viewData,i),this._viewData.structuredByExtent&&this.gcsm.getCuState("view")&&(this._viewData.selectedExtent0=this._viewData.selectedExtent=GCO5.appModel.getInfo("infoFromMapName",[this.gcsm.getCuState("view"),"id_extent"]),i=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("view"),{id_extent:this._viewData.selectedExtent}),this._viewData.selectedView0=i[0].pk)},_hasZonageForView:function(t,e){e=GCO5.appModel.getInfo("ViewDef",[e]).zonages;return 0<=GCO5.core.GcArrayUtil.indexOfByKey(e,"c_id_nivgeo",t)},_getSubMapView:function(t,e,i,n){var r=GCO5.core.GcArrayUtil.getColumnByKey(GCO5.appModel.getInfo("SubNivgeos",[t]),"nivgeo"),a=(r.push(t),this._viewData.selectedExtent),s=GCO5.appModel.getInfo("MapNamesFromNivgeos",[r,a,"pk"]);if(0==s.length&&(s=GCO5.appModel.getInfo("MapNamesFromNivgeo",[t,null,"pk"])),!e){if(0==s.length)return null;t=i?s.indexOf(i):0;return s[t=t<0?0:t]}s=GCO5.core.GcArrayUtil.getColumnByKey(GCO5.appModel.getInfo("SubNivgeos",[e]),"nivgeo"),s.push(e),t=GCO5.core.GcArrayUtil.intersection(r,s);if(0==t.length)return null;e=GCO5.appModel.getInfo("MapNamesFromNivgeos",[t,a,"pk"]);return 0<e.length?0<=e.indexOf(i)?i:n?e:e[e.length-1]:0<(e=GCO5.appModel.getInfo("MapNamesFromNivgeos",[t,null,"pk"])).length?n?e:e[0]:null},_getZonIndics:function(){this.gcsm.freeze("zonindics"),GCO5.appModel.getListIndics(this._onZonIndics,this,{typind:"Z"})},_onZonIndics:function(t,e){t=t.indics.concat().sort(function(t,e){return t.c_lib_indicateur_court.localeCompare(e.c_lib_indicateur_court)});this.setObservableArray("listZonIndics",t),this.gcsm.unFreeze("zonindics")},_onAddedToStage:function(t){this._super(t),this.cli.clearHash()},setupMap:function(t){t.mapContainer=$(".mapContainer",this._$renderedContent),t.styles.drillMaps=!1,t.styles.extent0=t.extent?new GCO5.model.maps.GeoExtent(t.extent):this._viewData.extent0,t.legendContainer={cv:null,divH:$(".maplegendH",this._$renderedContent),div:$(".maplegendV",this._$renderedContent)},t.copyrights=GCO5.appModel.getInfo("infoFromMapName",[t.mapName,"copyrights"]),t.id_view=GCO5.appModel.getInfo("infoFromMapName",[t.mapName,"c_id_view"]),t.styles.zonagesOnly=!0,this.__setMapDimensions(this.map,!0);var e,i=GCO5.core.GcArrayUtil.indexOfByKey(t.layers,"name",GCO5.appModel.getFirstAdminLayerName(t.mapName));0<=i&&t.layers.splice(i,1),this.map?(t.selgeo=this.selgeoTarget,this.map.setup(t),this._syncUIAfterChangeMapView(t),this._viewData.changingViewKeepZons&&(this.setObservableProperty("selectedZon2",this._viewData.selectedZon2,{forceTrigger:!0}),e=this,GCO5.core.GcDelayUtil.callLater(function(){e._viewData.changingViewKeepZons=!1},[],1,e))):(this.map=new GCO5.view.component.MapViewThematic(t),this._addMapListeners()),this._updateStatLayerStrokeStyle(),this.setObservableProperty("mapnivgeo",this.map.getIdNivgeo()),this._viewData.structuredByExtent&&this.gcsm.registerCuState("extent",this.map.getIdExtent())},_syncUIAfterChangeMapView:function(t){var e=this._viewData,i=GCO5.appModel.getInfo("infoFromMapName",[t.mapName,"id_extent"]);i!=e.selectedExtent&&this.setObservableProperty("selectedExtent",i,{noTrigger:!0}),e.selectedView="",this.setObservableProperty("selectedView",t.mapName,{noTrigger:!0,ns:"internal"});i=this.map.getIndicsModelsIndexed()["_zon_."+this._viewData.selectedZon1];i&&(this._viewData.zonMim=i,this.setObservableProperty({libIndic1:i.getProp("libIndic")}),this.setObservableProperty("nbZon1All",i.getProp("firstDistribInfo").frequences.length))},_updateStatLayerStrokeStyle:function(t){},_updZonLayer:function(t,e){e=e||{};var i=this.map,n=i.zon1LayerName,n=(n&&(i.removeLayer(n,!e.render),i.zon1LayerName=null),[{name:t,refgeo:1}]);GCO5.core.GcStringUtil.isEmpty(t)||(i.zon1LayerName=n[0].name,this.gcsm.freeze("map",null,!0),GCO5.appModel.loadLayers(this._onLayersLoaded,this,n,!0,i.getName(),"addLayer"))},_onLayersLoaded:function(t,e){var i=GCO5.core.GcObjectUtil.getFirstKey(t),t=GCO5.appModel.getInfo("habillLayerLoaded",[this.map.getName(),i,t,this._isZonage(i)]);t.zOrder=this._isZonage(t.name)?this.map.getNewZonIndex():this.map.getNewHabillIndex(t.zOrder),this._isZonage(t.name)&&(t.styles.lineWidth=(t.is_partition,1),t.styles.strokeStyle="#777"),this.map.addLayer(t),this.gcsm.unFreeze("map",10)},_isZonage:function(t){return t==this.map.zon1LayerName},_updHabillLayer:function(t,e){e?"V"==t?this.map.addLayer({name:"V"}):(this.gcsm.freeze("map",null,!0),GCO5.appModel.loadLayers(this._onLayersLoaded,this,[{name:t,refgeo:0}],!1,null,"addLayer")):this.map.removeLayer(t,!0)},_onRemovedFromStage:function(){var t=this.map.getSelgeo();t&&t.setDefaultStyles(),this._super()},_onEndRenderMap:function(){this.gcsm.unFreeze("render"),this._waitingForFirstMapRendered||this._updateHashAfterRenderMap(),this._pendingZonLayer&&(this._pendingZonLayer=!1,this._updZonLayer(this._viewData.selectedZonLayerName)),this._waitingForFirstMapRendered=!1},_addListeners:function(){var s=this,o=this._viewData,r=this.constructor;$.observe(o,"zon2Displayed",function(t,e){o.noTrigger||(e=e.value,s._setZon2Visibility(e))}),$.observe("internal",o,"selectedView",function(t,e){var i;o.noTrigger||(e=e.value,s.map&&"englozon"==o.selectedAction&&""==t.namespace&&s._reinitComponent(),o.compthismap&&s.setObservableProperty("compthismap",!1),"comparzon"==o.selectedAction&&(o.changingViewKeepZons?s.map&&(i=s.map.getEnabledIndicsModelsIndexed()):(o.noTrigger=!0,s.setObservableProperty("selectedZon1",""),o.noTrigger=!1)),$(s).triggerHandler(r.CHANGE_MAPVIEW,[e,null,i]))}),$.observe(o,"selectedExtent",function(t,e){o.noTrigger||(e=e.value,o.structuredByExtent&&(o.selectedExtent0=e,e=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("view"),{id_extent:o.selectedExtent}),o.selectedView0=e[0].pk))}),$.observe(o,"selectedAction",function(t,e){o.noTrigger||(e=e.value,0==s._viewData.listZonIndics.length&&s._getZonIndics(),s._reinitComponent("selectedAction"),s._setZon2Visibility(!1),s.map.clearSel(),s.map.mapToolTip.clear(),s.map.removeAllThemes({noRender:!0}),s.setObservableProperty({libIndic1:""}),s.tableView&&("englozon"==e?s.tableView.hide():s.tableView.show()),o.selectedView0!=o.selectedView?GCO5.core.GcDelayUtil.callLater(s.setObservableProperty,["selectedView",o.selectedView0,{ns:"internal"}],20,s):GCO5.core.GcDelayUtil.callLater(s.map.zoomOnFullExtent,[],30,s.map))}),$.observe(o,"selectedFilter",function(t,e){o.noTrigger||(e=e.value,$("#zon_map",s._$renderedContent).trigger("click"),s._onFilterZonComp(e))}),$.observe(o,"selectedZon1",function(t,e){if(!o.noTrigger){e=e.value;if($("#zon_map",s._$renderedContent).trigger("click"),s.setObservableProperty("selectedFilter","all",{noTrigger:!0}),s.setObservableProperty("selectedZon2",""),s.map.removeAllThemes({noRender:""!=e}),s.setObservableProperty({libIndic1:""}),""!=e){var i=GCO5.core.GcArrayUtil.getSubArray(o.listZonIndics,{c_id_indicateur:e}),n=new GCO5.model.indics.IndicModel(i[0]),e=s._getSubMapView(e,null,o.selectedView);if((e=i[0].c_id_views.indexOf(e)<0?s.sortViewsByNivgeo(i[0].c_id_views)[0]:e)!=o.selectedView)return o.changingViewKeepZons=!0,void $(s).triggerHandler(r.CHANGE_INDIC,[!0,n,{id_view:e,id_extent:GCO5.appModel.getInfo("infoFromMapName",[e,"id_extent"])}]);GCO5.appModel.loadMapIndic(s._onLoadIndicData,s,n,s.map)}}}),$.observe(o,"selectedZon2",function(t,e){e=e.value;if(""==e&&(s._updZonLayer(null,{render:!0}),o.mapIndicModel&&s.setObservableProperty({libIndic1:o.mapIndicModel.getProp("libIndic")})),!o.noTrigger&&""!=o.selectedZon1&&""!=e&&o.selectedZon1!=e){$("#zon_map",s._$renderedContent).trigger("click");var i=s._getSubMapView(o.selectedZon1,e,s.map.getIdView());if(i!=o.selectedView)return console.log("selectedZon2 changement de vue ???",o.selectedZon1,e,o.selectedView,"==>",i),o.changingViewKeepZons=!0,void s.setObservableProperty("selectedView",i,{ns:"internal"});GCO5.appModel.loadZonComp(s._onLoadZoncomp,s,{zon1:o.selectedZon1,zon2:o.selectedZon2,idView:s.map.getIdView()})}}),$("[data-link='searchStr']",this._$renderedContent).on("keydown",function(t){var e=t.keyCode||t.which;"keydown"==t.type&&"13"!=e||($("#zon_map",s._$renderedContent).trigger("click"),s._onSearchGeo({path:"searchStr",value:$(this).val()}),s.setObservableProperty("territoryTargeted",null))}),$(".ui-collapsible-set",this._$renderedContent).add($("#positionList",this._$renderedContent)).on("click","li",function(t){t=$(t.currentTarget),t=o.rechgeo_a[parseFloat(t.data("uid"))],s.setObservableProperty("territoryTargeted",t),s._updateStatLayerStrokeStyle(!0),o.selectedNivgeoSup=null,GCO5.appModel.searchGeoByCodgeo(s._onResultSearchGeo2,s,t.nivgeo,t.codgeo),t={codgeo:t.codgeo,nivgeo:t.nivgeo};GCO5.appModel.searchSurroundGeo(s._onSearchSurroundGeo,s,t),$("#zon_sel_tab",s._$renderedContent).trigger("click")}),$("#zonSupList",this._$renderedContent).on("click","li",function(t){var t=$(t.target).closest("li"),i=(t.closest("ul").find("li").removeClass("selected"),t.addClass("selected"),o.zonsup_a[parseFloat(t.data("uid"))]),n=(i.id_extent=s.map.getIdExtent(),s.map.getLyStatName()),r=o.selectedNivgeoSup,a=(o.selectedNivgeoSup=i.nivgeo,new GCO5.model.maps.SelGeo(i));a.setStyles({strokeStyle:"#00f",fillUniqueSel:null}),i.nivgeo!=r&&s.map.removeLayer(s.map.zon1LayerName,!0),s._updateStatLayerStrokeStyle(!0),a.getSelIds(s.map.nivgeo,s.map.getIdExtent(),function(){var t,e;i.nivgeo!=r&&(s.map.removeAllThemes({noRender:!0}),s.setObservableProperty({libIndic1:""})),s.map.zoomOnFeatureId(n,a.getSelIds()),o.selgeoSup=a,i.nivgeo!=r&&(t=GCO5.core.GcArrayUtil.getSubArray(o.listZonIndics,{c_id_indicateur:i.nivgeo}),e=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("viewLayers"),{cle:s.map.getName(),c_purpose:"Z",c_id_nivgeo:i.nivgeo}),o.selectedZonLayerName=1==e.length?e[0].c_id_layer:null,0<t.length?(e=new GCO5.model.indics.IndicModel(t[0]),GCO5.core.GcDelayUtil.callLater(GCO5.appModel.loadMapIndic,[s._onLoadIndicData,s,e,s.map],65,GCO5.appModel)):s.map.drawSelgeo(a,n,!0))})}),$("#zon_map",this._$renderedContent).closest("ul").on("click keydown",".tabs__link",function(t,e){"keydown"==t.type&&13!=t.keyCode||("zon_map"!=t.target.id||e&&e.noResize||GCO5.core.GcDelayUtil.callLater(s.onResize,[],1,s),$(t.target).closest(".js-tablist").find("a").removeClass("highlighted"),$(t.target).addClass("highlighted"),s.setObservableProperty("selectedRestit",t.target.id.substr(0,1)),"zon_report"!=t.target.id&&s.tableView&&s.tableView.onRemovedFromStage())}),$("#zon_report",this._$renderedContent).on("click",function(t){$("#zon_nav_2",s._$renderedContent).is(":visible")||GCO5.core.GcDelayUtil.callLater(s._displayTableView,[],2,s)}),$("#zon-prolonger",this._$renderedContent).on("click","a",function(t){$(GCO5.topApp).triggerHandler(GCO5.view.component.AComponent.LOAD_COMPONENT,{id:$(this).data("cu"),categ:"main"})}),$.observe(o,"selectedTableType",$.proxy(this._setTableType,this)),this.addMixinListeners()},_getZon1RefData:function(){return GCO5.appModel.getRefData(this._viewData.selectedZon1,this.map.getIdExtent())},_setTableType:function(){var t,e,i,n,r,a=this._viewData;a.noTrigger||(t=a.selectedTableType,e=this._getZon1RefData(),i=this.tableView,n=[{id:"codgeo",lib:this.gclg.getString("CODE"),align:"l"},{id:"libgeo",lib:this.gclg.getString("LABEL"),align:"l"}],a.mapnivgeo!=a.selectedZon1&&n.push({id:"eft",lib:this.gclg.getString("NB_OF")+" "+GCO5.appModel.getInfo("libNivgeo",[a.mapnivgeo,!0,!0]),align:"r"}),this.getViewData().selectedTableRef=GCO5.appModel.getInfo("infoFromMapName",[this.map.getName(),"pkgeo"]),"allzon1"==t?(r=i.buildDatasetFromArrays(e,n),i.clear(),GCO5.core.GcDelayUtil.callLater(i.callDataTableFromFreeDataset,[r,n],5,i)):"filt"==t?(r=i.buildDatasetFromArrays(e,n,a.filterZon1Index),i.clear(),GCO5.core.GcDelayUtil.callLater(i.callDataTableFromFreeDataset,[r,n],5,i)):GCO5.core.GcDelayUtil.callLater(i.setRef,[],5,i))},_initTableView:function(t){this.tableView||(this.tableView=new GCO5.view.component.TableView({map:this.map,ca:this,noRender:t.noRender,hide:"englozon"==this._viewData.selectedAction}),"englozon"!=this._viewData.selectedAction&&this.setObservableProperty("selectedTableType","allzon1",{forceTrigger:!0}))},_displayTableView:function(){var t=this.tableView,e=this,i=[];if("englozon"==this._viewData.selectedAction)return t?void 0:(e.gcsm.freeze("tables_m"),void require(["tables_m"],function(t){e.gcsm.unFreeze("tables_m"),t.initialize(),e._initTableView({noRender:"englozon"==e._viewData.selectedAction})}));if(t&&t.syncWithMap(this.map.getIndicsModelsIndexed(),!0),!t)return e.gcsm.freeze("tables_m"),void require(["tables_m"],function(t){e.gcsm.unFreeze("tables_m"),t.initialize(),e._initTableView({noRender:"englozon"==e._viewData.selectedAction||!0}),0<i.length&&e._displayTableView()});GCO5.core.GcDelayUtil.callLater(function(){e.setObservableProperty("selectedTableType","allzon1",{forceTrigger:!0})},[],10,t)},_reinitComponent:function(t){var e=this._viewData;this.setObservableProperty("territoryTargeted",null),this.setObservableArray("rechgeo_a",[]),this.setObservableArray("zonsup_a",[]),this.setObservableProperty("selectedZon1",""),e.selectedZon2="",e.zon2Displayed=!0,e.selectedNivgeoSup=null,e.selectedZonTypo4c=null,e.selectedZonLayerName=null,e.selgeoSup=null,this.setObservableProperty("searchStr",""),this._updateStatLayerStrokeStyle(),$("#zon_nav_1",this._$renderedContent).removeClass("noSelInfoInFooter"),$(".rechgeo_msg",this._$renderedContent).hide(),$(".zonsup_msg",this._$renderedContent).hide(),$("#zon_map",this._$renderedContent).trigger("click")},_compareZonInclusion:function(t,e){this._viewData;var i=GCO5.appModel.getInfo("surNivgeos",[t]),n=GCO5.appModel.getInfo("surNivgeos",[e]);return 0<=GCO5.core.GcArrayUtil.indexOfByKey(i,"id_nivgeo",e)?"<":0<=GCO5.core.GcArrayUtil.indexOfByKey(n,"id_nivgeo",t)?">":""},_onLoadZoncomp:function(t){var e,i=this._viewData,n={nb_all:0,nb_fragmented:0,nb_intersect:0,nb_outside:0,nb_included:0,nb_smaller:0},t=(i.compare_a=t.compare_a,i.zonindex_o=GCO5.core.GcArrayUtil.toIndexedObj(t.compare_a,i.selectedZon1),this._compareZonInclusion(i.selectedZon1,i.selectedZon2)),r=("<"==t&&(e={},i.compare_a.forEach(function(t){t=t["max_"+i.selectedZon2];e[t]||(e[t]=0),e[t]++})),this._setZon2Visibility(!0),0);i.compare_a.forEach(function(t){n.nb_all++,"1"==t.fragmented&&n.nb_fragmented++,"1"==t.deborde&&r++,("1"==t.fragmented||"0"==t.deborde&&"0"==t.fragmented)&&n.nb_intersect++,"1"==t.deborde&&"0"==t.fragmented&&n.nb_outside++,"0"==t.deborde&&"0"==t.fragmented&&n.nb_included++,e&&1<e[t["max_"+i.selectedZon2]]&&(t.smaller=1,n.nb_smaller++)}),n.nb_includex=">"==t?n.nb_fragmented:0,n.nb_equal=">"==t?n.nb_included:0,"<"==t&&(n.nb_equal=n.nb_all-n.nb_smaller),this.setObservableProperty("comparezon",t),this.setObservableProperty("zon1DebordeZon2",0<r),this.setObservableProperty("nbZon1All",n.nb_all),this.setObservableProperty("nbZon1",n.nb_all),this.setObservableProperty("nbZon1Outside",n.nb_outside),this.setObservableProperty("nbZon1Fusionned",n.nb_includex),this.setObservableProperty("nbZon1EqualZon2",n.nb_equal),this.setObservableProperty("nbSmallerIncluded",n.nb_smaller),n.nb_fragmented=">"==t?0:n.nb_fragmented,n.nb_included=">"==t?0:n.nb_included,"<"==t&&(n.nb_included=0),i.filter0_a.forEach(function(t){t.eft=n["nb_"+t.data]}),this.setObservableArray("filter_a",[]),this.setObservableArray("filter_a",i.filter0_a);this.map.getIndicsModelsIndexed()["_zon_."+i.selectedZon2]||(t=GCO5.core.GcArrayUtil.getSubArray(i.listZonIndics,{c_id_indicateur:i.selectedZon2}),t=new GCO5.model.indics.IndicModel(t[0]),GCO5.appModel.loadMapIndic(this._onLoadIndicData2,this,t,this.map)),this.setObservableProperty("selectedFilter","all");t=0<=["de","en"].indexOf(this.gclg.getLang());this.setObservableProperty({libIndic1:this._viewData.zonMim.getProp("libIndic")+", "+this.gclg.getString("COMPARED_WITH","pilotage","zonage")+" "+GCO5.appModel.getInfo("libNivgeo",[i.selectedZon2,!t,!0])})},_setZon2Visibility:function(t){var e;t?(t=this._viewData,e=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("viewLayers"),{cle:this.map.getName(),c_purpose:["Z"],c_id_nivgeo:t.selectedZon2}),t.selectedZonLayerName=1==e.length?e[0].c_id_layer:null,t.selectedZonLayerName?GCO5.core.GcDelayUtil.callLater(this._updZonLayer,[t.selectedZonLayerName],10,this):this.map.zon1LayerName&&this._updZonLayer(null,{render:!0})):this._updZonLayer(null,{render:!0})},_onFilterZonComp:function(t){var e=this._viewData;if("all"==t)return e.filterZon1Index=null,e.zonMim.choroCodes=null,this.map.updTheme(e.zonMim),void this.setObservableProperty("nbZon1",e.nbZon1All);var i,n={},r=0;"fragmented"==t||"includex"==t?i=function(t){"1"==t.fragmented&&(r++,n[t[e.selectedZon1]]=1)}:"included"==t||"equal"==t?i=function(t){"0"==t.deborde&&"0"==t.fragmented&&void 0===t.smaller&&(r++,n[t[e.selectedZon1]]=1)}:"outside"==t?i=function(t){"1"==t.deborde&&"0"==t.fragmented&&(r++,n[t[e.selectedZon1]]=1)}:"intersect"==t?i=function(t){("1"==t.fragmented||"0"==t.deborde&&"0"==t.fragmented)&&(r++,n[t[e.selectedZon1]]=1)}:"smaller"==t&&(i=function(t){1==t.smaller&&(r++,n[t[e.selectedZon1]]=1)}),e.compare_a.forEach(i),this.setObservableProperty("nbZon1",r),e.zonMim.choroCodes=e.zonMim.getProp("zonageChoroCodesFiltered",n),this.map.updTheme(e.zonMim),e.filterZon1Index=n},_onBuildInfosel:function(){var t=this.map.getSelgeo(),e=this._viewData.territoryTargeted,i=e?e.nivgeo+"|"+e.codgeo:null;if("englozon"==this._viewData.selectedAction&&t){if(t&&(!e||i!=t.getPkGeo())){if(!t.getSingleCodgeo())return void this.map.clearSel();t.setStyles({strokeStyle:"#00f",fillUniqueSel:null}),$("#zon_nav_1",this._$renderedContent).addClass("noSelInfoInFooter"),this.setObservableProperty("territoryTargeted",{codgeo:t.codgeo,nivgeo:t.nivgeo,libgeo:t.libgeo,lib_nivgeo:t.getLibNivgeo()}),GCO5.appModel.searchSurroundGeo(this._onSearchSurroundGeo,this,{codgeo:t.codgeo,nivgeo:t.nivgeo}),$("#zon_sel_tab",this._$renderedContent).trigger("click")}this._updateFooter(t)}},_updateFooter:function(t){var e,i=0<=["de","en"].indexOf(this.gclg.getLang()),n=this.map.$legDivContainerH.find(".mapLibView"),t=this.gclg.getString("TERRITORY","concepts")+this.gclg.getString("P2")+" "+t.getLibSelExtended(!0,!1,!0,!i);this._viewData.selgeoSup&&0<(e=GCO5.core.GcArrayUtil.getSubArray(this._viewData.zonsup_a,{nivgeo:this._viewData.selectedNivgeoSup})).length&&((e=e[0]).codgeo&&(e.id_extent=this.map.getIdExtent()),this._viewData.selgeoSup=new GCO5.model.maps.SelGeo(e),t+="<br>"+this.gclg.getString("INCLUDING_AREA","pilotage","zonage")+this.gclg.getString("P2")+" "+this._viewData.selgeoSup.getLibSelExtended(!0,!1,!0,!i)),n.css({display:"flex","max-width":"750px"}).find("p").html(t)},_onLoadIndicData:function(t,e){t&&t.isMapIndicModel?((this._viewData.mapIndicModel=t).resetParams("calcs"),this.setObservableProperty({libIndic1:t.getProp("libIndic")}),this._viewData.zonMim=this._viewData.mapIndicModel=t,this.map.addTheme(t,{render:!0}),this._viewData.selectedZonLayerName&&"englozon"==this._viewData.selectedAction&&(this._pendingZonLayer=!0),this.setObservableProperty("nbZon1All",t.getProp("firstDistribInfo").frequences.length)):console.warn("indic zonage non disponible",t.getPk())},_onLoadIndicData2:function(t,e){t.disable(),this.map.addTheme(t,{render:!1})},_onSearchSurroundGeo:function(t){var e=this._viewData,t=t.rech_a.filter(function(t){return 0<=GCO5.core.GcArrayUtil.indexOfByKey(e.listZonIndics,"c_id_indicateur",t.nivgeo)});this.setObservableArray("zonsup_a",t),$(".errMsg.zonsup_msg",this._$renderedContent).hide(),0==t.length?$(".errMsg.zonsup_msg",this._$renderedContent).show():((t=this.map.getSelgeo())&&t.getSingleCodgeo()&&this._updateFooter(t),e.selectedNivgeoSup&&0<(t=GCO5.core.GcArrayUtil.indexOfByKey(e.zonsup_a,"nivgeo",e.selectedNivgeoSup))&&$("#zonSupList li",this._$renderedContent).eq(t).trigger("click"))},_readPosition:function(t){var i;t?(t.view=this._viewData.structuredByExtent?this.map.getIdView():this._viewData.selectedView0,this.setObservableProperty("mode","position"),this._reinitComponent(),this.map.clearSel(),this.setObservableProperty("selectedView",t.view,{ns:"internal"}),i=this,GCO5.appModel.getZonsAroundPosition(function(t,e){i.__onResultSearchGeo.call(i,t,"","position",i._viewData.viewNivgeos)},this,t)):$(".rechgeo_msg",this._$renderedContent).show()},_onSearchGeo:function(t){var e,i,n,r=this,t=(t.path,t.value);this.setObservableProperty("mode","key"),t&&!GCO5.core.GcStringUtil.isEmpty(t)&&(""==t?this._clearSearchGeo():($(".rechgeo_msg",this._$renderedContent).hide(),this._updZonLayer(null),this.map.clearSel(),this.map.removeAllThemes({noRender:!1}),e=this._viewData.selectedView,i=r._viewData.viewNivgeos,n=this._viewData.mode,GCO5.appModel.searchGeoByKey(function(t,e){r.__onResultSearchGeo.call(r,t,e,n,i),r.setObservableArray("zonsup_a",[]),r._viewData.selgeoSup=null,r.setObservableProperty({libIndic1:""}),$("#zon_list_tab",r._$renderedContent).trigger("click"),r.setObservableProperty("territoryTargeted",null)},this,t,e)))},_onResultSearchGeo2:function(t){var e=this._viewData.territoryTargeted,i=0;if(this.map&&e.inView)for(var n in t.rech_a)if(t.rech_a[n].idView==this.map.getName()){i=+n;break}var r=t.rech_a[i].idView,a=GCO5.appModel.getInfo("infoFromMapName",[r,"pk","id_view"]),r=(e.id_extent=GCO5.appModel.getInfo("infoFromMapName",[r,"id_extent","id_view"]),e.id=t.rech_a[i].fid,this.selgeoTarget=new GCO5.model.maps.SelGeo(e));r.setStyles({strokeStyle:"#00f",fillUniqueSel:null}),$("#zon_nav_1",this._$renderedContent).addClass("noSelInfoInFooter"),e.inView?this.map.drawSelgeo(r,this.map.getStatLayerName(),!0):(r.sessionRegister(),this.setObservableProperty("selectedView",a,{ns:"internal"}))},_updateHashAfterRenderMap:function(){if(!this.gcsm.historyBrowsing){var t,e=$.bbq.getState(),i=(this.map.getEnabledIndicsModelsIndexed(),{});for(t in e)["a","f","z1","z2"].indexOf(t)<0&&(i[t]=e[t]);GCO5.core.GcObjectUtil.equal(i,e)||$.bbq.pushState(i,2)}},onHashChange:function(t){var e;t.page&&(this._super(),(t=t.page.replace(/\_/g,"|"))!=(e=$("#rep_page_cb")).val()&&(e.val(t),e.trigger("change")))},_clearSearchGeo:function(){},xlsx:function(t,e){var i=[],n=[],r=[],a=this.tableView,s=GCO5.appModel.getInfo("infoFromMapName",[this.map.getName(),"c_lib_view"]);if(r.push(GCO5.appModel.getLegal("tit_nav")),"englozon"==this._viewData.selectedAction){for(var o=0;o<this._viewData.zonsup_a.length;o++){var l=this._viewData.zonsup_a[o];i.push([l.nivgeoLib,l.codgeo+" - "+l.libgeo])}var c=this._viewData.territoryTargeted,c=(r.push(this.gclg.getString("INCLUDING_ZONINGS","pilotage","zonage")+this.gclg.getString("P2B")+" "+c.lib_nivgeo+", "+c.libgeo+" ("+c.codgeo+")"),[{wch:40},{wch:40}]),h=(n=[this.gclg.getString("ZONING","concepts"),this.gclg.getString("CODE")+" - "+this.gclg.getString("LABEL")],"Data"),d=GCO5.core.GcXlsUtil.writeDatasetToSheet(i,n,r,!0);return(p={SheetNames:[],Sheets:{}}).SheetNames.push(h),(p.Sheets[h]=d)["!cols"]=c,void GCO5.core.GcDelayUtil.callLater(function(){GCO5.core.GcXlsUtil.saveXlsFile(p,"data."+t,t),$(".msg",e._$container).text("")},[],10,this)}var u,p,g=this._viewData.selectedTableType,f=this._getZon1RefData(),n=[{id:"codgeo",lib:this.gclg.getString("CODE"),align:"l"},{id:"libgeo",lib:this.gclg.getString("LABEL"),align:"l"},{id:"eft",lib:this.gclg.getString("NB_OF")+" "+GCO5.appModel.getInfo("libNivgeo",[this._viewData.mapnivgeo,!0,!0]),align:"r"}],c=("allzon1"==g?(r.push(GCO5.appModel.getInfo("libNivgeo",[this._viewData.selectedZon1,!0,!0])),i=a.buildDatasetFromArrays(f,n)):"filt"==g?(u=$("input[name=filters]:checked",this._$renderedContent),r.push(GCO5.appModel.getInfo("libNivgeo",[this._viewData.selectedZon1,!0,!0])+" "+$.trim(u.closest("label").text())),i=a.buildDatasetFromArrays(f,n,this._viewData.filterZon1Index)):GCO5.core.GcDelayUtil.callLater(a.setRef,[],5,a),[{wch:6},{wch:40},{wch:20},{wch:20},{wch:20},{wch:20},{wch:20}]),h="Data";"allzon1"==g||"filt"==g?(n=GCO5.core.GcArrayUtil.getColumnByKey(n,"lib"),d=GCO5.core.GcXlsUtil.writeDatasetToSheet(i,n,r,!0)):(r.push(this.gclg.getString("REFGEO")+this.gclg.getString("P2B")+" "+s.replace("|"," ")),d=(u=e.getMapDataset().prepareForXls()).ws,c=u.wscols),(p={SheetNames:[],Sheets:{}}).SheetNames.push(h),(p.Sheets[h]=d)["!cols"]=c,GCO5.core.GcDelayUtil.callLater(function(){GCO5.core.GcXlsUtil.saveXlsFile(p,"data."+t,t),$(".msg",e._$container).text("")},[],10,this)}}),puremvc.define({name:"GCO5.view.mediator.ZonageMediator",parent:puremvc.Mediator},{gcsm:null,initComponent:function(t){GCO5.core.GcComponentUtil.setupAndShowComponent(this.viewComponent,t)},onRegister:function(){this.gcsm=GCO5.core.SystemManager.getInstance();var t=new GCO5.view.component.ZonageComponent;this.setViewComponent(t),this.addListeners(t)},listNotificationInterests:function(){return[GCO5.AppConstants.INIT_COMPONENT,GCO5.AppConstants.ON_RESIZE]},handleNotification:function(t){var e=t.getName(),i=t.getBody(),n=this.viewComponent;switch(e){case GCO5.AppConstants.INIT_COMPONENT:"zonage"==i.id&&this.initComponent(i);break;case GCO5.AppConstants.ON_RESIZE:n.onResize()}},addListeners:function(r){var a=this,t=r.constructor;$(r).on(t.CHANGE_MAPVIEW,function(t,e,i,n){a.gcsm.freeze("render"),GCO5.appModel.loadMapViewModel(a.onChangeMapView,a,e,i,n)}),$(r).on(GCO5.view.component.MapView.INFOSEL,function(t,e){r._onBuildInfosel()}),$(r).on(t.CHANGE_INDIC,function(t,e,i,n){i=i.isIndicModel?i:new GCO5.model.indics.IndicModel(i);GCO5.appModel.loadMapIndic(a._onLoadIndicData,a,i,r.map,n)})},_onLoadIndicData:function(t,e,i){var n=this.viewComponent;e&&t.isIndicModel&&(e=e[0],t=n.map.getNewMapIndicsInfoAfter(t,"add"),GCO5.appModel.loadMapViewModel(n.setupMap,n,e,null,t.indicsModelRetained,null,!1))},onChangeMapView:function(t){var e=this.viewComponent;GCO5.model.maps.SelGeo.getcurSelgeo();e.setupMap(t)}},{NAME:"ZonageMediator"}),GCO5.view.component.ReportComponent=GCO5.view.component.AComponent.extend({statics:{NAME:"GCO5.view.component.ReportComponent",CHANGE_MAPVIEW:"chgmv"},gcDashboardModel:null,reportLayout:null,reportMode:null,map:null,_waitingForFirstMapRendered:!0,_mapRendering:null,_fireInitEvents:function(t){GCO5.core.GcComponentUtil.animateCollapsibleSet($(".treereports",this._$renderedContent)),this.setObservableProperty("selectedChapter",this._viewData.selectedChapter,{forceTrigger:!0}),this.__setMapDimensions(this.map,!0),this._super(t)},_getReportsForSelgeo:function(e){var i=this._viewData;return i.report_a.filter(function(t){return i.isReportCompatibleWithSelgeo(t,e)})},_hasReportsForSelgeo:function(t){return 0<this._getReportsForSelgeo(t).length},_onAddedToStage:function(t){var e,i,n=this._viewData,r=this._enrichSelgeo_a(),a=(n._selgeo_a=r.concat(),this.setObservableArray("selgeo_a",r),this.setObservableProperty("savedSelgeosLength",r.length),t.selgeo||GCO5.model.maps.SelGeo.getcurSelgeo()||n.selgeo1),s=null!=a&&this._hasReportsForSelgeo(a),o=!1,r=(s||(a=this._getDefaultReportSelgeo(n.selectedReport),o=!0),"PT"==a.getTopology()&&GCO5.appModel.loadRefData(function(){var i=GCO5.appModel.getRefData(a.nivgeo),t=i.codgeo.map(function(t,e){return{pk:a.nivgeo+"|"+t,libgeo:i.libgeo[e]}});this.setObservableArray("geosymbs_a",t),a.getSingleCodgeo()&&this.setObservableProperty("selectedCodgeo1",a.nivgeo+"|"+a.getSingleCodgeo(),{noTrigger:!0}),n.selgeo2&&n.selgeo2.getSingleCodgeo()&&this.setObservableProperty("selectedCodgeo2",n.selgeo2.nivgeo+"|"+n.selgeo2.getSingleCodgeo(),{noTrigger:!0})},this,a.nivgeo),this._openActiveSelgeoTab(!1),n.noTrigger=!0,this.setObservableProperties({savedSelgeosLength:r.length,selectedGeoMethod:"PT"!=a.getTopology()||n.geoSymbsListIsShort()?"r":"l",libSelgeo1:t.libSelgeo1,selectedSelgeo1:"*",selNumActive:1}),!1);this._viewData.structuredByExtent&&this.gcsm.getCuState("view")&&this._viewData.selectedExtent!=GCO5.appModel.getInfo("infoFromMapName",[this.gcsm.getCuState("view"),"id_extent"])&&(e=GCO5.appModel.getInfo("infoFromMapName",[this.gcsm.getCuState("view"),"id_extent"]),i=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("view"),{id_extent:e}),this._viewData.selectedView0=i[0].pk,i=GCO5.appModel.getConcept("zonref_o")[i[0].c_id_zonref],this._viewData.selgeo2=new GCO5.model.maps.SelGeo({nivgeo:i.c_id_nivgeo,codgeo:i.c_zonref_def,libgeo:i.c_lib_zonref}),r=this._viewData.pkSelgeo2!=this._viewData.selgeo2.getPkGeo(),this.setObservableProperties({selectedExtent:e,libSelgeo2Ref:i.c_lib_zonref,libSelgeo2:i.c_lib_zonref,libSelgeoN2:i.c_lib_zonref}),$("#accordionrp21_tab2",this._$renderedContent).html(this.gclg.getString("COMPAR_ZONE","report")+" <b>"+i.c_lib_zonref+"</b>").attr("title",i.c_lib_zonref)),n.selgeo2&&n.isReportCompatibleWithSelgeo(n.report_o[n.selectedReport],n.selgeo2)||this.setObservableProperties({libSelgeo2:this._getLibZonRef(n.selectedReport),libSelgeo2Ref:this._getLibZonRef(n.selectedReport),selgeo2:this._getSelgeoZonref(),selgeo2IsDefault:!0,pkSelgeo2:this._getSelgeoZonref()?this._getSelgeoZonref().getPkGeo():null}),n.noTrigger=!1,this._setSelgeo(a,null,{selNum:1,customSel:s,isDefault:o}),r&&this._setSelgeo(null,this._viewData.selgeo2,{selNum:2,customSel:!0}),t&&"RECALL"==t.action&&(this.goToMainContent(),this._setReportDimensions()),this._super(t),this.cli.clearHash(),this.onResize(),$("#rep_nav_2",this._$renderedContent).addClass("noSelInfoInFooter")},_setSelgeo0:function(t,e){this._viewData["selgeo"+e]=t;var i=0<=["de","en"].indexOf(this.gclg.getLang()),n=t.getLibSelExtended(!1),r=t.getLibSelExtended(!0,null,null,!i),i=t.getLibSelExtended(!0,!0,null,!i).split("&nbsp;").join(" ");this.setObservableProperty("libSelgeo"+e,n),this.setObservableProperty("libNivgeo"+e,GCO5.appModel.getInfo("LibNivgeo",[t.nivgeo,!0,!0])),this.setObservableProperty("libSelgeoExt"+e,i),this.setObservableProperty("libSelgeoN"+e,r),this.setObservableProperty("selgeoTopo"+e,t.getTopology()),$(".libSelgeoN"+e,this._$renderedContent).text(r),this._viewData["selectedCodgeo"+e]&&"PT"==t.getTopology()&&this.setObservableProperty("selectedCodgeo"+e,t.nivgeo+"|"+t.getSingleCodgeo(),{noTrigger:!0})},_setSelgeo:function(t,e,i){function n(t){return l.gclg.getString(t,"report")}var r,a,s,o=this._viewData,l=this,c=(2==(i=i||{selNum:1}).selNum&&(h=l._viewData.selgeo_a[o.selectedSelgeo2],(c=e||t)&&"t"!=o.selectedGeoMethod&&h&&h.codgeo!=c.getPkGeo()&&this.setObservableProperty("selectedSelgeo2","*",{noTrigger:!0}),this._viewData.selgeo2IsDefault=!!i.isDefault),1==i.selNum&&(h=l._viewData.selgeo_a[o.selectedSelgeo1],"t"!=o.selectedGeoMethod&&h&&h.codgeo!=t.getPkGeo()&&this.setObservableProperty("selectedSelgeo1","*",{noTrigger:!0}),this._viewData.selgeo1IsDefault=!!i.isDefault),t&&e?(this._setSelgeo0(t,1),this._setSelgeo0(e,2)):this._setSelgeo0(t||e,i.selNum),$("#accordionrp21_tab1",this._$renderedContent)),h=$("#accordionrp21_tab2",this._$renderedContent),d=0<=["de","en"].indexOf(this.gclg.getLang());return e||(a=t.getLibSelExtended(!0,null,null,!d),s=t.getLibSelExtended(!0,!0,null,!d).split("&nbsp;").join(" "),(1==i.selNum?c.html(n("STUDY_ZONE")+"&nbsp;<b>"+a+"</b>"):h.html(n("COMPAR_ZONE")+"&nbsp;<b>"+a+"</b>")).attr("title",s)),i.refreshPilotageOnly?((1==i.selNum?c.html(n("STUDY_ZONE")+"&nbsp;<b>"+a+"</b>"):h.html(n("COMPAR_ZONE")+"&nbsp;<b>"+a+"</b>")).attr("title",s),this._viewData["mapSelgeo"+i.selNum]=t,void this.setObservableProperty("pkMapSelgeo"+i.selNum,t.getPkGeo())):this._isMapVisible()?(this._loadSelgeoOnMap(i.selNum),void(this._viewData["mapSelgeo"+i.selNum]=t)):(i.customSel&&(d=this._getReportsForSelgeo(o.selgeo1),c=this._viewData.selectedReport,GCO5.core.GcArrayUtil.indexOfByKey(d,"c_id_report",c)<0&&(0<d.length?c=d[0].c_id_report:t=this._getDefaultReportSelgeo(c),this.inited||(this._viewData.selectedChapter=this._checkSelectedChapter(c))),r=o.selectedReport!=c,this.setObservableProperty("selectedReport",c)),r&&(o.noTrigger=!0),t&&e?(o.noTrigger=!0,this.setObservableProperty("pkSelgeo1",t.getPkGeo()),r||(o.noTrigger=!1),this.setObservableProperty("pkSelgeo2",e.getPkGeo())):(o.noTrigger=i.reportChanging,this.setObservableProperty("pkSelgeo"+i.selNum,(t||e).getPkGeo())),l._updateHashAfterRenderChapter(),void(o.noTrigger=!1))},_checkSelectedChapter:function(t){var t=this._viewData.report_o[t].chapters.concat(),e=this._viewData.selectedChapter;return e=GCO5.core.GcArrayUtil.indexOfByKey(t,"c_id_chapter",e)<0?t[0].c_id_chapter:e},_renderViewData:function(){this._super(),GCO5.core.GcComponentUtil.animateCollapsibleSet($(".rp_rech_geo",this._$renderedContent))},goToMainContent:function(){$(".treereports",this._$renderedContent).focus()},saveState:function(t){return{}},getSaveState:function(){return{fav:1,study:1,url:1}},_getZonExemple:function(t){var e=GCO5.appModel.getConcept("report_o");return GCO5.core.GcArrayUtil.getSubArray(e[t].reportAxis,{c_util:"E"})[0]},_getCurZonRefInfo:function(t,e){return 0==(e=(e=!e&&this._viewData.structuredByExtent&&this.gcsm.getCuState("view")?(e=GCO5.appModel.getInfo("infoFromMapName",[this.gcsm.getCuState("view"),"id_extent"]),GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("view"),{id_extent:e})):GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("report_o")[t||this._viewData.selectedReport].reportAxis,{c_util:"R"})).filter(function(t){return GCO5.core.GcStringUtil.isEmpty(t.c_id_variable)})).length?null:GCO5.appModel.getConcept("zonref_o")[e[0].c_id_zonref]},_getLibZonRef:function(t){t=this._getCurZonRefInfo(t);return t?t.c_lib_zonref:null},_getDefaultReportSelgeo:function(t){t=this._getZonExemple(t),t=GCO5.appModel.getConcept("zonref_o")[t.c_id_zonref];return new GCO5.model.maps.SelGeo({codgeo:t.c_zonref_def,nivgeo:t.c_id_nivgeo,libgeo:t.c_lib_zonref})},_isSelgeo2Zonref:function(t){t=this._getSelgeoZonref(null,t);return!(!t||!this._viewData.selgeo2)&&this._viewData.selgeo2.getPkGeo()==t.getPkGeo()},_getSelgeoZonref:function(t,e){t=this._getCurZonRefInfo(t,e);return t?new GCO5.model.maps.SelGeo({codgeo:t.c_zonref_def,nivgeo:t.c_id_nivgeo,libgeo:t.c_lib_zonref}):null},_isNivgeoCompatibleWithReport:function(t,e){return 0<=this._getNivgeosCompatibleWithReport(e).indexOf(t)},_getNivgeosCompatibleWithReport:function(t){t=t||this._viewData.selectedReport;t=GCO5.appModel.getConcept("report_o")[t].c_id_nivgeo;return[t].concat(GCO5.core.GcArrayUtil.getColumnByKey(GCO5.appModel.getInfo("surNivgeos",[t,!0]),"id_nivgeo"))},_getNivgeosCompatibleWithReports:function(){var t,e=GCO5.appModel.getConcept("report_o"),i=[];for(t in e)i=i.concat(this._getNivgeosCompatibleWithReport(e[t].c_id_report));return GCO5.core.GcArrayUtil.getDistinctValues(i)},_prepareViewData:function(t){GCO5.core.GcObjectUtil.defaults(this,GCO5.view.component.MapIndicatorCommon);var e,i,n,r,a,s,o,l,c,h,d,u,p,g=this,f=this._viewData=this._getBaseViewData("report"),m=GCO5.appModel.getConcept("report").concat().sort(function(t,e){return t.c_ordre-e.c_ordre}),_=GCO5.appModel.getConcept("report_o");0!=m.length&&(p=d="",m.forEach(function(t){t.children=t.chapters}),i=m[0].c_id_report,n=(e=_[i].chapters.concat())[0].c_id_chapter,t&&t.report&&_[t.report]?(i=t.report,e=_[i].chapters.concat(),n=t.chapter&&0<=GCO5.core.GcArrayUtil.indexOfByKey(e,"c_id_chapter",t.chapter)?t.chapter:e[0].c_id_chapter):((t=$.deparam.fragment()).report||t.block&&this.cli.isInIframe())&&(t.report?(i=t.report,e=_[i].chapters.concat(),t.chapter&&(n=t.chapter)):t.block&&(r=t.block),t.selgeo1&&(a=(h=(d=t.selgeo1).split(".")).shift(),a=new GCO5.model.maps.SelGeo({codgeo:h.join("."),nivgeo:a})),t.selgeo2&&(t=(h=(p=t.selgeo2).split(".")).shift(),s=new GCO5.model.maps.SelGeo({codgeo:h.join("."),nivgeo:t}))),this.reportMode=!0,t=GCO5.appModel.getConcept("extent"),o="20mm",GCO5.browser.isChrome&&(o="2mm"),GCO5.browser.isIE&&(o="10mm"),l=this.gclg.getTextDirection(),c=GCO5.initInfo.printBannerPortrait,(t={cp:"rep",extent_a:t,pkSelgeo1:d,pkSelgeo2:p,selgeo1IsDefault:!1,selgeo2IsDefault:!1,selgeo1:a,selgeo2:s,selectedRestit:"r",geosymbs_a:[],compatibleWithSelgeo:!1,rechgeo_a:[],report_a:m,report_o:_,chapter_a:e,dataviz_a:[],block_a:[],nivgeo_a:[],libSelgeo2:g._getLibZonRef(i),libSelgeo2Ref:g._getLibZonRef(i),libSelgeoN2:g._getLibZonRef(i),selectedReport:i,selectedChapter:n,selectedBlock:r,nbReports:m.length,globalFilter_a:[],reportMode:this.reportMode,selgeo_a:[],rechsurround_a:[],reportmenu_a:GCO5.appModel.getReportMenu(),pagesize_a:[{data:"A4"},{data:"Letter"},{data:"Legal"}],browsermargin_a:[{data:"20mm",label:g.gclg.getString("MARGIN_STD","print")},{data:"10mm",label:g.gclg.getString("MARGIN_NARROW","print")},{data:"2mm",label:g.gclg.getString("MARGIN_MINI","print")}],selectedBrowserMargin:o,printBanner:c,getMapHeaderClass:function(){return"mapHeader report-map "+(1==this.selNumActive?"study":"compar")},getViewLibVisibility:function(){return!1},geoSymbsListIsShort:function(){return!this.geosymbs_a||this.geosymbs_a.length<100},print:function(t){g.onBeforePrint(),GCO5.core.GcDelayUtil.callLater(function(){window.print()},[],10,g)},collapsibleRechGeoVisible:function(){return"position"!=this.mode},isSelgeo1Single:function(t,e){return!g._isMapVisible()&&this.selgeo1?null!=this.selgeo1.getSingleCodgeo():!!this.mapSelgeo1&&null!=this.mapSelgeo1.getSingleCodgeo()},isSelgeo1Extendable:function(t,e){if(!this.isSelgeo1Single())return!1;var i=g._isMapVisible()?this.mapSelgeo1:this.selgeo1,i=GCO5.appModel.getInfo("surNivgeos",[i.getNivgeo(),!0]);return i&&0<i.length},isSelgeo2Single:function(t,e){return!g._isMapVisible()&&this.selgeo2?null!=this.selgeo2.getSingleCodgeo():!!this.mapSelgeo2&&null!=this.mapSelgeo2.getSingleCodgeo()},isSelgeo2Extendable:function(t,e){if(!this.isSelgeo2Single())return!1;var i=g._isMapVisible()?this.mapSelgeo2:this.selgeo2,i=GCO5.appModel.getInfo("surNivgeos",[i.getNivgeo(),!0]);return i&&0<i.length},getSelgeoList2:function(){var t=this.selectedSelgeo2,e=g._getSelgeoZonref();if(!e)return[];var e={codgeo:e.codgeo,nivgeo:e.nivgeo,libgeo:e.libgeo,libgeoExtended:e.libgeo,pk:"REF"},i=1==this.selNumActive?this.selgeo_a:this.selgeo_a.filter(function(t){return g._isNivgeoCompatibleWithReport(t.nivgeo)}),i=[e].concat(i),t=t||"*";return(0<=GCO5.core.GcArrayUtil.indexOfByKey(i,"pk",t)||"*"==t)&&GCO5.core.GcDelayUtil.callLater(function(){g.setObservableProperty("selectedSelgeo2",t,{noTrigger:!0}),$("[data-link='selectedSelgeo2']").val(t)},[],1,g),i},getComparedWithMention:function(){return this.pkSelgeo1.replace("|",".")==this.pkSelgeo2.replace("|",".")?"":"<span>, "+g.gclg.getString("COMPARED_WITH","pilotage","report")+"</span> <span contenteditable='true' class='libSelgeoN2 bold'>"+this.libSelgeoN2+"</span>"},isReportCompatibleWithSelgeo:function(t,e){return e&&e.isCompatibleWithNivgeo(t.c_id_nivgeo)&&!(0==t.c_selmult&&null===e.getSingleCodgeo())&&!(0==t.c_selmult&&e.getNivgeo()!=t.c_id_nivgeo)},getReports:function(){var t=m.some(function(t){return f.selgeo1&&!f.isReportCompatibleWithSelgeo(t,f.selgeo1)});return g.setObservableProperty("hasNoCompatibleReport",t),m.filter(function(t){return!g._viewData.compatibleWithSelgeo||g._viewData.selgeo1&&g._viewData.selgeo1.isCompatibleWithNivgeo(t.c_id_nivgeo)})},getReportLib:function(){var t=_[this.selectedReport];return t?t.c_lib_report.toUpperCase().split("|").join(" "):""},getChapterLib:function(){var t=GCO5.core.GcArrayUtil.getSubArray(this.chapter_a,{c_id_chapter:this.selectedChapter});return 0<t.length?t[0].c_lib.toUpperCase().split("|").join(" "):""},filtReportReset:function(t){console.log("filtReportReset // do nothing")},filtGeoReset:function(t){console.log("filtGeoReset // do nothing")},keySearchReport:function(){console.log("keySearchReport// do nothing")},searchGeo:function(){g._onSearchGeo({path:"searchStr",value:f.searchStrGeo})},readPosition:function(){GCO5.model.maps.SelGeo.readPosition(g._readPosition,g)},getPrevIcon:function(){return"rtl"===l?"5":"0"},getNextIcon:function(){return"rtl"===l?"0":"5"},goToSiblingDataviz:function(t){t&&(t.selectedBlock&&g.setObservableProperty("selectedBlock",t.selectedBlock),t.selectedDataviz?g.setObservableProperty("selectedDataviz",t.selectedDataviz):t.selectedChapter?g.setObservableProperty("selectedChapter",t.selectedChapter):t.selectedReport&&g.setObservableProperty("selectedReport",t.selectedReport),g._openTreeReportsOnChapter(this.selectedReport,this.selectedChapter))},prevDataviz:function(){this.goToLastDataviz=!0,this.goToSiblingDataviz(this.getPreviousDatavizInfo())},nextDataviz:function(){this.goToSiblingDataviz(this.getNextDatavizInfo())},prevChapter:function(){this.goToSiblingDataviz(this.getPreviousChapterInfo())},nextChapter:function(){this.goToSiblingDataviz(this.getNextChapterInfo())},getChaptersInReport:function(){return GCO5.core.GcArrayUtil.getSubArray(this.chapter_a,{c_id_report:this.selectedReport})},getPreviousChapterInfo:function(){var t={},e=this.getChapterIndex(),i=this.getChaptersInReport();return 0<e?t.selectedChapter=i[e-1].c_id_chapter:0<(e=this.getReportIndex())?t.selectedReport=this.report_a[e-1].c_id_report:t=null,t},getNextChapterInfo:function(){var t={},e=this.getChapterIndex(),i=this.getChaptersInReport();return e<this.getChaptersInReport().length-1?t.selectedChapter=i[e+1].c_id_chapter:(e=this.getReportIndex())<this.report_a.length-1?t.selectedReport=this.report_a[e+1].c_id_report:t=null,t},getNextDatavizInfo:function(){var t,e,i={};return(t=this.getDatavizIndex())<this.dataviz_a.length-1?i.selectedDataviz=this.dataviz_a[t+1].c_id_dataviz:(t=this.getChapterIndex(),e=this.getChaptersInReport(),t<this.getChaptersInReport().length-1?i.selectedChapter=e[t+1].c_id_chapter:(t=this.getReportIndex())<this.report_a.length-1?i.selectedReport=this.report_a[t+1].c_id_report:i=null),i},getPreviousDatavizInfo:function(){var t,e,i={};return 0<(t=this.getDatavizIndex())?i.selectedDataviz=this.dataviz_a[t-1].c_id_dataviz:(t=this.getChapterIndex(),e=this.getChaptersInReport(),0<t?i.selectedChapter=e[t-1].c_id_chapter:0<(t=this.getReportIndex())?i.selectedReport=this.report_a[t-1].c_id_report:i=null),i},getBlockIndex:function(){return GCO5.core.GcArrayUtil.indexOfByKey(this.block_a,"c_id_block",this.selectedBlock)},getDatavizIndex:function(){return GCO5.core.GcArrayUtil.indexOfByKey(this.dataviz_a,"c_id_dataviz",this.selectedDataviz)},getChapterIndex:function(){var t=this.getChaptersInReport();return GCO5.core.GcArrayUtil.indexOfByKey(t,"c_id_chapter",this.selectedChapter)},getReportIndex:function(){return GCO5.core.GcArrayUtil.indexOfByKey(this.report_a,"c_id_report",this.selectedReport)},exportReport:function(){g._enterReportExportMode()}}).getSelgeoList2.depends=["selectedReport","savedSelgeosLength","libSelgeo2Ref"],t.getReports.depends=["compatibleWithSelgeo","pkSelgeo1"],t.collapsibleRechGeoVisible.depends="mode",t.getReportLib.depends=["selectedReport"],t.getChapterLib.depends=["selectedChapter"],t.getNextDatavizInfo.depends=["selectedDataviz"],t.getPreviousDatavizInfo.depends=["selectedDataviz"],t.isSelgeo1Extendable.depends=["pkSelgeo1","pkMapSelgeo1"],t.isSelgeo2Extendable.depends=["pkSelgeo2","pkMapSelgeo2"],t.getMapHeaderClass.depends=["selNumActive"],t.geoSymbsListIsShort.depends=["geosymbs_a"],t.getComparedWithMention.depends=["pkSelgeo1","pkSelgeo2"],GCO5.core.GcObjectUtil.extend(this._viewData,t),this._viewData.structuredByExtent&&this.gcsm.getCuState("view")&&(this._viewData.selectedExtent0=this._viewData.selectedExtent=GCO5.appModel.getInfo("infoFromMapName",[this.gcsm.getCuState("view"),"id_extent"]),h=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("view"),{id_extent:this._viewData.selectedExtent}),this._viewData.selectedView0=h[0].pk,d=GCO5.appModel.getConcept("zonref_o")[h[0].c_id_zonref],this._viewData.selgeo2=new GCO5.model.maps.SelGeo({nivgeo:d.c_id_nivgeo,codgeo:d.c_zonref_def,libgeo:d.c_lib_zonref}),this._viewData.libSelgeo2=this._viewData.libSelgeoN2=this._viewData.libSelgeo2Ref=d.c_lib_zonref,this._viewData.pkSelgeo2=this._viewData.selgeo2.getPkGeo()),u=this._getNivgeosCompatibleWithReports(),p=this._viewData.view_a.filter(function(t){return 0<=u.indexOf(GCO5.appModel.getInfo("infoFromMapName",[t.c_id_view,"id_nivgeo"]))}),this._viewData.compatViews_a=p.map(function(t){return t.c_id_view}),this._viewData.selectedView=this._viewData.selectedView0)},_openTreeReportsOnChapter:function(t,e){var i=$(".treereports",this._$renderedContent),t=i.find("[data-pk='"+t+"']");i.find(".ui-selected").removeClass("ui-selected"),1==t.length&&(t.find("[data-pk='"+e+"']").find("a").addClass("ui-selected"),(i=t.find(".ui-collapsible-heading-toggle")).closest(".ui-collapsible").hasClass("ui-collapsible-collapsed")&&i.trigger("click"))},_onScrollReport:function(t){var e,i,n,r,a=this,s=$(".report-viewport",this._$renderedContent),o=$(">.dataviz",s);this._viewData._scrollingReport?this._viewData._scrollingReport=!1:1<o.length&&(o.each(function(t){0!=(n=$(this).find(".dataviz-header h2")).length&&n.is(":visible")&&(0<=(r=n.offset().top-s.offset().top)&&r<=s.height()/2&&(e=n.closest(".dataviz").attr("id"),a.setObservableProperty("selectedDataviz",e,{noTrigger:!0})),r<0&&(i=n.closest(".dataviz").attr("id")))}),e||a.setObservableProperty("selectedDataviz",i,{noTrigger:!0}))},_getReportGlobalFilter:function(t){t=GCO5.appModel.getConcept("report_o")[t];if(t&&t.reportAxis){t=t.reportAxis.filter(function(t){return"F"==t.c_type_axis});if(1===t.length)return t[0].c_id_variable}return null},_onChangeCurrentReport:function(t){var e=t.value;if(this._viewData.chapter_a=this._viewData.report_o[e].chapters.concat(),!this._viewData.noTrigger){$("#rp_report",this._$renderedContent).trigger("click",!0),this.gcDashboardModel&&this.gcDashboardModel.resetForNewReport();for(var n,r,t=this._checkSelectedChapter(e),i=this._getDefaultReportSelgeo(e),a=this._viewData.selgeo1,s=this._getSelgeoZonref(e),o=this._viewData.selgeo2,l=[],c=!1,h=1;h<=2;h++){var d,u=1===h?i:s,p=1===h?a:o;this._viewData["selgeo"+h+"IsDefault"]&&u!==p?(d={selNum:h,reportChanging:!0,isDefault:!0},1===h?d.customSel=!0:d.refreshPilotageOnly=!0,this._setSelgeo(u,null,d),c=!0):l.push(h)}for(h in l){u=1===(h=l[h])?i:s,p=1===h?a:o;this._viewData.isReportCompatibleWithSelgeo(this._viewData.report_o[e],p)&&a.getTopology()==i.getTopology()||(this._viewData.noTrigger=!0,this._setSelgeo(u,null,{selNum:h,customSel:!0,reportChanging:!0,isDefault:!0}),c=!(this._viewData.noTrigger=!1))}!0===c&&(this.setObservableProperty("selectedGeoMethod","r"),this._openActiveSelgeoTab(!1)),this.setObservableProperty("selectedChapter",t,{forceTrigger:!0}),this.setObservableProperty("selectedGeoMethod","PT"!=this._viewData.selgeo1.getTopology()||this._viewData.geoSymbsListIsShort()?"r":"l"),"PT"==this._viewData.selgeo1.getTopology()&&(n=this._viewData.selgeo1,r=n.nivgeo,GCO5.appModel.loadRefData(function(){var i=GCO5.appModel.getRefData(r),t=i.codgeo.map(function(t,e){return{pk:r+"|"+t,libgeo:i.libgeo[e]}});this.setObservableArray("geosymbs_a",t),n.getSingleCodgeo()&&this.setObservableProperty("selectedCodgeo1",r+"|"+n.getSingleCodgeo(),{noTrigger:!0})},this,r)),this._setReportDimensions()}},_addListeners:function(){var a=this,s=this._viewData,i=this.constructor;$(".page-report-container .help",this._$renderedContent).on("click",function(t){GCO5.browser.isFirefox&&alert("Pour optimiser l'impression (marges...), rendez-vous dans le menu en haut à droite, rubrique Imprimer")}),$(".report-viewport",this._$renderedContent).on("input",".libSelgeoN1",function(i,t){$(".libSelgeoN1",a._$renderedContent).each(function(t,e){this!==i.currentTarget&&$(this).text($(i.currentTarget).text())})}),$(".report-viewport",this._$renderedContent).on("input",".libSelgeoN2",function(i,t){$(".libSelgeoN2",a._$renderedContent).each(function(t,e){this!==i.currentTarget&&$(this).text($(i.currentTarget).text())})}),$.observe(s,"selectedBrowserMargin",function(t,e){s.noTrigger||(e=e.value,$(".page-content",a._$renderedContent).css("margin-right",e),$(".pageNav",a._$renderedContent).width(Math.max(720,$(".page-content").innerWidth()-6)),e=$(".report-viewport",a._$renderedContent).width(),$(".report-container",a._$renderedContent).css("width",e-1+"px"),GCO5.core.GcDelayUtil.callLater(a.onResize,[],2,a))}),GCO5.core.GcDelayUtil.callLaterAfterEventStopped($(".report-viewport",this._$renderedContent),this._onScrollReport,"scroll",300,this),$(".treereports",this._$renderedContent).on("collapsibleexpand",function(t,e){e=$(e).data("pk");a.setObservableProperty("selectedReport",e)}),$(".treereports",this._$renderedContent).on("click","li",function(t){if(0==$(this).data("level"))return!1;a.setObservableProperty("selectedChapter",$(this).data("pk"))}),$.observe(s,"selectedReport",function(t,e){console.log("CHANGE REPORT",e,JSON.parse(JSON.stringify(s))),a._onChangeCurrentReport(e)}),$.observe(s,"selectedChapter",function(t,e){var i;s.noTrigger||((i=a._getReportGlobalFilter(s.selectedReport))?GCO5.appModel.loadFilterData(function(){var t=GCO5.appModel.getInfo("filter1Data",[i]);a.setObservableProperty("lib_globalfilter1",GCO5.appModel.getConcept("nomenc_o")[i].c_lib_nomenc),a.setObservableProperty("globalFilter1",i),a.setObservableArray("globalFilter_a",t,"selectedGlobalFilter"),a.setObservableProperty("selectedGlobalFilter",t[0].id,{forceTrigger:!0})},a,i):(s.selectedGlobalFilter=s.globalFilter1=null,a.setObservableArray("globalFilter_a",[]),a._loadReportChapterData()),GCO5.core.GcDelayUtil.callLater(a.gcsm.statTrack,["chapter",s.selectedReport,s.selectedChapter],1,a.gcsm))}),$.observe(s,"selectedBlock",function(t,e){s.noTrigger||a._loadReportChapterData()}),$.observe(s,"selectedGlobalFilter",function(t,e){s.noTrigger||null==e.value||a._loadReportChapterData()}),$.observe(s,"pkSelgeo1",function(t,e){s.noTrigger||a._loadReportChapterData()}),$.observe(s,"pkSelgeo2",function(t,e){s.noTrigger||a._loadReportChapterData()}),$.observe(s,"selectedDataviz",function(t,e){var i;s.noTrigger||(i=(i=$("#"+s.selectedDataviz,a._$renderedContent)).length?i:$("#"+s.selectedDataviz+"_0",a._$renderedContent)).length&&(s._scrollingReport=!0,$(".report-viewport").scrollTop(0).scrollTop(i.position().top-$(".report-viewport").position().top))}),$.observe(s,"selectedView",function(t,e){s.noTrigger||(e=e.value,a.map&&GCO5.core.GcDelayUtil.callLater(function(){$("#rp_map").focus()},[],10,a),$(a).triggerHandler(i.CHANGE_MAPVIEW,[e]))}),$("#rp_map",this._$renderedContent).on("click",function(t,e){a._isMapVisible()||("rp_map"!=t.target.id||e&&e.noResize||GCO5.core.GcDelayUtil.callLater(a.onResize,[],1,a),a._openActiveSelgeoTab(),e||GCO5.core.GcDelayUtil.callLater(a._loadSelgeoOnMap,[],5,a),s.noTrigger=!0,a.setObservableProperty("selectedGeoMethod","m"),s.noTrigger=!1,s.selectedRestit="m",a.alignFormLabels(".labelgroup"))}),$("#rp_report",this._$renderedContent).on("click",function(t,e){if(a._isMapVisible()&&"removedFromStage"!=e){var i,n,r=s.selNumActive;if(a._viewData.mapSelgeo1&&(i=s.mapSelgeo1.getPkGeo()!=s.pkSelgeo1),a._viewData.mapSelgeo2&&(n=s.mapSelgeo2.getPkGeo()!=s.pkSelgeo2),GCO5.core.GcDelayUtil.callLater(a._reinitSelgeoPanel,[],5,a),!i&&!n||e)return a._viewData.mapSelgeo1=a._viewData.mapSelgeo2=null,void(s.selectedRestit="r");0==a._viewData["mapSelgeo"+r].getSelIds().length&&(1==r?i=!0:n=!0,a._viewData["mapSelgeo"+r]=a._viewData["selgeo"+r+"_save"]),i&&n?GCO5.core.GcDelayUtil.callLater(a._setSelgeo,[a._viewData.mapSelgeo1,a._viewData.mapSelgeo2,{selNum:r,customSel:!0}],1,a):(GCO5.core.GcDelayUtil.callLater(a._setSelgeo,[a._viewData["mapSelgeo"+r],null,{selNum:r,customSel:!0}],1,a),a._viewData["mapSelgeo"+r]=null),s.selectedRestit="r"}}),$("#accordionrp21_tab1",this._$renderedContent).on("click",function(t,e){a.setObservableProperty("selNumActive",1),a._reinitSelgeoPanel()}),$("#accordionrp21_tab2",this._$renderedContent).on("click",function(t,e){a.setObservableProperty("selNumActive",2),a._reinitSelgeoPanel()}),$(".zonselgeo1",this._$renderedContent).on("click",function(t,e){a.setObservableProperty("selNumActive",1),a._openActiveSelgeoTab()}),$(".zonselgeo2",this._$renderedContent).on("click",function(t,e){a.setObservableProperty("selNumActive",2),a._openActiveSelgeoTab()}),$("[data-link='searchStrGeo']",this._$renderedContent).on("keydown",function(t){var e=t.keyCode||t.which;"keydown"==t.type&&"13"!=e||a._onSearchGeo({path:"searchStr",value:$(this).val()})}),$.observe(s,"selectedGeoMethod",function(t,e){var i;s.noTrigger||(e=e.value,$("[data-link='searchStrGeo']",a._$renderedContent),"m"==e?$("#rp_map",a._$renderedContent).trigger("click"):"r"==e?a._clearSearchGeo():"e"==e&&(a.setObservableArray("rechsurround_a",[]),$(".rechgeosup_msg",this._$renderedContent).hide(),1==s.selNumActive&&s.selgeo1.getSingleCodgeo()&&(i={codgeo:s.selgeo1.codgeo,nivgeo:s.selgeo1.nivgeo},a.map&&(i.idView=a.map.getName()),GCO5.appModel.searchSurroundGeo(a._onSearchSurroundGeo,a,i)),2==s.selNumActive&&s.selgeo2.getSingleCodgeo()&&(i={codgeo:s.selgeo2.codgeo,nivgeo:s.selgeo2.nivgeo},a.map&&(i.idView=a.map.getName()),GCO5.appModel.searchSurroundGeo(a._onSearchSurroundGeo,a,i))))}),$(".rechgeolist.ui-collapsible-set",this._$renderedContent).add($("#positionList",this._$renderedContent)).add($("#positionList2",this._$renderedContent)).on("click","li",function(t){t=$(t.currentTarget),t=s.rechgeo_a[parseFloat(t.data("uid"))];a.setObservableProperty("territoryTargeted",t),GCO5.appModel.searchGeoByCodgeo(a._onResultSearchGeo2,a,t.nivgeo,t.codgeo),GCO5.appModel.searchSurroundGeo(a._onSearchSurroundGeo,a,{codgeo:t.codgeo,nivgeo:t.nivgeo})}),$(".ui-listview.extend",this._$container).on("click","li",function(t){t=$(t.target).closest("li"),t=a._curSelRow=a._viewData.rechsurround_a[parseFloat(t.attr("uid"))];a.setObservableProperty("territoryTargeted",t),GCO5.appModel.searchGeoByCodgeo(a._onResultSearchGeo2,a,t.nivgeo,t.codgeo)}),$.observe(this._viewData,"selectedCodgeo1",function(t,e){var i,e=e.value;"*"==e||"PT"!=s.selgeoTopo1||s.noTrigger||(e=e.split("|"),i=$("[data-link='selectedCodgeo1'] option:selected",a._$renderedContent).text(),e=new GCO5.model.maps.SelGeo({nivgeo:e[0],codgeo:e[1],libgeo:i}),a._setSelgeo(e,null,{selNum:1,customSel:!0}))}),$.observe(this._viewData,"selectedCodgeo2",function(t,e){var i,e=e.value;"*"==e||"PT"!=s.selgeoTopo2||s.noTrigger||(e=e.split("|"),i=$("[data-link='selectedCodgeo2'] option:selected",a._$renderedContent).text(),e=new GCO5.model.maps.SelGeo({nivgeo:e[0],codgeo:e[1],libgeo:i}),a._setSelgeo(e,null,{selNum:2,customSel:!0}))}),$.observe(this._viewData,"selectedSelgeo1",function(t,e){var e=e.value;"*"!=e&&e&&("ADD"==e?GCO5.core.GcDelayUtil.callLater(a._saveSel,[s.selgeo1,"1"],10,a):(e=a._viewData.selgeo_a[e],e=new GCO5.model.maps.SelGeo(e),a._setSelgeo(e,null,{selNum:1,customSel:!0})))}),$.observe(this._viewData,"selectedSelgeo2",function(t,e){if(!s.noTrigger){var i,e=e.value;if("REF"==e||"*"==e)i=a._getSelgeoZonref();else{if("ADD"==e)return void GCO5.core.GcDelayUtil.callLater(a._saveSel,[s.selgeo2,"2"],10,a);e=a._viewData.selgeo_a[e],i=new GCO5.model.maps.SelGeo(e)}a._setSelgeo(i,null,{selNum:2,customSel:!0})}}),$("#rep-prolonger",this._$renderedContent).on("click","a",function(t){$(GCO5.topApp).triggerHandler(GCO5.view.component.AComponent.LOAD_COMPONENT,{id:$(this).data("cu"),categ:"main"})}),$(".reportmenucontent",this._$renderedContent).on("click keydown","a",function(t){"keydown"==t.type&&13!=t.keyCode||("Print"==(t=$(this).data("pk"))?a.gcDashboardModel.displayed&&GCO5.core.GcDelayUtil.callLater(a._enterReportPrePrintMode,[],10,a):"PrintAll"==t?a.gcDashboardModel.displayed&&(a.setObservableProperty("toPrintAllReport",!0),a.gcsm.freeze("printAllReport",a.gclg.getString("PREP_PRINT_REPORT","restit","report")),$(".report-viewport").css("height","auto"),$(".report-container").empty(),a._enterReportPrePrintMode(!0),GCO5.core.GcDelayUtil.callLater(a._loadReportChapterData,[!0],10,a)):"ExportAll"==t?a.gcDashboardModel.displayed&&GCO5.core.GcDelayUtil.callLater(a._enterReportExportMode,[],10,a):(GCO5.core.GcComponentUtil.displaySlidingPanel($(".map-options-menu",a._$renderedContent)),$(a.map).triggerHandler(GCO5.view.component.MapViewThematic.DISPLAY_GEO_SETTINGS,[t])))}),this.addMixinListeners()},_enrichSelgeo_a:function(t){var i=this,n=0<=["de","en"].indexOf(this.gclg.getLang());return(t=t||(t=this.cli.readFromLocalStorage("selgeo_a"))&&JSON.parse(t)||[]).forEach(function(t,e){t.pk=e,t.selIds?(e=t.selIds.length,e=i.gclg.formatNumber(e)+" "+GCO5.appModel.getInfo("LibNivgeo",[t.nivgeo,!n,1<e]),t.libgeo==e?t.libgeoExtended=t.libgeo2?e+" ("+t.libgeo2+" +... )":e:t.libgeoExtended=t.libgeo+" ("+e+")"):t.libgeoExtended=t.libgeo+" ("+GCO5.appModel.getInfo("LibNivgeo",[t.nivgeo,!n,!1])+i.gclg.getString("P2")+" "+t.codgeo+")"}),t},_saveSel:function(e,t){var i=this,n=e.nivgeo,r=e.codgeo,a=this._enrichSelgeo_a();if(r){r=GCO5.core.GcArrayUtil.getSubArray(a,{codgeo:[r],nivgeo:[n]});if(0<r.length)return void this.setObservableProperty("selectedSelgeo"+t,r[0].pk,{noTrigger:!0})}e.localStorageTestSave(function(t){e.localStorageSave(),i.setObservableProperty("confirmMsg",this.gclg.getString("SEL_SAVE_OK","selection"))},i),a=this._enrichSelgeo_a(),this.setObservableArray("selgeo_a",a,null,null,{noTrigger:!0}),this.setObservableProperty("savedSelgeosLength",a.length,{noTrigger:!0}),this.setObservableProperty("selectedSelgeo"+t,"0",{noTrigger:!0})},_updateFooter:function(t){var e,i;this.map&&(e=this.map.$legDivContainerH.find(".mapLibView"),i=0<=["de","en"].indexOf(this.gclg.getLang()),t=this.gclg.getString("TERRITORY","concepts")+this.gclg.getString("P2")+" "+t.getLibSelExtended(!0,!1,!0,!i),e.css({display:"flex","max-width":"750px"}).find("p").html(t))},_onExitPrint:function(){this.gcsm.setPrintMode(null),$(".report-container",this._$renderedContent).css("width","auto"),$("body").removeClass("pre-print no100vh"),GCO5.topApp._initMegaMenu(),this._updateHashOnExitPrint(),$(".page-content",this._$renderedContent).css("margin-right",""),this._viewData.toPrintAllReport?(GCO5.core.GcDelayUtil.callLater(this._loadReportChapterData,[!1,!0],10,this),this.setObservableProperty("toPrintAllReport",!1)):this.onResize()},_enterReportExportMode:function(){var t={reportLib:this._viewData.getReportLib(),chapterLib:this._viewData.getChapterLib()};t.libgeo=$.trim($(".page-report-container .ficHeader div",this._$renderedContent).first().text()),this.gcDashboardModel.exportReportDataXlsx(t)},_enterReportPrePrintMode:function(t){this.gcsm.setPrintMode("preprint"),$("body").addClass("pre-print no100vh"),this.setObservableProperty("selectedBrowserMargin",this._viewData.selectedBrowserMargin,{forceTrigger:!0}),this.onResize(),this._updateHashOnEnterPrint(),this.gcDashboardModel.enterReportPrePrintMode(t),GCO5.core.GcDelayUtil.callLater(function(){$(".report-viewport",this._$renderedContent).css("height","auto");$(".report-viewport",this._$renderedContent).get(0).scrollHeight},[],5)},onBeforePrint:function(){$("body").hasClass("pre-print")||"m"==this._viewData.selectedRestit&&alert(this.gclg.getString("PRINT_HINT","print")+this._viewData.selectedRestit)},_reinitSelgeoPanel:function(){var t=this._viewData.selNumActive;this._isMapVisible()?(this.setObservableProperty("selectedGeoMethod","m"),GCO5.core.GcDelayUtil.callLater(this._loadSelgeoOnMap,[],5,this)):this.setObservableProperty("selectedGeoMethod",1==t?"r":"t",{forceTrigger:!0})},_clearSearchGeo:function(){$("[data-link='searchStrGeo']",this._$renderedContent).val(""),this.setObservableArray("rechsurround_a",[]),this.setObservableArray("rechgeo_a",[]),this.setObservableProperty("extendedTerr",!1)},_openActiveSelgeoTab:function(t){var e=$("#accordionrp21_tab"+this._viewData.selNumActive,this._$renderedContent),i="true"==e.attr("aria-expanded");(!i&&!1!==t||i&&!1===t)&&e.trigger("click")},_onRemovedFromStage:function(){this._viewData.selgeo1&&this._viewData.selgeo1.sessionRegister(),this._isMapVisible()&&$("#rp_report",this._$renderedContent).trigger("click","removedFromStage")},_loadSelgeoOnMap:function(){var t,e=this._viewData.selNumActive,i=this,n=this._viewData["selgeo"+e],r=(this._viewData["selgeo"+e+"_save"]=GCO5.model.maps.SelGeo.cloneSelgeo(this._viewData["selgeo"+e]),i.map?i.map.getStatLayerName():null),e=i.map?i.map.nivgeo:null,a=i.map?i.map.getIdExtent():null,s=n.nivgeo,o=n.getIdExtent(),l=GCO5.appModel.getInfo("surNivgeos",[e,!0]),c=GCO5.appModel.getInfo("subNivgeos",[s]),h=o?GCO5.appModel.getInfo("mapNameFromNivgeo",[s,o]):null;if(this._updateFooter(n),"PT"==n.getTopology()){var r=n.nivgeo+"_P",h=null,d=(n.getSingleCodgeo()&&(h=this.gcDashboardModel.getTerritoryInfo(n.nivgeo+"@"+n.codgeo,"view"),n.id_extent&&GCO5.appModel.getInfo("infoFromMapName",[h,"id_extent"])!=n.id_extent&&(h=null)),h||(p=GCO5.appModel.getRefData(n.nivgeo,null,"views"),n.id_extent&&(p=p.filter(function(t){return GCO5.appModel.getInfo("infoFromMapName",[t,"id_extent"])==n.id_extent})),h=p[0]),GCO5.appModel.getInfo("infoFromMapName",[h,"id_extent"]));i.setObservableProperty("selectedExtent",d),i.setObservableProperty("selectedView",h,{forceTrigger:!0})}else{if(!h)for(var u in c){var p,u=c[u].nivgeo;if(i._isNivgeoCompatibleWithReport(u))if(o){var g=GCO5.appModel.getInfo("mapNameFromNivgeo",[u,o]);if(g){h=g;break}}else if(0<(p=GCO5.appModel.getInfo("mapNamesFromNivgeo",[u])).length){t=u;break}}d=!1;o&&o==a?s==e?i.map?i.map.drawSelgeo(n,r,!0):d=!0:h?d=!0:0<=GCO5.core.GcArrayUtil.indexOfByKey(l,"id_nivgeo",s)&&n.getSelIds(e,a,function(){i.map.drawSelgeo(n,r,!0)}):d=!0,d&&(t=t||GCO5.appModel.getInfo("infoFromMapName",[h,"id_nivgeo"]),n.getSelIds(t,o,function(){h=h||n.getIdView(),n.sessionRegister();var t=GCO5.appModel.getInfo("infoFromMapName",[h,"id_extent"]);i._viewData.selectedView=h,i.setObservableProperty("selectedExtent",t,{noTrigger:!0}),i.setObservableProperty("selectedView",h,{forceTrigger:!0})},i))}this._loadingSelgeoOnMap=!0,GCO5.core.GcDelayUtil.callLater(function(){i._loadingSelgeoOnMap=!1},[],100,this)},_isMapVisible:function(){return"m"==this._viewData.selectedRestit},_onBuildInfosel:function(){var t,e=this.map.getSelgeo();e&&!this._loadingSelgeoOnMap&&(t=this._viewData.selNumActive,this._setSelgeo(e,null,{selNum:t,refreshPilotageOnly:!0}))},_loadReportChapterData:function(r,a){var s=this,o=this._viewData,l=this._viewData.selgeo1,c=this._isSelgeo2Zonref(!0)?null:o.selgeo2;this.cli.isInIframe()&&(s.gcDashboardModel&&s.gcDashboardModel.clearIFrame(),o.selectedBlock)?GCO5.appModel.loadReportBlockData(s,function(t){t.report?(s._updateHashAfterRenderChapter(),s.gcDashboardModel||(s.gcDashboardModel=new GCO5.model.dashboard.GcChapterModel({container:$(".report-viewport"),ca:s})),o.noTrigger=!0,o.noTrigger=o.goToLastDataviz=!1,t.selgeo=l,t.singleBlock=o.selectedBlock,s.gcDashboardModel.loadBlockData(t,l,c,s._displayReport,s)):$("body").empty().html('<div style="text-align: center;"><em>'+s.gclg.getString("NO_DATA_BLOCK","report")+"</em></div>")},o.selectedBlock,o.selgeo1,o.selgeo2):GCO5.appModel.loadReportChapterData(s,function(t,e){var i,n;t.report?(s._updateHashAfterRenderChapter(),i=t.report.chapters[0].dataviz,s.gcDashboardModel||(s.gcDashboardModel=new GCO5.model.dashboard.GcChapterModel({container:$(".report-viewport"),ca:s})),o.noTrigger=!0,n=o.goToLastDataviz?i.length-1:0,s.setObservableArray("dataviz_a",i,"selectedDataviz",i[n].c_id_dataviz),s.setObservableProperty("selectedDatavizLib",i[n].c_title+" - "+i[n].c_subtitle),o.noTrigger=o.goToLastDataviz=!1,t.selgeo=l,t.globalFilter1=o.selectedGlobalFilter,t.globalFilter1Id=o.globalFilter1,t.singleBlock=o.selectedBlock,o.selectedBlock?s.gcDashboardModel.loadBlockData(t,l,c,s._displayReport,s):s.gcDashboardModel.loadData(t,r||a,l,c,s._displayReport,s,r)):GCO5.core.ClientInfo.getInstance().isInIframe()?$("body").empty().html('<div style="text-align: center;"><em>'+s.gclg.getString("NO_DATA_CHAPTER","report")+"</em></div>"):alert(s.gclg.getString("ERROR")+s.gclg.getString("P2B")+" "+s.gclg.getString("NO_DATA_CHAPTER","report"))},o.selectedReport,r?null:o.selectedChapter,l,c)},_displayReport:function(t){var e,i,n=$("#accordionrp21_tab1",this._$renderedContent),r=$("#accordionrp21_tab2",this._$renderedContent),a=this.gcDashboardModel.getTerritoryByType(1),s=0<=["de","en"].indexOf(this.gclg.getLang());a&&!this._viewData.selgeo1.libgeo&&(this._viewData.selgeo1.libgeo=this.gcDashboardModel.getTerritoryByType(1).title,e=this._viewData.selgeo1.getLibSelExtended(!0,null,null,!s),i=this._viewData.selgeo1.getLibSelExtended(!0,!0,null,!s).split("&nbsp;").join(" "),this._setSelgeo0(this._viewData.selgeo1,1),n.html(this.gclg.getString("STUDY_ZONE","report")+"&nbsp;<b>"+e+"</b>").attr("title",i)),this.gcDashboardModel.getTerritoryByType(2)&&!this._viewData.selgeo2.libgeo&&(this._viewData.selgeo2.libgeo=this.gcDashboardModel.getTerritoryByType(2).title,e=this._viewData.selgeo2.getLibSelExtended(!0,null,null,!s),i=this._viewData.selgeo2.getLibSelExtended(!0,!0,null,!s).split("&nbsp;").join(" "),this._setSelgeo0(this._viewData.selgeo2,2),r.html(this.gclg.getString("COMPAR_ZONE","report")+"&nbsp;<b>"+e+"</b>").attr("title",i)),this._setReportDimensions()},_readPosition:function(t){var i;t?(t.view=GCO5.appModel.getInfo("infoFromMapName",[this._viewData.selectedView0,"id_view","pk"]),this.setObservableProperty("mode","position"),(i=this).map&&this.map.clearSel(),GCO5.appModel.getZonsAroundPosition(function(t,e){i.__onResultSearchGeo.call(i,t,"","position",i._viewData.viewNivgeos)},this,t)):$(".rechgeo_msg",this._$renderedContent).show()},_onSearchGeo:function(t){var i,n,r=this,t=(t.path,t.value);this.setObservableProperty("mode","key"),!t||GCO5.core.GcStringUtil.isEmpty(t)?this._clearSearchGeo():($(".rechgeo_msg",this._$renderedContent).hide(),i=1==this._viewData.selNumActive?null:this._getNivgeosCompatibleWithReport(),n=this._viewData.mode,GCO5.appModel.searchGeoByKey(function(t,e){r.__onResultSearchGeo.call(r,t,e,n,i)},this,t,"","*",1))},_onResultSearchGeo2:function(t){var e=this._viewData.territoryTargeted,i=(0<t.rech_a.length&&(i=t.rech_a[0].idView,e.id_extent=GCO5.appModel.getInfo("infoFromMapName",[i,"id_extent","id_view"]),e.id=t.rech_a[0].fid),this.selgeoTarget=new GCO5.model.maps.SelGeo(e));this._setSelgeo(i,null,{selNum:this._viewData.selNumActive,customSel:!0}),this.setObservableProperty("selectedGeoMethod","r")},_onSearchSurroundGeo:function(t){$.observable(this._viewData.rechsurround_a).refresh(t.rech_a),0==t.rech_a.length&&$(".rechgeosup_msg",this._$renderedContent).show()},_displayDataviz:function(t){var e,i={fullHTML:!0};this.reportChart?(e=this.reportChart.update(t,i),this._setReportDimensions(e)):(this.reportChart=new GCO5.view.component.D3ChartContainer($("#reportContent"),t,i),$("[data-menu]",this._$renderedContent).menu(),$("[data-menu-trigger]",this._$renderedContent)["menu-trigger"]())},setupMap:function(t){t.mapContainer=$(".mapContainer",this._$renderedContent),t.styles.drillMaps=!1,t.styles.extent0=t.extent?new GCO5.model.maps.GeoExtent(t.extent):this._viewData.extent0,t.legendContainer={cv:null,divH:$("#rep_nav_2 .maplegendH",this._$renderedContent)},t.copyrights=GCO5.appModel.getInfo("infoFromMapName",[t.mapName,"copyrights"]),t.id_view=GCO5.appModel.getInfo("infoFromMapName",[t.mapName,"c_id_view"]),t.styles.noCallInfosel=!0;var e,i,n=this._viewData.selgeo1.getTopology(),r=this;t.selgeo||(t.selgeo=GCO5.model.maps.SelGeo.getcurSelgeo()),this.__setMapDimensions(this.map,!0),this.map?(e=this.map.getCurTheme()?10:0,this.map.getCurTheme()&&this.map.removeAllThemes({noRender:!0,immediate:!0}),GCO5.core.GcDelayUtil.callLater(this.map.setup,[t],e,this.map)):(this.map=new GCO5.view.component.MapViewThematic(t),this._addMapListeners()),"PT"==n&&(i=this._viewData.selgeo1.nivgeo+"_P",GCO5.core.GcDelayUtil.callLater(function(){GCO5.appModel.loadLayers(r._onPointLayerLoaded,r,[{name:i,refgeo:0}],!1,r.map.getName(),"addLayer")},[],e,this)),this.map.getStatLayer().styles.strokeStyle="PT"==n?"none":"#ccc"},_onPointLayerLoaded:function(t,e){var i=GCO5.core.GcObjectUtil.getFirstKey(t),n=this._viewData["selgeo"+this._viewData.selNumActive],r=this._viewData.selgeo1.getTopology(),r=(this.map.getStatLayer().styles.selectable="PG"==r,this._getPointIndicModel(i,t)),t=(this.map.addThemes(r),n.getSelIds(n.nivgeo,this.map.getIdExtent()));GCO5.core.GcDelayUtil.callLater(this.map.drawSelIds,[i,t,!0],50,this.map)},_getPointIndicModel:function(t,e){var t=t.substr(0,t.length-2),i=GCO5.appModel.getRefData(t,this.map.getIdExtent()),n=GCO5.appModel.getInfo("LibNivgeo",[t]),r=this.map.nivgeo,n={classes:["1"],classeslib:[n],c_id_dataset:"_report",c_id_views:[this.map.getIdExtent()],c_id_indicateur:"symb",c_id_extent:this.map.getIdExtent(),c_lib_indicateur:"",mods:["1"],mods_o:{1:1},nivgeo:r,nivgeos:[r],c_id_typind:"I",c_topo:"PT",colorPalette:[{col:"#ff6600",symb:"sq",size:5}],nivgeos_a:[r],disperse:-1},r={options:{},indic:{c_id_view:this.map.getName(),c_id_symb:t},distribution:{codes:i.codgeo.map(function(t){return 1}),frequences:[]}},t=new GCO5.model.indics.IndicModel(n),i={},n=(t.updateWithServerFullData({content:r}),i[t.getPk()]=new GCO5.model.indics.MapIndicModel(t));return GCO5.appModel.getPointLayerDef(n,e,this.map.getName()),i},_addMapListeners:function(){var e=this.map;this.addMixinMapListeners(),$("body").on("keyup",function(t){e&&e.onKeyUp.apply(e,[t])}),$("body").on("keydown",function(t){e&&e.onKeyDown.apply(e,[t])})},_updateHashAfterRenderChapter:function(){if(console.log("ReportComponent _updateHashAfterRenderChapter","this.gcsm.historyBrowsing",this.gcsm.historyBrowsing),!this.gcsm.historyBrowsing&&!this.gcsm.getPrintMode()){var t,e=$.bbq.getState(),i={};for(t in e)["z","i","i2","f","f2","s","s2","bbox","selcodgeo"].indexOf(t)<0&&(i[t]=e[t]);i.selgeo1=this._viewData.selgeo1.getSingleCodgeo()&&this._viewData.pkSelgeo1&&!this._viewData.selgeo1IsDefault?this._viewData.pkSelgeo1.replace("|","."):null,i.selgeo2=this._viewData.selgeo2&&this._viewData.selgeo2.getSingleCodgeo()&&this._viewData.pkSelgeo2&&!this._viewData.selgeo2IsDefault?this._viewData.pkSelgeo2.replace("|","."):null,i.selgeo1||delete i.selgeo1,i.selgeo2||delete i.selgeo2,this._viewData.selectedBlock?i.block=this._viewData.selectedBlock:(i.report=this._viewData.selectedReport,i.chapter=this._viewData.selectedChapter),GCO5.core.GcObjectUtil.equal(i,e)||$.bbq.pushState(i,2)}},onHashChange:function(t){if(!t.report&&!t.chapter&&!t.block)return t.i&&t.view?(t.c_id_indicateur=t.i.split(".")[1],t.c_id_dataset=t.i.split(".")[0],t.f&&(t.f1code=t.f),$(GCO5.topApp).triggerHandler(GCO5.view.component.AComponent.LOAD_COMPONENT,{id:"indicator",categ:"main",indicModel:new GCO5.model.indics.IndicModel(t),mapName:t.view}),!1):void 0;var e,i,n,r,a,s,o,l,c;this._super(),!t.p&&this.gcsm.getPrintMode()?this._onExitPrint():(e=t.chapter,i=t.report,n=t.block,l=t.selgeo1,t=t.selgeo2,i&&i!=this._viewData.selectedReport&&(this.setObservableProperty("selectedReport",i,{noTrigger:!0}),r=!0),e&&e!=this._viewData.selectedChapter&&(this.setObservableProperty("selectedChapter",e,{noTrigger:!0}),r=!0),n&&n!=this._viewData.selectedBlock&&(this.setObservableProperty("selectedBlock",n,{noTrigger:!0}),r=!0),a=this._viewData.pkSelgeo1&&l&&l!=this._viewData.pkSelgeo1.replace("|","."),c=this._viewData.pkSelgeo2&&t&&t!=this._viewData.pkSelgeo2.replace("|","."),a&&(l=(o=l.split(".")).shift(),s=new GCO5.model.maps.SelGeo({nivgeo:l,codgeo:o.join(".")}),c||this._setSelgeo(s,null,{selNum:1,customSel:!0}),this.setObservableProperty("selectedGeoMethod","r"),r=!1),c&&(l=(o=t.split(".")).shift(),c=new GCO5.model.maps.SelGeo({nivgeo:l,codgeo:o.join(".")}),this._setSelgeo(a?s:null,c,{selNum:2,customSel:!0}),this.setObservableProperty("selectedGeoMethod","r"),r=!1),r&&(i?this.setObservableProperty("selectedReport",i,{forceTrigger:!0}):e?this.setObservableProperty("selectedChapter",e,{forceTrigger:!0}):n&&this.setObservableProperty("selectedBlock",n,{forceTrigger:!0})))},_setReportDimensions:function(t){var e,i;this.gcDashboardModel&&(t=t||this.curTypeBloc,this.reportMode?$("body").hasClass("pre-print")||this.cli.isInIframe()||(e=$(".report-viewport").offset().top,$(".report-viewport").height(Math.min(1600,GCO5.browser.height-e-12))):(e=$("#reportContent").offset().top,t&&$("#reportContent").height("TA"==t.substr(0,2)||"TX"==t.substr(0,2)?"auto":Math.min(1600,GCO5.browser.height-e-12))),t=$(".cu-pilotage",this._$renderedContent),e=GCO5.browser.height-t.offset().top-1,this.cli.isInIframe()&&(i=$(".iframe-notice-container")).length&&(e-=i.height()),t.height(e))},onResize:function(t,e){var i;this._resizing||(window.scrollTo(0,1),this._isMapVisible()?GCO5.view.component.MapIndicatorCommon.onResize.call(this):((i=this)._resizing=!0,GCO5.core.GcDelayUtil.callLater(function(){i._resizing=!1},[],20,this),this._setReportDimensions(),this.reportMode&&this.gcDashboardModel&&(this._viewData.selectedBlock||$(".report-viewport").css("visibility","hidden"),this.gcDashboardModel.resize(t),this._viewData.selectedBlock||GCO5.core.GcDelayUtil.callLater(function(){$(".report-viewport").css("visibility","visible")},[],5,this))))}}),puremvc.define({name:"GCO5.view.mediator.ReportMediator",parent:puremvc.Mediator},{initComponent:function(t){GCO5.core.GcComponentUtil.setupAndShowComponent(this.viewComponent,t)},onRegister:function(){var t=new GCO5.view.component.ReportComponent;this.setViewComponent(t),this.addListeners(t)},listNotificationInterests:function(){return[GCO5.AppConstants.INIT_COMPONENT,GCO5.AppConstants.ON_RESIZE,GCO5.AppConstants.BEFORE_PRINT,GCO5.AppConstants.POSTROBOT_IN_MSG]},handleNotification:function(t){var e=t.getName(),i=t.getBody(),n=this.viewComponent;switch(e){case GCO5.AppConstants.INIT_COMPONENT:if("report"==i.id){if(!GCO5.appModel.hasReports()&&!GCO5.core.ClientInfo.getInstance().isSingleBlockReport())return;this.initComponent(i)}break;case GCO5.AppConstants.ON_RESIZE:n.onResize();break;case GCO5.AppConstants.BEFORE_PRINT:break;case GCO5.AppConstants.POSTROBOT_IN_MSG:if(n.isVisible()&&"Report"==i.scope)switch(i.msg){case"changeChapter":i.data.chapter&&n.setObservableProperty("selectedChapter",i.data.chapter);break;case"printChapter":n._enterReportPrePrintMode();break;case"exportReportData":console.log("exportReportData"),n._enterReportExportMode()}}},addListeners:function(t){var n=this,e=t.constructor;$(t).on(e.CHANGE_MAPVIEW,function(t,e,i){GCO5.appModel.loadMapViewModel(n.onChangeMapView,n,e,i)})},onChangeMapView:function(i){var n=this.viewComponent,t=GCO5.model.maps.SelGeo.getcurSelgeo();t&&t.getSingleCodgeo()?(i.selgeo=t).getSelIds(i.nivgeo,i.id_extent,function(t,e){0==e&&(i.selgeo=null),n.setupMap(i)}):n.setupMap(i)}},{NAME:"ReportMediator"}),GCO5.view.component.IndicatorComponent=GCO5.view.component.AComponent.extend({statics:{NAME:"GCO5.view.component.IndicatorComponent",CHANGE_MAPVIEW:"chgmv",CHANGE_INDIC:"chgind"},map:null,map2:null,_waitingForFirstMapRendered:!0,_mapRendering:null,_studyLoading:null,_filteredDomTree:null,_updatingTreeFilters:null,_URLIndicsToLoad:[],_pendingSelgeoPt:null,tableView:null,ficindicView:null,mobileReducedMode:null,_fireInitEvents:function(i){GCO5.core.GcComponentUtil.animateCollapsibleSet($(".treeindics",this._$renderedContent)),GCO5.core.GcComponentUtil.animateCollapsibleSet($(".indics_filter1",this._$renderedContent),"atih_pmsi"==GCO5.appModel.getOption("app")),this._super(i);var n,r,t,e,a=this.cli.checkAndCleanState($.bbq.getState()),s=this;i.selgeo&&"PT"==i.selgeo.getTopology()&&(this._pendingSelgeoPt=i.selgeo),i.indicModels&&0<i.indicModels.length?(s._URLIndicsToLoad=i.indicModels,i.mapName&&(this._viewData.selectedView0=i.mapName),this._studyLoading=i.indicModels):i.indicModel?(s._URLIndicsToLoad.push(i.indicModel),i.mapName&&(this._viewData.selectedView0=i.mapName)):GCO5.core.GcStringUtil.isEmpty(GCO5.initInfo.indics)?"favs"==i.src?(this._viewData.selectedView0=i.mapName||GCO5.appModel.getInfo("mapNameFromNivgeo",[i.nivgeo,i.id_extent]),i.selgeo&&"PG"==i.selgeo.getTopology()&&i.selgeo.sessionRegister()):a.i?0!=a.i.indexOf("_import")&&"ExternaldataComponent"!=i.previousActiveComponentName&&["","2"].forEach(function(t){if(n=a["i"+t]){if(r=n.split("."),0==(i={c_id_dataset:r[0],c_id_indicateur:r[1]}).c_id_dataset.indexOf("_import"))return;(n=a["s"+t])&&(i.serie=s._viewData["serie"+(""==t?"1":t)]=n.replace(/_slash_/g,"/")),(n=a["f"+t])&&(i.f1code=n),(n=a["e"+t])&&(i.f0code=n);var e=new GCO5.model.indics.IndicModel(i);(n=a["t"+t])&&e.setOption("tree",n),s._URLIndicsToLoad.push(e)}}):a.view||i.tag||i.theme||"ExternaldataComponent"==i.previousActiveComponentName||(e=GCO5.appModel.getInitKey("indicsLoadinit"),r=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("dataset"),{c_id_dataset:e.c_id_dataset}),!e||1!=r.length||!GCO5.core.GcStringUtil.isEmpty(r[0].filter1)&&GCO5.core.GcStringUtil.isEmpty(e.f1code)||(s._URLIndicsToLoad.push(new GCO5.model.indics.IndicModel(e)),e.c_id_view&&Array.isArray(e.c_id_view)&&0<e.c_id_view.length&&(t=GCO5.appModel.getConcept("view").map(function(t){return t.c_id_view}),0<(e=GCO5.core.GcArrayUtil.intersection(e.c_id_view,t)).length&&(this._viewData.selectedView0=e[0])))):(t={c_id_dataset:(r=GCO5.initInfo.indics.split("."))[0],c_id_indicateur:r[1]},GCO5.initInfo.f1code&&(t.f1code=GCO5.initInfo.f1code),s._URLIndicsToLoad.push(new GCO5.model.indics.IndicModel(t)),GCO5.core.GcStringUtil.isEmpty(GCO5.initInfo.view)||0<=GCO5.core.GcArrayUtil.indexOfByKey(GCO5.appModel.getConcept("view"),"c_id_view",GCO5.initInfo.view)&&(this._viewData.selectedView0=GCO5.initInfo.view),history.replaceState({},"newstate",this.cli.getUrlWithoutQueryString()+"#c=indicator"),GCO5.initInfo.indics=GCO5.initInfo.serie=GCO5.initInfo.view=null),"ReportComponent"!=i.previousActiveComponentName||i.indicModel||(e=GCO5.model.maps.SelGeo.getcurSelgeo())&&e.getIdView()&&e!=this._viewData.selectedView&&(this._viewData.selectedView=this._viewData.selectedView0=e.getIdView(),s._URLIndicsToLoad=[]),this.changeMapView(this._viewData.selectedView0),this.setObservableProperty("nbIndicsToLoadInit",this._viewData.nbIndicsToLoadInit0=this._URLIndicsToLoad.length),this.__setMapDimensions(this.map,!0)},afterShow:function(){this._super(),this.alignFormLabels(".labelgroup")},goToMainContent:function(){$('[data-link="searchStr"]',this._$renderedContent).focus()},getSaveState:function(){return{fav:1,study:1,url:1}},_onAddedToStage:function(t){this.mobileReducedMode=this.cli.isTinyWidthScreen(),$("#tm_map",this._$renderedContent).trigger("click");var e=this.cli.checkAndCleanState($.bbq.getState()),i=(t.selgeo&&t.selgeo.sessionRegister(),t.extent&&(this._viewData.extent0=new GCO5.model.maps.GeoExtent(t.extent)),this);if(t&&t.tag?(this.setObservableProperty("tag",t.tag),GCO5.core.GcDelayUtil.callLater(function(){i.setObservableProperty("selectedTree","__KEYWORD__",{forceTrigger:!0})},[],1,i)):(this.setObservableProperty("tag",null),this.setObservableProperty("selectedTree",this._viewData.idTree0)),e.theme?(t.indicModels=null,t.theme=e.theme,this.gcsm.freeze("openTreeIndicsOnTheme"),GCO5.core.GcDelayUtil.callLater(this.openTreeIndicsOnTheme,[e.theme,!0],1,this)):t&&t.theme&&(this.gcsm.freeze("openTreeIndicsOnTheme"),GCO5.core.GcDelayUtil.callLater(this.openTreeIndicsOnTheme,[t.theme,!0],105,this)),t&&"RECALL"==t.action){var n=t.indicModels&&0<t.indicModels.length;if("favs"==t.src&&("selgeo"==t.type||t.selgeo&&!n)){if(t.mapName!=this._viewData.selectedView)return this.changeMapView(t.mapName),void this._super(t);this.map.drawSelgeo(t.selgeo,null,!0)}n?(this._URLIndicsToLoad=t.indicModels,this._studyLoading=t.indicModels):t.indicModel?this._URLIndicsToLoad.push(t.indicModel):e.view&&e.view!=this._viewData.selectedView&&this.changeMapView(e.view),0<this._URLIndicsToLoad.length&&(this._viewData.selectedTheme="",this._backToTreeIndics(),t.mapName&&t.mapName!=this._viewData.selectedView?this.changeMapView(t.mapName):(n=!1,t.selgeo&&"PT"==t.selgeo.getTopology()&&(this._pendingSelgeoPt=t.selgeo),t.selgeo&&"PG"==t.selgeo.getTopology()?this.map.drawSelgeo(t.selgeo,null,n=!0):this._viewData.extent0&&(n=!0,this.map.setMapExtent(this._viewData.extent0),this._viewData.extent0=null),n||GCO5.core.GcDelayUtil.callLater(this._loadNextIndicData,[],5,this)),this.setObservableProperty("nbIndicsToLoadInit",this._viewData.nbIndicsToLoadInit0=this._URLIndicsToLoad.length))}this.map?this.onResize():this.setTableVisibility(),t&&t.tag||(e=GCO5.model.indics.Dataset.getTree(),(n=this._viewData.selectedTheme)&&0==n.indexOf("_import")&&(this._reSyncImportedData(),this.setObservableProperty("selectedTheme",n,{forceTrigger:!0})),(t&&"favs"==t.src||0<=["FavsComponent","ExternaldataComponent"].indexOf(t.previousActiveComponentName))&&e&&GCO5.core.GcDelayUtil.callLater(this._updateDomainTree,["withImport"],10,this)),this._super(t)},_reSyncImportedData:function(){var t=GCO5.model.indics.Dataset.getDataset(this._viewData.selectedTheme),e=this.map.getIndicsModelsIndexed();this._viewData.selectedView!=t.getCurMapName()&&t.setCurMapName(this._viewData.selectedView),this._viewData.selectedIndics_a.forEach(function(t){t.disabled||e[t.pk].enable(),e[t.pk]&&e[t.pk].isEnabled()!=!t.disabled&&t.disabled&&e[t.pk].disable()})},setupMap:function(t){var e,i=this._getMapSuffix(!0),n=this["map"+this._getMapSuffix()],i=this._viewData["selectedIndics_a"+i],r=n?n.getContainer():$(".mapContainer",this._$renderedContent).eq(this._viewData.mapNumActive-1),a=this;t.mapContainer=r,t.styles.drillMaps=!1,t.styles.extent0=t.extent?new GCO5.model.maps.GeoExtent(t.extent):this._viewData.extent0,t.legendContainer={cv:null,divH:$(".maplegendH",r.parent()),div:$(".maplegendV",this._$renderedContent).eq(this._viewData.mapNumActive-1)},t.copyrights=GCO5.appModel.getInfo("infoFromMapName",[t.mapName,"copyrights"]),this.setObservableProperty("mapCopyrights",t.copyrights),this.__setMapDimensions(n,!0),this._mapRendering=!0,"2"==this._getMapSuffix()&&this.map.getIdExtent()==t.id_extent&&(t.styles.extent0=this.map.getMapExtent()),n?(this._waitingForUpdateMapTitle=!1,n.setup(t),this.tableView&&this._tableViewActive()?this._loadAllIndicModels(r=function(){a.tableView.setMap(n)},this)||r.apply(this.tableView):this.ficindicView&&this._ficindicViewActive()&&this._initFicindicView(),e=n.getIndicsModelsIndexed(),a=this,i.forEach(function(t){t=e[t.pk];t&&GCO5.core.GcDelayUtil.callLater(a._buildMetaIndic,[t],10,a)}),n.mapToolTip.clear(),n.zon1LayerName=null):(2==this._viewData.mapNumActive&&this._updateMapIndicsLib(null,null,!0),this._viewData.selcodgeo0&&(t.selgeo=new GCO5.model.maps.SelGeo({id_extent:t.id_extent,nivgeo:t.nivgeo,codgeo:this._viewData.selcodgeo0})),n=this["map"+this._getMapSuffix()]=new GCO5.view.component.MapViewThematic(t),2==this._viewData.mapNumActive&&GCO5.core.GcDelayUtil.callLater(a.__setMapDimensions,[n,!0],1,a),this._viewData.selcodgeo0=null,this._addMapListeners(n)),a.hasTwoMaps()&&this.map2&&this._viewData.linkedMaps&&this.map.linkToMap(this.map2,!0),this._viewData.structuredByExtent&&1==this._viewData.mapNumActive&&(this.gcsm.registerCuState("view",n.getIdView()),this.gcsm.registerCuState("extent",n.getIdExtent())),this._syncUIAfterChangeMapView(t)},_prepareViewData:function(t){GCO5.core.GcObjectUtil.defaults(this,GCO5.view.component.MapIndicatorCommon);function i(t){return h.gclg.getString(t,"pilotage","indicator")}var n=GCO5.appModel.getConcept("tree"),r=GCO5.appModel.getInitKey("curTree"),o=GCO5.core.GcArrayUtil.indexOfByKey(n,"c_id_tree",r),a=GCO5.appModel.getConcept("view"),s=0<=o?n[o].themes.concat():[],l=a[0].pk,c=a[0].id_nivgeo,h=this,a=(GCO5.appModel.getOption("default_view")?d=GCO5.core.GcArrayUtil.getSubArray(a,{pk:GCO5.appModel.getOption("default_view")}):GCO5.appModel.getOption("default_extent")&&(d=GCO5.core.GcArrayUtil.getSubArray(a,{id_extent:GCO5.appModel.getOption("default_extent")})),d&&0<d.length&&(l=d[0].pk,c=d[0].nivgeo),$.deparam.fragment()),d=(!a.view||(d=GCO5.appModel.getInfo("infoFromMapName",[a.view,"pk","id_view"]))&&(l=d,c=GCO5.appModel.getInfo("infoFromMapName",[a.view,"id_nivgeo","id_view"])),GCO5.model.indics.Dataset.getTree()),u=(d&&(s=d.concat(s)),this._viewData=this._getBaseViewData(this.getShortName())),d=r,p=(t&&t.tag&&(r="__KEYWORD__"),this._getTreeType(r)),g=[{color:"#FFDDF5",label:i("INDIC_TYPO")},{color:"#ddeeff",label:i("INDIC_RATIOS")},{color:"#FFffdd",label:i("INDIC_ADDITIVES")},{color:"#ccffee",label:i("INDIC_POINTS")},{color:"#f0f0f0",label:i("INDIC_FLUX")}],f=this.cli.checkAndCleanState($.bbq.getState()).synth,g={cp:"tm",selectedRestit:"m",mapVisibility:!0,tree_a:s,nbDoms:s.length,indic_a:[],indtypes_a:g,nivgeo:c,selectedView0:l,selectedTheme:"",selectedIndic:"",selectedIndics_a:[],selectedIndicModels_o:{},selectedIndics_a_c2:[],selectedIndicModels_o_c2:{},displaySynth:f,f1_a_c2:[],indic1_c2:"",indic2_c2:"",libIndic1_c2:"",libIndic2_c2:"",serie1_a_c2:[],serie1_c2:null,serie2_c2:null,serie2_a_c2:[],source1_c2:"",source2_c2:"",anim1_c2:!0,anim2_c2:!0,nivgeosIndics_c2:"*",viewsIndics_c2:"*",nivgeo_c2:c,linkedMaps:!0,selectedFicIndic:"",nivgeosIndics:"*",viewsIndics:"*",tabmenu_a:GCO5.appModel.getTabMenu(),ficmenu_a:GCO5.appModel.getFicMenu(),printDoc:!0,nbIndicsInTheme:0,ficindics_a:[],theme_a:[],selectedTree:r,typeTree:p,idTree0:d,trees:n,selectedTypind:"",searchStr:"",tag:t.tag,typind_a:GCO5.appModel.getTypindList(this.cli.isTinyWidthScreen()?["RC"]:null),hasTag:function(){return null!=this.tag},getFilter1Mods:function(t){for(var e=t.split("."),i=null,n=0;n<this.indic_a.length;n++)this.indic_a[n].c_id_dataset===e[0]&&this.indic_a[n].c_id_indicateur===e[1]&&(i=this.indic_a[n]);if(!i)throw new Error("Indicateur introuvable");var r,a,t=i.f1_a;return i.c_mods_nomenc.hasOwnProperty(this.selectedTheme)&&null!==i.c_mods_nomenc[this.selectedTheme]&&(r=i.c_mods_nomenc[this.selectedTheme].split("|"),0!==(a=t.filter(function(t){return 0<=r.indexOf(t.id)})).length&&(t=a)),t},hasEssentials:function(){return GCO5.appModel.getInfo("essentialFlag",[this.selectedTree])},getF1Lib:function(t,e){if(!GCO5.appModel.getOption("showFilter1Lib0")&&(null==e||0==parseFloat(e)))return"";var i,t=(t=GCO5.appModel.getInfo("filter1Data",[t]))||this.f1_a,t=GCO5.core.GcArrayUtil.getSubArray(t,{id:""+e});if(0==t.length&&(this.indic_a.forEach(function(t){t.filter1&&t.f1_a&&(1==(t=t.f1_a.filter(function(t){return t.id==e})).length&&(i=t[0].lib))}),i))return" - "+i;return 0==t.length?"":" - "+t[0].lib},getDomLib:function(){var t;return(t="_import"==this.selectedDom?GCO5.model.indics.Dataset.getTree()[0].c_lib:(t=GCO5.appModel.getInitKey("dom_o")[this.selectedDom])&&t.label)?t.toUpperCase().split("|").join(" "):""},getThmLib:function(){if("_import"==this.selectedDom)return GCO5.model.indics.Dataset.getTree()[0].children.filter(function(t){return t.c_id_theme==u.selectedTheme})[0].c_lib;if(this.selectedDom==this.selectedTheme)return"";var i=GCO5.appModel.getInitKey("theme_o")||{},t=i[this.selectedTheme],n=[];return t&&t.id_parent&&function t(e){e=i[e.id_parent];return!e||!e.id_parent||(n.push("<a href='javascript:void(0)' class='normal'>"+e.label+"</a> &gt; "),t(e))}(t),n.reverse(),t?n.join("")+t.label:""},hasSynthMenu:function(){return"1"!==GCO5.appModel.getOption("always_hide_synth")},getIndicBackgroundColor:function(){var t=this.getIndex();return u.isSortByTypeVisible?u.sortByType?{C:"#ddeeff",R:"#FFffdd",Z:"#FFDDF5",I:"#FFDDF5",P:"#ccffee",O:"#ccffee",F:"#f0f0f0"}[this.data.c_id_typind]:t%2?"#fff":"#f6f6f6":"#fff"},getIndicList:function(){var i={C:1,R:2,I:0,P:3,O:4,F:5},n=!1,r=[],a=0,s=GCO5.appModel.getInfo("infoFromMapName",[this.selectedView,"id_view"]);return this.indic_a.forEach(function(e){var t;0!=e.c_essential&&a++,u.essentiels2&&0==e.c_essential||(e.c_id_views.indexOf(s)<0&&(n=!0),t={pk0:e.pk},e.c_id_theme&&0<=e.c_id_theme.indexOf("@")&&(t.c_id_theme=e.c_id_theme),t=GCO5.core.GcArrayUtil.getSubArray(h.getSelectedIndics(),t),e.selected=0<t.length,e.f1_a&&(e.f1_a.forEach(function(t){t.selected=!1}),e.selected&&t.forEach(function(t){0<=(o=GCO5.core.GcArrayUtil.indexOfByKey(e.f1_a,"id",t.f1code))&&(e.f1_a[o].selected=!0)})),r.push(e))}),h.setObservableProperty("nbIndicsInTheme",r.length),h.setObservableProperty("nbEssentiels",a),h.setObservableProperty("isSortByTypeVisible",1<r.length),GCO5.core.GcDelayUtil.callLater(h.setObservableProperty,["hasNoCompatibleIndics2",n,{forceTrigger:!0}],10,h),r.sort(function(t,e){return u.sortByType?i[t.c_id_typind]<i[e.c_id_typind]?-1:i[t.c_id_typind]>i[e.c_id_typind]?1:t.c_ordre<e.c_ordre?-1:t.c_ordre>e.c_ordre?1:0:t.c_ordre-e.c_ordre})},getRefLib:function(){if(0==this.tableref_a.length)return"";var t=GCO5.core.GcArrayUtil.indexOfByKey(this.tableref_a,"data",this.selectedTableRef);if(t<0)return"";var e,t="<b>"+this.tableref_a[t].label+"</b>",i=this.tableInfo;return i.selected||i.filtered<i.eft?(e=h.gclg.getString("SELECTION","concepts"),["de","en"].indexOf(h.gclg.getLang())<0&&(e=e.toLowerCase()),e=i.selected?", "+e+h.gclg.getString("P2")+" "+h.gclg.formatNumber(i.selected):"",null!=i.filtered&&i.filtered<i.eft?t+"<br>"+h.gclg.getString("FILTER2")+h.gclg.getString("P2")+" "+h.gclg.formatNumber(i.filtered)+" "+h.gclg.getString("ROWS","tables")+" "+h.gclg.getString("OVER")+" "+h.gclg.formatNumber(i.eft)+e:t+"<br>"+h.gclg.formatNumber(i.eft)+" "+h.gclg.getString("ROWS","tables")+e):t+"<br>"+h.gclg.formatNumber(i.eft)+" "+h.gclg.getString("ROWS","tables")},getExtent:function(){return this.extent_a},searchGeo:function(t){GCO5.core.GcComponentUtil.displaySlidingPanel(t.target),$(h.getActiveMap()).triggerHandler(GCO5.view.component.MapViewThematic.DISPLAY_GEO_SETTINGS,["Search"])},filtReset:function(t){h._resetTreeFilters(this.ficSelected);var e=$("#label_expand_1.expandmore__button",h._$renderedContent);e.hasClass("js-expandmore-button is-opened")&&e.trigger("click")},keySearch:function(){h._onTreeFiltering(e,{path:"searchStr",value:u.searchStr})},indvisi:function(){return u.selectedRestit.indexOf("f")<0?!this.disabled:this.ficSelected},getSelectedFicIndicLabel:function(){var t=GCO5.core.GcArrayUtil.indexOfByKey(this.ficindics_a,"data",this.selectedFicIndic),t=0<=t?GCO5.core.GcStringUtil.proper(this.ficindics_a[t].label,!0):("*"===this.selectedFicIndic?h.gclg.getString("COMPAR_TABLE","restit","indicator"):h.gclg.getString("AREA_PROFILE","indics")).toUpperCase();return t},checkFicSectionVisibility:function(){return"1"!==GCO5.appModel.getOption("always_hide_synth")&&0<this.getNbIndicsNotImported()||0<this.nbIndicsToLoadInit||this.hasSpine&&this.hasSelgeo?"flex":"none"},getNbIndicsNotImported:function(){return this.selectedIndics_a.reduce(function(t,e,i){return t+ +!e.external},0)},getNbIndicsNotImportedAndDisplayable:function(){return this.selectedIndics_a.reduce(function(t,e,i){return t+ +(!e.external&&e.valuesDisplayable)},0)},getNextFicIndicInfo:function(){var t=GCO5.core.GcArrayUtil.indexOfByKey(this.selectedIndics_a,"pk",this.selectedFicIndic);return 0<=t&&t<this.selectedIndics_a.length-1||this.hasSelgeo&&"*"!=this.selectedFicIndic},nextFicIndic:function(){var t=GCO5.core.GcArrayUtil.indexOfByKey(this.selectedIndics_a,"pk",this.selectedFicIndic);h.setObservableProperty("selectedFicIndic",0<=t&&t<this.selectedIndics_a.length-1?this.selectedIndics_a[t+1].pk:"*")},getPrevFicIndicInfo:function(){return 0<GCO5.core.GcArrayUtil.indexOfByKey(this.selectedIndics_a,"pk",this.selectedFicIndic)||"*"==this.selectedFicIndic},prevFicIndic:function(){var t=GCO5.core.GcArrayUtil.indexOfByKey(this.selectedIndics_a,"pk",this.selectedFicIndic);t<0&&(t=this.selectedIndics_a.length),h.setObservableProperty("selectedFicIndic",this.selectedIndics_a[t-1].pk)},selectedExtentFn:function(t){return u["selectedExtent"+(2==t?"2":"")]}};GCO5.core.GcStringUtil.isEmpty(GCO5.appModel.getOption("defaultSpineChart"))||(g.hasSpine=!0),1==g.nbDoms&&(g.selectedDom=s[0].c_id_theme),"1"==GCO5.appModel.getOption("sortIndicsByType")&&(g.sortByType=!0),g.selectedExtentFn.set=function(t,e,i){h.setObservableProperty("selectedExtent"+(1==this.mapNumActive?"":"2"),t)},g.selectedExtentFn.depends=["selectedExtent","selectedExtent2"],g.getViews2=function(){return this.getViews("2")},g.getViews2.depends=["selectedExtent2"],u.getSelectedIndics2.depends=["hasNoCompatibleIndics_c2"],g.indvisi.set=function(t,e,i){0<=u.selectedRestit.indexOf("f")&&(this.ficSelected=t),0<=u.selectedRestit.indexOf("m")&&(this.disabled=!t)},g.getNextFicIndicInfo.depends=["selectedIndics_a.**","selectedFicIndic","hasSelgeo"],g.getPrevFicIndicInfo.depends=["selectedIndics_a.**","selectedFicIndic","hasSelgeo"],g.hasEssentials.depends=["selectedTree"],g.checkFicSectionVisibility.depends=["selectedIndics_a.**","nbIndicsToLoadInit","hasSelgeo"],g.getSelectedFicIndicLabel.depends=["selectedFicIndic"],g.getDomLib.depends=["selectedDom"],g.getThmLib.depends=["selectedTheme"],g.getIndicBackgroundColor.depends=["sortByType"],g.getIndicList.depends=["sortByType","essentiels2","selectedView","mapNumActive"],g.getRefLib.depends=["tableInfo"],g.hasTag.depends=["tag"],g.selectedExtent=GCO5.appModel.getInfo("infoFromMapName",[l,"id_extent"]),g.selectedTableRef=GCO5.appModel.getInfo("infoFromMapName",[l,"pkgeo"]),g.selectedExtent2=g.selectedExtent,u.getViewLib.depends=["selectedView","selectedView2"],"atih_pmsi"==GCO5.appModel.getOption("app")&&((f={filter0_a:[],selectedF0Code:"",selectedF0Codes:[],selectedFilter0:"",selectedF0Lib:"",searchStrF0Lib:"",selectedFilter0List:"1",f0code0:"",note_series:null,displayGHTEtabs:!1,reg_a:[],dep_a:[],reg0_a:[],dep0_a:[],year_a:[],multipleSelectedF0Codes:function(){var t=this.selectedF0Codes.length;return 0<t&&t<=10},myFilter0Lib:function(){return 0<=this.selectedFilter0.indexOf("ght")?"Mes GHT":"Mes établissements"},isGHT:function(){return 0<=this.selectedFilter0.indexOf("ght")},isGHTSet:function(){if(!this.selectedF0Code||!this.isGHT())return!1;var t=GCO5.appModel.getInfo("refTabVars",[this.selectedFilter0.replace("ght",""),h.map.getIdExtent()]);return"00000"!=this.selectedF0Code&&this.selectedF0Code.indexOf("|")<0&&0<=GCO5.core.GcArrayUtil.indexOfByKey(t,"c_varname","ght")},f0SearchFailed:function(){return 0==this.filter0_a.length},sumF0codes:function(){h.setObservableProperty("selectedF0Code",u.selectedF0Codes.join("|"))},searchFilter0Lib:function(){GCO5.core.GcDelayUtil.callLater(h.setObservableProperty,["selectedYear",u.selectedYear,{forceTrigger:!0}],1,h)},filter0LibReset:function(t){h.setObservableProperty("searchStrF0Lib",""),h.setObservableProperty("selectedReg",""),h.setObservableProperty("selectedDep","",{noTrigger:!0}),GCO5.core.GcDelayUtil.callLater(h.setObservableProperty,["selectedYear",u.selectedYear,{forceTrigger:!t}],1,h)},_onGHTLayerLoaded:function(i){var t=GCO5.appModel.getPointLayerDef(null,i,h.map.getName(),{styles:{rovable:!0,noEtiq:!0,symbol:"sq",strokeStyle:"#999",fill:"#ff0000",fillStyle:"#ff0000",size:4}}),n=GCO5.core.GcObjectUtil.getFirstKey(i);t.styles.filterIndices=i[n].ght?i[n].ght.map(function(t,e){return Number(t==u.selectedF0Code)&&(!i[n].series[e]||0<=i[n].series[e].indexOf(u.selectedYear))}):null,h.map.addLayer(t),h.gcsm.unFreeze("map",10)}}).myFilter0Lib.depends="selectedFilter0",f.isGHT.depends="selectedFilter0",f.isGHTSet.depends=["selectedFilter0","selectedF0Code"],f.multipleSelectedF0Codes.depends="selectedF0Codes",f.f0SearchFailed.depends="filter0_a",GCO5.core.GcObjectUtil.extend(this._viewData,f)),GCO5.core.GcObjectUtil.extend(this._viewData,g),a.selcodgeo?this._viewData.selcodgeo0=a.selcodgeo:a.bbox&&(this._viewData.extent0=new GCO5.model.maps.GeoExtent(a.bbox))},_tableViewActive:function(){return $("#tm_nav_2",this._$renderedContent).is(":visible")},_ficindicViewActive:function(){return $("#tm_nav_3",this._$renderedContent).is(":visible")},_setFicIndicVisibility:function(t){this.setObservableProperty("selectedFicIndic",t)},_closeTreeIndics:function(){var t=$(".treeindics",this._$renderedContent);t.find(".ui-collapsible-content[aria-hidden='false']").siblings("h3").find("a").trigger("click"),t.find(".ui-selected").removeClass("ui-selected")},addIndicToActiveMap:function(t,e,i,n){t={c_id_dataset:t,c_id_indicateur:e};GCO5.core.GcStringUtil.isEmpty(i)||(t.serie=i),GCO5.core.GcStringUtil.isEmpty(n)||(t.f1code=n),this._loadNextIndicData(new GCO5.model.indics.IndicModel(t))},_addListeners:function(){var c,h,r,o,d=this,u=this.constructor,p=d._viewData,i=$("#cth_indic_cb",this._$renderedContent),n=($(this._$renderedContent).on("click","dialog a.link-theme",function(t){d.openTreeIndicsOnTheme($(this).data("link"),!0)}),$("#tm-prolonger",this._$renderedContent).on("click","a",function(t){d._backToTreeIndics(),$(GCO5.topApp).triggerHandler(GCO5.view.component.AComponent.LOAD_COMPONENT,{id:$(this).data("cu"),categ:"main"})}),$.observe(p,"linkedMaps",function(t,e){p.noTrigger||((c=e.value)&&d.map2.setMapExtent(d.map.getMapExtent()),d.map.linkToMap(c?d.map2:null,!0))}),$("#tm_extent_cb2",this._$renderedContent));n.on("change",function(t,e){GCO5.core.GcDelayUtil.callLater(function(){n.val()!=p.selectedExtent2&&d.setObservableProperty("selectedExtent2",n.val())},[],1,d)}),$.observe(p,"selectedView","selectedView2",function(t,e){if(p.noTrigger)return!0;c=e.value;var e="selectedView2"==e.path?"2":"",i=d["map"+e];if(("2"==e?2:1)==p.mapNumActive){var n=p.mapIndicModels||(i?i.getEnabledIndicsModelsIndexed():d.dataDef_o.mapIndicModels);if(i)if(i.anamorphing&&i.anamorph(!1,null,!0),r=i._changingViewKeepExtent?i.getMapExtent().rect:i.beforeChangeView(c).extent,i.isReprojected())return r=i.restoreProjInit(!0),i.updateGlobe(null,null,null,null,!0),GCO5.core.GcDelayUtil.callLater(function(){var t=i.beforeChangeView(c);r=t.extent,$(d).triggerHandler(u.CHANGE_MAPVIEW,[c,r,n])},[],10,d),void d.gcsm.freeze("render");p.compthismap&&d.setObservableProperty("compthismap",!1),d.isMapVisible()&&d.gcsm.freeze("render"),$(d).triggerHandler(u.CHANGE_MAPVIEW,[c,r,n,p.mapNumActive])}}),i.on("change",function(t,e){if(!d._waitingForFirstMapRendered&&""!==(c=h=$(this).val())){var i=GCO5.core.GcArrayUtil.getSubArray(p.indic_a,{pk:[h]})[0],i=GCO5.core.GcObjectUtil.cloneJson(i);if(i)if("N"==p.typeTree&&((r=p.selectedTheme.substr(1).split("@")).pop(),p.selectedF1Code=r.join("@")),i.filter1&&!GCO5.core.GcStringUtil.isEmpty(p.selectedF1Code)&&(i.f1code=p.selectedF1Code,c+="|"+i.f1code),"atih_pmsi"==GCO5.appModel.getOption("app")&&(!GCO5.core.GcStringUtil.isEmpty(p.selectedF0Code)&&GCO5.appModel.getInfo("datasetFilter0",[i.c_id_dataset])&&(i.f0code=p.selectedF0Code,i.f0lib=p.selectedF0Lib),!GCO5.core.GcStringUtil.isEmpty(p.selectedF0Serie)&&e&&e.fromFilter0&&(i.serie=p.selectedF0Serie,p.selectedF0Serie=null)),(r=d.getActiveMap().getIndicsModelsIndexed()[c])&&p.selectedF0Code==r.getProp("f0Code"))r.isEnabled()||d.getActiveMap().enableTheme(r),d._syncUIAfterPickIndic(r.getIndicModel(),i);else if(0==i.c_id_dataset.indexOf("_import")){var n,r,a=GCO5.model.indics.Dataset.getDataset(i.c_id_dataset),s={};(r=a.getIndics()[c])&&r.getOption("disabledAtFirst")?(r.setOption("disabledAtFirst",!1),r.disable(),i.disabled=!0,d.gcsm.unFreeze("render"),(d._waitingForFirstMapRendered||0<d._URLIndicsToLoad.length)&&GCO5.core.GcDelayUtil.callLater(d._loadNextIndicData,[],1,d)):(n=d["map"+d._getMapSuffix()],s=a.tryDisplayIndicOnMap(h,n)),"loadNewMap"==s.action&&d._activeImportedIndicOnNewMap(r,s.mapName),d._syncUIAfterPickIndic(r.getIndicModel(),i)}else{if(p.indicModel0||(d._waitingForUpdateMapTitle=!0),"atih_pmsi"==GCO5.appModel.getOption("app")){e&&e.fromFilter0&&r?((l=r.getIndicModel()).setF0Code(p.selectedF0Code),l.setF0Lib(p.selectedF0Lib)):l=new GCO5.model.indics.IndicModel(i);var o=GCO5.appModel.getInfo("datasetFilter0",[l.getProp("IdDataset")]);if(o&&(GCO5.core.GcStringUtil.isEmpty(p.selectedF0Code)||p.selectedFilter0!=o))return p.selectedFilter0&&(p.selectedF0Code=""),p.reg_a&&0==p.reg_a.length&&GCO5.appModel.loadRefData(function(){GCO5.appModel.loadRefData(function(){p.noTrigger=!0,d.setObservableArray("reg_a",GCO5.appModel.getRefData("reg","extent1","*",{fullArray:!0})),d.setObservableArray("dep_a",p.dep0_a=GCO5.appModel.getRefData("dep","extent1","*",{fullArray:!0})),p.noTrigger=!1},d,"reg","extent1")},d,"dep","extent1"),void GCO5.appModel.loadRefData(function(t){var e=p.f0_a=GCO5.appModel.getRefData(o,null,"*",{fullArray:!0}),i=GCO5.core.GcStringUtil.repeat("0",e[0].codgeo.length),e=(d.setObservableProperty("selectedFilter0",o),e.unshift({codgeo:i,libgeo:GCO5.appModel.getInfo("libNivgeo",[o,!1,!0]),regroup:"1"}),GCO5.appModel.getConcept("dataset_o")[l.getProp("IdDataset")].series);e&&(i=(e=e.concat().reverse()).map(function(t){return{id:t,lib:"Etablissements actifs en "+t}}),GCO5.core.GcDelayUtil.callLater(d.setObservableArray,["year_a",i,"selectedYear",e[0]],10,d))},d,o,null,d.map.getIdView())}var l=l||p.indicModel0||new GCO5.model.indics.IndicModel(i),a=d._getActiveSerieFromDataset(l.getProp("IdDataset"));a&&l.setSerie(a),d.isMapVisible()&&d.gcsm.freeze("render"),l.setOption("tree",p.selectedTree),l.getOption("disabledAtFirst")?(l.setOption("disabledAtFirst",!1),i.disabled=!0,d.gcsm.unFreeze("render"),GCO5.core.GcDelayUtil.callLater(d._buildMetaIndic,[l],10,d),(d._waitingForFirstMapRendered||0<d._URLIndicsToLoad.length)&&GCO5.core.GcDelayUtil.callLater(d._loadNextIndicData,[],1,d)):$(d).triggerHandler(u.CHANGE_INDIC,[!0,l]),d._syncUIAfterPickIndic(l,i)}}}),"atih_pmsi"==GCO5.appModel.getOption("app")&&($.observe(p,"d0IndicSerie",function(t,e){for(var i,n,r,a=p.f0_a,s=(a.length,a.length),o=0;o<s;o++)if(a[o].codgeo==p.selectedF0Code){i=a[o];break}i&&i.note_series&&(r=i.note_series.split("|"),0<=(e=GCO5.core.GcArrayUtil.indexOfByKey(p.year_a,"id",e.value))&&(n=r[p.year_a.length-1-e])),d.setObservableProperty("note_series",n)}),$.observe(p,"selectedF0Code",function(t,e){e=e.value,e="1"==p.selectedFilter0List?e?$(".f0CodeList option:selected",d._$renderedContent).text():null:p.selectedF0Codes.length+" "+(0<p.selectedFilter0.indexOf("ght")?"GHT":"établissements");d.setObservableProperty("selectedF0Lib",e),d._removeOldFilter0Indics(),d.setObservableProperty("displayGHTEtabs",!1),p.selectedF0Code?GCO5.core.GcDelayUtil.callLater(function(){d.gcsm.unFreeze("regsel"),i.trigger("change",{fromFilter0:!0})},[],20,d):d.gcsm.unFreeze("regsel")}),o=function(){var n={},r=(GCO5.core.GcStringUtil.isEmpty(p.selectedDep)||(n.dep=p.selectedDep),GCO5.core.GcStringUtil.isEmpty(p.selectedReg)||(n.reg=p.selectedReg),GCO5.core.GcStringUtil.isEmpty(p.searchStrF0Lib)?null:p.searchStrF0Lib.toUpperCase());return p.f0_a.filter(function(t){var e=t.codgeo.substr(0,3),i="001"===e,e="002"===e;return t.regroup||!i&&!e||(t.regroup="2"),!(!n.reg&&!n.dep&&(i||e))&&(!(!n.dep&&e)&&((!n.dep||t.dep==n.dep)&&((!n.reg||t.reg==n.reg)&&(!(t.series&&t.series.indexOf(p.selectedYear)<0)&&!(r&&t.libgeo.indexOf(r)<0)))))})},$.observe(p,"selectedReg",function(t,e){p.noTrigger||(c=e.value,d.setObservableArray("dep_a",GCO5.core.GcStringUtil.isEmpty(c)?p.dep0_a:GCO5.core.GcArrayUtil.getSubArray(p.dep0_a,{reg:c})),d.setObservableProperty("selectedDep","",{noTrigger:!0}),d.gcsm.freeze("regsel"),GCO5.core.GcDelayUtil.callLater(function(){var t=o();d.setObservableArray("filter0_a",t,"selectedF0Code",0<t.length?t[0].codgeo:"")},[],2,d))}),$.observe(p,"selectedDep",function(t,e){var i;p.noTrigger||(i=o(),GCO5.core.GcDelayUtil.callLater(d.setObservableArray,["filter0_a",i,"selectedF0Code",0<i.length?i[0].codgeo:""],2,d))}),$.observe(p,"selectedFilter0",function(t,e){p.noTrigger||(c=e.value,GCO5.core.GcStringUtil.isEmpty(p.searchStrF0Lib)&&GCO5.core.GcStringUtil.isEmpty(p.selectedDep)&&GCO5.core.GcStringUtil.isEmpty(p.selectedReg)||p.filter0LibReset(!0),d.setObservableProperty("selectedFilter0List","1"),d.setObservableProperty("displayGHTEtabs",!1))}),$.observe(p,"selectedFilter0List",function(t,e){var i;p.noTrigger||(c=e.value,e=$("[data-link='selectedF0Codes']",d._$renderedContent),"2"==c?(i=p.filter0_a.filter(function(t){return!t.regroup}).map(function(t){return"<option value='"+t.codgeo+"'>"+t.libgeo+"</option>"}),e.append(i)):(0<p.selectedF0Code.indexOf("|")&&d.setObservableProperty("selectedF0Code",p.selectedF0Code.split("|")[0]),e.empty()))}),$.observe(p,"selectedYear",function(t,e){if(!p.noTrigger&&e.value){c=e.value;var i=o(),n=p.selectedF0Code;if(n){for(var r,a=i.length,s=0;s<a;s++)if(i[s].codgeo==n){r=s;break}void 0===r&&(n=null)}n=(n=!n&&0<i.length?i[0].codgeo:n)||"",GCO5.core.GcDelayUtil.callLater(d.setObservableArray,["filter0_a",i,"selectedF0Code",n],1,d)}}),$.observe(p,"displayGHTEtabs",function(t,e){p.noTrigger||(c=e.value,e=p.selectedFilter0.replace("ght","")+"_P",c?(GCO5.appModel.loadLayers(p._onGHTLayerLoaded,this,[{name:e}],!1,d.map.getName(),"addLayer"),p.lastGHTLayerName=e):(d.map.removeLayer(p.lastGHTLayerName),p.lastGHTLayerName=null))}),$("[data-link='searchStrF0Lib']",this._$container).on("keydown",function(t){var e=t.keyCode||t.which;"keydown"==t.type&&"13"!=e||p.searchFilter0Lib()})),$(".indic-basket",this._$renderedContent).on("click keydown",".removeItem",function(t){var e,i=t.keyCode||t.which;if("keydown"!=t.type||"13"==i)return c=$(this).closest("li").data("pk"),$.view(this).index,t=d._getMapSuffix(!0),i=d["map"+d._getMapSuffix()],e=p["selectedIndics_a"+t],t=p["selectedIndicModels_o"+t],d._updateSelectedIndicsList("remove",t[c]),0==e.length&&"f"==p.selectedRestit&&GCO5.core.GcDelayUtil.callLater(function(){$("#tm_map",d._$renderedContent).trigger("click")},[],10,d),0==e.length&&d._closeTreeIndics(),t=i.getIndicsModelsIndexed(),d._removeTheme(t[c]),d.setObservableProperty("selectedIndic",""),d._syncIndicList(!0),!1}),$(".tabmenucontent",this._$renderedContent).on("click keydown","a",function(t){"keydown"==t.type&&13!=t.keyCode||(t=$(this).data("pk"),d._setCompositeMode(t))}),$(".c2-on-geo",this._$renderedContent).on("click keydown",".tabs__link",function(t,e){"keydown"==t.type&&13!=t.keyCode||e||(e=$(t.target).data("pk"),$(".c2-on-basket",d._$renderedContent).find("[data-pk='"+e+"']").trigger("click","fromTabsGeo"),d.setObservableProperty("mapNumActive",+$(t.target).data("pk").substr(3)))}),$(".c2-on-basket",this._$renderedContent).on("click keydown",".tabs__link",function(t,e){"keydown"==t.type&&13!=t.keyCode||e||(e=$(t.target).data("pk"),$(".c2-on-geo",d._$renderedContent).find("[data-pk='"+e+"']").trigger("click","fromTabsBasket"),d.setObservableProperty("mapNumActive",+$(t.target).data("pk").substr(3)))}),$("#tm_map",this._$renderedContent).closest("ul").on("click keydown",".tabs__link",function(t,e){var i;"keydown"==t.type&&13!=t.keyCode||("m"!=(i=t.target.id.substr(3,1))||e&&e.noResize||GCO5.core.GcDelayUtil.callLater(d.onResize,[],1,d),$(t.target).closest(".js-tablist").find("a").removeClass("highlighted"),$(t.target).addClass("highlighted"),d.setObservableProperty("selectedRestit",i))}),$.observe(p,"selectedRestit",function(t,e){var i,n=e.oldValue,e=e.value;if(1==e.length){$("body").removeClass("restitCompositeMode restitCompositeMode2 restit-c2 pilotage-off"),$("#sep_12",d._$renderedContent).hide();for(var r=1;r<=4;r++)$("#tm_nav_"+r,d._$renderedContent).removeAttr("style")}if(1<n.length&&GCO5.core.GcDelayUtil.callLater(d.onResize,[],1,d),"m"==e&&d.ficindicView&&(a=p.selectedIndics_a.concat(),d.setObservableArray("selectedIndics_a",[]),d.setObservableArray("selectedIndics_a",a),i=d.map.getIndicsModelsIndexed(),a.forEach(function(t){t=i[t.pk];t&&GCO5.core.GcDelayUtil.callLater(d._buildMetaIndic,[t],10,d)})),e.indexOf("t")<0&&0<=n.indexOf("t")&&d.tableView.onRemovedFromStage(),"t"==e){if($("#tm_nav_2",d._$renderedContent).is(":visible"))return;GCO5.core.GcDelayUtil.callLater(d._displayTableView,[],2,d)}if("f"==e){if($("#tm_nav_3",d._$renderedContent).is(":visible"))return;GCO5.core.GcDelayUtil.callLater(d._initFicindicView,[],2,d)}"m2"==e?d._loadAllIndicModels(d._cloneIndicsAndBuildMap2,d)||d._cloneIndicsAndBuildMap2():"m2"==n&&($("#tm_nav_4",d._$renderedContent).addClass("no-display"),2==p.mapNumActive&&($(".c2-on-geo",d._$renderedContent).find("[data-pk='map1']").trigger("click"),d.setObservableProperty("mapNumActive",1)),d.map.linkToMap(null),d._updateMapIndicsLib());var a=$(".indic-basket .indVisi",d._$renderedContent);"t"==e?a.attr("disabled","disabled"):a.removeAttr("disabled")}),$.observe(p,"selectedFicIndic",function(t,i){d.ficindicView&&(p.selectedIndics_a.forEach(function(t,e){$.observable(t).setProperty("indvisi",null),$.observable(t).setProperty("indvisi",t.pk==i.value)}),$("#tmindic-tabdet",d._$renderedContent).prop("checked","*"==i.value),$("#tmindic-spine",d._$renderedContent).prop("checked","SPINE"==i.value),d.ficindicView.setIndic(i.value))}),this.addMixinListeners(),$.observe(p,"essentiels","compthismap","selectedTypind",$.proxy(this._onTreeFiltering,this)),$("[data-link='searchStr']",this._$container).on("keydown",function(t){var e=t.keyCode||t.which;"keydown"==t.type&&"13"!=e||d._onTreeFiltering(t,{path:"searchStr",value:$(this).val()})}),$.observable(p.selectedIndics_a_c2).observeAll($.proxy(this._updateMapIndicsLib,this))},_removeOldFilter0Indics:function(e){var i=this,n=this._viewData,t=i._getMapSuffix(!0),r=i["map"+i._getMapSuffix()],a=n["selectedIndics_a"+t],s=n["selectedIndicModels_o"+t],o=[],l=r.getIndicsModelsIndexed();a.forEach(function(t){if(t.filter0&&(e||t.disabled||t.filter0!=n.selectedFilter0))return i._removeTheme(l[t.pk],{noRender:!0}),void delete s[t.pk];o.push(t)}),GCO5.core.GcStringUtil.isEmpty(n.selectedF1Code)||(r=$(".indics_filter1 .ui-collapsible-content li[data-pk!='"+n.selectedF1Code+"']",this._$renderedContent),$("a",r).removeClass("selected")),a.length!=o.length&&i.setObservableArray("selectedIndics_a"+t,o)},_cloneIndicsAndBuildMap2:function(){var i=this._viewData,n=this,r=($("#tm_nav_4",n._$renderedContent).removeClass("no-display"),$("body").addClass("restit-c2"),$("body").addClass("restitCompositeMode2"),$(".c2-on-geo",n._$renderedContent).find("[data-pk='map2']").trigger("click"),this.onResize(),i.selectedIndicModels_o_c2={},n.map.getIndicsModelsIndexed()),a=[];i.selectedIndics_a.forEach(function(t){var e;r[t.pk]&&(e=new GCO5.model.indics.MapIndicModel(r[t.pk].getIndicModel().clone()),i.selectedIndicModels_o_c2[e.getPkF1()]=e,n._buildMetaIndic(e),t.disabled&&e&&e.disable(),(e=GCO5.core.GcObjectUtil.cloneJson(t)).indvisi=i.indvisi,a.push(e))}),n.setObservableArray("selectedIndics_a_c2",a),n.map2&&n.map2.removeAllThemes({noRender:!0}),i.mapIndicModels=i.selectedIndicModels_o_c2,n.setObservableProperty("selectedView2",i.selectedView,{forceTrigger:!0}),i.mapIndicModels=null},_setCompositeMode:function(e,t){var i=this,n=this._viewData;e!=n.selectedRestit&&("m1"!=e&&$(".js-tablist__link_plus",i._$renderedContent).addClass("highlighted"),$("body").removeClass("restitCompositeMode restitCompositeMode2 restit-c2 pilotage-off"),"m2"!=e&&$("body").addClass("restitCompositeMode"+(!t&&2==e.length&&1024<GCO5.browser.width?"2":"")),["t","m","f"].forEach(function(t){i._activateRestitTab(t,0<=e.indexOf(t))}),GCO5.core.GcDelayUtil.callLater(i.onResize,[],1,i),0<=e.indexOf("t")&&GCO5.core.GcDelayUtil.callLater(i._displayTableView,[],2,i),0<=e.indexOf("f")&&(n=i.displayThisMapindicOnly(),GCO5.core.GcDelayUtil.callLater(i._initFicindicView,[],n?50:5,i)),"m2"==e&&i._updateMapIndicsLib(null,null,null,!0),$("#tm_map",i._$renderedContent).focus(),i.setObservableProperty("selectedRestit",e))},_onRemovedFromStage:function(){},_showMap:function(t){var e=$("#tm_map",this._$renderedContent);"false"!=e.attr("aria-selected")&&!t||e.trigger("click",{noResize:!0})},onLoadIndicData:function(t,e){var i=this;this["map"+this._getMapSuffix()];this.tableView&&this.tableView.isComposited()&&this._displayTableView(),this.ficindicView&&this.ficindicView.isComposited()&&this._initFicindicView(),t.resetParams("calcs");var n,r={replace:this.mobileReducedMode,render:!0};this._waitingForUpdateMapTitle=!1,this._updateMapIndicAxisValues(t),this.map.getContainer().is(":visible")&&(this._updateMapIndicsLib(),this._updateMapIndicAxisValues(t)),this._addTheme(t,r),this._buildMetaIndic(t),t.getProp("filter1")||this._syncIndicList(),1<=this._viewData.nbIndicsToLoadInit0&&0==this._URLIndicsToLoad.length&&(0<(r=GCO5.appModel.getInfo("TreesFromThemes",[t.getProp("idThemes")])).length&&r.indexOf(this._viewData.selectedTree)<0&&i.setObservableProperty("selectedTree",r[0],{forceTrigger:!0}),this.hasTwoMaps()||GCO5.core.GcDelayUtil.callLater(this.openTreeIndicsOnTheme,[t.getProp("idThemes")],20,this),this._pendingSelgeoPt&&"PT"==this._pendingSelgeoPt.getTopology()&&(n=this._pendingSelgeoPt.nivgeo+"_P",GCO5.core.GcDelayUtil.callLater(function(){i.map.drawSelIds(n,i._pendingSelgeoPt.getSelIds()),i._pendingSelgeoPt=null},[],10,i))),t.getProp("f1Code")&&this._scrollToIndicF1code(t,80)},_addTheme:function(t,e){e=e||{render:!0};var i=this["map"+this._getMapSuffix()];i.getContainer().is(":visible")?i.addTheme(t,e):i.addTheme(t,{render:!1,enabled:!1}),this.tableView&&this.tableView.addIndicModel(t,i.getIndicsModelsIndexed(!0),i.getContainer().is(":visible")),this.ficindicView&&this._ficindicViewActive()&&this._initFicindicView(t)},_removeTheme:function(t,e){var i=this["map"+this._getMapSuffix()];i.removeTheme(t,e),this.tableView&&this.tableView.removeIndicModel(t,i.getIndicsModelsIndexed(!0),e)},_initTableView:function(t){this.tableView||(this.tableView=new GCO5.view.component.TableView({map:this.map,ca:this,noRender:t.noRender}))},_getNotYetLoadedIndicModels:function(){var i=this.map.getIndicsModelsIndexed(),n=[],r=this.map.getIdView();return this._viewData.selectedIndics_a.forEach(function(t){var e;!i[t.pk]&&0<=t.c_id_views.indexOf(r)&&(0==t.c_id_dataset.indexOf("_import")?(e=GCO5.model.indics.Dataset.getDataset(t.c_id_dataset),n.push(e.getMapIndicModel(t.pk).getIndicModel())):n.push(new GCO5.model.indics.IndicModel(t)))}),n},isMapVisible:function(){return 0<=this._viewData.selectedRestit.indexOf("m")},_displayTableView:function(){var t=this.tableView,e=this,i=this._getNotYetLoadedIndicModels();if(!t)return e.gcsm.freeze("tables_m"),void require(["tables_m"],function(t){e.gcsm.unFreeze("tables_m"),t.initialize(),e._initTableView({noRender:0<i.length}),0<i.length&&e._displayTableView()});function n(){t.syncWithMap(e.map.getIndicsModelsIndexed(!0))}this._loadAllIndicModels(n,this)||GCO5.core.GcDelayUtil.callLater(n,[],1,t)},_loadAllIndicModels:function(r,a){var s=this,i=s.map.getIndicsModelsIndexed(!0),n=[],o=this.map.getIdView();this._viewData.selectedIndics_a.forEach(function(t){var e;!i[t.pk]&&0<=t.c_id_views.indexOf(o)&&(0==t.c_id_dataset.indexOf("_import")?(e=GCO5.model.indics.Dataset.getDataset(t.c_id_dataset),n.push(e.getMapIndicModel(t.pk)),e.getMapIndicModel(t.pk).getIndicModel().setNivgeo(s.map.nivgeo)):n.push(new GCO5.model.indics.IndicModel(t)))});return 0<n.length&&(GCO5.appModel.loadMapViewModel(function(t){for(var e in t.mapIndicModels){var i,n,e=t.mapIndicModels[e].isMapIndicModel?t.mapIndicModels[e]:new GCO5.model.indics.MapIndicModel(t.mapIndicModels[e]);e.getLayerName()&&!s.map.hasLayer(e.getLayerName())&&(i={},n=GCO5.core.GcArrayUtil.getSubArray(t.layers,{name:e.getLayerName()}),i[e.getLayerName()]=n[0].ba,GCO5.appModel.getPointLayerDef(e,i,s.map.getName())),s.map.addTheme(e,{render:!1,enabled:!1})}r&&r.apply(a)},s,s.map.getName(),s.map.getIdExtent(),n),!0)},_initFicindicView:function(e){this.ficindicView?this.ficindicView.onResize():this.ficindicView=new GCO5.view.component.FicindicView({container:$("#tm_nav_3",this._$renderedContent),map:this.map,ca:this,hasSpine:this._viewData.hasSpine});function t(){var i,t=r.ficindicView.getFicIndicList(),n=(r.setObservableArray("ficindics_a",t),r.setObservableProperty("hasSelgeo",r.map.hasSelgeo()),r.setObservableProperty("hasMultSelgeo",r.map.hasMultSelgeo()),-1);t.forEach(function(t,e){t.enabled&&-1==n&&(i=t.data,n=e)}),$("#tmindic-tabdet",r._$renderedContent).prop("checked",!1),a.selectedIndics_a.forEach(function(t,e){$.observable(t).setProperty("indvisi",null),$.observable(t).setProperty("indvisi",t.pk==i)}),e||!(0<t.length)||a.hasSpine&&s||r.setObservableProperty("selectedFicIndic",t[Math.max(n,0)].data,{forceTrigger:!0})}var r=this,a=this._viewData,s=r.map.hasSelgeo();this._loadAllIndicModels(t,this)||t.apply(this),this.ficindicView.show({selOnly:s}),e?GCO5.core.GcDelayUtil.callLater(function(){r.setObservableProperty("selectedFicIndic",e.getPkF1())},[],10,this):a.hasSpine&&s&&GCO5.core.GcDelayUtil.callLater(function(){r.setObservableProperty("selectedFicIndic","SPINE",{forceTrigger:!0})},[],10,this)},_onBuildInfosel:function(e,t){var i=t.getSelgeo(),n=this,t=this._viewData.selectedRestit;if(this.setObservableProperty("hasSelgeo",!!i),i&&GCO5.core.GcDelayUtil.callLater(function(){var t=n.gcsm.getActivePanel();t&&t.onBuildInfosel(e)},[],10),0<=t.indexOf("f")&&this.ficindicView&&this.ficindicView.onBuildInfosel(e),0<=t.indexOf("t")&&this.tableView&&GCO5.core.GcDelayUtil.callLater(function(){n.tableView.onBuildInfosel(e,i)},[],2),e){var r,a=this.map.getEnabledIndicsModelsIndexed(),s={},o={};for(r in a)s[r]=a[r].getProp("selMention",!0),o[r]=a[r].getProp("refMention",!0,!0);t=this.map.getSelIds(),t=t?t.length:0;this.cli.isInIframe()&&n.cli.postRobotSend("endInfoSel",{detail:{data:e.data,indic:e.indicateurs,terr:e.territories,selmention:s,refmention:o,libsel:this.map.getLibSel(),nbObjSel:t},msg:"endInfoSel"})}this._updateHashAfterRenderMap()},_getMimFromPk0:function(t){if(this.getActiveMap()){var e,i=this.getActiveMap().getIndicsModelsIndexed();for(e in i)if(i[e].getPk()==t)return i[e]}return null},onLoadIndicsFromTheme:function(t){function e(){0<r.length&&t.indics.forEach(function(t){var e;t.filter1&&(e=n._getMimFromPk0(t.c_id_dataset+"."+t.c_id_indicateur),i=e?GCO5.core.GcObjectUtil.cloneJson(e.getProp("filter1Array")):null,t.f1_a=n._viewData._filterKeyMode?n._getFilter1List(t.filter1,t.pk):GCO5.core.GcObjectUtil.cloneJson(i||GCO5.appModel.getInfo("filter1Data",[t.filter1])),t.f1_a&&t.f1_a.forEach(function(t){t.selected=!1}))}),n.mobileReducedMode&&(t.indics=t.indics.filter(function(t){return null==t.c_indic_assoc})),n.setObservableArray("indic_a",t.indics),this._viewData.indicModel0&&n._displayNextIndic(),n._syncIndicList(),this._viewData.treeIndicsClicked&&n._showListIndics()}var i,n=this,r=[];if(t.indics.forEach(function(t){t.filter1&&r.indexOf(t.filter1+"."+t.c_id_dataset)<0&&r.push(t.filter1+"."+t.c_id_dataset)}),0<r.length){var a,s=[];for(a in r){var o=r[a].split(".");s.indexOf(o[0])<0&&s.push(o[0])}GCO5.appModel.loadFilterData(e,this,s.join("|"))}else e.apply(this)},_backToTreeIndics:function(){this.setObservableProperty("essentiels2",0),$(".tree_choice",this._$renderedContent).show(),"__KEYWORD__"!=this._viewData.selectedTree&&$(".filtGroup",this._$renderedContent).show(),$(".treeindics",this._$renderedContent).show(),$(".indics_filter1",this._$renderedContent).hide(),$(".indics_msg",this._$renderedContent).hide()},_showListIndics:function(){var t;$(".tree_choice",this._$renderedContent).hide(),this._viewData._filterKeyMode||$(".filtGroup",this._$renderedContent).hide(),$(".treeindics",this._$renderedContent).hide(),$(".indics_filter1",this._$renderedContent).show(),$(".indics_filter1 .indic-container",this._$renderedContent).scrollTop(0),1==this._viewData.indic_a.length&&("N"==this._getTreeType(this._viewData.selectedTree)?t=$(".indics_filter1",this._$renderedContent).find("h3.no-filter1 a"):GCO5.core.GcStringUtil.isEmpty(this._viewData.indic_a[0].filter1)||(t=$(".indics_filter1",this._$renderedContent).find("h3.filter1 a")),t&&t.closest("div").hasClass("ui-collapsible ui-collapsible-collapsed")&&t.trigger("click")),this._viewData.treeIndicsClicked=!1},_onTreeFiltering:function(t,e){var i,n,r;this._updatingTreeFilters||(this._getTreeFilters(),i=e.path,n=this._viewData,this.constructor,e=e.value,n.selectedTheme=null,this.setObservableProperty("selectedIndic",""),"tag"==i&&this._viewData.filtReset(),r="tag"==i?{}:{tree:n.selectedTree},GCO5.core.GcStringUtil.isEmpty(n.searchStr)||(r.key="searchStr"==i?e:n.searchStr),""!=n.selectedTypind&&(r.typind=n.selectedTypind),n.compthismap&&(r.view=this.getActiveMap().getName()),n.essentiels&&(r.essential=1),"tag"==i&&(r.tag=e),"tag"==i||1<GCO5.core.GcObjectUtil.count(r)?GCO5.appModel.getListIndics(this.onTreeFiltered,this,r):this._resetTreeFilters(!0))},onTreeFiltered:function(t,e){var t=t.indics&&0<t.indics.length?GCO5.appModel.getInfo("filteredDomTree",[t.indics,e]):t,i=t.dom_a,n=this;if(!i)return $(".treeindics",this._$renderedContent).hide(),void $(".indics_msg",this._$renderedContent).show();$(".indics_msg",this._$renderedContent).hide(),this._viewData._filterKeyMode=!0,this._filteredDomTree=t,this.setObservableProperty("nbDoms",t.dom_a.length),this.setObservableArray("tree_a",t.dom_a),this.setObservableProperty("selectedDom",i[0].c_id_theme);i=$(".treeindics",this._$renderedContent);1!=t.dom_a.length||t.dom_a[0].children&&1!=t.dom_a[0].children.length?this._backToTreeIndics():((0<i.find("li").length?i.find("li"):i.find("button")).eq(0).trigger("click"),e&&e.key&&GCO5.core.GcDelayUtil.callLater(function(){var t=$(".indic-container h3",n._$renderedContent).eq(0);t.hasClass("filter1")&&t.find("a").trigger("click")},[],10))},_getFilter1List:function(t,e){t=GCO5.core.GcObjectUtil.cloneJson(GCO5.appModel.getInfo("filter1Data",[t])||[]);if(this._viewData._filterKeyMode){e=GCO5.core.GcArrayUtil.getSubArray(this._filteredDomTree.i_a,{pk:e});if(0==e.length)return[];e=e[0];if(e.filteredMods)return e.filteredMods}return t},_getTreeFilters:function(){var e,i={},n=this._viewData;return["searchStr","compthismap","essentiels","selectedTypind"].forEach(function(t){(e=n[t])&&""!=e&&(i[t]=e)}),i},_resetTreeFilters:function(t){this._viewData._filterKeyMode=!1,this._updatingTreeFilters=!0,this._viewData.selectedTheme="",this.setObservableProperties({searchStr:"",essentiels:!1,compthismap:!1,selectedTypind:""}),this._updatingTreeFilters=!1,this._updateDomainTree(t),this._backToTreeIndics()},_loadNextIndicData:function(t){if(t=t||this._URLIndicsToLoad.shift()){var e=t.getPkF1(),i=this.getSelectedIndics(),n=GCO5.core.GcArrayUtil.indexOfByKey(i,"pk",e);if(0<=n)return i[n].disabled&&(this._syncSelectedIndicCheckbox(e,!0),this._setIndicVisibility(e,!0)),void(0<this._URLIndicsToLoad.length&&GCO5.core.GcDelayUtil.callLater(this._loadNextIndicData,[],5,this));this._viewData.indicModel0=t,GCO5.appModel.loadFullIndicInfo(this._onLoadIndic0MetaData,this,t)}},_onLoadIndic0MetaData:function(t,e){function i(){n.setObservableArray("indic_a",e.indics),n._displayNextIndic()}var n=this;t.getProp("filter1")?GCO5.appModel.loadFilterData(i,this,t.getProp("filter1")):i.apply(this)},_displayNextIndic:function(){var t,e;0!=this._viewData.indic_a.length&&this._viewData.indicModel0&&(t=this._viewData.indic_a[0],this.setObservableProperty("selectedIndic",this._viewData.indicModel0?this._viewData.indicModel0.getPk():t.pk),(e=this._viewData.indicModel0?this._viewData.indicModel0.getProp("f1Code"):t.f1code)&&this.setObservableProperty("selectedF1Code",e),(e=this._viewData.indicModel0?this._viewData.indicModel0.getProp("f0Code"):t.f0code)&&(this._viewData.selectedF0Code=e,this._viewData.indicModel0&&(this._viewData.selectedF0Serie=this._viewData.indicModel0.getProp("serie"))),$("#cth_indic_cb",this._$renderedContent).trigger("change"),0==this._URLIndicsToLoad.length&&(this._viewData.indicModel0=this._viewData.theme0=null))},_addMapListeners:function(i){var i=i||this.map,r=this;this.addMixinMapListeners(i),$("header",i.getContainer().closest(".thematicmap-layout")).on("dragover",function(t){if(!r._draggingElement)return!1;0==$(this).has(r._draggingElement).length&&$(this).addClass("drag-over"),t.preventDefault()}).on("dragleave",function(t){$(this).removeClass("drag-over"),t.preventDefault()}).on("drop",function(t){if(t.preventDefault(),!r._draggingElement||1==$(this).has(r._draggingElement).length)return!1;var e=t.originalEvent.dataTransfer.getData("Text").split("."),i=0,n=(t.originalEvent.shiftKey||t.originalEvent.ctrlKey||(t=$(".thematicmap-layout header").eq(0).get(0)===this?"map2":"map1",$(".c2-on-basket",r._$renderedContent).find("[data-pk='"+t+"']").trigger("click"),t=e[0]+"."+e[1],GCO5.core.GcStringUtil.isEmpty(e[3])||(t+="|"+e[3]),n=GCO5.core.GcArrayUtil.getSubArray(r.getSelectedIndics(),{pk:t})[0],$.observable(n).setProperty("indvisi",!1),r._setIndicVisibility(t,!1),i=10),$(".thematicmap-layout header").eq(0).get(0)===this?"map1":"map2");$(".c2-on-basket",r._$renderedContent).find("[data-pk='"+n+"']").trigger("click"),GCO5.core.GcDelayUtil.callLater(r.addIndicToActiveMap,[e[0],e[1],e[2],e[3]],i,r),$(this).removeClass("drag-over"),r._draggingElement=null}),$(i).on(GCO5.view.component.MapViewThematic.DISPLAY_SEL_SETTINGS,function(t){var e;i.getSelgeo()&&(e=new GCO5.view.component.MapSelinfoPanel,GCO5.core.GcComponentUtil.displaySlidingPanel(t.target),GCO5.core.GcDelayUtil.callLater(function(){e.setup({action:"NEW",categ:"panel",container:$(".cd-panel-content"),map:t.target})},[],10,r))}),$("body").on("keyup",function(t){i&&i.onKeyUp.apply(i,[t])}),$("body").on("keydown",function(t){i&&i.onKeyDown.apply(i,[t])}),$(i).on(GCO5.view.component.MapView.MOUSEMOVE,function(t,e,i){var n;r.hasTwoMaps()&&(n=(t=t.target)==r.map?r.map2:r.map,t.getStatLayerName()==n.getStatLayerName()&&(e?n.displayTooltipOnFid(e[t.getStatLayerName()].fid,null,t):n.clearLayerRovInfo(i,!0,!0)))})},_onEndRenderMap:function(){if(this._waitingForFirstMapRendered||0<this._URLIndicsToLoad.length){var t=this._viewData.extent0;this._viewData.extent0=null,0<this._URLIndicsToLoad.length&&(!t||t.contains(this.map._getMapExtentA5(),!0))?(t=this.map.hasSelgeo()?30:1,GCO5.core.GcDelayUtil.callLater(this._loadNextIndicData,[],t,this),this._waitingForFirstMapRendered=!1):this._waitingForFirstMapRendered&&(this._waitingForFirstMapRendered=!1,this._displayNextIndic())}else{if(this.setObservableProperty("nbIndicsToLoadInit",0),this._updateHashAfterRenderMap(),this.cli.isInIframe()){var e,i=this.map.getEnabledIndicsModelsIndexed(),n={},r=[];for(e in i)n[e]=i[e].getProp("controlMetaData"),r.push({id_indic:e,meta_indic:n[e]});this.cli.postRobotSend("endRenderMap",{indicators:r,msg:"endRenderMap"})}this._viewData.displaySynth&&(1400<GCO5.browser.width&&GCO5.core.GcDelayUtil.callLater(this._setCompositeMode,["mf","2"==this._viewData.displaySynth],20,this),this._viewData.displaySynth=null)}this._mapRendering=!1},_updateHashAfterRenderMap:function(){if(!this.gcsm.historyBrowsing&&!this.gcsm.getPrintMode()){var t=$.bbq.getState(),e=this.map.getEnabledIndicsModelsIndexed(),i={},n=0;for(r in t)["z","i","i2","f","f2","e","e2","s","s2","t","t2","bbox","selcodgeo"].indexOf(r)<0&&(i[r]=t[r]);t.synth&&!this._viewData.displaySynth&&delete i.synth;var r,a=1<GCO5.appModel.getConcept("tree").length;for(r in e){var s,o=(h=e[r]).getProp("f0Code"),l=h.getProp("f1Code"),c=h.getProp("serie"),h=h.getOption("tree"),d=(this._getTreeType(h),r);Array.isArray(o)&&(o=o.join(",")),l&&((s=r.split("|")).pop(),d=s.join("|")),0==n?(i.i=d,c&&(i.s=c.replace(/\//g,"_slash_")),l&&(i.f=l),o&&(i.e=o),a&&h&&(i.t=h)):(i.i2=d,c&&(i.s2=c.replace(/\//g,"_slash_")),l&&(i.f2=l),o&&(i.e2=o),a&&h&&(i.t2=h)),n++}this.map.isReprojected()||1==this.map.getScaleRatio()&&this.map.getMapExtent().contains(this.map._getMapExtentA5(),!0)||(i.bbox=this.map.getMapExtent().toString(","));var u=this.map.getSelgeo(this.map.getStatLayerName());u&&u.getSingleCodgeo()?i.selcodgeo=u.getSingleCodgeo():delete i.selcodgeo,GCO5.core.GcObjectUtil.equal(i,t)||$.bbq.pushState(i,2)}},onHashChange:function(t){var e,i,n,r,a=GCO5.appModel.getConcept("view_o")[t.view];if(a&&(e=a.id_view,i=a.id_nivgeo,n=a.id_extent),this.cli.isInIframe()){if(!GCO5.core.GcStringUtil.isEmpty(t.i)&&!GCO5.core.GcStringUtil.isEmpty(this._viewData.indic1)&&(t.i!=this._viewData.indic1.split("|")[0]||t.f&&t.i+"|"+t.f!=this._viewData.indic1))return a={c_id_dataset:(a=t.i.split("."))[0],c_id_indicateur:a[1]},t.f&&(a.f1code=t.f),a={indicModels:[new GCO5.model.indics.IndicModel(a)],action:"RECALL"},$(".indic-basket .removeAllItems",this._$renderedContent).trigger("click"),void GCO5.core.GcDelayUtil.callLater(this._onAddedToStage,[a],20,this);t.selcodgeo&&t.view&&(r=(a=this.map?this.map.getSelgeo(this.map.getStatLayerName()):null)&&a.getSingleCodgeo()?a.getSingleCodgeo():null,this.map&&(r&&t.selcodgeo!=r||null===r)&&(a=new GCO5.model.maps.SelGeo({id_extent:n,nivgeo:i,codgeo:t.selcodgeo}),this.map.drawSelgeo(a,null,!0)))}t.view&&this.map&&(this._super(),!t.p&&this.gcsm.getPrintMode()?this._onExitPrint():e&&e!=this._viewData.selectedView&&this.changeMapView(e))}}),GCO5.view.component.MapIndicatorCommon={rtl:!1,_getBaseViewData:function(t){this.rtl="rtl"===this.gclg.getTextDirection();var e,i=GCO5.appModel.getConcept("view"),n=GCO5.appModel.getConcept("extent"),r=n[0].c_id_extent,a=i[0].pk,s=i[0].nivgeo,c=(GCO5.appModel.getOption("default_view")?e=GCO5.core.GcArrayUtil.getSubArray(i,{pk:GCO5.appModel.getOption("default_view")}):GCO5.appModel.getOption("default_extent")&&(e=GCO5.core.GcArrayUtil.getSubArray(i,{id_extent:GCO5.appModel.getOption("default_extent")})),e&&0<e.length&&(a=e[0].pk,r=e[0].c_id_extent,s=e[0].id_nivgeo),this),h={app:GCO5.appModel.getOption("app"),view_a:i,nivgeo:s,selectedView0:a,selectedView:"",extent_a:n,selectedExtent0:r,selectedExtent:r,tableref_a:[],tjsIndics_a:[],structuredByExtent:"1"==GCO5.appModel.getOption("structuredByExtent"),pagesize_a:[{data:"A4"},{data:"A5"},{data:"A3"},{data:"Letter"},{data:"Legal"}],pageorient_a:[{data:"portrait",label:c.gclg.getString("PORTRAIT","print")},{data:"landscape",label:c.gclg.getString("LANDSCAPE","print")}],selectedPageSize:"A4",selectedPageOrient:"portrait",isSortByTypeVisible:!0,updateSerieListForDisplay1:!1,updateSerieListForDisplay2:!1,f1_a:[],indic1:"",indic2:"",libIndic1:"",libIndic2:"",serie1_a:[],serie1:null,serie2:null,serie2_a:[],source1:"",source2:"",anim1:!0,anim2:!0,metaLabels:[this.gclg.getString("INDIC_PRES","pilotage","indicator"),this.gclg.getString("INDIC_STATS","pilotage","indicator"),this.gclg.getString("INDIC_KNOW_MORE","pilotage","indicator")],i_a:["1","2"],mapmenu_a:GCO5.appModel.getMapMenu(t),tablemenu_a:GCO5.appModel.getTableMenu(this.importedDataset),smallScreen:this.cli.isSmallWidthScreen(),tinyScreen:this.cli.isTinyWidthScreen(),viewNivgeos:GCO5.core.GcArrayUtil.getColumnByKey(GCO5.appModel.getConcept("views"),"id_nivgeo"),mapNumActive:1,printBanner:GCO5.initInfo.printBannerPortrait,printComment:!1,hasCustomPrintBanner:function(){return GCO5.initInfo.hasCustomPrintBanner},getPrintBanner:function(){return"portrait"===this.selectedPageOrient?GCO5.initInfo.printBannerPortrait:GCO5.initInfo.printBannerLandscape},getMapHeaderClass:function(){return"mapHeader "+(""!=this.libIndic1&&""!=this.libIndic2?"i2":""!=this.libIndic1?"i1":"i0")},getViewLib:function(t){t=2==t?this.selectedView2:this.selectedView,t=GCO5.core.GcStringUtil.isEmpty(t)?"":GCO5.appModel.getInfo("infoFromMapName",[t,"c_lib_view"]);return t?t.split("|").join(" "):""},getViewLibVisibility:function(t){return"2"==t?""==this.libIndic1_c2:""==this.libIndic1},getViews:function(t){var e=this["selectedExtent"+(t=t||"")],i=this["selectedView"+t],n=GCO5.core.GcArrayUtil.getSubArray(this.view_a,{id_extent:e});if(""!=i&&0<n.length)if(GCO5.core.GcArrayUtil.indexOfByKey(n,"pk",i)<0){var r=GCO5.core.GcArrayUtil.indexOfByKey(n,"id_nivgeo",this.nivgeo);if(r<0&&c.getActiveMap()){var a,s=c.getActiveMap().getEnabledIndicsModelsIndexed();for(a in s){var o=GCO5.core.GcArrayUtil.intersection(s[a].getProp("views"),GCO5.core.GcArrayUtil.getColumnByKey(n,"pk"));if(0<o.length){r=GCO5.core.GcArrayUtil.indexOfByKey(n,"pk",o[0]);break}}}r<0&&(r=0),GCO5.core.GcDelayUtil.callLater(function(){"ReportComponent"==c.getName()&&"m"!=h.selectedGeoMethod?h.selectedView=l:c.setObservableProperty("selectedView"+t,l=n[r].pk)},[],1,c)}else{var l=i;GCO5.core.GcDelayUtil.callLater(function(){c.setObservableProperty("selectedView"+t,l,{noTrigger:!0,forceTrigger:!0})},[],1,c)}return n},getSeriesShort:function(t,e){if(t=this.data.series){if(1<t.length)return" <span>("+t[t.length-1]+"..."+t[0]+")</span>";if(1==t.length)return", <span>"+t[0]+"</span>"}return"<span></span>"},getSerieSelectedIndex:function(t,e){return this["serie"+t+"_a"+(e=e?"_c2":"")].indexOf(this["serie"+t+e])+1},toPilotage:function(){$("#tm_map",c._$renderedContent).trigger("click"),c._$renderedContent.addClass("pilotage-only"),c.alignFormLabels(".labelgroup"),c.map&&(c.map.setStyles({"hidden-pilotage":!0}),c.map.mapToolTip.clear())},hidePilotage:function(){$("body").removeClass("restitCompositeMode2 pilotage-on").addClass("restitCompositeMode pilotage-off"),c.onResize(null,null,!0),$(".switch-pilotage-show").focus()},showPilotage:function(){$("body").removeClass("restitCompositeMode pilotage-off").addClass("restitCompositeMode2 pilotage-on"),c.onResize(null,null,!0),$(".switch-pilotage-hide").focus()},backFromPrint:function(t){c._onExitPrint()},print:function(t){window.print()},displayMap:function(){c._$renderedContent.removeClass("pilotage-only"),c.map&&c.map.setStyles({"hidden-pilotage":!1})},getLibSel:function(){return c.getActiveMap().getLibSel()},getNbSelObjs:function(){return c.getActiveMap().getNbSelObjs()},getSelectedIndics:function(t){return this["selectedIndics_a"+(t=t?"_c2":"")]},getSelectedIndics2:function(){return this.selectedIndics_a_c2},getLibIndic:function(t,e){return this["libIndic"+t+(e=e?"_c2":"")]},getAnim:function(t,e){return this["anim"+t+(e=e?"_c2":"")]},getSerie:function(t,e){return this["serie"+t+(e=e?"_c2":"")]},getSerieList:function(t,e){return this["serie"+t+"_a"+(e=e?"_c2":"")]},getSerieListForDisplay1:function(t){return""!=this.getLibIndic("1",t=t?"_c2":"")?this["serie1_a"+t]:[]},getSerieListForDisplay2:function(t){return""!=this.getLibIndic("2",t=t?"_c2":"")?this["serie2_a"+t]:[]}};return h.getPrintBanner.depends=["selectedPageOrient"],h.getLibIndic.depends=["libIndic1","libIndic2","libIndic1_c2","libIndic2_c2"],h.getSerie.depends=["serie1","serie2","serie1_c2","serie2_c2"],h.getSerieList.depends=["serie1_a","serie2_a","serie1_a_c2","serie2_a_c2"],h.getSerieListForDisplay1.depends="updateSerieListForDisplay1",h.getSerieListForDisplay2.depends="updateSerieListForDisplay2",h.getSerieSelectedIndex.depends=["serie1","serie2","serie1_c2","serie2_c2"],h.getSelectedIndics.depends=["hasNoCompatibleIndics"],h.getViews.depends=["selectedExtent"],h.getViewLib.depends=["selectedView"],h.getMapHeaderClass.depends=["libIndic1","libIndic2"],h.getViewLibVisibility.depends=["libIndic1","libIndic1_c2"],h.extent_a=GCO5.appModel.getConcept("extent"),h.selectedExtent=GCO5.appModel.getInfo("infoFromMapName",[a,"id_extent"]),h},changeMapView:function(t){this._viewData.selectedView=t,this.setObservableProperty("selectedExtent",GCO5.appModel.getInfo("infoFromMapName",[t,"id_extent"])),this.setObservableProperty("selectedView",t,{forceTrigger:!0})},_getTreeType:function(t){return GCO5.appModel.getInfo("TreeType",[t])},_updateDomainTree:function(t){var e,i;"__KEYWORD__"!=this._viewData.selectedTree&&(e=GCO5.model.indics.Dataset.getTree(),i=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("tree"),{c_id_tree:this._viewData.selectedTree})[0].themes.concat(),e&&(i=e.concat(i)),this.setObservableProperty("nbDoms",i.length),this.setObservableArray("tree_a",i),this._backToTreeIndics(),"withImport"==t&&this.openTreeIndicsOnTheme(i[0].c_id_theme),this.setObservableProperty("selectedDom",i[0].c_id_theme))},getSelectedIndics:function(){var t=this._getMapSuffix(!0);return this._viewData["selectedIndics_a"+t]},_getThemesByDomain:function(t){var e=this._viewData._filterKeyMode?this._filteredDomTree.dom_o?this._filteredDomTree.dom_o[t].themes:this._filteredDomTree.th_a:GCO5.appModel.getConcept("theme");return e="_import"==t&&0<(t=GCO5.model.indics.Dataset.getDatasetListByCat()).length?t.concat():e},_activeImportedIndicOnNewMap:function(t,e){t.enable();var i,n=this.map.getEnabledIndicsModelsIndexed();for(i in this.map.getNewMapIndicsInfoAfter(t,"add").indicsToDisable)n[i].disable();n[t.getPk()]||(n[t.getPk()]=t),this._viewData.mapIndicModels=n,this.setObservableProperty("selectedView",e),this._viewData.mapIndicModels=null},saveState:function(){var t=this.getCurrentStateMeta({onlyEnabledIndics:!1}),e=GCO5.model.indics.Dataset.exportAllDatasets();return{state:t,dts_a:e,refgeos:this.getExternalDataRefgeosFromImportedIndicators(e)}},getExternalDataRefgeosFromImportedIndicators:function(t){var e,i={};for(e in t){var n=t[e];0===n.data.indexOf("_import")&&0<n.nbIndics&&("PT"==(n=GCO5.model.indics.Dataset.getDataset(n.data)).topology&&(i[n.getPk()]=n.refgeoData))}return i},getCurrentStateMeta:function(t){t=t||{};var e,i=this.map.getSelgeo(),n=this.map.getMapExtent(),r={type:"map",nivgeo:this.map.nivgeo,mapName:this.map.getIdView(),id_extent:this.map.getIdExtent(),indics_a:[]},a=(i||n.contains(this.map._getMapExtentA5(),!0)||(r.extent=n.rect),this._getCustomMapIndicModels(t.onlyEnabledIndics,t.ignoreImportedIndics));for(e in a){var s=a[e],o={};o.c_id_indicateur=s.getProp("idIndic"),o.c_id_dataset=s.getProp("idDataset"),o.lib_indicateur=s.getProp("shortLibIndic"),o.typind=s.getProp("type"),o.nbDec=s.getProp("nbDec"),o.topo=s.getProp("topology"),o.source=s.getProp("source"),s.getProp("serie")&&(o.serie=s.getProp("serie")),s.getProp("f1Code")&&(o.f1code=s.getProp("f1Code"),o.f1lib=s.getProp("f1Lib")),s.getProp("f0Code")&&(o.f0code=s.getProp("f0Code")),this.map.anamorphing&&(o.cartogram=!0),o.mapParams=s.exportParams(t),r.indics_a.push(o)}return i&&(r.selgeo=i.getDataNivgeo()),r},_getCustomMapIndicModels:function(t,e){var i,n=this.map.getIndicsModelsIndexed(),r=[];for(i in this._viewData.selectedIndics_a){var a=this._viewData.selectedIndics_a[i];t&&a.disabled||(a=(e||0!==a.c_id_dataset.indexOf("_import")?n:GCO5.model.indics.Dataset.getDataset(a.c_id_dataset).getIndics())[a.pk],r.push(a))}return r},extractImportedDataValuesForCurrentState:function(t){var e,i=this._getCustomMapIndicModels(t),n={};for(e in i){var r=i[e];if(0===r.getProp("idDataset").indexOf("_import")){var a=r.getProp("dataset"),s=r.getProp("idDataset"),o=r.getValues(),l=r.getProp("idIndic");if(n[s])for(var c in o)n[s][c][l]=o[c];else{n[s]=[];var h,d,u=a.getCodgeosIndex();for(h in u)o[u[h]]&&((d={}).__idgeo__=h,d[l]=o[u[h]]),n[s].push(d)}}}return n},_getActiveSerieFromDataset:function(t){var e,i=this.getActiveMap().getEnabledIndicsModelsIndexed();for(e in i){var n=i[e];if(n.getProp("idDataset")==t&&n.getProp("serie"))return n.getProp("serie")}return null},openTreeIndicsOnTheme:function(e,t){if(!(GCO5.core.GcDelayUtil.curFrame()<1e3&&"atih_pmsi"==GCO5.appModel.getOption("app"))){this._viewData.nbIndicsToLoadInit0=0;var i,n,r,a,s=GCO5.appModel.getInfo("domFromThm",[e]),o=this;if(!s){var l=GCO5.appModel.getConcept("tree"),c=this._viewData.selectedTree;if("N"==this._getTreeType(c))return;l.forEach(function(t){t.c_id_tree==c||s||"I"!=t.c_type_tree||(o.setObservableProperty("selectedTree",t.c_id_tree),s=GCO5.appModel.getInfo("domFromThm",[e]))})}s&&(l=$(".treeindics",this._$renderedContent),i=s.dom||s.thm,n=s.thm,r=l.find("[data-pk='"+i+"']"),l.find(".ui-selected").removeClass("ui-selected"),1==r.length&&((a=n==i?r:r.find("[data-pk='"+n+"']")).find("a").addClass("ui-selected"),this._backToTreeIndics(),!(l=r.find(".ui-collapsible-heading-toggle")).closest(".ui-collapsible").hasClass("ui-collapsible-collapsed")&&n!=i||((l.closest(".ui-collapsible").find(".ui-collapsible-content li").length<=10||t)&&l.trigger("click"),t&&(o.gcsm.freeze("listIndics"),GCO5.core.GcDelayUtil.callLater(function(){a.find("a").trigger("click"),o.gcsm.unFreeze("listIndics",10)},[],70,l)))),this.gcsm.unFreeze("openTreeIndicsOnTheme"))}},isIndicatorComponent:function(){return 0<this.constructor.NAME.indexOf("Indicator")},_setIndicVisibility:function(t,e){var i,n=this._getMapSuffix(!0),r=this["map"+this._getMapSuffix()],n=this._viewData["selectedIndics_a"+n],a=r.getIndicsModelsIndexed(),s=this,a=a[t],o=GCO5.core.GcArrayUtil.getSubArray(n,{pk:[t]})[0],n=this._getActiveSerieFromDataset(o.c_id_dataset),l=GCO5.model.indics.Dataset.getDataset(o.c_id_dataset);e&&!this.hasTwoMaps()&&this.isIndicatorComponent()&&"N"!=this._getTreeType(this._viewData.selectedTree)&&(i=a?a.getProp("idThemes"):o.c_id_theme||o.c_id_dataset,o&&o.TJSServer&&(i="_tjs_"+o.TJSServer),GCO5.core.GcDelayUtil.callLater(this.openTreeIndicsOnTheme,[i],20,this)),a?(s.gcsm.freeze("render"),r.setThemeVisibility(a,e),e&&a.getProp("f1Code")&&this._scrollToIndicF1code(a),e&&n&&(l?this._updateMapIndicAxisValues(a,n):o.serie!=n&&0<=o.series.indexOf(n)?(o.serie=n,GCO5.core.GcDelayUtil.callLater(function(){$(s).triggerHandler(s.constructor.CHANGE_INDIC,[!0,o])},[],5,this)):this._updateMapIndicAxisValues(a,n=o.serie))):(o.disabled=!1,l?"loadNewMap"==(i=l.tryDisplayIndicOnMap(t,this.map)).action&&(r=l.getIndics(),s._activeImportedIndicOnNewMap(r[t],i.mapName)):(n&&0<=o.series.indexOf(n)&&(o.serie=n),$(this).triggerHandler(this.constructor.CHANGE_INDIC,[!0,o])))},_getMapSuffix:function(t){return 2==this._viewData.mapNumActive?(t?"_c":"")+"2":""},getActiveMap:function(){return 2==this._viewData.mapNumActive?this.map2:this.map},_updateMapIndicAxisValues:function(t,e){var i,n,r=this._getMapSuffix(!0),a=this._viewData["selectedIndics_a"+r],s=this._viewData["selectedIndicModels_o"+r],o=t.getPkF1(),l=t.getPk(),c=this._viewData["indic1"+r]==o||1==this._getReducedIndicStatus()?"1":this._viewData["indic2"+r]==o?"2":null,e=e||t.getProp("serie"),h=t.getProp("filter1"),d=GCO5.core.GcArrayUtil.indexOfByKey(a,"pk",l),u=GCO5.core.GcArrayUtil.indexOfByKey(a,"pk0",l);if(h&&GCO5.core.GcArrayUtil.indexOfByKey(a,"pk",o)<0&&(0<=d||0<=u)&&((g=a[d=d<0?u:d]).f1code=t.getProp("f1Code"),o=g.pk=g.pk0+"|"+g.f1code,g.pksafe=t.getPkF1Safe(),s[g.pk]=t,this.setObservableProperty("selectedF1Code",g.f1code),this.setObservableProperty("hasNoCompatibleIndics"+r,this._viewData["hasNoCompatibleIndics"+r],{forceTrigger:!0}),this._buildMetaIndic(t)),e&&c){var p,g,u="serie"+c,s=this._viewData[u+"_a"+r].concat().sort();if(p=t.checkSeriesValues(s,e)){if((d=GCO5.core.GcArrayUtil.indexOfByKey(a,"pk",o))<0)return;(g=a[d]).series=p.serie_a,g.serie=p.serie,this._updateSerieListOnDisplay(c,u+"_a"+r,p.serie_a.reverse()),this.setObservableProperty(u+r,p.serie,{forceTrigger:!0}),this._updateMapIndicsLib()}else GCO5.core.GcDelayUtil.callLater(this.setObservableProperty,[u+r,e],1,this)}h&&"N"!=this._viewData.typeTree&&(i=t.getProp("f1Code"),s=this._getFilter1List(h,t.getPk()),p=t.checkFilter1Values(s,i),(d=GCO5.core.GcArrayUtil.indexOfByKey(this._viewData.indic_a,"pk",l))<0||(p?n=p.f1_a.concat():(this.setObservableProperty("selectedF1Code",i),n=s.concat(),this._scrollToIndicF1code(t)),!this._viewData.indic_a[d].f1_a||this._viewData.indic_a[d].f1_a.length==n.length&&this._viewData.indic_a[d].f1_a[0].id==n[0].id?this._viewData.indic_a[d].f1_a=n:(this._viewData.indic_a[d].f1_a=n,this._removeFilter1IndicsNoCompatibleWithNewView(o,l,n),this._viewData.indic_a[d].f1_a.forEach(function(t){t.selected=t.id==i}),this.setObservableArray("indic_a",this._viewData.indic_a),this._syncIndicList(),$(".indics_filter1",this._$renderedContent).find("h3[data-pk='"+l+"'] a").trigger("click"))))},_removeFilter1IndicsNoCompatibleWithNewView:function(e,t,i){var n=t.split(".").shift(),r=this,t=this._viewData,a=r._getMapSuffix(!0),s=r["map"+r._getMapSuffix()],o=t["selectedIndics_a"+a],l=t["selectedIndicModels_o"+a],c=[],h=s.getIndicsModelsIndexed(),d=!1;o.forEach(function(t){if(t.c_id_dataset==n&&GCO5.core.GcArrayUtil.indexOfByKey(i,"id",t.f1code)<0)return r._removeTheme(h[t.pk],{noRender:!0}),delete l[t.pk],void(d=!0);c.push(t),t.pk==e&&c.length}),d&&(GCO5.core.GcStringUtil.isEmpty(t.selectedF1Code)||(s=$(".indics_filter1 .ui-collapsible-content li[data-pk!='"+t.selectedF1Code+"']",this._$renderedContent),$("a",s).removeClass("selected")),o.length!=c.length&&r.setObservableArray("selectedIndics_a"+a,c))},_scrollToIndicF1code:function(e,t){var i=this;t=t||0,GCO5.core.GcDelayUtil.callLater(function(){var t=$(".indic-container div[data-pk='"+e.getPk()+"'] li[data-pk='"+e.getProp("f1Code")+"']",i._$renderedContent);t.length&&1==i._viewData.indic_a.length&&t.scrollIntoView()},[],t,this)},_syncUIAfterPickIndic:function(t,e){var i=t.getPkF1(),n=(this._getMapSuffix(!0),this.getActiveMap()),r=this.getSelectedIndics();GCO5.core.GcArrayUtil.indexOfByKey(r,"pk",i)<0?(e=e||GCO5.appModel.getInfo("IndicMetaData",[t]),(r=GCO5.core.GcObjectUtil.cloneJson(e)).pk=i,r.pksafe=t.getPkF1Safe(),r.pk0=t.getPk(),r.f1code=t.getProp("f1Code"),r.filter0=t.getProp("filter0"),r.disabled=e.disabled||n&&!n.getContainer().is(":visible"),r.external=t.onImportedData()||t.isTJS(),r.valuesDisplayable=t.valuesDisplayable(),r.idDataset||(r.idDataset=r.c_id_dataset),this._updateSelectedIndicsList("insert",t,r)):this._syncSelectedIndicCheckbox(i,!0),t.getProp("filter1")||this._syncIndicList()},_getReducedIndicStatus:function(){return this.mobileReducedMode},_updateSelectedIndicsList:function(i,t,e){var n,r,a,s,o,l,c,h=-1,d=-1,u=this,p=this._getMapSuffix(!0),g=this.getActiveMap(),f=this.getSelectedIndics(),m=this._viewData["selectedIndicModels_o"+p],_=f.concat(),v=t.getPkF1();1==this._getReducedIndicStatus()&&(_=[]),"N"==this._viewData.typeTree&&e&&(e.f1_a=[]),_.forEach(function(t,e){"remove"==i&&v==t.pk?s=e:(a=m[t.pk].getMappingSuperCategory(),t.firstChoro=t.firstSymb=!1,"Choro"==a&&(n||(t.firstChoro=n=!0),h=e),"Symb"==a&&(r||(t.firstSymb=r=!0),d=e))}),"insert"==i||"update"==i?(l=t.getMappingSuperCategory(),m[v]=t,"Choro"==l&&(o=n?h+1:(n=!0,d+1)),"Symb"==l&&(o=r?d+1:(r=!0,0)),"insert"==i?_.splice(o,0,e):t.onImportedData()&&_[t=GCO5.core.GcArrayUtil.indexOfByKey(_,"pk",t.getPk())].scat!=l&&(e=_[t],_.splice(t,1),o<=t?_.splice(o,0,e):_.splice(o-1,0,e))):(_.splice(s,1),delete m[v]),n=r=!1,_.forEach(function(t,e){a=m[t.pk].getMappingSuperCategory(),t.firstChoro=t.firstSymb=!1,"Choro"!=a||n||(t.firstChoro=n=!0),"Symb"!=a||r||(t.firstSymb=r=!0),t.indvisi=u._viewData.indvisi}),"update"!=i&&"remove"!=i||this.setObservableArray("selectedIndics_a"+p,[]),this.setObservableArray("selectedIndics_a"+p,_),"remove"==i&&u._buildMetaIndic&&(c=g.getIndicsModelsIndexed(),f.forEach(function(t){0!=t.c_id_dataset.indexOf("_import")&&(t=c[t.pk]||new GCO5.model.indics.IndicModel(t),GCO5.core.GcDelayUtil.callLater(u._buildMetaIndic,[t],10,u))}))},_syncIndicList:function(t){var e=t?$(".indic-container div.ui-collapsible:not(.ui-collapsible-collapsed)",this._$renderedContent).data("pk"):null;this.setObservableProperty("sortByType",this._viewData.sortByType,{forceTrigger:!0}),t&&e&&((t=$(".indic-container div.ui-collapsible[data-pk='"+e+"']",this._$renderedContent)).length&&t.find("h3.filter1 a").trigger("click"))},_syncSelectedIndicCheckbox:function(t,e){var i=this.getSelectedIndics(),t=GCO5.core.GcArrayUtil.indexOfByKey(i,"pk",t);t<0||(this._waitingForUpdateMapTitle=!1,$.observable(i[t]).setProperty("indvisi",e))},_syncAllSelectedIndicCheckboxes:function(){var t,e,i,n,r;1!=this._getReducedIndicStatus()&&(t=this.getActiveMap(),e=0,n=t.getEnabledIndicsModelsIndexed(),r=t.getIdView(),this.getSelectedIndics().forEach(function(t){n[t.pk]||$.observable(t).setProperty("indvisi",!1),0<=t.c_id_views.indexOf(r)&&t.disabled?i=t:t.disabled||e++}),0==e&&i&&($.observable(i).setProperty("indvisi",!0),GCO5.core.GcDelayUtil.callLater(this._setIndicVisibility,[i.pk,!0],40,this)))},_syncUIAfterChangeMapView:function(t){var e=this._viewData,i=this._getMapSuffix(),n=GCO5.appModel.getInfo("infoFromMapName",[t.mapName,"id_extent"]);n!=e["selectedExtent"+i]?(e["selectedView"+i]=t.mapName,this.setObservableProperty("selectedExtent"+i,n)):this.setObservableProperty("selectedView"+i,t.mapName,{noTrigger:!0}),this.gcsm.historyBrowsing||1!=e.mapNumActive||(n=t.mapName,$.bbq.getState("view")?$.bbq.pushState({view:n}):"indicator"==$.bbq.getState("c")&&(i=GCO5.core.ClientInfo.getInstance().getUrlWithoutHash(),i+="#view="+n+"&c=indicator",history.replaceState({view:n,c:"indicator"},null,i))),this.setObservableProperty("nivgeo",t.nivgeo),this._updateMapIndicsLib(),this._syncAllSelectedIndicCheckboxes()},addMixinMapListeners:function(r){this._viewData;var a=this;r=r||this.map,$(r).on(GCO5.view.component.MapView.UPD_SERIE,function(t,e){a._updateMapIndicAxisValues(e.mapIndicModel,e.serie)}).on(GCO5.view.component.MapView.INFOSEL,function(t,e){e.map=t.target,$(a).triggerHandler(GCO5.view.component.MapView.INFOSEL,e)}).on(GCO5.view.component.MapView.ONBUILD_INFOSEL,function(t,e){a._onBuildInfosel&&a._onBuildInfosel(e,t.target)}).on(GCO5.view.component.MapViewThematic.ON_DISABLE_INDIC,function(t,e){a._syncSelectedIndicCheckbox(e,!1)}).on(GCO5.view.component.MapViewThematic.ON_ENABLE_INDIC,function(t,e){a._syncSelectedIndicCheckbox(e,!0)}).on(GCO5.model.indics.DatasetImported.BEFORE_ADD_INDICS,function(t,e){a._loadIndicsFromCurrentDataset()}).on(GCO5.view.component.MapViewThematic.DISPLAY_THM_SETTINGS,function(t,e){var e=e.split("|"),e=(e.pop(),e.join("|")),i=r.getEnabledIndicsModelsIndexed()[e],n="Map"+i.getCategory().replace("_","")+"SettingsPanel";GCO5.appModel.loadColorsFamData(function(){function e(){var t=new GCO5.view.component[n];GCO5.core.GcDelayUtil.callLater(function(){t.setup({action:"NEW",categ:"panel",container:$(".cd-panel.from-left .cd-panel-content"),mim:i,map:r})},[],10,a)}GCO5.view.component.AMapThmSettingsPanel?e.apply(a):(a.gcsm.freeze("settingsPanel"),require(["mapthmsettings_m"],function(t){a.gcsm.unFreeze("settingsPanel"),t.initialize(),e.apply(a)}))},a,"C")}).on(GCO5.view.component.MapViewThematic.DISPLAY_GEO_SETTINGS,function(t,e){function i(){var t=new GCO5.view.component[n];GCO5.core.GcDelayUtil.callLater(function(){t.setup({action:"NEW",categ:"panel",container:$(".cd-panel.from-left .cd-panel-content"),map:r,ca:a})},[],10,a)}var n="Map"+e+"Panel";GCO5.view.component.MapSearchPanel?i.apply(a):(a.gcsm.freeze("settingsPanel"),require(["mapgeosettings_m"],function(t){a.gcsm.unFreeze("settingsPanel"),t.initialize(),i.apply(a)}))}).on(GCO5.view.component.MapViewThematic.DISPLAY_TABLE_SETTINGS,function(t,e){a.tableView.displayTablePanel(e,a)}).on(GCO5.view.component.MapViewThematic.DISPLAY_FIC_SETTINGS,function(t,e){a.ficindicView.displayFicPanel(e)}).on(GCO5.view.component.MapViewThematic.DISPLAY_SEL_METHODS,function(t){var e=new GCO5.view.component.MapSelmethodsPanel;GCO5.core.GcComponentUtil.displaySlidingPanel(t.target),GCO5.core.GcDelayUtil.callLater(function(){e.setup({action:"NEW",categ:"panel",container:$(".cd-panel.from-left .cd-panel-content"),map:r})},[],10,a)}).on(GCO5.view.component.MapView.END_RENDER,function(t,e,i){a._onEndRenderMap.apply(a)}).on(GCO5.view.component.MapView.REQUEST_CHANGE_VIEW,function(t,e){a.setObservableProperty("selectedView",e.mapName)})},_addMapListeners:function(){this.addMixinMapListeners()},_onEndRenderMap:function(){this._waitingForFirstMapRendered,this._waitingForFirstMapRendered=!1},__setMapDimensions:function(t,e){var i=t?t.getContainer():$(".mapContainer",this._$renderedContent).eq(this._viewData.mapNumActive-1),n=(t&&t.getDisplayGroup().hide(),i.width()),r=GCO5.browser.height-i.offset().top-2,a=r,s=this.gcsm.getActiveComponent(),s=(!this.cli.isInIframe()||!s||"ReportComponent"==s.getName()||$("body").hasClass("iframe2")||(s=$(".iframe-notice-container")).length&&(a-=s.height(),s.css("visibility","visible")),t?t.getLegendContainers():null),s=s?s.legH:$(".maplegendH",i.parent()),s=(s.is(":visible")&&(a-=parseFloat(s.css("min-height"))),a=Math.floor(a),i.height(a),i.closest(".mapSection").height(r),$(".cu-pilotage",this._$renderedContent)),r=GCO5.browser.height-s.offset().top-1;s.height(r);$(".page-container",this._$renderedContent).height(GCO5.browser.height);s=$(".map-aside-sc",this._$renderedContent);return s.height(GCO5.browser.height-s.offset().top-2),!t||(t.getDisplayGroup().show(),!(Math.abs(t.getWidth()-n)<=1&&Math.abs(t.getHeight()-a)<=1)&&(!!i.is(":visible")&&(t.setSize(n,a,e),!0)))},onResize:function(t,e,i){this._mapRendering||$("body").hasClass("pre-print")||(this.cli.isLargerThanSmallWidthScreen()&&this._$renderedContent.removeClass("pilotage-only"),this.ficindicView&&this.ficindicView.onResize(),this.tableView&&this.tableView.onResize(null,null,i),this.tableView&&GCO5.core.GcDelayUtil.callLater(this.tableView.onResize,[null,null,i],20,this.tableView),this.map&&!this.resizing&&(i=this.__setMapDimensions(this.map),this.map2&&this.map2.getContainer().is(":visible")&&(GCO5.browser.width<900?$("#tm_map",this._$renderedContent).trigger("click"):GCO5.core.GcDelayUtil.callLater(this.__setMapDimensions,[this.map2],10,this)),i&&(this.setTableVisibility(),this.alignFormLabels(".labelgroup"))))},setTableVisibility:function(){$("#"+this._viewData.cp+"_table").parent().css("display",this.cli.isTinyWidthScreen()||this.cli.isTinyHeightScreen()?"none":"flex")},_setMapDimensionsAfterResize:function(){var t=this.map,e=t.getContainer().closest(".page-container"),e=$(".mapPrintContainer",e),i=t.getContainer(),n=Math.max(e.width(),300),r=Math.max(e.height(),300);i.width(n).height(r),e.width(n).height(r),t.setSize(n,r),GCO5.core.GcDelayUtil.callLater(function(){i.show()},[],10,this)},_updateDragCaches:function(){var t=this.map.getContainer().closest(".page-container"),e=$(".mapPrintContainer",t);this.rtl?$(".drag-cache-h",t).css("right",(parseFloat(e.css("right"))||0)+e.width()+10+"px"):$(".drag-cache-h",t).css("left",(parseFloat(e.css("left"))||0)+e.width()+10+"px"),$(".drag-cache-v",t).css("top",(parseFloat(e.css("top"))||140)+e.height()+10+"px")},_setMapDimensionsPrePrint:function(){var t=this.map,e=(t.getLegendContainers(),t.getContainer()),t=t.getContainer().closest(".page-container"),i=$(".mapPrintContainer",t),n=$(".mapthlegendV",t),t=$(".printTextContainer",t),r=t.filter(".comment");t.filter(".doc");e.css({width:"15cm",height:"15cm"}),GCO5.browser.isFirefox&&e.css({width:"14cm",height:"14cm"}),this.map.setSize(e.width()-1,e.height()-1),i.width(e.width()).height(e.height()),this.rtl?n.css("right",e.width()+10+"px"):n.css("left",e.width()+10+"px"),r.hide(),GCO5.core.GcDelayUtil.callLater(this._onPageOrientChange,[this._viewData.selectedPageOrient],20,this)},_updateHashOnEnterPrint:function(){var t;this.gcsm.historyBrowsing||((t=GCO5.core.GcObjectUtil.cloneJson($.bbq.getState())).p=1,$.bbq.pushState(t,2))},_updateHashOnExitPrint:function(){var t;this.gcsm.historyBrowsing||(delete(t=GCO5.core.GcObjectUtil.cloneJson($.bbq.getState())).p,$.bbq.pushState(t,2))},_onPageOrientChange:function(t){var e,i=this.map,n=(i.getLegendContainers(),i.getContainer()),i=i.getContainer().closest(".page-container"),r=($printTextContainer=$(".printTextContainer",i),$printComment=$printTextContainer.filter(".comment"),$printDoc=$printTextContainer.filter(".doc"),$mapPrintContainer=$(".mapPrintContainer",i),$mapLegendV=$(".mapthlegendV",i),!1),i=(this._viewData.selectedIndics_a&&this._viewData.selectedIndics_a.forEach(function(t){0!=t.c_id_dataset.indexOf("_import")||t.disabled||(r=!0)}),this._viewData.meta1);this._viewData.meta2&&this._viewData.meta1!=this._viewData.meta2&&(i="<b class='figure-with-border mrvs'>1</b>"+i+"<br><br><b class='figure-with-border mrvs'>2</b>"+this._viewData.meta2),r&&this.setObservableProperty("printDoc",!0),this.setObservableProperty("metaDocPrint",i&&!r),$printDoc.find("span").html(i),$printDoc.css("display",GCO5.core.GcStringUtil.isEmpty(i)?"none":"block"),$printComment.show(),this.rtl?"portrait"==t?($printDoc.css({right:"0px",top:$mapPrintContainer.offset().top+n.height()+10+"px"}).width(GCO5.browser.isFirefox?"17.5cm":"19cm"),$printComment.css({right:"0px",top:parseFloat($printDoc.css("top"))+$printDoc.height()+20+"px"}).width(GCO5.browser.isFirefox?"17.5cm":"19cm")):(e=this._viewData.meta1?$mapLegendV.width():0,$printDoc.css({top:$mapPrintContainer.offset().top-20+"px",right:n.width()+e+25+"px"}).width(300),$printComment.css({top:parseFloat($printDoc.css("top"))+$printDoc.height()+(this._viewData.meta1?20:0)+"px",right:n.width()+e+25+"px"}).width(315)):"portrait"==t?($printDoc.css({left:"0px",top:$mapPrintContainer.offset().top+n.height()+10+"px"}).width(GCO5.browser.isFirefox?"17.5cm":"19cm"),$printComment.css({left:"0px",top:parseFloat($printDoc.css("top"))+$printDoc.height()+20+"px"}).width(GCO5.browser.isFirefox?"17.5cm":"19cm")):(e=this._viewData.meta1?$mapLegendV.width():0,$printDoc.css({top:$mapPrintContainer.offset().top-20+"px",left:n.width()+e+25+"px"}).width(300),$printComment.css({top:parseFloat($printDoc.css("top"))+$printDoc.height()+(this._viewData.meta1?20:0)+"px",left:n.width()+e+25+"px"}).width(315))},_enterPrePrintMode:function(){var t=this.map,e=(t.getLegendContainers().legV,this._viewData.printDoc=null!=t.getCurTheme(),t.enterPrePrintMode(),t.getContainer().closest(".page-container")),n=this,i=$(".thematicmap-layout",e),r=$(".mapPrintContainer",e),a=t.getContainer(),s=$(".mapthlegendV",e),o=$(".printTextContainer",e),l=(this.gcsm.setPrintMode("preprint"),this.map.setPrintMode("preprint"),$("body").addClass("pre-print"),$(".backFromPrint",e)),e=(l.prop("disabled",!0),GCO5.core.GcDelayUtil.callLater(function(){l.prop("disabled",!1).focus()},[],50,n),$("#mapSection",e).hide(),n._setMapDimensionsPrePrint(),this._updateHashOnEnterPrint(),r.resizable({containment:".page",start:function(t,e){a.hide(),r.find(".print-copyright").hide();var i=r.css("border-top");r.css("border","1px solid #ccc"),r.css("border-top",i)},stop:function(t,e){n._setMapDimensionsAfterResize(),GCO5.core.GcDelayUtil.callLater(function(){r.find(".print-copyright").show()},[],10,n),this.rtl?$(".copyright-scale",r).show().css({top:n.map.getHeight()/2+"px",bottom:"auto",left:n.map.getWidth()/2-2+"px"}):$(".copyright-scale",r).show().css({top:n.map.getHeight()/2+"px",bottom:"auto",right:n.map.getWidth()/2-2+"px"});var i=r.css("border-top");r.css("border","none"),r.css("border-top",i),n._updateDragCaches()}}).draggable({stop:function(){n._updateDragCaches()},cancel:".mapContainer",containment:$(".page",n._$renderedContent)}),o.draggable({cancel:"textarea",containment:".page",start:function(){$(this).find("textarea").blur()},stop:function(){$(this).find("textarea").focus()}}).resizable({containment:$(".page",n._$renderedContent)}),$("<div class='drag-cache drag-cache-h'></div>")),o=$("<div class='drag-cache drag-cache-v'></div>"),e=(e.insertAfter(r),o.insertAfter(r),s.draggable().appendTo(i),s.find("svg").draggable(),a.appendTo(r),a.hide(),GCO5.core.GcDelayUtil.callLater(function(){r.append($("<p class='print-copyright'>"+t.drawCopyrights()+"</p>")),a.show(),s.css("width",s.find("svg").width()+"px"),n._updateDragCaches()},[],10,this),this.setObservableProperty("printComment",this._viewData.printComment,{forceTrigger:!0}),this.setObservableProperty("printDoc",this._viewData.printDoc,{forceTrigger:!0}),t.getResolutionRatio()),o=this.map.getHeight()/e-13,i=(t.gMapsActive()&&(o+=15),2==e?this.map.getWidth()/e+1:1);this.rtl?$(".copyright-scale",r).css({top:o+"px",bottom:"auto",left:i+"px"}):$(".copyright-scale",r).css({top:o+"px",bottom:"auto",right:i+"px"})},_onExitPrint:function(){var t=this.map,e=t.getContainer(),i=t.getLegendContainers(),t=t.getContainer().closest(".page-container"),i=i.legV,n=$(".mapthlegendV",t);this.gcsm.setPrintMode(null),this.map.setPrintMode(null),$(".drag-cache",t).remove(),$(".mapPrintContainer",t).resizable("destroy").draggable("destroy").removeAttr("style").find(".print-copyright").remove(),$(".printTextContainer",t).resizable("destroy").draggable("destroy").removeAttr("style"),$(".printTextContainer.comment",t).css("visibility",this._viewData.printComment?"visible":"hidden"),n.draggable("destroy").removeAttr("style").appendTo(i).find("svg").draggable("destroy").removeAttr("style"),e.removeAttr("style").prependTo($(".map-legendH-container",t)),this.rtl?$(".copyright-scale",t).css({top:"auto",bottom:"0",left:"2px"}):$(".copyright-scale",t).css({top:"auto",bottom:"0",right:"2px"}),$("body").removeClass("pre-print"),$("#mapSection",t).show(),this._updateHashOnExitPrint(),GCO5.topApp._initMegaMenu(),this.onResize()},onBeforePrint:function(){var e,i,n,r,t=this.map.getContainer().closest(".page-container");$("body").hasClass("pre-print")?(t.scrollTop(0),e=$(".printTextContainer.comment",t).find("textarea"),i=e.val(),n=GCO5.appModel.getLegal("tx_reserve_cmt"),GCO5.core.GcStringUtil.isEmpty(n)&&(n=this.gclg.getString("USER_COMMENT","print")),n=this.gclg.getString("WARNING")+this.gclg.getString("P2B")+" "+n,i==this.gclg.getString("MY_COMMENT")+"..."?e.hide():i.indexOf(n)<0&&(e.val(n+"\n"+i+"\n"),e.height(e.height()+30)),(r=t).css("height","auto"),$(window).one("mousemove",function(){var t;0==i.indexOf(n)&&((t=i.split("\n")).shift(),i=t.join("\n")),e.show().val(i),r.height(GCO5.browser.height),$(window).off("mousemove")})):"m"==this._viewData.selectedRestit&&alert(this.gclg.getString("PRINT_HINT","print"))},_activateRestitTab:function(t,e){var i=this._viewData.cp,n=$("#"+i+"_"+{m:"map",t:"table",f:"fiche"}[t],this._$renderedContent),i=$("#"+i+"_nav_"+{m:1,t:2,f:3}[t],this._$renderedContent);e?n.addClass("highlighted"):n.removeClass("highlighted"),n.attr({"aria-selected":e.toString()}),i.css("display",e?"block":"none")},alignFormLabels:function(t,e){e=e||this._$renderedContent;var i=0,t=$(t,e);t.each(function(t){i=Math.max(i,$(this).outerWidth())}),t.each(function(t){$(this).css("min-width",i+"px")})},hasTwoMaps:function(){return"m2"==this._viewData.selectedRestit&&this.map2},addMixinListeners:function(){var g=this._viewData,f=this,n=$("#cth_indic_cb",this._$renderedContent),r=$(".treeindics",f._$renderedContent);r.on("click",".ui-collapsible-heading-toggle",function(t,e){var i;0==$(this).closest("div").data("nbthemes")&&(r.find(".ui-selected").removeClass("ui-selected"),i=$(this).closest("div").data("pk"),g.treeIndicsClicked=!0,i==g.selectedTheme?f._showListIndics():(f.setObservableProperty("selectedDom",i),f.setObservableProperty("selectedTheme",i)))}),r.on("collapsibleexpand",function(t,e){"1"==$(e).data("level")&&f.setObservableProperty("selectedDom",$(e).data("pk"))}),r.on("click keyup","li",function(t){if("keyup"==t.type)"13"!=(t=t.keyCode||t.which)&&"32"!=t||GCO5.core.GcDelayUtil.callLater(function(){$(".indics_filter1 > div.ui-collapset-header ",f._$renderedContent).find("a").focus()},[],10,f);else{if(0==$(this).data("level"))return!1;r.find(".ui-selected").removeClass("ui-selected"),$(this).find("a").addClass("ui-selected");t=$(this).data("pk");g.treeIndicsClicked=!0,t==g.selectedTheme?f._showListIndics():f.setObservableProperty("selectedTheme",t)}}),$(".indics_filter1",this._$renderedContent).find(".ui-collapset-header").on("click keydown","a",function(t){"keydown"==t.type?"13"!=(t=t.keyCode||t.which)&&"32"!=t||GCO5.core.GcDelayUtil.callLater(function(){$(".treeindics",f._$renderedContent).find("a.ui-selected").focus()},[],10,f):f._backToTreeIndics()}),$(".indics_filter1",this._$renderedContent).on("click","h3.no-filter1",function(t){f.setObservableProperty("selectedIndic",$(this).data("pk")),n.trigger("change"),"N"==g.typeTree&&$(this).find("a").addClass("selected")}),$(".indics_filter1",this._$renderedContent).on("click",".ui-collapsible-content li",function(t){var e=""+$(this).data("pk"),i=$(this).closest(".ui-collapsible").data("pk");$(this).find("a").addClass("selected"),$(this).closest(".ui-collapsible").find("h3 a").addClass("selected"),f.setObservableProperty("selectedIndic",i),f.setObservableProperty("selectedF1Code",e),GCO5.core.GcDelayUtil.callLater(function(){n.trigger("change")},[],5,f)}),$.observe(g,"selectedPageOrient",function(t,e){e=e.value;f._onPageOrientChange(e)}),$.observe(g,"selectedTheme",function(t,e){var i=e.value;GCO5.core.GcStringUtil.isEmpty(i)?f.setObservableProperty("selectedIndic",""):0==i.indexOf("_import")||0==i.indexOf("_tjs_")?f.onLoadIndicsFromTheme({indics:GCO5.appModel.getIndicsFromImportedDataset(i)}):f._viewData._filterKeyMode&&f._filteredDomTree.i_a?(e=f._filteredDomTree.i_a.filter(function(t){if(0<=t.c_id_theme.indexOf(i))return!0}),f.onLoadIndicsFromTheme({indics:e})):(f.setObservableArray("tjsIndics_a",[]),GCO5.appModel.getListIndics(f.onLoadIndicsFromTheme,f,{theme:i,tree:g.selectedTree,tjs:g.selectedTjsSrv}))}),$.observe(g,"selectedTree",function(t,e){e=e.value;g.typeTree=f._getTreeType(e),"__KEYWORD__"==e?f._onTreeFiltering(t,{path:"tag",value:g.tag}):(GCO5.appModel.buildDomainTree(e),f._updateDomainTree())}),$(".indic-basket",this._$renderedContent).on("click keydown",".removeAllItems",function(t){var e=t.keyCode||t.which;"keydown"==t.type&&"13"!=e||(t=f._getMapSuffix(!0),(e=f["map"+f._getMapSuffix()])&&(f.setObservableArray("selectedIndics_a"+t,[]),g["selectedIndicModels_o"+t]={},e.removeAllThemes(),f.tableView&&f.tableView.removeIndicModel(),f.setObservableProperty("selectedIndic",""),f._syncIndicList(),f._closeTreeIndics()))}).on("change",".indVisi",function(t){f._waitingForUpdateMapTitle=!1;var e=$(this),i=e.closest("li").data("pk"),n=this.checked,r=f._getMapSuffix(!0),r=g["selectedIndics_a"+r];0<=g.selectedRestit.indexOf("f")?(r.forEach(function(t,e){n&&t.pk!=i&&$.observable(t).setProperty("indvisi",!1),n||t.pk!=i||GCO5.core.GcDelayUtil.callLater(function(){$.observable(t).setProperty("indvisi",!0)},[],1,f)}),"*"!=i||n?"*"!=i&&$("#tmindic-tabdet",f._$renderedContent).prop("checked",!1):GCO5.core.GcDelayUtil.callLater(function(){e.prop("checked",!0)},[],1,f),GCO5.core.GcDelayUtil.callLater(f._setFicIndicVisibility,[i,n],1,f)):0<=g.selectedRestit.indexOf("m")&&GCO5.core.GcDelayUtil.callLater(f._setIndicVisibility,[i,n],1,f)}),$(".page-container .help",this._$renderedContent).on("click",function(t){alert("aide")}),$.observe(g,"selectedPageSize",function(t,e){g.noTrigger||e.value}),$.observe(g,"selectedPageOrient",function(t,e){g.noTrigger||(e=e.value,$(".page").removeClass(function(t,e){return(e.match(/(^|\s)orient-\S+/g)||[]).join(" ")}).addClass("orient-"+e),$(".pageNav").css("width","portrait"==e?"20cm":"28.5cm"))}),$(".l_serie",this._$renderedContent).on("click keydown","li",function(t){var e=t.keyCode||t.which;if("keydown"!=t.type||"13"==e){var i,e=f.map.getContainer().closest(".thematicmap-layout").get(0)==$(this).closest(".thematicmap-layout").get(0)?"1":"2",n="2"==e?"2":"",r="2"==e?"_c2":"",a=(f.hasTwoMaps()&&($(".c2-on-basket",f._$renderedContent).find("[data-pk='map"+e+"']").trigger("click"),$(".c2-on-geo",f._$renderedContent).find("[data-pk='map"+e+"']").trigger("click")),f["map"+n]),s=g["selectedIndics_a"+r],e=$(this).closest("div").attr("id").split("_").pop().substr(0,6),o=a.getIndicsModelsIndexed()[g["indic"+e.substr(-1)+r]],l=$(this).text();if(l!=o.getProp("serie")){if(l==f.gclg.getString("ANIM","anim"))return i=new GCO5.view.component.MapAnimPanel,GCO5.core.GcComponentUtil.displaySlidingPanel(t.target),f.cli.isWithoutPilotagePanel()&&$(".cd-panel-container").hide(),void GCO5.core.GcDelayUtil.callLater(function(){i.setup({action:"NEW",categ:"panel",ca:f,container:$(".cd-panel-content"),map:a,mapIndicModel:o})},[],10,f);if(s[GCO5.core.GcArrayUtil.indexOfByKey(s,"pk",o.getPkF1())].serie=l,0==o.getProp("idDataset").indexOf("_import")){var c=o.getIndicModel().getDataset().mapIndicModels;for(h in c)c[h].setSerie(l);for(h in a.render(),c)c[h].isEnabled()&&f._updateMapIndicAxisValues(c[h])}else{var h,d=o.getProp("idDataset"),u={},p=0;for(h in c=a.getEnabledIndicsModelsIndexed())c[h].getProp("idDataset")==d&&(u[h]=c[h],u[h].setSerie(l),s[GCO5.core.GcArrayUtil.indexOfByKey(s,"pk",h)].serie=l,p++);1<p?(n={},a.getSelgeo()&&(n.selgeo=a.getSelgeo()),a._changingViewKeepExtent=!a.viewContainsAndTouchesMainActiveLayer(!0),GCO5.appModel.loadMapViewModel(f.setupMap,f,a.getName(),a.getMapExtent(),u,n)):GCO5.appModel.loadMapIndic(f.onLoadIndicData,f,o.getIndicModel(),a,{serie:l},o)}}}}),$(".mapmenucontent",this._$renderedContent).on("click keydown","a",function(t){var e,i;if("keydown"!=t.type||13==t.keyCode)return t=$(this).data("pk"),i=$(this).closest(".mapmenucontent").attr("id").substr(-1,1),i=f["map"+("2"==i?"2":"")],"Print"==t?(e=f.backToSingleMapMode(),void GCO5.core.GcDelayUtil.callLater(f._enterPrePrintMode,[],e,f)):void("Select"==t?$(i).triggerHandler(GCO5.view.component.MapViewThematic.DISPLAY_SEL_METHODS,[]):(GCO5.core.GcComponentUtil.displaySlidingPanel($(".map-options-menu",f._$renderedContent)),$(i).triggerHandler(GCO5.view.component.MapViewThematic.DISPLAY_GEO_SETTINGS,[t])))}),$(".tablemenucontent",this._$renderedContent).on("click keydown","a",function(t){"keydown"==t.type&&13!=t.keyCode||(f.tableView.isFluxTable()?alert("Le filtrage des données de flux n'est pas encore disponible."):(GCO5.core.GcComponentUtil.displaySlidingPanel(t.target,1<f._viewData.selectedRestit.length?"right":"left"),$(f.map).triggerHandler(GCO5.view.component.MapViewThematic.DISPLAY_TABLE_SETTINGS,[$(this).data("pk")])))}),$(".tableficcontent",this._$renderedContent).on("click keydown","a",function(t){"keydown"==t.type&&13!=t.keyCode||("Print"==$(this).data("pk")?(GCO5.browser.isFirefox,window.print()):(GCO5.core.GcComponentUtil.displaySlidingPanel(t.target,1<f._viewData.selectedRestit.length?"right":"left"),$(f.map).triggerHandler(GCO5.view.component.MapViewThematic.DISPLAY_FIC_SETTINGS,[$(this).data("pk")])))}),$(this._$renderedContent).on("click","dialog a.link-nivgeo",function(t){var e,i;$(this).data("link")!=g.nivgeo&&(i=0,f.getActiveMap().getEnabledIndicsModelsIndexed()[e=$(this).data("pk")]||(f._syncSelectedIndicCheckbox(e,!0),i=60),GCO5.core.GcDelayUtil.callLater(f.changeMapView,[GCO5.appModel.getInfo("mapNameFromNivgeo",[$(this).data("link")])],i,f),$("body").trigger("click"))}),$(this._$renderedContent).on("click","dialog a.link-extent",function(t){var e=f.getActiveMap().getEnabledIndicsModelsIndexed(),i=$(this).data("pk"),n=$(this).data("link"),r=0;e[i]||(f._syncSelectedIndicCheckbox(i,!0),r=60),GCO5.core.GcDelayUtil.callLater(function(){var t=(e=f.getActiveMap().getIndicsModelsIndexed())[i].getProp("ViewsCompatible",{id_extent:n});0<=t.indexOf(g.mapName)||f.changeMapView(t[0])},[],r,f),$("body").trigger("click")}),$.observable(g.selectedIndics_a).observeAll($.proxy(this._updateMapIndicsLib,this))},_buildMetaIndic:function(i,t){var n=this._getMapSuffix(),e=this._viewData["selectedIndics_a"+this._getMapSuffix(!0)];if(i){if(null==t)for(var r in t=0,e){if(e[r].pk==i.getPkF1())break;t++}function a(t){return c.gclg.getString(t,"indics")}function s(t){return c.gclg.getString(t,"concepts")}function o(t){return c.gclg.getString(t,"pilotage","indicator")}var l=[],c=this,h=this._viewData.cp,d=[];i.getProp("source")&&d.push({title:a("SOURCE"),label:i.getProp("source")}),GCO5.core.GcStringUtil.isEmpty(i.getProp("unit"))||d.push({title:a("UNIT"),label:i.getProp("unit")});var u,p,g="";i.getNivgeosArray().forEach(function(t){g+="<a href='javascript:void(0)' class='link-nivgeo' title=\""+o("MAP_AT_THIS_LEVEL")+"\" data-pk='"+i.getPkF1()+"' data-link='"+t.data+"'>"+t.label+"</a>, "}),""!=g&&d.push({title:s("NIVGEOS_S"),label:g.substr(0,g.length-2)}),i.getProp("extents").length<=8&&(g="",i.getProp("extents").forEach(function(t){g+="<a href='javascript:void(0)' class='link-extent' title=\""+o("MAP_AT_THIS_LEVEL")+"\" data-pk='"+i.getPkF1()+"' data-link='"+t.c_id_extent+"'>"+t.c_lib_extent+"</a>, "}),""!=g&&d.push({title:s("EXTENTS"),label:g.substr(0,g.length-2)})),g="",i.getProp("libThemes").forEach(function(t){g+="tm"==h?"<a href='javascript:void(0)' class='link-theme' title=\""+o("LOCATE_IN_TREE")+"\" data-link='"+t.id_theme+"'>"+t.lib_theme+"</a>, ":t.lib_theme+", "}),""!=g&&d.push({title:i.onImportedData()?s("DATASET"):s("THEMES2"),label:g.substr(0,g.length-2)}),i.getProp("descIndicateur")&&d.push({title:o("INDIC_DESC"),label:GCO5.core.GcStringUtil.toHTmlWithSingleBr(i.getProp("descIndicateur"))}),GCO5.core.GcStringUtil.isEmpty(i.getProp("precisions"))||d.push({title:o("INDIC_PREC"),label:GCO5.core.GcStringUtil.toHTmlWithSingleBr(i.getProp("Precisions"))}),GCO5.core.GcStringUtil.isEmpty(i.getProp("FormulaLib"))||d.push({title:a("INDIC_FORMULA"),label:"<span class='word-break-all'>"+GCO5.core.GcStringUtil.toHTmlWithSingleBr(i.getProp("FormulaLib"))+"</span>"}),GCO5.core.GcStringUtil.isEmpty(i.getProp("LimitUtil"))||d.push({title:o("INDIC_LIM_UTIL"),label:GCO5.core.GcStringUtil.toHTmlWithSingleBr(i.getProp("LimitUtil"))}),i.hasMultiplePeriods()&&(70<(u=(p=i.getProp("dataSeries")).reverse().join(", ")).length&&(u=p[0]+"..."+p[p.length-1]),d.push({title:a("PERIODS"),label:u})),i.getProp("hasCI")&&d.push({title:a("DATA_PRECISION"),label:a("VALUES_WITH_CI")}),i.getProp("TJSMention")&&(i.getProp("TJSServerGeoclipURL")?(g="<a href='"+i.getProp("TJSServerGeoclipURL")+"' title=\"Accéder au serveur TJS\" target='_blank'>"+i.getProp("TJSMention")+"</a>, ",d.push({title:"Origine TJS",label:g})):d.push({title:"Origine TJS",label:i.getProp("TJSMention")})),i.valuesDisplayable()?i.valuesExportable()||d.push({title:a("DIFF_LIMITS"),label:a("VALS_NONEXP")}):d.push({title:a("DIFF_LIMITS"),label:a("VALS_NONDIFF")}),u=d.reduce(function(t,e,i){return t+(0<i?"<br><br>":"")+(e.title?"<b>"+e.title+c.gclg.getString("P2")+"  </b>":"")+e.label},""),l.push(u),"tm"==h&&(u=$.render.thematicMapStatDesc({mapIndicModel:i}),l.push(u),d=[],(p=i.getProp("uRLTextIndicateur"))&&d.push({title:null,label:"<a href='"+i.getProp("uRLIndicateur")+"' target='_blank'>"+p+"</a>"}),(p=i.getProp("URLTextData"))&&d.push({title:null,label:"<a href='"+i.getProp("URLData")+"' target='_blank'>"+p+"</a>"}),i.getProp("uRLLogo")&&d.push({title:null,label:"<p class='inblxx'><img style='max-width:120px' src='"+i.getProp("uRLLogo")+"'></p>"}),u=d.reduce(function(t,e,i){return t+(0<i?"<br><br>":"")+(e.title?"<b>"+e.title+c.gclg.getString("P2")+"  </b>":"")+e.label},""),i.getProp("uRLIndicateur")||i.getProp("URLData")?l.push(u):$("#ind"+i.getPkF1Safe()+"_meta"+n,c._$renderedContent).find("li").eq(2).hide()),l.forEach(function(t,e){c.getElementById(h+"_meta"+(e+1)+"_"+i.getPkF1Safe()+n).html(t)}),$("#"+h+i.getPkF1Safe()+"_meta"+n,c._$renderedContent).find(".js-tabs").accessibleTabsAria()}},backToSingleMapMode:function(t){var e=0;return $("body").is('[class*="restitCompositeMode"]')&&(e+=10,$("#tm_map").trigger("click")),e},displayThisMapindicOnly:function(t){var e,i=this.map.getIndicsModelsIndexed(),n=this.map;if(t||(e=this.map.getEnabledIndicsModelsIndexed(),t=(t=GCO5.core.GcObjectUtil.getFirstKey(e))||GCO5.core.GcObjectUtil.getFirstKey(i)),!i[t])return!1;i[t].isEnabled()||(n.setThemeVisibility(i[t],!0),this._syncSelectedIndicCheckbox(t,!0));var r,a=!1;for(r in i)if(r!=t&&i[r].isEnabled()){GCO5.core.GcDelayUtil.callLater(function(){n.setThemeVisibility(i[r],!1)},[],25),this._syncSelectedIndicCheckbox(r,!1),a=!0;break}return a},_updateSerieListOnDisplay:function(t,e,i,n,r){var a=this._viewData;a[e]&&i&&(a[e].length!=i.length||a[e].join(",")!=i.join(","))&&(this.setObservableArray(e,i),n&&r&&this.setObservableProperty(n,r,{forceTrigger:!0}),this.setObservableProperty("updateSerieListForDisplay"+t,!0,{forceTrigger:!0}))},_updateMapIndicsLib:function(t,e,i,n){var r,a,s,o,l,c,h,d=1,u=0,p=this,g=this._viewData,f=this._getMapSuffix(!0),m=this.getActiveMap(),_=this.getSelectedIndics(),v=this._viewData["selectedIndicModels_o"+f];!m||p._waitingForUpdateMapTitle||g.selectedRestit.indexOf("m")<0||(p.setObservableProperty("libIndic1"+f,""),p.setObservableProperty("libIndic2"+f,""),r=[],s=!(a=[]),o=m.getIndicsModelsIndexed(),l=[],c=m.getIdView(),_.forEach(function(t){var e=v[t.pk];e&&(0!=t.c_id_dataset.indexOf("_import")&&0!=t.c_id_dataset.indexOf("tjs_")||(p._buildMetaIndic&&p._buildMetaIndic(e,u++),t.c_source=e.getProp("source"),t.c_unite=e.getProp("unit"),t.c_desc_indicateur=e.getProp("descIndicateur"),t.c_tjs_mention=e.getProp("TJSMention")),(e=t.c_id_views=(e?e.getProp("views"):null)||t.c_id_views)&&e.indexOf(c)<0&&(s=!0),e="SPINE"==g.selectedFicIndic&&o[t.pk].isEnabled(),(!t.disabled||e)&&d<=2&&(t.priority=0<=["I","C"].indexOf(t.c_id_typind)?2:1,l.push(t),d++))}),$(".libIndic",m.getContainer().closest(".thematicmap-layout")).off("dragstart").removeAttr("title").removeAttr("draggable"),l.sort(function(t,e){return t.priority-e.priority}),l.forEach(function(i,t){r=0<r.length?GCO5.core.GcArrayUtil.intersection(r,i.nivgeos):i.nivgeos,a=0<a.length?GCO5.core.GcArrayUtil.intersection(a,i.c_id_views):i.c_id_views;var e=i.libIndic;GCO5.core.GcStringUtil.isEmpty(i.c_unite)||(e+=" ("+i.c_unite+")"),i.series&&1==i.series.length&&(e+=" "+i.series[0]),i.f1code&&(e+=g.getF1Lib(i.filter1,i.f1code)),j=t+1,g.selectedF0Lib&&i.f0code&&(i.series&&p.setObservableProperty("d0IndicSerie",i.serie||i.series.concat().sort().reverse()[0],{forceTrigger:!0}),h=!0,e=g.selectedF0Lib+" - "+e),p.setObservableProperty("libIndic"+j+f,e),p.setObservableProperty("source"+j+f,i.c_source+(i.c_tjs_mention?" - "+i.c_tjs_mention:"")),p.setObservableProperty("meta"+j+f,i.c_desc_indicateur),p.setObservableProperty("indic"+j+f,i.pk),p.setObservableProperty("anim"+j+f,0<=["I","C","R"].indexOf(i.c_id_typind)&&!i.isPie&&"PG"==i.c_topo),o[i.pk]&&p._updateMapIndicAxisValues(o[i.pk]);e=(e=i.series||[]).concat().sort().reverse();p._updateSerieListOnDisplay(j,"serie"+j+"_a"+f,e,"serie"+j+f,0==e.length?null:i.serie=i.serie||e[0],{forceTrigger:!0}),o[i.pk]&&p._updateMapIndicAxisValues(o[i.pk]),GCO5.browser.isTouch||!p.hasTwoMaps()&&!n||$(".libIndic",m.getContainer().closest(".thematicmap-layout")).eq(t).prop("draggable","true").attr("title",p.gclg.getString("DRAG_TO_OTHER_VIEW","restit","indicator")).on("dragstart",function(t){p._draggingElement=$(this);var e=i.pk0+"."+(i.serie||"")+"."+(i.f1code||"");t.originalEvent.dataTransfer.setData("Text",e)})}),"atih_pmsi"==GCO5.appModel.getOption("app")&&(p.setObservableProperty("filter0ListIsVisible",h),h||GCO5.core.GcDelayUtil.callLater(p.setObservableProperty,["displayGHTEtabs",!1],30,p)),0==l.length&&p.setObservableProperty("meta1"+f,null),1==l.length&&p.setObservableProperty("meta2"+f,null),p.setObservableProperty("nivgeosIndics"+f,0==r.length||2==j?"*":r.join("|")),p.setObservableProperty("viewsIndics"+f,0==a.length||2==j?"*":a.join("|")),p.setObservableProperty("hasNoCompatibleIndics"+f,s),i||GCO5.core.GcDelayUtil.callLater(p.onResize,[],30,p))},__onResultSearchGeo:function(t,e,i,n,r){var a=t.rech_a.length,s=GCO5.core.GcStringUtil.unaccent(e),o=GCO5.appModel.getInitKey("nivgeo_o");if(r=r||this,0==a)return $(".rechgeo_msg",this._$renderedContent).show(),void $.observable(this._viewData.nivgeo_a).refresh([]);$(".rechgeo_msg",this._$renderedContent).hide();for(var l=0;l<a;l++){var c=t.rech_a[l],h=c.libgeo||"",d=(c.uid=l,GCO5.core.GcStringUtil.unaccent(h.toLowerCase())),d=(c.libgeo2=h+" ("+c.codgeo+")",d.indexOf(s)),u=c.codgeo.toLowerCase().indexOf(s),h=h.length+" (".length+u,u=c.libgeo2.substr(d<0?h:d,s.length);c.libgeo2=c.libgeo2.split(u).join("<b>"+u+"</b>"),c.lib_nivgeo=o[c.nivgeo].c_lib_nivgeo}"position"==i&&(t.rech_a=t.rech_a.filter(function(t){return!n||0<=n.indexOf(t.nivgeo)})),$.observable(this._viewData.rechgeo_a).refresh(t.rech_a),$.observable(this._viewData.nivgeo_a).refresh(e=r.__buildListGeoDp(t.rech_a,i,s,n)),0==e.length&&$(".rechgeo_msg",this._$renderedContent).show()},__buildListGeoDp:function(t,e,i,n){if("position"==e)return t.map(function(t){return t.label=t.nivgeoLib+" "+t.codgeo+" - "+t.libgeo,t});for(var r,a=t.length,s=[],o={},l=0;l<a;l++){(c=t[l]).libgeo=c.libgeo||"";var c,h,d=GCO5.core.GcStringUtil.unaccent(c.libgeo.toLowerCase()),u=(c.libgeo2=c.libgeo+" ("+c.codgeo+")","load"!=e&&(u=d.indexOf(i),h=c.codgeo.toLowerCase().indexOf(i),h=c.libgeo.length+" (".length+h,h=c.libgeo2.substr(u<0?h:u,i.length),c.libgeo2=c.libgeo2.split(h).join("<b>"+h+"</b>")),GCO5.core.GcArrayUtil.indexOfByKey(s,"data",c.nivgeo));o[c.nivgeo+c.codgeo]=++o[c.nivgeo+c.codgeo]||1,u<0?(!n||0<=n.indexOf(c.nivgeo))&&(h={data:c.nivgeo,label:GCO5.appModel.getInfo("libNivgeo",[c.nivgeo]),selgeos:[c],codgeolen:c.codgeo.length,mcodgeolen:c.codgeo.length,count:"geoloc"==e?-1:1,levenshtein:parseFloat(c.score),pos_cle:c.pos_cle||d.indexOf(i),nivgeo:c.nivgeo,hasExactMatch:Number(d==i||c.codgeo==i)},s.push(h)):(s[u].selgeos.push(c),s[u].count++,s[u].codgeolen+=c.codgeo.length,s[u].mcodgeolen=s[u].codgeolen/s[u].count,s[u].levenshtein+=parseFloat(c.score),s[u].mlevenshtein=parseFloat(c.score)/s[u].count,s[u].pos_cle+=d.indexOf(i),s[u].mpos_cle=s[u].pos_cle/s[u].count,s[u].libgeolen=c.lib_nivgeo?c.lib_nivgeo.length:100,s[u].hasExactMatch=s[u].hasExactMatch||Number(d==i||c.codgeo==i))}for(r in s){for(var p in s[r].selgeos)1<o[(c=s[r].selgeos[p]).nivgeo+c.codgeo]&&""==c.filt_nivgeo&&(c.exclude=!0,o[c.nivgeo+c.codgeo]=0);for(var p in s[r].selgeos)1<o[(c=s[r].selgeos[p]).nivgeo+c.codgeo]&&(c.libgeo2+=", "+c.lib_view.split("|").join(" "))}return e||s.sort(function(t,e){var i=e.hasExactMatch-t.hasExactMatch;return 0!=i||0!=(i=t.mpos_cle-e.mpos_cle)||0!=(i=t.mcodgeolen-e.mcodgeolen)||0!=(i=t.libgeolen-e.libgeolen)?i:e.mlevenshtein-t.mlevenshtein}),s}},puremvc.define({name:"GCO5.view.mediator.IndicatorMediator",parent:puremvc.Mediator},{gcsm:null,initComponent:function(t){var e,n;"1"==GCO5.initInfo.iframe&&GCO5.initInfo.indicslist&&(e=GCO5.initInfo.indicslist.split(","),n=e.length,t.indicModels=e.map(function(t,e){var t=t.split("@"),i={},t=(i.c_id_dataset=t[0],i.c_id_indicateur=t[1],new GCO5.model.indics.IndicModel(i));return e<n-1&&t.setOption("disabledAtFirst",!0),t}),GCO5.initInfo.indicslist=null),GCO5.core.GcComponentUtil.setupAndShowComponent(this.viewComponent,t)},onRegister:function(){this.gcsm=GCO5.core.SystemManager.getInstance();var t=new GCO5.view.component.IndicatorComponent;this.setViewComponent(t),this.addListeners(t)},listNotificationInterests:function(){return[GCO5.AppConstants.INIT_COMPONENT,GCO5.AppConstants.ON_RESIZE,GCO5.AppConstants.BEFORE_PRINT,GCO5.AppConstants.POSTROBOT_IN_MSG]},handleNotification:function(t){var e=t.getName(),i=t.getBody(),n=this.viewComponent;switch(e){case GCO5.AppConstants.INIT_COMPONENT:"indicator"==i.id&&this.initComponent(i);break;case GCO5.AppConstants.ON_RESIZE:n.isVisible()&&n.onResize(i.type);break;case GCO5.AppConstants.BEFORE_PRINT:n.isVisible()&&n.onBeforePrint();break;case GCO5.AppConstants.POSTROBOT_IN_MSG:if(n.isVisible()&&"Indicator"==i.scope)switch(i.msg){case"changeMapView":i.data.mapName&&GCO5.appModel.loadMapViewModel(this.onChangeMapView,this,i.data.mapName);break;case"exportMapImg":n.map.exportImageWithHeaders();break;case"printMap":console.log("POSTROBOT printMap"),n._enterPrePrintMode();break;case"zoomOnFullExtent":n.map.zoomOnFullExtent();break;case"clearSelection":n.map.clearSel("*")}}},onChangeMapView:function(i){var n=this.viewComponent,t=2==i.mapNumActive?null:GCO5.model.maps.SelGeo.getcurSelgeo();t&&(t.getSingleCodgeo()||t.isCompatibleWithMapView(i.mapName))?(i.selgeo=t).getSelIds(i.nivgeo,i.id_extent,function(t,e){0==e&&(i.selgeo=null),GCO5.core.GcDelayUtil.callLater(n.setupMap,[i],1,n)}):GCO5.core.GcDelayUtil.callLater(n.setupMap,[i],1,n)},addListeners:function(r){var h=this,t=r.constructor;$(r).on(t.CHANGE_MAPVIEW,function(t,e,i,n,r){for(o in n){var a,s=n[o];s.onImportedData()&&((a=a||{})[(s=s.getIndicModel().getDataset()).getPk()]=s)}if(a){var o,l=GCO5.core.GcObjectUtil.count(a),c=0;for(o in a)c++,a[o].prepareBeforeNewMap(c==l?h.onChangeMapView:null,c==l?h:null,e,n,i)}else GCO5.appModel.loadMapViewModel(h.onChangeMapView,h,e,i,n,{mapNumActive:r})}),$(r).on(t.CHANGE_INDIC,function(t,e,i){var i=i.isIndicModel?i:new GCO5.model.indics.IndicModel(GCO5.core.GcObjectUtil.cloneJson(i)),n=r.getActiveMap();GCO5.appModel.loadMapIndic(h._onLoadIndicData,h,i,n)}),$(r).on(GCO5.view.component.MapView.INFOSEL,function(t,e){GCO5.appModel.loadInfosel(e,e.map.onLoadInfosel,e.map)}),$(r).on(GCO5.view.component.MapView.REPROJ,function(t,e){GCO5.model.maps.AProj4||(h.gcsm.freeze("proj4"),require(["proj4_m"],function(t){h.gcsm.unFreeze("proj4"),t.initialize(e.ca,e.callback)}))})},_onLoadIndicData:function(t,e,i){var n,r,a,s,o,l,c,h,d,u,p,g=this.viewComponent,f=this,m=g.getActiveMap();e&&t.isIndicModel?(l=GCO5.appModel.getConcept("view"),(s=this.gcsm.getCuState("extent")||GCO5.appModel.getInfo("infoFromMapName",[m.getName(),"id_extent"]))&&(n=GCO5.appModel.getConcept("nivgeo_o"),r=GCO5.appModel.getConcept("view_o"),c=GCO5.core.GcArrayUtil.getSubArray(l,{id_extent:s}),0<(u=GCO5.core.GcArrayUtil.intersection(e,GCO5.core.GcArrayUtil.getColumnByKey(c,"c_id_view"))).length&&(a=(u=u.sort(function(t,e){return t=r[t].c_id_nivgeo,e=r[e].c_id_nivgeo,n[t].c_nivgeos_sup&&0<=n[t].c_nivgeos_sup.indexOf(e)?-1:n[e].c_nivgeos_sup&&0<=n[e].c_nivgeos_sup.indexOf(t)?1:0}))[0])),a||(c=null,GCO5.appModel.getOption("default_view")?c=GCO5.core.GcArrayUtil.getSubArray(l,{pk:GCO5.appModel.getOption("default_view")}):GCO5.appModel.getOption("default_extent")&&(c=GCO5.core.GcArrayUtil.getSubArray(l,{id_extent:GCO5.appModel.getOption("default_extent")})),c&&0<(u=GCO5.core.GcArrayUtil.intersection(e,GCO5.core.GcArrayUtil.getColumnByKey(c,"c_id_view"))).length&&(a=u[0])),a=a||e[0],s=m.getNewMapIndicsInfoAfter(t,"add"),m.isReprojected()&&(m.restoreProjInit(!0),m.updateGlobe(null,null,null,null,!0)),1==GCO5.core.GcObjectUtil.count(s.indicsModelRetained)&&(o=(t=GCO5.core.GcObjectUtil.getFirstVal(s.indicsModelRetained)).getProp("idIndicAssoc"),GCO5.core.GcStringUtil.isEmpty(o)||(h=t.getProp("idDataset")+"."+o,d=GCO5.core.GcArrayUtil.getSubArray(g._viewData.indic_a,{pk:h})[0],p=t.buildIndicAssocModel(d),s.indicsModelRetained[p.getPk()]=p)),GCO5.appModel.loadMapViewModel(function(t){p&&g._syncUIAfterPickIndic(p),f.onChangeMapView(t)},this,a,null,s.indicsModelRetained,null,!1)):(o=t.getProp("idIndicAssoc"),GCO5.core.GcStringUtil.isEmpty(o)?(h=t.getPk(),l=t.getPkF1(),0==(c=GCO5.core.GcArrayUtil.getSubArray(g.getSelectedIndics(),{pk:l})).length&&t.getAssocModel()&&g._syncUIAfterPickIndic(t,GCO5.appModel.getInfo("indicMetaData",[t]))):(h=t.getProp("idDataset")+"."+o,d=GCO5.core.GcArrayUtil.getSubArray(g._viewData.indic_a,{pk:h})[0],(u=m.getIndicsModelsIndexed())[h]?(u[h].isEnabled()||(u[h].enable(),g._syncUIAfterPickIndic(u[h])),t.getIndicModel().linkAssocModel(u[h].getIndicModel())):(p=t.buildIndicAssocModel(GCO5.core.GcObjectUtil.cloneJson(d)),d&&g._syncUIAfterPickIndic(p,d),GCO5.core.GcDelayUtil.callLater(GCO5.appModel.loadMapIndic,[this._onLoadIndicData,this,p,m],10,this))),g.onLoadIndicData(t))}},{NAME:"IndicatorMediator"}),GCO5.view.component.ExternaldataComponent=GCO5.view.component.AComponent.extend({statics:{NAME:"GCO5.view.component.ExternaldataComponent",CHANGE_MAPVIEW:"chgmv",CHANGE_INDIC:"chgind"},map:null,_waitingForFirstMapRendered:!0,_mapRendering:null,tableView:null,_changingDataset:null,_importingData:null,_mapReadyForPaste:null,_onRemovedFromStage:function(){if("tjssrv"==this._viewData.selectedImport){var t,e=this._viewData.selectedIndics_a.filter(function(t){return!GCO5.core.GcStringUtil.isEmpty(t.TJSServer)}),i={};for(t in e)i[e[t].TJSServer]||(i[e[t].TJSServer]=[]),e[t].c_id_views=new GCO5.model.indics.IndicModel(e[t]).getProp("ViewsCompatible"),e[t].c_id_indicateur=e[t].pk.split(".").pop(),i[e[t].TJSServer].push(e[t]);GCO5.model.indics.Dataset.registerTJSServers(i)}this._displayMap(),this._super()},_fireInitEvents:function(t){this.gcsm.freeze("initialRender"),GCO5.core.GcComponentUtil.animateCollapsibleSet($(".treeindics",this._$renderedContent)),GCO5.core.GcComponentUtil.animateCollapsibleSet($(".indics_filter1",this._$renderedContent),"atih_pmsi"==GCO5.appModel.getOption("app"));var e=GCO5.model.indics.Dataset.getDatasetListByCat(),e=(0<e.length&&(this.setObservableArray("dtslist_a",e),this.setObservableProperty("selectedDts",e[0].data)),GCO5.model.indics.Dataset.getDataset(this._viewData.selectedDts)),e=(e&&(this._viewData.selectedView=e.getCurMapName()),this.setObservableProperty("selectedExtent",this._viewData.selectedExtent0),this.__setMapDimensions(this.map,!0),this.cli.checkAndCleanState($.bbq.getState()));e.tjs&&e.i&&(this._viewData.selectedTheme=e.i.split(".").shift(),this._viewData.selectedTJSIndic=e.i.split(".").pop(),this.setObservableProperty("selectedImport","tjssrv")),this._super(t)},afterShow:function(){this._super(),this.alignFormLabels(".labelgroup")},goToMainContent:function(){$('[data-link="selectedImport"]',this._$renderedContent).focus()},getSaveState:function(){return{fav:0,study:1,url:0}},_onAddedToStage:function(t){var e=this.inited,t=(this._super(t),this.cli.clearHash(),GCO5.model.indics.Dataset.getDatasetListByCat()),i=(0<t.length&&(e&&this.setObservableArray("dtslist_a",t),e&&this.setObservableProperty("selectedDts",t[0].data)),GCO5.model.indics.Dataset.getDataset(this._viewData.selectedDts));if(i&&this.map){var e=this._viewData.selectedView!=i.getCurMapName(),n=this,r=this.map.getIndicsModelsIndexed(),a=0,s=0,o={},l={};if(this._viewData.selectedIndics_a.forEach(function(t,e){t.disabled||(l[t.pk]=1),r[t.pk]&&r[t.pk].isEnabled()!=!t.disabled&&(t.disabled&&(o[t.pk]=1),a++)}),a){for(var c in o)r[c].disable();for(var c in l)r[c].enable(),GCO5.core.GcDelayUtil.callLater(function(){n.map.setThemeVisibility(r[c],!1)},[],30*s++),n._syncSelectedIndicCheckbox(c,!1)}e&&GCO5.core.GcDelayUtil.callLater(function(){n.setObservableProperty("selectedView",i.getCurMapName())},[],30*s++)}},_prepareViewData:function(t){GCO5.core.GcObjectUtil.defaults(this,GCO5.view.component.MapIndicatorCommon);function e(t){return r.gclg.getString(t,"pilotage","externaldata")}var n=GCO5.appModel.getConcept("view"),i=GCO5.appModel.getConcept("extent"),r=this,a=[{data:"stats",label:e("PASTE_PG_DATA")},{data:"xy",label:e("PASTE_XY_DATA")}],s=GCO5.appModel.getConcept("tjs"),o=(0<s.length&&a.push({data:"tjssrv",label:e("CONNECT_TJS")}),a.forEach(function(t){t.visible="imp"!=t.data}),this._viewData=this._getBaseViewData(this.getShortName())),l=this.cli.checkAndCleanState($.bbq.getState()).tjs||(s&&0<s.length?s[0].c_id_tjs:null),s={ca:this,cp:"im",tjs_a:s,tree_a:[],selectedRestit:"m",mapVisibility:!0,import_a:a,dtsNivgeos:[],selectedImport:"stats",selectedTjsSrv:l,selectedTjsSrv0:l,pastedText:"",selectedIndics_a:[],selectedIndicModels_o:{},libDataset:"",selectedDelimDec:this.gclg.get_delim_dec(),dtslist_a:GCO5.model.indics.Dataset.getDatasetListByCat(),selectedDts:"*",selectedTheme:null,serie_a:[],selectedImportedTable:"g",selectedDtsSerie:null,datasetIsValid:!1,tjsThemes_a:[],metaLabels:[this.gclg.getString("DOCUMENTATION")],init:0,displayForSaveSelGeo:function(t){GCO5.core.GcComponentUtil.displaySlidingPanel(t.target),$(r.map).triggerHandler(GCO5.view.component.MapViewThematic.DISPLAY_GEO_SETTINGS,["Export"])},getExtentList:function(){var e,t;if(!o.noTrigger)return e=0<=["stats","xy","tjssrv","tjsfile","kml"].indexOf(o.selectedImport),o.view_a=n.filter(function(t){return e||o.importedDataset&&0<=o.dtsNivgeos.indexOf(t.c_id_nivgeo)&&o.dtsExtent==t.c_id_extent}),r.map&&"tjssrv"==o.selectedImport&&!GCO5.core.GcStringUtil.isEmpty(o.selectedTheme)&&n.filter(function(t){return 0<=o.dtsNivgeos.indexOf(t.id_nivgeo)}),t=i.filter(function(t){return 0<=GCO5.core.GcArrayUtil.indexOfByKey(o.view_a,"c_id_extent",t.c_id_extent)}),o.selectedExtent&&GCO5.core.GcDelayUtil.callLater(function(){r.setObservableProperty("selectedExtent",o.selectedExtent,{forceTrigger:!0})},[],1,r),t},getViewList:function(){if(o.noTrigger||!this.selectedExtent||!r.inited)return[];var t=GCO5.core.GcArrayUtil.getSubArray(n,{c_id_extent:this.selectedExtent}),e=r.map&&"tjssrv"==o.selectedImport&&!GCO5.core.GcStringUtil.isEmpty(o.selectedTheme);if(e&&0==(t=(t=GCO5.core.GcArrayUtil.getSubArray(n,{c_id_extent:o.selectedExtent})).filter(function(t){return 0<=o.dtsNivgeos.indexOf(t.id_nivgeo)})).length)return t;var i=GCO5.core.GcArrayUtil.indexOfByKey(t,"pk",this.selectedView)<0?t[0].pk:this.selectedView;return o.lastViewListFrame!=GCO5.core.GcDelayUtil.curFrame()&&GCO5.core.GcDelayUtil.callLater(function(){var t;o.selectedView==i&&(o.selectedView=null,1==o.init?t={noTrigger:!0}:o.init=1),r.setObservableProperty("selectedView",i,t),$("[data-link='selectedView']",r._$renderedContent).val(i)},[],1,r),o.lastViewListFrame=GCO5.core.GcDelayUtil.curFrame(),t},getDtsNivgeoList:function(){if(!this.selectedDts||"*"==this.selectedDts)return this.getViewList();var e=GCO5.model.indics.Dataset.getDataset(this.selectedDts),t=GCO5.core.GcArrayUtil.getSubArray(n,{c_id_extent:e.getIdExtent()}),i=e.getUsableNivgeos();return"PT"==e.topology?t.filter(function(t){return 0<=[e.curNivgeo].indexOf(t.id_nivgeo)}):t.filter(function(t){return 0<=i.indexOf(t.id_nivgeo)})},getViewPrefix:function(t){return 0==this.dtsNivgeos.length||0<=this.dtsNivgeos.indexOf(t)?"":"*"},getNbIndics:function(){return this.indic_a.reduce(function(t,e){return t+(o.compthismap&&!(0<=e.nivgeos.indexOf(o.nivgeo))&&""!=e.pk||o.essentiels&&"0"!=e.expert&&""!=e.pk?0:1)},0)-1},saveTJSFile:function(){console.log("saveTJSFile")},delDts:function(){$.observable(this.dtslist_a).remove($("[data-link=selectedDts] option:selected",r._$renderedContent).index()-1),GCO5.model.indics.Dataset.removeDataset(this.selectedDts),r.setObservableProperty("selectedDts","*")},indvisi:function(){return!this.disabled},getPasteHint:function(){return e("stats"==this.selectedImport?"PASTE_HINT":"PASTEXY_HINT")}};s.indvisi.set=function(t){this.disabled=!t},s.getDtsNivgeoList.depends=["selectedDts","dtsNivgeos.**"],s.getViewList.depends=["selectedExtent"],s.getPasteHint.depends=["selectedImport"],s.getExtentList.depends=["dtsNivgeos.**"],GCO5.core.GcObjectUtil.extend(this._viewData,s),this._viewData.structuredByExtent&&this.gcsm.getCuState("view")?(this._viewData.selectedView0=this.gcsm.getCuState("view"),this._viewData.selectedExtent0=this._viewData.selectedExtent=GCO5.appModel.getInfo("infoFromMapName",[this.gcsm.getCuState("view"),"id_extent"])):this._viewData.selectedView=this._viewData.selectedView0},setupMap:function(t){var e,i=this;t.mapContainer=$(".mapContainer",this._$renderedContent),t.styles.drillMaps=!1,t.styles.extent0=t.extent?new GCO5.model.maps.GeoExtent(t.extent):this._viewData.extent0,t.legendContainer={cv:null,divH:$(".maplegendH",this._$renderedContent),div:$(".maplegendV",this._$renderedContent)},t.copyrights=GCO5.appModel.getInfo("infoFromMapName",[t.mapName,"copyrights"]),this.__setMapDimensions(this.map),t.styles.selectable=!1,this.map?(this.map.setup(t),this._loadAllIndicModels(e=function(){i.tableView&&i._tableViewActive()&&GCO5.core.GcDelayUtil.callLater(i.tableView.setMap,[i.map],10,i.tableView)},this)||e.apply(this.tableView)):(this.map=new GCO5.view.component.MapViewThematic(t),this._addMapListeners()),this._syncUIAfterChangeMapView(t)},_loadAllIndicModels:function(t,e){var i=this,n=i.map.getIndicsModelsIndexed(),r=(this.map.getIdView(),this.map.getIdNivgeo()),a=this._viewData.importedDataset;if(a)return this._viewData.selectedIndics_a.forEach(function(t){!n[t.pk]&&0<=t.nivgeos.indexOf(r)&&a.tryDisplayIndicOnMap(t.pk,i.map,{render:!1,enabled:!1})}),!1},_tableViewActive:function(){return $("#im_nav_2",this._$renderedContent).is(":visible")},_onDatasetPaste:function(t){var e=this._viewData.importedDataset;return e&&!e.isValid()&&e.destroy(),e=new GCO5.model.indics.DatasetImported({mapName:this.map.getName(),topology:"xy"==this._viewData.selectedImport?"PT":"PG"}),this.setObservableProperty("importedDataset",e),e.checkPastedData(t,this._viewData.selectedDelimDec)},_onGetTJSThemes:function(t){this.setObservableArray("tjsThemes_a",t.themes);t=0<=GCO5.core.GcArrayUtil.indexOfByKey(t.themes,"c_id_theme",this._viewData.selectedTheme)?this._viewData.selectedTheme:t.themes[0].c_id_theme;this.setObservableProperty("selectedTheme",t,{forceTrigger:!0})},onLoadIndicsFromTheme:function(t){t.indics.forEach(function(t){t.pk=t.c_id_dataset+"."+t.c_id_indicateur}),this.setObservableArray("tjsIndics_a",t.indics);var e=this._viewData.selectedTheme+"."+this._viewData.selectedTJSIndic,t=GCO5.core.GcArrayUtil.indexOfByKey(t.indics,"pk",e);this.setObservableProperty("selectedIndicTJS",0<=t?e:"")},onLoadIndicData:function(t,e){this.onLoadIndicTJSData(t,e)},onLoadIndicTJSData:function(t,e){this["map"+this._getMapSuffix()];t.resetParams("calcs");var i={replace:this.mobileReducedMode,render:!0};this._waitingForUpdateMapTitle=!1,this._updateMapIndicAxisValues(t),this.map.getContainer().is(":visible")&&(this._updateMapIndicsLib(),this._updateMapIndicAxisValues(t)),this._addTheme(t,i),this._buildMetaIndic(t),t.getProp("filter1")||this._syncIndicList()},_closeTreeIndics:function(){},_addTheme:function(t,e){e=e||{render:!0};var i=this["map"+this._getMapSuffix()];i.getContainer().is(":visible")?i.addTheme(t,e):i.addTheme(t,{render:!1,enabled:!1})},_addListeners:function(){var i,a,n,c=this,r=this.constructor,h=c._viewData,s=$("#im_paste_ta",this._$renderedContent);$.observe(h,"libDataset",function(){h.importedDataset&&(h.importedDataset.setName(h.libDataset),$("[data-link=selectedDts] option:selected",c._$renderedContent).text(h.libDataset))}),$(window).on("paste",function(t){var e=$(":focus");if((e.get(0)===s.get(0)||!e.is(":text")&&!e.is("textarea"))&&s.is(":visible")&&c._mapReadyForPaste){t.returnValue=!1,t.preventDefault(),c._displayMap(),s.css("border",""),c.setObservableProperty("datasetIsValid",!1);e=t.originalEvent.clipboardData?t.originalEvent.clipboardData.getData("text/plain"):window.clipboardData.getData("Text"),t=c._onDatasetPaste(e),e=t.msg;if(c.setObservableProperty("selectedDelimDec",t.delimDec),(i=h.importedDataset).isValid()){c.setObservableProperty("datasetIsValid",!0),c._importingData=!0;t=i.parsePastedData({delimDec:c._viewData.selectedDelimDec,epsg:c.map.getEpsg(),map:c.map});if("ko"==t.status)return s.css("border","2px solid red"),void s.val(c.gclg.getString("ERROR")+c.gclg.getString("P2B")+" "+t.errMsg);c.setObservableProperty("importReport",h.importedDataset.getImportReport()),c.setObservableProperty("importReportShort",h.importedDataset.getImportReportShort());h.importedDataset.loadInMap(c.map);c.setObservableProperty("datasetIsValid",!1);t=h.importedDataset.getNumericFields(),t=($("#imd_add_indic",c._$renderedContent).parent().css("display",1<t.length?"block":"none"),GCO5.model.indics.Dataset.getDatasetListByCat());c.setObservableArray("dtslist_a",t),c.setObservableProperties({selectedImport:"*",selectedDts:h.importedDataset.getPk()},{noTrigger:!0}),$.observable(h.import_a[h.import_a.length-1]).setProperty("visible",!0),h.dtsExtent=h.importedDataset.id_extent,GCO5.core.GcDelayUtil.callLater(function(){c.setObservableArray("dtsNivgeos",h.importedDataset.getUsableNivgeos())},[],10,c),c.setObservableProperty("importedDataset",h.importedDataset,{forceTrigger:!0}),e=""}else s.css("border","2px solid red");c.setObservableProperties({libDataset:i.getName(),pastedText:e})}}),$.observe(h,"selectedImport",function(t,e){var i,n=e.value;h.noTrigger||(c._displayMap(),i=2,"*"!=e.oldValue&&0<h.selectedIndics_a.length&&(i=50),"tjs"==n.substr(0,3)&&0<h.tjs_a.length&&(e=(e=h.selectedTjsSrv)||h.tjs_a[0].c_id_tjs,GCO5.core.GcDelayUtil.callLater(c.setObservableProperty,["selectedTjsSrv",e,{forceTrigger:!0}],i,c)),"*"!=n&&(h.selectedTjsSrv0?h.selectedTjsSrv0=null:(c.setObservableProperty("selectedTjsSrv","",{noTrigger:!0}),c.setObservableProperty("selectedTheme","",{noTrigger:!0}),c.setObservableProperty("selectedIndicTJS","",{noTrigger:!0})),GCO5.core.GcDelayUtil.callLater(function(){c.setObservableProperty("importedDataset",null),c._viewData.selectedDts=c._viewData.dtsExtent=null,c.setObservableProperty("pastedText",""),c.setObservableArray("dtsNivgeos",[]),c.setObservableProperty("selectedDts","*"),c._removeAllIndics(),c.alignFormLabels(".labelgroup")},[],20,c)))}),$.observe(h,"selectedTjsSrv",function(t,e){var i=e.value;h.noTrigger||(c._displayMap(),"*"!=i&&(c.setObservableArray("tjsThemes_a",[]),c.setObservableArray("tjsIndics_a",[]),GCO5.core.GcDelayUtil.callLater(function(){GCO5.appModel.getTJSThemes(c._onGetTJSThemes,c,i)},[],20,c)),h.selectedTree="*"!=i?"T01":"")}),$.observe(h,"selectedIndicTJS",function(t,e){var i,e=e.value;h.noTrigger||""==e||(e=GCO5.core.GcArrayUtil.getSubArray(h.tjsIndics_a,{pk:[e]})[0],e=GCO5.core.GcObjectUtil.cloneJson(e),i=new GCO5.model.indics.IndicModel(e),c.setObservableArray("dtsNivgeos",e.nivgeos),i.setTJSServer(h.selectedTjsSrv),$(c).triggerHandler(r.CHANGE_INDIC,[!0,i]),c._syncUIAfterPickIndic(i,e))}),$.observe(h,"selectedDts",function(t,e){var i,e=e.value;h.noTrigger||(i=c._removeAllIndics(),"*"==e?c.setObservableProperty("importedDataset",null):(GCO5.core.GcDelayUtil.callLater(function(){c.setObservableProperty("selectedImport","*")},[],2),c._displayMap(),c.setObservableProperty("importedDataset",GCO5.model.indics.Dataset.getDataset(e)),e=h.importedDataset.getNumericFields(),$("#imd_add_indic",c._$renderedContent).parent().css("display",1<e.length?"block":"none"),GCO5.core.GcDelayUtil.callLater(function(){c._changingDataset=!0,h.selectedExtent=GCO5.appModel.getInfo("infoFromMapName",[h.importedDataset.mapName,"c_id_extent"]),h.selectedView=h.importedDataset.mapName,h.dtsExtent=h.importedDataset.id_extent,GCO5.core.GcDelayUtil.callLater(function(){c.setObservableProperty("selectedView",h.importedDataset.mapName,{forceTrigger:!0})},[],2)},[],i?30:0,h.importedDataset)))}),$.observe(h,"selectedView",function(t,e){var i;h.noTrigger||(e=e.value,i=h.mapIndicModels||(c.map?c.map.getEnabledIndicsModelsIndexed():null),c.setObservableProperties({datasetIsValid:!1,pastedText:""}),s.css("border",""),c.map&&"imp"==h.selectedImport&&!c._changingDataset&&(n=c.map._changingViewKeepExtent?c.map.getMapExtent().rect:c.map.beforeChangeView(e).extent),c._mapReadyForPaste=!1,$(c).triggerHandler(r.CHANGE_MAPVIEW,[e,n,i,h.importedDataset]))}),$.observe(h,"selectedImportedTable",$.proxy(this._setGeocodFilter,this)),$.observe(h,"selectedDtsSerie",$.proxy(this._onImportedDtsSerieChange,this)),$("#imd_add_indic",this._$renderedContent).on("click keydown",function(t){var e=t.keyCode||t.which;if("keydown"!=t.type||"13"==e){var i,n=new GCO5.view.component.MapImportIndicPanel,r=c.map.getEnabledIndicsModelsIndexed(),a=h.importedDataset,s=5,o=0,l=[];for(i in r)l.push(r[i]);for(i in l)GCO5.core.GcDelayUtil.callLater(function(){var t=l.pop();c.map.setThemeVisibility(t,!1),c._syncSelectedIndicCheckbox(t.getPkF1(),!1)},[],s+=30*o++);return GCO5.core.GcDelayUtil.callLater(function(){GCO5.core.GcComponentUtil.displaySlidingPanel(t.target),n.setup({action:"NEW",categ:"panel",container:$(".cd-panel-content"),map:c.map,index:h.selectedIndics_a.length,ca:c,dts:a})},[],s+25,c),!1}}),$(".indic-basket",this._$renderedContent).on("click keydown",".removeItem",function(t){var e=t.keyCode||t.which;if("keydown"!=t.type||"13"==e)return a=$(this).closest("li").data("pk"),$.view(this).index,c._updateSelectedIndicsList("remove",h.selectedIndicModels_o[a]),t=c.map.getIndicsModelsIndexed(),c.map.removeTheme(t[a]),0==a.indexOf("_import")&&GCO5.model.indics.Dataset.getDataset(t[a].getProp("idDataset")).deleteMapIndicModel(t[a]),$.observable(h).setProperty("selectedIndic",""),!1}).on("click keydown",".edit",function(t){var e,i,n,r=t.keyCode||t.which;if("keydown"!=t.type||"13"==r)return e=new GCO5.view.component.MapImportIndicPanel,a=$(this).closest("li").data("pk"),i=$.view(this).index,GCO5.core.GcComponentUtil.displaySlidingPanel(t.target),c.displayThisMapindicOnly(a),n=c.map.getIndicsModelsIndexed(),GCO5.core.GcDelayUtil.callLater(function(){e.setup({action:"NEW",categ:"panel",container:$(".cd-panel-content"),map:c.map,index:i,ca:c,mapIndicModel:n[a],dts:h.importedDataset})},[],10,c),!1}),$("#im_map",this._$renderedContent).closest("ul").on("click keydown",".tabs__link",function(t,e){"keydown"==t.type&&13!=t.keyCode||("im_map"!=t.target.id||e&&e.noResize||GCO5.core.GcDelayUtil.callLater(c.onResize,[],1,c),$(t.target).closest(".js-tablist").find("a").removeClass("highlighted"),$(t.target).addClass("highlighted"),c.setObservableProperty("selectedRestit",t.target.id.substr(3,1)),"im_table"!=t.target.id&&c.tableView&&GCO5.core.GcDelayUtil.callLater(c.tableView.clear,[],10,c.tableView))}),$("#im_table",this._$renderedContent).on("click",function(t){"m"==h.selectedRestit&&GCO5.core.GcDelayUtil.callLater(c._displayTableView,[],2,c)}),$.observe(h,"selectedRestit",function(t,e){var i=$(".indic-basket .indVisi",c._$renderedContent);"t"==e.value?i.attr("disabled","disabled"):i.removeAttr("disabled")}),this.addMixinListeners(),$("#im-prolonger",this._$renderedContent).on("click","a",function(t){$(GCO5.topApp).triggerHandler(GCO5.view.component.AComponent.LOAD_COMPONENT,{id:$(this).data("cu"),categ:"main"})}),$("#im-modele",this._$renderedContent).on("click",function(t){c._modele_xslx()})},_displayMap:function(){"m"!=this._viewData.selectedRestit&&$("#im_map",this._$renderedContent).trigger("click",{noResize:!0})},_onImportedDtsSerieChange:function(){var t=this._viewData,e=this.tableView;if(!t.noTrigger){var i,n,r=t.selectedDtsSerie,a=t.importedDataset.mapIndicModels;for(n in a)(i=a[n]).setSerie(r),i.isEnabled()&&$(this.map).trigger(GCO5.view.component.MapView.UPD_SERIE,{serie:r,mapIndicModel:i});e.setRef()}},_setGeocodFilter:function(){var t,e,i=this._viewData;i.noTrigger||(e=i.selectedImportedTable,i=i.importedDataset,t=this.tableView,"ng"==e?(e=i.columns_a.map(function(t,e){return{id:t.pk,lib:0==e?"Code":t.pk}}),i=t.buildDatasetFromDp(i.getNonGeocodRows(),e),t.clear(),GCO5.core.GcDelayUtil.callLater(t.callDataTableFromFreeDataset,[i,e],5,t)):GCO5.core.GcDelayUtil.callLater(t.setRef,[],5,t))},_initTableView:function(t){this.tableView||(this.tableView=new GCO5.view.component.TableView({map:this.map,ca:this,noRender:t.noRender}))},_displayTableView:function(){var t,e=this.tableView,i=this,n=this._viewData.importedDataset,r=[];if(n&&((t=n.getTemporalAxis())?(this.setObservableArray("serie_a",t.values.concat().sort().reverse()),this.setObservableProperty("selectedDtsSerie",n.getSerie(),{noTrigger:!0})):this.setObservableArray("serie_a",[]),this.setObservableProperty("selectedImportedTable","mp",{noTrigger:!0}),this.setObservableProperty("nbNonGeocod",n.getNonGeocodRows().length),this.setObservableProperty("nbGeocod",n.getInitialData().length)),!e)return i.gcsm.freeze("tables_m"),void require(["tables_m"],function(t){i.gcsm.unFreeze("tables_m"),t.initialize(),i._initTableView({noRender:0<r.length}),0<r.length&&i._displayTableView()});GCO5.core.GcDelayUtil.callLater(function(){e.syncWithMap(i.map.getIndicsModelsIndexed())},[],10,e)},onSaveIndicsDef:function(t){var e,i=t.mapIndicModel,n=this._viewData.importedDataset,r=(this._viewData.selectedIndics_a.length==t.indicIndex?(e=!0,r={pk:i.getPk(),c_id_dataset:i.getProp("idDataset"),idDataset:i.getProp("idDataset"),idIndicateur:i.getProp("idIndicateur"),shortLibIndic:i.getProp("shortLibIndic"),libIndic:i.getProp("libIndic"),c_desc_indicateur:i.getProp("descIndicateur"),series:i.getProp("series"),c_id_typind:i.getProp("type"),c_topo:n.topology,nivgeos:i.getProp("nivgeos"),c_id_views:i.getProp("views"),scat:i.getMappingSuperCategory()},this._syncUIAfterPickIndic(i.getIndicModel(),r),this.tableView&&this._tableViewActive()&&GCO5.core.GcDelayUtil.callLater(this.tableView.syncWithMap,[this.map.getIndicsModelsIndexed()],10,this.tableView)):r=GCO5.core.GcArrayUtil.getSubArray(this._viewData.selectedIndics_a,{pk:t.mapIndicModel.getPk()})[0],r.c_id_views=i.getProp("views"),r.nivgeos=i.getProp("nivgeos"),$.observable(r).setProperty("shortLibIndic",t.shortLibIndic),$.observable(r).setProperty("libIndic",t.shortLibIndic),$.observable(this._viewData).setProperty("libDataset",t.libDataset),n.getNumericFields());$("#imd_add_indic",this._$renderedContent).parent().css("display",1<r.length?"block":"none"),this._viewData.importedDataset.getUsableNivgeos().length>this._viewData.dtsNivgeos.length&&this.setObservableArray("dtsNivgeos",this._viewData.importedDataset.getUsableNivgeos()),e||this._updateSelectedIndicsList("update",i.getIndicModel())},_removeAllIndics:function(){return 0!=GCO5.core.GcObjectUtil.count(this._viewData.selectedIndicModels_o)&&($.observable(this._viewData.selectedIndics_a).refresh([]),this._viewData.selectedIndicModels_o={},this.map.removeAllThemes(),this.tableView&&this.tableView.removeIndicModel(),!0)},_loadIndicsFromCurrentDataset:function(){var t,e=this._viewData.importedDataset.getIndics();for(t in e){var i=e[t],n={pk:i.getPk(),c_id_dataset:i.getProp("idDataset"),idDataset:i.getProp("idDataset"),idIndicateur:i.getProp("idIndicateur"),shortLibIndic:i.getProp("shortLibIndic"),libIndic:i.getProp("libIndic"),c_desc_indicateur:i.getProp("descIndicateur"),series:i.getProp("series"),nivgeos:i.getProp("nivgeos"),c_id_views:i.getProp("views"),c_id_typind:i.getProp("type"),c_topo:this._viewData.importedDataset.topology,scat:i.getMappingSuperCategory()};this._syncUIAfterPickIndic(i.getIndicModel(),n),this.tableView&&this._tableViewActive()&&GCO5.core.GcDelayUtil.callLater(this.tableView.syncWithMap,[this.map.getIndicsModelsIndexed()],10,this.tableView)}},_addMapListeners:function(){var i=this;this.addMixinMapListeners(),$(this.map).on(GCO5.model.indics.DatasetImported.BEFORE_ADD_INDICS,function(t,e){i._loadIndicsFromCurrentDataset()})},_onEndRenderMap:function(){var t=this;this.gcsm.unFreeze("render"),this.gcsm.unFreeze("initialRender"),this._changingDataset?(this._changingDataset=!1,GCO5.core.GcDelayUtil.callLater(function(){t._viewData.importedDataset.reloadThemes(t.map),t.setObservableArray("dtsNivgeos",t._viewData.importedDataset.getUsableNivgeos())},[],5,t)):t._viewData.importedDataset&&t._importingData&&(GCO5.core.GcDelayUtil.callLater(function(){t._viewData.importedDataset.zoomOnCurrentIdsWithValues(t.map)},[],25,t),t._importingData=!1),t._mapReadyForPaste=!0,this._updateHashAfterRenderMap()},onHashChange:function(t){},_updateHashAfterRenderMap:function(){var t,e;this.gcsm.historyBrowsing||this.gcsm.getPrintMode()||(t=$.bbq.getState(),e={c:"externaldata"},"tjssrv"==this._viewData.selectedImport?(e.tjs=this._viewData.selectedTjsSrv,e.i=this._viewData.selectedIndicTJS,e.view=this.map.getName()):(delete e.tjs,delete e.i,delete e.view),GCO5.core.GcObjectUtil.equal(e,t)||$.bbq.pushState(e,2))},_modele_xslx:function(){var e=this;if(!window.XLSX)return this.gcsm.freeze("XLSX"),void require(["zip_m"],function(t){require(["xlsx_m"],function(t){e._modele_xslx(),e.gcsm.unFreeze("XLSX")})});var t="xy"==this._viewData.selectedImport,i=[{wch:40},{wch:8},{wch:40}],t=(t&&(i=[{wch:6},{wch:6},{wch:6},{wch:40},{wch:40}]),t?this._prepareModelXYForXls():e._prepareModelForXls()),n={SheetNames:[],Sheets:{}};n.SheetNames.push("Data"),(n.Sheets.Data=t)["!cols"]=i,GCO5.core.GcXlsUtil.saveXlsFile(n,"import_model.xlsx")},_prepareModelXYForXls:function(){var t={},e={s:{c:0,r:0},e:{c:0,r:0}};for(n in r=["X","Y",this.gclg.getString("CODE"),this.gclg.getString("LABEL"),this.gclg.getString("YOUR_INDICS","pilotage","externaldata")])e.e.c=n,t[a=XLSX.utils.encode_cell({c:n,r:0})]={v:r[n],t:"s",s:GCO5.core.GcXlsUtil.xlsBoldFormat};for(var i=0;i<1;i++){var n,r=[-1.104716,45.822608,"02820A","Bureau de poste Marennes"];for(n in 0==i&&r.push(this.gclg.getString("YOUR_DATA","pilotage","externaldata")+"..."),r){e.e.r<i&&(e.e.r=i+1),e.e.c<n&&(e.e.c=n);var a,s={v:r[n]};null!=s.v&&(a=XLSX.utils.encode_cell({c:n,r:i+1}),"number"==typeof s.v?s.t="n":"boolean"==typeof s.v?s.t="b":s.t="s",t[a]=s)}}return e.e.r++,t["!ref"]=XLSX.utils.encode_range(e),t},_prepareModelForXls:function(){var t=this.map.getName(),e=GCO5.appModel.getInfo("infoFromMapName",[t,"nivgeo"])||GCO5.appModel.getInfo("infoFromMapName",[t,"id_nivgeo"]),i=GCO5.appModel.getInfo("infoFromMapName",[t,"id_extent"]),n={},r=XLSX.utils.encode_cell({c:0,r:0}),t=(t=GCO5.appModel.getInfo("infoFromMapName",[t,"c_lib_view"]))?t.split("|").join(" "):"",a=(n[r]={v:t,t:"s",s:GCO5.core.GcXlsUtil.xlsBoldFormat},n[r=XLSX.utils.encode_cell({c:1,r:1})]={v:this.gclg.getString("COPY_FROM_CODES","pilotage","externaldata"),t:"s",s:GCO5.core.GcXlsUtil.xlsItalicFormat},GCO5.appModel.getRefData(e,i)),s=[this.gclg.getString("LABEL"),this.gclg.getString("CODE"),this.gclg.getString("YOUR_INDICS","pilotage","externaldata")];for(c in s)n[r=XLSX.utils.encode_cell({c:c,r:2})]={v:s[c],t:"s",s:GCO5.core.GcXlsUtil.xlsBoldFormat};for(var o=Math.min(a.codgeo.length,1e5),t=o+3,l=0;l<o;l++){var c,h=[a.libgeo[l],a.codgeo[l]];for(c in 0===l&&h.push(this.gclg.getString("YOUR_DATA","pilotage","externaldata")+"..."),h){var d={v:h[c]};null!=d.v&&(r=XLSX.utils.encode_cell({c:c,r:l+3}),"number"==typeof d.v?d.t="n":"boolean"==typeof d.v?d.t="b":d.t="s",n[r]=d)}}return n["!ref"]=XLSX.utils.encode_range({s:{c:0,r:0},e:{c:s.length,r:t-1}}),n},xlsx:function(t,e){function i(t){return d.gclg.getString(t,"pilotage","externaldata")}var n,r=this.tableView,a=this._viewData.selectedImportedTable,s=this._viewData.importedDataset,o=(r=this.tableView).getData(),l=[],c=GCO5.appModel.getInfo("infoFromMapName",[this.map.getName(),"c_lib_view"]),c=(l.push(GCO5.appModel.getLegal("tit_nav")),l.push(this.gclg.getString("REFGEO")+this.gclg.getString("P2B")+" "+c.replace("|"," ")),("ng"==a?["Code"]:["Code","Libellé"]).concat(r.mapDataset.getLibIndics())),r="tjssrv"==this._viewData.selectedImport?this._viewData.selectedTjsSrv:null,r=(!r||(r=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("tjs"),{c_id_tjs:r}))&&1==r.length&&(n=r[0].c_tjs.indexOf("GC_tjs.php")<0?null:r[0].c_tjs.split("GC_tjs.php")[0]),[{wch:6},{wch:40},{wch:20},{wch:20},{wch:20},{wch:20},{wch:20}]),s=s?s.getSerie():"",h=s?" "+this.gclg.getString("FOR")+" "+s:"",d=this,h=("ng"==a?(r[1].wch=20,l.push(i("DATA_NON_GEOCOD")+" ("+this.gclg.formatNumber(o.length,0,!0)+" "+i("ROWS_NON_GEOCOD")+")")):"mp"==a&&(c.splice(1,0,d.gclg.getString("LABEL")),l.push(i("GEOCODING_RESULT")+" ("+this.gclg.formatNumber(o.length,0,!0)+" "+i("ROWS_GEOCODED").toLowerCase()+h+")"),s&&l.push(this.gclg.getString("PERIOD","indics")+this.gclg.getString("P2B")+" "+s)),n&&l.push("Origine TJS",n),GCO5.core.GcXlsUtil.writeDatasetToSheet(o,c,l,"ng"==a)),u={SheetNames:[],Sheets:{}};u.SheetNames.push("Data"),(u.Sheets.Data=h)["!cols"]=r,GCO5.core.GcDelayUtil.callLater(function(){GCO5.core.GcXlsUtil.saveXlsFile(u,"data."+t,t),$(".msg",e._$container).text("")},[],10,this)}}),puremvc.define({name:"GCO5.view.mediator.ExternaldataMediator",parent:puremvc.Mediator},{gcsm:null,initComponent:function(t){GCO5.core.GcComponentUtil.setupAndShowComponent(this.viewComponent,t),this.gcsm=GCO5.core.SystemManager.getInstance()},onRegister:function(){var t=new GCO5.view.component.ExternaldataComponent;this.setViewComponent(t),this.addListeners(t)},listNotificationInterests:function(){return[GCO5.AppConstants.INIT_COMPONENT,GCO5.AppConstants.ON_RESIZE]},handleNotification:function(t){var e=t.getName(),i=t.getBody(),n=this.viewComponent;switch(e){case GCO5.AppConstants.INIT_COMPONENT:"externaldata"==i.id&&this.initComponent(i);break;case GCO5.AppConstants.ON_RESIZE:n.isVisible()&&n.onResize()}},addListeners:function(a){var r=this,t=a.constructor;$(a).on(t.CHANGE_MAPVIEW,function(t,e,i,n,r){r&&r.isValid()?r.prepareBeforeNewMap(a.setupMap,a,e,n,i):GCO5.appModel.loadMapViewModel(a.setupMap,a,e,i,n)}),$(a).on(GCO5.view.component.MapView.INFOSEL,function(t,e){GCO5.appModel.loadInfosel(e,a.map.onLoadInfosel,a.map)}),$(a).on(GCO5.view.component.MapView.REPROJ,function(t,e){GCO5.model.maps.AProj4||(r.gcsm.freeze("proj4"),require(["proj4_m"],function(t){r.gcsm.unFreeze("proj4"),t.initialize(e.ca,e.callback)}))}),$(a).on(t.CHANGE_INDIC,function(t,e,i){var i=i.isIndicModel?i:new GCO5.model.indics.IndicModel(GCO5.core.GcObjectUtil.cloneJson(i)),n=a.getActiveMap();GCO5.appModel.loadMapIndic(r._onLoadIndicData,r,i,n)})},_onLoadIndicData:function(t,e,i){var n,r,a,s,o,l,c,h=this.viewComponent,d=this,u=h.getActiveMap();e&&t.isIndicModel?(n=GCO5.appModel.getConcept("view"),(c=this.gcsm.getCuState("extent")||GCO5.appModel.getInfo("infoFromMapName",[u.getName(),"id_extent"]))&&(r=GCO5.appModel.getConcept("nivgeo_o"),a=GCO5.appModel.getConcept("view_o"),l=GCO5.core.GcArrayUtil.getSubArray(n,{id_extent:c}),0<(s=GCO5.core.GcArrayUtil.intersection(e,GCO5.core.GcArrayUtil.getColumnByKey(l,"c_id_view"))).length&&(o=(s=s.sort(function(t,e){return t=a[t].c_id_nivgeo,e=a[e].c_id_nivgeo,r[t].c_nivgeos_sup&&0<=r[t].c_nivgeos_sup.indexOf(e)?-1:r[e].c_nivgeos_sup&&0<=r[e].c_nivgeos_sup.indexOf(t)?1:0}))[0])),o||(l=null,GCO5.appModel.getOption("default_view")?l=GCO5.core.GcArrayUtil.getSubArray(n,{pk:GCO5.appModel.getOption("default_view")}):GCO5.appModel.getOption("default_extent")&&(l=GCO5.core.GcArrayUtil.getSubArray(n,{id_extent:GCO5.appModel.getOption("default_extent")})),l&&0<(s=GCO5.core.GcArrayUtil.intersection(e,GCO5.core.GcArrayUtil.getColumnByKey(l,"c_id_view"))).length&&(o=s[0])),o=o||e[0],c=u.getNewMapIndicsInfoAfter(t,"add"),u.isReprojected()&&(u.restoreProjInit(!0),u.updateGlobe(null,null,null,null,!0)),1==GCO5.core.GcObjectUtil.count(c.indicsModelRetained)&&(t=GCO5.core.GcObjectUtil.getFirstVal(c.indicsModelRetained)),GCO5.appModel.loadMapViewModel(function(t){d.onChangeMapView(t)},this,o,null,c.indicsModelRetained,null,!1)):h.onLoadIndicTJSData(t)},onChangeMapView:function(t){var e=this.viewComponent;GCO5.core.GcDelayUtil.callLater(e.setupMap,[t],1,e)}},{NAME:"ExternaldataMediator"}),GCO5.view.component.ArticleComponent=GCO5.view.component.AComponent.extend({statics:{NAME:"GCO5.view.component.ArticleComponent"},_prepareViewData:function(t){t.cp="article",this._viewData=t},goToMainContent:function(){$(".article",this._$renderedContent).focus()},_onAddedToStage:function(t){this._super(t),$("body").addClass("textComponent"),this.cli.clearHash(),this._updateHashAfterRenderArticle()},onResize:function(){var t;this._resizing||(t=$(".article",this._$renderedContent)).height(t[0].scrollHeight)},_addListeners:function(){var e=this;$(this._$renderedContent).scroll(function(t){$(this).is(":visible")&&e.onResize()}),window.Cookiebot&&$("a.cookiebot-renew",this._$renderedContent).attr("href","javascript:Cookiebot.renew()")},_updateHashAfterRenderArticle:function(){if(!this.gcsm.historyBrowsing){var t,e=$.bbq.getState(),i={};for(t in e)i[t]=e[t];i.page=this._viewData.c_id_page,GCO5.core.GcObjectUtil.equal(i,e)||$.bbq.pushState(i,2)}},onHashChange:function(t){t.page&&this._super()}}),puremvc.define({name:"GCO5.view.mediator.ArticleMediator",parent:puremvc.Mediator},{initComponent:function(t){GCO5.appModel.getPageContent(this._onPageContentLoaded,this,"A",t)},_onPageContentLoaded:function(t,e){e=e?GCO5.core.GcArrayUtil.getSubArray(t.page,{c_id_page:e}):t;GCO5.core.GcComponentUtil.setupAndShowComponent(this.viewComponent,e[0])},onRegister:function(){var t=new GCO5.view.component.ArticleComponent;this.setViewComponent(t),this.addListeners(t)},listNotificationInterests:function(){return[GCO5.AppConstants.INIT_COMPONENT,GCO5.AppConstants.ON_RESIZE]},handleNotification:function(t){var e=t.getName(),i=t.getBody(),n=this.viewComponent;switch(e){case GCO5.AppConstants.INIT_COMPONENT:"article"==i.id&&this.initComponent(i.id_page);break;case GCO5.AppConstants.ON_RESIZE:n.onResize(i)}},addListeners:function(t){}},{NAME:"ArticleMediator"}),GCO5.view.component.ContactComponent=GCO5.view.component.AComponent.extend({statics:{NAME:"GCO5.view.component.ContactComponent"},goToMainContent:function(){},_prepareViewData:function(t){t.cp="contact",this._viewData=t,this._viewData.GAisAuthorized=void 0!==window.gtag&&1==this.cli.getCookie("ga_accepted"),this._viewData.MAisAuthorized=void 0!==window._paq,this._viewData.ATisAuthorized=void 0!==window._AT_tag,this._viewData.hasGA=!GCO5.core.GcStringUtil.isEmpty(window.GCO5.initInfo.GA_KEY)&&void 0===Window.Cookiebot,this._viewData.hasMA=!GCO5.core.GcStringUtil.isEmpty(window.GCO5.initInfo.PIWIK_KEY),this._viewData.hasAT=!GCO5.core.GcStringUtil.isEmpty(window.GCO5.initInfo.AT_KEY),this._viewData.hasCK=void 0!==window.Cookiebot,this._viewData.hasGA&&null==this.cli.getCookie("ga_accepted")&&this.cli.setCookie("ga_accepted",0,GCO5.core.ClientInfo.EXPIRE_CONSENT_COOKIE),this._viewData.rtl="rtl"===this.gclg.getTextDirection()},onResize:function(){var t;this._resizing||(t=$(".article",this._$renderedContent)).height(t[0].scrollHeight-parseFloat(t.css("padding-bottom")))},addListeners:function(){var i=this;$(this._$renderedContent).scroll(function(t){$(this).is(":visible")&&i.onResize()}),$.observe(this._viewData,"GAisAuthorized",function(t,e){e=e.value;i.cli.setCookie("cookie_optin",+e,GCO5.core.ClientInfo.EXPIRE_CONSENT_COOKIE),e?window.accepteGA&&window.accepteGA():window.refuseGA&&window.refuseGA(),i.cli.hideCookieContainer()}),$.observe(this._viewData,"MAisAuthorized",function(t,e){e=e.value;i.cli.setCookie("cookie_optin",+e,GCO5.core.ClientInfo.EXPIRE_CONSENT_COOKIE),e?i.cli.setCookie("ma_accepted",1,GCO5.core.ClientInfo.EXPIRE_CONSENT_COOKIE):i.cli.setCookie("ma_accepted",0),i.cli.hideCookieContainer()}),$.observe(this._viewData,"ATisAuthorized",function(t,e){e=e.value;i.cli.setCookie("cookie_optin",+e,GCO5.core.ClientInfo.EXPIRE_CONSENT_COOKIE),e?i.cli.setCookie("at_accepted",1,GCO5.core.ClientInfo.EXPIRE_CONSENT_COOKIE):i.cli.setCookie("at_accepted",0),i.cli.hideCookieContainer()})},_onAddedToStage:function(e){this._super(e),window.scrollTo(0,0),this.onResize(),$("body").addClass("textComponent");var t=$("<div class='mts mbl'></div>").appendTo($(".body-article",this._$renderedContent)),i=($.render.ContactCookie.link(t,this._viewData),this);GCO5.core.GcDelayUtil.callLater(function(){var t=$("#"+e.section,i._$renderedContent).offset();t&&this._$renderedContent.scrollTop(t.top-this._$renderedContent.offset().top)},[],2,this),this.addListeners()},onHashChange:function(t){t.page&&this._super()}}),puremvc.define({name:"GCO5.view.mediator.ContactMediator",parent:puremvc.Mediator},{initComponent:function(t){GCO5.appModel.getPageContent(this._onPageContentLoaded,this,"C",t.id_page,t)},_onPageContentLoaded:function(t,e){t.page[0].section=e,GCO5.core.GcComponentUtil.setupAndShowComponent(this.viewComponent,t.page[0])},onRegister:function(){var t=new GCO5.view.component.ContactComponent;this.setViewComponent(t),this.addListeners(t)},listNotificationInterests:function(){return[GCO5.AppConstants.INIT_COMPONENT,GCO5.AppConstants.ON_RESIZE]},handleNotification:function(t){var e=t.getName(),i=t.getBody(),n=this.viewComponent;switch(e){case GCO5.AppConstants.INIT_COMPONENT:"contact"==i.id&&this.initComponent(i);break;case GCO5.AppConstants.ON_RESIZE:n.onResize(i)}},addListeners:function(t){}},{NAME:"ContactMediator"}),GCO5.view.component.HelpComponent=GCO5.view.component.AComponent.extend({statics:{NAME:"GCO5.view.component.HelpComponent"},_prepareViewData:function(t){t.cp="help",this._viewData=t},goToMainContent:function(){$(".article",this._$renderedContent).focus()},_onAddedToStage:function(t){this._super(t),$("body").addClass("textComponent"),this.cli.clearHash()},onResize:function(){var t;this._resizing||(t=$(".article",this._$renderedContent)).height(t[0].scrollHeight)},_addListeners:function(){var e=this;$(this._$renderedContent).scroll(function(t){$(this).is(":visible")&&e.onResize()})},onHashChange:function(t){t.page&&this._super()}}),puremvc.define({name:"GCO5.view.mediator.HelpMediator",parent:puremvc.Mediator},{initComponent:function(t){GCO5.appModel.getPageContent(this._onPageContentLoaded,this,"H")},_onPageContentLoaded:function(t){GCO5.core.GcComponentUtil.setupAndShowComponent(this.viewComponent,t.page[0])},onRegister:function(){var t=new GCO5.view.component.HelpComponent;this.setViewComponent(t),this.addListeners(t)},listNotificationInterests:function(){return[GCO5.AppConstants.INIT_COMPONENT,GCO5.AppConstants.ON_RESIZE]},handleNotification:function(t){var e=t.getName(),i=t.getBody(),n=this.viewComponent;switch(e){case GCO5.AppConstants.INIT_COMPONENT:"help"==i.id&&this.initComponent(i);break;case GCO5.AppConstants.ON_RESIZE:n.onResize(i)}},addListeners:function(t){}},{NAME:"HelpMediator"}),GCO5.view.component.NewsComponent=GCO5.view.component.AComponent.extend({statics:{NAME:"GCO5.view.component.NewsComponent"},goToMainContent:function(){$(".news ul li:first-of-type",this._$renderedContent).focus()},_prepareViewData:function(t){var e=this,t=t.news.concat().reverse(),i=GCO5.appModel.getInitKey("dataset_o");t.forEach(function(t){t.themes&&(t.libthemes=e._getLibThemes(t.themes).join(", ")),t.c_id_dataset&&i[t.c_id_dataset].series&&(t.series=i[t.c_id_dataset].series.concat().reverse().join(", ")),t.nivgeos&&(t.libnivgeos=t.nivgeos.map(function(t){return GCO5.appModel.getInfo("libNivgeo",[t])}).reverse().join(", ")),t.date=t.c_date_news.split("-").reverse().join("/")}),this._viewData={cp:"news",news:t}},_getLibThemes:function(t){var e=GCO5.appModel.getInitKey("theme_o");return t.map(function(t){return e[t]?e[t].label:null}).filter(function(t){return!!t})},_onAddedToStage:function(t){this._super(t),$("body").addClass("textComponent"),t.id_new&&(t=$("[data-new='"+t.id_new+"']",this._$renderedContent).offset())&&this._$renderedContent.scrollTop(t.top-this._$renderedContent.offset().top),this.cli.clearHash()},onHashChange:function(t){t.page&&this._super()},onResize:function(t,e){var i;this._resizing||(i=$(".article",this._$renderedContent)).height(i[0].scrollHeight)},_addListeners:function(){var n=this;$(this._$renderedContent).scroll(function(t){$(this).is(":visible")&&n.onResize()}),$(".indic",this._$renderedContent).on("click keydown",function(t){var e,i=t.keyCode||t.which;"keydown"==t.type&&"13"!=i&&"32"!=i||(t=$(this).data("pk"),i=$(this).data("view"),e={id:"indicator",categ:"main",from:"home"},GCO5.core.GcStringUtil.isEmpty(i)||(e.mapName=i),t&&(i=t.split("."),e.indicModel=new GCO5.model.indics.IndicModel({c_id_dataset:i[0],c_id_indicateur:i[1]})),GCO5.core.GcDelayUtil.callLater(function(){$(GCO5.topApp).triggerHandler(GCO5.view.component.AComponent.LOAD_COMPONENT,e)},[],1,n))})}}),puremvc.define({name:"GCO5.view.mediator.NewsMediator",parent:puremvc.Mediator},{initComponent:function(t){GCO5.appModel.getPageContent(this._onPageContentLoaded,this,"N",null,t)},_onPageContentLoaded:function(t,e,i){t.action=i.action,t.id_new=i.id_new,GCO5.core.GcComponentUtil.setupAndShowComponent(this.viewComponent,t)},onRegister:function(){var t=new GCO5.view.component.NewsComponent;this.setViewComponent(t),this.addListeners(t)},listNotificationInterests:function(){return[GCO5.AppConstants.INIT_COMPONENT,GCO5.AppConstants.ON_RESIZE]},handleNotification:function(t){var e=t.getName(),i=t.getBody(),n=this.viewComponent;switch(e){case GCO5.AppConstants.INIT_COMPONENT:"news"==i.id&&this.initComponent(i);break;case GCO5.AppConstants.ON_RESIZE:n.onResize(i)}},addListeners:function(t){}},{NAME:"NewsMediator"}),GCO5.view.component.ResetpasswordComponent=GCO5.view.component.AComponent.extend({statics:{NAME:"GCO5.view.component.ResetpasswordComponent"},_prepareViewData:function(t){t.cp="resetpassword";var e=this;this._viewData=t,this._viewData.token=$.bbq.getState("token"),this._viewData.email="",this._viewData.password="",this._viewData.password2="",this._viewData.msg="",this._viewData.resetIsSuccess=!1,this._viewData.errorEmail=!1,this._viewData.errorWeakPwd=!1,this._viewData.errorWrongPwd=!1,this._viewData.isFormComplete=!1,this._viewData.sendNewPassword=function(){e.checkForm(),e.isFormComplete(e._viewData)&&GCO5.appModel.sendNewPassword(e.onSendNewPassword,e,{email:this.email,password:this.password,token:this.token})},this._viewData.hasToken=function(){return this.token&&1<this.token.length}},onSendNewPassword:function(t){!0===t.content.success?this.setObservableProperty("resetIsSuccess",!0):this.setObservableProperty("msg",this.gclg.getString("RESET_SECURITY_MAIL","login"))},verifyEmail:function(){var t=!1;return 0!==this._viewData.email.length&&/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/.test(this._viewData.email)||(t=!0),this.setObservableProperty("errorEmail",t),t},verifyPassword:function(){var t=new RegExp("^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*[^a-zA-Z0-9]).{12,}$");return 0!==this._viewData.password.length&&t.test(this._viewData.password)?(this.setObservableProperty("errorWeakPwd",!1),!0):(this.setObservableProperty("errorWeakPwd",!0),!1)},verifyPassword2:function(){return 0<this._viewData.password2.length&&this._viewData.password!==this._viewData.password2?this.setObservableProperty("errorWrongPwd",!0):this.setObservableProperty("errorWrongPwd",!1),this._viewData.errorWrongPwd},isFormComplete:function(t){return 0<t.email.length&&!t.errorEmail&&0<t.password.length&&!t.errorWeakPwd&&0<t.password2.length&&!t.errorWrongPwd},checkForm:function(){this.verifyEmail(),this.verifyPassword(),this.verifyPassword2(),this.setObservableProperty("isFormComplete",this.isFormComplete(this._viewData))},goToMainContent:function(){$(".resetpassword",this._$renderedContent).focus()},_onAddedToStage:function(t){this._super(t),$("body").addClass("textComponent"),this.cli.clearHash()},_addListeners:function(){var t=this;$("#email").on("focusout",function(){t.verifyEmail()}),$("#password1").on("focusout",function(){t.verifyPassword(),t.verifyPassword2()}),$("#password2").on("focusout",function(){t.verifyPassword()&&t.verifyPassword2()}),$(".backhomeLink").on("click",function(){t.cli.reloadAndReinit()}),window.Cookiebot&&$("a.cookiebot-renew",this._$renderedContent).attr("href","javascript:Cookiebot.renew()")}}),puremvc.define({name:"GCO5.view.mediator.ResetpasswordMediator",parent:puremvc.Mediator},{initComponent:function(){console.log("initComponent"),GCO5.core.GcComponentUtil.setupAndShowComponent(this.viewComponent,this)},_onPageContentLoaded:function(t){GCO5.core.GcComponentUtil.setupAndShowComponent(this.viewComponent,this)},onRegister:function(){var t=new GCO5.view.component.ResetpasswordComponent;this.setViewComponent(t),this.addListeners(t)},listNotificationInterests:function(){return[GCO5.AppConstants.INIT_COMPONENT,GCO5.AppConstants.ON_RESIZE]},handleNotification:function(t){var e=t.getName(),i=t.getBody(),n=this.viewComponent;switch(e){case GCO5.AppConstants.INIT_COMPONENT:"resetpassword"==i.id&&this.initComponent();break;case GCO5.AppConstants.ON_RESIZE:n.onResize(i)}},addListeners:function(t){}},{NAME:"ResetpasswordMediator"}),GCO5.view.component.FavsCommon={LOADSELGEO:"loadSelgeo",LOADFAVMAP:"loadFavMap",_getBaseViewData:function(){var i=this,t=this.cli.readFromLocalStorage("selgeo_a"),e=((t=t?JSON.parse(t):[]).forEach(function(t){t.selected=!1}),this.cli.readFromLocalStorage("favmap_a")),n=((e=e?JSON.parse(e):[]).forEach(function(t){t.selected=!1}),[{data:"map",label:this.gclg.getString("MAPS_INDICS","favs")},{data:"selgeo",label:this.gclg.getString("SELS_GEO","concepts")}]),r=(GCO5.browser.isIOS||n.push({data:"study",label:this.gclg.getString("STUDIES","concepts")}),this._viewData={cp:"fav",selgeo_a:t,favmap_a:e,report_a:[],typfav_a:n,selectedTypFav:"map",loadSelgeo:function(t,e){e=e.linkCtx.data,e={selgeo:e=new GCO5.model.maps.SelGeo(e),nivgeo:e.nivgeo,id_extent:e.id_extent,src:"favs",type:"selgeo"};e.mapName=GCO5.appModel.getInfo("mapNameFromNivgeo",[e.nivgeo,e.id_extent]),i.close(),$(i).triggerHandler(GCO5.view.component.FavsCommon.LOADSELGEO,e)},loadFavMap:function(t,e){i._loadState(e.linkCtx.data)},getSelgeoSelectedIndex:function(){var i=-1;return this.selgeo_a.forEach(function(t,e){t.selected&&(i=e)}),i},getSelgeoSelectedIndexes:function(){var i=[];return this.selgeo_a.forEach(function(t,e){t.selected&&i.push(e)}),i.reverse()},delSelgeo:function(t,e){this.getSelgeoSelectedIndexes().forEach(function(t){$.observable(r.selgeo_a).remove(t)}),GCO5.core.ClientInfo.getInstance().writeToLocalStorage("selgeo_a",JSON.stringify(this.selgeo_a))},upSelgeo:function(){var t=this.getSelgeoSelectedIndex();$.observable(this.selgeo_a).move(t,t-1),GCO5.core.ClientInfo.getInstance().writeToLocalStorage("selgeo_a",JSON.stringify(this.selgeo_a))},downSelgeo:function(){var t=this.getSelgeoSelectedIndex();$.observable(this.selgeo_a).move(t,t+1),GCO5.core.ClientInfo.getInstance().writeToLocalStorage("selgeo_a",JSON.stringify(this.selgeo_a))},getNbSelgeoSelected:function(){return this.selgeo_a.reduce(function(t,e){return t+(e.selected?1:0)},0)},getMapSelectedIndex:function(){var i=-1;return this.favmap_a.forEach(function(t,e){t.selected&&(i=e)}),i},getMapSelectedIndexes:function(){var i=[];return this.favmap_a.forEach(function(t,e){t.selected&&i.push(e)}),i.reverse()},renameFav:function(t,e){var i=this.getMapSelectedIndex();console.log("renameFav",i,r.favmap_a[i])},delMap:function(t,e){this.getMapSelectedIndexes().forEach(function(t){$.observable(r.favmap_a).remove(t)}),GCO5.core.ClientInfo.getInstance().writeToLocalStorage("favmap_a",JSON.stringify(this.favmap_a))},upMap:function(){var t=this.getMapSelectedIndex();$.observable(this.favmap_a).move(t,t-1),GCO5.core.ClientInfo.getInstance().writeToLocalStorage("favmap_a",JSON.stringify(this.favmap_a))},downMap:function(){var t=this.getMapSelectedIndex();$.observable(this.favmap_a).move(t,t+1),GCO5.core.ClientInfo.getInstance().writeToLocalStorage("favmap_a",JSON.stringify(this.favmap_a))},getNbMapSelected:function(){return this.favmap_a.reduce(function(t,e){return t+(e.selected?1:0)},0)},addToFavorites:function(){i._addToFavorites()},saveStudy:function(){GCO5.core.GcStringUtil.isEmpty(this.libStudy)?i.setObservableProperty("confirmStudyMsg",i.gclg.getString("ERR_STUDY_NAME","favs")):i._saveStudy()},saveSel:function(){var e=this.selgeo;e.localStorageTestSave(function(t){e.libgeo=r.libSel,e.localStorageSave(),i.setObservableProperty("confirmSelMsg",i.gclg.getString("SEL_SAVE_OK","selection"))},i)}});return r.getNbSelgeoSelected.depends="selgeo_a.**",r.getSelgeoSelectedIndex.depends="selgeo_a.**",r.getNbMapSelected.depends="favmap_a.**",r.getMapSelectedIndex.depends="favmap_a.**",r},_addToFavorites:function(){var t,e=GCO5.core.ClientInfo.getInstance(),i=GCO5.core.SystemManager.getInstance().getActiveComponent(),n=(n=e.readFromLocalStorage("favmap_a"))?JSON.parse(n):[],r=i.getCurrentStateMeta({ignoreImportedIndics:!0});for(t in n)if(JSON.stringify(r)==JSON.stringify(n[t]))return void this.setObservableProperty("confirmMsg",this.gclg.getString("WARNING_FAV_EXIST","favs"));n.unshift(r),e.writeToLocalStorage("favmap_a",JSON.stringify(n)),this._viewData.favmap_a&&this.setObservableArray("favmap_a",n),this.setObservableProperty("confirmMsg",this.gclg.getString("OK_FAV_SAVE","favs"))},_saveStudy:function(){var e=this,t=GCO5.core.SystemManager.getInstance().getActiveComponent(),i=GCO5.core.GcStringUtil.validColName(this._viewData.libStudy)+".ast";if(!window.JSZip)return e.gcsm.freeze("zip"),void require(["zip_m"],function(t){e.gcsm.unFreeze("zip"),GCO5.view.component.FavsCommon._saveStudy.apply(e)});e.setObservableProperty("confirmStudyMsg",this.gclg.getString("OK_STUDY_SAVE","favs"));function n(t){o.onload=function(){r=this.result,s.file("map1.png",r),r=s.generate({type:$.isFunction(window.Blob)?"blob":"base64",compression:"DEFLATE"}),saveAs(r,i)},o.readAsArrayBuffer(t)}var r,a=t.saveState(),s=new JSZip,o=new FileReader,a=(s.file("catalog.json",JSON.stringify({state1:a.state})),a.refgeos&&s.file("refgeos.json",JSON.stringify({state1:a.refgeos})),s.file("datasets.json",JSON.stringify({state1:a.dts_a})),this._map||t.map),t=GCO5.core.GcBitmapUtil.downScaleCanvas(a.exportImage(),.2);navigator.msSaveBlob?n.call(this,t.msToBlob()):t.toBlob(n)},_loadState:function(t){var e={src:"favs",type:"map",indicModels:[]},n=(e.mapName=t.mapName,0);e.indicModels=(t.indics_a||[]).map(function(t){t.idDataset=t.c_id_dataset,t.pk=t.c_id_indicateur,t.shortLibIndic=t.c_lib_indicateur_court,t.libIndic=t.c_lib_indicateur;var e,i=t.hasOwnProperty("enabled")&&!t.enabled;return 0==t.c_id_dataset.indexOf("_import")?(GCO5.model.indics.DatasetImported.updateImprtCpt(+t.idDataset.substr(7)),e=GCO5.model.indics.Dataset.getDataset(t.idDataset).getMapIndicModel(t.idDataset+"."+t.pk),t.serie&&e.setSerie(t.serie),e._readCustomMapParams(null,t.mapParams),n++):e=new GCO5.model.indics.IndicModel(t),i&&e.setOption("disabledAtFirst",!0),e}),0<n&&GCO5.appModel.loadColorsFamData(null,null,"C"),t.selgeo&&(e.selgeo=new GCO5.model.maps.SelGeo(t.selgeo)),e.extent=t.extent,$(this).triggerHandler(GCO5.view.component.FavsCommon.LOADFAVMAP,e),this.close()},addMixinListeners:function(){var a=this,i=a.gcsm.getComponent("app");$(this).on(GCO5.view.component.FavsCommon.LOADSELGEO,function(t,e){e.selgeo&&e.selgeo.sessionRegister(),i.loadMainComponent("indicator",e)}),$(this).on(GCO5.view.component.FavsCommon.LOADFAVMAP,function(t,e){i.loadMainComponent("indicator",e)}),$("#file",this._$renderedContent).on("change",function(t){for(var e=t.target.files,i=0;e[i];i++){var n=e[i],r=new FileReader;r.onload=function(i){return function(t){try{var e=new JSZip(t.target.result);a._readZipEntries(e.files)}catch(t){console.error("Error reading study file "+i.name+" : "+t.message)}}}(n),r.readAsArrayBuffer(n)}})},_readZipEntries:function(t){var e,i,n,r;for(r in t){var a=t[r].name;"catalog.json"==a&&(e=JSON.parse(t[r].asText())),"refgeos.json"==a&&(i=(i=JSON.parse(t[r].asText())).state1),"datasets.json"==a&&(n=JSON.parse(t[r].asText()))}n.state1&&Array.isArray(n.state1)&&n.state1.forEach(function(t){GCO5.model.indics.DatasetImported.importJSON(t.export_o,i)}),GCO5.core.GcDelayUtil.callLater(this._loadState,[e.state1],10,this)}},GCO5.view.component.MapSelinfoPanel=GCO5.view.component.APanel.extend({statics:{NAME:"GCO5.view.component.MapSelinfoPanel"},_map:null,_surroundDp:null,_curSelRow:null,selgeo:null,selgeo0:null,_initComponent:function(t){this._super(t);var e=this.selgeo=t.map.hasSymbSelgeo()?t.map.getSelgeo(t.map.getSymbThemeLayer().getName()):t.map.getSelgeo();this.selgeo0=GCO5.model.maps.SelGeo.cloneSelgeo(e),e&&(this.gcsm.freeze("map"),GCO5.appModel.searchSurroundGeo(this._onSearchSurroundGeo,this,{idView:t.map.getName(),codgeo:e.codgeo,nivgeo:e.nivgeo,selIds:e.getSelIds()}))},_prepareViewData:function(){var e=this,t=(t=this._map.getSelDescriptions())&&t[this._map.getStatLayerName()],i=this._updateSelDescription(),n=i.selDescription,r=i.i_a,i=this._map.getWidthWorld(),a=GCO5.appModel.getInfo("ReportsCompatibleWithSelgeo",[this.selgeo]),a=this._viewData={addSelInfo0:this._map.getLastSelAddedInfo(),selgeoHasReports:0<a.length,map:this._map,mapName:this._map.getName(),id_view:GCO5.appModel.getInfo("infoFromMapName",[this._map.getName(),"id_view"]),rech_a:[],hasSel:!0,hasSavableSel:!this._map.hasSymbSelgeo(),selgeoIsSimple:this.selgeo.getSingleCodgeo(),selgeo0Id:this.selgeo.getSingleCodgeo()?this.selgeo.id:null,selExtendKm:0,selExtendStep:.1,maxSelExtendKm:10*Math.ceil(.5*i/1e3)/10,computeOnLastFidAdded:!1,selExtendIsoKm:0,maxSelExtendIsoKm:200,selExtendMn:0,selExtendMnStep:1,maxSelExtendMn:120,displayIso:!1,isoComputed:!1,isoMethod:"time",isoGraph:"Voiture",isoReverse:"1",isolateSelection:!1,noToll:!1,libSel:this.selgeo.getLibgeo().split("&nbsp;").join(" "),selDescription:n,zonSelInfo:t.zonSelInfo,getLibNivgeo:function(t,e,i){return GCO5.appModel.getInfo("libNivgeo",[t,e,i])},ficIndic:function(){e.close(),GCO5.core.GcDelayUtil.callLater(function(){$("#tm_fiche").trigger("click")},[],5,e)},pdz:function(){e.close();var t={id:"report",categ:"main",selgeo:this.selgeo,mapName:this.map.getName()};$(GCO5.topApp).triggerHandler(GCO5.view.component.AComponent.LOAD_COMPONENT,t)},zoomSel:function(){this.map.zoomOnFeatureId(null,this.map.getSelIds())},deSel:function(){e.setObservableProperty("hasSel",!1),this.map.clearSel("*"),e.close()},isReducedScreen:function(){return!e.cli.isLargeWidthScreen()},saveSel:function(t){e._saveSel()},hasIndics:function(){return 0<r.length},selCircleOk:function(){e._onSelCircleOk()},selIsoOk:function(){e._onSelIsoOk()}};return a.libSel0=a.libSel,a},_addListeners:function(){var s=this,o=s._map,l=s._viewData;this._super(),$(".ui-listview",this._$container).on("click","li",function(t){var t=$(t.target).closest("li"),t=s._surroundDp[parseFloat(t.attr("uid"))],e=(t.id_extent=o.getIdExtent(),o.getLyStatName()),i=o.nivgeo,n="PG",r=("PT"==GCO5.appModel.getInfo("NivgeoTopology",[s.selgeo.nivgeo])&&(i=s.selgeo.nivgeo,e=i+"_P",n="PT"),new GCO5.model.maps.SelGeo(t)),a=s._viewData.computeOnLastFidAdded;s.setObservableProperty("libSel",a?"":t.libgeo+" ("+t.nivgeoLib+")"),r.getSelIds(i,o.getIdExtent(),function(){l.computeOnLastFidAdded?(o._setSelgeo(GCO5.model.maps.SelGeo.cloneSelgeo(s.selgeo0),!1,e),o.drawSelIds(e,r.getSelIds(),!0,!0,{centerFid:l.addSelInfo0.fid})):o.drawSelgeo(r,e,"PG"==n)},s,{idView:o.getName()}),s.setObservableProperty("hasSel",!0),s._map.clearSelCircle(),s.setObservableProperty("displayIso",!1),s.setObservableProperty("isoComputed",!1),s.setObservableProperty("selExtendKm",0),s.setObservableProperty("selExtendMn",0),s.setObservableProperty("selExtendIsoKm",0),s.cli.isSmallWidthScreen()&&s.close()}),$("[data-link='libSel']",this._$container).on("keydown",function(t){var e=t.keyCode||t.which;"keydown"==t.type&&"13"!=e||s._saveSel($(this).val())}),$.observe(this._viewData,"selExtendKm",$.proxy(this._onSelExtendKm,this)),GCO5.core.GcComponentUtil.enhanceSliderEvents($("[data-link='selExtendKm']",this._$container)),GCO5.core.GcComponentUtil.enhanceSliderEvents($("[data-link='selExtendMn']",this._$container)),GCO5.core.GcComponentUtil.enhanceSliderEvents($("[data-link='selExtendIsoKm']",this._$container)),$("[data-link='selExtendKm']",this._$renderedContent).on("input change",function(t){s.setObservableProperty("selExtendKm",$(this).val())}),$.observe(this._viewData,"displayIso",$.proxy(this._displayIsoLayer,this)),$.observe(this._viewData,"isoGraph",function(){s.setObservableProperty("displayIso",!1),s.setObservableProperty("isoComputed",!1),s.setObservableProperty("selExtendMn",0),s.setObservableProperty("selExtendIsoKm",0)}),$.observe(this._viewData,"computeOnLastFidAdded",function(t,e){if(s._viewData.noTrigger)return!1;var e=e.value,i=s.selgeo0;s.gcsm.freeze("map"),e?(e=s._viewData.addSelInfo0,GCO5.appModel.searchSurroundGeo(s._onSearchSurroundGeo,s,{idView:o.getName(),nivgeo:i.nivgeo,selIds:[e.fid]})):GCO5.appModel.searchSurroundGeo(s._onSearchSurroundGeo,s,{idView:o.getName(),codgeo:i.codgeo,nivgeo:i.nivgeo,selIds:i.getSelIds()})})},_onSearchSurroundGeo:function(t){var e=this._viewData.zonSelInfo,i=(e&&(t.rech_a.forEach(function(t,e){t.rowid=e}),0<(e=GCO5.core.GcArrayUtil.getSubArray(t.rech_a,{codgeo:[e.codgeo],nivgeo:[e.nivgeo]})).length&&(t.rech_a.splice(e[0].rowid,1),t.rech_a.unshift(e[0]))),t.rech_a||(t.rech_a=[]),this.gcsm.unFreeze("map"),GCO5.appModel.getConcept("extent_o")[this._map.getIdExtent()].c_id_nivgeo);t.rech_a=t.rech_a.filter(function(t){var e=GCO5.core.GcArrayUtil.getColumnByKey(GCO5.appModel.getInfo("SubNivgeos",[t.nivgeo]),"nivgeo");return i==t.nivgeo||e.indexOf(i)<0}),$.observable(this._viewData.rech_a).refresh(this._surroundDp=t.rech_a)},onBuildInfosel:function(t){var e=this._updateSelDescription().selDescription;this.setObservableProperty("selDescription",e),GCO5.core.GcStringUtil.isEmpty(this._viewData.libSel)&&this.setObservableProperty("libSel",$(e).text())},_onSelExtendKm:function(){var t=1e3*+this._viewData.selExtendKm;this._map.drawSelCircleAroundFid(this._viewData.addSelInfo0?this._viewData.addSelInfo0.fid:this._viewData.selgeo0Id,t)},_onSelCircleOk:function(){var t=+this._viewData.selExtendKm,t=this._viewData.computeOnLastFidAdded?"":t+" "+this.gclg.getString("KM","units")+" "+this.gclg.getString("AROUND")+" "+this._viewData.libSel0,e=this._viewData.computeOnLastFidAdded?{centerFid:this._viewData.addSelInfo0.fid}:null;this._map.selectInCurrentCircle(t,e),this.setObservableProperty("libSel",t),this.setObservableProperty("selExtendMn",0),this.setObservableProperty("selExtendIsoKm",0),this.setObservableProperty("displayIso",!1),this.setObservableProperty("isoComputed",!1)},_onSelIsoOk:function(){var i="time"==this._viewData.isoMethod,n=i?60*+this._viewData.selExtendMn:1e3*+this._viewData.selExtendIsoKm,r=this,a=r._viewData.computeOnLastFidAdded,s=this._viewData.addSelInfo0?this._viewData.addSelInfo0.fid:this._viewData.selgeo0Id,o=r._map.getLyStatName(),t=this._map.getSelgeoCenterWorld(this.selgeo0,s);this.setObservableProperty("displayIso",!1),"time"==this._viewData.isoMethod?(this.setObservableProperty("selExtendKm",0),this.setObservableProperty("selExtendIsoKm",0)):this.setObservableProperty("selExtendMn",0),r._map.drawSelCircleAroundFid(s,0,3,this.selgeo0),GCO5.appModel.loadIsochroneSelIds(function(t){var e=0==t.length||!t.selIds;e||(a?r._map._setSelgeo(GCO5.model.maps.SelGeo.cloneSelgeo(r.selgeo0),!1,o):r._map.clearSel("*")),r._map.clearSelCircle(),e||(e=i?GCO5.core.GcStringUtil.secondsToHms(n):r.gclg.formatNumber(+this._viewData.selExtendIsoKm)+" "+r.gclg.getString("KM","units")+" ",e+=" "+("1"==r._viewData.isoReverse?"vers":"de")+" "+this._viewData.libSel0,r.setObservableProperty("libSel",a?"":e),e=a?{centerFid:s}:{libsel:e},r._map.drawSelIds(r._map.getStatLayerName(),t.selIds,!0,a,e),this.setObservableProperty("isoComputed",!0),GCO5.core.GcDelayUtil.callLater(r._map.drawSelCircleAroundFid,[s,0,3,r.selgeo0],40,r._map))},this,this._map.getIdView(),Math.round(t.p0W.x),Math.round(t.p0W.y),n,this._viewData,this._map._srId)},_displayIsoLayer:function(t,e){var i;e.value?(this.gcsm.freeze("map"),e="time"==this._viewData.isoMethod?60*+this._viewData.selExtendMn:1e3*+this._viewData.selExtendIsoKm,i=this._map.getSelgeoCenterWorld(this.selgeo0),GCO5.appModel.loadIsochroneLayer(this._onLayerIsoLoaded,this,this._map.getIdView(),Math.round(i.p0W.x),Math.round(i.p0W.y),e,this._viewData,this._map._srId)):this._map.removeLayer("isochrone_DR",!1,!0)},_onLayerIsoLoaded:function(t){var e=GCO5.core.GcObjectUtil.getFirstKey(t),e=GCO5.appModel.getInfo("isoLayerLoaded",[this._map.getName(),e,t]);this._map.addLayer(e),this.gcsm.unFreeze("map")},_updateSelDescription:function(){var t,e=(e=this._map.getSelDescriptions())&&e[this._map.hasSymbSelgeo()?this._map.getSymbThemeLayer().getName():this._map.getStatLayerName()],i=this._map.getEnabledIndicsModelsIndexed(),n=[],r=0,a="<b>"+e.libSel+"</b>";for(t in e.libSel!=e.libSel3&&(a+=" ("+e.libSel3+")"),e.txtTabVars&&(a+="<br>"+e.txtTabVars),i)i[t].valuesDisplayable()&&n.push({idIndic:t,num:++r,formattedValSel:i[t].getProp("selMention",!0),formattedValRef:i[t].getProp("refMention",!0),valreflib:i[t].getProp("refLib"),libIndic:"<span class='figure-with-border pbs'>"+r+"</span>&nbsp;"+i[t].getProp("shortLibIndic")});return n.forEach(function(t){(t.formattedValSel||t.valreflib)&&(a+="<br>"+t.libIndic,t.formattedValSel&&(a+="<br><b>"+t.formattedValSel+"</b>"),t.valreflib&&t.formattedValRef&&(a+=", "+t.formattedValRef))}),{selDescription:a,i_a:n}},_saveSel:function(){var e=this._map.getSelgeo(),i=this;e.localStorageTestSave(function(t){e.libgeo=i._viewData.libSel,e.localStorageSave(),i.setObservableProperty("confirmMsg",this.gclg.getString("SEL_SAVE_OK","selection"))},i)},_renderViewData:function(){var t=(t=this.getName()).substr(0,1).toLowerCase()+t.substr(1);this._$renderedContent=$("<section id='"+t+"' data-role='component' class='no-display'></section>").appendTo(this._$container),$.render[this.getName()].link(this._$renderedContent,this._viewData),this.configureSlidingPanelHeader(this.gclg.getString("PANEL_CUR_SEL","selection"))},_destroy:function(t){this._map.clearSelCircle(),this._map.removeLayer("isochrone_DR",!1,!0),this._super()}}),GCO5.view.component.MapSelmethodsPanel=GCO5.view.component.APanel.extend({statics:{NAME:"GCO5.view.component.MapSelmethodsPanel"},_initComponent:function(t){},_prepareViewData:function(){return this._viewData={}},_renderViewData:function(){var t=(t=this.getName()).substr(0,1).toLowerCase()+t.substr(1);this._$renderedContent=$("<section id='"+t+"' data-role='component' class='no-display'></section>").appendTo(this._$container),$.render[this.getName()].link(this._$renderedContent,this._viewData),this.configureSlidingPanelHeader(this.gclg.getString("SELECTIONS_HELP","selection"))},_destroy:function(t){this._$renderedContent.remove()}}),GCO5.view.component.MapAnimPanel=GCO5.view.component.AComponent.extend({statics:{NAME:"GCO5.view.component.MapAnimPanel"},_map:null,_mapIndicModel:null,_otherMim:null,_mim_o:null,_bmpStatus_o:null,_ca:null,_initComponent:function(t){this._ca=t.ca,this._map=t.map,this._mapIndicModel=t.mapIndicModel;var t=this._mapIndicModel.getProp("serie"),e=this._mapIndicModel.getProp("dataSeries",{anim:!0,series:t}).reverse(),i=this._mapIndicModel.getIndicModel();this._mim_o=this._map.getEnabledIndicsModelsIndexed();var n,r,a=this,s=this._mapIndicModel.getProp("idDataset"),t=0==s.indexOf("_import");for(r in this._mapIndicModel.setAnimateMode(!0),this._bmpStatus_o={},this._bmpStatus_o[this._mapIndicModel.getPkF1()]=1,this._mim_o){var o=this._mim_o[r];o!==this._mapIndicModel&&o.getProp("idDataset")==s&&(this._otherMim=o,n=o.getIndicModel(),this._bmpStatus_o[o.getPkF1()]=1)}var l,c,h=this._map.getIdView(),d={serie:"anim",id_view:h},u={serie:e[0],id_view:h};this._otherMim?(h=this._map.getCanvas("maptransition"),$(h).insertAfter($(this._map.getStatCanvas())),t?(this._otherMim.resetParams("calcs"),this._map.getThemeViewByMapIndicModel(this._otherMim).getSerieBitmaps(),this._mapIndicModel.resetParams("calcs"),this._map.getThemeViewByMapIndicModel(this._mapIndicModel).getSerieBitmaps()):(l=function(){a._otherMim.resetParams("calcs"),a._mapIndicModel.resetParams("calcs"),a.setObservableProperty("serie",e[0],{noTrigger:!0}),a._ca._updateMapIndicAxisValues(a._mapIndicModel),a._ca._updateMapIndicAxisValues(a._otherMim),a._map.updTheme(a._mapIndicModel),GCO5.core.GcDelayUtil.callLater(function(){GCO5.appModel.loadIndicData(c,this,i,d)},[],10,a)},c=function(t,e){a._onLoadIndicData(t,e),GCO5.appModel.loadIndicData(a._onLoadIndicData,a,n,d)},GCO5.appModel.loadIndicData(function(){GCO5.appModel.loadIndicData(l,this,n,u)},this,i,u))):t?(this._mapIndicModel.resetParams("calcs"),this._map.getThemeViewByMapIndicModel(this._mapIndicModel).getSerieBitmaps()):GCO5.core.GcDelayUtil.callLater(this._onLoadIndicDataBeforeAnim,[null,i],5,this)},_onLoadIndicDataBeforeAnim:function(t,e){var i=this,n=(this.setObservableProperty("serie",e.getProp("serie"),{noTrigger:!0}),this._viewData.serie0Reinit&&this._mapIndicModel.resetParams("calcs"),this._ca._updateMapIndicAxisValues(this._mapIndicModel),this._map.addTheme(this._mapIndicModel,{render:!0}),{serie:"anim",id_view:i._viewData.id_view});n.seuils=this._mapIndicModel.getMeta("seuils"),this._viewData.dataSeries.join("")!=this._viewData.dataSeries0.join("")&&(n.series=this._viewData.dataSeries.join("|")),this.setObservableProperty("serie0Reinit",!1),GCO5.core.GcDelayUtil.callLater(function(){GCO5.appModel.loadIndicData(i._onLoadIndicData,i,e,n)},[],10,this)},_onLoadIndicData:function(t,e){var i=this._mim_o[e.getPkF1()],e=(e.setAnimData(t),this._map.getThemeViewByMapIndicModel(i).getSerieBitmaps(),this._map.getCanvas("maptransition"));$(e).insertAfter($(this._map.getStatCanvas())),this.setObservableProperty("animDirty",!1)},_onSlidering:function(t,e){if(!this._viewData.noTrigger){var i=[this._mapIndicModel];for(t in this._otherMim&&i.push(this._otherMim),this._map.onSerieAnimChange(e.value,i,!0),i)this._ca._updateMapIndicAxisValues(i[t],e.value)}},_addListeners:function(){var o=this,l=o._viewData,t=GCO5.view.component.AppComponent.CLOSE_PANEL;$(document).off(t),$(document).one(t,$.proxy(o._destroy,o)),GCO5.core.GcComponentUtil.enhanceSliderEvents($("#serieRange",this._$container)),$.observe(this._viewData,"serie",$.proxy(this._onSlidering,this)),$(this._map).on(GCO5.view.component.MapView.UPD_SERIE,function(t,e){$.observable(o._viewData).setProperty("serie",e.serie)}),$(this._map).on(GCO5.view.component.MapViewThematic.ANIM_BMP_READY,function(t,e){(o._bmpStatus_o[e.mapIndicModel.getPkF1()]=0)==GCO5.core.GcObjectUtil.sum(o._bmpStatus_o)&&o.setObservableProperty("animReady",!0),o.setObservableProperty("animDirty",!1)}),$(this._map).on(GCO5.view.component.MapView.END_ANIM,function(t,e){$.observable(o._viewData).setProperty("animating",!1)}),$("#serieRange",this._$renderedContent).on("input change click",function(t){"click"==t.type&&o._map.isAnimating()?l.pauseAnim():o.setObservableProperty("serie",o._viewData.dataSeries[$(this).val()])}),this.cli.isLocalhost()&&!this._viewData.getReducedMode()&&(this.temporalRangeSlider&&(this.temporalRangeSlider.noUiSlider.on("update",function(t,e){var i,n,r,a,s=l.dataSeries0.slice(+t[0],+t[1]+1);o.setObservableProperty("animDirty",!0),o.setObservableProperty("serieSliding",l.dataSeries0[+t[0]]+"-"+l.dataSeries0[+t[1]]),o.setObservableArray("dataSeries1",s.concat()),a=s.length>l.nbMaxPeriods?(o.setObservableProperty("limitPeriods","i"),i=l.getInterval(),n=s.length,a=s.indexOf(l.serie0),r=(n-1-a)%i,s.filter(function(t,e){return(n-1-e+r)%i==0})):(0==t[0]?o.setObservableProperty("limitPeriods","d",{noTrigger:!0}):t[1]==l.dataSeries0.length-1?o.setObservableProperty("limitPeriods","f",{noTrigger:!0}):o.setObservableProperty("limitPeriods","",{noTrigger:!0}),s),o.setObservableArray("dataSeries",a)}),this.temporalRangeSlider.noUiSlider.on("end",function(){o.setObservableProperty("serie0Reinit",!1),l.dataSeries.indexOf(l.serie0)<0&&(o.setObservableProperty("serie0Reinit",!0),o.setObservableProperty("periode_seuils",l.dataSeries[l.dataSeries.length-1]))})),$.observe(this._viewData,"seuilsComputation","periode_seuils",function(t){o.setObservableProperty("animDirty",!0),"periode_seuils"==t.data.prop&&o.setObservableProperty("seuilsComputation","2")}),$.observe(this._viewData,"limitPeriods",function(t,e){"d"==e.value&&(o.setObservableArray("dataSeries",l.dataSeries0.slice(0,l.nbMaxPeriods-1)),o.temporalRangeSlider.noUiSlider.set([0,l.dataSeries.length])),"f"==e.value&&(o.setObservableArray("dataSeries",l.dataSeries0.slice(l.dataSeries0.length-l.nbMaxPeriods)),o.temporalRangeSlider.noUiSlider.set([l.dataSeries0.length-l.dataSeries.length,l.dataSeries0.length])),o.setObservableProperty("animDirty",!0)}))},_prepareViewData:function(){this.cli.isLocalhost()&&(GCO5.view.component.AThemeView.MAX_ANIM_PERIODS=10);function t(){var t=this.dataSeries.indexOf(this.serie);return t}function e(){return this.dataSeries.length}function i(){return[].concat(s.map(function(t){return{data:t,label:t}}))}function n(){return Math.ceil(this.dataSeries1.length/this.nbMaxPeriods)}var r=this,a=this._mapIndicModel,s=a.getProp("dataSeries",{anim:!0,serie0:a.getProp("serie")}),o=this.cli,l=a.getProp("dataSeries"),c=(t.depends=["dataSeries","serie"],e.depends=["dataSeries"],i.depends="dataSeries",n.depends="dataSeries1",GCO5.view.component.AThemeView.MAX_ANIM_PERIODS),h=this._viewData={nbMaxPeriods:c,tooMuchPeriods:l.length>c,animReady:!1,animDirty:!1,map:this._map,mapName:this._map.getName(),mapIndicModel:a,otherMim:this._otherMim,id_view:GCO5.appModel.getInfo("infoFromMapName",[this._map.getName(),"id_view"]),serie:this._mapIndicModel.getProp("serie"),serie0:this._mapIndicModel.getProp("serie"),serie0Reinit:!1,dataSeries:s,dataSeries0:l,dataSeries1:s.concat(),nseries:s.length,animating:!1,seuilsComputation:"1",periode_seuils:"f",limitPeriods:"i",serieSliding:"",launchAnim:function(){var t=[this.mapIndicModel,this.otherMim];this.otherMim?"Symb"==this.mapIndicModel.getSuperCategory()&&t.reverse():t.pop(),t.forEach(function(t,e){h.map.getThemeViewByMapIndicModel(t).playAnim(e)}),r.setObservableProperty("animating",!0)},pauseAnim:function(){this.map.pauseAnim(this.mapIndicModel),r.setObservableProperty("animating",!1)},prevPeriod:function(){var t=this.dataSeries.indexOf(this.serie);r.setObservableProperty("serie",this.dataSeries[--t])},nextPeriod:function(){var t=this.dataSeries.indexOf(this.serie);r.setObservableProperty("serie",this.dataSeries[++t])},getKSerie:t,getNbSeries:e,getPeriodesSeuils:i,getInterval:n,getReducedMode:function(){return o.isWithoutPilotagePanel()?o.isInIframe()?2:1:0},getPanelHeight:function(){return this.getReducedMode()?$(".mapSection").offset().top-1+"px":0},getPanelStyle:function(){return this.getReducedMode()?1==this.getReducedMode()?"style='margin-top:10px'":2==this.getReducedMode()?o.isTinyWidthScreen()?"style='max-width:350px;margin-top:5px'":"style='max-width:500px;margin-top:15px'":void 0:""},computeAnim:function(){var t,e=a.getIndicModel();h.dataSeries.indexOf(h.serie0)<0?(h.serie0=h.periode_seuils,t={serie:h.serie0,id_view:r._map.getIdView()},r.setObservableProperty("serie0Reinit",!0),GCO5.appModel.loadIndicData(r._onLoadIndicDataBeforeAnim,r,e,t)):r._onLoadIndicDataBeforeAnim(null,e)}};return h},_renderViewData:function(){var t,e=this.getName(),i=this._viewData,e=e.substr(0,1).toLowerCase()+e.substr(1);this._$renderedContent=$("<section id='"+e+"' data-role='component' class='no-display'></section>").appendTo(this._$container),$.render[this.getName()].link(this._$renderedContent,i),this.configureSlidingPanelHeader(this.gclg.getString("TEMP_ANIM","anim")),this.cli.isWithoutPilotagePanel()&&(this._$container.closest(".cd-panel-container").height("200px"),this._$container.closest(".cd-panel-container").show()),this._viewData.getReducedMode()&&(this._$container.closest(".cd-panel").find(".cd-panel-header").hide(),this._$container.closest(".cd-panel-container").height(i.getPanelHeight()).css("width","100%").css("max-width","100%"),this._$container.closest(".cd-panel-content").css("padding-top","0").css("overflow-y","hidden")),this.cli.isLocalhost()&&!i.getReducedMode()&&i.tooMuchPeriods&&(e=this._$container.find(".temporalRangeSlider"),this.temporalRangeSlider=e.get(0),e=i.dataSeries.length,t=i.dataSeries0.length,i=i.dataSeries0.indexOf(i.dataSeries[0]),this.temporalRangeSlider&&noUiSlider.create(this.temporalRangeSlider,{start:[i,i+e],connect:!0,behaviour:"drag",step:1,margin:1,range:{min:0,max:t-1}}))},_destroy:function(t){$.unobserve(this._viewData);var e,i=this._viewData.serie0;this._mapIndicModel.setSerie(i,{fromAnim:!0}),this._mapIndicModel.setAnimateMode(!1),this._map.getThemeViewByMapIndicModel(this._mapIndicModel).updateLegend(),this._otherMim&&(this._map.closeAnim(this._otherMim),this._otherMim.setSerie(i),this._otherMim.setAnimateMode(!1),this._map.getThemeViewByMapIndicModel(this._otherMim).updateLegend()),this._map.closeAnim(this._mapIndicModel),this._viewData.getReducedMode()&&((e=this._$container).closest(".cd-panel-container").height("100%"),e.closest(".cd-panel-container").height(this._viewData.getPanelHeight()),GCO5.core.GcDelayUtil.callLater(function(){e.closest(".cd-panel").find(".cd-panel-header").show(),e.closest(".cd-panel-container").removeAttr("style"),e.closest(".cd-panel-content").removeAttr("style")},[],100,this)),this._$renderedContent.remove(),this.temporalRangeSlider&&this.temporalRangeSlider.noUiSlider.off()}}),GCO5.view.component.MapImportIndicPanel=GCO5.view.component.AComponent.extend({statics:{NAME:"GCO5.view.component.MapImportIndicPanel"},_map:null,_mapIndicModel:null,_ca:null,_indicIndex:null,_newIndic:null,_loadedOnMap:null,_initComponent:function(t){this._map=t.map,this._mapIndicModel=t.mapIndicModel,this._ca=t.ca,this._indicIndex=t.index},_isCompositeIndic:function(){var t=this._mapIndicModel?this._mapIndicModel.getPk():null;return t&&0<t.indexOf("_composite_pk")},_addListeners:function(){var i=this,t=GCO5.view.component.AppComponent.CLOSE_PANEL;$(document).off(t),$(document).one(t,$.proxy(i._destroy,i)),$.observe(this._viewData,"selectedTypind",$.proxy(this._onTypindChange,this)),$.observe(this._viewData,"selectedFrmType",$.proxy(this._onFrmTypeChange,this)),$.observe(this._viewData,"selectedDataSource",$.proxy(this._onDataSourceChange,this)),$.observe(this._viewData,"shortLibIndic",function(t,e){i.configureSlidingPanelHeader(e.value)}),$("[data-link='data']",this._$renderedContent).on("change",function(t){t=+$(t.target).data("index");$(this).parent().parent().find("[data-link='label']").val($(this).val()).trigger("change"),i._viewData.vars_a[t].label=$(this).val()})},_onDataSourceChange:function(t,e){e=e.value;this.setObservableProperty("selectedTypind","group"==e?"R":"C")},_onTypindChange:function(t,e){var i,n=e.value,e=(e.oldValue,this._mapIndicModel.getProp("idIndicateur")),r=this._viewData.dts.getFieldInfo(e);"I"==n?(e=r.mods.sort().map(function(t,e){return{data:t,lib0:t,lib:r.VIlibs?t+" - "+r.VIlibs[e]:t,colf:GCO5.model.indics.MapIndicModel.COLFVI[e]}}),this.setObservableArray("ranges_a",e),this._initSubComponentsAndEnhance()):this._isCompositeIndic()&&(this._mapIndicModel&&(i=this._mapIndicModel.getPk().split(".").pop(),this._mapIndicModel.destroy()),this._mapIndicModel=this.createNewMapIndicModel(this._viewData.dts,n,i))},_onFrmTypeChange:function(t,e){this.setObservableProperty("selectedTypind","var1-var2"==e.value||"var1+var2"==e.value?"R":"C")},createNewMapIndicModel:function(t,e,i){var n={},r=t.getNumericFields(),r=GCO5.core.GcArrayUtil.getColumnByKey(r,"data"),i=(n.pk=i||t.getNewComputedIndicPk(),n.libIndic=n.shortLibIndic=this.gclg.getString("NEW_INDIC","pilotage","externaldata")+" "+n.pk.split("_composite_pk").pop(),n.dataSource="frm",n.views=n.c_id_views=GCO5.appModel.getInfo("mapNamesFromNivgeos",[t.nivgeos,this._map.getIdExtent(),"id_view"]),n.nivgeos=t.nivgeos,"PT"==t.topology&&(n.idSymbLayer=t.getPk(),n.c_topo="PT"),"C"==e?(t._addChoroNumAttributes(n),n.nbdec=1,n.unit="%",n.dataSource="frm",n.frm_type={type:"p1*var1/var2+p2",var1:r[0],var2:r[1],p1:100,p2:0},2<r.length&&(n.frm_type.var3=r[2])):"R"==e&&(t._addSymbGradAttributes(n,"group"==this._viewData.selectedDataSource),n.unit="","frm"==this._viewData.selectedDataSource&&(n.frm_type={type:"var1-var2",var1:r[0],var2:r[1],p1:1,p2:0},2<r.length&&(n.frm_type.var3=r[2]),n.idColFam=GCO5.model.indics.MapIndicModel.DEFAULT_COLFAM_SOLDE,n.colf=GCO5.appModel.getInfo("hexColorsFromColFam",[n.idColFam,"R"])[0].c_coldef)),this._initialTypind=e,this._viewData&&this.setObservableProperty("unit",n.unit),new GCO5.model.indics.MapIndicModel(t._createIndicModel(n)));return"PT"==t.topology&&((r={})[(e=n.idSymbLayer+"_P")+"_P"]=GCO5.appModel.getRefData(e,this._map.getIdExtent()),GCO5.appModel.getPointLayerDef(i,r,this._map.getName())),i},_prepareViewData:function(s){function t(t){return o.gclg.getString(t,"pilotage","externaldata")}var i,e,n,o=this,r=[{data:"col",label:t("DATASET_COLUMN")},{data:"frm",label:this.gclg.getString("INDIC_FORMULA2","indics")},{data:"group",label:t("GROUPS_PIES")}],a=(r.forEach(function(t){t.visible="col"!=t.data}),s.dts.getNumericFields()),l=(this._mapIndicModel?this._loadedOnMap=!0:(this._newIndic=!0,2<=a.length&&(this._initialTypind="C",c={typind:"C",typind_a:["C","R"]},this._mapIndicModel=this.createNewMapIndicModel(s.dts,"C"))),this._mapIndicModel.getProp("idIndicateur")),c=c||s.dts.getFieldInfo(l),h=c?c.typind:this._mapIndicModel.getProp("type"),d=(this._initialTypind||(this._initialTypind=h),this._mapIndicModel?this._mapIndicModel.getProp("formulaType"):null),u=s.dataSource||this._mapIndicModel.getProp("dataSource"),p="group"==u,g=p?this._mapIndicModel.getProp("nbVars"):2,p=(p&&(i=this._mapIndicModel.getProp("vILibs"),n=this._mapIndicModel.getHexColors(),e=this._mapIndicModel.getProp("vars").map(function(t,e){return{data:t,label:i[e],colf:n[e]}})),[{data:"R",label:t("INDIC_ADDITIVE")},{data:"C",label:t("INDIC_RATIO")},{data:"I",label:t("INDIC_TYPO")},{data:"O",label:t("INDIC_OURSIN")}]),f=(p.forEach(function(t){t.visible=!0}),this._viewData={map:this._map,mapName:this._map.getName(),indicIndex:s.index,dts:s.dts,selectedDataSource:u,dataSource_a:r,selectedFrmType:d?d.type:"p1*var1/var2+p2",frmtype_a:[{data:"p1*var1/var2+p2",label:"p1 * var1 / var2"},{data:"var1-var2",label:"var1 - var2"},{data:"var1+var2",label:"var1 + var2"},{data:"p1*(var1-var2)/var3",label:"p1 * (var1-var2) / var3"}],colsnum_a:a,mult_a:[1,100,1e3,1e4],vars_a:e,selectedNumvars:g,typind_a:p,selectedTypind:h,source:this._mapIndicModel.getProp("source"),shortLibIndic:this._mapIndicModel.getProp("shortLibIndic"),libIndic:this._mapIndicModel.getProp("libIndic"),unit:this._mapIndicModel.getProp("unit"),libDataset:s.dts.getName(),lastMappedTypind:o._newIndic?null:o._initialTypind,lastMapIndicModel:this._mapIndicModel,saveDefs:function(t,e,i){if(o._loadedOnMap&&this.lastMappedTypind!=this.selectedTypind)return this.map.removeTheme(this.lastMapIndicModel,{noEnablingOthers:!0}),this.lastMapIndicModel.destroy(),this.lastMappedTypind=this.selectedTypind,void GCO5.core.GcDelayUtil.callLater(this.saveDefs,[null,null,this.selectedTypind],50,this);!o._isCompositeIndic()&&i&&(o._mapIndicModel=this.dts.reBuildMapIndicModel(l,i));var n,r=o._mapIndicModel.getIndicModel(),i=(["source","unit","shortLibIndic"].forEach(function(t){r.setProp(t,f[t])}),r.setProp("nivgeo",this.map.getIdNivgeo()),r.setProp("libIndic",f.shortLibIndic),GCO5.core.GcArrayUtil.getColumnByKey(this.ranges_a,"lib")),a=GCO5.core.GcArrayUtil.getColumnByKey(this.ranges_a,"colf");this.areRangesVisible()&&this.ranges_a&&1<=this.ranges_a.length&&(r.setProp("VIlibs",i.slice(0,r.getProp("VIMods").length)),r.setProp("VIcols",a),o._mapIndicModel.updateWithDefs({colf:a})),"col"==f.selectedDataSource&&"C"==f.selectedTypind&&r.getValues(),"frm"==f.selectedDataSource?((i=r.getProp("formulaType"))&&(i.type=f.selectedFrmType,i.var1=f.selectedVar1,i.var2=f.selectedVar2,i.p1=f.selectedP1,o._mapIndicModel.clearComputedData()),"C"==f.selectedTypind?(r.getValues(),n=r.getProp("firstDistribInfo"),a=GCO5.model.indics.MapIndicModel[n&&n.minth<0?"DEFAULT_COLFAM_DIVERGING":"DEFAULT_COLFAM_ORDERED"],o._mapIndicModel.updateWithDefs({idColFam:a})):(r.getValues(),i=(n=r.getProp("firstDistribInfo"))&&n.minth<0?["#ff9900","#0099ff"]:["#5C85CC"],o._mapIndicModel.updateWithDefs({colf:i}),o._mapIndicModel.calcs.distribInfo=n)):"group"==f.selectedDataSource&&(a=f.vars_a.slice(0,f.selectedNumvars),o._mapIndicModel.clearComputedData(),r.setProp("vars_a",GCO5.core.GcArrayUtil.getColumnByKey(a,"data")),r.setProp("dataSource","group"),r.setProp("nbvars",f.selectedNumvars),r.setProp("VImods",GCO5.core.GcArrayUtil.getColumnByKey(a,"data")),r.setProp("VIlibs",GCO5.core.GcArrayUtil.getColumnByKey(a,"label")),r.setProp("colf",GCO5.core.GcArrayUtil.getColumnByKey(a,"colf")),o._mapIndicModel.updateWithDefs({colf:GCO5.core.GcArrayUtil.getColumnByKey(a,"colf")})),s.dts.updMapIndicModel(o._mapIndicModel),this.map.addTheme(o._mapIndicModel,{render:!0}),f.lastMappedTypind=f.selectedTypind,f.lastMapIndicModel=f.mapIndicModel=o._mapIndicModel,o._ca.onSaveIndicsDef.call(o._ca,f),o._loadedOnMap=!0},areRangesVisible:function(){return"I"==this.selectedTypind||"P"==this.selectedTypind}}),u=(f.areRangesVisible.depends=["selectedTypind","selectedDataSource"],f.numvars_a=a.map(function(t,e){return e+1}),this._mapIndicModel.getProp("formulaType"));return u&&(f.selectedVar1=u.var1,f.selectedVar2=u.var2,f.selectedVar3=u.var3,f.selectedP1=u.p1,n=d3.scaleOrdinal(d3.schemeCategory10).range(),f.vars_a=a.map(function(t,e){return{data:t.data,label:t.data,colf:n[e]}})),f.ranges_a=this._mapIndicModel.getRangesInfo(!0,!0,!0)||[],c&&f.typind_a.forEach(function(t){t.visible=0<=c.typind_a.indexOf(t.data)}),f},_renderViewData:function(){var t=(t=this.getName()).substr(0,1).toLowerCase()+t.substr(1),t=(this._$renderedContent=$("<section id='"+t+"' data-role='component' class='no-display'></section>").appendTo(this._$container),$.render[this.getName()].link(this._$renderedContent,this._viewData),this._newIndic?this.gclg.getString("NEW_INDIC","pilotage","externaldata"):this._mapIndicModel.getProp("shortLibIndic"));this.configureSlidingPanelHeader(t),GCO5.core.GcDelayUtil.callLater(this._ca.alignFormLabels,[".labelgroup",this._$renderedContent],10,this._ca)},_destroy:function(t){$.unobserve(this._viewData),this._$renderedContent.remove()},_initSubComponentsAndEnhance:function(){this._super(),$(".colpicker",this._$container).spectrum({type:"color",showInput:!0,containerClassName:"full-spectrum",replacerClassName:"full-spectrum",hideAfterPaletteSelect:!0,showPalette:!0,showAlpha:!1,palette:[["#000000","#434343","#666666","#999999","#b7b7b7","#cccccc","#d9d9d9","#efefef","#f3f3f3","#ffffff"],["#980000","#ff0000","#ff9900","#ffff00","#00ff00","#00ffff","#4a86e8","#0000ff","#9900ff","#ff00ff"],["#e6b8af","#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d9ead3","#c9daf8","#cfe2f3","#d9d2e9","#ead1dc"],["#dd7e6b","#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#a4c2f4","#9fc5e8","#b4a7d6","#d5a6bd"],["#cc4125","#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6d9eeb","#6fa8dc","#8e7cc3","#c27ba0"],["#a61c00","#cc0000","#e69138","#f1c232","#6aa84f","#45818e","#3c78d8","#3d85c6","#674ea7","#a64d79"],["#85200c","#990000","#b45f06","#bf9000","#38761d","#134f5c","#1155cc","#0b5394","#351c75","#741b47"],["#5b0f00","#660000","#783f04","#7f6000","#274e13","#0c343d","#1c4587","#073763","#20124d","#4c1130"]],preferredFormat:"hex"})}}),function(){var n="undefined"!=typeof exports&&exports||this;n.svgAsDataUri=function(a,s,o){s=s||1;var l=function(){var t=document.createElement("div"),e=a.cloneNode(!0),i=parseInt(e.getAttribute("width")),n=parseInt(e.getAttribute("height")),r="http://www.w3.org/2000/xmlns/",r=(e.setAttribute("version","1.1"),e.setAttributeNS(r,"xmlns","http://www.w3.org/2000/svg"),e.setAttributeNS(r,"xmlns:xlink","http://www.w3.org/1999/xlink"),e.setAttribute("width",i*s),e.setAttribute("height",n*s),e.setAttribute("viewBox","0 0 "+i+" "+n),t.appendChild(e),e.insertBefore(function(t){for(var e="",i=document.styleSheets,n=0;n<i.length;n++){try{var r=i[n].cssRules}catch(t){continue}for(var a=0;a<r.length;a++){var s=r[a];try{void 0!==s.style&&0<t.querySelectorAll(s.selectorText).length&&(e+=s.selectorText+" { "+s.style.cssText+" }\n")}catch(t){}}}var o=document.createElement("style"),l=(o.setAttribute("type","text/css"),o.innerHTML="<![CDATA[\n"+e+"\n]]>",document.createElement("defs"));return l.appendChild(o),l}(e),e.firstChild),'<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'+t.innerHTML),i="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(r)));o&&o(i,r)},t=document.querySelectorAll("svg image"),c=t.length;0==c&&l();for(var e=0;e<t.length;e++)!function(t){if(t.getAttribute("xlink:href")){var e=t.getAttribute("xlink:href").value;if(/^http/.test(e)&&!new RegExp("^"+window.location.host).test(e))throw new Error("Cannot render embedded images linking to external hosts.")}var i=document.createElement("canvas"),n=i.getContext("2d"),r=new Image;r.src=t.getAttribute("xlink:href"),r.onload=function(){i.width=r.width,i.height=r.height,n.drawImage(r,0,0),t.setAttribute("xlink:href",i.toDataURL("image/png")),0==--c&&l()}}(t[e])},n.saveSvgAsPng=function(t,e,i){n.svgAsDataUri(t,i,function(t){var e=new Image;e.src=t,e.onload=function(){var t=document.createElement("canvas");document.body.appendChild(t),t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0);try{alert(t.toDataURL())}catch(t){alert(t.message)}}})}}(),function(t,e){"use strict";"undefined"!=typeof define&&define.amd?define("canvgModule",["rgbcolor","stackblur"],e):"undefined"!=typeof module&&module.exports&&(module.exports=e(require("rgbcolor"),require("stackblur"))),t.canvg=e(t.RGBColor,t.stackBlur)}("undefined"!=typeof window?window:this,function(c,h){function d(t,e,n){if(null==t&&null==e&&null==n)for(var r=document.querySelectorAll("svg"),a=0;a<r.length;a++){var s=r[a],o=document.createElement("canvas"),l=(o.width=s.clientWidth,o.height=s.clientHeight,s.parentNode.insertBefore(o,s),s.parentNode.removeChild(s),document.createElement("div"));l.appendChild(s),d(o,l.innerHTML)}else{null!=(t="string"==typeof t?document.getElementById(t):t).svg&&t.svg.stop();n=function(t){var w={opts:t,FRAMERATE:30,MAX_VIRTUAL_PIXELS:3e4,log:function(t){}};1==w.opts.log&&"undefined"!=typeof console&&(w.log=function(t){console.log(t)});w.init=function(t){var e=0;w.UniqueId=function(){return"canvg"+ ++e},w.Definitions={},w.Styles={},w.StylesSpecificity={},w.Animations=[],w.Images=[],w.ctx=t,w.ViewPort=new function(){this.viewPorts=[],this.Clear=function(){this.viewPorts=[]},this.SetCurrent=function(t,e){this.viewPorts.push({width:t,height:e})},this.RemoveCurrent=function(){this.viewPorts.pop()},this.Current=function(){return this.viewPorts[this.viewPorts.length-1]},this.width=function(){return this.Current().width},this.height=function(){return this.Current().height},this.ComputeSize=function(t){return null!=t&&"number"==typeof t?t:"x"==t?this.width():"y"==t?this.height():Math.sqrt(Math.pow(this.width(),2)+Math.pow(this.height(),2))/Math.sqrt(2)}}},w.init(),w.ImagesLoaded=function(){for(var t=0;t<w.Images.length;t++)if(!w.Images[t].loaded)return!1;return!0},w.trim=function(t){return t.replace(/^\s+|\s+$/g,"")},w.compressSpaces=function(t){return t.replace(/[\s\r\t\n]+/gm," ")},w.ajax=function(t){var e=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");return e?(e.open("GET",t,!1),e.send(null),e.responseText):null},w.parseXml=function(t){var e,i;return"undefined"!=typeof Windows&&void 0!==Windows.Data&&void 0!==Windows.Data.Xml?(i=new Windows.Data.Xml.Dom.XmlDocument,(e=new Windows.Data.Xml.Dom.XmlLoadSettings).prohibitDtd=!1,i.loadXml(t,e),i):window.DOMParser?(new DOMParser).parseFromString(t,"text/xml"):(t=t.replace(/<!DOCTYPE svg[^>]*>/,""),(i=new ActiveXObject("Microsoft.XMLDOM")).async="false",i.loadXML(t),i)},w.Property=function(t,e){this.name=t,this.value=e},w.Property.prototype.getValue=function(){return this.value},w.Property.prototype.hasValue=function(){return null!=this.value&&""!==this.value},w.Property.prototype.numValue=function(){if(!this.hasValue())return 0;var t=parseFloat(this.value);return(this.value+"").match(/%$/)&&(t/=100),t},w.Property.prototype.valueOrDefault=function(t){return this.hasValue()?this.value:t},w.Property.prototype.numValueOrDefault=function(t){return this.hasValue()?this.numValue():t},w.Property.prototype.addOpacity=function(t){var e,i=this.value;return null!=t.value&&""!=t.value&&"string"==typeof this.value&&(e=new c(this.value)).ok&&(i="rgba("+e.r+", "+e.g+", "+e.b+", "+t.numValue()+")"),new w.Property(this.name,i)},w.Property.prototype.getDefinition=function(){var t=this.value.match(/#([^\)'"]+)/);return t=(t=t&&t[1])||this.value,w.Definitions[t]},w.Property.prototype.isUrlDefinition=function(){return 0==this.value.indexOf("url(")},w.Property.prototype.getFillStyleDefinition=function(t,e){var i=this.getDefinition();return null!=i&&i.createGradient?i.createGradient(w.ctx,t,e):null!=i&&i.createPattern?(i.getHrefAttribute().hasValue()&&(e=i.attribute("patternTransform"),i=i.getHrefAttribute().getDefinition(),e.hasValue()&&(i.attribute("patternTransform",!0).value=e.value)),i.createPattern(w.ctx,t)):null},w.Property.prototype.getDPI=function(t){return 96},w.Property.prototype.getEM=function(t){var e=12,i=new w.Property("fontSize",w.Font.Parse(w.ctx.font).fontSize);return e=i.hasValue()?i.toPixels(t):e},w.Property.prototype.getUnits=function(){return(this.value+"").replace(/[0-9\.\-]/g,"")},w.Property.prototype.toPixels=function(t,e){if(!this.hasValue())return 0;var i=this.value+"";if(i.match(/em$/))return this.numValue()*this.getEM(t);if(i.match(/ex$/))return this.numValue()*this.getEM(t)/2;if(i.match(/px$/))return this.numValue();if(i.match(/pt$/))return this.numValue()*this.getDPI(t)*(1/72);if(i.match(/pc$/))return 15*this.numValue();if(i.match(/cm$/))return this.numValue()*this.getDPI(t)/2.54;if(i.match(/mm$/))return this.numValue()*this.getDPI(t)/25.4;if(i.match(/in$/))return this.numValue()*this.getDPI(t);if(i.match(/%$/))return this.numValue()*w.ViewPort.ComputeSize(t);i=this.numValue();return e&&i<1?i*w.ViewPort.ComputeSize(t):i},w.Property.prototype.toMilliseconds=function(){if(!this.hasValue())return 0;var t=this.value+"";return t.match(/s$/)?1e3*this.numValue():(t.match(/ms$/),this.numValue())},w.Property.prototype.toRadians=function(){if(!this.hasValue())return 0;var t=this.value+"";return t.match(/deg$/)?this.numValue()*(Math.PI/180):t.match(/grad$/)?this.numValue()*(Math.PI/200):t.match(/rad$/)?this.numValue():this.numValue()*(Math.PI/180)};var e={baseline:"alphabetic","before-edge":"top","text-before-edge":"top",middle:"middle",central:"middle","after-edge":"bottom","text-after-edge":"bottom",ideographic:"ideographic",alphabetic:"alphabetic",hanging:"hanging",mathematical:"alphabetic"};return w.Property.prototype.toTextBaseline=function(){return this.hasValue()?e[this.value]:null},w.Font=new function(){this.Styles="normal|italic|oblique|inherit",this.Variants="normal|small-caps|inherit",this.Weights="normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900|inherit",this.CreateFont=function(t,e,i,n,r,a){a=null!=a?this.Parse(a):this.CreateFont("","","","","",w.ctx.font);return{fontFamily:r||a.fontFamily,fontSize:n||a.fontSize,fontStyle:t||a.fontStyle,fontWeight:i||a.fontWeight,fontVariant:e||a.fontVariant,toString:function(){return[this.fontStyle,this.fontVariant,this.fontWeight,this.fontSize,this.fontFamily].join(" ")}}};var s=this;this.Parse=function(t){for(var e={},i=w.trim(w.compressSpaces(t||"")).split(" "),n={fontSize:!1,fontStyle:!1,fontWeight:!1,fontVariant:!1},r="",a=0;a<i.length;a++)n.fontStyle||-1==s.Styles.indexOf(i[a])?n.fontVariant||-1==s.Variants.indexOf(i[a])?n.fontWeight||-1==s.Weights.indexOf(i[a])?n.fontSize?"inherit"!=i[a]&&(r+=i[a]):("inherit"!=i[a]&&(e.fontSize=i[a].split("/")[0]),n.fontStyle=n.fontVariant=n.fontWeight=n.fontSize=!0):("inherit"!=i[a]&&(e.fontWeight=i[a]),n.fontStyle=n.fontVariant=n.fontWeight=!0):("inherit"!=i[a]&&(e.fontVariant=i[a]),n.fontStyle=n.fontVariant=!0):("inherit"!=i[a]&&(e.fontStyle=i[a]),n.fontStyle=!0);return""!=r&&(e.fontFamily=r),e}},w.ToNumberArray=function(t){for(var e=w.trim(w.compressSpaces((t||"").replace(/,/g," "))).split(" "),i=0;i<e.length;i++)e[i]=parseFloat(e[i]);return e},w.Point=function(t,e){this.x=t,this.y=e},w.Point.prototype.angleTo=function(t){return Math.atan2(t.y-this.y,t.x-this.x)},w.Point.prototype.applyTransform=function(t){var e=this.x*t[0]+this.y*t[2]+t[4],t=this.x*t[1]+this.y*t[3]+t[5];this.x=e,this.y=t},w.CreatePoint=function(t){t=w.ToNumberArray(t);return new w.Point(t[0],t[1])},w.CreatePath=function(t){for(var e=w.ToNumberArray(t),i=[],n=0;n<e.length;n+=2)i.push(new w.Point(e[n],e[n+1]));return i},w.BoundingBox=function(t,e,n,r){this.x1=Number.NaN,this.y1=Number.NaN,this.x2=Number.NaN,this.y2=Number.NaN,this.x=function(){return this.x1},this.y=function(){return this.y1},this.width=function(){return this.x2-this.x1},this.height=function(){return this.y2-this.y1},this.addPoint=function(t,e){null!=t&&((isNaN(this.x1)||isNaN(this.x2))&&(this.x1=t,this.x2=t),t<this.x1&&(this.x1=t),t>this.x2&&(this.x2=t)),null!=e&&((isNaN(this.y1)||isNaN(this.y2))&&(this.y1=e,this.y2=e),e<this.y1&&(this.y1=e),e>this.y2&&(this.y2=e))},this.addX=function(t){this.addPoint(t,null)},this.addY=function(t){this.addPoint(null,t)},this.addBoundingBox=function(t){this.addPoint(t.x1,t.y1),this.addPoint(t.x2,t.y2)},this.addQuadraticCurve=function(t,e,i,n,r,a){i=t+2/3*(i-t),n=e+2/3*(n-e);this.addBezierCurve(t,e,i,i+1/3*(r-t),n,n+1/3*(a-e),r,a)},this.addBezierCurve=function(t,e,n,r,a,s,o,l){var c=[t,e],h=[n,r],d=[a,s],u=[o,l];for(this.addPoint(c[0],c[1]),this.addPoint(u[0],u[1]),i=0;i<=1;i++){function p(t){return Math.pow(1-t,3)*c[i]+3*Math.pow(1-t,2)*t*h[i]+3*(1-t)*Math.pow(t,2)*d[i]+Math.pow(t,3)*u[i]}var g,f=6*c[i]-12*h[i]+6*d[i],m=-3*c[i]+9*h[i]-9*d[i]+3*u[i],_=3*h[i]-3*c[i];0==m?0==f||0<(g=-_/f)&&g<1&&(0==i&&this.addX(p(g)),1==i&&this.addY(p(g))):(g=Math.pow(f,2)-4*_*m)<0||(0<(_=(-f+Math.sqrt(g))/(2*m))&&_<1&&(0==i&&this.addX(p(_)),1==i&&this.addY(p(_))),0<(_=(-f-Math.sqrt(g))/(2*m))&&_<1&&(0==i&&this.addX(p(_)),1==i&&this.addY(p(_))))}},this.isPointInBox=function(t,e){return this.x1<=t&&t<=this.x2&&this.y1<=e&&e<=this.y2},this.addPoint(t,e),this.addPoint(n,r)},w.Transform=function(t){for(var e=this,i=(this.Type={},this.Type.translate=function(t){this.p=w.CreatePoint(t),this.apply=function(t){t.translate(this.p.x||0,this.p.y||0)},this.unapply=function(t){t.translate(-1*this.p.x||0,-1*this.p.y||0)},this.applyToPoint=function(t){t.applyTransform([1,0,0,1,this.p.x||0,this.p.y||0])}},this.Type.rotate=function(t){t=w.ToNumberArray(t);this.angle=new w.Property("angle",t[0]),this.cx=t[1]||0,this.cy=t[2]||0,this.apply=function(t){t.translate(this.cx,this.cy),t.rotate(this.angle.toRadians()),t.translate(-this.cx,-this.cy)},this.unapply=function(t){t.translate(this.cx,this.cy),t.rotate(-1*this.angle.toRadians()),t.translate(-this.cx,-this.cy)},this.applyToPoint=function(t){var e=this.angle.toRadians();t.applyTransform([1,0,0,1,this.p.x||0,this.p.y||0]),t.applyTransform([Math.cos(e),Math.sin(e),-Math.sin(e),Math.cos(e),0,0]),t.applyTransform([1,0,0,1,-this.p.x||0,-this.p.y||0])}},this.Type.scale=function(t){this.p=w.CreatePoint(t),this.apply=function(t){t.scale(this.p.x||1,this.p.y||this.p.x||1)},this.unapply=function(t){t.scale(1/this.p.x||1,1/this.p.y||this.p.x||1)},this.applyToPoint=function(t){t.applyTransform([this.p.x||0,0,0,this.p.y||0,0,0])}},this.Type.matrix=function(t){this.m=w.ToNumberArray(t),this.apply=function(t){t.transform(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5])},this.unapply=function(t){var e=this.m[0],i=this.m[2],n=this.m[4],r=this.m[1],a=this.m[3],s=this.m[5],o=1/(e*(+a-0*s)-i*(+r-0*s)+n*(0*r-0*a));t.transform(o*(+a-0*s),o*(0*s-+r),o*(0*n-+i),o*(+e-0*n),o*(i*s-n*a),o*(n*r-e*s))},this.applyToPoint=function(t){t.applyTransform(this.m)}},this.Type.SkewBase=function(t){this.base=e.Type.matrix,this.base(t),this.angle=new w.Property("angle",t)},this.Type.SkewBase.prototype=new this.Type.matrix,this.Type.skewX=function(t){this.base=e.Type.SkewBase,this.base(t),this.m=[1,0,Math.tan(this.angle.toRadians()),1,0,0]},this.Type.skewX.prototype=new this.Type.SkewBase,this.Type.skewY=function(t){this.base=e.Type.SkewBase,this.base(t),this.m=[1,Math.tan(this.angle.toRadians()),0,1,0,0]},this.Type.skewY.prototype=new this.Type.SkewBase,this.transforms=[],this.apply=function(t){for(var e=0;e<this.transforms.length;e++)this.transforms[e].apply(t)},this.unapply=function(t){for(var e=this.transforms.length-1;0<=e;e--)this.transforms[e].unapply(t)},this.applyToPoint=function(t){for(var e=0;e<this.transforms.length;e++)this.transforms[e].applyToPoint(t)},w.trim(w.compressSpaces(t)).replace(/\)([a-zA-Z])/g,") $1").replace(/\)(\s?,\s?)/g,") ").split(/\s(?=[a-z])/)),n=0;n<i.length;n++){var r=w.trim(i[n].split("(")[0]),a=i[n].split("(")[1].replace(")",""),s=this.Type[r];void 0!==s&&((s=new s(a)).type=r,this.transforms.push(s))}},w.AspectRatio=function(t,e,i,n,r,a,s,o,l,c){var h=(e=(e=w.compressSpaces(e)).replace(/^defer\s/,"")).split(" ")[0]||"xMidYMid",e=e.split(" ")[1]||"meet",d=i/n,u=r/a,p=Math.min(d,u),g=Math.max(d,u);"meet"==e&&(n*=p,a*=p),"slice"==e&&(n*=g,a*=g),l=new w.Property("refX",l),c=new w.Property("refY",c),l.hasValue()&&c.hasValue()?t.translate(-p*l.toPixels("x"),-p*c.toPixels("y")):(h.match(/^xMid/)&&("meet"==e&&p==u||"slice"==e&&g==u)&&t.translate(i/2-n/2,0),h.match(/YMid$/)&&("meet"==e&&p==d||"slice"==e&&g==d)&&t.translate(0,r/2-a/2),h.match(/^xMax/)&&("meet"==e&&p==u||"slice"==e&&g==u)&&t.translate(i-n,0),h.match(/YMax$/)&&("meet"==e&&p==d||"slice"==e&&g==d)&&t.translate(0,r-a)),"none"==h?t.scale(d,u):"meet"==e?t.scale(p,p):"slice"==e&&t.scale(g,g),t.translate(null==s?0:-s,null==o?0:-o)},w.Element={},w.EmptyProperty=new w.Property("EMPTY",""),w.Element.ElementBase=function(a){this.attributes={},this.styles={},this.stylesSpecificity={},this.children=[],this.attribute=function(t,e){var i=this.attributes[t];return null!=i?i:(1==e&&(i=new w.Property(t,""),this.attributes[t]=i),i||w.EmptyProperty)},this.getHrefAttribute=function(){for(var t in this.attributes)if("href"==t||t.match(/:href$/))return this.attributes[t];return w.EmptyProperty},this.style=function(t,e,i){var n=this.styles[t];if(null!=n)return n;var r=this.attribute(t);if(null!=r&&r.hasValue())return this.styles[t]=r;if(1!=i){r=this.parent;if(null!=r){i=r.style(t);if(null!=i&&i.hasValue())return i}}return 1==e&&(n=new w.Property(t,""),this.styles[t]=n),n||w.EmptyProperty},this.render=function(t){var e;"none"!=this.style("display").value&&"hidden"!=this.style("visibility").value&&(t.save(),this.style("mask").hasValue()?null!=(e=this.style("mask").getDefinition())&&e.apply(t,this):this.style("filter").hasValue()?null!=(e=this.style("filter").getDefinition())&&e.apply(t,this):(this.setContext(t),this.renderChildren(t),this.clearContext(t)),t.restore())},this.setContext=function(t){},this.clearContext=function(t){},this.renderChildren=function(t){for(var e=0;e<this.children.length;e++)this.children[e].render(t)},this.addChild=function(t,e){var i=t;(i=e?w.CreateElement(t):i).parent=this,"title"!=i.type&&this.children.push(i)},this.addStylesFromStyleDefinition=function(){for(var t in w.Styles)if("@"!=t[0]&&u(a,t)){var e=w.Styles[t],i=w.StylesSpecificity[t];if(null!=e)for(var n in e){var r=this.stylesSpecificity[n];(r=void 0===r?"000":r)<i&&(this.styles[n]=e[n],this.stylesSpecificity[n]=i)}}};var t=new RegExp("^[A-Z-]+$");if(null!=a&&1==a.nodeType){for(var e=0;e<a.attributes.length;e++){var i=a.attributes[e],n=(n=i.nodeName,t.test(n)?n.toLowerCase():n);this.attributes[n]=new w.Property(n,i.value)}if(this.addStylesFromStyleDefinition(),this.attribute("style").hasValue())for(var r,s,o=this.attribute("style").value.split(";"),e=0;e<o.length;e++)""!=w.trim(o[e])&&(s=o[e].split(":"),r=w.trim(s[0]),s=w.trim(s[1]),this.styles[r]=new w.Property(r,s));this.attribute("id").hasValue()&&null==w.Definitions[this.attribute("id").value]&&(w.Definitions[this.attribute("id").value]=this);for(e=0;e<a.childNodes.length;e++){var l,c=a.childNodes[e];1==c.nodeType&&this.addChild(c,!0),!this.captureTextNodes||3!=c.nodeType&&4!=c.nodeType||(l=c.value||c.text||c.textContent||"",""!=w.compressSpaces(l)&&this.addChild(new w.Element.tspan(c),!1))}}},w.Element.RenderedElementBase=function(t){this.base=w.Element.ElementBase,this.base(t),this.setContext=function(t){var e,i,n;this.style("fill").isUrlDefinition()?null!=(e=this.style("fill").getFillStyleDefinition(this,this.style("fill-opacity")))&&(t.fillStyle=e):this.style("fill").hasValue()&&("currentColor"==(n=this.style("fill")).value&&(n.value=this.style("color").value),"inherit"!=n.value&&(t.fillStyle="none"==n.value?"rgba(0,0,0,0)":n.value)),this.style("fill-opacity").hasValue()&&(n=(n=new w.Property("fill",t.fillStyle)).addOpacity(this.style("fill-opacity")),t.fillStyle=n.value),this.style("stroke").isUrlDefinition()?null!=(e=this.style("stroke").getFillStyleDefinition(this,this.style("stroke-opacity")))&&(t.strokeStyle=e):this.style("stroke").hasValue()&&("currentColor"==(i=this.style("stroke")).value&&(i.value=this.style("color").value),"inherit"!=i.value&&(t.strokeStyle="none"==i.value?"rgba(0,0,0,0)":i.value)),this.style("stroke-opacity").hasValue()&&(i=(i=new w.Property("stroke",t.strokeStyle)).addOpacity(this.style("stroke-opacity")),t.strokeStyle=i.value),this.style("stroke-width").hasValue()&&(n=this.style("stroke-width").toPixels(),t.lineWidth=0==n?.001:n),this.style("stroke-linecap").hasValue()&&(t.lineCap=this.style("stroke-linecap").value),this.style("stroke-linejoin").hasValue()&&(t.lineJoin=this.style("stroke-linejoin").value),this.style("stroke-miterlimit").hasValue()&&(t.miterLimit=this.style("stroke-miterlimit").value),this.style("stroke-dasharray").hasValue()&&"none"!=this.style("stroke-dasharray").value&&(e=w.ToNumberArray(this.style("stroke-dasharray").value),void 0!==t.setLineDash?t.setLineDash(e):void 0!==t.webkitLineDash?t.webkitLineDash=e:void 0===t.mozDash||1==e.length&&0==e[0]||(t.mozDash=e),i=this.style("stroke-dashoffset").numValueOrDefault(1),void 0!==t.lineDashOffset?t.lineDashOffset=i:void 0!==t.webkitLineDashOffset?t.webkitLineDashOffset=i:void 0!==t.mozDashOffset&&(t.mozDashOffset=i)),void 0!==t.font&&(t.font=w.Font.CreateFont(this.style("font-style").value,this.style("font-variant").value,this.style("font-weight").value,this.style("font-size").hasValue()?this.style("font-size").toPixels()+"px":"",this.style("font-family").value).toString()),this.style("transform",!1,!0).hasValue()&&new w.Transform(this.style("transform",!1,!0).value).apply(t),this.style("clip-path",!1,!0).hasValue()&&null!=(n=this.style("clip-path",!1,!0).getDefinition())&&n.apply(t),this.style("opacity").hasValue()&&(t.globalAlpha=this.style("opacity").numValue(),0==t.globalAlpha&&(t.globalAlpha=.001))}},w.Element.RenderedElementBase.prototype=new w.Element.ElementBase,w.Element.PathElementBase=function(t){this.base=w.Element.RenderedElementBase,this.base(t),this.path=function(t){return null!=t&&t.beginPath(),new w.BoundingBox},this.renderChildren=function(t){this.path(t),w.Mouse.checkPath(this,t),""!=t.fillStyle&&("inherit"!=this.style("fill-rule").valueOrDefault("inherit")?t.fill(this.style("fill-rule").value):t.fill()),""!=t.strokeStyle&&t.stroke();var e=this.getMarkers();if(null!=e){if(this.style("marker-start").isUrlDefinition()&&(i=this.style("marker-start").getDefinition()).render(t,e[0][0],e[0][1]),this.style("marker-mid").isUrlDefinition())for(var i=this.style("marker-mid").getDefinition(),n=1;n<e.length-1;n++)i.render(t,e[n][0],e[n][1]);this.style("marker-end").isUrlDefinition()&&(i=this.style("marker-end").getDefinition()).render(t,e[e.length-1][0],e[e.length-1][1])}},this.getBoundingBox=function(){return this.path()},this.getMarkers=function(){return null}},w.Element.PathElementBase.prototype=new w.Element.RenderedElementBase,w.Element.svg=function(t){this.base=w.Element.RenderedElementBase,this.base(t),this.baseClearContext=this.clearContext,this.clearContext=function(t){this.baseClearContext(t),w.ViewPort.RemoveCurrent()},this.baseSetContext=this.setContext,this.setContext=function(t){t.strokeStyle="rgba(0,0,0,0)",t.lineCap="butt",t.lineJoin="miter",t.miterLimit=4,void 0!==t.font&&void 0!==window.getComputedStyle&&(t.font=window.getComputedStyle(t.canvas).getPropertyValue("font")),this.baseSetContext(t),this.attribute("x").hasValue()||(this.attribute("x",!0).value=0),this.attribute("y").hasValue()||(this.attribute("y",!0).value=0),t.translate(this.attribute("x").toPixels("x"),this.attribute("y").toPixels("y"));var e,i,n,r=w.ViewPort.width(),a=w.ViewPort.height();this.attribute("width").hasValue()||(this.attribute("width",!0).value="100%"),this.attribute("height").hasValue()||(this.attribute("height",!0).value="100%"),void 0===this.root&&(r=this.attribute("width").toPixels("x"),a=this.attribute("height").toPixels("y"),e=i=0,this.attribute("refX").hasValue()&&this.attribute("refY").hasValue()&&(i=-this.attribute("refX").toPixels("x"),e=-this.attribute("refY").toPixels("y")),"visible"!=this.attribute("overflow").valueOrDefault("hidden")&&(t.beginPath(),t.moveTo(i,e),t.lineTo(r,e),t.lineTo(r,a),t.lineTo(i,a),t.closePath(),t.clip())),w.ViewPort.SetCurrent(r,a),this.attribute("viewBox").hasValue()&&(i=(e=w.ToNumberArray(this.attribute("viewBox").value))[0],n=e[1],r=e[2],a=e[3],w.AspectRatio(t,this.attribute("preserveAspectRatio").value,w.ViewPort.width(),r,w.ViewPort.height(),a,i,n,this.attribute("refX").value,this.attribute("refY").value),w.ViewPort.RemoveCurrent(),w.ViewPort.SetCurrent(e[2],e[3]))}},w.Element.svg.prototype=new w.Element.RenderedElementBase,w.Element.rect=function(t){this.base=w.Element.PathElementBase,this.base(t),this.path=function(t){var e=this.attribute("x").toPixels("x"),i=this.attribute("y").toPixels("y"),n=this.attribute("width").toPixels("x"),r=this.attribute("height").toPixels("y"),a=this.attribute("rx").toPixels("x"),s=this.attribute("ry").toPixels("y");return this.attribute("rx").hasValue()&&!this.attribute("ry").hasValue()&&(s=a),this.attribute("ry").hasValue()&&!this.attribute("rx").hasValue()&&(a=s),a=Math.min(a,n/2),s=Math.min(s,r/2),null!=t&&(t.beginPath(),t.moveTo(e+a,i),t.lineTo(e+n-a,i),t.quadraticCurveTo(e+n,i,e+n,i+s),t.lineTo(e+n,i+r-s),t.quadraticCurveTo(e+n,i+r,e+n-a,i+r),t.lineTo(e+a,i+r),t.quadraticCurveTo(e,i+r,e,i+r-s),t.lineTo(e,i+s),t.quadraticCurveTo(e,i,e+a,i),t.closePath()),new w.BoundingBox(e,i,e+n,i+r)}},w.Element.rect.prototype=new w.Element.PathElementBase,w.Element.circle=function(t){this.base=w.Element.PathElementBase,this.base(t),this.path=function(t){var e=this.attribute("cx").toPixels("x"),i=this.attribute("cy").toPixels("y"),n=this.attribute("r").toPixels();return null!=t&&(t.beginPath(),t.arc(e,i,n,0,2*Math.PI,!0),t.closePath()),new w.BoundingBox(e-n,i-n,e+n,i+n)}},w.Element.circle.prototype=new w.Element.PathElementBase,w.Element.ellipse=function(t){this.base=w.Element.PathElementBase,this.base(t),this.path=function(t){var e=(Math.sqrt(2)-1)/3*4,i=this.attribute("rx").toPixels("x"),n=this.attribute("ry").toPixels("y"),r=this.attribute("cx").toPixels("x"),a=this.attribute("cy").toPixels("y");return null!=t&&(t.beginPath(),t.moveTo(r,a-n),t.bezierCurveTo(r+e*i,a-n,r+i,a-e*n,r+i,a),t.bezierCurveTo(r+i,a+e*n,r+e*i,a+n,r,a+n),t.bezierCurveTo(r-e*i,a+n,r-i,a+e*n,r-i,a),t.bezierCurveTo(r-i,a-e*n,r-e*i,a-n,r,a-n),t.closePath()),new w.BoundingBox(r-i,a-n,r+i,a+n)}},w.Element.ellipse.prototype=new w.Element.PathElementBase,w.Element.line=function(t){this.base=w.Element.PathElementBase,this.base(t),this.getPoints=function(){return[new w.Point(this.attribute("x1").toPixels("x"),this.attribute("y1").toPixels("y")),new w.Point(this.attribute("x2").toPixels("x"),this.attribute("y2").toPixels("y"))]},this.path=function(t){var e=this.getPoints();return null!=t&&(t.beginPath(),t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y)),new w.BoundingBox(e[0].x,e[0].y,e[1].x,e[1].y)},this.getMarkers=function(){var t=this.getPoints(),e=t[0].angleTo(t[1]);return[[t[0],e],[t[1],e]]}},w.Element.line.prototype=new w.Element.PathElementBase,w.Element.polyline=function(t){this.base=w.Element.PathElementBase,this.base(t),this.points=w.CreatePath(this.attribute("points").value),this.path=function(t){var e=new w.BoundingBox(this.points[0].x,this.points[0].y);null!=t&&(t.beginPath(),t.moveTo(this.points[0].x,this.points[0].y));for(var i=1;i<this.points.length;i++)e.addPoint(this.points[i].x,this.points[i].y),null!=t&&t.lineTo(this.points[i].x,this.points[i].y);return e},this.getMarkers=function(){for(var t=[],e=0;e<this.points.length-1;e++)t.push([this.points[e],this.points[e].angleTo(this.points[e+1])]);return 0<t.length&&t.push([this.points[this.points.length-1],t[t.length-1][1]]),t}},w.Element.polyline.prototype=new w.Element.PathElementBase,w.Element.polygon=function(t){this.base=w.Element.polyline,this.base(t),this.basePath=this.path,this.path=function(t){var e=this.basePath(t);return null!=t&&(t.lineTo(this.points[0].x,this.points[0].y),t.closePath()),e}},w.Element.polygon.prototype=new w.Element.polyline,w.Element.path=function(t){this.base=w.Element.PathElementBase,this.base(t);for(var e=(e=this.attribute("d").value).replace(/,/gm," "),i=0;i<2;i++)e=e.replace(/([MmZzLlHhVvCcSsQqTtAa])([^\s])/gm,"$1 $2");e=(e=e.replace(/([^\s])([MmZzLlHhVvCcSsQqTtAa])/gm,"$1 $2")).replace(/([0-9])([+\-])/gm,"$1 $2");for(i=0;i<2;i++)e=e.replace(/(\.[0-9]*)(\.)/gm,"$1 $2");e=e.replace(/([Aa](\s+[0-9]+){3})\s+([01])\s*([01])/gm,"$1 $3 $4 "),e=w.compressSpaces(e),e=w.trim(e),this.PathParser=new function(t){this.tokens=t.split(" "),this.reset=function(){this.i=-1,this.command="",this.previousCommand="",this.start=new w.Point(0,0),this.control=new w.Point(0,0),this.current=new w.Point(0,0),this.points=[],this.angles=[]},this.isEnd=function(){return this.i>=this.tokens.length-1},this.isCommandOrEnd=function(){return!!this.isEnd()||null!=this.tokens[this.i+1].match(/^[A-Za-z]$/)},this.isRelativeCommand=function(){switch(this.command){case"m":case"l":case"h":case"v":case"c":case"s":case"q":case"t":case"a":case"z":return!0}return!1},this.getToken=function(){return this.i++,this.tokens[this.i]},this.getScalar=function(){return parseFloat(this.getToken())},this.nextCommand=function(){this.previousCommand=this.command,this.command=this.getToken()},this.getPoint=function(){var t=new w.Point(this.getScalar(),this.getScalar());return this.makeAbsolute(t)},this.getAsControlPoint=function(){var t=this.getPoint();return this.control=t},this.getAsCurrentPoint=function(){var t=this.getPoint();return this.current=t},this.getReflectedControlPoint=function(){return"c"!=this.previousCommand.toLowerCase()&&"s"!=this.previousCommand.toLowerCase()&&"q"!=this.previousCommand.toLowerCase()&&"t"!=this.previousCommand.toLowerCase()?this.current:new w.Point(2*this.current.x-this.control.x,2*this.current.y-this.control.y)},this.makeAbsolute=function(t){return this.isRelativeCommand()&&(t.x+=this.current.x,t.y+=this.current.y),t},this.addMarker=function(t,e,i){null!=i&&0<this.angles.length&&null==this.angles[this.angles.length-1]&&(this.angles[this.angles.length-1]=this.points[this.points.length-1].angleTo(i)),this.addMarkerAngle(t,null==e?null:e.angleTo(t))},this.addMarkerAngle=function(t,e){this.points.push(t),this.angles.push(e)},this.getMarkerPoints=function(){return this.points},this.getMarkerAngles=function(){for(var t=0;t<this.angles.length;t++)if(null==this.angles[t])for(var e=t+1;e<this.angles.length;e++)if(null!=this.angles[e]){this.angles[t]=this.angles[e];break}return this.angles}}(e),this.path=function(t){var e=this.PathParser,i=(e.reset(),new w.BoundingBox);for(null!=t&&t.beginPath();!e.isEnd();)switch(e.nextCommand(),e.command){case"M":case"m":var n=e.getAsCurrentPoint();for(e.addMarker(n),i.addPoint(n.x,n.y),null!=t&&t.moveTo(n.x,n.y),e.start=e.current;!e.isCommandOrEnd();){n=e.getAsCurrentPoint();e.addMarker(n,e.start),i.addPoint(n.x,n.y),null!=t&&t.lineTo(n.x,n.y)}break;case"L":case"l":for(;!e.isCommandOrEnd();){var r=e.current,n=e.getAsCurrentPoint();e.addMarker(n,r),i.addPoint(n.x,n.y),null!=t&&t.lineTo(n.x,n.y)}break;case"H":case"h":for(;!e.isCommandOrEnd();){var a=new w.Point((e.isRelativeCommand()?e.current.x:0)+e.getScalar(),e.current.y);e.addMarker(a,e.current),e.current=a,i.addPoint(e.current.x,e.current.y),null!=t&&t.lineTo(e.current.x,e.current.y)}break;case"V":case"v":for(;!e.isCommandOrEnd();){a=new w.Point(e.current.x,(e.isRelativeCommand()?e.current.y:0)+e.getScalar());e.addMarker(a,e.current),e.current=a,i.addPoint(e.current.x,e.current.y),null!=t&&t.lineTo(e.current.x,e.current.y)}break;case"C":case"c":for(;!e.isCommandOrEnd();){var s=e.current,o=e.getPoint(),l=e.getAsControlPoint(),c=e.getAsCurrentPoint();e.addMarker(c,l,o),i.addBezierCurve(s.x,s.y,o.x,o.y,l.x,l.y,c.x,c.y),null!=t&&t.bezierCurveTo(o.x,o.y,l.x,l.y,c.x,c.y)}break;case"S":case"s":for(;!e.isCommandOrEnd();){s=e.current,o=e.getReflectedControlPoint(),l=e.getAsControlPoint(),c=e.getAsCurrentPoint();e.addMarker(c,l,o),i.addBezierCurve(s.x,s.y,o.x,o.y,l.x,l.y,c.x,c.y),null!=t&&t.bezierCurveTo(o.x,o.y,l.x,l.y,c.x,c.y)}break;case"Q":case"q":for(;!e.isCommandOrEnd();){s=e.current,l=e.getAsControlPoint(),c=e.getAsCurrentPoint();e.addMarker(c,l,l),i.addQuadraticCurve(s.x,s.y,l.x,l.y,c.x,c.y),null!=t&&t.quadraticCurveTo(l.x,l.y,c.x,c.y)}break;case"T":case"t":for(;!e.isCommandOrEnd();){s=e.current,l=e.getReflectedControlPoint(),c=(e.control=l,e.getAsCurrentPoint());e.addMarker(c,l,l),i.addQuadraticCurve(s.x,s.y,l.x,l.y,c.x,c.y),null!=t&&t.quadraticCurveTo(l.x,l.y,c.x,c.y)}break;case"A":case"a":for(;!e.isCommandOrEnd();){function h(t,e){return(t[0]*e[1]<t[1]*e[0]?-1:1)*Math.acos(y(t,e))}var s=e.current,d=e.getScalar(),u=e.getScalar(),p=e.getScalar()*(Math.PI/180),g=e.getScalar(),f=e.getScalar(),c=e.getAsCurrentPoint(),m=new w.Point(Math.cos(p)*(s.x-c.x)/2+Math.sin(p)*(s.y-c.y)/2,-Math.sin(p)*(s.x-c.x)/2+Math.cos(p)*(s.y-c.y)/2),_=Math.pow(m.x,2)/Math.pow(d,2)+Math.pow(m.y,2)/Math.pow(u,2),_=(1<_&&(d*=Math.sqrt(_),u*=Math.sqrt(_)),(g==f?-1:1)*Math.sqrt((Math.pow(d,2)*Math.pow(u,2)-Math.pow(d,2)*Math.pow(m.y,2)-Math.pow(u,2)*Math.pow(m.x,2))/(Math.pow(d,2)*Math.pow(m.y,2)+Math.pow(u,2)*Math.pow(m.x,2)))),g=(isNaN(_)&&(_=0),new w.Point(_*d*m.y/u,_*-u*m.x/d)),_=new w.Point((s.x+c.x)/2+Math.cos(p)*g.x-Math.sin(p)*g.y,(s.y+c.y)/2+Math.sin(p)*g.x+Math.cos(p)*g.y),v=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2))},y=function(t,e){return(t[0]*e[0]+t[1]*e[1])/(v(t)*v(e))},b=h([1,0],[(m.x-g.x)/d,(m.y-g.y)/u]),C=[(m.x-g.x)/d,(m.y-g.y)/u],m=[(-m.x-g.x)/d,(-m.y-g.y)/u],g=h(C,m),x=(y(C,m)<=-1&&(g=Math.PI),1-f?1:-1),C=b+(g=1<=y(C,m)?0:g)/2*x,m=new w.Point(_.x+d*Math.cos(C),_.y+u*Math.sin(C));e.addMarkerAngle(m,C-x*Math.PI/2),e.addMarkerAngle(c,C-x*Math.PI),i.addPoint(c.x,c.y),null!=t&&(y=u<d?d:u,m=u<d?1:d/u,C=u<d?u/d:1,t.translate(_.x,_.y),t.rotate(p),t.scale(m,C),t.arc(0,0,y,b,b+g,1-f),t.scale(1/m,1/C),t.rotate(-p),t.translate(-_.x,-_.y))}break;case"Z":case"z":null!=t&&t.closePath(),e.current=e.start}return i},this.getMarkers=function(){for(var t=this.PathParser.getMarkerPoints(),e=this.PathParser.getMarkerAngles(),i=[],n=0;n<t.length;n++)i.push([t[n],e[n]]);return i}},w.Element.path.prototype=new w.Element.PathElementBase,w.Element.pattern=function(t){this.base=w.Element.ElementBase,this.base(t),this.createPattern=function(t,e){var i=this.attribute("width").toPixels("x",!0),n=this.attribute("height").toPixels("y",!0),r=new w.Element.svg,a=(r.attributes.viewBox=new w.Property("viewBox",this.attribute("viewBox").value),r.attributes.width=new w.Property("width",i+"px"),r.attributes.height=new w.Property("height",n+"px"),r.attributes.transform=new w.Property("transform",this.attribute("patternTransform").value),r.children=this.children,document.createElement("canvas")),s=(a.width=i,a.height=n,a.getContext("2d"));this.attribute("x").hasValue()&&this.attribute("y").hasValue()&&s.translate(this.attribute("x").toPixels("x",!0),this.attribute("y").toPixels("y",!0));for(var o=-1;o<=1;o++)for(var l=-1;l<=1;l++)s.save(),r.attributes.x=new w.Property("x",o*a.width),r.attributes.y=new w.Property("y",l*a.height),r.render(s),s.restore();return t.createPattern(a,"repeat")}},w.Element.pattern.prototype=new w.Element.ElementBase,w.Element.marker=function(t){this.base=w.Element.ElementBase,this.base(t),this.baseRender=this.render,this.render=function(t,e,i){t.translate(e.x,e.y),"auto"==this.attribute("orient").valueOrDefault("auto")&&t.rotate(i),"strokeWidth"==this.attribute("markerUnits").valueOrDefault("strokeWidth")&&t.scale(t.lineWidth,t.lineWidth),t.save();var n=new w.Element.svg;n.attributes.viewBox=new w.Property("viewBox",this.attribute("viewBox").value),n.attributes.refX=new w.Property("refX",this.attribute("refX").value),n.attributes.refY=new w.Property("refY",this.attribute("refY").value),n.attributes.width=new w.Property("width",this.attribute("markerWidth").value),n.attributes.height=new w.Property("height",this.attribute("markerHeight").value),n.attributes.fill=new w.Property("fill",this.attribute("fill").valueOrDefault("black")),n.attributes.stroke=new w.Property("stroke",this.attribute("stroke").valueOrDefault("none")),n.children=this.children,n.render(t),t.restore(),"strokeWidth"==this.attribute("markerUnits").valueOrDefault("strokeWidth")&&t.scale(1/t.lineWidth,1/t.lineWidth),"auto"==this.attribute("orient").valueOrDefault("auto")&&t.rotate(-i),t.translate(-e.x,-e.y)}},w.Element.marker.prototype=new w.Element.ElementBase,w.Element.defs=function(t){this.base=w.Element.ElementBase,this.base(t),this.render=function(t){}},w.Element.defs.prototype=new w.Element.ElementBase,w.Element.GradientBase=function(t){this.base=w.Element.ElementBase,this.base(t),this.stops=[];for(var e=0;e<this.children.length;e++){var i=this.children[e];"stop"==i.type&&this.stops.push(i)}this.getGradient=function(){},this.gradientUnits=function(){return this.attribute("gradientUnits").valueOrDefault("objectBoundingBox")},this.attributesToInherit=["gradientUnits"],this.inheritStopContainer=function(t){for(var e=0;e<this.attributesToInherit.length;e++){var i=this.attributesToInherit[e];!this.attribute(i).hasValue()&&t.attribute(i).hasValue()&&(this.attribute(i,!0).value=t.attribute(i).value)}},this.createGradient=function(t,e,i){function n(t){return i.hasValue()?new w.Property("color",t).addOpacity(i).value:t}var r=this,a=(this.getHrefAttribute().hasValue()&&(r=this.getHrefAttribute().getDefinition(),this.inheritStopContainer(r)),this.getGradient(t,e));if(null==a)return n(r.stops[r.stops.length-1].color);for(var s,o=0;o<r.stops.length;o++)a.addColorStop(r.stops[o].offset,n(r.stops[o].color));return this.attribute("gradientTransform").hasValue()?(t=w.ViewPort.viewPorts[0],(e=new w.Element.rect).attributes.x=new w.Property("x",-w.MAX_VIRTUAL_PIXELS/3),e.attributes.y=new w.Property("y",-w.MAX_VIRTUAL_PIXELS/3),e.attributes.width=new w.Property("width",w.MAX_VIRTUAL_PIXELS),e.attributes.height=new w.Property("height",w.MAX_VIRTUAL_PIXELS),(s=new w.Element.g).attributes.transform=new w.Property("transform",this.attribute("gradientTransform").value),s.children=[e],(e=new w.Element.svg).attributes.x=new w.Property("x",0),e.attributes.y=new w.Property("y",0),e.attributes.width=new w.Property("width",t.width),e.attributes.height=new w.Property("height",t.height),e.children=[s],(s=document.createElement("canvas")).width=t.width,s.height=t.height,(t=s.getContext("2d")).fillStyle=a,e.render(t),t.createPattern(s,"no-repeat")):a}},w.Element.GradientBase.prototype=new w.Element.ElementBase,w.Element.linearGradient=function(t){this.base=w.Element.GradientBase,this.base(t),this.attributesToInherit.push("x1"),this.attributesToInherit.push("y1"),this.attributesToInherit.push("x2"),this.attributesToInherit.push("y2"),this.getGradient=function(t,e){var e="objectBoundingBox"==this.gradientUnits()?e.getBoundingBox():null,i=(this.attribute("x1").hasValue()||this.attribute("y1").hasValue()||this.attribute("x2").hasValue()||this.attribute("y2").hasValue()||(this.attribute("x1",!0).value=0,this.attribute("y1",!0).value=0,this.attribute("x2",!0).value=1,this.attribute("y2",!0).value=0),"objectBoundingBox"==this.gradientUnits()?e.x()+e.width()*this.attribute("x1").numValue():this.attribute("x1").toPixels("x")),n="objectBoundingBox"==this.gradientUnits()?e.y()+e.height()*this.attribute("y1").numValue():this.attribute("y1").toPixels("y"),r="objectBoundingBox"==this.gradientUnits()?e.x()+e.width()*this.attribute("x2").numValue():this.attribute("x2").toPixels("x"),e="objectBoundingBox"==this.gradientUnits()?e.y()+e.height()*this.attribute("y2").numValue():this.attribute("y2").toPixels("y");return i==r&&n==e?null:t.createLinearGradient(i,n,r,e)}},w.Element.linearGradient.prototype=new w.Element.GradientBase,w.Element.radialGradient=function(t){this.base=w.Element.GradientBase,this.base(t),this.attributesToInherit.push("cx"),this.attributesToInherit.push("cy"),this.attributesToInherit.push("r"),this.attributesToInherit.push("fx"),this.attributesToInherit.push("fy"),this.getGradient=function(t,e){var e=e.getBoundingBox(),i=(this.attribute("cx").hasValue()||(this.attribute("cx",!0).value="50%"),this.attribute("cy").hasValue()||(this.attribute("cy",!0).value="50%"),this.attribute("r").hasValue()||(this.attribute("r",!0).value="50%"),"objectBoundingBox"==this.gradientUnits()?e.x()+e.width()*this.attribute("cx").numValue():this.attribute("cx").toPixels("x")),n="objectBoundingBox"==this.gradientUnits()?e.y()+e.height()*this.attribute("cy").numValue():this.attribute("cy").toPixels("y"),r=i,a=n,e=(this.attribute("fx").hasValue()&&(r="objectBoundingBox"==this.gradientUnits()?e.x()+e.width()*this.attribute("fx").numValue():this.attribute("fx").toPixels("x")),this.attribute("fy").hasValue()&&(a="objectBoundingBox"==this.gradientUnits()?e.y()+e.height()*this.attribute("fy").numValue():this.attribute("fy").toPixels("y")),"objectBoundingBox"==this.gradientUnits()?(e.width()+e.height())/2*this.attribute("r").numValue():this.attribute("r").toPixels());return t.createRadialGradient(r,a,0,i,n,e)}},w.Element.radialGradient.prototype=new w.Element.GradientBase,w.Element.stop=function(t){this.base=w.Element.ElementBase,this.base(t),this.offset=this.attribute("offset").numValue(),this.offset<0&&(this.offset=0),1<this.offset&&(this.offset=1);t=this.style("stop-color",!0);""===t.value&&(t.value="#000"),this.style("stop-opacity").hasValue()&&(t=t.addOpacity(this.style("stop-opacity"))),this.color=t.value},w.Element.stop.prototype=new w.Element.ElementBase,w.Element.AnimateBase=function(t){this.base=w.Element.ElementBase,this.base(t),w.Animations.push(this),this.duration=0,this.begin=this.attribute("begin").toMilliseconds(),this.maxDuration=this.begin+this.attribute("dur").toMilliseconds(),this.getProperty=function(){var t=this.attribute("attributeType").value,e=this.attribute("attributeName").value;return"CSS"==t?this.parent.style(e,!0):this.parent.attribute(e,!0)},this.initialValue=null,this.initialUnits="",this.removed=!1,this.calcValue=function(){return""},this.update=function(t){if(null==this.initialValue&&(this.initialValue=this.getProperty().value,this.initialUnits=this.getProperty().getUnits()),this.duration>this.maxDuration){if("indefinite"==this.attribute("repeatCount").value||"indefinite"==this.attribute("repeatDur").value)this.duration=0;else if("freeze"!=this.attribute("fill").valueOrDefault("remove")||this.frozen){if("remove"==this.attribute("fill").valueOrDefault("remove")&&!this.removed)return this.removed=!0,this.getProperty().value=this.parent.animationFrozen?this.parent.animationFrozenValue:this.initialValue,!0}else this.frozen=!0,this.parent.animationFrozen=!0,this.parent.animationFrozenValue=this.getProperty().value;return!1}this.duration=this.duration+t;var e,t=!1;return this.begin<this.duration&&(e=this.calcValue(),this.attribute("type").hasValue()&&(e=this.attribute("type").value+"("+e+")"),this.getProperty().value=e,t=!0),t},this.from=this.attribute("from"),this.to=this.attribute("to"),this.values=this.attribute("values"),this.values.hasValue()&&(this.values.value=this.values.value.split(";")),this.progress=function(){var t,e,i,n={progress:(this.duration-this.begin)/(this.maxDuration-this.begin)};return this.values.hasValue()?(t=n.progress*(this.values.value.length-1),e=Math.floor(t),i=Math.ceil(t),n.from=new w.Property("from",parseFloat(this.values.value[e])),n.to=new w.Property("to",parseFloat(this.values.value[i])),n.progress=(t-e)/(i-e)):(n.from=this.from,n.to=this.to),n}},w.Element.AnimateBase.prototype=new w.Element.ElementBase,w.Element.animate=function(t){this.base=w.Element.AnimateBase,this.base(t),this.calcValue=function(){var t=this.progress();return t.from.numValue()+(t.to.numValue()-t.from.numValue())*t.progress+this.initialUnits}},w.Element.animate.prototype=new w.Element.AnimateBase,w.Element.animateColor=function(t){this.base=w.Element.AnimateBase,this.base(t),this.calcValue=function(){var t,e,i=this.progress(),n=new c(i.from.value),r=new c(i.to.value);return n.ok&&r.ok?(t=n.r+(r.r-n.r)*i.progress,e=n.g+(r.g-n.g)*i.progress,r=n.b+(r.b-n.b)*i.progress,"rgb("+parseInt(t,10)+","+parseInt(e,10)+","+parseInt(r,10)+")"):this.attribute("from").value}},w.Element.animateColor.prototype=new w.Element.AnimateBase,w.Element.animateTransform=function(t){this.base=w.Element.AnimateBase,this.base(t),this.calcValue=function(){for(var t=this.progress(),e=w.ToNumberArray(t.from.value),i=w.ToNumberArray(t.to.value),n="",r=0;r<e.length;r++)n+=e[r]+(i[r]-e[r])*t.progress+" ";return n}},w.Element.animateTransform.prototype=new w.Element.animate,w.Element.font=function(t){this.base=w.Element.ElementBase,this.base(t),this.horizAdvX=this.attribute("horiz-adv-x").numValue(),this.isRTL=!1,this.isArabic=!1,this.fontFace=null,this.missingGlyph=null,this.glyphs=[];for(var e=0;e<this.children.length;e++){var i=this.children[e];"font-face"==i.type?(this.fontFace=i).style("font-family").hasValue()&&(w.Definitions[i.style("font-family").value]=this):"missing-glyph"==i.type?this.missingGlyph=i:"glyph"==i.type&&(""!=i.arabicForm?(this.isRTL=!0,this.isArabic=!0,void 0===this.glyphs[i.unicode]&&(this.glyphs[i.unicode]=[]),this.glyphs[i.unicode][i.arabicForm]=i):this.glyphs[i.unicode]=i)}},w.Element.font.prototype=new w.Element.ElementBase,w.Element.fontface=function(t){this.base=w.Element.ElementBase,this.base(t),this.ascent=this.attribute("ascent").value,this.descent=this.attribute("descent").value,this.unitsPerEm=this.attribute("units-per-em").numValue()},w.Element.fontface.prototype=new w.Element.ElementBase,w.Element.missingglyph=function(t){this.base=w.Element.path,this.base(t),this.horizAdvX=0},w.Element.missingglyph.prototype=new w.Element.path,w.Element.glyph=function(t){this.base=w.Element.path,this.base(t),this.horizAdvX=this.attribute("horiz-adv-x").numValue(),this.unicode=this.attribute("unicode").value,this.arabicForm=this.attribute("arabic-form").value},w.Element.glyph.prototype=new w.Element.path,w.Element.text=function(t){this.captureTextNodes=!0,this.base=w.Element.RenderedElementBase,this.base(t),this.baseSetContext=this.setContext,this.setContext=function(t){this.baseSetContext(t);var e=this.style("dominant-baseline").toTextBaseline();null!=(e=null==e?this.style("alignment-baseline").toTextBaseline():e)&&(t.textBaseline=e)},this.getBoundingBox=function(){var t=this.attribute("x").toPixels("x"),e=this.attribute("y").toPixels("y"),i=this.parent.style("font-size").numValueOrDefault(w.Font.Parse(w.ctx.font).fontSize);return new w.BoundingBox(t,e-i,t+Math.floor(2*i/3)*this.children[0].getText().length,e)},this.renderChildren=function(t){this.x=this.attribute("x").toPixels("x"),this.y=this.attribute("y").toPixels("y"),this.attribute("dx").hasValue()&&(this.x+=this.attribute("dx").toPixels("x")),this.attribute("dy").hasValue()&&(this.y+=this.attribute("dy").toPixels("y")),this.x+=this.getAnchorDelta(t,this,0);for(var e=0;e<this.children.length;e++)this.renderChild(t,this,this,e)},this.getAnchorDelta=function(t,e,i){var n=this.style("text-anchor").valueOrDefault("start");if("start"==n)return 0;for(var r=0,a=i;a<e.children.length;a++){var s=e.children[a];if(i<a&&s.attribute("x").hasValue())break;r+=s.measureTextRecursive(t)}return-1*("end"==n?r:r/2)},this.renderChild=function(t,e,i,n){var r=i.children[n];r.attribute("x").hasValue()?(r.x=r.attribute("x").toPixels("x")+e.getAnchorDelta(t,i,n),r.attribute("dx").hasValue()&&(r.x+=r.attribute("dx").toPixels("x"))):(r.attribute("dx").hasValue()&&(e.x+=r.attribute("dx").toPixels("x")),r.x=e.x),e.x=r.x+r.measureText(t),r.attribute("y").hasValue()?(r.y=r.attribute("y").toPixels("y"),r.attribute("dy").hasValue()&&(r.y+=r.attribute("dy").toPixels("y"))):(r.attribute("dy").hasValue()&&(e.y+=r.attribute("dy").toPixels("y")),r.y=e.y),e.y=r.y,r.render(t);for(n=0;n<r.children.length;n++)e.renderChild(t,e,r,n)}},w.Element.text.prototype=new w.Element.RenderedElementBase,w.Element.TextElementBase=function(t){this.base=w.Element.RenderedElementBase,this.base(t),this.getGlyph=function(t,e,i){var n,r=e[i],a=null;return t.isArabic?(n="isolated",(0==i||" "==e[i-1])&&i<e.length-2&&" "!=e[i+1]&&(n="terminal"),0<i&&" "!=e[i-1]&&i<e.length-2&&" "!=e[i+1]&&(n="medial"),0<i&&" "!=e[i-1]&&(i==e.length-1||" "==e[i+1])&&(n="initial"),void 0!==t.glyphs[r]&&null==(a=t.glyphs[r][n])&&"glyph"==t.glyphs[r].type&&(a=t.glyphs[r])):a=t.glyphs[r],a=null==a?t.missingGlyph:a},this.renderChildren=function(t){var e=this.parent.style("font-family").getDefinition();if(null!=e)for(var i=this.parent.style("font-size").numValueOrDefault(w.Font.Parse(w.ctx.font).fontSize),n=this.parent.style("font-style").valueOrDefault(w.Font.Parse(w.ctx.font).fontStyle),r=this.getText(),a=(e.isRTL&&(r=r.split("").reverse().join("")),w.ToNumberArray(this.parent.attribute("dx").value)),s=0;s<r.length;s++){var o=this.getGlyph(e,r,s),l=i/e.fontFace.unitsPerEm,c=(t.translate(this.x,this.y),t.scale(l,-l),t.lineWidth);t.lineWidth=t.lineWidth*e.fontFace.unitsPerEm/i,"italic"==n&&t.transform(1,0,.4,1,0,0),o.render(t),"italic"==n&&t.transform(1,0,-.4,1,0,0),t.lineWidth=c,t.scale(1/l,-1/l),t.translate(-this.x,-this.y),this.x+=i*(o.horizAdvX||e.horizAdvX)/e.fontFace.unitsPerEm,void 0===a[s]||isNaN(a[s])||(this.x+=a[s])}else""!=t.fillStyle&&t.fillText(w.compressSpaces(this.getText()),this.x,this.y),""!=t.strokeStyle&&t.strokeText(w.compressSpaces(this.getText()),this.x,this.y)},this.getText=function(){},this.measureTextRecursive=function(t){for(var e=this.measureText(t),i=0;i<this.children.length;i++)e+=this.children[i].measureTextRecursive(t);return e},this.measureText=function(t){var e=this.parent.style("font-family").getDefinition();if(null!=e){for(var i=this.parent.style("font-size").numValueOrDefault(w.Font.Parse(w.ctx.font).fontSize),n=0,r=this.getText(),a=(e.isRTL&&(r=r.split("").reverse().join("")),w.ToNumberArray(this.parent.attribute("dx").value)),s=0;s<r.length;s++)n+=(this.getGlyph(e,r,s).horizAdvX||e.horizAdvX)*i/e.fontFace.unitsPerEm,void 0===a[s]||isNaN(a[s])||(n+=a[s]);return n}var o=w.compressSpaces(this.getText());if(!t.measureText)return 10*o.length;t.save(),this.setContext(t);o=t.measureText(o).width;return t.restore(),o}},w.Element.TextElementBase.prototype=new w.Element.RenderedElementBase,w.Element.tspan=function(t){this.captureTextNodes=!0,this.base=w.Element.TextElementBase,this.base(t),this.text=w.compressSpaces(t.value||t.text||t.textContent||""),this.getText=function(){return 0<this.children.length?"":this.text}},w.Element.tspan.prototype=new w.Element.TextElementBase,w.Element.tref=function(t){this.base=w.Element.TextElementBase,this.base(t),this.getText=function(){var t=this.getHrefAttribute().getDefinition();if(null!=t)return t.children[0].getText()}},w.Element.tref.prototype=new w.Element.TextElementBase,w.Element.a=function(t){this.base=w.Element.TextElementBase,this.base(t),this.hasText=0<t.childNodes.length;for(var e=0;e<t.childNodes.length;e++)3!=t.childNodes[e].nodeType&&(this.hasText=!1);this.text=this.hasText?t.childNodes[0].value:"",this.getText=function(){return this.text},this.baseRenderChildren=this.renderChildren,this.renderChildren=function(t){var e;this.hasText?(this.baseRenderChildren(t),e=new w.Property("fontSize",w.Font.Parse(w.ctx.font).fontSize),w.Mouse.checkBoundingBox(this,new w.BoundingBox(this.x,this.y-e.toPixels("y"),this.x+this.measureText(t),this.y))):0<this.children.length&&((e=new w.Element.g).children=this.children,e.parent=this,e.render(t))},this.onclick=function(){window.open(this.getHrefAttribute().value)},this.onmousemove=function(){w.ctx.canvas.style.cursor="pointer"}},w.Element.a.prototype=new w.Element.TextElementBase,w.Element.image=function(t){this.base=w.Element.RenderedElementBase,this.base(t);var a,e,i=this.getHrefAttribute().value;""!=i&&(a=i.match(/\.svg$/),w.Images.push(this),this.loaded=!1,a?(this.img=w.ajax(i),this.loaded=!0):(this.img=document.createElement("img"),1==w.opts.useCORS&&(this.img.crossOrigin="Anonymous"),(e=this).img.onload=function(){e.loaded=!0},this.img.onerror=function(){w.log('ERROR: image "'+i+'" not found'),e.loaded=!0},this.img.src=i),this.renderChildren=function(t){var e=this.attribute("x").toPixels("x"),i=this.attribute("y").toPixels("y"),n=this.attribute("width").toPixels("x"),r=this.attribute("height").toPixels("y");0!=n&&0!=r&&(t.save(),a?t.drawSvg(this.img,e,i,n,r):(t.translate(e,i),w.AspectRatio(t,this.attribute("preserveAspectRatio").value,n,this.img.width,r,this.img.height,0,0),t.drawImage(this.img,0,0)),t.restore())},this.getBoundingBox=function(){var t=this.attribute("x").toPixels("x"),e=this.attribute("y").toPixels("y"),i=this.attribute("width").toPixels("x"),n=this.attribute("height").toPixels("y");return new w.BoundingBox(t,e,t+i,e+n)})},w.Element.image.prototype=new w.Element.RenderedElementBase,w.Element.g=function(t){this.base=w.Element.RenderedElementBase,this.base(t),this.getBoundingBox=function(){for(var t=new w.BoundingBox,e=0;e<this.children.length;e++)t.addBoundingBox(this.children[e].getBoundingBox());return t}},w.Element.g.prototype=new w.Element.RenderedElementBase,w.Element.symbol=function(t){this.base=w.Element.RenderedElementBase,this.base(t),this.render=function(t){}},w.Element.symbol.prototype=new w.Element.RenderedElementBase,w.Element.style=function(t){this.base=w.Element.ElementBase,this.base(t);for(var e="",i=0;i<t.childNodes.length;i++)e+=t.childNodes[i].data;e=e.replace(/(\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/)|(^[\s]*\/\/.*)/gm,"");for(var n=(e=w.compressSpaces(e)).split("}"),i=0;i<n.length;i++)if(""!=w.trim(n[i]))for(var r=n[i].split("{"),a=r[0].split(","),s=r[1].split(";"),o=0;o<a.length;o++){var l=w.trim(a[o]);if(""!=l){for(var c=w.Styles[l]||{},h=0;h<s.length;h++){var d=s[h].indexOf(":"),u=s[h].substr(0,d),d=s[h].substr(d+1,s[h].length-d);null!=u&&null!=d&&(c[w.trim(u)]=new w.Property(w.trim(u),w.trim(d)))}if(w.Styles[l]=c,w.StylesSpecificity[l]=function(n){function t(t,e){var i=n.match(t);null!=i&&(r[e]+=i.length,n=n.replace(t," "))}var r=[0,0,0];return n=(n=n.replace(/:not\(([^\)]*)\)/g,"     $1 ")).replace(/{[\s\S]*/gm," "),t(C,1),t(x,0),t(S,1),t(M,2),t(O,1),t(G,1),n=(n=n.replace(/[\*\s\+>~]/g," ")).replace(/[#\.]/g," "),t(I,2),r.join("")}(l),"@font-face"==l)for(var p=c["font-family"].value.replace(/"/g,""),g=c.src.value.split(","),f=0;f<g.length;f++)if(0<g[f].indexOf('format("svg")'))for(var m=g[f].indexOf("url"),_=g[f].indexOf(")",m),_=g[f].substr(m+5,_-m-6),v=w.parseXml(w.ajax(_)).getElementsByTagName("font"),y=0;y<v.length;y++){var b=w.CreateElement(v[y]);w.Definitions[p]=b}}}},w.Element.style.prototype=new w.Element.ElementBase,w.Element.use=function(t){this.base=w.Element.RenderedElementBase,this.base(t),this.baseSetContext=this.setContext,this.setContext=function(t){this.baseSetContext(t),this.attribute("x").hasValue()&&t.translate(this.attribute("x").toPixels("x"),0),this.attribute("y").hasValue()&&t.translate(0,this.attribute("y").toPixels("y"))};var n=this.getHrefAttribute().getDefinition();this.path=function(t){null!=n&&n.path(t)},this.getBoundingBox=function(){if(null!=n)return n.getBoundingBox()},this.renderChildren=function(t){var e,i;null!=n&&("symbol"==(e=n).type&&((e=new w.Element.svg).type="svg",e.attributes.viewBox=new w.Property("viewBox",n.attribute("viewBox").value),e.attributes.preserveAspectRatio=new w.Property("preserveAspectRatio",n.attribute("preserveAspectRatio").value),e.attributes.overflow=new w.Property("overflow",n.attribute("overflow").value),e.children=n.children),"svg"==e.type&&(this.attribute("width").hasValue()&&(e.attributes.width=new w.Property("width",this.attribute("width").value)),this.attribute("height").hasValue()&&(e.attributes.height=new w.Property("height",this.attribute("height").value))),i=e.parent,e.parent=null,e.render(t),e.parent=i)}},w.Element.use.prototype=new w.Element.RenderedElementBase,w.Element.mask=function(t){this.base=w.Element.ElementBase,this.base(t),this.apply=function(t,e){var i=this.attribute("x").toPixels("x"),n=this.attribute("y").toPixels("y"),r=this.attribute("width").toPixels("x"),a=this.attribute("height").toPixels("y");if(0==r&&0==a){for(var s=new w.BoundingBox,o=0;o<this.children.length;o++)s.addBoundingBox(this.children[o].getBoundingBox());i=Math.floor(s.x1),n=Math.floor(s.y1),r=Math.floor(s.width()),a=Math.floor(s.height())}var l=e.attribute("mask").value,c=(e.attribute("mask").value="",document.createElement("canvas")),h=(c.width=i+r,c.height=n+a,c.getContext("2d")),d=(this.renderChildren(h),document.createElement("canvas")),u=(d.width=i+r,d.height=n+a,d.getContext("2d"));e.render(u),u.globalCompositeOperation="destination-in",u.fillStyle=h.createPattern(c,"no-repeat"),u.fillRect(0,0,i+r,n+a),t.fillStyle=u.createPattern(d,"no-repeat"),t.fillRect(0,0,i+r,n+a),e.attribute("mask").value=l},this.render=function(t){}},w.Element.mask.prototype=new w.Element.ElementBase,w.Element.clipPath=function(t){this.base=w.Element.ElementBase,this.base(t),this.apply=function(t){var e=CanvasRenderingContext2D.prototype.beginPath,i=(CanvasRenderingContext2D.prototype.beginPath=function(){},CanvasRenderingContext2D.prototype.closePath);CanvasRenderingContext2D.prototype.closePath=function(){},e.call(t);for(var n=0;n<this.children.length;n++){var r,a=this.children[n];void 0!==a.path&&(a.style("transform",!1,!(r=null)).hasValue()&&(r=new w.Transform(a.style("transform",!1,!0).value)).apply(t),a.path(t),CanvasRenderingContext2D.prototype.closePath=i,r&&r.unapply(t))}i.call(t),t.clip(),CanvasRenderingContext2D.prototype.beginPath=e,CanvasRenderingContext2D.prototype.closePath=i},this.render=function(t){}},w.Element.clipPath.prototype=new w.Element.ElementBase,w.Element.filter=function(t){this.base=w.Element.ElementBase,this.base(t),this.apply=function(t,e){for(var i=e.getBoundingBox(),n=Math.floor(i.x1),r=Math.floor(i.y1),a=Math.floor(i.width()),s=Math.floor(i.height()),i=e.style("filter").value,o=(e.style("filter").value="",0),l=0,c=0;c<this.children.length;c++)var h=this.children[c].extraFilterDistance||0,o=Math.max(o,h),l=Math.max(l,h);var d=document.createElement("canvas"),u=(d.width=a+2*o,d.height=s+2*l,d.getContext("2d"));u.translate(-n+o,-r+l),e.render(u);for(c=0;c<this.children.length;c++)"function"==typeof this.children[c].apply&&this.children[c].apply(u,0,0,a+2*o,s+2*l);t.drawImage(d,0,0,a+2*o,s+2*l,n-o,r-l,a+2*o,s+2*l),e.style("filter",!0).value=i},this.render=function(t){}},w.Element.filter.prototype=new w.Element.ElementBase,w.Element.feMorphology=function(t){this.base=w.Element.ElementBase,this.base(t),this.apply=function(t,e,i,n,r){}},w.Element.feMorphology.prototype=new w.Element.ElementBase,w.Element.feComposite=function(t){this.base=w.Element.ElementBase,this.base(t),this.apply=function(t,e,i,n,r){}},w.Element.feComposite.prototype=new w.Element.ElementBase,w.Element.feColorMatrix=function(t){this.base=w.Element.ElementBase,this.base(t);var i=w.ToNumberArray(this.attribute("values").value);switch(this.attribute("type").valueOrDefault("matrix")){case"saturate":var e=i[0],i=[.213+.787*e,.715-.715*e,.072-.072*e,0,0,.213-.213*e,.715+.285*e,.072-.072*e,0,0,.213-.213*e,.715-.715*e,.072+.928*e,0,0,0,0,0,1,0,0,0,0,0,1];break;case"hueRotate":function n(t,e,i){return t+Math.cos(r)*e+Math.sin(r)*i}var r=i[0]*Math.PI/180;i=[n(.213,.787,-.213),n(.715,-.715,-.715),n(.072,-.072,.928),0,0,n(.213,-.213,.143),n(.715,.285,.14),n(.072,-.072,-.283),0,0,n(.213,-.213,-.787),n(.715,-.715,.715),n(.072,.928,.072),0,0,0,0,0,1,0,0,0,0,0,1];break;case"luminanceToAlpha":i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.2125,.7154,.0721,0,0,0,0,0,0,1]}function h(t,e,i,n,r,a){return t[i*n*4+4*e+a]}function d(t,e,i,n,r,a,s){t[i*n*4+4*e+a]=s}function u(t,e){t=i[t];return t*(t<0?e-255:e)}this.apply=function(t,e,i,n,r){for(var a=t.getImageData(0,0,n,r),i=0;i<r;i++)for(e=0;e<n;e++){var s=h(a.data,e,i,n,0,0),o=h(a.data,e,i,n,0,1),l=h(a.data,e,i,n,0,2),c=h(a.data,e,i,n,0,3);d(a.data,e,i,n,0,0,u(0,s)+u(1,o)+u(2,l)+u(3,c)+u(4,1)),d(a.data,e,i,n,0,1,u(5,s)+u(6,o)+u(7,l)+u(8,c)+u(9,1)),d(a.data,e,i,n,0,2,u(10,s)+u(11,o)+u(12,l)+u(13,c)+u(14,1)),d(a.data,e,i,n,0,3,u(15,s)+u(16,o)+u(17,l)+u(18,c)+u(19,1))}t.clearRect(0,0,n,r),t.putImageData(a,0,0)}},w.Element.feColorMatrix.prototype=new w.Element.ElementBase,w.Element.feGaussianBlur=function(t){this.base=w.Element.ElementBase,this.base(t),this.blurRadius=Math.floor(this.attribute("stdDeviation").numValue()),this.extraFilterDistance=this.blurRadius,this.apply=function(t,e,i,n,r){void 0===h.canvasRGBA?w.log("ERROR: StackBlur.js must be included for blur to work"):(t.canvas.id=w.UniqueId(),t.canvas.style.display="none",document.body.appendChild(t.canvas),h.canvasRGBA(t.canvas.id,e,i,n,r,this.blurRadius),document.body.removeChild(t.canvas))}},w.Element.feGaussianBlur.prototype=new w.Element.ElementBase,w.Element.title=function(t){},w.Element.title.prototype=new w.Element.ElementBase,w.Element.desc=function(t){},w.Element.desc.prototype=new w.Element.ElementBase,w.Element.MISSING=function(t){w.log("ERROR: Element '"+t.nodeName+"' not yet implemented.")},w.Element.MISSING.prototype=new w.Element.ElementBase,w.CreateElement=function(t){var e=(e=t.nodeName.replace(/^[^:]+:/,"")).replace(/\-/g,""),i=null;return(i=new(void 0!==w.Element[e]?w.Element[e]:w.Element.MISSING)(t)).type=t.nodeName,i},w.load=function(t,e){w.loadXml(t,w.ajax(e))},w.loadXml=function(t,e){w.loadXmlDoc(t,w.parseXml(e))},w.loadXmlDoc=function(a,s){w.init(a);function e(t){for(var e=a.canvas;e;)t.x-=e.offsetLeft,t.y-=e.offsetTop,e=e.offsetParent;return window.scrollX&&(t.x+=window.scrollX),window.scrollY&&(t.y+=window.scrollY),t}function i(){w.ViewPort.Clear(),a.canvas.parentNode&&w.ViewPort.SetCurrent(a.canvas.parentNode.clientWidth,a.canvas.parentNode.clientHeight),1!=w.opts.ignoreDimensions&&(o.style("width").hasValue()&&(a.canvas.width=o.style("width").toPixels("x"),a.canvas.style.width=a.canvas.width+"px"),o.style("height").hasValue()&&(a.canvas.height=o.style("height").toPixels("y"),a.canvas.style.height=a.canvas.height+"px"));var t,e,i,n=a.canvas.clientWidth||a.canvas.width,r=a.canvas.clientHeight||a.canvas.height;1==w.opts.ignoreDimensions&&o.style("width").hasValue()&&o.style("height").hasValue()&&(n=o.style("width").toPixels("x"),r=o.style("height").toPixels("y")),w.ViewPort.SetCurrent(n,r),null!=w.opts.offsetX&&(o.attribute("x",!0).value=w.opts.offsetX),null!=w.opts.offsetY&&(o.attribute("y",!0).value=w.opts.offsetY),null==w.opts.scaleWidth&&null==w.opts.scaleHeight||(e=t=null,i=w.ToNumberArray(o.attribute("viewBox").value),null!=w.opts.scaleWidth&&(o.attribute("width").hasValue()?t=o.attribute("width").toPixels("x")/w.opts.scaleWidth:isNaN(i[2])||(t=i[2]/w.opts.scaleWidth)),null!=w.opts.scaleHeight&&(o.attribute("height").hasValue()?e=o.attribute("height").toPixels("y")/w.opts.scaleHeight:isNaN(i[3])||(e=i[3]/w.opts.scaleHeight)),null==t&&(t=e),null==e&&(e=t),o.attribute("width",!0).value=w.opts.scaleWidth,o.attribute("height",!0).value=w.opts.scaleHeight,o.style("transform",!0,!0).value+=" scale("+1/t+","+1/e+")"),1!=w.opts.ignoreClear&&a.clearRect(0,0,n,r),o.render(a),l&&(l=!1,"function"==typeof w.opts.renderCallback&&w.opts.renderCallback(s))}1!=w.opts.ignoreMouse&&(a.canvas.onclick=function(t){t=e(new w.Point((null!=t?t:event).clientX,(null!=t?t:event).clientY));w.Mouse.onclick(t.x,t.y)},a.canvas.onmousemove=function(t){t=e(new w.Point((null!=t?t:event).clientX,(null!=t?t:event).clientY));w.Mouse.onmousemove(t.x,t.y)});var o=w.CreateElement(s.documentElement),l=(o.root=!0,o.addStylesFromStyleDefinition(),!0),n=!0;w.ImagesLoaded()&&(n=!1,i()),w.intervalID=setInterval(function(){var t=!1;if(n&&w.ImagesLoaded()&&(t=!(n=!1)),1!=w.opts.ignoreMouse&&(t|=w.Mouse.hasEvents()),1!=w.opts.ignoreAnimation)for(var e=0;e<w.Animations.length;e++)t|=w.Animations[e].update(1e3/w.FRAMERATE);(t="function"==typeof w.opts.forceRedraw&&1==w.opts.forceRedraw()?!0:t)&&(i(),w.Mouse.runEvents())},1e3/w.FRAMERATE)},w.stop=function(){w.intervalID&&clearInterval(w.intervalID)},w.Mouse=new function(){this.events=[],this.hasEvents=function(){return 0!=this.events.length},this.onclick=function(t,e){this.events.push({type:"onclick",x:t,y:e,run:function(t){t.onclick&&t.onclick()}})},this.onmousemove=function(t,e){this.events.push({type:"onmousemove",x:t,y:e,run:function(t){t.onmousemove&&t.onmousemove()}})},this.eventElements=[],this.checkPath=function(t,e){for(var i=0;i<this.events.length;i++){var n=this.events[i];e.isPointInPath&&e.isPointInPath(n.x,n.y)&&(this.eventElements[i]=t)}},this.checkBoundingBox=function(t,e){for(var i=0;i<this.events.length;i++){var n=this.events[i];e.isPointInBox(n.x,n.y)&&(this.eventElements[i]=t)}},this.runEvents=function(){w.ctx.canvas.style.cursor="";for(var t=0;t<this.events.length;t++)for(var e=this.events[t],i=this.eventElements[t];i;)e.run(i),i=i.parent;this.events=[],this.eventElements=[]}},w}(n||{}),t=(1==t.childNodes.length&&"OBJECT"==t.childNodes[0].nodeName||(t.svg=n),t.getContext("2d"));void 0!==e.documentElement?n.loadXmlDoc(t,e):"<"==e.substr(0,1)?n.loadXml(t,e):n.load(t,e)}}void 0!==Element.prototype.matches?u=function(t,e){return t.matches(e)}:void 0!==Element.prototype.webkitMatchesSelector?u=function(t,e){return t.webkitMatchesSelector(e)}:void 0!==Element.prototype.mozMatchesSelector?u=function(t,e){return t.mozMatchesSelector(e)}:void 0!==Element.prototype.msMatchesSelector?u=function(t,e){return t.msMatchesSelector(e)}:void 0!==Element.prototype.oMatchesSelector?u=function(t,e){return t.oMatchesSelector(e)}:void 0===(u="function"!=typeof jQuery&&"function"!=typeof Zepto?u:function(t,e){return $(t).is(e)})&&(u=Sizzle.matchesSelector);var u,C=/(\[[^\]]+\])/g,x=/(#[^\s\+>~\.\[:]+)/g,S=/(\.[^\s\+>~\.\[:]+)/g,M=/(::[^\s\+>~\.\[:]+|:first-line|:first-letter|:before|:after)/gi,O=/(:[\w-]+\([^\)]*\))/gi,G=/(:[^\s\+>~\.\[:]+)/g,I=/([^\s\+>~\.\[:]+)/g;return"undefined"!=typeof CanvasRenderingContext2D&&(CanvasRenderingContext2D.prototype.drawSvg=function(t,e,i,n,r,a){var s,o={ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,offsetX:e,offsetY:i,scaleWidth:n,scaleHeight:r};for(s in a)a.hasOwnProperty(s)&&(o[s]=a[s]);d(this.canvas,t,o)}),d}),GCO5.view.component.LoginPanel=GCO5.view.component.APanel.extend({statics:{NAME:"GCO5.view.component.LoginPanel"},_renderViewData:function(){this._super(),this.configureSlidingPanelHeader(this.gclg.getString("LOGIN2","login"))},_prepareViewData:function(){var t=this;return this._viewData={lib_user:GCO5.core.GcObjectUtil.isEmpty(GCO5.initInfo.libUser)?GCO5.appModel.getInfo("userLib"):GCO5.initInfo.libUser,isLogged:GCO5.appModel.getInfo("userIsLogged"),resetMail:GCO5.initInfo.hasOwnProperty("canResetMail")&&"1"==GCO5.initInfo.canResetMail&&!this.isLogged,login:function(){GCO5.core.GcStringUtil.isEmpty(this.user)?t.setObservableProperty("errMsg",t.gclg.getString("ERR_USER_MISSING","login")):GCO5.core.GcStringUtil.isEmpty(this.pwd)?t.setObservableProperty("errMsg",t.gclg.getString("ERR_PWD_MISSING","login")):GCO5.appModel.login(t.onLogin,t,{user:this.user,pwd:this.pwd})},logout:function(){GCO5.appModel.logout(t.onLogout,t)},activeReset:!1,activateReset:function(){t.setObservableProperty("activeReset",!0)},sendMail:function(){GCO5.core.GcStringUtil.isEmpty(this.email)?t.setObservableProperty("emailMsg",t.gclg.getString("ERR_EMAIL_MISSING","login")):GCO5.appModel.resetPassword(t.onResetPassword,t,{email:this.email})}}},_reloadPage:function(){GCO5.core.ClientInfo.getInstance().reloadPage()},_onAddedToStage:function(t){this._super(t),"RECALL"==t.action&&this.resetTemplate()},onLogin:function(t){t.content.user?this._reloadPage():this.setObservableProperty("errMsg",this.gclg.getString("ERR_WRONG_CRED","login"))},onLogout:function(t){this._reloadPage()},onResetPassword:function(t){t.content.success?this.setObservableProperty("emailMsg",this.gclg.getString("EMAIL_SUCCESS","login")):t.content.formatError?this.setObservableProperty("emailMsg",this.gclg.getString("EMAIL_FORMAT","login")):this.setObservableProperty("emailMsg","UnexpectedError")},_addListeners:function(){this._super()}}),GCO5.view.component.FavsPanel=GCO5.view.component.APanel.extend({statics:{NAME:"GCO5.view.component.FavsPanel"},_renderViewData:function(){this._super(),this.configureSlidingPanelHeader(this.gclg.getString("PANEL_TITLE","favs")),this.cli.localStorageSupported()||alert(this.gclg.getString("WARNING_PRIVATE","favs"))},_prepareViewData:function(){GCO5.core.GcObjectUtil.defaults(this,GCO5.view.component.FavsCommon);var t,e,i={activeComponentState:this.gcsm.getActiveComponent().getSaveState(),cuName:this.gcsm.getActiveComponent().getName(),isPanel:!0},n=("IndicatorComponent"==i.cuName&&(t=this.gcsm.getActiveComponent().map,e=i.selgeo=t.getSelgeo(),n=t.getEnabledIndicsModelsIndexed(),n=GCO5.core.GcObjectUtil.getFirstVal(n),i.sharable=!n||!n.onImportedData()&&!n.isTJS(),i.studyEnabled=!n||n.onImportedData()||!n.isTJS(),n=t.getCurrentUrl(n),i.iframeSource="<iframe width='600' height='600' src='"+n+"&iframe=1'></iframe>",i.hasSel=e&&!t.hasSymbSelgeo(),i.hasSel&&(i.libSel=e.getLibgeo().split("&nbsp;").join(" "))),this._viewData=this._getBaseViewData());return GCO5.core.GcObjectUtil.extend(this._viewData,i),n},_onAddedToStage:function(t){this._super(t),"RECALL"==t.action&&this.resetTemplate()},_addListeners:function(){this._super(),this.addMixinListeners()}}),GCO5.view.component.MenuPanel=GCO5.view.component.APanel.extend({statics:{NAME:"GCO5.view.component.MenuPanel"},_renderViewData:function(){this._super(),this.configureSlidingPanelHeader(this.gclg.getString("TOPMENU","topmenu"))},_prepareViewData:function(){function t(t){return e.gclg.getString(t,"topmenu")}var e=this,i=this._prepareObsList(),n=this._prepareWorkspacesList(),r=this._prepareAProposList(),a=this._preparePersoSpace(),n=[{title:this.gclg.getString("WORKSPACES","concepts"),list:n},{title:t("ABOUT"),list:r},{title:t("MYSPACE"),list:a}];return 0!==i.length&&n.unshift({title:"OSERVATOIRE",list:i}),this._viewData={menu_a:n}},_prepareObsList:function(){var t=[];return t=GCO5.appModel.hasMultipleObs()?GCO5.appModel.getInitKey("obs").map(function(t){return{id:"obs@"+t.c_id_obs,lib:t.c_lib_obs_court,site:t.c_preffered_url}}):t},_prepareWorkspacesList:function(){var t=[{id:"main@indicator",lib:this.gclg.getString("INDICS2","concepts")}];return GCO5.appModel.hasReports()&&t.push({id:"main@report",lib:this.gclg.getString("REPORTS","concepts")}),GCO5.appModel.hasZonages()&&t.push({id:"main@zonage",lib:this.gclg.getString("ZONINGS","concepts")}),GCO5.appModel.hasExternalData()&&t.push({id:"main@externaldata",lib:this.gclg.getString("EXTERNAL_DATA","concepts")}),t},_prepareAProposList:function(){var t=GCO5.appModel.getInitKey("articles").map(function(t){return{id:"main@article|"+t.c_id_page,lib:t.c_title}});return t.push({id:"main@contact",lib:this.gclg.getString("LEGALS","topmenu")}),t.push({id:"main@help",lib:this.gclg.getString("HELP")}),GCO5.appModel.getInfo("menuResource",["news"])&&t.push({id:"main@news",lib:this.gclg.getString("NEWS","topmenu")}),t.push({id:"main@home",lib:this.gclg.getString("HOMEPAGE","topmenu")}),t},_preparePersoSpace:function(){var t=[{id:"panel@favs",lib:this.gclg.getString("FAVS0","topmenu")}];return GCO5.appModel.getInfo("menuResource",["login"])&&t.push({id:"panel@login",lib:this.gclg.getString("LOGIN","login")}),t},_addListeners:function(){var c=this;$(".ui-listview",this._$container).on("click","li",function(t){var i=(o=$(this).data("pk").split("@"))[1],n=o[0];if("panel"==n){function r(){GCO5.core.GcDelayUtil.callLater(GCO5.core.GcComponentUtil.displaySlidingPanel,[e.target],5,c),GCO5.core.GcDelayUtil.callLater(function(){a.setup({action:"NEW",categ:"panel",container:$(".cd-panel-content")})},[],30,c)}var a=new GCO5.view.component[GCO5.core.GcStringUtil.proper(i)+"Panel"];"favs"!=i||window.JSZip?r.apply(c):(c.gcsm.freeze("favs"),require(["favs_m"],function(t){c.gcsm.unFreeze("favs"),t.initialize(),r.apply(c)}))}else if("main"==n){var s=(o=i.split("|"))[0],o=2==o.length?o[1]:null;if(GCO5.appModel.getMainComponents().indexOf(s)<0)return;var l={categ:"main",from:"home"};l.id=s,l.id_page=o,GCO5.core.GcDelayUtil.callLater(function(){$(c.gcsm.getComponent("app")).triggerHandler(GCO5.view.component.AComponent.LOAD_COMPONENT,l)},[],5,c)}else"obs"===n&&(s=GCO5.appModel.getInitKey("obs").filter(function(t){return t.c_id_obs===i})[0],location=null===s.c_preferred_url?"?obs="+s.c_id_obs:s.c_preferred_url);c.close()}),this._super()}}),GCO5.view.component.FicExportPanel=GCO5.view.component.APanel.extend({statics:{NAME:"GCO5.view.component.FicExportPanel"},_renderViewData:function(){this._super(),this.configureSlidingPanelHeader(this.gclg.getString("EXPORT_FICINDIC","restit","indicator"))},_prepareViewData:function(t){var e=this;this._viewData={map:t.fic._map,fic:t.fic,hasSelgeo:t.fic._map.hasSelgeo(),hasSel:t.hasSel,onlySelection:!1,exportScope:"*",exportFmt:"xlsx",statTable:t.fic.getStatTable(),export:function(t){$(".msg",this._$container).text(e.gclg.getString("EXPORT_PREPARING")+"...").show(),"xlsx"==this.exportFmt?GCO5.core.GcDelayUtil.callLater(e.xlsx,["xlsx"],1,e):"ods"==this.exportFmt&&GCO5.core.GcDelayUtil.callLater(e.xlsx,["ods"],1,e)}}},xlsx:function(e){var t,i,n,r,a=this,s=this._viewData.fic.getMapIndicModel();window.XLSX?((n={SheetNames:[r=this.gclg.getString("KEY_FIGURES","indics"),t=this.gclg.getString("CHARTS"),i=this.gclg.getString("DOC")],Sheets:{}}).Sheets[r]=this._getSynthIndicXls(s),n.Sheets[t]=this._getChartDataXls(s),n.Sheets[i]=GCO5.core.GcXlsUtil.getMetaIndicXls(s,this._viewData.map),r=XLSX.write(n,{bookType:e,bookSST:!1,type:"binary"}),saveAs(new Blob([function(t){for(var e=new ArrayBuffer(t.length),i=new Uint8Array(e),n=0,r=t.length;n<r;n++)i[n]=255&t.charCodeAt(n);return e}(r)],{type:"application/octet-stream"}),"data."+e),$(".msg",this._$container).text("")):require(["zip_m"],function(t){require(["xlsx_m"],function(t){a.xlsx(e)})})},_getChartDataXls:function(t){var e=this._viewData.fic.getChartData(),i={},n=1,r={s:{c:0,r:0},e:{c:0,r:0}},a=GCO5.core.GcXlsUtil.addXlsStringLine;a(r,i,[t.getProp("libIndicWithF1",!0,!0)],0,!0);for(var s=0;s<e.length;s++){for(var o in a(r,i,[e[s].title],++n,!0),e[s].dp)a(r,i,e[s].dp[o],++n);n+=2}i["!ref"]=XLSX.utils.encode_range(r);return i["!cols"]=[{wch:30},{wch:20},{wch:20}],i},_getSynthIndicXls:function(t){var i={},n=0,r={s:{c:0,r:0},e:{c:0,r:0}},a=GCO5.core.GcXlsUtil.addXlsStringLine,e=GCO5.appModel.getInfo("infoFromMapName",[this._viewData.map.getName(),"c_lib_view"]);return a(r,i,[GCO5.appModel.getLegal("tit_nav")],n++,!0),a(r,i,[this.gclg.getString("FICINDIC"),t.getProp("libIndicWithF1",!0,!0)],n++,!0),a(r,i,[this.gclg.getString("REFGEO")+" : "+e.replace("|"," ")],n++),GCO5.core.GcXlsUtil.tableToDp(this._viewData.statTable).forEach(function(t,e){a(r,i,t,++n,0==e)}),i["!ref"]=XLSX.utils.encode_range(r),i["!cols"]=[{wch:20},{wch:40}],i}}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amdXX?define(["exports"],e):e((t=t||self).d3=t.d3||{})}(this,function(z){"use strict";function g(t,e){return t<e?-1:e<t?1:e<=t?0:NaN}function M(a){var i;return 1===a.length&&(i=a,a=function(t,e){return g(i(t),e)}),{left:function(t,e,i,n){for(null==i&&(i=0),null==n&&(n=t.length);i<n;){var r=i+n>>>1;a(t[r],e)<0?i=1+r:n=r}return i},right:function(t,e,i,n){for(null==i&&(i=0),null==n&&(n=t.length);i<n;){var r=i+n>>>1;0<a(t[r],e)?n=r:i=1+r}return i}}}var m=M(g),v=m.right,m=m.left;function b(t,e){return[t,e]}function C(t){return null===t?NaN:+t}function w(t,e){var i,n,r=t.length,a=0,s=-1,o=0,l=0;if(null==e)for(;++s<r;)isNaN(i=C(t[s]))||(l+=(n=i-o)*(i-(o+=n/++a)));else for(;++s<r;)isNaN(i=C(e(t[s],s,t)))||(l+=(n=i-o)*(i-(o+=n/++a)));if(1<a)return l/(a-1)}function B(t,e){t=w(t,e);return t&&Math.sqrt(t)}function j(t,e){var i,n,r,a=t.length,s=-1;if(null==e){for(;++s<a;)if(null!=(i=t[s])&&i<=i)for(n=r=i;++s<a;)null!=(i=t[s])&&(i<n&&(n=i),r<i&&(r=i))}else for(;++s<a;)if(null!=(i=e(t[s],s,t))&&i<=i)for(n=r=i;++s<a;)null!=(i=e(t[s],s,t))&&(i<n&&(n=i),r<i&&(r=i));return[n,r]}var H=Array.prototype,W=H.slice,X=H.map;function Y(t){return function(){return t}}function q(t){return t}function K(t,e,i){t=+t,e=+e,i=(r=arguments.length)<2?(e=t,t=0,1):r<3?1:+i;for(var n=-1,r=0|Math.max(0,Math.ceil((e-t)/i)),a=new Array(r);++n<r;)a[n]=t+n*i;return a}var Z=Math.sqrt(50),J=Math.sqrt(10),Q=Math.sqrt(2);function tt(t,e,i){var n,r,a,s,o=-1;if(i=+i,(t=+t)===(e=+e)&&0<i)return[t];if((n=e<t)&&(r=t,t=e,e=r),0===(s=et(t,e,i))||!isFinite(s))return[];if(0<s)for(t=Math.ceil(t/s),e=Math.floor(e/s),a=new Array(r=Math.ceil(e-t+1));++o<r;)a[o]=(t+o)*s;else for(t=Math.floor(t*s),e=Math.ceil(e*s),a=new Array(r=Math.ceil(t-e+1));++o<r;)a[o]=(t-o)/s;return n&&a.reverse(),a}function et(t,e,i){e=(e-t)/Math.max(0,i),t=Math.floor(Math.log(e)/Math.LN10),i=e/Math.pow(10,t);return 0<=t?(Z<=i?10:J<=i?5:Q<=i?2:1)*Math.pow(10,t):-Math.pow(10,-t)/(Z<=i?10:J<=i?5:Q<=i?2:1)}function it(t,e,i){var i=Math.abs(e-t)/Math.max(0,i),n=Math.pow(10,Math.floor(Math.log(i)/Math.LN10)),i=i/n;return Z<=i?n*=10:J<=i?n*=5:Q<=i&&(n*=2),e<t?-n:n}function nt(t){return Math.ceil(Math.log(t.length)/Math.LN2)+1}function rt(t,e,i){if(null==i&&(i=C),n=t.length){if((e=+e)<=0||n<2)return+i(t[0],0,t);if(1<=e)return+i(t[n-1],n-1,t);var n=(n-1)*e,e=Math.floor(n),r=+i(t[e],e,t);return r+(+i(t[e+1],e+1,t)-r)*(n-e)}}function at(t,e){var i,n,r=t.length,a=-1;if(null==e){for(;++a<r;)if(null!=(i=t[a])&&i<=i)for(n=i;++a<r;)null!=(i=t[a])&&n<i&&(n=i)}else for(;++a<r;)if(null!=(i=e(t[a],a,t))&&i<=i)for(n=i;++a<r;)null!=(i=e(t[a],a,t))&&n<i&&(n=i);return n}function st(t){for(var e,i,n,r=t.length,a=-1,s=0;++a<r;)s+=t[a].length;for(i=new Array(s);0<=--r;)for(e=(n=t[r]).length;0<=--e;)i[--s]=n[e];return i}function ot(t,e){var i,n,r=t.length,a=-1;if(null==e){for(;++a<r;)if(null!=(i=t[a])&&i<=i)for(n=i;++a<r;)null!=(i=t[a])&&i<n&&(n=i)}else for(;++a<r;)if(null!=(i=e(t[a],a,t))&&i<=i)for(n=i;++a<r;)null!=(i=e(t[a],a,t))&&i<n&&(n=i);return n}function lt(t){if(!(r=t.length))return[];for(var e=-1,i=ot(t,ct),n=new Array(i);++e<i;)for(var r,a=-1,s=n[e]=new Array(r);++a<r;)s[a]=t[a][e];return n}function ct(t){return t.length}var ht=Array.prototype.slice;function dt(t){return t}var ut=1,pt=2,gt=3,ft=4,mt=1e-6;function _t(t){return"translate("+(t+.5)+",0)"}function vt(t){return"translate(0,"+(t+.5)+")"}function yt(e){return function(t){return+e(t)}}function bt(e){var i=Math.max(0,e.bandwidth()-1)/2;return e.round()&&(i=Math.round(i)),function(t){return+e(t)+i}}function Ct(){return!this.__axis}function xt(p,g){var f=[],m=null,_=null,v=6,y=6,b=3,C=p===ut||p===ft?-1:1,x=p===ft||p===pt?"x":"y",w=p===ut||p===gt?_t:vt;function e(t){var e=null==m?g.ticks?g.ticks.apply(g,f):g.domain():m,i=null==_?g.tickFormat?g.tickFormat.apply(g,f):dt:_,n=Math.max(v,0)+b,r=g.range(),a=+r[0]+.5,r=+r[r.length-1]+.5,s=(g.bandwidth?bt:yt)(g.copy()),o=t.selection?t.selection():t,l=o.selectAll(".domain").data([null]),c=(e=o.selectAll(".tick").data(e,g).order()).exit(),h=e.enter().append("g").attr("class","tick"),d=e.select("line"),u=e.select("text"),l=l.merge(l.enter().insert("path",".tick").attr("class","domain").attr("stroke","currentColor")),e=e.merge(h),d=d.merge(h.append("line").attr("stroke","currentColor").attr(x+"2",C*v)),u=u.merge(h.append("text").attr("fill","currentColor").attr(x,C*n).attr("dy",p===ut?"0em":p===gt?"0.71em":"0.32em"));t!==o&&(l=l.transition(t),e=e.transition(t),d=d.transition(t),u=u.transition(t),c=c.transition(t).attr("opacity",mt).attr("transform",function(t){return isFinite(t=s(t))?w(t):this.getAttribute("transform")}),h.attr("opacity",mt).attr("transform",function(t){var e=this.parentNode.__axis;return w(e&&isFinite(e=e(t))?e:s(t))})),c.remove(),l.attr("d",p===ft||p==pt?y?"M"+C*y+","+a+"H0.5V"+r+"H"+C*y:"M0.5,"+a+"V"+r:y?"M"+a+","+C*y+"V0.5H"+r+"V"+C*y:"M"+a+",0.5H"+r),e.attr("opacity",1).attr("transform",function(t){return w(s(t))}),d.attr(x+"2",C*v),u.attr(x,C*n).text(i),o.filter(Ct).attr("fill","none").attr("font-size",10).attr("font-family","sans-serif").attr("text-anchor",p===pt?"start":p===ft?"end":"middle"),o.each(function(){this.__axis=s})}return e.scale=function(t){return arguments.length?(g=t,e):g},e.ticks=function(){return f=ht.call(arguments),e},e.tickArguments=function(t){return arguments.length?(f=null==t?[]:ht.call(t),e):f.slice()},e.tickValues=function(t){return arguments.length?(m=null==t?null:ht.call(t),e):m&&m.slice()},e.tickFormat=function(t){return arguments.length?(_=t,e):_},e.tickSize=function(t){return arguments.length?(v=y=+t,e):v},e.tickSizeInner=function(t){return arguments.length?(v=+t,e):v},e.tickSizeOuter=function(t){return arguments.length?(y=+t,e):y},e.tickPadding=function(t){return arguments.length?(b=+t,e):b},e}var wt={value:function(){}};function St(){for(var t,e=0,i=arguments.length,n={};e<i;++e){if(!(t=arguments[e]+"")||t in n||/[\s.]/.test(t))throw new Error("illegal type: "+t);n[t]=[]}return new Mt(n)}function Mt(t){this._=t}function Ot(t,e,i){for(var n=0,r=t.length;n<r;++n)if(t[n].name===e){t[n]=wt,t=t.slice(0,n).concat(t.slice(n+1));break}return null!=i&&t.push({name:e,value:i}),t}Mt.prototype=St.prototype={constructor:Mt,on:function(t,e){var i,n,r=this._,a=(n=r,(t+"").trim().split(/^|\s+/).map(function(t){var e="",i=t.indexOf(".");if(0<=i&&(e=t.slice(i+1),t=t.slice(0,i)),t&&!n.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:e}})),s=-1,o=a.length;if(!(arguments.length<2)){if(null!=e&&"function"!=typeof e)throw new Error("invalid callback: "+e);for(;++s<o;)if(i=(t=a[s]).type)r[i]=Ot(r[i],t.name,e);else if(null==e)for(i in r)r[i]=Ot(r[i],t.name,null);return this}for(;++s<o;)if((i=(t=a[s]).type)&&(i=function(t,e){for(var i,n=0,r=t.length;n<r;++n)if((i=t[n]).name===e)return i.value}(r[i],t.name)))return i},copy:function(){var t,e={},i=this._;for(t in i)e[t]=i[t].slice();return new Mt(e)},call:function(t,e){if(0<(i=arguments.length-2))for(var i,n,r=new Array(i),a=0;a<i;++a)r[a]=arguments[a+2];if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(a=0,i=(n=this._[t]).length;a<i;++a)n[a].value.apply(e,r)},apply:function(t,e,i){if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(var n=this._[t],r=0,a=n.length;r<a;++r)n[r].value.apply(e,i)}};var Gt="http://www.w3.org/1999/xhtml",It={svg:"http://www.w3.org/2000/svg",xhtml:Gt,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function Tt(t){var e=t+="",i=e.indexOf(":");return 0<=i&&"xmlns"!==(e=t.slice(0,i))&&(t=t.slice(i+1)),It.hasOwnProperty(e)?{space:It[e],local:t}:t}function At(t){t=Tt(t);return(t.local?function(t){return function(){return this.ownerDocument.createElementNS(t.space,t.local)}}:function(i){return function(){var t=this.ownerDocument,e=this.namespaceURI;return e===Gt&&t.documentElement.namespaceURI===Gt?t.createElement(i):t.createElementNS(e,i)}})(t)}function Pt(){}function Dt(t){return null==t?Pt:function(){return this.querySelector(t)}}function Et(){return[]}function Nt(t){return null==t?Et:function(){return this.querySelectorAll(t)}}function Lt(t){return function(){return this.matches(t)}}function Rt(t){return new Array(t.length)}function kt(t,e){this.ownerDocument=t.ownerDocument,this.namespaceURI=t.namespaceURI,this._next=null,this._parent=t,this.__data__=e}kt.prototype={constructor:kt,appendChild:function(t){return this._parent.insertBefore(t,this._next)},insertBefore:function(t,e){return this._parent.insertBefore(t,e)},querySelector:function(t){return this._parent.querySelector(t)},querySelectorAll:function(t){return this._parent.querySelectorAll(t)}};var Ft="$";function Vt(t,e,i,n,r,a){for(var s,o=0,l=e.length,c=a.length;o<c;++o)(s=e[o])?(s.__data__=a[o],n[o]=s):i[o]=new kt(t,a[o]);for(;o<l;++o)(s=e[o])&&(r[o]=s)}function Ut(t,e,i,n,r,a,s){for(var o,l,c={},h=e.length,d=a.length,u=new Array(h),p=0;p<h;++p)(o=e[p])&&(u[p]=l=Ft+s.call(o,o.__data__,p,e),l in c?r[p]=o:c[l]=o);for(p=0;p<d;++p)(o=c[l=Ft+s.call(t,a[p],p,a)])?((n[p]=o).__data__=a[p],c[l]=null):i[p]=new kt(t,a[p]);for(p=0;p<h;++p)(o=e[p])&&c[u[p]]===o&&(r[p]=o)}function $t(t,e){return t<e?-1:e<t?1:e<=t?0:NaN}function Bt(t){return t.ownerDocument&&t.ownerDocument.defaultView||t.document&&t||t.defaultView}function zt(t,e){return t.style.getPropertyValue(e)||Bt(t).getComputedStyle(t,null).getPropertyValue(e)}function jt(t){return t.trim().split(/^|\s+/)}function Ht(t){return t.classList||new Wt(t)}function Wt(t){this._node=t,this._names=jt(t.getAttribute("class")||"")}function Xt(t,e){for(var i=Ht(t),n=-1,r=e.length;++n<r;)i.add(e[n])}function Yt(t,e){for(var i=Ht(t),n=-1,r=e.length;++n<r;)i.remove(e[n])}function qt(){this.textContent=""}function Kt(){this.innerHTML=""}function Zt(){this.nextSibling&&this.parentNode.appendChild(this)}function Jt(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function Qt(){return null}function te(){var t=this.parentNode;t&&t.removeChild(this)}function ee(){var t=this.cloneNode(!1),e=this.parentNode;return e?e.insertBefore(t,this.nextSibling):t}function ie(){var t=this.cloneNode(!0),e=this.parentNode;return e?e.insertBefore(t,this.nextSibling):t}Wt.prototype={add:function(t){this._names.indexOf(t)<0&&(this._names.push(t),this._node.setAttribute("class",this._names.join(" ")))},remove:function(t){t=this._names.indexOf(t);0<=t&&(this._names.splice(t,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(t){return 0<=this._names.indexOf(t)}};var ne={};function re(i,t,e){return i=ae(i,t,e),function(t){var e=t.relatedTarget;e&&(e===this||8&e.compareDocumentPosition(this))||i.call(this,t)}}function ae(i,n,r){return function(t){var e=z.event;z.event=t;try{i.call(this,this.__data__,n,r)}finally{z.event=e}}}function se(a){return function(){var t=this.__on;if(t){for(var e,i=0,n=-1,r=t.length;i<r;++i)e=t[i],a.type&&e.type!==a.type||e.name!==a.name?t[++n]=e:this.removeEventListener(e.type,e.listener,e.capture);++n?t.length=n:delete this.__on}}}function oe(l,c,h){var d=ne.hasOwnProperty(l.type)?re:ae;return function(t,e,i){var n,r=this.__on,a=d(c,e,i);if(r)for(var s=0,o=r.length;s<o;++s)if((n=r[s]).type===l.type&&n.name===l.name)return this.removeEventListener(n.type,n.listener,n.capture),this.addEventListener(n.type,n.listener=a,n.capture=h),void(n.value=c);this.addEventListener(l.type,a,h),n={type:l.type,name:l.name,value:c,listener:a,capture:h},r?r.push(n):this.__on=[n]}}function le(t,e,i,n){var r=z.event;t.sourceEvent=z.event,z.event=t;try{return e.apply(i,n)}finally{z.event=r}}function ce(t,e,i){var n=Bt(t),r=n.CustomEvent;"function"==typeof r?r=new r(e,i):(r=n.document.createEvent("Event"),i?(r.initEvent(e,i.bubbles,i.cancelable),r.detail=i.detail):r.initEvent(e,!1,!1)),t.dispatchEvent(r)}z.event=null,"undefined"==typeof document||"onmouseenter"in document.documentElement||(ne={mouseenter:"mouseover",mouseleave:"mouseout"});var he=[null];function x(t,e){this._groups=t,this._parents=e}function de(){return new x([[document.documentElement]],he)}function ue(t){return"string"==typeof t?new x([[document.querySelector(t)]],[document.documentElement]):new x([[t]],he)}x.prototype=de.prototype={constructor:x,select:function(t){"function"!=typeof t&&(t=Dt(t));for(var e=this._groups,i=e.length,n=new Array(i),r=0;r<i;++r)for(var a,s,o=e[r],l=o.length,c=n[r]=new Array(l),h=0;h<l;++h)(a=o[h])&&(s=t.call(a,a.__data__,h,o))&&("__data__"in a&&(s.__data__=a.__data__),c[h]=s);return new x(n,this._parents)},selectAll:function(t){"function"!=typeof t&&(t=Nt(t));for(var e=this._groups,i=e.length,n=[],r=[],a=0;a<i;++a)for(var s,o=e[a],l=o.length,c=0;c<l;++c)(s=o[c])&&(n.push(t.call(s,s.__data__,c,o)),r.push(s));return new x(n,r)},filter:function(t){"function"!=typeof t&&(t=Lt(t));for(var e=this._groups,i=e.length,n=new Array(i),r=0;r<i;++r)for(var a,s=e[r],o=s.length,l=n[r]=[],c=0;c<o;++c)(a=s[c])&&t.call(a,a.__data__,c,s)&&l.push(a);return new x(n,this._parents)},data:function(t,e){if(!t)return g=new Array(this.size()),h=-1,this.each(function(t){g[++h]=t}),g;var i,n=e?Ut:Vt,r=this._parents,a=this._groups;"function"!=typeof t&&(i=t,t=function(){return i});for(var s=a.length,o=new Array(s),l=new Array(s),c=new Array(s),h=0;h<s;++h){var d=r[h],u=a[h],p=u.length,g=t.call(d,d&&d.__data__,h,r),f=g.length,m=l[h]=new Array(f),_=o[h]=new Array(f);n(d,u,m,_,c[h]=new Array(p),g,e);for(var v,y,b=0,C=0;b<f;++b)if(v=m[b]){for(C<=b&&(C=b+1);!(y=_[C])&&++C<f;);v._next=y||null}}return(o=new x(o,r))._enter=l,o._exit=c,o},enter:function(){return new x(this._enter||this._groups.map(Rt),this._parents)},exit:function(){return new x(this._exit||this._groups.map(Rt),this._parents)},join:function(t,e,i){var n=this.enter(),r=this,a=this.exit(),n="function"==typeof t?t(n):n.append(t+"");return null!=e&&(r=e(r)),null==i?a.remove():i(a),n&&r?n.merge(r).order():r},merge:function(t){for(var e=this._groups,i=t._groups,n=e.length,t=i.length,r=Math.min(n,t),a=new Array(n),s=0;s<r;++s)for(var o,l=e[s],c=i[s],h=l.length,d=a[s]=new Array(h),u=0;u<h;++u)(o=l[u]||c[u])&&(d[u]=o);for(;s<n;++s)a[s]=e[s];return new x(a,this._parents)},order:function(){for(var t=this._groups,e=-1,i=t.length;++e<i;)for(var n,r=t[e],a=r.length-1,s=r[a];0<=--a;)(n=r[a])&&(s&&4^n.compareDocumentPosition(s)&&s.parentNode.insertBefore(n,s),s=n);return this},sort:function(i){function t(t,e){return t&&e?i(t.__data__,e.__data__):!t-!e}i=i||$t;for(var e=this._groups,n=e.length,r=new Array(n),a=0;a<n;++a){for(var s,o=e[a],l=o.length,c=r[a]=new Array(l),h=0;h<l;++h)(s=o[h])&&(c[h]=s);c.sort(t)}return new x(r,this._parents).order()},call:function(){var t=arguments[0];return arguments[0]=this,t.apply(null,arguments),this},nodes:function(){var t=new Array(this.size()),e=-1;return this.each(function(){t[++e]=this}),t},node:function(){for(var t=this._groups,e=0,i=t.length;e<i;++e)for(var n=t[e],r=0,a=n.length;r<a;++r){var s=n[r];if(s)return s}return null},size:function(){var t=0;return this.each(function(){++t}),t},empty:function(){return!this.node()},each:function(t){for(var e=this._groups,i=0,n=e.length;i<n;++i)for(var r,a=e[i],s=0,o=a.length;s<o;++s)(r=a[s])&&t.call(r,r.__data__,s,a);return this},attr:function(t,e){var i,t=Tt(t);return arguments.length<2?(i=this.node(),t.local?i.getAttributeNS(t.space,t.local):i.getAttribute(t)):this.each((null==e?t.local?function(t){return function(){this.removeAttributeNS(t.space,t.local)}}:function(t){return function(){this.removeAttribute(t)}}:"function"==typeof e?t.local?function(e,i){return function(){var t=i.apply(this,arguments);null==t?this.removeAttributeNS(e.space,e.local):this.setAttributeNS(e.space,e.local,t)}}:function(e,i){return function(){var t=i.apply(this,arguments);null==t?this.removeAttribute(e):this.setAttribute(e,t)}}:t.local?function(t,e){return function(){this.setAttributeNS(t.space,t.local,e)}}:function(t,e){return function(){this.setAttribute(t,e)}})(t,e))},style:function(t,e,i){return 1<arguments.length?this.each((null==e?function(t){return function(){this.style.removeProperty(t)}}:"function"==typeof e?function(e,i,n){return function(){var t=i.apply(this,arguments);null==t?this.style.removeProperty(e):this.style.setProperty(e,t,n)}}:function(t,e,i){return function(){this.style.setProperty(t,e,i)}})(t,e,null==i?"":i)):zt(this.node(),t)},property:function(t,e){return 1<arguments.length?this.each((null==e?function(t){return function(){delete this[t]}}:"function"==typeof e?function(e,i){return function(){var t=i.apply(this,arguments);null==t?delete this[e]:this[e]=t}}:function(t,e){return function(){this[t]=e}})(t,e)):this.node()[t]},classed:function(t,e){var i=jt(t+"");if(arguments.length<2){for(var n=Ht(this.node()),r=-1,a=i.length;++r<a;)if(!n.contains(i[r]))return!1;return!0}return this.each(("function"==typeof e?function(t,e){return function(){(e.apply(this,arguments)?Xt:Yt)(this,t)}}:e?function(t){return function(){Xt(this,t)}}:function(t){return function(){Yt(this,t)}})(i,e))},text:function(t){return arguments.length?this.each(null==t?qt:("function"==typeof t?function(e){return function(){var t=e.apply(this,arguments);this.textContent=null==t?"":t}}:function(t){return function(){this.textContent=t}})(t)):this.node().textContent},html:function(t){return arguments.length?this.each(null==t?Kt:("function"==typeof t?function(e){return function(){var t=e.apply(this,arguments);this.innerHTML=null==t?"":t}}:function(t){return function(){this.innerHTML=t}})(t)):this.node().innerHTML},raise:function(){return this.each(Zt)},lower:function(){return this.each(Jt)},append:function(t){var e="function"==typeof t?t:At(t);return this.select(function(){return this.appendChild(e.apply(this,arguments))})},insert:function(t,e){var i="function"==typeof t?t:At(t),n=null==e?Qt:"function"==typeof e?e:Dt(e);return this.select(function(){return this.insertBefore(i.apply(this,arguments),n.apply(this,arguments)||null)})},remove:function(){return this.each(te)},clone:function(t){return this.select(t?ie:ee)},datum:function(t){return arguments.length?this.property("__data__",t):this.node().__data__},on:function(t,e,i){var n,r,a=(t+"").trim().split(/^|\s+/).map(function(t){var e="",i=t.indexOf(".");return 0<=i&&(e=t.slice(i+1),t=t.slice(0,i)),{type:t,name:e}}),s=a.length;if(!(arguments.length<2)){for(o=e?oe:se,null==i&&(i=!1),n=0;n<s;++n)this.each(o(a[n],e,i));return this}var o=this.node().__on;if(o)for(var l,c=0,h=o.length;c<h;++c)for(n=0,l=o[c];n<s;++n)if((r=a[n]).type===l.type&&r.name===l.name)return l.value},dispatch:function(t,e){return this.each(("function"==typeof e?function(t,e){return function(){return ce(this,t,e.apply(this,arguments))}}:function(t,e){return function(){return ce(this,t,e)}})(t,e))}};var pe=0;function ge(){return new fe}function fe(){this._="@"+(++pe).toString(36)}function me(){for(var t,e=z.event;t=e.sourceEvent;)e=t;return e}function _e(t,e){var i=t.ownerSVGElement||t;if(i.createSVGPoint)return(i=i.createSVGPoint()).x=e.clientX,i.y=e.clientY,[(i=i.matrixTransform(t.getScreenCTM().inverse())).x,i.y];i=t.getBoundingClientRect();return[e.clientX-i.left-t.clientLeft,e.clientY-i.top-t.clientTop]}function ve(t){var e=me();return _e(t,e=e.changedTouches?e.changedTouches[0]:e)}function ye(t,e,i){arguments.length<3&&(i=e,e=me().changedTouches);for(var n,r=0,a=e?e.length:0;r<a;++r)if((n=e[r]).identifier===i)return _e(t,n);return null}function be(){z.event.stopImmediatePropagation()}function Ce(){z.event.preventDefault(),z.event.stopImmediatePropagation()}function xe(t){var e=t.document.documentElement,t=ue(t).on("dragstart.drag",Ce,!0);"onselectstart"in e?t.on("selectstart.drag",Ce,!0):(e.__noselect=e.style.MozUserSelect,e.style.MozUserSelect="none")}function we(t,e){var i=t.document.documentElement,n=ue(t).on("dragstart.drag",null);e&&(n.on("click.drag",Ce,!0),setTimeout(function(){n.on("click.drag",null)},0)),"onselectstart"in i?n.on("selectstart.drag",null):(i.style.MozUserSelect=i.__noselect,delete i.__noselect)}function Se(t){return function(){return t}}function Me(t,e,i,n,r,a,s,o,l,c){this.target=t,this.type=e,this.subject=i,this.identifier=n,this.active=r,this.x=a,this.y=s,this.dx=o,this.dy=l,this._=c}function Oe(){return!z.event.ctrlKey&&!z.event.button}function Ge(){return this.parentNode}function Ie(t){return null==t?{x:z.event.x,y:z.event.y}:t}function Te(){return navigator.maxTouchPoints||"ontouchstart"in this}function Ae(t,e,i){(t.prototype=e.prototype=i).constructor=t}function Pe(t,e){var i,n=Object.create(t.prototype);for(i in e)n[i]=e[i];return n}function De(){}fe.prototype=ge.prototype={constructor:fe,get:function(t){for(var e=this._;!(e in t);)if(!(t=t.parentNode))return;return t[e]},set:function(t,e){return t[this._]=e},remove:function(t){return this._ in t&&delete t[this._]},toString:function(){return this._}},Me.prototype.on=function(){var t=this._.on.apply(this._,arguments);return t===this._?this:t};var H="\\s*([+-]?\\d+)\\s*",Ee="\\s*([+-]?\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)\\s*",Ne="\\s*([+-]?\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)%\\s*",Le=/^#([0-9a-f]{3,8})$/,Re=new RegExp("^rgb\\("+[H,H,H]+"\\)$"),ke=new RegExp("^rgb\\("+[Ne,Ne,Ne]+"\\)$"),Fe=new RegExp("^rgba\\("+[H,H,H,Ee]+"\\)$"),Ve=new RegExp("^rgba\\("+[Ne,Ne,Ne,Ee]+"\\)$"),Ue=new RegExp("^hsl\\("+[Ee,Ne,Ne]+"\\)$"),$e=new RegExp("^hsla\\("+[Ee,Ne,Ne,Ee]+"\\)$"),Be={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};function ze(){return this.rgb().formatHex()}function je(){return this.rgb().formatRgb()}function He(t){var e,i;return t=(t+"").trim().toLowerCase(),(e=Le.exec(t))?(i=e[1].length,e=parseInt(e[1],16),6===i?We(e):3===i?new o(e>>8&15|e>>4&240,e>>4&15|240&e,(15&e)<<4|15&e,1):8===i?Xe(e>>24&255,e>>16&255,e>>8&255,(255&e)/255):4===i?Xe(e>>12&15|e>>8&240,e>>8&15|e>>4&240,e>>4&15|240&e,((15&e)<<4|15&e)/255):null):(e=Re.exec(t))?new o(e[1],e[2],e[3],1):(e=ke.exec(t))?new o(255*e[1]/100,255*e[2]/100,255*e[3]/100,1):(e=Fe.exec(t))?Xe(e[1],e[2],e[3],e[4]):(e=Ve.exec(t))?Xe(255*e[1]/100,255*e[2]/100,255*e[3]/100,e[4]):(e=Ue.exec(t))?Qe(e[1],e[2]/100,e[3]/100,1):(e=$e.exec(t))?Qe(e[1],e[2]/100,e[3]/100,e[4]):Be.hasOwnProperty(t)?We(Be[t]):"transparent"===t?new o(NaN,NaN,NaN,0):null}function We(t){return new o(t>>16&255,t>>8&255,255&t,1)}function Xe(t,e,i,n){return new o(t=n<=0?e=i=NaN:t,e,i,n)}function Ye(t){return(t=t instanceof De?t:He(t))?new o((t=t.rgb()).r,t.g,t.b,t.opacity):new o}function qe(t,e,i,n){return 1===arguments.length?Ye(t):new o(t,e,i,null==n?1:n)}function o(t,e,i,n){this.r=+t,this.g=+e,this.b=+i,this.opacity=+n}function Ke(){return"#"+Je(this.r)+Je(this.g)+Je(this.b)}function Ze(){var t=this.opacity;return(1===(t=isNaN(t)?1:Math.max(0,Math.min(1,t)))?"rgb(":"rgba(")+Math.max(0,Math.min(255,Math.round(this.r)||0))+", "+Math.max(0,Math.min(255,Math.round(this.g)||0))+", "+Math.max(0,Math.min(255,Math.round(this.b)||0))+(1===t?")":", "+t+")")}function Je(t){return((t=Math.max(0,Math.min(255,Math.round(t)||0)))<16?"0":"")+t.toString(16)}function Qe(t,e,i,n){return n<=0?t=e=i=NaN:i<=0||1<=i?t=e=NaN:e<=0&&(t=NaN),new ii(t,e,i,n)}function ti(t){if(t instanceof ii)return new ii(t.h,t.s,t.l,t.opacity);if(!(t=t instanceof De?t:He(t)))return new ii;if(t instanceof ii)return t;var e=(t=t.rgb()).r/255,i=t.g/255,n=t.b/255,r=Math.min(e,i,n),a=Math.max(e,i,n),s=NaN,o=a-r,l=(a+r)/2;return o?(s=e===a?(i-n)/o+6*(i<n):i===a?(n-e)/o+2:(e-i)/o+4,o/=l<.5?a+r:2-a-r,s*=60):o=0<l&&l<1?0:s,new ii(s,o,l,t.opacity)}function ei(t,e,i,n){return 1===arguments.length?ti(t):new ii(t,e,i,null==n?1:n)}function ii(t,e,i,n){this.h=+t,this.s=+e,this.l=+i,this.opacity=+n}function ni(t,e,i){return 255*(t<60?e+(i-e)*t/60:t<180?i:t<240?e+(i-e)*(240-t)/60:e)}Ae(De,He,{copy:function(t){return Object.assign(new this.constructor,this,t)},displayable:function(){return this.rgb().displayable()},hex:ze,formatHex:ze,formatHsl:function(){return ti(this).formatHsl()},formatRgb:je,toString:je}),Ae(o,qe,Pe(De,{brighter:function(t){return t=null==t?1/.7:Math.pow(1/.7,t),new o(this.r*t,this.g*t,this.b*t,this.opacity)},darker:function(t){return t=null==t?.7:Math.pow(.7,t),new o(this.r*t,this.g*t,this.b*t,this.opacity)},rgb:function(){return this},displayable:function(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:Ke,formatHex:Ke,formatRgb:Ze,toString:Ze})),Ae(ii,ei,Pe(De,{brighter:function(t){return t=null==t?1/.7:Math.pow(1/.7,t),new ii(this.h,this.s,this.l*t,this.opacity)},darker:function(t){return t=null==t?.7:Math.pow(.7,t),new ii(this.h,this.s,this.l*t,this.opacity)},rgb:function(){var t=this.h%360+360*(this.h<0),e=isNaN(t)||isNaN(this.s)?0:this.s,i=this.l,e=i+(i<.5?i:1-i)*e,i=2*i-e;return new o(ni(240<=t?t-240:120+t,i,e),ni(t,i,e),ni(t<120?240+t:t-120,i,e),this.opacity)},displayable:function(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl:function(){var t=this.opacity;return(1===(t=isNaN(t)?1:Math.max(0,Math.min(1,t)))?"hsl(":"hsla(")+(this.h||0)+", "+100*(this.s||0)+"%, "+100*(this.l||0)+"%"+(1===t?")":", "+t+")")}}));var ri=Math.PI/180,ai=180/Math.PI,si=.96422,oi=1,li=.82521,ci=4/29,hi=6/29*3*(6/29),di=6/29*(6/29)*(6/29);function ui(t){if(t instanceof gi)return new gi(t.l,t.a,t.b,t.opacity);if(t instanceof Ci)return xi(t);var e,i,n=vi((t=t instanceof o?t:Ye(t)).r),r=vi(t.g),a=vi(t.b),s=fi((.2225045*n+.7168786*r+.0606169*a)/oi);return n===r&&r===a?e=i=s:(e=fi((.4360747*n+.3850649*r+.1430804*a)/si),i=fi((.0139322*n+.0971045*r+.7141733*a)/li)),new gi(116*s-16,500*(e-s),200*(s-i),t.opacity)}function pi(t,e,i,n){return 1===arguments.length?ui(t):new gi(t,e,i,null==n?1:n)}function gi(t,e,i,n){this.l=+t,this.a=+e,this.b=+i,this.opacity=+n}function fi(t){return di<t?Math.pow(t,1/3):t/hi+ci}function mi(t){return 6/29<t?t*t*t:hi*(t-ci)}function _i(t){return 255*(t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055)}function vi(t){return(t/=255)<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function yi(t){if(t instanceof Ci)return new Ci(t.h,t.c,t.l,t.opacity);if(0===(t=t instanceof gi?t:ui(t)).a&&0===t.b)return new Ci(NaN,0<t.l&&t.l<100?0:NaN,t.l,t.opacity);var e=Math.atan2(t.b,t.a)*ai;return new Ci(e<0?360+e:e,Math.sqrt(t.a*t.a+t.b*t.b),t.l,t.opacity)}function bi(t,e,i,n){return 1===arguments.length?yi(t):new Ci(t,e,i,null==n?1:n)}function Ci(t,e,i,n){this.h=+t,this.c=+e,this.l=+i,this.opacity=+n}function xi(t){if(isNaN(t.h))return new gi(t.l,0,0,t.opacity);var e=t.h*ri;return new gi(t.l,Math.cos(e)*t.c,Math.sin(e)*t.c,t.opacity)}Ae(gi,pi,Pe(De,{brighter:function(t){return new gi(this.l+18*(null==t?1:t),this.a,this.b,this.opacity)},darker:function(t){return new gi(this.l-18*(null==t?1:t),this.a,this.b,this.opacity)},rgb:function(){var t=(this.l+16)/116,e=isNaN(this.a)?t:t+this.a/500,i=isNaN(this.b)?t:t-this.b/200;return new o(_i(3.1338561*(e=si*mi(e))-1.6168667*(t=oi*mi(t))-.4906146*(i=li*mi(i))),_i(-.9787684*e+1.9161415*t+.033454*i),_i(.0719453*e-.2289914*t+1.4052427*i),this.opacity)}})),Ae(Ci,bi,Pe(De,{brighter:function(t){return new Ci(this.h,this.c,this.l+18*(null==t?1:t),this.opacity)},darker:function(t){return new Ci(this.h,this.c,this.l-18*(null==t?1:t),this.opacity)},rgb:function(){return xi(this).rgb()}}));var wi=-.29227,Si=-.90649,Mi=1.97294,Oi=Mi*Si,Gi=1.78277*Mi,Ii=1.78277*wi- -.14861*Si;function Ti(t,e,i,n){if(1!==arguments.length)return new Ai(t,e,i,null==n?1:n);e=t;if(e instanceof Ai)return new Ai(e.h,e.s,e.l,e.opacity);var i=(e=e instanceof o?e:Ye(e)).r/255,n=e.g/255,t=e.b/255,n=(Mi*(n-(i=(Ii*t+Oi*i-Gi*n)/(Ii+Oi-Gi)))-wi*(t=t-i))/Si,r=Math.sqrt(n*n+t*t)/(Mi*i*(1-i));return new Ai((n=r?Math.atan2(n,t)*ai-120:NaN)<0?n+360:n,r,i,e.opacity)}function Ai(t,e,i,n){this.h=+t,this.s=+e,this.l=+i,this.opacity=+n}function Pi(t,e,i,n,r){var a=t*t,s=a*t;return((1-3*t+3*a-s)*e+(4-6*a+3*s)*i+(1+3*t+3*a-3*s)*n+s*r)/6}function Di(s){var o=s.length-1;return function(t){var e=t<=0?t=0:1<=t?o-(t=1):Math.floor(t*o),i=s[e],n=s[e+1],r=0<e?s[e-1]:2*i-n,a=e<o-1?s[e+2]:2*n-i;return Pi((t-e/o)*o,r,i,n,a)}}function Ei(s){var o=s.length;return function(t){var e=Math.floor(((t%=1)<0?++t:t)*o),i=s[(e+o-1)%o],n=s[e%o],r=s[(e+1)%o],a=s[(e+2)%o];return Pi((t-e/o)*o,i,n,r,a)}}function Ni(t){return function(){return t}}function Li(e,i){return function(t){return e+t*i}}function Ri(t,e){var i=e-t;return i?Li(t,180<i||i<-180?i-360*Math.round(i/360):i):Ni(isNaN(t)?e:t)}function ki(a){return 1==(a=+a)?l:function(t,e){return e-t?(i=t,n=e,r=a,i=Math.pow(i,r),n=Math.pow(n,r)-i,r=1/r,function(t){return Math.pow(i+t*n,r)}):Ni(isNaN(t)?e:t);var i,n,r}}function l(t,e){var i=e-t;return i?Li(t,i):Ni(isNaN(t)?e:t)}Ae(Ai,Ti,Pe(De,{brighter:function(t){return t=null==t?1/.7:Math.pow(1/.7,t),new Ai(this.h,this.s,this.l*t,this.opacity)},darker:function(t){return t=null==t?.7:Math.pow(.7,t),new Ai(this.h,this.s,this.l*t,this.opacity)},rgb:function(){var t=isNaN(this.h)?0:(this.h+120)*ri,e=+this.l,i=isNaN(this.s)?0:this.s*e*(1-e),n=Math.cos(t),t=Math.sin(t);return new o(255*(e+i*(-.14861*n+1.78277*t)),255*(e+i*(wi*n+Si*t)),255*(e+Mi*n*i),this.opacity)}}));var Fi=function t(e){var s=ki(e);function i(e,t){var i=s((e=qe(e)).r,(t=qe(t)).r),n=s(e.g,t.g),r=s(e.b,t.b),a=l(e.opacity,t.opacity);return function(t){return e.r=i(t),e.g=n(t),e.b=r(t),e.opacity=a(t),e+""}}return i.gamma=t,i}(1);function Vi(o){return function(t){for(var e,i=t.length,n=new Array(i),r=new Array(i),a=new Array(i),s=0;s<i;++s)e=qe(t[s]),n[s]=e.r||0,r[s]=e.g||0,a[s]=e.b||0;return n=o(n),r=o(r),a=o(a),e.opacity=1,function(t){return e.r=n(t),e.g=r(t),e.b=a(t),e+""}}}var Ui=Vi(Di),H=Vi(Ei);function $i(e,i){i=i||[];var n,r=e?Math.min(i.length,e.length):0,a=i.slice();return function(t){for(n=0;n<r;++n)a[n]=e[n]*(1-t)+i[n]*t;return a}}function Bi(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)}function zi(t,e){for(var i=e?e.length:0,n=t?Math.min(i,t.length):0,r=new Array(n),a=new Array(i),s=0;s<n;++s)r[s]=Ki(t[s],e[s]);for(;s<i;++s)a[s]=e[s];return function(t){for(s=0;s<n;++s)a[s]=r[s](t);return a}}function ji(e,i){var n=new Date;return e=+e,i=+i,function(t){return n.setTime(e*(1-t)+i*t),n}}function Hi(e,i){return e=+e,i=+i,function(t){return e*(1-t)+i*t}}function Wi(t,e){var i,n={},r={};for(i in null!==t&&"object"==typeof t||(t={}),e=null!==e&&"object"==typeof e?e:{})i in t?n[i]=Ki(t[i],e[i]):r[i]=e[i];return function(t){for(i in n)r[i]=n[i](t);return r}}var Xi=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,Yi=new RegExp(Xi.source,"g");function qi(t,n){var e,i,r,a,s,o=Xi.lastIndex=Yi.lastIndex=0,l=-1,c=[],h=[];for(t+="",n+="";(e=Xi.exec(t))&&(i=Yi.exec(n));)(r=i.index)>o&&(r=n.slice(o,r),c[l]?c[l]+=r:c[++l]=r),(e=e[0])===(i=i[0])?c[l]?c[l]+=i:c[++l]=i:(c[++l]=null,h.push({i:l,x:Hi(e,i)})),o=Yi.lastIndex;return o<n.length&&(r=n.slice(o),c[l]?c[l]+=r:c[++l]=r),c.length<2?h[0]?(s=h[0].x,function(t){return s(t)+""}):(a=n,function(){return a}):(n=h.length,function(t){for(var e,i=0;i<n;++i)c[(e=h[i]).i]=e.x(t);return c.join("")})}function Ki(t,e){var i=typeof e;return null==e||"boolean"==i?Ni(e):("number"==i?Hi:"string"==i?(i=He(e))?(e=i,Fi):qi:e instanceof He?Fi:e instanceof Date?ji:Bi(e)?$i:Array.isArray(e)?zi:"function"!=typeof e.valueOf&&"function"!=typeof e.toString||isNaN(e)?Wi:Hi)(t,e)}function Zi(e,i){return e=+e,i=+i,function(t){return Math.round(e*(1-t)+i*t)}}var Ji,Qi,tn,en,nn=180/Math.PI,rn={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function an(t,e,i,n,r,a){var s,o,l;return(s=Math.sqrt(t*t+e*e))&&(t/=s,e/=s),(l=t*i+e*n)&&(i-=t*l,n-=e*l),(o=Math.sqrt(i*i+n*n))&&(i/=o,n/=o,l/=o),t*n<e*i&&(t=-t,e=-e,l=-l,s=-s),{translateX:r,translateY:a,rotate:Math.atan2(e,t)*nn,skewX:Math.atan(l)*nn,scaleX:s,scaleY:o}}function sn(u,p,g,f){function m(t){return t.length?t.pop()+" ":""}return function(t,e){var i,n,r,a,s,o,l,c,h=[],d=[];return t=u(t),e=u(e),r=t.translateX,a=t.translateY,l=e.translateX,o=e.translateY,s=h,n=d,r!==l||a!==o?(i=s.push("translate(",null,p,null,g),n.push({i:i-4,x:Hi(r,l)},{i:i-2,x:Hi(a,o)})):(l||o)&&s.push("translate("+l+p+o+g),n=t.rotate,r=e.rotate,i=h,a=d,n!==r?(180<n-r?r+=360:180<r-n&&(n+=360),a.push({i:i.push(m(i)+"rotate(",null,f)-2,x:Hi(n,r)})):r&&i.push(m(i)+"rotate("+r+f),s=t.skewX,l=e.skewX,o=h,a=d,s!==l?a.push({i:o.push(m(o)+"skewX(",null,f)-2,x:Hi(s,l)}):l&&o.push(m(o)+"skewX("+l+f),n=t.scaleX,r=t.scaleY,a=e.scaleX,s=e.scaleY,o=h,l=d,n!==a||r!==s?(c=o.push(m(o)+"scale(",null,",",null,")"),l.push({i:c-4,x:Hi(n,a)},{i:c-2,x:Hi(r,s)})):1===a&&1===s||o.push(m(o)+"scale("+a+","+s+")"),t=e=null,function(t){for(var e,i=-1,n=d.length;++i<n;)h[(e=d[i]).i]=e.x(t);return h.join("")}}}var on=sn(function(t){return"none"===t?rn:(Ji||(Ji=document.createElement("DIV"),Qi=document.documentElement,tn=document.defaultView),Ji.style.transform=t,t=tn.getComputedStyle(Qi.appendChild(Ji),null).getPropertyValue("transform"),Qi.removeChild(Ji),an(+(t=t.slice(7,-1).split(","))[0],+t[1],+t[2],+t[3],+t[4],+t[5]))},"px, ","px)","deg)"),ln=sn(function(t){return null==t?rn:((en=en||document.createElementNS("http://www.w3.org/2000/svg","g")).setAttribute("transform",t),(t=en.transform.baseVal.consolidate())?an((t=t.matrix).a,t.b,t.c,t.d,t.e,t.f):rn)},", ",")",")"),cn=Math.SQRT2;function hn(t){return((t=Math.exp(t))+1/t)/2}function dn(t,e){var n,r,a,s=t[0],o=t[1],l=t[2],t=e[0],i=e[1],e=e[2],c=t-s,h=i-o,t=c*c+h*h;return(e=t<1e-12?(a=Math.log(e/l)/cn,function(t){return[s+t*c,o+t*h,l*Math.exp(cn*t*a)]}):(n=Math.sqrt(t),i=(e*e-l*l+4*t)/(2*l*2*n),t=(e*e-l*l-4*t)/(2*e*2*n),r=Math.log(Math.sqrt(i*i+1)-i),a=(Math.log(Math.sqrt(t*t+1)-t)-r)/cn,function(t){var t=t*a,e=hn(r),i=l/(2*n)*(e*(i=cn*t+r,((i=Math.exp(2*i))-1)/(i+1))-(i=r,((i=Math.exp(r))-1/i)/2));return[s+i*c,o+i*h,l*e/hn(cn*t+r)]})).duration=1e3*a,e}function un(s){return function(e,t){var i=s((e=ei(e)).h,(t=ei(t)).h),n=l(e.s,t.s),r=l(e.l,t.l),a=l(e.opacity,t.opacity);return function(t){return e.h=i(t),e.s=n(t),e.l=r(t),e.opacity=a(t),e+""}}}Ne=un(Ri),Ee=un(l);function pn(s){return function(e,t){var i=s((e=bi(e)).h,(t=bi(t)).h),n=l(e.c,t.c),r=l(e.l,t.l),a=l(e.opacity,t.opacity);return function(t){return e.h=i(t),e.c=n(t),e.l=r(t),e.opacity=a(t),e+""}}}var gn=pn(Ri),fn=pn(l);function mn(o){return function t(s){function e(e,t){var i=o((e=Ti(e)).h,(t=Ti(t)).h),n=l(e.s,t.s),r=l(e.l,t.l),a=l(e.opacity,t.opacity);return function(t){return e.h=i(t),e.s=n(t),e.l=r(Math.pow(t,s)),e.opacity=a(t),e+""}}return s=+s,e.gamma=t,e}(1)}var _n=mn(Ri),vn=mn(l);var yn,bn,Cn=0,xn=0,wn=0,Sn=1e3,Mn=0,On=0,Gn=0,In="object"==typeof performance&&performance.now?performance:Date,Tn="object"==typeof window&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(t){setTimeout(t,17)};function An(){return On||(Tn(Pn),On=In.now()+Gn)}function Pn(){On=0}function Dn(){this._call=this._time=this._next=null}function En(t,e,i){var n=new Dn;return n.restart(t,e,i),n}function Nn(){An(),++Cn;for(var t,e=yn;e;)0<=(t=On-e._time)&&e._call.call(null,t),e=e._next;--Cn}function Ln(){On=(Mn=In.now())+Gn,Cn=xn=0;try{Nn()}finally{for(var t,e,i=yn,n=1/(Cn=0);i;)i=i._call?(n>i._time&&(n=i._time),(t=i)._next):(e=i._next,i._next=null,t?t._next=e:yn=e);bn=t,kn(n),On=0}}function Rn(){var t=In.now(),e=t-Mn;Sn<e&&(Gn-=e,Mn=t)}function kn(t){Cn||(xn=xn&&clearTimeout(xn),24<t-On?(t<1/0&&(xn=setTimeout(Ln,t-In.now()-Gn)),wn=wn&&clearInterval(wn)):(wn||(Mn=In.now(),wn=setInterval(Rn,Sn)),Cn=1,Tn(Ln)))}function Fn(e,i,t){var n=new Dn;return i=null==i?0:+i,n.restart(function(t){n.stop(),e(t+i)},i,t),n}Dn.prototype=En.prototype={constructor:Dn,restart:function(t,e,i){if("function"!=typeof t)throw new TypeError("callback is not a function");i=(null==i?An():+i)+(null==e?0:+e),this._next||bn===this||(bn?bn._next=this:yn=this,bn=this),this._call=t,this._time=i,kn()},stop:function(){this._call&&(this._call=null,this._time=1/0,kn())}};var Vn=St("start","end","cancel","interrupt"),Un=[],$n=0,Bn=1,zn=2,jn=3,Hn=4,Wn=5,Xn=6;function Yn(t,e,i,n,r,a){var s,o,l,c,h,d=t.__transition;if(d){if(i in d)return}else t.__transition={};function u(t){var e,i,n,r;if(l.state!==Bn)return g();for(e in h)if((r=h[e]).name===l.name){if(r.state===jn)return Fn(u);r.state===Hn?(r.state=Xn,r.timer.stop(),r.on.call("interrupt",s,s.__data__,r.index,r.group),delete h[e]):+e<o&&(r.state=Xn,r.timer.stop(),r.on.call("cancel",s,s.__data__,r.index,r.group),delete h[e])}if(Fn(function(){l.state===jn&&(l.state=Hn,l.timer.restart(p,l.delay,l.time),p(t))}),l.state=zn,l.on.call("start",s,s.__data__,l.index,l.group),l.state===zn){for(l.state=jn,c=new Array(n=l.tween.length),e=0,i=-1;e<n;++e)(r=l.tween[e].value.call(s,s.__data__,l.index,l.group))&&(c[++i]=r);c.length=i+1}}function p(t){for(var e=t<l.duration?l.ease.call(null,t/l.duration):(l.timer.restart(g),l.state=Wn,1),i=-1,n=c.length;++i<n;)c[i].call(s,e);l.state===Wn&&(l.on.call("end",s,s.__data__,l.index,l.group),g())}function g(){for(var t in l.state=Xn,l.timer.stop(),delete h[o],h)return;delete s.__transition}s=t,o=i,l={name:e,index:n,group:r,on:Vn,tween:Un,time:a.time,delay:a.delay,duration:a.duration,ease:a.ease,timer:null,state:$n},((h=s.__transition)[o]=l).timer=En(function(t){l.state=Bn,l.timer.restart(u,l.delay,l.time),l.delay<=t&&u(t-l.delay)},0,l.time)}function qn(t,e){t=Zn(t,e);if(t.state>$n)throw new Error("too late; already scheduled");return t}function Kn(t,e){t=Zn(t,e);if(t.state>jn)throw new Error("too late; already running");return t}function Zn(t,e){t=t.__transition;if(t=t&&t[e])return t;throw new Error("transition not found")}function Jn(t,e){var i,n,r,a=t.__transition,s=!0;if(a){for(r in e=null==e?null:e+"",a)(i=a[r]).name!==e?s=!1:(n=i.state>zn&&i.state<Wn,i.state=Xn,i.timer.stop(),i.on.call(n?"interrupt":"cancel",t,t.__data__,i.index,i.group),delete a[r]);s&&delete t.__transition}}function Qn(t,e,i){var n=t._id;return t.each(function(){var t=Kn(this,n);(t.value||(t.value={}))[e]=i.apply(this,arguments)}),function(t){return Zn(t,n).value[e]}}function tr(t,e){var i;return("number"==typeof e?Hi:e instanceof He?Fi:(i=He(e))?(e=i,Fi):qi)(t,e)}function er(n,r){var a,s;function t(){var e,i,t=r.apply(this,arguments);return a=t!==s?(s=t)&&(e=n,i=t,function(t){this.setAttributeNS(e.space,e.local,i.call(this,t))}):a}return t._value=r,t}function ir(n,r){var a,s;function t(){var e,i,t=r.apply(this,arguments);return a=t!==s?(s=t)&&(e=n,i=t,function(t){this.setAttribute(e,i.call(this,t))}):a}return t._value=r,t}var nr=de.prototype.constructor;function rr(t){return function(){this.style.removeProperty(t)}}function ar(r,a,s){var o,l;function t(){var e,i,n,t=a.apply(this,arguments);return o=t!==l?(l=t)&&(e=r,i=t,n=s,function(t){this.style.setProperty(e,i.call(this,t),n)}):o}return t._value=a,t}function sr(i){var n,r;function t(){var e,t=i.apply(this,arguments);return n=t!==r?(r=t)&&(e=t,function(t){this.textContent=e.call(this,t)}):n}return t._value=i,t}var or=0;function lr(t,e,i,n){this._groups=t,this._parents=e,this._name=i,this._id=n}function cr(t){return de().transition(t)}var hr=de.prototype;function dr(t){return((t*=2)<=1?t*t:--t*(2-t)+1)/2}function ur(t){return((t*=2)<=1?t*t*t:(t-=2)*t*t+2)/2}lr.prototype=cr.prototype={constructor:lr,select:function(t){var e=this._name,i=this._id;"function"!=typeof t&&(t=Dt(t));for(var n=this._groups,r=n.length,a=new Array(r),s=0;s<r;++s)for(var o,l,c=n[s],h=c.length,d=a[s]=new Array(h),u=0;u<h;++u)(o=c[u])&&(l=t.call(o,o.__data__,u,c))&&("__data__"in o&&(l.__data__=o.__data__),d[u]=l,Yn(d[u],e,i,u,d,Zn(o,i)));return new lr(a,this._parents,e,i)},selectAll:function(t){var e=this._name,i=this._id;"function"!=typeof t&&(t=Nt(t));for(var n=this._groups,r=n.length,a=[],s=[],o=0;o<r;++o)for(var l,c=n[o],h=c.length,d=0;d<h;++d)if(l=c[d]){for(var u,p=t.call(l,l.__data__,d,c),g=Zn(l,i),f=0,m=p.length;f<m;++f)(u=p[f])&&Yn(u,e,i,f,p,g);a.push(p),s.push(l)}return new lr(a,s,e,i)},filter:function(t){"function"!=typeof t&&(t=Lt(t));for(var e=this._groups,i=e.length,n=new Array(i),r=0;r<i;++r)for(var a,s=e[r],o=s.length,l=n[r]=[],c=0;c<o;++c)(a=s[c])&&t.call(a,a.__data__,c,s)&&l.push(a);return new lr(n,this._parents,this._name,this._id)},merge:function(t){if(t._id!==this._id)throw new Error;for(var e=this._groups,i=t._groups,n=e.length,t=i.length,r=Math.min(n,t),a=new Array(n),s=0;s<r;++s)for(var o,l=e[s],c=i[s],h=l.length,d=a[s]=new Array(h),u=0;u<h;++u)(o=l[u]||c[u])&&(d[u]=o);for(;s<n;++s)a[s]=e[s];return new lr(a,this._parents,this._name,this._id)},selection:function(){return new nr(this._groups,this._parents)},transition:function(){for(var t=this._name,e=this._id,i=++or,n=this._groups,r=n.length,a=0;a<r;++a)for(var s,o=n[a],l=o.length,c=0;c<l;++c)(s=o[c])&&Yn(s,t,i,c,o,{time:(s=Zn(s,e)).time+s.delay+s.duration,delay:0,duration:s.duration,ease:s.ease});return new lr(n,this._parents,t,i)},call:hr.call,nodes:hr.nodes,node:hr.node,size:hr.size,empty:hr.empty,each:hr.each,on:function(t,e){var i,n,r,a,s,o,l=this._id;return arguments.length<2?Zn(this.node(),l).on.on(t):this.each((i=l,r=e,o=((n=t)+"").trim().split(/^|\s+/).every(function(t){var e=t.indexOf(".");return!(t=0<=e?t.slice(0,e):t)||"start"===t})?qn:Kn,function(){var t=o(this,i),e=t.on;e!==a&&(s=(a=e).copy()).on(n,r),t.on=s}))},attr:function(t,e){var i=Tt(t),n="transform"===i?ln:tr;return this.attrTween(t,"function"==typeof e?(i.local?function(n,r,a){var s,o,l;return function(){var t,e,i=a(this);if(null!=i)return(t=this.getAttributeNS(n.space,n.local))===(e=i+"")?null:t===s&&e===o?l:(o=e,l=r(s=t,i));this.removeAttributeNS(n.space,n.local)}}:function(n,r,a){var s,o,l;return function(){var t,e,i=a(this);if(null!=i)return(t=this.getAttribute(n))===(e=i+"")?null:t===s&&e===o?l:(o=e,l=r(s=t,i));this.removeAttribute(n)}})(i,n,Qn(this,"attr."+t,e)):null==e?(i.local?function(t){return function(){this.removeAttributeNS(t.space,t.local)}}:function(t){return function(){this.removeAttribute(t)}})(i):(i.local?function(e,i,n){var r,a,s=n+"";return function(){var t=this.getAttributeNS(e.space,e.local);return t===s?null:t===r?a:a=i(r=t,n)}}:function(e,i,n){var r,a,s=n+"";return function(){var t=this.getAttribute(e);return t===s?null:t===r?a:a=i(r=t,n)}})(i,n,e))},attrTween:function(t,e){var i="attr."+t;if(arguments.length<2)return(i=this.tween(i))&&i._value;if(null==e)return this.tween(i,null);if("function"!=typeof e)throw new Error;return t=Tt(t),this.tween(i,(t.local?er:ir)(t,e))},style:function(t,e,i){var n,r,a,s,o,l,c,h,d,u,p,g,f,m,_,v,y,b,C,x,w,S,M,O,G,I="transform"==(t+="")?on:tr;return null==e?this.styleTween(t,(w=t,S=I,function(){var t=zt(this,w),e=(this.style.removeProperty(w),zt(this,w));return t===e?null:t===M&&e===O?G:G=S(M=t,O=e)})).on("end.style."+t,rr(t)):"function"==typeof e?this.styleTween(t,(v=I,y=Qn(this,"style."+(_=t),e),function(){var t=zt(this,_),e=y(this),i=e+"";return null==e&&(this.style.removeProperty(_),i=e=zt(this,_)),t===i?null:t===b&&i===C?x:(C=i,x=v(b=t,e))})).each((c=this._id,m="end."+(f="style."+(h=t)),function(){var t=Kn(this,c),e=t.on,i=null==t.value[f]?g=g||rr(h):void 0;e===d&&p===i||(u=(d=e).copy()).on(m,p=i),t.on=u})):this.styleTween(t,(n=t,r=I,l=(a=e)+"",function(){var t=zt(this,n);return t===l?null:t===s?o:o=r(s=t,a)}),i).on("end.style."+t,null)},styleTween:function(t,e,i){var n="style."+(t+="");if(arguments.length<2)return(n=this.tween(n))&&n._value;if(null==e)return this.tween(n,null);if("function"!=typeof e)throw new Error;return this.tween(n,ar(t,e,null==i?"":i))},text:function(t){return this.tween("text","function"==typeof t?(i=Qn(this,"text",t),function(){var t=i(this);this.textContent=null==t?"":t}):(e=null==t?"":t+"",function(){this.textContent=e}));var e,i},textTween:function(t){var e="text";if(arguments.length<1)return(e=this.tween(e))&&e._value;if(null==t)return this.tween(e,null);if("function"!=typeof t)throw new Error;return this.tween(e,sr(t))},remove:function(){return this.on("end.remove",(i=this._id,function(){var t,e=this.parentNode;for(t in this.__transition)if(+t!==i)return;e&&e.removeChild(this)}));var i},tween:function(t,e){var i=this._id;if(t+="",arguments.length<2){for(var n,r=Zn(this.node(),i).tween,a=0,s=r.length;a<s;++a)if((n=r[a]).name===t)return n.value;return null}return this.each((null==e?function(r,a){var s,o;return function(){var t=Kn(this,r),e=t.tween;if(e!==s)for(var i=0,n=(o=s=e).length;i<n;++i)if(o[i].name===a){(o=o.slice()).splice(i,1);break}t.tween=o}}:function(a,s,o){var l,c;if("function"!=typeof o)throw new Error;return function(){var t=Kn(this,a),e=t.tween;if(e!==l){c=(l=e).slice();for(var i={name:s,value:o},n=0,r=c.length;n<r;++n)if(c[n].name===s){c[n]=i;break}n===r&&c.push(i)}t.tween=c}})(i,t,e))},delay:function(t){var e=this._id;return arguments.length?this.each(("function"==typeof t?function(t,e){return function(){qn(this,t).delay=+e.apply(this,arguments)}}:function(t,e){return e=+e,function(){qn(this,t).delay=e}})(e,t)):Zn(this.node(),e).delay},duration:function(t){var e=this._id;return arguments.length?this.each(("function"==typeof t?function(t,e){return function(){Kn(this,t).duration=+e.apply(this,arguments)}}:function(t,e){return e=+e,function(){Kn(this,t).duration=e}})(e,t)):Zn(this.node(),e).duration},ease:function(t){var e=this._id;return arguments.length?this.each(function(t,e){if("function"!=typeof e)throw new Error;return function(){Kn(this,t).ease=e}}(e,t)):Zn(this.node(),e).ease},end:function(){var r,a,s=this,o=s._id,l=s.size();return new Promise(function(t,e){var i={value:e},n={value:function(){0==--l&&t()}};s.each(function(){var t=Kn(this,o),e=t.on;e!==r&&((a=(r=e).copy())._.cancel.push(i),a._.interrupt.push(i),a._.end.push(n)),t.on=a})})}};var hr=function t(e){function i(t){return Math.pow(t,e)}return e=+e,i.exponent=t,i}(3),pr=function t(e){function i(t){return 1-Math.pow(1-t,e)}return e=+e,i.exponent=t,i}(3),gr=function t(e){function i(t){return((t*=2)<=1?Math.pow(t,e):2-Math.pow(2-t,e))/2}return e=+e,i.exponent=t,i}(3),fr=Math.PI,mr=fr/2;function _r(t){return(1-Math.cos(fr*t))/2}function vr(t){return((t*=2)<=1?Math.pow(2,10*t-10):2-Math.pow(2,10-10*t))/2}function yr(t){return((t*=2)<=1?1-Math.sqrt(1-t*t):Math.sqrt(1-(t-=2)*t)+1)/2}var br=7.5625;function Cr(t){return(t=+t)<4/11?br*t*t:t<8/11?br*(t-=6/11)*t+.75:t<10/11?br*(t-=9/11)*t+.9375:br*(t-=21/22)*t+63/64}var xr=function t(e){function i(t){return t*t*((e+1)*t-e)}return e=+e,i.overshoot=t,i}(1.70158),wr=function t(e){function i(t){return--t*t*((e+1)*t+e)+1}return e=+e,i.overshoot=t,i}(1.70158),Sr=function t(e){function i(t){return((t*=2)<1?t*t*((e+1)*t-e):(t-=2)*t*((e+1)*t+e)+2)/2}return e=+e,i.overshoot=t,i}(1.70158),Mr=2*Math.PI,Or=function e(i,n){var r=Math.asin(1/(i=Math.max(1,i)))*(n/=Mr);function t(t){return i*Math.pow(2,10*--t)*Math.sin((r-t)/n)}return t.amplitude=function(t){return e(t,n*Mr)},t.period=function(t){return e(i,t)},t}(1,.3),Gr=function e(i,n){var r=Math.asin(1/(i=Math.max(1,i)))*(n/=Mr);function t(t){return 1-i*Math.pow(2,-10*(t=+t))*Math.sin((t+r)/n)}return t.amplitude=function(t){return e(t,n*Mr)},t.period=function(t){return e(i,t)},t}(1,.3),Ir=function e(i,n){var r=Math.asin(1/(i=Math.max(1,i)))*(n/=Mr);function t(t){return((t=2*t-1)<0?i*Math.pow(2,10*t)*Math.sin((r-t)/n):2-i*Math.pow(2,-10*t)*Math.sin((r+t)/n))/2}return t.amplitude=function(t){return e(t,n*Mr)},t.period=function(t){return e(i,t)},t}(1,.3),Tr={time:null,delay:0,duration:250,ease:ur};de.prototype.interrupt=function(t){return this.each(function(){Jn(this,t)})},de.prototype.transition=function(t){var e,i;t=t instanceof lr?(e=t._id,t._name):(e=++or,(i=Tr).time=An(),null==t?null:t+"");for(var n=this._groups,r=n.length,a=0;a<r;++a)for(var s,o=n[a],l=o.length,c=0;c<l;++c)(s=o[c])&&Yn(s,t,e,c,o,i||function(t,e){for(var i;!(i=t.__transition)||!(i=i[e]);)if(!(t=t.parentNode))return Tr.time=An(),Tr;return i}(s,e));return new lr(n,this._parents,t,e)};var Ar=[null];function Pr(t){return function(){return t}}function Dr(t,e,i){this.target=t,this.type=e,this.selection=i}function Er(){z.event.stopImmediatePropagation()}function Nr(){z.event.preventDefault(),z.event.stopImmediatePropagation()}var Lr={name:"drag"},Rr={name:"space"},kr={name:"handle"},Fr={name:"center"};function Vr(t){return[+t[0],+t[1]]}function Ur(t){return[Vr(t[0]),Vr(t[1])]}var $r={name:"x",handles:["w","e"].map(qr),input:function(t,e){return null==t?null:[[+t[0],e[0][1]],[+t[1],e[1][1]]]},output:function(t){return t&&[t[0][0],t[1][0]]}},Br={name:"y",handles:["n","s"].map(qr),input:function(t,e){return null==t?null:[[e[0][0],+t[0]],[e[1][0],+t[1]]]},output:function(t){return t&&[t[0][1],t[1][1]]}},zr={name:"xy",handles:["n","w","e","s","nw","ne","sw","se"].map(qr),input:function(t){return null==t?null:Ur(t)},output:function(t){return t}},jr={overlay:"crosshair",selection:"move",n:"ns-resize",e:"ew-resize",s:"ns-resize",w:"ew-resize",nw:"nwse-resize",ne:"nesw-resize",se:"nwse-resize",sw:"nesw-resize"},Hr={e:"w",w:"e",nw:"ne",ne:"nw",se:"sw",sw:"se"},Wr={n:"s",s:"n",nw:"sw",ne:"se",se:"ne",sw:"nw"},Xr={overlay:1,selection:1,n:null,e:1,s:null,w:-1,nw:-1,ne:1,se:1,sw:-1},Yr={overlay:1,selection:1,n:-1,e:null,s:1,w:null,nw:-1,ne:-1,se:1,sw:1};function qr(t){return{type:t}}function Kr(){return!z.event.ctrlKey&&!z.event.button}function Zr(){var t=this.ownerSVGElement||this;return t.hasAttribute("viewBox")?[[(t=t.viewBox.baseVal).x,t.y],[t.x+t.width,t.y+t.height]]:[[0,0],[t.width.baseVal.value,t.height.baseVal.value]]}function Jr(){return navigator.maxTouchPoints||"ontouchstart"in this}function Qr(t){for(;!t.__brush;)if(!(t=t.parentNode))return;return t.__brush}function ta(k){var F,e=Zr,V=Kr,i=Jr,U=!0,n=St("start","brush","end"),r=6;function a(t){var e=t.property("__brush",h).selectAll(".overlay").data([qr("overlay")]),e=(e.enter().append("rect").attr("class","overlay").attr("pointer-events","all").attr("cursor",jr.overlay).merge(e).each(function(){var t=Qr(this).extent;ue(this).attr("x",t[0][0]).attr("y",t[0][1]).attr("width",t[1][0]-t[0][0]).attr("height",t[1][1]-t[0][1])}),t.selectAll(".selection").data([qr("selection")]).enter().append("rect").attr("class","selection").attr("cursor",jr.selection).attr("fill","#777").attr("fill-opacity",.3).attr("stroke","#fff").attr("shape-rendering","crispEdges"),t.selectAll(".handle").data(k.handles,function(t){return t.type}));e.exit().remove(),e.enter().append("rect").attr("class",function(t){return"handle handle--"+t.type}).attr("cursor",function(t){return jr[t.type]}),t.each($).attr("fill","none").attr("pointer-events","all").on("mousedown.brush",o).filter(i).on("touchstart.brush",o).on("touchmove.brush",l).on("touchend.brush touchcancel.brush",c).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function $(){var t=ue(this),e=Qr(this).selection;e?(t.selectAll(".selection").style("display",null).attr("x",e[0][0]).attr("y",e[0][1]).attr("width",e[1][0]-e[0][0]).attr("height",e[1][1]-e[0][1]),t.selectAll(".handle").style("display",null).attr("x",function(t){return"e"===t.type[t.type.length-1]?e[1][0]-r/2:e[0][0]-r/2}).attr("y",function(t){return"s"===t.type[0]?e[1][1]-r/2:e[0][1]-r/2}).attr("width",function(t){return"n"===t.type||"s"===t.type?e[1][0]-e[0][0]+r:r}).attr("height",function(t){return"e"===t.type||"w"===t.type?e[1][1]-e[0][1]+r:r})):t.selectAll(".selection,.handle").style("display","none").attr("x",null).attr("y",null).attr("width",null).attr("height",null)}function B(t,e,i){return!i&&t.__brush.emitter||new s(t,e)}function s(t,e){this.that=t,this.args=e,this.state=t.__brush,this.active=0}function o(){var e,i,n,r,a,s,t,o,l,c,h,d,u,p,g,f,m,_,v,y,b,C,x,w,S,M,O,G,I,T,A,P,D,E;function L(){var t=O(e);!w||S||M||(Math.abs(t[0]-I[0])>Math.abs(t[1]-I[1])?M=!0:S=!0),I=t,x=!0,Nr(),N()}function N(){var t;switch(b=I[0]-G[0],C=I[1]-G[1],n){case Rr:case Lr:r&&(b=Math.max(l-c,Math.min(g-f,b)),h=c+b,m=f+b),a&&(C=Math.max(d-u,Math.min(_-v,C)),p=u+C,y=v+C);break;case kr:r<0?(b=Math.max(l-c,Math.min(g-c,b)),h=c+b,m=f):0<r&&(b=Math.max(l-f,Math.min(g-f,b)),h=c,m=f+b),a<0?(C=Math.max(d-u,Math.min(_-u,C)),p=u+C,y=v):0<a&&(C=Math.max(d-v,Math.min(_-v,C)),p=u,y=v+C);break;case Fr:r&&(h=Math.max(l,Math.min(g,c-b*r)),m=Math.max(l,Math.min(g,f+b*r))),a&&(p=Math.max(d,Math.min(_,u-C*a)),y=Math.max(d,Math.min(_,v+C*a)))}m<h&&(r*=-1,t=c,c=f,f=t,t=h,h=m,m=t,i in Hr&&D.attr("cursor",jr[i=Hr[i]])),y<p&&(a*=-1,t=u,u=v,v=t,t=p,p=y,y=t,i in Wr&&D.attr("cursor",jr[i=Wr[i]])),s.selection&&(o=s.selection),S&&(h=o[0][0],m=o[1][0]),M&&(p=o[0][1],y=o[1][1]),o[0][0]===h&&o[0][1]===p&&o[1][0]===m&&o[1][1]===y||(s.selection=[[h,p],[m,y]],$.call(e),T.brush())}function R(){if(Er(),z.event.touches){if(z.event.touches.length)return;F&&clearTimeout(F),F=setTimeout(function(){F=null},500)}else we(z.event.view,x),E.on("keydown.brush keyup.brush mousemove.brush mouseup.brush",null);var t;P.attr("pointer-events","all"),D.attr("cursor",jr.overlay),s.selection&&(o=s.selection),(t=o)[0][0]!==t[1][0]&&t[0][1]!==t[1][1]||(s.selection=null,$.call(e)),T.end()}F&&!z.event.touches||V.apply(this,arguments)&&(e=this,i=z.event.target.__data__.type,n="selection"===(U&&z.event.metaKey?i="overlay":i)?Lr:U&&z.event.altKey?Fr:kr,r=k===Br?null:Xr[i],a=k===$r?null:Yr[i],t=(s=Qr(e)).extent,o=s.selection,l=t[0][0],d=t[0][1],g=t[1][0],_=t[1][1],C=b=0,w=r&&a&&U&&z.event.shiftKey,O=z.event.touches?(A=z.event.changedTouches[0].identifier,function(t){return ye(t,z.event.touches,A)}):ve,G=O(e),I=G,T=B(e,arguments,!0).beforestart(),"overlay"===i?(o&&(x=!0),s.selection=o=[[c=k===Br?l:G[0],u=k===$r?d:G[1]],[f=k===Br?g:c,v=k===$r?_:u]]):(c=o[0][0],u=o[0][1],f=o[1][0],v=o[1][1]),h=c,p=u,m=f,y=v,P=ue(e).attr("pointer-events","none"),D=P.selectAll(".overlay").attr("cursor",jr[i]),z.event.touches?(T.moved=L,T.ended=R):(E=ue(z.event.view).on("mousemove.brush",L,!0).on("mouseup.brush",R,!0),U&&E.on("keydown.brush",function(){switch(z.event.keyCode){case 16:w=r&&a;break;case 18:n===kr&&(r&&(f=m-b*r,c=h+b*r),a&&(v=y-C*a,u=p+C*a),n=Fr,N());break;case 32:n!==kr&&n!==Fr||(r<0?f=m-b:0<r&&(c=h-b),a<0?v=y-C:0<a&&(u=p-C),n=Rr,D.attr("cursor",jr.selection),N());break;default:return}Nr()},!0).on("keyup.brush",function(){switch(z.event.keyCode){case 16:w&&(S=M=w=!1,N());break;case 18:n===Fr&&(r<0?f=m:0<r&&(c=h),a<0?v=y:0<a&&(u=p),n=kr,N());break;case 32:n===Rr&&(n=z.event.altKey?(r&&(f=m-b*r,c=h+b*r),a&&(v=y-C*a,u=p+C*a),Fr):(r<0?f=m:0<r&&(c=h),a<0?v=y:0<a&&(u=p),kr),D.attr("cursor",jr[i]),N());break;default:return}Nr()},!0),xe(z.event.view)),Er(),Jn(e),$.call(e),T.start())}function l(){B(this,arguments).moved()}function c(){B(this,arguments).ended()}function h(){var t=this.__brush||{selection:null};return t.extent=Ur(e.apply(this,arguments)),t.dim=k,t}return a.move=function(t,o){t.selection?t.on("start.brush",function(){B(this,arguments).beforestart().start()}).on("interrupt.brush end.brush",function(){B(this,arguments).end()}).tween("brush",function(){var e=this,i=e.__brush,n=B(e,arguments),t=i.selection,r=k.input("function"==typeof o?o.apply(this,arguments):o,i.extent),a=Ki(t,r);function s(t){i.selection=1===t&&null===r?null:a(t),$.call(e),n.brush()}return null!==t&&null!==r?s:s(1)}):t.each(function(){var t=arguments,e=this.__brush,i=k.input("function"==typeof o?o.apply(this,t):o,e.extent),t=B(this,t).beforestart();Jn(this),e.selection=null===i?null:i,$.call(this),t.start().brush().end()})},a.clear=function(t){a.move(t,null)},s.prototype={beforestart:function(){return 1==++this.active&&((this.state.emitter=this).starting=!0),this},start:function(){return this.starting?(this.starting=!1,this.emit("start")):this.emit("brush"),this},brush:function(){return this.emit("brush"),this},end:function(){return 0==--this.active&&(delete this.state.emitter,this.emit("end")),this},emit:function(t){le(new Dr(a,t,k.output(this.state.selection)),n.apply,n,[t,this.that,this.args])}},a.extent=function(t){return arguments.length?(e="function"==typeof t?t:Pr(Ur(t)),a):e},a.filter=function(t){return arguments.length?(V="function"==typeof t?t:Pr(!!t),a):V},a.touchable=function(t){return arguments.length?(i="function"==typeof t?t:Pr(!!t),a):i},a.handleSize=function(t){return arguments.length?(r=+t,a):r},a.keyModifiers=function(t){return arguments.length?(U=!!t,a):U},a.on=function(){var t=n.on.apply(n,arguments);return t===n?a:t},a}var ea=Math.cos,ia=Math.sin,t=Math.PI,na=t/2,ra=2*t,aa=Math.max;var sa=Array.prototype.slice;function oa(t){return function(){return t}}var la=Math.PI,ca=2*la,ha=ca-1e-6;function da(){this._x0=this._y0=this._x1=this._y1=null,this._=""}function ua(){return new da}function pa(t){return t.source}function ga(t){return t.target}function fa(t){return t.radius}function ma(t){return t.startAngle}function _a(t){return t.endAngle}da.prototype=ua.prototype={constructor:da,moveTo:function(t,e){this._+="M"+(this._x0=this._x1=+t)+","+(this._y0=this._y1=+e)},closePath:function(){null!==this._x1&&(this._x1=this._x0,this._y1=this._y0,this._+="Z")},lineTo:function(t,e){this._+="L"+(this._x1=+t)+","+(this._y1=+e)},quadraticCurveTo:function(t,e,i,n){this._+="Q"+ +t+","+ +e+","+(this._x1=+i)+","+(this._y1=+n)},bezierCurveTo:function(t,e,i,n,r,a){this._+="C"+ +t+","+ +e+","+ +i+","+ +n+","+(this._x1=+r)+","+(this._y1=+a)},arcTo:function(t,e,i,n,r){var a,s,o=this._x1,l=this._y1,c=(i=+i)-(t=+t),h=(n=+n)-(e=+e),d=o-t,u=l-e,p=d*d+u*u;if((r=+r)<0)throw new Error("negative radius: "+r);null===this._x1?this._+="M"+(this._x1=t)+","+(this._y1=e):1e-6<p&&(1e-6<Math.abs(u*c-h*d)&&r?(s=c*c+h*h,n=(i=i-o)*i+(o=n-l)*o,l=Math.sqrt(s),a=Math.sqrt(p),p=(s=r*Math.tan((la-Math.acos((s+p-n)/(2*l*a)))/2))/a,n=s/l,1e-6<Math.abs(p-1)&&(this._+="L"+(t+p*d)+","+(e+p*u)),this._+="A"+r+","+r+",0,0,"+ +(d*o<u*i)+","+(this._x1=t+n*c)+","+(this._y1=e+n*h)):this._+="L"+(this._x1=t)+","+(this._y1=e))},arc:function(t,e,i,n,r,a){t=+t,e=+e,a=!!a;var s=(i=+i)*Math.cos(n),o=i*Math.sin(n),l=t+s,c=e+o,h=1^a,a=a?n-r:r-n;if(i<0)throw new Error("negative radius: "+i);null===this._x1?this._+="M"+l+","+c:(1e-6<Math.abs(this._x1-l)||1e-6<Math.abs(this._y1-c))&&(this._+="L"+l+","+c),i&&(ha<(a=a<0?a%ca+ca:a)?this._+="A"+i+","+i+",0,1,"+h+","+(t-s)+","+(e-o)+"A"+i+","+i+",0,1,"+h+","+(this._x1=l)+","+(this._y1=c):1e-6<a&&(this._+="A"+i+","+i+",0,"+ +(la<=a)+","+h+","+(this._x1=t+i*Math.cos(r))+","+(this._y1=e+i*Math.sin(r))))},rect:function(t,e,i,n){this._+="M"+(this._x0=this._x1=+t)+","+(this._y0=this._y1=+e)+"h"+ +i+"v"+ +n+"h"+-i+"Z"},toString:function(){return this._}};function va(){}function ya(t,e){var i=new va;if(t instanceof va)t.each(function(t,e){i.set(e,t)});else if(Array.isArray(t)){var n,r=-1,a=t.length;if(null==e)for(;++r<a;)i.set(r,t[r]);else for(;++r<a;)i.set(e(n=t[r],r,t),n)}else if(t)for(var s in t)i.set(s,t[s]);return i}function ba(){return{}}function Ca(t,e,i){t[e]=i}function xa(){return ya()}function wa(t,e,i){t.set(e,i)}function Sa(){}va.prototype=ya.prototype={constructor:va,has:function(t){return"$"+t in this},get:function(t){return this["$"+t]},set:function(t,e){return this["$"+t]=e,this},remove:function(t){t="$"+t;return t in this&&delete this[t]},clear:function(){for(var t in this)"$"===t[0]&&delete this[t]},keys:function(){var t,e=[];for(t in this)"$"===t[0]&&e.push(t.slice(1));return e},values:function(){var t,e=[];for(t in this)"$"===t[0]&&e.push(this[t]);return e},entries:function(){var t,e=[];for(t in this)"$"===t[0]&&e.push({key:t.slice(1),value:this[t]});return e},size:function(){var t,e=0;for(t in this)"$"===t[0]&&++e;return e},empty:function(){for(var t in this)if("$"===t[0])return!1;return!0},each:function(t){for(var e in this)"$"===e[0]&&t(this[e],e.slice(1),this)}};t=ya.prototype;function Ma(t,e){var i=new Sa;if(t instanceof Sa)t.each(function(t){i.add(t)});else if(t){var n=-1,r=t.length;if(null==e)for(;++n<r;)i.add(t[n]);else for(;++n<r;)i.add(e(t[n],n,t))}return i}Sa.prototype=Ma.prototype={constructor:Sa,has:t.has,add:function(t){return this["$"+(t+="")]=t,this},remove:t.remove,clear:t.clear,values:t.keys,size:t.size,empty:t.empty,each:t.each};var Oa=Array.prototype.slice;function Ga(t,e){return t-e}function Ia(t){return function(){return t}}function Ta(t,e){for(var i,n=-1,r=e.length;++n<r;)if(i=function(t,e){for(var i=e[0],n=e[1],r=-1,a=0,s=t.length,o=s-1;a<s;o=a++){var l=t[a],c=l[0],h=l[1],d=t[o],u=d[0],p=d[1];if(function(t,e,i){return function(t,e,i){return(e[0]-t[0])*(i[1]-t[1])==(i[0]-t[0])*(e[1]-t[1])}(t,e,i)&&function(t,e,i){return t<=e&&e<=i||i<=e&&e<=t}(t[t=+(t[0]===e[0])],i[t],e[t])}(l,d,e))return 0;n<h!=n<p&&i<(u-c)*(n-h)/(p-h)+c&&(r=-r)}return r}(t,e[n]))return i;return 0}function Aa(){}var Pa=[[],[[[1,1.5],[.5,1]]],[[[1.5,1],[1,1.5]]],[[[1.5,1],[.5,1]]],[[[1,.5],[1.5,1]]],[[[1,1.5],[.5,1]],[[1,.5],[1.5,1]]],[[[1,.5],[1,1.5]]],[[[1,.5],[.5,1]]],[[[.5,1],[1,.5]]],[[[1,1.5],[1,.5]]],[[[.5,1],[1,.5]],[[1.5,1],[1,1.5]]],[[[1.5,1],[1,.5]]],[[[.5,1],[1.5,1]]],[[[1,1.5],[1.5,1]]],[[[.5,1],[1,1.5]]],[]];function Da(){var m=1,_=1,r=nt,v=e;function i(e){var t,i,n=r(e);return(n=Array.isArray(n)?n.slice().sort(Ga):(n=it(t=(i=j(e))[0],i=i[1],n),K(Math.floor(t/n)*n,Math.floor(i/n)*n,n))).map(function(t){return a(e,t)})}function a(e,i){var s,o,t,n,r,a,l=[],c=[],h=e,d=i,u=function(t){v(t,e,i),0<function(t){for(var e=0,i=t.length,n=t[i-1][1]*t[0][0]-t[i-1][0]*t[0][1];++e<i;)n+=t[e-1][1]*t[e][0]-t[e-1][0]*t[e][1];return n}(t)?l.push([t]):c.push(t)},p=new Array,g=new Array;for(s=o=-1,n=h[0]>=d,Pa[n<<1].forEach(f);++s<m-1;)t=n,n=h[s+1]>=d,Pa[t|n<<1].forEach(f);for(Pa[n<<0].forEach(f);++o<_-1;){for(s=-1,n=h[o*m+m]>=d,r=h[o*m]>=d,Pa[n<<1|r<<2].forEach(f);++s<m-1;)t=n,n=h[o*m+m+s+1]>=d,a=r,r=h[o*m+s+1]>=d,Pa[t|n<<1|r<<2|a<<3].forEach(f);Pa[n|r<<3].forEach(f)}for(s=-1,r=h[o*m]>=d,Pa[r<<2].forEach(f);++s<m-1;)a=r,r=h[o*m+s+1]>=d,Pa[r<<2|a<<3].forEach(f);function f(t){var e,i,n=[t[0][0]+s,t[0][1]+o],t=[t[1][0]+s,t[1][1]+o],r=y(n),a=y(t);(e=g[r])?(i=p[a])?(delete g[e.end],delete p[i.start],e===i?(e.ring.push(t),u(e.ring)):p[e.start]=g[i.end]={start:e.start,end:i.end,ring:e.ring.concat(i.ring)}):(delete g[e.end],e.ring.push(t),g[e.end=a]=e):(e=p[a])?(i=g[r])?(delete p[e.start],delete g[i.end],e===i?(e.ring.push(t),u(e.ring)):p[i.start]=g[e.end]={start:i.start,end:e.end,ring:i.ring.concat(e.ring)}):(delete p[e.start],e.ring.unshift(n),p[e.start=r]=e):p[r]=g[a]={start:r,end:a,ring:[n,t]}}return Pa[r<<3].forEach(f),c.forEach(function(t){for(var e,i=0,n=l.length;i<n;++i)if(-1!==Ta((e=l[i])[0],t))return void e.push(t)}),{type:"MultiPolygon",value:i,coordinates:l}}function y(t){return 2*t[0]+t[1]*(m+1)*4}function e(t,o,l){t.forEach(function(t){var e,i=t[0],n=t[1],r=0|i,a=0|n,s=o[a*m+r];0<i&&i<m&&r===i&&(e=o[a*m+r-1],t[0]=i+(l-e)/(s-e)-.5),0<n&&n<_&&a===n&&(e=o[(a-1)*m+r],t[1]=n+(l-e)/(s-e)-.5)})}return i.contour=a,i.size=function(t){if(!arguments.length)return[m,_];var e=Math.ceil(t[0]),t=Math.ceil(t[1]);if(0<e&&0<t)return m=e,_=t,i;throw new Error("invalid size")},i.thresholds=function(t){return arguments.length?(r="function"==typeof t?t:Array.isArray(t)?Ia(Oa.call(t)):Ia(t),i):r},i.smooth=function(t){return arguments.length?(v=t?e:Aa,i):v===e},i}function Ea(t,e,i){for(var n=t.width,r=t.height,a=1+(i<<1),s=0;s<r;++s)for(var o=0,l=0;o<n+i;++o)o<n&&(l+=t.data[o+s*n]),i<=o&&(a<=o&&(l-=t.data[o-a+s*n]),e.data[o-i+s*n]=l/Math.min(o+1,n-1+a-o,a))}function Na(t,e,i){for(var n=t.width,r=t.height,a=1+(i<<1),s=0;s<n;++s)for(var o=0,l=0;o<r+i;++o)o<r&&(l+=t.data[s+o*n]),i<=o&&(a<=o&&(l-=t.data[s+(o-a)*n]),e.data[s+(o-i)*n]=l/Math.min(o+1,r-1+a-o,a))}function La(t){return t[0]}function Ra(t){return t[1]}function ka(){return 1}var Fa={},Va={};function Ua(t){return new Function("d","return {"+t.map(function(t,e){return JSON.stringify(t)+": d["+e+'] || ""'}).join(",")+"}")}function $a(t){var i=Object.create(null),n=[];return t.forEach(function(t){for(var e in t)e in i||n.push(i[e]=e)}),n}function Ba(t,e){var t=t+"",i=t.length;return i<e?new Array(e-i+1).join(0)+t:t}function za(t){var e,i=t.getUTCHours(),n=t.getUTCMinutes(),r=t.getUTCSeconds(),a=t.getUTCMilliseconds();return isNaN(t)?"Invalid Date":((e=t.getUTCFullYear())<0?"-"+Ba(-e,6):9999<e?"+"+Ba(e,6):Ba(e,4))+"-"+Ba(t.getUTCMonth()+1,2)+"-"+Ba(t.getUTCDate(),2)+(a?"T"+Ba(i,2)+":"+Ba(n,2)+":"+Ba(r,2)+"."+Ba(a,3)+"Z":r?"T"+Ba(i,2)+":"+Ba(n,2)+":"+Ba(r,2)+"Z":n||i?"T"+Ba(i,2)+":"+Ba(n,2)+"Z":"")}function ja(n){var e=new RegExp('["'+n+"\n\r]"),d=n.charCodeAt(0);function i(n,t){var e,i=[],r=n.length,a=0,s=0,o=r<=0,l=!1;function c(){if(o)return Va;if(l)return l=!1,Fa;var t,e,i=a;if(34===n.charCodeAt(i)){for(;a++<r&&34!==n.charCodeAt(a)||34===n.charCodeAt(++a););return(t=a)>=r?o=!0:10===(e=n.charCodeAt(a++))?l=!0:13===e&&(l=!0,10===n.charCodeAt(a)&&++a),n.slice(i+1,t-1).replace(/""/g,'"')}for(;a<r;){if(10===(e=n.charCodeAt(t=a++)))l=!0;else if(13===e)l=!0,10===n.charCodeAt(a)&&++a;else if(e!==d)continue;return n.slice(i,t)}return o=!0,n.slice(i,r)}for(10===n.charCodeAt(r-1)&&--r,13===n.charCodeAt(r-1)&&--r;(e=c())!==Va;){for(var h=[];e!==Fa&&e!==Va;)h.push(e),e=c();t&&null==(h=t(h,s++))||i.push(h)}return i}function r(t,i){return t.map(function(e){return i.map(function(t){return s(e[t])}).join(n)})}function a(t){return t.map(s).join(n)}function s(t){return null==t?"":t instanceof Date?za(t):e.test(t+="")?'"'+t.replace(/"/g,'""')+'"':t}return{parse:function(t,a){var s,o;return(t=i(t,function(t,e){if(s)return s(t,e-1);var i,n,r;o=t,s=a?(n=a,r=Ua(i=t),function(t,e){return n(r(t),e,i)}):Ua(t)})).columns=o||[],t},parseRows:i,format:function(t,e){return[(e=null==e?$a(t):e).map(s).join(n)].concat(r(t,e)).join("\n")},formatBody:function(t,e){return r(t,e=null==e?$a(t):e).join("\n")},formatRows:function(t){return t.map(a).join("\n")},formatRow:a,formatValue:s}}var t=ja(","),Ha=t.parse,Wa=t.parseRows,Xa=t.format,Ya=t.formatBody,qa=t.formatRows,Ka=t.formatRow,t=t.formatValue,Za=ja("\t"),Ja=Za.parse,Qa=Za.parseRows,ts=Za.format,es=Za.formatBody,is=Za.formatRows,ns=Za.formatRow,Za=Za.formatValue;var rs=new Date("2019-01-01T00:00").getHours()||new Date("2019-07-01T00:00").getHours();function as(t){if(t.ok)return t.blob();throw new Error(t.status+" "+t.statusText)}function ss(t){if(t.ok)return t.arrayBuffer();throw new Error(t.status+" "+t.statusText)}function os(t){if(t.ok)return t.text();throw new Error(t.status+" "+t.statusText)}function ls(t,e){return fetch(t,e).then(os)}function cs(n){return function(t,e,i){return 2===arguments.length&&"function"==typeof e&&(i=e,e=void 0),ls(t,e).then(function(t){return n(t,i)})}}var hs=cs(Ha),ds=cs(Ja);function us(t){if(t.ok)return t.json();throw new Error(t.status+" "+t.statusText)}function ps(i){return function(t,e){return ls(t,e).then(function(t){return(new DOMParser).parseFromString(t,i)})}}var gs=ps("application/xml"),fs=ps("text/html"),ms=ps("image/svg+xml");function f(t){return function(){return t}}function _s(){return 1e-6*(Math.random()-.5)}function vs(t,e,i,n){if(isNaN(e)||isNaN(i))return t;var r,a,s,o,l,c,h,d,u,p=t._root,g={data:n},f=t._x0,m=t._y0,_=t._x1,v=t._y1;if(!p)return t._root=g,t;for(;p.length;)if((c=e>=(a=(f+_)/2))?f=a:_=a,(h=i>=(s=(m+v)/2))?m=s:v=s,!(p=(r=p)[d=h<<1|c]))return r[d]=g,t;if(o=+t._x.call(null,p.data),l=+t._y.call(null,p.data),e===o&&i===l)return g.next=p,r?r[d]=g:t._root=g,t;for(;r=r?r[d]=new Array(4):t._root=new Array(4),(c=e>=(a=(f+_)/2))?f=a:_=a,(h=i>=(s=(m+v)/2))?m=s:v=s,(d=h<<1|c)==(u=(s<=l)<<1|a<=o););return r[u]=p,r[d]=g,t}function _(t,e,i,n,r){this.node=t,this.x0=e,this.y0=i,this.x1=n,this.y1=r}function ys(t){return t[0]}function bs(t){return t[1]}function Cs(t,e,i){e=new xs(null==e?ys:e,null==i?bs:i,NaN,NaN,NaN,NaN);return null==t?e:e.addAll(t)}function xs(t,e,i,n,r,a){this._x=t,this._y=e,this._x0=i,this._y0=n,this._x1=r,this._y1=a,this._root=void 0}function ws(t){for(var e={data:t.data},i=e;t=t.next;)i=i.next={data:t.data};return e}var e=Cs.prototype=xs.prototype;function Ss(t){return t.x+t.vx}function Ms(t){return t.y+t.vy}function Os(t){return t.index}function Gs(t,e){t=t.get(e);if(t)return t;throw new Error("missing: "+e)}function Is(t){return t.x}function Ts(t){return t.y}e.copy=function(){var t,e,i=new xs(this._x,this._y,this._x0,this._y0,this._x1,this._y1),n=this._root;if(n){if(!n.length)return i._root=ws(n),i;for(t=[{source:n,target:i._root=new Array(4)}];n=t.pop();)for(var r=0;r<4;++r)(e=n.source[r])&&(e.length?t.push({source:e,target:n.target[r]=new Array(4)}):n.target[r]=ws(e))}return i},e.add=function(t){var e=+this._x.call(null,t),i=+this._y.call(null,t);return vs(this.cover(e,i),e,i,t)},e.addAll=function(t){for(var e,i,n=t.length,r=new Array(n),a=new Array(n),s=1/0,o=1/0,l=-1/0,c=-1/0,h=0;h<n;++h)isNaN(e=+this._x.call(null,i=t[h]))||isNaN(i=+this._y.call(null,i))||((r[h]=e)<s&&(s=e),l<e&&(l=e),(a[h]=i)<o&&(o=i),c<i&&(c=i));if(!(l<s||c<o))for(this.cover(s,o).cover(l,c),h=0;h<n;++h)vs(this,r[h],a[h],t[h]);return this},e.cover=function(t,e){if(!isNaN(t=+t)&&!isNaN(e=+e)){var i=this._x0,n=this._y0,r=this._x1,a=this._y1;if(isNaN(i))r=(i=Math.floor(t))+1,a=(n=Math.floor(e))+1;else{for(var s,o,l=r-i,c=this._root;t<i||r<=t||e<n||a<=e;)switch(o=(e<n)<<1|t<i,(s=new Array(4))[o]=c,c=s,l*=2,o){case 0:r=i+l,a=n+l;break;case 1:i=r-l,a=n+l;break;case 2:r=i+l,n=a-l;break;case 3:i=r-l,n=a-l}this._root&&this._root.length&&(this._root=c)}this._x0=i,this._y0=n,this._x1=r,this._y1=a}return this},e.data=function(){var e=[];return this.visit(function(t){if(!t.length)for(;e.push(t.data),t=t.next;);}),e},e.extent=function(t){return arguments.length?this.cover(+t[0][0],+t[0][1]).cover(+t[1][0],+t[1][1]):isNaN(this._x0)?void 0:[[this._x0,this._y0],[this._x1,this._y1]]},e.find=function(t,e,i){var n,r,a,s,o,l,c,h,d=this._x0,u=this._y0,p=this._x1,g=this._y1,f=[],m=this._root;for(m&&f.push(new _(m,d,u,p,g)),null==i?i=1/0:(d=t-i,u=e-i,p=t+i,g=e+i,i*=i);n=f.pop();)!(m=n.node)||(o=n.x0)>p||(l=n.y0)>g||(s=n.x1)<d||(r=n.y1)<u||(m.length?(f.push(new _(m[3],a=(o+s)/2,c=(l+r)/2,s,r),new _(m[2],o,c,a,r),new _(m[1],a,l,s,c),new _(m[0],o,l,a,c)),(r=(c<=e)<<1|a<=t)&&(n=f[f.length-1],f[f.length-1]=f[f.length-1-r],f[f.length-1-r]=n)):(l=(s=t-+this._x.call(null,m.data))*s+(o=e-+this._y.call(null,m.data))*o)<i&&(d=t-(c=Math.sqrt(i=l)),u=e-c,p=t+c,g=e+c,h=m.data));return h},e.remove=function(t){if(!isNaN(a=+this._x.call(null,t))&&!isNaN(s=+this._y.call(null,t))){var e,i,n,r,a,s,o,l,c,h,d,u=this._root,p=this._x0,g=this._y0,f=this._x1,m=this._y1;if(u){if(u.length)for(;;){if((l=a>=(o=(p+f)/2))?p=o:f=o,(c=s>=(o=(g+m)/2))?g=o:m=o,!(u=(e=u)[h=c<<1|l]))return this;if(!u.length)break;(e[h+1&3]||e[h+2&3]||e[h+3&3])&&(i=e,d=h)}for(;u.data!==t;)if(!(u=(n=u).next))return this;if((r=u.next)&&delete u.next,n)return r?n.next=r:delete n.next,this;if(!e)return this._root=r,this;r?e[h]=r:delete e[h],(u=e[0]||e[1]||e[2]||e[3])&&u===(e[3]||e[2]||e[1]||e[0])&&!u.length&&(i?i[d]=u:this._root=u)}}return this},e.removeAll=function(t){for(var e=0,i=t.length;e<i;++e)this.remove(t[e]);return this},e.root=function(){return this._root},e.size=function(){var e=0;return this.visit(function(t){if(!t.length)for(;++e,t=t.next;);}),e},e.visit=function(t){var e,i,n,r,a,s,o,l=[],c=this._root;for(c&&l.push(new _(c,this._x0,this._y0,this._x1,this._y1));a=l.pop();)!t(c=a.node,i=a.x0,n=a.y0,r=a.x1,a=a.y1)&&c.length&&(s=(i+r)/2,o=(n+a)/2,(e=c[3])&&l.push(new _(e,s,o,r,a)),(e=c[2])&&l.push(new _(e,i,o,s,a)),(e=c[1])&&l.push(new _(e,s,n,r,o)),(e=c[0])&&l.push(new _(e,i,n,s,o)));return this},e.visitAfter=function(t){var e,i=[],n=[];for(this._root&&i.push(new _(this._root,this._x0,this._y0,this._x1,this._y1));e=i.pop();){var r,a,s,o,l,c,h,d=e.node;d.length&&(a=e.x0,s=e.y0,c=(a+(o=e.x1))/2,h=(s+(l=e.y1))/2,(r=d[0])&&i.push(new _(r,a,s,c,h)),(r=d[1])&&i.push(new _(r,c,s,o,h)),(r=d[2])&&i.push(new _(r,a,h,c,l)),(r=d[3])&&i.push(new _(r,c,h,o,l))),n.push(e)}for(;e=n.pop();)t(e.node,e.x0,e.y0,e.x1,e.y1);return this},e.x=function(t){return arguments.length?(this._x=t,this):this._x},e.y=function(t){return arguments.length?(this._y=t,this):this._y};var As=Math.PI*(3-Math.sqrt(5));function Ps(t,e){if((e=(t=e?t.toExponential(e-1):t.toExponential()).indexOf("e"))<0)return null;var i=t.slice(0,e);return[1<i.length?i[0]+i.slice(2):i,+t.slice(e+1)]}function Ds(t){return(t=Ps(Math.abs(t)))?t[1]:NaN}var Es,Ns=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function Ls(t){if(e=Ns.exec(t))return new Rs({fill:e[1],align:e[2],sign:e[3],symbol:e[4],zero:e[5],width:e[6],comma:e[7],precision:e[8]&&e[8].slice(1),trim:e[9],type:e[10]});var e;throw new Error("invalid format: "+t)}function Rs(t){this.fill=void 0===t.fill?" ":t.fill+"",this.align=void 0===t.align?">":t.align+"",this.sign=void 0===t.sign?"-":t.sign+"",this.symbol=void 0===t.symbol?"":t.symbol+"",this.zero=!!t.zero,this.width=void 0===t.width?void 0:+t.width,this.comma=!!t.comma,this.precision=void 0===t.precision?void 0:+t.precision,this.trim=!!t.trim,this.type=void 0===t.type?"":t.type+""}function ks(t,e){e=Ps(t,e);if(!e)return t+"";t=e[0],e=e[1];return e<0?"0."+new Array(-e).join("0")+t:t.length>e+1?t.slice(0,e+1)+"."+t.slice(e+1):t+new Array(e-t.length+2).join("0")}Ls.prototype=Rs.prototype,Rs.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(void 0===this.width?"":Math.max(1,0|this.width))+(this.comma?",":"")+(void 0===this.precision?"":"."+Math.max(0,0|this.precision))+(this.trim?"~":"")+this.type};var Fs={"%":function(t,e){return(100*t).toFixed(e)},b:function(t){return Math.round(t).toString(2)},c:function(t){return t+""},d:function(t){return Math.round(t).toString(10)},e:function(t,e){return t.toExponential(e)},f:function(t,e){return t.toFixed(e)},g:function(t,e){return t.toPrecision(e)},o:function(t){return Math.round(t).toString(8)},p:function(t,e){return ks(100*t,e)},r:ks,s:function(t,e){if(!(n=Ps(t,e)))return t+"";var i=n[0],n=(n=n[1])-(Es=3*Math.max(-8,Math.min(8,Math.floor(n/3))))+1,r=i.length;return n===r?i:r<n?i+new Array(n-r+1).join("0"):0<n?i.slice(0,n)+"."+i.slice(n):"0."+new Array(1-n).join("0")+Ps(t,Math.max(0,e+n-1))[0]},X:function(t){return Math.round(t).toString(16).toUpperCase()},x:function(t){return Math.round(t).toString(16)}};function Vs(t){return t}var Us,$s=Array.prototype.map,Bs=["y","z","a","f","p","n","µ","m","","k","M","G","T","P","E","Z","Y"];function zs(t){var e,o,l,x=void 0===t.grouping||void 0===t.thousands?Vs:(o=$s.call(t.grouping,Number),l=t.thousands+"",function(t,e){for(var i=t.length,n=[],r=0,a=o[0],s=0;0<i&&0<a&&(e<s+a+1&&(a=Math.max(1,e-s)),n.push(t.substring(i-=a,i+a)),!((s+=a+1)>e));)a=o[r=(r+1)%o.length];return n.reverse().join(l)}),n=void 0===t.currency?"":t.currency[0]+"",r=void 0===t.currency?"":t.currency[1]+"",w=void 0===t.decimal?".":t.decimal+"",S=void 0===t.numerals?Vs:(e=$s.call(t.numerals,String),function(t){return t.replace(/[0-9]/g,function(t){return e[+t]})}),a=void 0===t.percent?"%":t.percent+"",M=void 0===t.minus?"-":t.minus+"",O=void 0===t.nan?"NaN":t.nan+"";function s(t){var c=(t=Ls(t)).fill,h=t.align,d=t.sign,e=t.symbol,u=t.zero,p=t.width,g=t.comma,f=t.precision,m=t.trim,_=t.type,v=("n"===_?(g=!0,_="g"):Fs[_]||(void 0===f&&(f=12),m=!0,_="g"),(u||"0"===c&&"="===h)&&(u=!0,c="0",h="="),"$"===e?n:"#"===e&&/[boxX]/.test(_)?"0"+_.toLowerCase():""),y="$"===e?r:/[%p]/.test(_)?a:"",b=Fs[_],C=/[defgprs%]/.test(_);function i(t){var e,i,n,r=v,a=y;if("c"===_)a=b(t)+a,t="";else{var s=(t=+t)<0||1/t<0;if(t=isNaN(t)?O:b(Math.abs(t),f),m&&(t=function(t){t:for(var e,i=t.length,n=1,r=-1;n<i;++n)switch(t[n]){case".":r=e=n;break;case"0":0===r&&(r=n),e=n;break;default:if(!+t[n])break t;0<r&&(r=0)}return 0<r?t.slice(0,r)+t.slice(e+1):t}(t)),r=((s=s&&0==+t&&"+"!==d?!1:s)?"("===d?d:M:"-"===d||"("===d?"":d)+r,a=("s"===_?Bs[8+Es/3]:"")+a+(s&&"("===d?")":""),C)for(e=-1,i=t.length;++e<i;)if((n=t.charCodeAt(e))<48||57<n){a=(46===n?w+t.slice(e+1):t.slice(e))+a,t=t.slice(0,e);break}}g&&!u&&(t=x(t,1/0));var o=r.length+t.length+a.length,l=o<p?new Array(p-o+1).join(c):"";switch(g&&u&&(t=x(l+t,l.length?p-a.length:1/0),l=""),h){case"<":t=r+t+a+l;break;case"=":t=r+l+t+a;break;case"^":t=l.slice(0,o=l.length>>1)+r+t+a+l.slice(o);break;default:t=l+r+t+a}return S(t)}return f=void 0===f?6:/[gprs]/.test(_)?Math.max(1,Math.min(21,f)):Math.max(0,Math.min(20,f)),i.toString=function(){return t+""},i}return{format:s,formatPrefix:function(t,e){var i=s(((t=Ls(t)).type="f",t)),t=3*Math.max(-8,Math.min(8,Math.floor(Ds(e)/3))),n=Math.pow(10,-t),r=Bs[8+t/3];return function(t){return i(n*t)+r}}}}function js(t){return Us=zs(t),z.format=Us.format,z.formatPrefix=Us.formatPrefix,Us}function Hs(t){return Math.max(0,-Ds(Math.abs(t)))}function Ws(t,e){return Math.max(0,3*Math.max(-8,Math.min(8,Math.floor(Ds(e)/3)))-Ds(Math.abs(t)))}function Xs(t,e){return t=Math.abs(t),e=Math.abs(e)-t,Math.max(0,Ds(e)-Ds(t))+1}function Ys(){return new qs}function qs(){this.reset()}js({decimal:".",thousands:",",grouping:[3],currency:["$",""],minus:"-"}),qs.prototype={constructor:qs,reset:function(){this.s=this.t=0},add:function(t){Zs(Ks,t,this.t),Zs(this,Ks.s,this.s),this.s?this.t+=Ks.t:this.s=Ks.t},valueOf:function(){return this.s}};var Ks=new qs;function Zs(t,e,i){var n=t.s=e+i,r=n-e;t.t=e-(n-r)+(i-r)}var A=1e-6,O=Math.PI,G=O/2,Js=O/4,I=2*O,P=180/O,D=O/180,E=Math.abs,Qs=Math.atan,N=Math.atan2,T=Math.cos,to=Math.ceil,eo=Math.exp,io=Math.log,no=Math.pow,L=Math.sin,ro=Math.sign||function(t){return 0<t?1:t<0?-1:0},R=Math.sqrt,ao=Math.tan;function so(t){return 1<t?0:t<-1?O:Math.acos(t)}function k(t){return 1<t?G:t<-1?-G:Math.asin(t)}function oo(t){return(t=L(t/2))*t}function n(){}function lo(t,e){t&&ho.hasOwnProperty(t.type)&&ho[t.type](t,e)}var co={Feature:function(t,e){lo(t.geometry,e)},FeatureCollection:function(t,e){for(var i=t.features,n=-1,r=i.length;++n<r;)lo(i[n].geometry,e)}},ho={Sphere:function(t,e){e.sphere()},Point:function(t,e){t=t.coordinates,e.point(t[0],t[1],t[2])},MultiPoint:function(t,e){for(var i=t.coordinates,n=-1,r=i.length;++n<r;)t=i[n],e.point(t[0],t[1],t[2])},LineString:function(t,e){uo(t.coordinates,e,0)},MultiLineString:function(t,e){for(var i=t.coordinates,n=-1,r=i.length;++n<r;)uo(i[n],e,0)},Polygon:function(t,e){po(t.coordinates,e)},MultiPolygon:function(t,e){for(var i=t.coordinates,n=-1,r=i.length;++n<r;)po(i[n],e)},GeometryCollection:function(t,e){for(var i=t.geometries,n=-1,r=i.length;++n<r;)lo(i[n],e)}};function uo(t,e,i){var n,r=-1,a=t.length-i;for(e.lineStart();++r<a;)n=t[r],e.point(n[0],n[1],n[2]);e.lineEnd()}function po(t,e){var i=-1,n=t.length;for(e.polygonStart();++i<n;)uo(t[i],e,1);e.polygonEnd()}function go(t,e){t&&co.hasOwnProperty(t.type)?co[t.type](t,e):lo(t,e)}var fo,mo,_o,vo,yo,bo=Ys(),Co=Ys(),xo={point:n,lineStart:n,lineEnd:n,polygonStart:function(){bo.reset(),xo.lineStart=wo,xo.lineEnd=So},polygonEnd:function(){var t=+bo;Co.add(t<0?I+t:t),this.lineStart=this.lineEnd=this.point=n},sphere:function(){Co.add(I)}};function wo(){xo.point=Mo}function So(){Oo(fo,mo)}function Mo(t,e){xo.point=Oo,fo=t,mo=e,_o=t*=D,vo=T(e=(e*=D)/2+Js),yo=L(e)}function Oo(t,e){var i=(t*=D)-_o,n=0<=i?1:-1,i=n*i,r=T(e=(e*=D)/2+Js),e=L(e),a=yo*e,s=vo*r+a*T(i),a=a*n*L(i);bo.add(N(a,s)),_o=t,vo=r,yo=e}function Go(t){return[N(t[1],t[0]),k(t[2])]}function Io(t){var e=t[0],t=t[1],i=T(t);return[i*T(e),i*L(e),L(t)]}function To(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Ao(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}function Po(t,e){t[0]+=e[0],t[1]+=e[1],t[2]+=e[2]}function Do(t,e){return[t[0]*e,t[1]*e,t[2]*e]}function Eo(t){var e=R(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]/=e,t[1]/=e,t[2]/=e}var c,No,h,Lo,Ro,ko,Fo,Vo,Uo,$o,Bo,zo,jo,Ho,Wo,Xo,Yo,qo,Ko,Zo,Jo,Qo,tl,d,u,el,il=Ys(),nl={point:rl,lineStart:sl,lineEnd:ol,polygonStart:function(){nl.point=ll,nl.lineStart=cl,nl.lineEnd=hl,il.reset(),xo.polygonStart()},polygonEnd:function(){xo.polygonEnd(),nl.point=rl,nl.lineStart=sl,nl.lineEnd=ol,bo<0?(c=-(h=180),No=-(Lo=90)):A<il?Lo=90:il<-A&&(No=-90),$o[0]=c,$o[1]=h},sphere:function(){c=-(h=180),No=-(Lo=90)}};function rl(t,e){Uo.push($o=[c=t,h=t]),e<No&&(No=e),Lo<e&&(Lo=e)}function al(t,e){var i,n,r,a,s,o=Io([t*D,e*D]);Vo?(i=Ao(Vo,o),Eo(i=Ao([i[1],-i[0],0],i)),i=Go(i),s=t-Ro,r=i[0]*P*(n=0<s?1:-1),(s=180<E(s))^(n*Ro<r&&r<n*t)?(a=i[1]*P,Lo<a&&(Lo=a)):s^(n*Ro<(r=(r+360)%360-180)&&r<n*t)?(a=-i[1]*P)<No&&(No=a):(e<No&&(No=e),Lo<e&&(Lo=e)),s?t<Ro?dl(c,t)>dl(c,h)&&(h=t):dl(t,h)>dl(c,h)&&(c=t):c<=h?(t<c&&(c=t),h<t&&(h=t)):Ro<t?dl(c,t)>dl(c,h)&&(h=t):dl(t,h)>dl(c,h)&&(c=t)):Uo.push($o=[c=t,h=t]),e<No&&(No=e),Lo<e&&(Lo=e),Vo=o,Ro=t}function sl(){nl.point=al}function ol(){$o[0]=c,$o[1]=h,nl.point=rl,Vo=null}function ll(t,e){var i;Vo?(i=t-Ro,il.add(180<E(i)?i+(0<i?360:-360):i)):(ko=t,Fo=e),xo.point(t,e),al(t,e)}function cl(){xo.lineStart()}function hl(){ll(ko,Fo),xo.lineEnd(),E(il)>A&&(c=-(h=180)),$o[0]=c,$o[1]=h,Vo=null}function dl(t,e){return(e-=t)<0?e+360:e}function ul(t,e){return t[0]-e[0]}function pl(t,e){return t[0]<=t[1]?t[0]<=e&&e<=t[1]:e<t[0]||t[1]<e}var gl={sphere:n,point:fl,lineStart:_l,lineEnd:bl,polygonStart:function(){gl.lineStart=Cl,gl.lineEnd=xl},polygonEnd:function(){gl.lineStart=_l,gl.lineEnd=bl}};function fl(t,e){t*=D;var i=T(e*=D);ml(i*T(t),i*L(t),L(e))}function ml(t,e,i){jo+=(t-jo)/++Bo,Ho+=(e-Ho)/Bo,Wo+=(i-Wo)/Bo}function _l(){gl.point=vl}function vl(t,e){t*=D;var i=T(e*=D);d=i*T(t),u=i*L(t),el=L(e),gl.point=yl,ml(d,u,el)}function yl(t,e){t*=D;var i=T(e*=D),n=i*T(t),i=i*L(t),t=L(e),e=N(R((e=u*t-el*i)*e+(e=el*n-d*t)*e+(e=d*i-u*n)*e),d*n+u*i+el*t);zo+=e,Xo+=e*(d+(d=n)),Yo+=e*(u+(u=i)),qo+=e*(el+(el=t)),ml(d,u,el)}function bl(){gl.point=fl}function Cl(){gl.point=wl}function xl(){Sl(Qo,tl),gl.point=fl}function wl(t,e){Qo=t,tl=e,t*=D,e*=D,gl.point=Sl;var i=T(e);d=i*T(t),u=i*L(t),el=L(e),ml(d,u,el)}function Sl(t,e){t*=D;var i=T(e*=D),n=i*T(t),i=i*L(t),t=L(e),e=u*t-el*i,r=el*n-d*t,a=d*i-u*n,s=R(e*e+r*r+a*a),o=k(s),s=s&&-o/s;Ko+=s*e,Zo+=s*r,Jo+=s*a,zo+=o,Xo+=o*(d+(d=n)),Yo+=o*(u+(u=i)),qo+=o*(el+(el=t)),ml(d,u,el)}function Ml(t){return function(){return t}}function Ol(i,n){function t(t,e){return t=i(t,e),n(t[0],t[1])}return i.invert&&n.invert&&(t.invert=function(t,e){return(t=n.invert(t,e))&&i.invert(t[0],t[1])}),t}function Gl(t,e){return[E(t)>O?t+Math.round(-t/I)*I:t,e]}function Il(t,e,i){return(t%=I)?e||i?Ol(Al(t),Pl(e,i)):Al(t):e||i?Pl(e,i):Gl}function Tl(i){return function(t,e){return[O<(t+=i)?t-I:t<-O?t+I:t,e]}}function Al(t){var e=Tl(t);return e.invert=Tl(-t),e}function Pl(t,e){var r=T(t),a=L(t),s=T(e),o=L(e);function i(t,e){var i=T(e),n=T(t)*i,t=L(t)*i,i=L(e),e=i*r+n*a;return[N(t*s-e*o,n*r-i*a),k(e*s+t*o)]}return i.invert=function(t,e){var i=T(e),n=T(t)*i,t=L(t)*i,i=L(e),e=i*s-t*o;return[N(t*s+i*o,n*r+e*a),k(e*r-n*a)]},i}function Dl(e){function t(t){return(t=e(t[0]*D,t[1]*D))[0]*=P,t[1]*=P,t}return e=Il(e[0]*D,e[1]*D,2<e.length?e[2]*D:0),t.invert=function(t){return(t=e.invert(t[0]*D,t[1]*D))[0]*=P,t[1]*=P,t},t}function El(t,e,i,n,r,a){if(i){var s=T(e),o=L(e),l=n*i;null==r?(r=e+n*I,a=e-l/2):(r=Nl(s,r),a=Nl(s,a),(0<n?r<a:a<r)&&(r+=n*I));for(var c,h=r;0<n?a<h:h<a;h-=l)c=Go([s,-o*T(h),-o*L(h)]),t.point(c[0],c[1])}}function Nl(t,e){(e=Io(e))[0]-=t,Eo(e);t=so(-e[1]);return((-e[2]<0?-t:t)+I-A)%I}function Ll(){var i,e=[];return{point:function(t,e){i.push([t,e])},lineStart:function(){e.push(i=[])},lineEnd:n,rejoin:function(){1<e.length&&e.push(e.pop().concat(e.shift()))},result:function(){var t=e;return e=[],i=null,t}}}function Rl(t,e){return E(t[0]-e[0])<A&&E(t[1]-e[1])<A}function kl(t,e,i,n){this.x=t,this.z=e,this.o=i,this.e=n,this.v=!1,this.n=this.p=null}function Fl(t,e,i,n,a){var s,r,o=[],l=[];if(t.forEach(function(t){if(!((e=t.length-1)<=0)){var e,i,n=t[0],r=t[e];if(Rl(n,r)){for(a.lineStart(),s=0;s<e;++s)a.point((n=t[s])[0],n[1]);a.lineEnd()}else o.push(i=new kl(n,t,null,!0)),l.push(i.o=new kl(n,null,i,!1)),o.push(i=new kl(r,t,null,!1)),l.push(i.o=new kl(r,null,i,!0))}}),o.length){for(l.sort(e),Vl(o),Vl(l),s=0,r=l.length;s<r;++s)l[s].e=i=!i;for(var c,h,d=o[0];;){for(var u=d,p=!0;u.v;)if((u=u.n)===d)return;c=u.z,a.lineStart();do{if(u.v=u.o.v=!0,u.e){if(p)for(s=0,r=c.length;s<r;++s)a.point((h=c[s])[0],h[1]);else n(u.x,u.n.x,1,a);u=u.n}else{if(p)for(c=u.p.z,s=c.length-1;0<=s;--s)a.point((h=c[s])[0],h[1]);else n(u.x,u.p.x,-1,a);u=u.p}}while(c=(u=u.o).z,p=!p,!u.v);a.lineEnd()}}}function Vl(t){if(e=t.length){for(var e,i,n=0,r=t[0];++n<e;)r.n=i=t[n],i.p=r,r=i;r.n=i=t[0],i.p=r}}Gl.invert=Gl;var Ul=Ys();function $l(t){return E(t[0])<=O?t[0]:ro(t[0])*((E(t[0])+O)%I-O)}function Bl(t,e){var i=$l(e),n=e[1],e=L(n),r=[L(i),-T(i),0],a=0,s=0;Ul.reset(),1===e?n=G+A:-1===e&&(n=-G-A);for(var o=0,l=t.length;o<l;++o)if(h=(c=t[o]).length)for(var c,h,d=c[h-1],u=$l(d),p=d[1]/2+Js,g=L(p),f=T(p),m=0;m<h;++m,u=v,g=b,f=y,d=_){var _=c[m],v=$l(_),y=_[1]/2+Js,b=L(y),y=T(y),C=v-u,x=0<=C?1:-1,w=x*C,S=O<w,M=g*b;Ul.add(N(M*x*L(w),f*y+M*T(w))),a+=S?C+x*I:C,S^i<=u^i<=v&&(Eo(M=Ao(Io(d),Io(_))),Eo(w=Ao(r,M)),((x=(S^0<=C?-1:1)*k(w[2]))<n||n===x&&(M[0]||M[1]))&&(s+=S^0<=C?1:-1))}return(a<-A||a<A&&Ul<-A)^1&s}function zl(m,_,v,y){return function(o){var l,c,h,i=_(o),d=Ll(),u=_(d),p=!1,e={point:n,lineStart:r,lineEnd:a,polygonStart:function(){e.point=g,e.lineStart=s,e.lineEnd=f,c=[],l=[]},polygonEnd:function(){e.point=n,e.lineStart=r,e.lineEnd=a,c=st(c);var t=Bl(l,y);c.length?(p||(o.polygonStart(),p=!0),Fl(c,Hl,t,v,o)):t&&(p||(o.polygonStart(),p=!0),o.lineStart(),v(null,null,1,o),o.lineEnd()),p&&(o.polygonEnd(),p=!1),c=l=null},sphere:function(){o.polygonStart(),o.lineStart(),v(null,null,1,o),o.lineEnd(),o.polygonEnd()}};function n(t,e){m(t,e)&&o.point(t,e)}function t(t,e){i.point(t,e)}function r(){e.point=t,i.lineStart()}function a(){e.point=n,i.lineEnd()}function g(t,e){h.push([t,e]),u.point(t,e)}function s(){u.lineStart(),h=[]}function f(){g(h[0][0],h[0][1]),u.lineEnd();var t,e,i,n,r=u.clean(),a=d.result(),s=a.length;if(h.pop(),l.push(h),h=null,s)if(1&r){if(0<(e=(i=a[0]).length-1)){for(p||(o.polygonStart(),p=!0),o.lineStart(),t=0;t<e;++t)o.point((n=i[t])[0],n[1]);o.lineEnd()}}else 1<s&&2&r&&a.push(a.pop().concat(a.shift())),c.push(a.filter(jl))}return e}}function jl(t){return 1<t.length}function Hl(t,e){return((t=t.x)[0]<0?t[1]-G-A:G-t[1])-((e=e.x)[0]<0?e[1]-G-A:G-e[1])}var Wl=zl(function(){return 1},function(c){var h,d=NaN,u=NaN,p=NaN;return{lineStart:function(){c.lineStart(),h=1},point:function(t,e){var i,n,r,a,s,o=0<t?O:-O,l=E(t-d);E(l-O)<A?(c.point(d,u=0<(u+e)/2?G:-G),c.point(p,u),c.lineEnd(),c.lineStart(),c.point(o,u),c.point(t,u),h=0):p!==o&&O<=l&&(E(d-p)<A&&(d-=p*A),E(t-o)<A&&(t-=o*A),l=u,r=e,s=L((i=d)-(n=t)),u=E(s)>A?Qs((L(l)*(a=T(r))*L(n)-L(r)*(n=T(l))*L(i))/(n*a*s)):(l+r)/2,c.point(p,u),c.lineEnd(),c.lineStart(),c.point(o,u),h=0),c.point(d=t,u=e),p=o},lineEnd:function(){c.lineEnd(),d=u=NaN},clean:function(){return 2-h}}},function(t,e,i,n){var r;null==t?(r=i*G,n.point(-O,r),n.point(0,r),n.point(O,r),n.point(O,0),n.point(O,-r),n.point(0,-r),n.point(-O,-r),n.point(-O,0),n.point(-O,r)):E(t[0]-e[0])>A?(t=t[0]<e[0]?O:-O,r=i*t/2,n.point(-t,r),n.point(0,r),n.point(t,r)):n.point(e[0],e[1])},[-O,-G]);function Xl(r){var p=T(r),a=6*D,d=0<p,u=E(p)>A;function g(t,e){return T(t)*T(e)>p}function f(t,e,i){var n=[1,0,0],r=Ao(Io(t),Io(e)),a=To(r,r),s=r[0],o=a-s*s;if(!o)return!i&&t;var l=Ao(n,r),n=Do(n,p*a/o),a=(Po(n,Do(r,-p*s/o)),l),r=To(n,a),s=To(a,a),o=r*r-s*(To(n,n)-1);if(!(o<0)){l=R(o),o=Do(a,(-r-l)/s);if(Po(o,n),o=Go(o),!i)return o;var c,i=t[0],h=e[0],t=t[1],e=e[1],d=(h<i&&(c=i,i=h,h=c),h-i),u=E(d-O)<A;return!u&&e<t&&(c=t,t=e,e=c),(u||d<A?u?0<t+e^o[1]<(E(o[0]-i)<A?t:e):t<=o[1]&&o[1]<=e:O<d^(i<=o[0]&&o[0]<=h))?(Po(c=Do(a,(-r+l)/s),n),[o,Go(c)]):void 0}}function m(t,e){var i=d?r:O-r,n=0;return t<-i?n|=1:i<t&&(n|=2),e<-i?n|=4:i<e&&(n|=8),n}return zl(g,function(a){var s,o,l,c,h;return{lineStart:function(){c=l=!1,h=1},point:function(t,e){var i,n=[t,e],r=g(t,e),t=d?r?0:m(t,e):r?m(t+(t<0?O:-O),e):0;!s&&(c=l=r)&&a.lineStart(),r===l||(i=f(s,n))&&!Rl(s,i)&&!Rl(n,i)||(n[0]+=A,n[1]+=A,r=g(n[0],n[1])),r!==l?(h=0,r?(a.lineStart(),i=f(n,s),a.point(i[0],i[1])):(i=f(s,n),a.point(i[0],i[1]),a.lineEnd()),s=i):u&&s&&d^r&&(t&o||!(e=f(n,s,!0))||(h=0,d?(a.lineStart(),a.point(e[0][0],e[0][1]),a.point(e[1][0],e[1][1]),a.lineEnd()):(a.point(e[1][0],e[1][1]),a.lineEnd(),a.lineStart(),a.point(e[0][0],e[0][1])))),!r||s&&Rl(s,n)||a.point(n[0],n[1]),s=n,l=r,o=t},lineEnd:function(){l&&a.lineEnd(),s=null},clean:function(){return h|(c&&l)<<1}}},function(t,e,i,n){El(n,r,a,i,t,e)},d?[0,-r]:[-O,r-O])}var Yl=1e9,ql=-Yl;function Kl(_,v,y,b){function C(t,e){return _<=t&&t<=y&&v<=e&&e<=b}function x(t,e,i,n){var r=0,a=0;if(null==t||(r=s(t,i))!==(a=s(e,i))||o(t,e)<0^0<i)for(;n.point(0===r||3===r?_:y,1<r?b:v),(r=(r+i+4)%4)!==a;);else n.point(e[0],e[1])}function s(t,e){return E(t[0]-_)<A?0<e?0:3:E(t[0]-y)<A?0<e?2:1:E(t[1]-v)<A?0<e?1:0:0<e?3:2}function w(t,e){return o(t.x,e.x)}function o(t,e){var i=s(t,1),n=s(e,1);return i!==n?i-n:0===i?e[1]-t[1]:1===i?t[0]-e[0]:2===i?t[1]-e[1]:e[0]-t[0]}return function(n){var r,d,a,s,o,l,c,h,u,p,g,f=n,t=Ll(),e={point:i,lineStart:function(){e.point=m,d&&d.push(a=[]);p=!0,u=!1,c=h=NaN},lineEnd:function(){r&&(m(s,o),l&&u&&t.rejoin(),r.push(t.result()));e.point=i,u&&f.lineEnd()},polygonStart:function(){f=t,r=[],d=[],g=!0},polygonEnd:function(){var t=function(){for(var t=0,e=0,i=d.length;e<i;++e)for(var n,r,a=d[e],s=1,o=a.length,l=a[0],c=l[0],h=l[1];s<o;++s)n=c,r=h,l=a[s],c=l[0],h=l[1],r<=b?b<h&&(h-r)*(_-n)<(c-n)*(b-r)&&++t:h<=b&&(c-n)*(b-r)<(h-r)*(_-n)&&--t;return t}(),e=g&&t,i=(r=st(r)).length;(e||i)&&(n.polygonStart(),e&&(n.lineStart(),x(null,null,1,n),n.lineEnd()),i&&Fl(r,w,t,x,n),n.polygonEnd());f=n,r=d=a=null}};function i(t,e){C(t,e)&&f.point(t,e)}function m(t,e){var i,n,r=C(t,e);d&&a.push([t,e]),p?(s=t,o=e,p=!1,(l=r)&&(f.lineStart(),f.point(t,e))):r&&u?f.point(t,e):!function(t,e,i,n,r,a){var s=t[0],o=t[1],l=0,c=1,h=e[0]-s,d=e[1]-o,i=i-s;if(h||!(0<i)){if(i/=h,h<0){if(i<l)return;i<c&&(c=i)}else if(0<h){if(c<i)return;l<i&&(l=i)}if(i=r-s,h||!(i<0)){if(i/=h,h<0){if(c<i)return;l<i&&(l=i)}else if(0<h){if(i<l)return;i<c&&(c=i)}if(i=n-o,d||!(0<i)){if(i/=d,d<0){if(i<l)return;i<c&&(c=i)}else if(0<d){if(c<i)return;l<i&&(l=i)}if(i=a-o,d||!(i<0)){if(i/=d,d<0){if(c<i)return;l<i&&(l=i)}else if(0<d){if(i<l)return;i<c&&(c=i)}return 0<l&&(t[0]=s+l*h,t[1]=o+l*d),c<1&&(e[0]=s+c*h,e[1]=o+c*d),1}}}}}(i=[c=Math.max(ql,Math.min(Yl,c)),h=Math.max(ql,Math.min(Yl,h))],n=[t=Math.max(ql,Math.min(Yl,t)),e=Math.max(ql,Math.min(Yl,e))],_,v,y,b)?r&&(f.lineStart(),f.point(t,e),g=!1):(u||(f.lineStart(),f.point(i[0],i[1])),f.point(n[0],n[1]),r||f.lineEnd(),g=!1),c=t,h=e,u=r}return e}}var Zl,Jl,Ql,tc=Ys(),ec={sphere:n,point:n,lineStart:function(){ec.point=nc,ec.lineEnd=ic},lineEnd:n,polygonStart:n,polygonEnd:n};function ic(){ec.point=ec.lineEnd=n}function nc(t,e){Zl=t*=D,Jl=L(e*=D),Ql=T(e),ec.point=rc}function rc(t,e){t*=D;var i=L(e*=D),e=T(e),n=E(t-Zl),r=T(n),n=e*L(n),a=Ql*i-Jl*e*r,r=Jl*i+Ql*e*r;tc.add(N(R(n*n+a*a),r)),Zl=t,Jl=i,Ql=e}function ac(t){return tc.reset(),go(t,ec),+tc}var sc=[null,null],oc={type:"LineString",coordinates:sc};function lc(t,e){return sc[0]=t,sc[1]=e,ac(oc)}var cc={Feature:function(t,e){return dc(t.geometry,e)},FeatureCollection:function(t,e){for(var i=t.features,n=-1,r=i.length;++n<r;)if(dc(i[n].geometry,e))return!0;return!1}},hc={Sphere:function(){return!0},Point:function(t,e){return uc(t.coordinates,e)},MultiPoint:function(t,e){for(var i=t.coordinates,n=-1,r=i.length;++n<r;)if(uc(i[n],e))return!0;return!1},LineString:function(t,e){return pc(t.coordinates,e)},MultiLineString:function(t,e){for(var i=t.coordinates,n=-1,r=i.length;++n<r;)if(pc(i[n],e))return!0;return!1},Polygon:function(t,e){return gc(t.coordinates,e)},MultiPolygon:function(t,e){for(var i=t.coordinates,n=-1,r=i.length;++n<r;)if(gc(i[n],e))return!0;return!1},GeometryCollection:function(t,e){for(var i=t.geometries,n=-1,r=i.length;++n<r;)if(dc(i[n],e))return!0;return!1}};function dc(t,e){return!(!t||!hc.hasOwnProperty(t.type))&&hc[t.type](t,e)}function uc(t,e){return 0===lc(t,e)}function pc(t,e){for(var i,n,r,a=0,s=t.length;a<s;a++){if(0===(n=lc(t[a],e)))return!0;if(0<a&&0<(r=lc(t[a],t[a-1]))&&i<=r&&n<=r&&(i+n-r)*(1-Math.pow((i-n)/r,2))<1e-12*r)return!0;i=n}return!1}function gc(t,e){return!!Bl(t.map(fc),mc(e))}function fc(t){return(t=t.map(mc)).pop(),t}function mc(t){return[t[0]*D,t[1]*D]}function _c(t,e,i){var n=K(t,e-A,i).concat(e);return function(e){return n.map(function(t){return[e,t]})}}function vc(t,e,i){var n=K(t,e-A,i).concat(e);return function(e){return n.map(function(t){return[t,e]})}}function yc(){var e,i,n,r,a,s,o,l,c,h,d,u,p=10,g=p,f=90,m=360,_=2.5;function v(){return{type:"MultiLineString",coordinates:t()}}function t(){return K(to(r/f)*f,n,f).map(d).concat(K(to(l/m)*m,o,m).map(u)).concat(K(to(i/p)*p,e,p).filter(function(t){return E(t%f)>A}).map(c)).concat(K(to(s/g)*g,a,g).filter(function(t){return E(t%m)>A}).map(h))}return v.lines=function(){return t().map(function(t){return{type:"LineString",coordinates:t}})},v.outline=function(){return{type:"Polygon",coordinates:[d(r).concat(u(o).slice(1),d(n).reverse().slice(1),u(l).reverse().slice(1))]}},v.extent=function(t){return arguments.length?v.extentMajor(t).extentMinor(t):v.extentMinor()},v.extentMajor=function(t){return arguments.length?(r=+t[0][0],n=+t[1][0],l=+t[0][1],o=+t[1][1],n<r&&(t=r,r=n,n=t),o<l&&(t=l,l=o,o=t),v.precision(_)):[[r,l],[n,o]]},v.extentMinor=function(t){return arguments.length?(i=+t[0][0],e=+t[1][0],s=+t[0][1],a=+t[1][1],e<i&&(t=i,i=e,e=t),a<s&&(t=s,s=a,a=t),v.precision(_)):[[i,s],[e,a]]},v.step=function(t){return arguments.length?v.stepMajor(t).stepMinor(t):v.stepMinor()},v.stepMajor=function(t){return arguments.length?(f=+t[0],m=+t[1],v):[f,m]},v.stepMinor=function(t){return arguments.length?(p=+t[0],g=+t[1],v):[p,g]},v.precision=function(t){return arguments.length?(_=+t,c=_c(s,a,90),h=vc(i,e,_),d=_c(l,o,90),u=vc(r,n,_),v):_},v.extentMajor([[-180,-90+A],[180,90-A]]).extentMinor([[-180,-80-A],[180,80+A]])}function bc(t){return t}var Cc,xc,wc,Sc,Mc=Ys(),Oc=Ys(),Gc={point:n,lineStart:n,lineEnd:n,polygonStart:function(){Gc.lineStart=Ic,Gc.lineEnd=Pc},polygonEnd:function(){Gc.lineStart=Gc.lineEnd=Gc.point=n,Mc.add(E(Oc)),Oc.reset()},result:function(){var t=Mc/2;return Mc.reset(),t}};function Ic(){Gc.point=Tc}function Tc(t,e){Gc.point=Ac,Cc=wc=t,xc=Sc=e}function Ac(t,e){Oc.add(Sc*t-wc*e),wc=t,Sc=e}function Pc(){Ac(Cc,xc)}var Dc=1/0,Ec=Dc,Nc=-Dc,Lc=Nc,Rc={point:function(t,e){t<Dc&&(Dc=t);Nc<t&&(Nc=t);e<Ec&&(Ec=e);Lc<e&&(Lc=e)},lineStart:n,lineEnd:n,polygonStart:n,polygonEnd:n,result:function(){var t=[[Dc,Ec],[Nc,Lc]];return Nc=Lc=-(Ec=Dc=1/0),t}};var kc,Fc,Vc,Uc,$c=0,Bc=0,zc=0,jc=0,Hc=0,Wc=0,Xc=0,Yc=0,qc=0,Kc={point:Zc,lineStart:Jc,lineEnd:eh,polygonStart:function(){Kc.lineStart=ih,Kc.lineEnd=nh},polygonEnd:function(){Kc.point=Zc,Kc.lineStart=Jc,Kc.lineEnd=eh},result:function(){var t=qc?[Xc/qc,Yc/qc]:Wc?[jc/Wc,Hc/Wc]:zc?[$c/zc,Bc/zc]:[NaN,NaN];return $c=Bc=zc=jc=Hc=Wc=Xc=Yc=qc=0,t}};function Zc(t,e){$c+=t,Bc+=e,++zc}function Jc(){Kc.point=Qc}function Qc(t,e){Kc.point=th,Zc(Vc=t,Uc=e)}function th(t,e){var i=t-Vc,n=e-Uc,i=R(i*i+n*n);jc+=i*(Vc+t)/2,Hc+=i*(Uc+e)/2,Wc+=i,Zc(Vc=t,Uc=e)}function eh(){Kc.point=Zc}function ih(){Kc.point=rh}function nh(){ah(kc,Fc)}function rh(t,e){Kc.point=ah,Zc(kc=Vc=t,Fc=Uc=e)}function ah(t,e){var i=t-Vc,n=e-Uc,i=R(i*i+n*n);jc+=i*(Vc+t)/2,Hc+=i*(Uc+e)/2,Wc+=i,Xc+=(i=Uc*t-Vc*e)*(Vc+t),Yc+=i*(Uc+e),qc+=3*i,Zc(Vc=t,Uc=e)}function sh(t){this._context=t}sh.prototype={_radius:4.5,pointRadius:function(t){return this._radius=t,this},polygonStart:function(){this._line=0},polygonEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){0===this._line&&this._context.closePath(),this._point=NaN},point:function(t,e){switch(this._point){case 0:this._context.moveTo(t,e),this._point=1;break;case 1:this._context.lineTo(t,e);break;default:this._context.moveTo(t+this._radius,e),this._context.arc(t,e,this._radius,0,I)}},result:n};var oh,lh,ch,hh,dh,uh=Ys(),ph={point:n,lineStart:function(){ph.point=gh},lineEnd:function(){oh&&fh(lh,ch),ph.point=n},polygonStart:function(){oh=!0},polygonEnd:function(){oh=null},result:function(){var t=+uh;return uh.reset(),t}};function gh(t,e){ph.point=fh,lh=hh=t,ch=dh=e}function fh(t,e){hh-=t,dh-=e,uh.add(R(hh*hh+dh*dh)),hh=t,dh=e}function mh(){this._string=[]}function _h(t){return"m0,"+t+"a"+t+","+t+" 0 1,1 0,"+-2*t+"a"+t+","+t+" 0 1,1 0,"+2*t+"z"}function vh(n){return function(t){var e,i=new yh;for(e in n)i[e]=n[e];return i.stream=t,i}}function yh(){}function bh(t,e,i){var n=t.clipExtent&&t.clipExtent();return t.scale(150).translate([0,0]),null!=n&&t.clipExtent(null),go(i,t.stream(Rc)),e(Rc.result()),null!=n&&t.clipExtent(n),t}function Ch(r,a,t){return bh(r,function(t){var e=a[1][0]-a[0][0],i=a[1][1]-a[0][1],n=Math.min(e/(t[1][0]-t[0][0]),i/(t[1][1]-t[0][1])),e=+a[0][0]+(e-n*(t[1][0]+t[0][0]))/2,i=+a[0][1]+(i-n*(t[1][1]+t[0][1]))/2;r.scale(150*n).translate([e,i])},t)}function xh(t,e,i){return Ch(t,[[0,0],e],i)}function wh(n,r,t){return bh(n,function(t){var e=+r,i=e/(t[1][0]-t[0][0]),e=(e-i*(t[1][0]+t[0][0]))/2,t=-i*t[0][1];n.scale(150*i).translate([e,t])},t)}function Sh(r,a,t){return bh(r,function(t){var e=+a,i=e/(t[1][1]-t[0][1]),n=-i*t[0][0],e=(e-i*(t[1][1]+t[0][1]))/2;r.scale(150*i).translate([n,e])},t)}mh.prototype={_radius:4.5,_circle:_h(4.5),pointRadius:function(t){return(t=+t)!==this._radius&&(this._radius=t,this._circle=null),this},polygonStart:function(){this._line=0},polygonEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){0===this._line&&this._string.push("Z"),this._point=NaN},point:function(t,e){switch(this._point){case 0:this._string.push("M",t,",",e),this._point=1;break;case 1:this._string.push("L",t,",",e);break;default:null==this._circle&&(this._circle=_h(this._radius)),this._string.push("M",t,",",e,this._circle)}},result:function(){var t;return this._string.length?(t=this._string.join(""),this._string=[],t):null}},yh.prototype={constructor:yh,point:function(t,e){this.stream.point(t,e)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}};var Mh=16,Oh=T(30*D);function Gh(t,e){return+e?(G=t,I=e,function(n){var i,r,a,s,o,l,c,h,d,u,p,g,f={point:t,lineStart:e,lineEnd:_,polygonStart:function(){n.polygonStart(),f.lineStart=v},polygonEnd:function(){n.polygonEnd(),f.lineStart=e}};function t(t,e){t=G(t,e),n.point(t[0],t[1])}function e(){h=NaN,f.point=m,n.lineStart()}function m(t,e){var i=Io([t,e]),e=G(t,e);T(h,d,c,u,p,g,h=e[0],d=e[1],c=t,u=i[0],p=i[1],g=i[2],Mh,n),n.point(h,d)}function _(){f.point=t,n.lineEnd()}function v(){e(),f.point=y,f.lineEnd=b}function y(t,e){m(i=t,e),r=h,a=d,s=u,o=p,l=g,f.point=m}function b(){T(h,d,c,u,p,g,r,a,i,s,o,l,Mh,n),f.lineEnd=_,_()}return f}):(i=t,vh({point:function(t,e){t=i(t,e),this.stream.point(t[0],t[1])}}));var i,G,I;function T(t,e,i,n,r,a,s,o,l,c,h,d,u,p){var g,f,m,_,v,y,b,C,x,w,S=s-t,M=o-e,O=S*S+M*M;4*I<O&&u--&&(m=a+d,b=k(m/=_=R((g=n+c)*g+(f=r+h)*f+m*m)),v=E(E(m)-1)<A||E(i-l)<A?(i+l)/2:N(f,g),y=(b=G(v,b))[0],b=b[1],(I<(w=M*(C=y-t)-S*(x=b-e))*w/O||.3<E((S*C+M*x)/O-.5)||n*c+r*h+a*d<Oh)&&(T(t,e,i,n,r,a,y,b,v,g/=_,f/=_,m,u,p),p.point(y,b),T(y,b,v,g,f,m,s,o,l,c,h,d,u,p)))}}var Ih=vh({point:function(t,e){this.stream.point(t*D,e*D)}});function Th(i,n,r,a,s){function t(t,e){return[n+i*(t*=a),r-i*(e*=s)]}return t.invert=function(t,e){return[(t-n)/i*a,(r-e)/i*s]},t}function Ah(t,i,n,r,a,e){var s=T(e),e=L(e),o=s*t,l=e*t,c=s/t,h=e/t,d=(e*n-s*i)/t,u=(e*i+s*n)/t;function p(t,e){return[o*(t*=r)-l*(e*=a)+i,n-l*t-o*e]}return p.invert=function(t,e){return[r*(c*t-h*e+d),a*(u-h*t-c*e)]},p}function Ph(t){return Dh(function(){return t})()}function Dh(t){var e,n,i,r,a,s,o,l,c,h,d=150,u=480,p=250,g=0,f=0,m=0,_=0,v=0,y=0,b=1,C=1,x=null,w=Wl,S=null,M=bc,O=.5;function G(t){return l(t[0]*D,t[1]*D)}function I(t){return(t=l.invert(t[0],t[1]))&&[t[0]*P,t[1]*P]}function T(){var t=Ah(d,0,0,b,C,y).apply(null,e(g,f)),t=(y?Ah:Th)(d,u-t[0],p-t[1],b,C,y);return n=Il(m,_,v),o=Ol(e,t),l=Ol(n,o),s=Gh(o,O),A()}function A(){return c=h=null,G}return G.stream=function(t){return c&&h===t?c:c=Ih((i=n,vh({point:function(t,e){t=i(t,e);return this.stream.point(t[0],t[1])}})(w(s(M(h=t))))));var i},G.preclip=function(t){return arguments.length?(w=t,x=void 0,A()):w},G.postclip=function(t){return arguments.length?(M=t,S=i=r=a=null,A()):M},G.clipAngle=function(t){return arguments.length?(w=+t?Xl(x=t*D):(x=null,Wl),A()):x*P},G.clipExtent=function(t){return arguments.length?(M=null==t?(S=i=r=a=null,bc):Kl(S=+t[0][0],i=+t[0][1],r=+t[1][0],a=+t[1][1]),A()):null==S?null:[[S,i],[r,a]]},G.scale=function(t){return arguments.length?(d=+t,T()):d},G.translate=function(t){return arguments.length?(u=+t[0],p=+t[1],T()):[u,p]},G.center=function(t){return arguments.length?(g=t[0]%360*D,f=t[1]%360*D,T()):[g*P,f*P]},G.rotate=function(t){return arguments.length?(m=t[0]%360*D,_=t[1]%360*D,v=2<t.length?t[2]%360*D:0,T()):[m*P,_*P,v*P]},G.angle=function(t){return arguments.length?(y=t%360*D,T()):y*P},G.reflectX=function(t){return arguments.length?(b=t?-1:1,T()):b<0},G.reflectY=function(t){return arguments.length?(C=t?-1:1,T()):C<0},G.precision=function(t){return arguments.length?(s=Gh(o,O=t*t),A()):R(O)},G.fitExtent=function(t,e){return Ch(G,t,e)},G.fitSize=function(t,e){return xh(G,t,e)},G.fitWidth=function(t,e){return wh(G,t,e)},G.fitHeight=function(t,e){return Sh(G,t,e)},function(){return e=t.apply(this,arguments),G.invert=e.invert&&I,T()}}function Eh(t){var e=0,i=O/3,n=Dh(t),t=n(e,i);return t.parallels=function(t){return arguments.length?n(e=t[0]*D,i=t[1]*D):[e*P,i*P]},t}function Nh(t,e){var i,n=L(t),r=(n+L(e))/2;if(E(r)<A)return i=T(t),a.invert=function(t,e){return[t/i,k(e*i)]},a;function a(t,e){return[t*i,L(e)/i]}var s=1+n*(2*r-n),o=R(s)/r;function l(t,e){e=R(s-2*r*L(e))/r;return[e*L(t*=r),o-e*T(t)]}return l.invert=function(t,e){var e=o-e,i=N(t,E(e))*ro(e);return e*r<0&&(i-=O*ro(t)*ro(e)),[i/r,k((s-(t*t+e*e)*r*r)/(2*r))]},l}function Lh(){return Eh(Nh).scale(155.424).center([0,33.6442])}function Rh(){return Lh().parallels([29.5,45.5]).scale(1070).translate([480,250]).rotate([96,0]).center([-.6,38.7])}function kh(r){return function(t,e){var i=T(t),n=T(e),i=r(i*n);return[i*n*L(t),i*L(e)]}}function Fh(a){return function(t,e){var i=R(t*t+e*e),n=a(i),r=L(n),n=T(n);return[N(t*r,i*n),k(i&&e*r/i)]}}var Vh=kh(function(t){return R(2/(1+t))});Vh.invert=Fh(function(t){return 2*k(t/2)});var Uh=kh(function(t){return(t=so(t))&&t/L(t)});function $h(t,e){return[t,io(ao((G+e)/2))]}function Bh(i){var n,r,a,s=Ph(i),e=s.center,o=s.scale,l=s.translate,c=s.clipExtent,h=null;function d(){var t=O*o(),e=s(Dl(s.rotate()).invert([0,0]));return c(null==h?[[e[0]-t,e[1]-t],[e[0]+t,e[1]+t]]:i===$h?[[Math.max(e[0]-t,h),n],[Math.min(e[0]+t,r),a]]:[[h,Math.max(e[1]-t,n)],[r,Math.min(e[1]+t,a)]])}return s.scale=function(t){return arguments.length?(o(t),d()):o()},s.translate=function(t){return arguments.length?(l(t),d()):l()},s.center=function(t){return arguments.length?(e(t),d()):e()},s.clipExtent=function(t){return arguments.length?(null==t?h=n=r=a=null:(h=+t[0][0],n=+t[0][1],r=+t[1][0],a=+t[1][1]),d()):null==h?null:[[h,n],[r,a]]},d()}function zh(t){return ao((G+t)/2)}function jh(t,e){var i=T(t),r=t===e?L(t):io(i/T(e))/io(zh(e)/zh(t)),a=i*no(zh(t),r)/r;return r?(n.invert=function(t,e){var e=a-e,i=ro(r)*R(t*t+e*e),n=N(t,E(e))*ro(e);return e*r<0&&(n-=O*ro(t)*ro(e)),[n/r,2*Qs(no(a/i,1/r))-G]},n):$h;function n(t,e){0<a?e<-G+A&&(e=-G+A):G-A<e&&(e=G-A);e=a/no(zh(e),r);return[e*L(r*t),a-e*T(r*t)]}}function Hh(t,e){return[t,e]}function Wh(t,e){var i=T(t),n=t===e?L(t):(i-T(e))/(e-t),r=i/n+t;return E(n)<A?Hh:(a.invert=function(t,e){var e=r-e,i=N(t,E(e))*ro(e);return e*n<0&&(i-=O*ro(t)*ro(e)),[i/n,r-ro(n)*R(t*t+e*e)]},a);function a(t,e){e=r-e,t*=n;return[e*L(t),r-e*T(t)]}}Uh.invert=Fh(function(t){return t}),$h.invert=function(t,e){return[t,2*Qs(eo(e))-G]},Hh.invert=Hh;var Xh=1.340264,Yh=-.081106,qh=893e-6,Kh=.003796,Zh=R(3)/2;function Jh(t,e){var e=k(Zh*L(e)),i=e*e,n=i*i*i;return[t*T(e)/(Zh*(Xh+3*Yh*i+n*(7*qh+9*Kh*i))),e*(Xh+Yh*i+n*(qh+Kh*i))]}function Qh(t,e){var i=T(e),n=T(t)*i;return[i*L(t)/n,L(e)/n]}function td(t,e){var i=e*e,n=i*i;return[t*(.8707-.131979*i+n*(n*(.003971*i-.001529*n)-.013791)),e*(1.007226+i*(.015085+n*(.028874*i-.044475-.005916*n)))]}function ed(t,e){return[T(e)*L(t),L(e)]}function id(t,e){var i=T(e),n=1+T(t)*i;return[i*L(t)/n,L(e)/n]}function nd(t,e){return[io(ao((G+e)/2)),-t]}function rd(t,e){return t.parent===e.parent?1:2}function ad(t,e){return t+e.x}function sd(t,e){return Math.max(t,e.y)}function od(t){var e=0,i=t.children,n=i&&i.length;if(n)for(;0<=--n;)e+=i[n].value;else e=1;t.value=e}function ld(t,e){var i,n,r,a,s,o=new ud(t),l=+t.value&&(o.value=t.value),c=[o];for(null==e&&(e=cd);i=c.pop();)if(l&&(i.value=+i.data.value),(r=e(i.data))&&(s=r.length))for(i.children=new Array(s),a=s-1;0<=a;--a)c.push(n=i.children[a]=new ud(r[a])),n.parent=i,n.depth=i.depth+1;return o.eachBefore(dd)}function cd(t){return t.children}function hd(t){t.data=t.data.data}function dd(t){for(var e=0;t.height=e,(t=t.parent)&&t.height<++e;);}function ud(t){this.data=t,this.depth=this.height=0,this.parent=null}Jh.invert=function(t,e){for(var i,n=e,r=n*n,a=r*r*r,s=0;s<12&&(a=(r=(n-=i=(n*(Xh+Yh*r+a*(qh+Kh*r))-e)/(Xh+3*Yh*r+a*(7*qh+9*Kh*r)))*n)*r*r,!(E(i)<1e-12));++s);return[Zh*t*(Xh+3*Yh*r+a*(7*qh+9*Kh*r))/T(n),k(L(n)/Zh)]},Qh.invert=Fh(Qs),td.invert=function(t,e){var i=e,n=25;do{var r=i*i,a=r*r}while(i-=a=(i*(1.007226+r*(.015085+a*(.028874*r-.044475-.005916*a)))-e)/(1.007226+r*(.045255+a*(.259866*r-.311325-.005916*11*a))),E(a)>A&&0<--n);return[t/(.8707+(r=i*i)*(r*(r*r*r*(.003971-.001529*r)-.013791)-.131979)),i]},ed.invert=Fh(k),id.invert=Fh(function(t){return 2*Qs(t)}),nd.invert=function(t,e){return[-e,2*Qs(eo(t))-G]},ud.prototype=ld.prototype={constructor:ud,count:function(){return this.eachAfter(od)},each:function(t){var e,i,n,r,a,s=[this];do{for(i=s.reverse(),s=[];e=i.pop();)if(t(e),n=e.children)for(r=0,a=n.length;r<a;++r)s.push(n[r])}while(s.length);return this},eachAfter:function(t){for(var e,i,n,r=this,a=[r],s=[];r=a.pop();)if(s.push(r),e=r.children)for(i=0,n=e.length;i<n;++i)a.push(e[i]);for(;r=s.pop();)t(r);return this},eachBefore:function(t){for(var e,i,n,r=[this];e=r.pop();)if(t(e),i=e.children)for(n=i.length-1;0<=n;--n)r.push(i[n]);return this},sum:function(r){return this.eachAfter(function(t){for(var e=+r(t.data)||0,i=t.children,n=i&&i.length;0<=--n;)e+=i[n].value;t.value=e})},sort:function(e){return this.eachBefore(function(t){t.children&&t.children.sort(e)})},path:function(t){for(var e=this,i=function(t,e){if(t===e)return t;var i=t.ancestors(),n=e.ancestors(),r=null;t=i.pop(),e=n.pop();for(;t===e;)r=t,t=i.pop(),e=n.pop();return r}(e,t),n=[e];e!==i;)e=e.parent,n.push(e);for(var r=n.length;t!==i;)n.splice(r,0,t),t=t.parent;return n},ancestors:function(){for(var t=this,e=[t];t=t.parent;)e.push(t);return e},descendants:function(){var e=[];return this.each(function(t){e.push(t)}),e},leaves:function(){var e=[];return this.eachBefore(function(t){t.children||e.push(t)}),e},links:function(){var e=this,i=[];return e.each(function(t){t!==e&&i.push({source:t.parent,target:t})}),i},copy:function(){return ld(this).eachBefore(hd)}};var pd=Array.prototype.slice;function gd(t){for(var e,i,n=0,r=(t=function(t){for(var e,i,n=t.length;n;)i=Math.random()*n--|0,e=t[n],t[n]=t[i],t[i]=e;return t}(pd.call(t))).length,a=[];n<r;)e=t[n],i&&md(i,e)?++n:(i=function(t){switch(t.length){case 1:return function(t){return{x:t.x,y:t.y,r:t.r}}(t[0]);case 2:return vd(t[0],t[1]);case 3:return yd(t[0],t[1],t[2])}}(a=function(t,e){var i,n;if(_d(e,t))return[e];for(i=0;i<t.length;++i)if(fd(e,t[i])&&_d(vd(t[i],e),t))return[t[i],e];for(i=0;i<t.length-1;++i)for(n=i+1;n<t.length;++n)if(fd(vd(t[i],t[n]),e)&&fd(vd(t[i],e),t[n])&&fd(vd(t[n],e),t[i])&&_d(yd(t[i],t[n],e),t))return[t[i],t[n],e];throw new Error}(a,e)),n=0);return i}function fd(t,e){var i=t.r-e.r,n=e.x-t.x,e=e.y-t.y;return i<0||i*i<n*n+e*e}function md(t,e){var i=t.r-e.r+1e-6,n=e.x-t.x,e=e.y-t.y;return 0<i&&n*n+e*e<i*i}function _d(t,e){for(var i=0;i<e.length;++i)if(!md(t,e[i]))return;return 1}function vd(t,e){var i=t.x,n=t.y,t=t.r,r=e.x,a=e.y,e=e.r,s=r-i,o=a-n,l=e-t,c=Math.sqrt(s*s+o*o);return{x:(i+r+s/c*l)/2,y:(n+a+o/c*l)/2,r:(c+t+e)/2}}function yd(t,e,i){var n=t.x,r=t.y,t=t.r,a=e.x,s=e.y,e=e.r,o=i.x,l=i.y,i=i.r,c=n-a,h=n-o,d=r-s,u=r-l,p=e-t,g=i-t,f=n*n+r*r-t*t,a=f-a*a-s*s+e*e,s=f-o*o-l*l+i*i,e=h*d-c*u,f=(d*s-u*a)/(2*e)-n,o=(u*p-d*g)/e,l=(h*a-c*s)/(2*e)-r,i=(c*g-h*p)/e,u=o*o+i*i-1,d=2*(t+f*o+l*i),a=f*f+l*l-t*t,s=-(u?(d+Math.sqrt(d*d-4*u*a))/(2*u):a/d);return{x:n+f+o*s,y:r+l+i*s,r:s}}function bd(t,e,i){var n,r,a,s,o=t.x-e.x,l=t.y-e.y,c=o*o+l*l;c?(r=e.r+i.r,s=t.r+i.r,(s*=s)<(r*=r)?(n=(c+s-r)/(2*c),a=Math.sqrt(Math.max(0,s/c-n*n)),i.x=t.x-n*o-a*l,i.y=t.y-n*l+a*o):(n=(c+r-s)/(2*c),a=Math.sqrt(Math.max(0,r/c-n*n)),i.x=e.x+n*o-a*l,i.y=e.y+n*l+a*o)):(i.x=e.x+i.r,i.y=e.y)}function Cd(t,e){var i=t.r+e.r-1e-6,n=e.x-t.x,e=e.y-t.y;return 0<i&&n*n+e*e<i*i}function xd(t){var e=t._,t=t.next._,i=e.r+t.r,n=(e.x*t.r+t.x*e.r)/i,t=(e.y*t.r+t.y*e.r)/i;return n*n+t*t}function wd(t){this._=t,this.next=null,this.previous=null}function Sd(t){if(!(n=t.length))return 0;var e,i,n,r,a,s,o,l,c,h,d=t[0];if(d.x=0,d.y=0,!(1<n))return d.r;if(e=t[1],d.x=-e.r,e.x=d.r,e.y=0,!(2<n))return d.r+e.r;bd(e,d,i=t[2]),d=new wd(d),e=new wd(e),i=new wd(i),((d.next=i.previous=e).next=d.previous=i).next=e.previous=d;t:for(s=3;s<n;++s){bd(d._,e._,i=t[s]),i=new wd(i),o=e.next,l=d.previous,c=e._.r,h=d._.r;do{if(c<=h){if(Cd(o._,i._)){e=o,(d.next=e).previous=d,--s;continue t}c+=o._.r,o=o.next}else{if(Cd(l._,i._)){((d=l).next=e).previous=d,--s;continue t}h+=l._.r,l=l.previous}}while(o!==l.next);for(i.previous=d,i.next=e,d.next=e.previous=e=i,r=xd(d);(i=i.next)!==e;)(a=xd(i))<r&&(d=i,r=a);e=d.next}for(d=[e._],i=e;(i=i.next)!==e;)d.push(i._);for(i=gd(d),s=0;s<n;++s)(d=t[s]).x-=i.x,d.y-=i.y;return i.r}function Md(t){if("function"!=typeof t)throw new Error;return t}function Od(){return 0}function Gd(t){return function(){return t}}function Id(t){return Math.sqrt(t.value)}function Td(e){return function(t){t.children||(t.r=Math.max(0,+e(t)||0))}}function Ad(s,o){return function(t){if(e=t.children){var e,i,n,r=e.length,a=s(t)*o||0;if(a)for(i=0;i<r;++i)e[i].r+=a;if(n=Sd(e),a)for(i=0;i<r;++i)e[i].r-=a;t.r=n+a}}}function Pd(i){return function(t){var e=t.parent;t.r*=i,e&&(t.x=e.x+i*t.x,t.y=e.y+i*t.y)}}function Dd(t){t.x0=Math.round(t.x0),t.y0=Math.round(t.y0),t.x1=Math.round(t.x1),t.y1=Math.round(t.y1)}function Ed(t,e,i,n,r){for(var a,s=t.children,o=-1,l=s.length,c=t.value&&(n-e)/t.value;++o<l;)(a=s[o]).y0=i,a.y1=r,a.x0=e,a.x1=e+=a.value*c}var Nd={depth:-1},Ld={};function Rd(t){return t.id}function kd(t){return t.parentId}function Fd(t,e){return t.parent===e.parent?1:2}function Vd(t){var e=t.children;return e?e[0]:t.t}function Ud(t){var e=t.children;return e?e[e.length-1]:t.t}function $d(t,e){this._=t,this.parent=null,this.children=null,this.A=null,(this.a=this).z=0,this.m=0,this.c=0,this.s=0,this.t=null,this.i=e}function Bd(t,e,i,n,r){for(var a,s=t.children,o=-1,l=s.length,c=t.value&&(r-i)/t.value;++o<l;)(a=s[o]).x0=e,a.x1=n,a.y0=i,a.y1=i+=a.value*c}$d.prototype=Object.create(ud.prototype);e=(1+Math.sqrt(5))/2;function zd(t,e,i,n,r,a){for(var s,o,l,c,h,d,u,p,g,f,m,_=[],v=e.children,y=0,b=0,C=v.length,x=e.value;y<C;){for(l=r-i,c=a-n;!(h=v[b++].value)&&b<C;);for(m=(d=u=h)*h*(f=Math.max(c/l,l/c)/(x*t)),g=Math.max(u/m,m/d);b<C;++b){if(h+=o=v[b].value,o<d&&(d=o),u<o&&(u=o),m=h*h*f,g<(p=Math.max(u/m,m/d))){h-=o;break}g=p}_.push(s={value:h,dice:l<c,children:v.slice(y,b)}),s.dice?Ed(s,i,n,r,x?n+=c*h/x:a):Bd(s,i,n,x?i+=l*h/x:r,a),x-=h,y=b}return _}var jd=function e(a){function t(t,e,i,n,r){zd(a,t,e,i,n,r)}return t.ratio=function(t){return e(1<(t=+t)?t:1)},t}(e);e=function e(p){function t(t,e,i,n,r){if((a=t._squarify)&&a.ratio===p)for(var a,s,o,l,c,h=-1,d=a.length,u=t.value;++h<d;){for(o=(s=a[h]).children,l=s.value=0,c=o.length;l<c;++l)s.value+=o[l].value;s.dice?Ed(s,e,i,n,i+=(r-i)*s.value/u):Bd(s,e,i,e+=(n-e)*s.value/u,r),u-=s.value}else t._squarify=a=zd(p,t,e,i,n,r),a.ratio=p}return t.ratio=function(t){return e(1<(t=+t)?t:1)},t}(e);function Hd(t,e){return t[0]-e[0]||t[1]-e[1]}function Wd(t){for(var e,i,n,r=t.length,a=[0,1],s=2,o=2;o<r;++o){for(;1<s&&(e=t[a[s-2]],i=t[a[s-1]],n=t[o],(i[0]-e[0])*(n[1]-e[1])-(i[1]-e[1])*(n[0]-e[0])<=0);)--s;a[s++]=o}return a.slice(0,s)}function Xd(){return Math.random()}var Yd=function t(i){function e(t,e){return t=null==t?0:+t,e=null==e?1:+e,1===arguments.length?(e=t,t=0):e-=t,function(){return i()*e+t}}return e.source=t,e}(Xd),qd=function t(a){function e(e,i){var n,r;return e=null==e?0:+e,i=null==i?1:+i,function(){var t;if(null!=n)t=n,n=null;else for(;n=2*a()-1,t=2*a()-1,!(r=n*n+t*t)||1<r;);return e+i*t*Math.sqrt(-2*Math.log(r)/r)}}return e.source=t,e}(Xd),Kd=function t(e){function i(){var t=qd.source(e).apply(this,arguments);return function(){return Math.exp(t())}}return i.source=t,i}(Xd),Zd=function t(n){function e(i){return function(){for(var t=0,e=0;e<i;++e)t+=n();return t}}return e.source=t,e}(Xd),Jd=function t(i){function e(t){var e=Zd.source(i)(t);return function(){return e()/t}}return e.source=t,e}(Xd),Qd=function t(e){function i(t){return function(){return-Math.log(1-e())/t}}return i.source=t,i}(Xd);function tu(t,e){switch(arguments.length){case 0:break;case 1:this.range(t);break;default:this.range(e).domain(t)}return this}function eu(t,e){switch(arguments.length){case 0:break;case 1:this.interpolator(t);break;default:this.interpolator(e).domain(t)}return this}var iu=Array.prototype,nu=iu.map,ru=iu.slice,au={name:"implicit"};function su(){var a=ya(),s=[],n=[],r=au;function o(t){var e=t+"",i=a.get(e);if(!i){if(r!==au)return r;a.set(e,i=s.push(t))}return n[(i-1)%n.length]}return o.domain=function(t){if(!arguments.length)return s.slice();s=[],a=ya();for(var e,i,n=-1,r=t.length;++n<r;)a.has(i=(e=t[n])+"")||a.set(i,s.push(e));return o},o.range=function(t){return arguments.length?(n=ru.call(t),o):n.slice()},o.unknown=function(t){return arguments.length?(r=t,o):r},o.copy=function(){return su(s,n).unknown(r)},tu.apply(o,arguments),o}function ou(){var r,a,t=su().unknown(void 0),s=t.domain,o=t.range,l=[0,1],c=!1,h=0,d=0,u=.5;function e(){var t=s().length,e=l[1]<l[0],i=l[+e],n=l[1-e],n=(r=(n-i)/Math.max(1,t-h+2*d),c&&(r=Math.floor(r)),i+=(n-i-r*(t-h))*u,a=r*(1-h),c&&(i=Math.round(i),a=Math.round(a)),K(t).map(function(t){return i+r*t}));return o(e?n.reverse():n)}return delete t.unknown,t.domain=function(t){return arguments.length?(s(t),e()):s()},t.range=function(t){return arguments.length?(l=[+t[0],+t[1]],e()):l.slice()},t.rangeRound=function(t){return l=[+t[0],+t[1]],c=!0,e()},t.bandwidth=function(){return a},t.step=function(){return r},t.round=function(t){return arguments.length?(c=!!t,e()):c},t.padding=function(t){return arguments.length?(h=Math.min(1,d=+t),e()):h},t.paddingInner=function(t){return arguments.length?(h=Math.min(1,t),e()):h},t.paddingOuter=function(t){return arguments.length?(d=+t,e()):d},t.align=function(t){return arguments.length?(u=Math.max(0,Math.min(1,t)),e()):u},t.copy=function(){return ou(s(),l).round(c).paddingInner(h).paddingOuter(d).align(u)},tu.apply(e(),arguments)}function lu(t){return+t}var cu=[0,1];function S(t){return t}function hu(e,i){return(i-=e=+e)?function(t){return(t-e)/i}:(t=isNaN(i)?NaN:.5,function(){return t});var t}function du(t){var e=t[0],i=t[t.length-1];return i<e&&(t=e,e=i,i=t),function(t){return Math.max(e,Math.min(i,t))}}function uu(t,e,i){var n=t[0],t=t[1],r=e[0],e=e[1],r=t<n?(n=hu(t,n),i(e,r)):(n=hu(n,t),i(r,e));return function(t){return r(n(t))}}function pu(i,t,e){var n=Math.min(i.length,t.length)-1,r=new Array(n),a=new Array(n),s=-1;for(i[n]<i[0]&&(i=i.slice().reverse(),t=t.slice().reverse());++s<n;)r[s]=hu(i[s],i[s+1]),a[s]=e(t[s],t[s+1]);return function(t){var e=v(i,t,1,n)-1;return a[e](r[e](t))}}function gu(t,e){return e.domain(t.domain()).range(t.range()).interpolate(t.interpolate()).clamp(t.clamp()).unknown(t.unknown())}function fu(){var i,n,e,r,a,s,o=cu,l=cu,c=Ki,h=S;function d(){return r=2<Math.min(o.length,l.length)?pu:uu,a=s=null,u}function u(t){return isNaN(t=+t)?e:(a=a||r(o.map(i),l,c))(i(h(t)))}return u.invert=function(t){return h(n((s=s||r(l,o.map(i),Hi))(t)))},u.domain=function(t){return arguments.length?(o=nu.call(t,lu),h!==S&&(h=du(o)),d()):o.slice()},u.range=function(t){return arguments.length?(l=ru.call(t),d()):l.slice()},u.rangeRound=function(t){return l=ru.call(t),c=Zi,d()},u.clamp=function(t){return arguments.length?(h=t?du(o):S,u):h!==S},u.interpolate=function(t){return arguments.length?(c=t,d()):c},u.unknown=function(t){return arguments.length?(e=t,u):e},function(t,e){return i=t,n=e,d()}}function mu(t,e){return fu()(t,e)}function _u(t,e,i,n){var r,a=it(t,e,i);switch((n=Ls(null==n?",f":n)).type){case"s":var s=Math.max(Math.abs(t),Math.abs(e));return null!=n.precision||isNaN(r=Ws(a,s))||(n.precision=r),z.formatPrefix(n,s);case"":case"e":case"g":case"p":case"r":null!=n.precision||isNaN(r=Xs(a,Math.max(Math.abs(t),Math.abs(e))))||(n.precision=r-("e"===n.type));break;case"f":case"%":null!=n.precision||isNaN(r=Hs(a))||(n.precision=r-2*("%"===n.type))}return z.format(n)}function vu(o){var l=o.domain;return o.ticks=function(t){var e=l();return tt(e[0],e[e.length-1],null==t?10:t)},o.tickFormat=function(t,e){var i=l();return _u(i[0],i[i.length-1],null==t?10:t,e)},o.nice=function(t){null==t&&(t=10);var e,i=l(),n=0,r=i.length-1,a=i[n],s=i[r];return s<a&&(e=a,a=s,s=e,e=n,n=r,r=e),0<(e=et(a,s,t))?e=et(a=Math.floor(a/e)*e,s=Math.ceil(s/e)*e,t):e<0&&(e=et(a=Math.ceil(a*e)/e,s=Math.floor(s*e)/e,t)),0<e?(i[n]=Math.floor(a/e)*e,i[r]=Math.ceil(s/e)*e,l(i)):e<0&&(i[n]=Math.ceil(a*e)/e,i[r]=Math.floor(s*e)/e,l(i)),o},o}function yu(t,e){var i,n=0,r=(t=t.slice()).length-1,a=t[n],s=t[r];return s<a&&(i=n,n=r,r=i,i=a,a=s,s=i),t[n]=e.floor(a),t[r]=e.ceil(s),t}function bu(t){return Math.log(t)}function Cu(t){return Math.exp(t)}function xu(t){return-Math.log(-t)}function wu(t){return-Math.exp(-t)}function Su(t){return isFinite(t)?+("1e"+t):t<0?0:t}function Mu(e){return function(t){return-e(-t)}}function Ou(t){var h,d,r=t(bu,Cu),u=r.domain,p=10;function e(){var e,i;return h=(i=p)===Math.E?Math.log:10===i&&Math.log10||2===i&&Math.log2||(i=Math.log(i),function(t){return Math.log(t)/i}),d=10===(e=p)?Su:e===Math.E?Math.exp:function(t){return Math.pow(e,t)},u()[0]<0?(h=Mu(h),d=Mu(d),t(xu,wu)):t(bu,Cu),r}return r.base=function(t){return arguments.length?(p=+t,e()):p},r.domain=function(t){return arguments.length?(u(t),e()):u()},r.ticks=function(t){var e,i,n,r=u(),a=r[0],s=r[r.length-1],o=((r=s<a)&&(o=a,a=s,s=o),h(a)),l=h(s),t=null==t?10:+t,c=[];if(!(p%1)&&l-o<t){if(o=Math.round(o)-1,l=Math.round(l)+1,0<a){for(;o<l;++o)for(i=1,e=d(o);i<p;++i)if(!((n=e*i)<a)){if(s<n)break;c.push(n)}}else for(;o<l;++o)for(i=p-1,e=d(o);1<=i;--i)if(!((n=e*i)<a)){if(s<n)break;c.push(n)}}else c=tt(o,l,Math.min(l-o,t)).map(d);return r?c.reverse():c},r.tickFormat=function(t,i){if("function"!=typeof(i=null==i?10===p?".0e":",":i)&&(i=z.format(i)),t===1/0)return i;null==t&&(t=10);var n=Math.max(1,p*t/r.ticks().length);return function(t){var e=t/d(Math.round(h(t)));return e*p<p-.5&&(e*=p),e<=n?i(t):""}},r.nice=function(){return u(yu(u(),{floor:function(t){return d(Math.floor(h(t)))},ceil:function(t){return d(Math.ceil(h(t)))}}))},r}function Gu(e){return function(t){return Math.sign(t)*Math.log1p(Math.abs(t/e))}}function Iu(e){return function(t){return Math.sign(t)*Math.expm1(Math.abs(t))*e}}function Tu(e){var i=1,t=e(Gu(i),Iu(i));return t.constant=function(t){return arguments.length?e(Gu(i=+t),Iu(i)):i},vu(t)}function Au(e){return function(t){return t<0?-Math.pow(-t,e):Math.pow(t,e)}}function Pu(t){return t<0?-Math.sqrt(-t):Math.sqrt(t)}function Du(t){return t<0?-t*t:t*t}function Eu(e){var t=e(S,S),i=1;return t.exponent=function(t){return arguments.length?1===(i=+t)?e(S,S):.5===i?e(Pu,Du):e(Au(i),Au(1/i)):i},vu(t)}function Nu(){var t=Eu(fu());return t.copy=function(){return gu(t,Nu()).exponent(t.exponent())},tu.apply(t,arguments),t}var Lu=new Date,Ru=new Date;function r(a,s,i,n){function o(t){return a(t=0===arguments.length?new Date:new Date(+t)),t}return o.floor=function(t){return a(t=new Date(+t)),t},o.ceil=function(t){return a(t=new Date(t-1)),s(t,1),a(t),t},o.round=function(t){var e=o(t),i=o.ceil(t);return t-e<i-t?e:i},o.offset=function(t,e){return s(t=new Date(+t),null==e?1:Math.floor(e)),t},o.range=function(t,e,i){var n,r=[];if(t=o.ceil(t),i=null==i?1:Math.floor(i),t<e&&0<i)for(;r.push(n=new Date(+t)),s(t,i),a(t),n<t&&t<e;);return r},o.filter=function(i){return r(function(t){if(t<=t)for(;a(t),!i(t);)t.setTime(t-1)},function(t,e){if(t<=t)if(e<0)for(;++e<=0;)for(;s(t,-1),!i(t););else for(;0<=--e;)for(;s(t,1),!i(t););})},i&&(o.count=function(t,e){return Lu.setTime(+t),Ru.setTime(+e),a(Lu),a(Ru),Math.floor(i(Lu,Ru))},o.every=function(e){return e=Math.floor(e),isFinite(e)&&0<e?1<e?o.filter(n?function(t){return n(t)%e==0}:function(t){return o.count(0,t)%e==0}):o:null}),o}var ku=r(function(){},function(t,e){t.setTime(+t+e)},function(t,e){return e-t}),iu=(ku.every=function(i){return i=Math.floor(i),isFinite(i)&&0<i?1<i?r(function(t){t.setTime(Math.floor(t/i)*i)},function(t,e){t.setTime(+t+e*i)},function(t,e){return(e-t)/i}):ku:null},ku.range),Fu=r(function(t){t.setTime(t-t.getMilliseconds())},function(t,e){t.setTime(+t+1e3*e)},function(t,e){return(e-t)/1e3},function(t){return t.getUTCSeconds()}),Vu=Fu.range,Uu=r(function(t){t.setTime(t-t.getMilliseconds()-1e3*t.getSeconds())},function(t,e){t.setTime(+t+6e4*e)},function(t,e){return(e-t)/6e4},function(t){return t.getMinutes()}),$u=Uu.range,Bu=r(function(t){t.setTime(t-t.getMilliseconds()-1e3*t.getSeconds()-6e4*t.getMinutes())},function(t,e){t.setTime(+t+36e5*e)},function(t,e){return(e-t)/36e5},function(t){return t.getHours()}),zu=Bu.range,ju=r(function(t){t.setHours(0,0,0,0)},function(t,e){t.setDate(t.getDate()+e)},function(t,e){return(e-t-6e4*(e.getTimezoneOffset()-t.getTimezoneOffset()))/864e5},function(t){return t.getDate()-1}),Hu=ju.range;function Wu(e){return r(function(t){t.setDate(t.getDate()-(t.getDay()+7-e)%7),t.setHours(0,0,0,0)},function(t,e){t.setDate(t.getDate()+7*e)},function(t,e){return(e-t-6e4*(e.getTimezoneOffset()-t.getTimezoneOffset()))/6048e5})}var Xu=Wu(0),Yu=Wu(1),qu=Wu(2),Ku=Wu(3),Zu=Wu(4),Ju=Wu(5),Qu=Wu(6),tp=Xu.range,ep=Yu.range,ip=qu.range,np=Ku.range,rp=Zu.range,ap=Ju.range,sp=Qu.range,op=r(function(t){t.setDate(1),t.setHours(0,0,0,0)},function(t,e){t.setMonth(t.getMonth()+e)},function(t,e){return e.getMonth()-t.getMonth()+12*(e.getFullYear()-t.getFullYear())},function(t){return t.getMonth()}),lp=op.range,cp=r(function(t){t.setMonth(0,1),t.setHours(0,0,0,0)},function(t,e){t.setFullYear(t.getFullYear()+e)},function(t,e){return e.getFullYear()-t.getFullYear()},function(t){return t.getFullYear()}),hp=(cp.every=function(i){return isFinite(i=Math.floor(i))&&0<i?r(function(t){t.setFullYear(Math.floor(t.getFullYear()/i)*i),t.setMonth(0,1),t.setHours(0,0,0,0)},function(t,e){t.setFullYear(t.getFullYear()+e*i)}):null},cp.range),dp=r(function(t){t.setUTCSeconds(0,0)},function(t,e){t.setTime(+t+6e4*e)},function(t,e){return(e-t)/6e4},function(t){return t.getUTCMinutes()}),up=dp.range,pp=r(function(t){t.setUTCMinutes(0,0,0)},function(t,e){t.setTime(+t+36e5*e)},function(t,e){return(e-t)/36e5},function(t){return t.getUTCHours()}),gp=pp.range,fp=r(function(t){t.setUTCHours(0,0,0,0)},function(t,e){t.setUTCDate(t.getUTCDate()+e)},function(t,e){return(e-t)/864e5},function(t){return t.getUTCDate()-1}),mp=fp.range;function _p(e){return r(function(t){t.setUTCDate(t.getUTCDate()-(t.getUTCDay()+7-e)%7),t.setUTCHours(0,0,0,0)},function(t,e){t.setUTCDate(t.getUTCDate()+7*e)},function(t,e){return(e-t)/6048e5})}var vp=_p(0),yp=_p(1),bp=_p(2),Cp=_p(3),xp=_p(4),wp=_p(5),Sp=_p(6),Mp=vp.range,Op=yp.range,Gp=bp.range,Ip=Cp.range,Tp=xp.range,Ap=wp.range,Pp=Sp.range,Dp=r(function(t){t.setUTCDate(1),t.setUTCHours(0,0,0,0)},function(t,e){t.setUTCMonth(t.getUTCMonth()+e)},function(t,e){return e.getUTCMonth()-t.getUTCMonth()+12*(e.getUTCFullYear()-t.getUTCFullYear())},function(t){return t.getUTCMonth()}),Ep=Dp.range,Np=r(function(t){t.setUTCMonth(0,1),t.setUTCHours(0,0,0,0)},function(t,e){t.setUTCFullYear(t.getUTCFullYear()+e)},function(t,e){return e.getUTCFullYear()-t.getUTCFullYear()},function(t){return t.getUTCFullYear()}),Lp=(Np.every=function(i){return isFinite(i=Math.floor(i))&&0<i?r(function(t){t.setUTCFullYear(Math.floor(t.getUTCFullYear()/i)*i),t.setUTCMonth(0,1),t.setUTCHours(0,0,0,0)},function(t,e){t.setUTCFullYear(t.getUTCFullYear()+e*i)}):null},Np.range);function Rp(t){var e;return 0<=t.y&&t.y<100?((e=new Date(-1,t.m,t.d,t.H,t.M,t.S,t.L)).setFullYear(t.y),e):new Date(t.y,t.m,t.d,t.H,t.M,t.S,t.L)}function kp(t){var e;return 0<=t.y&&t.y<100?((e=new Date(Date.UTC(-1,t.m,t.d,t.H,t.M,t.S,t.L))).setUTCFullYear(t.y),e):new Date(Date.UTC(t.y,t.m,t.d,t.H,t.M,t.S,t.L))}function Fp(t,e,i){return{y:t,m:e,d:i,H:0,M:0,S:0,L:0}}function Vp(t){var n=t.dateTime,r=t.date,a=t.time,e=t.periods,i=t.days,s=t.shortDays,o=t.months,l=t.shortMonths,c=Hp(e),h=Wp(e),d=Hp(i),u=Wp(i),p=Hp(s),g=Wp(s),f=Hp(o),m=Wp(o),_=Hp(l),v=Wp(l),y={a:function(t){return s[t.getDay()]},A:function(t){return i[t.getDay()]},b:function(t){return l[t.getMonth()]},B:function(t){return o[t.getMonth()]},c:null,d:pg,e:pg,f:vg,H:gg,I:fg,j:mg,L:_g,m:yg,M:bg,p:function(t){return e[+(12<=t.getHours())]},q:function(t){return 1+~~(t.getMonth()/3)},Q:Yg,s:qg,S:Cg,u:xg,U:wg,V:Sg,w:Mg,W:Og,x:null,X:null,y:Gg,Y:Ig,Z:Tg,"%":Xg},b={a:function(t){return s[t.getUTCDay()]},A:function(t){return i[t.getUTCDay()]},b:function(t){return l[t.getUTCMonth()]},B:function(t){return o[t.getUTCMonth()]},c:null,d:Ag,e:Ag,f:Lg,H:Pg,I:Dg,j:Eg,L:Ng,m:Rg,M:kg,p:function(t){return e[+(12<=t.getUTCHours())]},q:function(t){return 1+~~(t.getUTCMonth()/3)},Q:Yg,s:qg,S:Fg,u:Vg,U:Ug,V:$g,w:Bg,W:zg,x:null,X:null,y:jg,Y:Hg,Z:Wg,"%":Xg},C={a:function(t,e,i){e=p.exec(e.slice(i));return e?(t.w=g[e[0].toLowerCase()],i+e[0].length):-1},A:function(t,e,i){e=d.exec(e.slice(i));return e?(t.w=u[e[0].toLowerCase()],i+e[0].length):-1},b:function(t,e,i){e=_.exec(e.slice(i));return e?(t.m=v[e[0].toLowerCase()],i+e[0].length):-1},B:function(t,e,i){e=f.exec(e.slice(i));return e?(t.m=m[e[0].toLowerCase()],i+e[0].length):-1},c:function(t,e,i){return S(t,n,e,i)},d:ng,e:ng,f:cg,H:ag,I:ag,j:rg,L:lg,m:ig,M:sg,p:function(t,e,i){e=c.exec(e.slice(i));return e?(t.p=h[e[0].toLowerCase()],i+e[0].length):-1},q:eg,Q:dg,s:ug,S:og,u:Yp,U:qp,V:Kp,w:Xp,W:Zp,x:function(t,e,i){return S(t,r,e,i)},X:function(t,e,i){return S(t,a,e,i)},y:Qp,Y:Jp,Z:tg,"%":hg};function x(l,c){return function(t){var e,i,n,r=[],a=-1,s=0,o=l.length;for(t instanceof Date||(t=new Date(+t));++a<o;)37===l.charCodeAt(a)&&(r.push(l.slice(s,a)),null!=(i=$p[e=l.charAt(++a)])?e=l.charAt(++a):i="e"===e?" ":"0",(n=c[e])&&(e=n(t,i)),r.push(e),s=a+1);return r.push(l.slice(s,a)),r.join("")}}function w(r,a){return function(t){var e,i,n=Fp(1900,void 0,1);if(S(n,r,t+="",0)!=t.length)return null;if("Q"in n)return new Date(n.Q);if("s"in n)return new Date(1e3*n.s+("L"in n?n.L:0));if(!a||"Z"in n||(n.Z=0),"p"in n&&(n.H=n.H%12+12*n.p),void 0===n.m&&(n.m="q"in n?n.q:0),"V"in n){if(n.V<1||53<n.V)return null;"w"in n||(n.w=1),"Z"in n?(e=4<(i=(e=kp(Fp(n.y,0,1))).getUTCDay())||0===i?yp.ceil(e):yp(e),e=fp.offset(e,7*(n.V-1)),n.y=e.getUTCFullYear(),n.m=e.getUTCMonth(),n.d=e.getUTCDate()+(n.w+6)%7):(e=4<(i=(e=Rp(Fp(n.y,0,1))).getDay())||0===i?Yu.ceil(e):Yu(e),e=ju.offset(e,7*(n.V-1)),n.y=e.getFullYear(),n.m=e.getMonth(),n.d=e.getDate()+(n.w+6)%7)}else("W"in n||"U"in n)&&("w"in n||(n.w="u"in n?n.u%7:"W"in n?1:0),i="Z"in n?kp(Fp(n.y,0,1)).getUTCDay():Rp(Fp(n.y,0,1)).getDay(),n.m=0,n.d="W"in n?(n.w+6)%7+7*n.W-(i+5)%7:n.w+7*n.U-(i+6)%7);return"Z"in n?(n.H+=n.Z/100|0,n.M+=n.Z%100,kp(n)):Rp(n)}}function S(t,e,i,n){for(var r,a,s=0,o=e.length,l=i.length;s<o;){if(l<=n)return-1;if(37===(r=e.charCodeAt(s++))){if(r=e.charAt(s++),!(a=C[r in $p?e.charAt(s++):r])||(n=a(t,i,n))<0)return-1}else if(r!=i.charCodeAt(n++))return-1}return n}return y.x=x(r,y),y.X=x(a,y),y.c=x(n,y),b.x=x(r,b),b.X=x(a,b),b.c=x(n,b),{format:function(t){var e=x(t+="",y);return e.toString=function(){return t},e},parse:function(t){var e=w(t+="",!1);return e.toString=function(){return t},e},utcFormat:function(t){var e=x(t+="",b);return e.toString=function(){return t},e},utcParse:function(t){var e=w(t+="",!0);return e.toString=function(){return t},e}}}var Up,$p={"-":"",_:" ",0:"0"},a=/^\s*\d+/,Bp=/^%/,zp=/[\\^$*+?|[\]().{}]/g;function s(t,e,i){var n=t<0?"-":"",t=(n?-t:t)+"",r=t.length;return n+(r<i?new Array(i-r+1).join(e)+t:t)}function jp(t){return t.replace(zp,"\\$&")}function Hp(t){return new RegExp("^(?:"+t.map(jp).join("|")+")","i")}function Wp(t){for(var e={},i=-1,n=t.length;++i<n;)e[t[i].toLowerCase()]=i;return e}function Xp(t,e,i){e=a.exec(e.slice(i,i+1));return e?(t.w=+e[0],i+e[0].length):-1}function Yp(t,e,i){e=a.exec(e.slice(i,i+1));return e?(t.u=+e[0],i+e[0].length):-1}function qp(t,e,i){e=a.exec(e.slice(i,i+2));return e?(t.U=+e[0],i+e[0].length):-1}function Kp(t,e,i){e=a.exec(e.slice(i,i+2));return e?(t.V=+e[0],i+e[0].length):-1}function Zp(t,e,i){e=a.exec(e.slice(i,i+2));return e?(t.W=+e[0],i+e[0].length):-1}function Jp(t,e,i){e=a.exec(e.slice(i,i+4));return e?(t.y=+e[0],i+e[0].length):-1}function Qp(t,e,i){e=a.exec(e.slice(i,i+2));return e?(t.y=+e[0]+(68<+e[0]?1900:2e3),i+e[0].length):-1}function tg(t,e,i){e=/^(Z)|([+-]\d\d)(?::?(\d\d))?/.exec(e.slice(i,i+6));return e?(t.Z=e[1]?0:-(e[2]+(e[3]||"00")),i+e[0].length):-1}function eg(t,e,i){e=a.exec(e.slice(i,i+1));return e?(t.q=3*e[0]-3,i+e[0].length):-1}function ig(t,e,i){e=a.exec(e.slice(i,i+2));return e?(t.m=e[0]-1,i+e[0].length):-1}function ng(t,e,i){e=a.exec(e.slice(i,i+2));return e?(t.d=+e[0],i+e[0].length):-1}function rg(t,e,i){e=a.exec(e.slice(i,i+3));return e?(t.m=0,t.d=+e[0],i+e[0].length):-1}function ag(t,e,i){e=a.exec(e.slice(i,i+2));return e?(t.H=+e[0],i+e[0].length):-1}function sg(t,e,i){e=a.exec(e.slice(i,i+2));return e?(t.M=+e[0],i+e[0].length):-1}function og(t,e,i){e=a.exec(e.slice(i,i+2));return e?(t.S=+e[0],i+e[0].length):-1}function lg(t,e,i){e=a.exec(e.slice(i,i+3));return e?(t.L=+e[0],i+e[0].length):-1}function cg(t,e,i){e=a.exec(e.slice(i,i+6));return e?(t.L=Math.floor(e[0]/1e3),i+e[0].length):-1}function hg(t,e,i){e=Bp.exec(e.slice(i,i+1));return e?i+e[0].length:-1}function dg(t,e,i){e=a.exec(e.slice(i));return e?(t.Q=+e[0],i+e[0].length):-1}function ug(t,e,i){e=a.exec(e.slice(i));return e?(t.s=+e[0],i+e[0].length):-1}function pg(t,e){return s(t.getDate(),e,2)}function gg(t,e){return s(t.getHours(),e,2)}function fg(t,e){return s(t.getHours()%12||12,e,2)}function mg(t,e){return s(1+ju.count(cp(t),t),e,3)}function _g(t,e){return s(t.getMilliseconds(),e,3)}function vg(t,e){return _g(t,e)+"000"}function yg(t,e){return s(t.getMonth()+1,e,2)}function bg(t,e){return s(t.getMinutes(),e,2)}function Cg(t,e){return s(t.getSeconds(),e,2)}function xg(t){t=t.getDay();return 0===t?7:t}function wg(t,e){return s(Xu.count(cp(t)-1,t),e,2)}function Sg(t,e){var i=t.getDay();return t=4<=i||0===i?Zu(t):Zu.ceil(t),s(Zu.count(cp(t),t)+(4===cp(t).getDay()),e,2)}function Mg(t){return t.getDay()}function Og(t,e){return s(Yu.count(cp(t)-1,t),e,2)}function Gg(t,e){return s(t.getFullYear()%100,e,2)}function Ig(t,e){return s(t.getFullYear()%1e4,e,4)}function Tg(t){t=t.getTimezoneOffset();return(0<t?"-":(t*=-1,"+"))+s(t/60|0,"0",2)+s(t%60,"0",2)}function Ag(t,e){return s(t.getUTCDate(),e,2)}function Pg(t,e){return s(t.getUTCHours(),e,2)}function Dg(t,e){return s(t.getUTCHours()%12||12,e,2)}function Eg(t,e){return s(1+fp.count(Np(t),t),e,3)}function Ng(t,e){return s(t.getUTCMilliseconds(),e,3)}function Lg(t,e){return Ng(t,e)+"000"}function Rg(t,e){return s(t.getUTCMonth()+1,e,2)}function kg(t,e){return s(t.getUTCMinutes(),e,2)}function Fg(t,e){return s(t.getUTCSeconds(),e,2)}function Vg(t){t=t.getUTCDay();return 0===t?7:t}function Ug(t,e){return s(vp.count(Np(t)-1,t),e,2)}function $g(t,e){var i=t.getUTCDay();return t=4<=i||0===i?xp(t):xp.ceil(t),s(xp.count(Np(t),t)+(4===Np(t).getUTCDay()),e,2)}function Bg(t){return t.getUTCDay()}function zg(t,e){return s(yp.count(Np(t)-1,t),e,2)}function jg(t,e){return s(t.getUTCFullYear()%100,e,2)}function Hg(t,e){return s(t.getUTCFullYear()%1e4,e,4)}function Wg(){return"+0000"}function Xg(){return"%"}function Yg(t){return+t}function qg(t){return Math.floor(+t/1e3)}function Kg(t){return Up=Vp(t),z.timeFormat=Up.format,z.timeParse=Up.parse,z.utcFormat=Up.utcFormat,z.utcParse=Up.utcParse,Up}Kg({dateTime:"%x, %X",date:"%-m/%-d/%Y",time:"%-I:%M:%S %p",periods:["AM","PM"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]});var Zg="%Y-%m-%dT%H:%M:%S.%LZ";var Jg=Date.prototype.toISOString?function(t){return t.toISOString()}:z.utcFormat(Zg);var Zg=+new Date("2000-01-01T00:00:00.000Z")?function(t){return t=new Date(t),isNaN(t)?null:t}:z.utcParse(Zg),Qg=1e3,tf=60*Qg,ef=60*tf,nf=24*ef,rf=7*nf,af=30*nf,sf=365*nf;function of(t){return new Date(t)}function lf(t){return t instanceof Date?+t:+new Date(+t)}function cf(s,e,i,n,r,a,o,l,c){var h=mu(S,S),d=h.invert,u=h.domain,p=c(".%L"),g=c(":%S"),f=c("%I:%M"),m=c("%I %p"),_=c("%a %d"),v=c("%b %d"),y=c("%B"),b=c("%Y"),C=[[o,1,Qg],[o,5,5*Qg],[o,15,15*Qg],[o,30,30*Qg],[a,1,tf],[a,5,5*tf],[a,15,15*tf],[a,30,30*tf],[r,1,ef],[r,3,3*ef],[r,6,6*ef],[r,12,12*ef],[n,1,nf],[n,2,2*nf],[i,1,rf],[e,1,af],[e,3,3*af],[s,1,sf]];function x(t){return(o(t)<t?p:a(t)<t?g:r(t)<t?f:n(t)<t?m:e(t)<t?i(t)<t?_:v:s(t)<t?y:b)(t)}function w(t,e,i,n){var r,a;return"number"==typeof(t=null==t?10:t)&&(r=Math.abs(i-e)/t,t=(a=M(function(t){return t[2]}).right(C,r))===C.length?(n=it(e/sf,i/sf,t),s):a?(n=(a=C[r/C[a-1][2]<C[a][2]/r?a-1:a])[1],a[0]):(n=Math.max(it(e,i,t),1),l)),null==n?t:t.every(n)}return h.invert=function(t){return new Date(d(t))},h.domain=function(t){return arguments.length?u(nu.call(t,lf)):u().map(of)},h.ticks=function(t,e){var i,n=u(),r=n[0],n=n[n.length-1],a=n<r;return a&&(i=r,r=n,n=i),i=(i=w(t,r,n,e))?i.range(r,n+1):[],a?i.reverse():i},h.tickFormat=function(t,e){return null==e?x:c(e)},h.nice=function(t,e){var i=u();return(t=w(t,i[0],i[i.length-1],e))?u(yu(i,t)):h},h.copy=function(){return gu(h,cf(s,e,i,n,r,a,o,l,c))},h}function hf(){var e,i,n,r,a,s=0,o=1,l=S,c=!1;function h(t){return isNaN(t=+t)?a:l(0===n?.5:(t=(r(t)-e)*n,c?Math.max(0,Math.min(1,t)):t))}return h.domain=function(t){return arguments.length?(e=r(s=+t[0]),i=r(o=+t[1]),n=e===i?0:1/(i-e),h):[s,o]},h.clamp=function(t){return arguments.length?(c=!!t,h):c},h.interpolator=function(t){return arguments.length?(l=t,h):l},h.unknown=function(t){return arguments.length?(a=t,h):a},function(t){return e=(r=t)(s),i=t(o),n=e===i?0:1/(i-e),h}}function df(t,e){return e.domain(t.domain()).interpolator(t.interpolator()).clamp(t.clamp()).unknown(t.unknown())}function uf(){var t=Eu(hf());return t.copy=function(){return df(t,uf()).exponent(t.exponent())},eu.apply(t,arguments)}function pf(){var e,i,n,r,a,s,o,l=0,c=.5,h=1,d=S,u=!1;function p(t){return isNaN(t=+t)?o:(t=.5+((t=+s(t))-i)*(t<i?r:a),d(u?Math.max(0,Math.min(1,t)):t))}return p.domain=function(t){return arguments.length?(e=s(l=+t[0]),i=s(c=+t[1]),n=s(h=+t[2]),r=e===i?0:.5/(i-e),a=i===n?0:.5/(n-i),p):[l,c,h]},p.clamp=function(t){return arguments.length?(u=!!t,p):u},p.interpolator=function(t){return arguments.length?(d=t,p):d},p.unknown=function(t){return arguments.length?(o=t,p):o},function(t){return e=(s=t)(l),i=t(c),n=t(h),r=e===i?0:.5/(i-e),a=i===n?0:.5/(n-i),p}}function gf(){var t=Eu(pf());return t.copy=function(){return df(t,gf()).exponent(t.exponent())},eu.apply(t,arguments)}function i(t){for(var e=t.length/6|0,i=new Array(e),n=0;n<e;)i[n]="#"+t.slice(6*n,6*++n);return i}var ff=i("1f77b4ff7f0e2ca02cd627289467bd8c564be377c27f7f7fbcbd2217becf"),mf=i("7fc97fbeaed4fdc086ffff99386cb0f0027fbf5b17666666"),_f=i("1b9e77d95f027570b3e7298a66a61ee6ab02a6761d666666"),vf=i("a6cee31f78b4b2df8a33a02cfb9a99e31a1cfdbf6fff7f00cab2d66a3d9affff99b15928"),yf=i("fbb4aeb3cde3ccebc5decbe4fed9a6ffffcce5d8bdfddaecf2f2f2"),bf=i("b3e2cdfdcdaccbd5e8f4cae4e6f5c9fff2aef1e2cccccccc"),Cf=i("e41a1c377eb84daf4a984ea3ff7f00ffff33a65628f781bf999999"),xf=i("66c2a5fc8d628da0cbe78ac3a6d854ffd92fe5c494b3b3b3"),wf=i("8dd3c7ffffb3bebadafb807280b1d3fdb462b3de69fccde5d9d9d9bc80bdccebc5ffed6f"),Sf=i("4e79a7f28e2ce1575976b7b259a14fedc949af7aa1ff9da79c755fbab0ab");function p(t){return Ui(t[t.length-1])}var Mf=new Array(3).concat("d8b365f5f5f55ab4ac","a6611adfc27d80cdc1018571","a6611adfc27df5f5f580cdc1018571","8c510ad8b365f6e8c3c7eae55ab4ac01665e","8c510ad8b365f6e8c3f5f5f5c7eae55ab4ac01665e","8c510abf812ddfc27df6e8c3c7eae580cdc135978f01665e","8c510abf812ddfc27df6e8c3f5f5f5c7eae580cdc135978f01665e","5430058c510abf812ddfc27df6e8c3c7eae580cdc135978f01665e003c30","5430058c510abf812ddfc27df6e8c3f5f5f5c7eae580cdc135978f01665e003c30").map(i),Of=p(Mf),Gf=new Array(3).concat("af8dc3f7f7f77fbf7b","7b3294c2a5cfa6dba0008837","7b3294c2a5cff7f7f7a6dba0008837","762a83af8dc3e7d4e8d9f0d37fbf7b1b7837","762a83af8dc3e7d4e8f7f7f7d9f0d37fbf7b1b7837","762a839970abc2a5cfe7d4e8d9f0d3a6dba05aae611b7837","762a839970abc2a5cfe7d4e8f7f7f7d9f0d3a6dba05aae611b7837","40004b762a839970abc2a5cfe7d4e8d9f0d3a6dba05aae611b783700441b","40004b762a839970abc2a5cfe7d4e8f7f7f7d9f0d3a6dba05aae611b783700441b").map(i),If=p(Gf),Tf=new Array(3).concat("e9a3c9f7f7f7a1d76a","d01c8bf1b6dab8e1864dac26","d01c8bf1b6daf7f7f7b8e1864dac26","c51b7de9a3c9fde0efe6f5d0a1d76a4d9221","c51b7de9a3c9fde0eff7f7f7e6f5d0a1d76a4d9221","c51b7dde77aef1b6dafde0efe6f5d0b8e1867fbc414d9221","c51b7dde77aef1b6dafde0eff7f7f7e6f5d0b8e1867fbc414d9221","8e0152c51b7dde77aef1b6dafde0efe6f5d0b8e1867fbc414d9221276419","8e0152c51b7dde77aef1b6dafde0eff7f7f7e6f5d0b8e1867fbc414d9221276419").map(i),Af=p(Tf),Pf=new Array(3).concat("998ec3f7f7f7f1a340","5e3c99b2abd2fdb863e66101","5e3c99b2abd2f7f7f7fdb863e66101","542788998ec3d8daebfee0b6f1a340b35806","542788998ec3d8daebf7f7f7fee0b6f1a340b35806","5427888073acb2abd2d8daebfee0b6fdb863e08214b35806","5427888073acb2abd2d8daebf7f7f7fee0b6fdb863e08214b35806","2d004b5427888073acb2abd2d8daebfee0b6fdb863e08214b358067f3b08","2d004b5427888073acb2abd2d8daebf7f7f7fee0b6fdb863e08214b358067f3b08").map(i),Df=p(Pf),Ef=new Array(3).concat("ef8a62f7f7f767a9cf","ca0020f4a58292c5de0571b0","ca0020f4a582f7f7f792c5de0571b0","b2182bef8a62fddbc7d1e5f067a9cf2166ac","b2182bef8a62fddbc7f7f7f7d1e5f067a9cf2166ac","b2182bd6604df4a582fddbc7d1e5f092c5de4393c32166ac","b2182bd6604df4a582fddbc7f7f7f7d1e5f092c5de4393c32166ac","67001fb2182bd6604df4a582fddbc7d1e5f092c5de4393c32166ac053061","67001fb2182bd6604df4a582fddbc7f7f7f7d1e5f092c5de4393c32166ac053061").map(i),Nf=p(Ef),Lf=new Array(3).concat("ef8a62ffffff999999","ca0020f4a582bababa404040","ca0020f4a582ffffffbababa404040","b2182bef8a62fddbc7e0e0e09999994d4d4d","b2182bef8a62fddbc7ffffffe0e0e09999994d4d4d","b2182bd6604df4a582fddbc7e0e0e0bababa8787874d4d4d","b2182bd6604df4a582fddbc7ffffffe0e0e0bababa8787874d4d4d","67001fb2182bd6604df4a582fddbc7e0e0e0bababa8787874d4d4d1a1a1a","67001fb2182bd6604df4a582fddbc7ffffffe0e0e0bababa8787874d4d4d1a1a1a").map(i),Rf=p(Lf),kf=new Array(3).concat("fc8d59ffffbf91bfdb","d7191cfdae61abd9e92c7bb6","d7191cfdae61ffffbfabd9e92c7bb6","d73027fc8d59fee090e0f3f891bfdb4575b4","d73027fc8d59fee090ffffbfe0f3f891bfdb4575b4","d73027f46d43fdae61fee090e0f3f8abd9e974add14575b4","d73027f46d43fdae61fee090ffffbfe0f3f8abd9e974add14575b4","a50026d73027f46d43fdae61fee090e0f3f8abd9e974add14575b4313695","a50026d73027f46d43fdae61fee090ffffbfe0f3f8abd9e974add14575b4313695").map(i),Ff=p(kf),Vf=new Array(3).concat("fc8d59ffffbf91cf60","d7191cfdae61a6d96a1a9641","d7191cfdae61ffffbfa6d96a1a9641","d73027fc8d59fee08bd9ef8b91cf601a9850","d73027fc8d59fee08bffffbfd9ef8b91cf601a9850","d73027f46d43fdae61fee08bd9ef8ba6d96a66bd631a9850","d73027f46d43fdae61fee08bffffbfd9ef8ba6d96a66bd631a9850","a50026d73027f46d43fdae61fee08bd9ef8ba6d96a66bd631a9850006837","a50026d73027f46d43fdae61fee08bffffbfd9ef8ba6d96a66bd631a9850006837").map(i),Uf=p(Vf),$f=new Array(3).concat("fc8d59ffffbf99d594","d7191cfdae61abdda42b83ba","d7191cfdae61ffffbfabdda42b83ba","d53e4ffc8d59fee08be6f59899d5943288bd","d53e4ffc8d59fee08bffffbfe6f59899d5943288bd","d53e4ff46d43fdae61fee08be6f598abdda466c2a53288bd","d53e4ff46d43fdae61fee08bffffbfe6f598abdda466c2a53288bd","9e0142d53e4ff46d43fdae61fee08be6f598abdda466c2a53288bd5e4fa2","9e0142d53e4ff46d43fdae61fee08bffffbfe6f598abdda466c2a53288bd5e4fa2").map(i),Bf=p($f),zf=new Array(3).concat("e5f5f999d8c92ca25f","edf8fbb2e2e266c2a4238b45","edf8fbb2e2e266c2a42ca25f006d2c","edf8fbccece699d8c966c2a42ca25f006d2c","edf8fbccece699d8c966c2a441ae76238b45005824","f7fcfde5f5f9ccece699d8c966c2a441ae76238b45005824","f7fcfde5f5f9ccece699d8c966c2a441ae76238b45006d2c00441b").map(i),jf=p(zf),Hf=new Array(3).concat("e0ecf49ebcda8856a7","edf8fbb3cde38c96c688419d","edf8fbb3cde38c96c68856a7810f7c","edf8fbbfd3e69ebcda8c96c68856a7810f7c","edf8fbbfd3e69ebcda8c96c68c6bb188419d6e016b","f7fcfde0ecf4bfd3e69ebcda8c96c68c6bb188419d6e016b","f7fcfde0ecf4bfd3e69ebcda8c96c68c6bb188419d810f7c4d004b").map(i),Wf=p(Hf),Xf=new Array(3).concat("e0f3dba8ddb543a2ca","f0f9e8bae4bc7bccc42b8cbe","f0f9e8bae4bc7bccc443a2ca0868ac","f0f9e8ccebc5a8ddb57bccc443a2ca0868ac","f0f9e8ccebc5a8ddb57bccc44eb3d32b8cbe08589e","f7fcf0e0f3dbccebc5a8ddb57bccc44eb3d32b8cbe08589e","f7fcf0e0f3dbccebc5a8ddb57bccc44eb3d32b8cbe0868ac084081").map(i),Yf=p(Xf),qf=new Array(3).concat("fee8c8fdbb84e34a33","fef0d9fdcc8afc8d59d7301f","fef0d9fdcc8afc8d59e34a33b30000","fef0d9fdd49efdbb84fc8d59e34a33b30000","fef0d9fdd49efdbb84fc8d59ef6548d7301f990000","fff7ecfee8c8fdd49efdbb84fc8d59ef6548d7301f990000","fff7ecfee8c8fdd49efdbb84fc8d59ef6548d7301fb300007f0000").map(i),Kf=p(qf),Zf=new Array(3).concat("ece2f0a6bddb1c9099","f6eff7bdc9e167a9cf02818a","f6eff7bdc9e167a9cf1c9099016c59","f6eff7d0d1e6a6bddb67a9cf1c9099016c59","f6eff7d0d1e6a6bddb67a9cf3690c002818a016450","fff7fbece2f0d0d1e6a6bddb67a9cf3690c002818a016450","fff7fbece2f0d0d1e6a6bddb67a9cf3690c002818a016c59014636").map(i),Jf=p(Zf),Qf=new Array(3).concat("ece7f2a6bddb2b8cbe","f1eef6bdc9e174a9cf0570b0","f1eef6bdc9e174a9cf2b8cbe045a8d","f1eef6d0d1e6a6bddb74a9cf2b8cbe045a8d","f1eef6d0d1e6a6bddb74a9cf3690c00570b0034e7b","fff7fbece7f2d0d1e6a6bddb74a9cf3690c00570b0034e7b","fff7fbece7f2d0d1e6a6bddb74a9cf3690c00570b0045a8d023858").map(i),tm=p(Qf),em=new Array(3).concat("e7e1efc994c7dd1c77","f1eef6d7b5d8df65b0ce1256","f1eef6d7b5d8df65b0dd1c77980043","f1eef6d4b9dac994c7df65b0dd1c77980043","f1eef6d4b9dac994c7df65b0e7298ace125691003f","f7f4f9e7e1efd4b9dac994c7df65b0e7298ace125691003f","f7f4f9e7e1efd4b9dac994c7df65b0e7298ace125698004367001f").map(i),im=p(em),nm=new Array(3).concat("fde0ddfa9fb5c51b8a","feebe2fbb4b9f768a1ae017e","feebe2fbb4b9f768a1c51b8a7a0177","feebe2fcc5c0fa9fb5f768a1c51b8a7a0177","feebe2fcc5c0fa9fb5f768a1dd3497ae017e7a0177","fff7f3fde0ddfcc5c0fa9fb5f768a1dd3497ae017e7a0177","fff7f3fde0ddfcc5c0fa9fb5f768a1dd3497ae017e7a017749006a").map(i),rm=p(nm),am=new Array(3).concat("edf8b17fcdbb2c7fb8","ffffcca1dab441b6c4225ea8","ffffcca1dab441b6c42c7fb8253494","ffffccc7e9b47fcdbb41b6c42c7fb8253494","ffffccc7e9b47fcdbb41b6c41d91c0225ea80c2c84","ffffd9edf8b1c7e9b47fcdbb41b6c41d91c0225ea80c2c84","ffffd9edf8b1c7e9b47fcdbb41b6c41d91c0225ea8253494081d58").map(i),sm=p(am),om=new Array(3).concat("f7fcb9addd8e31a354","ffffccc2e69978c679238443","ffffccc2e69978c67931a354006837","ffffccd9f0a3addd8e78c67931a354006837","ffffccd9f0a3addd8e78c67941ab5d238443005a32","ffffe5f7fcb9d9f0a3addd8e78c67941ab5d238443005a32","ffffe5f7fcb9d9f0a3addd8e78c67941ab5d238443006837004529").map(i),lm=p(om),cm=new Array(3).concat("fff7bcfec44fd95f0e","ffffd4fed98efe9929cc4c02","ffffd4fed98efe9929d95f0e993404","ffffd4fee391fec44ffe9929d95f0e993404","ffffd4fee391fec44ffe9929ec7014cc4c028c2d04","ffffe5fff7bcfee391fec44ffe9929ec7014cc4c028c2d04","ffffe5fff7bcfee391fec44ffe9929ec7014cc4c02993404662506").map(i),hm=p(cm),dm=new Array(3).concat("ffeda0feb24cf03b20","ffffb2fecc5cfd8d3ce31a1c","ffffb2fecc5cfd8d3cf03b20bd0026","ffffb2fed976feb24cfd8d3cf03b20bd0026","ffffb2fed976feb24cfd8d3cfc4e2ae31a1cb10026","ffffccffeda0fed976feb24cfd8d3cfc4e2ae31a1cb10026","ffffccffeda0fed976feb24cfd8d3cfc4e2ae31a1cbd0026800026").map(i),um=p(dm),pm=new Array(3).concat("deebf79ecae13182bd","eff3ffbdd7e76baed62171b5","eff3ffbdd7e76baed63182bd08519c","eff3ffc6dbef9ecae16baed63182bd08519c","eff3ffc6dbef9ecae16baed64292c62171b5084594","f7fbffdeebf7c6dbef9ecae16baed64292c62171b5084594","f7fbffdeebf7c6dbef9ecae16baed64292c62171b508519c08306b").map(i),gm=p(pm),fm=new Array(3).concat("e5f5e0a1d99b31a354","edf8e9bae4b374c476238b45","edf8e9bae4b374c47631a354006d2c","edf8e9c7e9c0a1d99b74c47631a354006d2c","edf8e9c7e9c0a1d99b74c47641ab5d238b45005a32","f7fcf5e5f5e0c7e9c0a1d99b74c47641ab5d238b45005a32","f7fcf5e5f5e0c7e9c0a1d99b74c47641ab5d238b45006d2c00441b").map(i),mm=p(fm),_m=new Array(3).concat("f0f0f0bdbdbd636363","f7f7f7cccccc969696525252","f7f7f7cccccc969696636363252525","f7f7f7d9d9d9bdbdbd969696636363252525","f7f7f7d9d9d9bdbdbd969696737373525252252525","fffffff0f0f0d9d9d9bdbdbd969696737373525252252525","fffffff0f0f0d9d9d9bdbdbd969696737373525252252525000000").map(i),vm=p(_m),ym=new Array(3).concat("efedf5bcbddc756bb1","f2f0f7cbc9e29e9ac86a51a3","f2f0f7cbc9e29e9ac8756bb154278f","f2f0f7dadaebbcbddc9e9ac8756bb154278f","f2f0f7dadaebbcbddc9e9ac8807dba6a51a34a1486","fcfbfdefedf5dadaebbcbddc9e9ac8807dba6a51a34a1486","fcfbfdefedf5dadaebbcbddc9e9ac8807dba6a51a354278f3f007d").map(i),bm=p(ym),Cm=new Array(3).concat("fee0d2fc9272de2d26","fee5d9fcae91fb6a4acb181d","fee5d9fcae91fb6a4ade2d26a50f15","fee5d9fcbba1fc9272fb6a4ade2d26a50f15","fee5d9fcbba1fc9272fb6a4aef3b2ccb181d99000d","fff5f0fee0d2fcbba1fc9272fb6a4aef3b2ccb181d99000d","fff5f0fee0d2fcbba1fc9272fb6a4aef3b2ccb181da50f1567000d").map(i),xm=p(Cm),wm=new Array(3).concat("fee6cefdae6be6550d","feeddefdbe85fd8d3cd94701","feeddefdbe85fd8d3ce6550da63603","feeddefdd0a2fdae6bfd8d3ce6550da63603","feeddefdd0a2fdae6bfd8d3cf16913d948018c2d04","fff5ebfee6cefdd0a2fdae6bfd8d3cf16913d948018c2d04","fff5ebfee6cefdd0a2fdae6bfd8d3cf16913d94801a636037f2704").map(i),Sm=p(wm);var Mm=vn(Ti(300,.5,0),Ti(-240,.5,1)),Om=vn(Ti(-100,.75,.35),Ti(80,1.5,.8)),Gm=vn(Ti(260,.75,.35),Ti(80,1.5,.8)),Im=Ti();var Tm=qe(),Am=Math.PI/3,Pm=2*Math.PI/3;function Dm(e){var i=e.length;return function(t){return e[Math.max(0,Math.min(i-1,Math.floor(t*i)))]}}var Em=Dm(i("44015444025645045745055946075a46085c460a5d460b5e470d60470e6147106347116447136548146748166848176948186a481a6c481b6d481c6e481d6f481f70482071482173482374482475482576482677482878482979472a7a472c7a472d7b472e7c472f7d46307e46327e46337f463480453581453781453882443983443a83443b84433d84433e85423f854240864241864142874144874045884046883f47883f48893e49893e4a893e4c8a3d4d8a3d4e8a3c4f8a3c508b3b518b3b528b3a538b3a548c39558c39568c38588c38598c375a8c375b8d365c8d365d8d355e8d355f8d34608d34618d33628d33638d32648e32658e31668e31678e31688e30698e306a8e2f6b8e2f6c8e2e6d8e2e6e8e2e6f8e2d708e2d718e2c718e2c728e2c738e2b748e2b758e2a768e2a778e2a788e29798e297a8e297b8e287c8e287d8e277e8e277f8e27808e26818e26828e26828e25838e25848e25858e24868e24878e23888e23898e238a8d228b8d228c8d228d8d218e8d218f8d21908d21918c20928c20928c20938c1f948c1f958b1f968b1f978b1f988b1f998a1f9a8a1e9b8a1e9c891e9d891f9e891f9f881fa0881fa1881fa1871fa28720a38620a48621a58521a68522a78522a88423a98324aa8325ab8225ac8226ad8127ad8128ae8029af7f2ab07f2cb17e2db27d2eb37c2fb47c31b57b32b67a34b67935b77937b87838b9773aba763bbb753dbc743fbc7340bd7242be7144bf7046c06f48c16e4ac16d4cc26c4ec36b50c46a52c56954c56856c66758c7655ac8645cc8635ec96260ca6063cb5f65cb5e67cc5c69cd5b6ccd5a6ece5870cf5773d05675d05477d1537ad1517cd2507fd34e81d34d84d44b86d54989d5488bd6468ed64590d74393d74195d84098d83e9bd93c9dd93ba0da39a2da37a5db36a8db34aadc32addc30b0dd2fb2dd2db5de2bb8de29bade28bddf26c0df25c2df23c5e021c8e020cae11fcde11dd0e11cd2e21bd5e21ad8e219dae319dde318dfe318e2e418e5e419e7e419eae51aece51befe51cf1e51df4e61ef6e620f8e621fbe723fde725")),Nm=Dm(i("00000401000501010601010802010902020b02020d03030f03031204041405041606051806051a07061c08071e0907200a08220b09240c09260d0a290e0b2b100b2d110c2f120d31130d34140e36150e38160f3b180f3d19103f1a10421c10441d11471e114920114b21114e22115024125325125527125829115a2a115c2c115f2d11612f116331116533106734106936106b38106c390f6e3b0f703d0f713f0f72400f74420f75440f764510774710784910784a10794c117a4e117b4f127b51127c52137c54137d56147d57157e59157e5a167e5c167f5d177f5f187f601880621980641a80651a80671b80681c816a1c816b1d816d1d816e1e81701f81721f817320817521817621817822817922827b23827c23827e24828025828125818326818426818627818827818928818b29818c29818e2a81902a81912b81932b80942c80962c80982d80992d809b2e7f9c2e7f9e2f7fa02f7fa1307ea3307ea5317ea6317da8327daa337dab337cad347cae347bb0357bb2357bb3367ab5367ab73779b83779ba3878bc3978bd3977bf3a77c03a76c23b75c43c75c53c74c73d73c83e73ca3e72cc3f71cd4071cf4070d0416fd2426fd3436ed5446dd6456cd8456cd9466bdb476adc4869de4968df4a68e04c67e24d66e34e65e44f64e55064e75263e85362e95462ea5661eb5760ec5860ed5a5fee5b5eef5d5ef05f5ef1605df2625df2645cf3655cf4675cf4695cf56b5cf66c5cf66e5cf7705cf7725cf8745cf8765cf9785df9795df97b5dfa7d5efa7f5efa815ffb835ffb8560fb8761fc8961fc8a62fc8c63fc8e64fc9065fd9266fd9467fd9668fd9869fd9a6afd9b6bfe9d6cfe9f6dfea16efea36ffea571fea772fea973feaa74feac76feae77feb078feb27afeb47bfeb67cfeb77efeb97ffebb81febd82febf84fec185fec287fec488fec68afec88cfeca8dfecc8ffecd90fecf92fed194fed395fed597fed799fed89afdda9cfddc9efddea0fde0a1fde2a3fde3a5fde5a7fde7a9fde9aafdebacfcecaefceeb0fcf0b2fcf2b4fcf4b6fcf6b8fcf7b9fcf9bbfcfbbdfcfdbf")),Lm=Dm(i("00000401000501010601010802010a02020c02020e03021004031204031405041706041907051b08051d09061f0a07220b07240c08260d08290e092b10092d110a30120a32140b34150b37160b39180c3c190c3e1b0c411c0c431e0c451f0c48210c4a230c4c240c4f260c51280b53290b552b0b572d0b592f0a5b310a5c320a5e340a5f3609613809623909633b09643d09653e0966400a67420a68440a68450a69470b6a490b6a4a0c6b4c0c6b4d0d6c4f0d6c510e6c520e6d540f6d550f6d57106e59106e5a116e5c126e5d126e5f136e61136e62146e64156e65156e67166e69166e6a176e6c186e6d186e6f196e71196e721a6e741a6e751b6e771c6d781c6d7a1d6d7c1d6d7d1e6d7f1e6c801f6c82206c84206b85216b87216b88226a8a226a8c23698d23698f24699025689225689326679526679727669827669a28659b29649d29649f2a63a02a63a22b62a32c61a52c60a62d60a82e5fa92e5eab2f5ead305dae305cb0315bb1325ab3325ab43359b63458b73557b93556ba3655bc3754bd3853bf3952c03a51c13a50c33b4fc43c4ec63d4dc73e4cc83f4bca404acb4149cc4248ce4347cf4446d04545d24644d34743d44842d54a41d74b3fd84c3ed94d3dda4e3cdb503bdd513ade5238df5337e05536e15635e25734e35933e45a31e55c30e65d2fe75e2ee8602de9612bea632aeb6429eb6628ec6726ed6925ee6a24ef6c23ef6e21f06f20f1711ff1731df2741cf3761bf37819f47918f57b17f57d15f67e14f68013f78212f78410f8850ff8870ef8890cf98b0bf98c0af98e09fa9008fa9207fa9407fb9606fb9706fb9906fb9b06fb9d07fc9f07fca108fca309fca50afca60cfca80dfcaa0ffcac11fcae12fcb014fcb216fcb418fbb61afbb81dfbba1ffbbc21fbbe23fac026fac228fac42afac62df9c72ff9c932f9cb35f8cd37f8cf3af7d13df7d340f6d543f6d746f5d949f5db4cf4dd4ff4df53f4e156f3e35af3e55df2e661f2e865f2ea69f1ec6df1ed71f1ef75f1f179f2f27df2f482f3f586f3f68af4f88ef5f992f6fa96f8fb9af9fc9dfafda1fcffa4")),Rm=Dm(i("0d088710078813078916078a19068c1b068d1d068e20068f2206902406912605912805922a05932c05942e05952f059631059733059735049837049938049a3a049a3c049b3e049c3f049c41049d43039e44039e46039f48039f4903a04b03a14c02a14e02a25002a25102a35302a35502a45601a45801a45901a55b01a55c01a65e01a66001a66100a76300a76400a76600a76700a86900a86a00a86c00a86e00a86f00a87100a87201a87401a87501a87701a87801a87a02a87b02a87d03a87e03a88004a88104a78305a78405a78606a68707a68808a68a09a58b0aa58d0ba58e0ca48f0da4910ea3920fa39410a29511a19613a19814a099159f9a169f9c179e9d189d9e199da01a9ca11b9ba21d9aa31e9aa51f99a62098a72197a82296aa2395ab2494ac2694ad2793ae2892b02991b12a90b22b8fb32c8eb42e8db52f8cb6308bb7318ab83289ba3388bb3488bc3587bd3786be3885bf3984c03a83c13b82c23c81c33d80c43e7fc5407ec6417dc7427cc8437bc9447aca457acb4679cc4778cc4977cd4a76ce4b75cf4c74d04d73d14e72d24f71d35171d45270d5536fd5546ed6556dd7566cd8576bd9586ada5a6ada5b69db5c68dc5d67dd5e66de5f65de6164df6263e06363e16462e26561e26660e3685fe4695ee56a5de56b5de66c5ce76e5be76f5ae87059e97158e97257ea7457eb7556eb7655ec7754ed7953ed7a52ee7b51ef7c51ef7e50f07f4ff0804ef1814df1834cf2844bf3854bf3874af48849f48948f58b47f58c46f68d45f68f44f79044f79143f79342f89441f89540f9973ff9983ef99a3efa9b3dfa9c3cfa9e3bfb9f3afba139fba238fca338fca537fca636fca835fca934fdab33fdac33fdae32fdaf31fdb130fdb22ffdb42ffdb52efeb72dfeb82cfeba2cfebb2bfebd2afebe2afec029fdc229fdc328fdc527fdc627fdc827fdca26fdcb26fccd25fcce25fcd025fcd225fbd324fbd524fbd724fad824fada24f9dc24f9dd25f8df25f8e125f7e225f7e425f6e626f6e826f5e926f5eb27f4ed27f3ee27f3f027f2f227f1f426f1f525f0f724f0f921"));function y(t){return function(){return t}}var km=Math.abs,F=Math.atan2,Fm=Math.cos,Vm=Math.max,Um=Math.min,$m=Math.sin,Bm=Math.sqrt,V=1e-12,zm=Math.PI,jm=zm/2,Hm=2*zm;function Wm(t){return 1<=t?jm:t<=-1?-jm:Math.asin(t)}function Xm(t){return t.innerRadius}function Ym(t){return t.outerRadius}function qm(t){return t.startAngle}function Km(t){return t.endAngle}function Zm(t){return t&&t.padAngle}function Jm(t,e,i,n,r,a,s){var o=t-i,l=e-n,s=(s?a:-a)/Bm(o*o+l*l),l=s*l,s=-s*o,o=t+l,t=e+s,e=i+l,i=n+s,n=(o+e)/2,c=(t+i)/2,h=e-o,d=i-t,u=h*h+d*d,a=r-a,o=o*i-e*t,i=(d<0?-1:1)*Bm(Vm(0,a*a*u-o*o)),e=(o*d-h*i)/u,t=(-o*h-d*i)/u,p=(o*d+h*i)/u,o=(-o*h+d*i)/u,h=e-n,d=t-c,i=p-n,u=o-c;return i*i+u*u<h*h+d*d&&(e=p,t=o),{cx:e,cy:t,x01:-l,y01:-s,x11:e*(r/a-1),y11:t*(r/a-1)}}function Qm(t){this._context=t}function t_(t){return new Qm(t)}function e_(t){return t[0]}function i_(t){return t[1]}function n_(){var s=e_,o=i_,l=y(!0),c=null,h=t_,d=null;function e(t){var e,i,n,r=t.length,a=!1;for(null==c&&(d=h(n=ua())),e=0;e<=r;++e)!(e<r&&l(i=t[e],e,t))===a&&((a=!a)?d.lineStart():d.lineEnd()),a&&d.point(+s(i,e,t),+o(i,e,t));if(n)return d=null,n+""||null}return e.x=function(t){return arguments.length?(s="function"==typeof t?t:y(+t),e):s},e.y=function(t){return arguments.length?(o="function"==typeof t?t:y(+t),e):o},e.defined=function(t){return arguments.length?(l="function"==typeof t?t:y(!!t),e):l},e.curve=function(t){return arguments.length?(h=t,null!=c&&(d=h(c)),e):h},e.context=function(t){return arguments.length?(null==t?c=d=null:d=h(c=t),e):c},e}function r_(){var h=e_,d=null,u=y(0),p=i_,g=y(!0),f=null,m=t_,_=null;function e(t){var e,i,n,r,a,s=t.length,o=!1,l=new Array(s),c=new Array(s);for(null==f&&(_=m(a=ua())),e=0;e<=s;++e){if(!(e<s&&g(r=t[e],e,t))===o)if(o=!o)i=e,_.areaStart(),_.lineStart();else{for(_.lineEnd(),_.lineStart(),n=e-1;i<=n;--n)_.point(l[n],c[n]);_.lineEnd(),_.areaEnd()}o&&(l[e]=+h(r,e,t),c[e]=+u(r,e,t),_.point(d?+d(r,e,t):l[e],p?+p(r,e,t):c[e]))}if(a)return _=null,a+""||null}function t(){return n_().defined(g).curve(m).context(f)}return e.x=function(t){return arguments.length?(h="function"==typeof t?t:y(+t),d=null,e):h},e.x0=function(t){return arguments.length?(h="function"==typeof t?t:y(+t),e):h},e.x1=function(t){return arguments.length?(d=null==t?null:"function"==typeof t?t:y(+t),e):d},e.y=function(t){return arguments.length?(u="function"==typeof t?t:y(+t),p=null,e):u},e.y0=function(t){return arguments.length?(u="function"==typeof t?t:y(+t),e):u},e.y1=function(t){return arguments.length?(p=null==t?null:"function"==typeof t?t:y(+t),e):p},e.lineX0=e.lineY0=function(){return t().x(h).y(u)},e.lineY1=function(){return t().x(h).y(p)},e.lineX1=function(){return t().x(d).y(u)},e.defined=function(t){return arguments.length?(g="function"==typeof t?t:y(!!t),e):g},e.curve=function(t){return arguments.length?(m=t,null!=f&&(_=m(f)),e):m},e.context=function(t){return arguments.length?(null==t?f=_=null:_=m(f=t),e):f},e}function a_(t,e){return e<t?-1:t<e?1:t<=e?0:NaN}function s_(t){return t}Qm.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,e){switch(t=+t,e=+e,this._point){case 0:this._point=1,this._line?this._context.lineTo(t,e):this._context.moveTo(t,e);break;case 1:this._point=2;default:this._context.lineTo(t,e)}}};var o_=c_(t_);function l_(t){this._curve=t}function c_(e){function t(t){return new l_(e(t))}return t._curve=e,t}function h_(t){var e=t.curve;return t.angle=t.x,delete t.x,t.radius=t.y,delete t.y,t.curve=function(t){return arguments.length?e(c_(t)):e()._curve},t}function d_(){return h_(n_().curve(o_))}function u_(){var t=r_().curve(o_),e=t.curve,i=t.lineX0,n=t.lineX1,r=t.lineY0,a=t.lineY1;return t.angle=t.x,delete t.x,t.startAngle=t.x0,delete t.x0,t.endAngle=t.x1,delete t.x1,t.radius=t.y,delete t.y,t.innerRadius=t.y0,delete t.y0,t.outerRadius=t.y1,delete t.y1,t.lineStartAngle=function(){return h_(i())},delete t.lineX0,t.lineEndAngle=function(){return h_(n())},delete t.lineX1,t.lineInnerRadius=function(){return h_(r())},delete t.lineY0,t.lineOuterRadius=function(){return h_(a())},delete t.lineY1,t.curve=function(t){return arguments.length?e(c_(t)):e()._curve},t}function p_(t,e){return[(e=+e)*Math.cos(t-=Math.PI/2),e*Math.sin(t)]}l_.prototype={areaStart:function(){this._curve.areaStart()},areaEnd:function(){this._curve.areaEnd()},lineStart:function(){this._curve.lineStart()},lineEnd:function(){this._curve.lineEnd()},point:function(t,e){this._curve.point(e*Math.sin(t),e*-Math.cos(t))}};var g_=Array.prototype.slice;function f_(t){return t.source}function m_(t){return t.target}function __(r){var a=f_,s=m_,o=e_,l=i_,c=null;function e(){var t,e=g_.call(arguments),i=a.apply(this,e),n=s.apply(this,e);if(c=c||(t=ua()),r(c,+o.apply(this,(e[0]=i,e)),+l.apply(this,e),+o.apply(this,(e[0]=n,e)),+l.apply(this,e)),t)return c=null,t+""||null}return e.source=function(t){return arguments.length?(a=t,e):a},e.target=function(t){return arguments.length?(s=t,e):s},e.x=function(t){return arguments.length?(o="function"==typeof t?t:y(+t),e):o},e.y=function(t){return arguments.length?(l="function"==typeof t?t:y(+t),e):l},e.context=function(t){return arguments.length?(c=null==t?null:t,e):c},e}function v_(t,e,i,n,r){t.moveTo(e,i),t.bezierCurveTo(e=(e+n)/2,i,e,r,n,r)}function y_(t,e,i,n,r){t.moveTo(e,i),t.bezierCurveTo(e,i=(i+r)/2,n,i,n,r)}function b_(t,e,i,n,r){var a=p_(e,i),e=p_(e,i=(i+r)/2),i=p_(n,i),n=p_(n,r);t.moveTo(a[0],a[1]),t.bezierCurveTo(e[0],e[1],i[0],i[1],n[0],n[1])}var C_={draw:function(t,e){e=Math.sqrt(e/zm);t.moveTo(e,0),t.arc(0,0,e,0,Hm)}},x_={draw:function(t,e){e=Math.sqrt(e/5)/2;t.moveTo(-3*e,-e),t.lineTo(-e,-e),t.lineTo(-e,-3*e),t.lineTo(e,-3*e),t.lineTo(e,-e),t.lineTo(3*e,-e),t.lineTo(3*e,e),t.lineTo(e,e),t.lineTo(e,3*e),t.lineTo(-e,3*e),t.lineTo(-e,e),t.lineTo(-3*e,e),t.closePath()}},w_=Math.sqrt(1/3),S_=2*w_,M_={draw:function(t,e){var e=Math.sqrt(e/S_),i=e*w_;t.moveTo(0,-e),t.lineTo(i,0),t.lineTo(0,e),t.lineTo(-i,0),t.closePath()}},O_=Math.sin(zm/10)/Math.sin(7*zm/10),G_=Math.sin(Hm/10)*O_,I_=-Math.cos(Hm/10)*O_,O_={draw:function(t,e){var i=Math.sqrt(.8908130915292852*e),n=G_*i,r=I_*i;t.moveTo(0,-i),t.lineTo(n,r);for(var a=1;a<5;++a){var s=Hm*a/5,o=Math.cos(s),s=Math.sin(s);t.lineTo(s*i,-o*i),t.lineTo(o*n-s*r,s*n+o*r)}t.closePath()}},T_={draw:function(t,e){var e=Math.sqrt(e),i=-e/2;t.rect(i,i,e,e)}},A_=Math.sqrt(3),P_={draw:function(t,e){e=-Math.sqrt(e/(3*A_));t.moveTo(0,2*e),t.lineTo(-A_*e,-e),t.lineTo(A_*e,-e),t.closePath()}},D_=Math.sqrt(3)/2,E_=1/Math.sqrt(12),N_=3*(E_/2+1),L_={draw:function(t,e){var e=Math.sqrt(e/N_),i=e/2,n=e*E_,r=i,e=e*E_+e,a=-r,s=e;t.moveTo(i,n),t.lineTo(r,e),t.lineTo(a,s),t.lineTo(-.5*i-D_*n,D_*i+-.5*n),t.lineTo(-.5*r-D_*e,D_*r+-.5*e),t.lineTo(-.5*a-D_*s,D_*a+-.5*s),t.lineTo(-.5*i+D_*n,-.5*n-D_*i),t.lineTo(-.5*r+D_*e,-.5*e-D_*r),t.lineTo(-.5*a+D_*s,-.5*s-D_*a),t.closePath()}},R_=[C_,x_,M_,T_,O_,P_,L_];function k_(){}function F_(t,e,i){t._context.bezierCurveTo((2*t._x0+t._x1)/3,(2*t._y0+t._y1)/3,(t._x0+2*t._x1)/3,(t._y0+2*t._y1)/3,(t._x0+4*t._x1+e)/6,(t._y0+4*t._y1+i)/6)}function V_(t){this._context=t}function U_(t){this._context=t}function $_(t){this._context=t}function B_(t,e){this._basis=new V_(t),this._beta=e}V_.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=NaN,this._point=0},lineEnd:function(){switch(this._point){case 3:F_(this,this._x1,this._y1);case 2:this._context.lineTo(this._x1,this._y1)}(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,e){switch(t=+t,e=+e,this._point){case 0:this._point=1,this._line?this._context.lineTo(t,e):this._context.moveTo(t,e);break;case 1:this._point=2;break;case 2:this._point=3,this._context.lineTo((5*this._x0+this._x1)/6,(5*this._y0+this._y1)/6);default:F_(this,t,e)}this._x0=this._x1,this._x1=t,this._y0=this._y1,this._y1=e}},U_.prototype={areaStart:k_,areaEnd:k_,lineStart:function(){this._x0=this._x1=this._x2=this._x3=this._x4=this._y0=this._y1=this._y2=this._y3=this._y4=NaN,this._point=0},lineEnd:function(){switch(this._point){case 1:this._context.moveTo(this._x2,this._y2),this._context.closePath();break;case 2:this._context.moveTo((this._x2+2*this._x3)/3,(this._y2+2*this._y3)/3),this._context.lineTo((this._x3+2*this._x2)/3,(this._y3+2*this._y2)/3),this._context.closePath();break;case 3:this.point(this._x2,this._y2),this.point(this._x3,this._y3),this.point(this._x4,this._y4)}},point:function(t,e){switch(t=+t,e=+e,this._point){case 0:this._point=1,this._x2=t,this._y2=e;break;case 1:this._point=2,this._x3=t,this._y3=e;break;case 2:this._point=3,this._x4=t,this._y4=e,this._context.moveTo((this._x0+4*this._x1+t)/6,(this._y0+4*this._y1+e)/6);break;default:F_(this,t,e)}this._x0=this._x1,this._x1=t,this._y0=this._y1,this._y1=e}},$_.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=NaN,this._point=0},lineEnd:function(){(this._line||0!==this._line&&3===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,e){switch(t=+t,e=+e,this._point){case 0:this._point=1;break;case 1:this._point=2;break;case 2:this._point=3;var i=(this._x0+4*this._x1+t)/6,n=(this._y0+4*this._y1+e)/6;this._line?this._context.lineTo(i,n):this._context.moveTo(i,n);break;case 3:this._point=4;default:F_(this,t,e)}this._x0=this._x1,this._x1=t,this._y0=this._y1,this._y1=e}},B_.prototype={lineStart:function(){this._x=[],this._y=[],this._basis.lineStart()},lineEnd:function(){var t=this._x,e=this._y,i=t.length-1;if(0<i)for(var n,r=t[0],a=e[0],s=t[i]-r,o=e[i]-a,l=-1;++l<=i;)this._basis.point(this._beta*t[l]+(1-this._beta)*(r+(n=l/i)*s),this._beta*e[l]+(1-this._beta)*(a+n*o));this._x=this._y=null,this._basis.lineEnd()},point:function(t,e){this._x.push(+t),this._y.push(+e)}};var z_=function e(i){function t(t){return 1===i?new V_(t):new B_(t,i)}return t.beta=function(t){return e(+t)},t}(.85);function j_(t,e,i){t._context.bezierCurveTo(t._x1+t._k*(t._x2-t._x0),t._y1+t._k*(t._y2-t._y0),t._x2+t._k*(t._x1-e),t._y2+t._k*(t._y1-i),t._x2,t._y2)}function H_(t,e){this._context=t,this._k=(1-e)/6}H_.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x2,this._y2);break;case 3:j_(this,this._x1,this._y1)}(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,e){switch(t=+t,e=+e,this._point){case 0:this._point=1,this._line?this._context.lineTo(t,e):this._context.moveTo(t,e);break;case 1:this._point=2,this._x1=t,this._y1=e;break;case 2:this._point=3;default:j_(this,t,e)}this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=e}};var W_=function e(i){function t(t){return new H_(t,i)}return t.tension=function(t){return e(+t)},t}(0);function X_(t,e){this._context=t,this._k=(1-e)/6}X_.prototype={areaStart:k_,areaEnd:k_,lineStart:function(){this._x0=this._x1=this._x2=this._x3=this._x4=this._x5=this._y0=this._y1=this._y2=this._y3=this._y4=this._y5=NaN,this._point=0},lineEnd:function(){switch(this._point){case 1:this._context.moveTo(this._x3,this._y3),this._context.closePath();break;case 2:this._context.lineTo(this._x3,this._y3),this._context.closePath();break;case 3:this.point(this._x3,this._y3),this.point(this._x4,this._y4),this.point(this._x5,this._y5)}},point:function(t,e){switch(t=+t,e=+e,this._point){case 0:this._point=1,this._x3=t,this._y3=e;break;case 1:this._point=2,this._context.moveTo(this._x4=t,this._y4=e);break;case 2:this._point=3,this._x5=t,this._y5=e;break;default:j_(this,t,e)}this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=e}};var Y_=function e(i){function t(t){return new X_(t,i)}return t.tension=function(t){return e(+t)},t}(0);function q_(t,e){this._context=t,this._k=(1-e)/6}q_.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._point=0},lineEnd:function(){(this._line||0!==this._line&&3===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,e){switch(t=+t,e=+e,this._point){case 0:this._point=1;break;case 1:this._point=2;break;case 2:this._point=3,this._line?this._context.lineTo(this._x2,this._y2):this._context.moveTo(this._x2,this._y2);break;case 3:this._point=4;default:j_(this,t,e)}this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=e}};var K_=function e(i){function t(t){return new q_(t,i)}return t.tension=function(t){return e(+t)},t}(0);function Z_(t,e,i){var n,r,a=t._x1,s=t._y1,o=t._x2,l=t._y2;t._l01_a>V&&(n=2*t._l01_2a+3*t._l01_a*t._l12_a+t._l12_2a,r=3*t._l01_a*(t._l01_a+t._l12_a),a=(a*n-t._x0*t._l12_2a+t._x2*t._l01_2a)/r,s=(s*n-t._y0*t._l12_2a+t._y2*t._l01_2a)/r),t._l23_a>V&&(n=2*t._l23_2a+3*t._l23_a*t._l12_a+t._l12_2a,r=3*t._l23_a*(t._l23_a+t._l12_a),o=(o*n+t._x1*t._l23_2a-e*t._l12_2a)/r,l=(l*n+t._y1*t._l23_2a-i*t._l12_2a)/r),t._context.bezierCurveTo(a,s,o,l,t._x2,t._y2)}function J_(t,e){this._context=t,this._alpha=e}J_.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._l01_a=this._l12_a=this._l23_a=this._l01_2a=this._l12_2a=this._l23_2a=this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x2,this._y2);break;case 3:this.point(this._x2,this._y2)}(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,e){var i,n;switch(t=+t,e=+e,this._point&&(i=this._x2-t,n=this._y2-e,this._l23_a=Math.sqrt(this._l23_2a=Math.pow(i*i+n*n,this._alpha))),this._point){case 0:this._point=1,this._line?this._context.lineTo(t,e):this._context.moveTo(t,e);break;case 1:this._point=2;break;case 2:this._point=3;default:Z_(this,t,e)}this._l01_a=this._l12_a,this._l12_a=this._l23_a,this._l01_2a=this._l12_2a,this._l12_2a=this._l23_2a,this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=e}};var Q_=function e(i){function t(t){return i?new J_(t,i):new H_(t,0)}return t.alpha=function(t){return e(+t)},t}(.5);function tv(t,e){this._context=t,this._alpha=e}tv.prototype={areaStart:k_,areaEnd:k_,lineStart:function(){this._x0=this._x1=this._x2=this._x3=this._x4=this._x5=this._y0=this._y1=this._y2=this._y3=this._y4=this._y5=NaN,this._l01_a=this._l12_a=this._l23_a=this._l01_2a=this._l12_2a=this._l23_2a=this._point=0},lineEnd:function(){switch(this._point){case 1:this._context.moveTo(this._x3,this._y3),this._context.closePath();break;case 2:this._context.lineTo(this._x3,this._y3),this._context.closePath();break;case 3:this.point(this._x3,this._y3),this.point(this._x4,this._y4),this.point(this._x5,this._y5)}},point:function(t,e){var i,n;switch(t=+t,e=+e,this._point&&(i=this._x2-t,n=this._y2-e,this._l23_a=Math.sqrt(this._l23_2a=Math.pow(i*i+n*n,this._alpha))),this._point){case 0:this._point=1,this._x3=t,this._y3=e;break;case 1:this._point=2,this._context.moveTo(this._x4=t,this._y4=e);break;case 2:this._point=3,this._x5=t,this._y5=e;break;default:Z_(this,t,e)}this._l01_a=this._l12_a,this._l12_a=this._l23_a,this._l01_2a=this._l12_2a,this._l12_2a=this._l23_2a,this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=e}};var ev=function e(i){function t(t){return i?new tv(t,i):new X_(t,0)}return t.alpha=function(t){return e(+t)},t}(.5);function iv(t,e){this._context=t,this._alpha=e}iv.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._x2=this._y0=this._y1=this._y2=NaN,this._l01_a=this._l12_a=this._l23_a=this._l01_2a=this._l12_2a=this._l23_2a=this._point=0},lineEnd:function(){(this._line||0!==this._line&&3===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,e){var i,n;switch(t=+t,e=+e,this._point&&(i=this._x2-t,n=this._y2-e,this._l23_a=Math.sqrt(this._l23_2a=Math.pow(i*i+n*n,this._alpha))),this._point){case 0:this._point=1;break;case 1:this._point=2;break;case 2:this._point=3,this._line?this._context.lineTo(this._x2,this._y2):this._context.moveTo(this._x2,this._y2);break;case 3:this._point=4;default:Z_(this,t,e)}this._l01_a=this._l12_a,this._l12_a=this._l23_a,this._l01_2a=this._l12_2a,this._l12_2a=this._l23_2a,this._x0=this._x1,this._x1=this._x2,this._x2=t,this._y0=this._y1,this._y1=this._y2,this._y2=e}};var nv=function e(i){function t(t){return i?new iv(t,i):new q_(t,0)}return t.alpha=function(t){return e(+t)},t}(.5);function rv(t){this._context=t}function av(t){return t<0?-1:1}function sv(t,e,i){var n=t._x1-t._x0,e=e-t._x1,r=(t._y1-t._y0)/(n||e<0&&-0),i=(i-t._y1)/(e||n<0&&-0),t=(r*e+i*n)/(n+e);return(av(r)+av(i))*Math.min(Math.abs(r),Math.abs(i),.5*Math.abs(t))||0}function ov(t,e){var i=t._x1-t._x0;return i?(3*(t._y1-t._y0)/i-e)/2:e}function lv(t,e,i){var n=t._x0,r=t._y0,a=t._x1,s=t._y1,o=(a-n)/3;t._context.bezierCurveTo(n+o,r+o*e,a-o,s-o*i,a,s)}function cv(t){this._context=t}function hv(t){this._context=new dv(t)}function dv(t){this._context=t}function uv(t){this._context=t}function pv(t){var e,i,n=t.length-1,r=new Array(n),a=new Array(n),s=new Array(n);for(a[r[0]=0]=2,s[0]=t[0]+2*t[1],e=1;e<n-1;++e)r[e]=1,a[e]=4,s[e]=4*t[e]+2*t[e+1];for(r[n-1]=2,a[n-1]=7,s[n-1]=8*t[n-1]+t[n],e=1;e<n;++e)i=r[e]/a[e-1],a[e]-=i,s[e]-=i*s[e-1];for(r[n-1]=s[n-1]/a[n-1],e=n-2;0<=e;--e)r[e]=(s[e]-r[e+1])/a[e];for(a[n-1]=(t[n]+r[n-1])/2,e=0;e<n-1;++e)a[e]=2*t[e+1]-r[e+1];return[r,a]}function gv(t,e){this._context=t,this._t=e}function fv(t,e){if(1<(r=t.length))for(var i,n,r,a=1,s=t[e[0]],o=s.length;a<r;++a)for(n=s,s=t[e[a]],i=0;i<o;++i)s[i][1]+=s[i][0]=isNaN(n[i][1])?n[i][0]:n[i][1]}function mv(t){for(var e=t.length,i=new Array(e);0<=--e;)i[e]=e;return i}function _v(t,e){return t[e]}function vv(t){var i=t.map(yv);return mv(t).sort(function(t,e){return i[t]-i[e]})}function yv(t){for(var e,i=-1,n=0,r=t.length,a=-1/0;++i<r;)(e=+t[i][1])>a&&(a=e,n=i);return n}function bv(t){var i=t.map(Cv);return mv(t).sort(function(t,e){return i[t]-i[e]})}function Cv(t){for(var e,i=0,n=-1,r=t.length;++n<r;)(e=+t[n][1])&&(i+=e);return i}function xv(t){return function(){return t}}function wv(t){return t[0]}function Sv(t){return t[1]}function Mv(){this._=null}function Ov(t){t.U=t.C=t.L=t.R=t.P=t.N=null}function Gv(t,e){var i=e,e=e.R,n=i.U;n?n.L===i?n.L=e:n.R=e:t._=e,e.U=n,i.U=e,i.R=e.L,i.R&&(i.R.U=i),e.L=i}function Iv(t,e){var i=e,e=e.L,n=i.U;n?n.L===i?n.L=e:n.R=e:t._=e,e.U=n,i.U=e,i.L=e.R,i.L&&(i.L.U=i),e.R=i}function Tv(t){for(;t.L;)t=t.L;return t}function Av(t,e,i,n){var r=[null,null],a=U.push(r)-1;return r.left=t,r.right=e,i&&Dv(r,t,e,i),n&&Dv(r,e,t,n),Yv[t.index].halfedges.push(a),Yv[e.index].halfedges.push(a),r}function Pv(t,e,i){e=[e,i];return e.left=t,e}function Dv(t,e,i,n){t[0]||t[1]?t.left===i?t[1]=n:t[0]=n:(t[0]=n,t.left=e,t.right=i)}function Ev(t,e,i,n){for(var r,a=U.length;a--;)(function(t,e,i,n,r){var a=t[1];if(!a){var s,o=t[0],l=t.left,c=t.right,h=l[0],l=l[1],d=c[0],c=c[1],u=(h+d)/2;if(c===l){if(u<e||n<=u)return;if(d<h){if(o){if(o[1]>=r)return}else o=[u,i];a=[u,r]}else{if(o){if(o[1]<i)return}else o=[u,r];a=[u,i]}}else if(u=(l+c)/2-(s=(h-d)/(c-l))*u,s<-1||1<s)if(d<h){if(o){if(o[1]>=r)return}else o=[(i-u)/s,i];a=[(r-u)/s,r]}else{if(o){if(o[1]<i)return}else o=[(r-u)/s,r];a=[(i-u)/s,i]}else if(l<c){if(o){if(o[0]>=n)return}else o=[e,s*e+u];a=[n,s*n+u]}else{if(o){if(o[0]<e)return}else o=[n,s*n+u];a=[e,s*e+u]}t[0]=o,t[1]=a}return 1})(r=U[a],t,e,i,n)&&function(t,e,i,n,r){var a=t[0],s=t[1],o=a[0],a=a[1],l=0,c=1,h=s[0]-o,s=s[1]-a,e=e-o;if(h||!(0<e)){if(e/=h,h<0){if(e<l)return;e<c&&(c=e)}else if(0<h){if(c<e)return;l<e&&(l=e)}if(e=n-o,h||!(e<0)){if(e/=h,h<0){if(c<e)return;l<e&&(l=e)}else if(0<h){if(e<l)return;e<c&&(c=e)}if(e=i-a,s||!(0<e)){if(e/=s,s<0){if(e<l)return;e<c&&(c=e)}else if(0<s){if(c<e)return;l<e&&(l=e)}if(e=r-a,s||!(e<0)){if(e/=s,s<0){if(c<e)return;l<e&&(l=e)}else if(0<s){if(e<l)return;e<c&&(c=e)}return(0<l||c<1)&&(0<l&&(t[0]=[o+l*h,a+l*s]),c<1&&(t[1]=[o+c*h,a+c*s])),1}}}}}(r,t,e,i,n)&&(Math.abs(r[0][0]-r[1][0])>$||Math.abs(r[0][1]-r[1][1])>$)||delete U[a]}function Nv(t,e){return e[+(e.left!==t.site)]}function Lv(){for(var t,e,i,n,r,a,s,o=0,l=Yv.length;o<l;++o)if((t=Yv[o])&&(i=(e=t.halfedges).length)){for(var c=new Array(i),h=new Array(i),d=0;d<i;++d)c[d]=d,h[d]=(n=t,r=U[e[d]],s=a=void 0,n=n.site,a=r.left,s=r.right,n===s&&(s=a,a=n),s?Math.atan2(s[1]-a[1],s[0]-a[0]):(s=n===a?(a=r[1],r[0]):(a=r[0],r[1]),Math.atan2(a[0]-s[0],s[1]-a[1])));for(c.sort(function(t,e){return h[e]-h[t]}),d=0;d<i;++d)h[d]=e[c[d]];for(d=0;d<i;++d)e[d]=h[d]}}rv.prototype={areaStart:k_,areaEnd:k_,lineStart:function(){this._point=0},lineEnd:function(){this._point&&this._context.closePath()},point:function(t,e){t=+t,e=+e,this._point?this._context.lineTo(t,e):(this._point=1,this._context.moveTo(t,e))}},cv.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=this._t0=NaN,this._point=0},lineEnd:function(){switch(this._point){case 2:this._context.lineTo(this._x1,this._y1);break;case 3:lv(this,this._t0,ov(this,this._t0))}(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),this._line=1-this._line},point:function(t,e){var i=NaN;if(e=+e,(t=+t)!==this._x1||e!==this._y1){switch(this._point){case 0:this._point=1,this._line?this._context.lineTo(t,e):this._context.moveTo(t,e);break;case 1:this._point=2;break;case 2:this._point=3,lv(this,ov(this,i=sv(this,t,e)),i);break;default:lv(this,this._t0,i=sv(this,t,e))}this._x0=this._x1,this._x1=t,this._y0=this._y1,this._y1=e,this._t0=i}}},(hv.prototype=Object.create(cv.prototype)).point=function(t,e){cv.prototype.point.call(this,e,t)},dv.prototype={moveTo:function(t,e){this._context.moveTo(e,t)},closePath:function(){this._context.closePath()},lineTo:function(t,e){this._context.lineTo(e,t)},bezierCurveTo:function(t,e,i,n,r,a){this._context.bezierCurveTo(e,t,n,i,a,r)}},uv.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x=[],this._y=[]},lineEnd:function(){var t=this._x,e=this._y,i=t.length;if(i)if(this._line?this._context.lineTo(t[0],e[0]):this._context.moveTo(t[0],e[0]),2===i)this._context.lineTo(t[1],e[1]);else for(var n=pv(t),r=pv(e),a=0,s=1;s<i;++a,++s)this._context.bezierCurveTo(n[0][a],r[0][a],n[1][a],r[1][a],t[s],e[s]);(this._line||0!==this._line&&1===i)&&this._context.closePath(),this._line=1-this._line,this._x=this._y=null},point:function(t,e){this._x.push(+t),this._y.push(+e)}},gv.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x=this._y=NaN,this._point=0},lineEnd:function(){0<this._t&&this._t<1&&2===this._point&&this._context.lineTo(this._x,this._y),(this._line||0!==this._line&&1===this._point)&&this._context.closePath(),0<=this._line&&(this._t=1-this._t,this._line=1-this._line)},point:function(t,e){switch(t=+t,e=+e,this._point){case 0:this._point=1,this._line?this._context.lineTo(t,e):this._context.moveTo(t,e);break;case 1:this._point=2;default:var i;this._t<=0?(this._context.lineTo(this._x,e),this._context.lineTo(t,e)):(i=this._x*(1-this._t)+t*this._t,this._context.lineTo(i,this._y),this._context.lineTo(i,e))}this._x=t,this._y=e}},Mv.prototype={constructor:Mv,insert:function(t,e){var i,n,r;if(t){if(e.P=t,e.N=t.N,t.N&&(t.N.P=e),t.N=e,t.R){for(t=t.R;t.L;)t=t.L;t.L=e}else t.R=e;i=t}else i=this._?(t=Tv(this._),e.P=null,(e.N=t).P=t.L=e,t):(e.P=e.N=null,this._=e,null);for(e.L=e.R=null,e.U=i,e.C=!0,t=e;i&&i.C;)i===(n=i.U).L?(r=n.R)&&r.C?(i.C=r.C=!1,n.C=!0,t=n):(t===i.R&&(Gv(this,i),i=(t=i).U),i.C=!1,n.C=!0,Iv(this,n)):(r=n.L)&&r.C?(i.C=r.C=!1,n.C=!0,t=n):(t===i.L&&(Iv(this,i),i=(t=i).U),i.C=!1,n.C=!0,Gv(this,n)),i=t.U;this._.C=!1},remove:function(t){t.N&&(t.N.P=t.P),t.P&&(t.P.N=t.N),t.N=t.P=null;var e,i,n=t.U,r=t.L,a=t.R,s=r?a?Tv(a):r:a;if(n?n.L===t?n.L=s:n.R=s:this._=s,r&&a?(i=s.C,s.C=t.C,((s.L=r).U=s)!==a?(n=s.U,s.U=t.U,t=s.R,n.L=t,(s.R=a).U=s):(s.U=n,t=(n=s).R)):(i=t.C,t=s),t&&(t.U=n),!i)if(t&&t.C)t.C=!1;else{do{if(t===this._)break;if(t===n.L){if((e=n.R).C&&(e.C=!1,n.C=!0,Gv(this,n),e=n.R),e.L&&e.L.C||e.R&&e.R.C){e.R&&e.R.C||(e.L.C=!1,e.C=!0,Iv(this,e),e=n.R),e.C=n.C,n.C=e.R.C=!1,Gv(this,n),t=this._;break}}else if((e=n.L).C&&(e.C=!1,n.C=!0,Iv(this,n),e=n.L),e.L&&e.L.C||e.R&&e.R.C){e.L&&e.L.C||(e.R.C=!1,e.C=!0,Gv(this,e),e=n.L),e.C=n.C,n.C=e.L.C=!1,Iv(this,n),t=this._;break}}while(e.C=!0,n=(t=n).U,!t.C);t&&(t.C=!1)}}};var Rv,kv=[];function Fv(){Ov(this),this.x=this.y=this.arc=this.site=this.cy=null}function Vv(t){var e=t.P,i=t.N;if(e&&i){var e=e.site,n=t.site,i=i.site;if(e!==i){var r=n[0],a=n[1],s=e[0]-r,e=e[1]-a,o=i[0]-r,i=i[1]-a,l=2*(s*i-e*o);if(!(-Kv<=l)){for(var c=s*s+e*e,h=o*o+i*i,i=(i*c-e*h)/l,e=(s*h-o*c)/l,d=kv.pop()||new Fv,u=(d.arc=t,d.site=n,d.x=i+r,d.y=(d.cy=e+a)+Math.sqrt(i*i+e*e),t.circle=d,null),p=qv._;p;)if(d.y<p.y||d.y===p.y&&d.x<=p.x){if(!p.L){u=p.P;break}p=p.L}else{if(!p.R){u=p;break}p=p.R}qv.insert(u,d),u||(Rv=d)}}}}function Uv(t){var e=t.circle;e&&(e.P||(Rv=e.N),qv.remove(e),kv.push(e),Ov(e),t.circle=null)}var $v=[];function Bv(){Ov(this),this.edge=this.site=this.circle=null}function zv(t){var e=$v.pop()||new Bv;return e.site=t,e}function jv(t){Uv(t),Xv.remove(t),$v.push(t),Ov(t)}function Hv(t){for(var e,i,n,r,a=t[0],s=t[1],o=Xv._;o;)if(n=Wv(o,s)-a,$<n)o=o.L;else{if(r=a-function(t,e){var i=t.N;if(i)return Wv(i,e);i=t.site;return i[1]===e?i[0]:1/0}(o,s),!($<r)){-$<n?(e=o.P,i=o):-$<r?i=(e=o).N:e=i=o;break}if(!o.R){e=o;break}o=o.R}Yv[t.index]={site:t,halfedges:[]};var l,c,h,d,u,p,g,f,m,_,v=zv(t);if(Xv.insert(e,v),e||i){if(e===i)return Uv(e),i=zv(e.site),Xv.insert(v,i),v.edge=i.edge=Av(e.site,v.site),Vv(e),void Vv(i);i?(Uv(e),Uv(i),c=(l=e.site)[0],h=l[1],d=t[0]-c,_=t[1]-h,p=(u=i.site)[0]-c,g=u[1]-h,Dv(i.edge,l,u,_=[(g*(f=d*d+_*_)-_*(m=p*p+g*g))/(g=2*(d*g-_*p))+c,(d*m-p*f)/g+h]),v.edge=Av(l,t,null,_),i.edge=Av(t,u,null,_),Vv(e),Vv(i)):v.edge=Av(e.site,v.site)}}function Wv(t,e){var i=t.site,n=i[0],r=i[1],a=r-e;if(!a)return n;t=t.P;if(!t)return-1/0;t=(i=t.site)[0],i=i[1],e=i-e;if(!e)return t;var s=t-n,o=1/a-1/e,l=s/e;return o?(-l+Math.sqrt(l*l-2*o*(s*s/(-2*e)-i+e/2+r-a/2)))/o+n:(n+t)/2}var Xv,Yv,qv,U,$=1e-6,Kv=1e-12;function Zv(t,e){return e[1]-t[1]||e[0]-t[0]}function Jv(t,e){var R,k,i,n=t.sort(Zv).pop();for(U=[],Yv=new Array(t.length),Xv=new Mv,qv=new Mv;;)if(i=Rv,n&&(!i||n[1]<i.y||n[1]===i.y&&n[0]<i.x))n[0]===R&&n[1]===k||(Hv(n),R=n[0],k=n[1]),n=t.pop();else{if(!i)break;f=g=p=u=d=h=c=l=o=s=a=r=void 0;for(var r=i.arc,a=r.circle,s=a.x,o=a.cy,l=[s,o],c=r.P,h=r.N,d=[r],u=(jv(r),c);u.circle&&Math.abs(s-u.circle.x)<$&&Math.abs(o-u.circle.cy)<$;)c=u.P,d.unshift(u),jv(u),u=c;d.unshift(u),Uv(u);for(var p=h;p.circle&&Math.abs(s-p.circle.x)<$&&Math.abs(o-p.circle.cy)<$;)h=p.N,d.push(p),jv(p),p=h;d.push(p),Uv(p);for(var g=d.length,f=1;f<g;++f)p=d[f],u=d[f-1],Dv(p.edge,u.site,p.site,l);u=d[0],(p=d[g-1]).edge=Av(u.site,p.site,null,l),Vv(u),Vv(p)}if(Lv(),e){var m,_,v,y,b,C,x,w,S,M,O=+e[0][0],G=+e[0][1],I=+e[1][0],e=+e[1][1],T=(Ev(O,G,I,e),O),A=G,P=I,D=e,F=Yv.length,E=!0;for(L=0;L<F;++L)if(m=Yv[L]){for(_=m.site,v=(y=m.halfedges).length;v--;)U[y[v]]||y.splice(v,1);for(v=0,b=y.length;v<b;)S=m,S=(M=(M=U[y[v]])[+(M.left===S.site)])[0],w=M[1],C=(x=Nv(m,U[y[++v%b]]))[0],x=x[1],(Math.abs(S-C)>$||Math.abs(w-x)>$)&&(y.splice(v,0,U.push(Pv(_,M,Math.abs(S-T)<$&&$<D-w?[T,Math.abs(C-T)<$?x:D]:Math.abs(w-D)<$&&$<P-S?[Math.abs(x-D)<$?C:P,D]:Math.abs(S-P)<$&&$<w-A?[P,Math.abs(C-P)<$?x:A]:Math.abs(w-A)<$&&$<S-T?[Math.abs(x-A)<$?C:T,A]:null))-1),++b);b&&(E=!1)}if(E){for(var N,V=1/0,L=0,E=null;L<F;++L)(m=Yv[L])&&(N=(N=(_=m.site)[0]-T)*N+(N=_[1]-A)*N)<V&&(V=N,E=m);E&&(O=[P,D],G=[P,A],E.halfedges.push(U.push(Pv(_=E.site,I=[T,A],e=[T,D]))-1,U.push(Pv(_,e,O))-1,U.push(Pv(_,O,G))-1,U.push(Pv(_,G,I))-1))}for(L=0;L<F;++L)!(m=Yv[L])||m.halfedges.length||delete Yv[L]}this.edges=U,this.cells=Yv,Xv=qv=U=Yv=null}function Qv(t){return function(){return t}}function t0(t,e,i){this.target=t,this.type=e,this.transform=i}function e0(t,e,i){this.k=t,this.x=e,this.y=i}Jv.prototype={constructor:Jv,polygons:function(){var i=this.edges;return this.cells.map(function(e){var t=e.halfedges.map(function(t){return Nv(e,i[t])});return t.data=e.site.data,t})},triangles:function(){var h=[],d=this.edges;return this.cells.forEach(function(t,e){if(n=(i=t.halfedges).length)for(var i,n,r,a,s=t.site,o=-1,l=d[i[n-1]],c=l.left===s?l.right:l.left;++o<n;)r=c,c=(l=d[i[o]]).left===s?l.right:l.left,r&&c&&e<r.index&&e<c.index&&(a=c,(s[0]-a[0])*(r[1]-s[1])-(s[0]-r[0])*(a[1]-s[1])<0)&&h.push([s.data,r.data,c.data])}),h},links:function(){return this.edges.filter(function(t){return t.right}).map(function(t){return{source:t.left.data,target:t.right.data}})},find:function(i,n,t){for(var e,r,a=this,s=a._found||0,o=a.cells.length;!(r=a.cells[s]);)if(++s>=o)return null;for(var l=i-r.site[0],c=n-r.site[1],h=l*l+c*c;r=a.cells[e=s],s=null,r.halfedges.forEach(function(t){var t=a.edges[t],e=t.left;!(e!==r.site&&e||(e=t.right))||(t=(t=i-e[0])*t+(t=n-e[1])*t)<h&&(h=t,s=e.index)}),null!==s;);return a._found=e,null==t||h<=t*t?r.site:null}},e0.prototype={constructor:e0,scale:function(t){return 1===t?this:new e0(this.k*t,this.x,this.y)},translate:function(t,e){return 0===t&0===e?this:new e0(this.k,this.x+this.k*t,this.y+this.k*e)},apply:function(t){return[t[0]*this.k+this.x,t[1]*this.k+this.y]},applyX:function(t){return t*this.k+this.x},applyY:function(t){return t*this.k+this.y},invert:function(t){return[(t[0]-this.x)/this.k,(t[1]-this.y)/this.k]},invertX:function(t){return(t-this.x)/this.k},invertY:function(t){return(t-this.y)/this.k},rescaleX:function(t){return t.copy().domain(t.range().map(this.invertX,this).map(t.invert,t))},rescaleY:function(t){return t.copy().domain(t.range().map(this.invertY,this).map(t.invert,t))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};var i0=new e0(1,0,0);function n0(t){for(;!t.__zoom;)if(!(t=t.parentNode))return i0;return t.__zoom}function r0(){z.event.stopImmediatePropagation()}function a0(){z.event.preventDefault(),z.event.stopImmediatePropagation()}function s0(){return!z.event.ctrlKey&&!z.event.button}function o0(){var t=this;return t instanceof SVGElement?(t=t.ownerSVGElement||t).hasAttribute("viewBox")?[[(t=t.viewBox.baseVal).x,t.y],[t.x+t.width,t.y+t.height]]:[[0,0],[t.width.baseVal.value,t.height.baseVal.value]]:[[0,0],[t.clientWidth,t.clientHeight]]}function l0(){return this.__zoom||i0}function c0(){return-z.event.deltaY*(1===z.event.deltaMode?.05:z.event.deltaMode?1:.002)}function h0(){return navigator.maxTouchPoints||"ontouchstart"in this}function d0(t,e,i){var n=t.invertX(e[0][0])-i[0][0],r=t.invertX(e[1][0])-i[1][0],a=t.invertY(e[0][1])-i[0][1],e=t.invertY(e[1][1])-i[1][1];return t.translate(n<r?(n+r)/2:Math.min(0,n)||Math.max(0,r),a<e?(a+e)/2:Math.min(0,a)||Math.max(0,e))}n0.prototype=e0.prototype,z.FormatSpecifier=Rs,z.active=function(t,e){var i,n,r=t.__transition;if(r)for(n in e=null==e?null:e+"",r)if((i=r[n]).state>Bn&&i.name===e)return new lr([[t]],Ar,e,+n);return null},z.arc=function(){var I=Xm,T=Ym,A=y(0),P=null,D=qm,E=Km,N=Zm,L=null;function e(){var t,e,i,n,r,a,s,o,l,c,h,d,u,p,g,f,m,_,v,y,b,C,x=+I.apply(this,arguments),w=+T.apply(this,arguments),S=D.apply(this,arguments)-jm,M=E.apply(this,arguments)-jm,O=km(M-S),G=S<M;if(L=L||(t=ua()),w<x&&(e=w,w=x,x=e),V<w?Hm-V<O?(L.moveTo(w*Fm(S),w*$m(S)),L.arc(0,0,w,S,M,!G),V<x&&(L.moveTo(x*Fm(M),x*$m(M)),L.arc(0,0,x,M,S,G))):(n=e=S,r=i=M,s=a=O,h=N.apply(this,arguments)/2,u=V<h&&(P?+P.apply(this,arguments):Bm(x*x+w*w)),C=b=o=Um(km(w-x)/2,+A.apply(this,arguments)),V<u&&(d=Wm(u/x*$m(h)),u=Wm(u/w*$m(h)),(a-=2*d)>V?(n+=d*=G?1:-1,r-=d):(a=0,n=r=(S+M)/2),(s-=2*u)>V?(e+=u*=G?1:-1,i-=u):(s=0,e=i=(S+M)/2)),h=w*Fm(e),d=w*$m(e),u=x*Fm(r),S=x*$m(r),V<o&&(p=w*Fm(i),g=w*$m(i),f=x*Fm(n),m=x*$m(n),O<zm&&(M=function(t,e,i,n,r,a,s,o){var l=(o=o-a)*(i=i-t)-(s=s-r)*(n=n-e);if(!(l*l<V))return[t+(l=(s*(e-a)-o*(t-r))/l)*i,e+l*n]}(h,d,f,m,p,g,u,S))&&(O=h-M[0],v=d-M[1],y=p-M[0],_=g-M[1],v=1/$m((1<(O=(O*y+v*_)/(Bm(O*O+v*v)*Bm(y*y+_*_)))?0:O<-1?zm:Math.acos(O))/2),y=Bm(M[0]*M[0]+M[1]*M[1]),b=Um(o,(x-y)/(v-1)),C=Um(o,(w-y)/(1+v)))),V<s?V<C?(l=Jm(f,m,h,d,w,C,G),c=Jm(p,g,u,S,w,C,G),L.moveTo(l.cx+l.x01,l.cy+l.y01),C<o?L.arc(l.cx,l.cy,C,F(l.y01,l.x01),F(c.y01,c.x01),!G):(L.arc(l.cx,l.cy,C,F(l.y01,l.x01),F(l.y11,l.x11),!G),L.arc(0,0,w,F(l.cy+l.y11,l.cx+l.x11),F(c.cy+c.y11,c.cx+c.x11),!G),L.arc(c.cx,c.cy,C,F(c.y11,c.x11),F(c.y01,c.x01),!G))):(L.moveTo(h,d),L.arc(0,0,w,e,i,!G)):L.moveTo(h,d),V<x&&V<a?V<b?(l=Jm(u,S,p,g,x,-b,G),c=Jm(h,d,f,m,x,-b,G),L.lineTo(l.cx+l.x01,l.cy+l.y01),b<o?L.arc(l.cx,l.cy,b,F(l.y01,l.x01),F(c.y01,c.x01),!G):(L.arc(l.cx,l.cy,b,F(l.y01,l.x01),F(l.y11,l.x11),!G),L.arc(0,0,x,F(l.cy+l.y11,l.cx+l.x11),F(c.cy+c.y11,c.cx+c.x11),G),L.arc(c.cx,c.cy,b,F(c.y11,c.x11),F(c.y01,c.x01),!G))):L.arc(0,0,x,r,n,G):L.lineTo(u,S)):L.moveTo(0,0),L.closePath(),t)return L=null,t+""||null}return e.centroid=function(){var t=(+I.apply(this,arguments)+ +T.apply(this,arguments))/2,e=(+D.apply(this,arguments)+ +E.apply(this,arguments))/2-zm/2;return[Fm(e)*t,$m(e)*t]},e.innerRadius=function(t){return arguments.length?(I="function"==typeof t?t:y(+t),e):I},e.outerRadius=function(t){return arguments.length?(T="function"==typeof t?t:y(+t),e):T},e.cornerRadius=function(t){return arguments.length?(A="function"==typeof t?t:y(+t),e):A},e.padRadius=function(t){return arguments.length?(P=null==t?null:"function"==typeof t?t:y(+t),e):P},e.startAngle=function(t){return arguments.length?(D="function"==typeof t?t:y(+t),e):D},e.endAngle=function(t){return arguments.length?(E="function"==typeof t?t:y(+t),e):E},e.padAngle=function(t){return arguments.length?(N="function"==typeof t?t:y(+t),e):N},e.context=function(t){return arguments.length?(L=null==t?null:t,e):L},e},z.area=r_,z.areaRadial=u_,z.ascending=g,z.autoType=function(t){for(var e in t){var i,n,r=t[e].trim();if(r)if("true"===r)r=!0;else if("false"===r)r=!1;else if("NaN"===r)r=NaN;else if(isNaN(i=+r)){if(!(n=r.match(/^([-+]\d{2})?\d{4}(-\d{2}(-\d{2})?)?(T\d{2}:\d{2}(:\d{2}(\.\d{3})?)?(Z|[-+]\d{2}:\d{2})?)?$/)))continue;rs&&n[4]&&!n[7]&&(r=r.replace(/-/g,"/").replace(/T/," ")),r=new Date(r)}else r=i;else r=null;t[e]=r}return t},z.axisBottom=function(t){return xt(gt,t)},z.axisLeft=function(t){return xt(ft,t)},z.axisRight=function(t){return xt(pt,t)},z.axisTop=function(t){return xt(ut,t)},z.bisect=v,z.bisectLeft=m,z.bisectRight=v,z.bisector=M,z.blob=function(t,e){return fetch(t,e).then(as)},z.brush=function(){return ta(zr)},z.brushSelection=function(t){return(t=t.__brush)?t.dim.output(t.selection):null},z.brushX=function(){return ta($r)},z.brushY=function(){return ta(Br)},z.buffer=function(t,e){return fetch(t,e).then(ss)},z.chord=function(){var C=0,x=null,w=null,S=null;function e(n){for(var t,e,i,r,a=n.length,s=[],o=K(a),l=[],c=[],h=c.groups=new Array(a),d=new Array(a*a),u=0,p=-1;++p<a;){for(t=0,r=-1;++r<a;)t+=n[p][r];s.push(t),l.push(K(a)),u+=t}for(x&&o.sort(function(t,e){return x(s[t],s[e])}),w&&l.forEach(function(t,i){t.sort(function(t,e){return w(n[i][t],n[i][e])})}),i=(u=aa(0,ra-C*a)/u)?C:ra/a,t=0,p=-1;++p<a;){for(e=t,r=-1;++r<a;){var g=o[p],f=l[g][r],m=n[g][f],_=t,v=t+=m*u;d[f*a+g]={index:g,subindex:f,startAngle:_,endAngle:v,value:m}}h[g]={index:g,startAngle:e,endAngle:t,value:s[g]},t+=i}for(p=-1;++p<a;)for(r=p-1;++r<a;){var y=d[r*a+p],b=d[p*a+r];(y.value||b.value)&&c.push(y.value<b.value?{source:b,target:y}:{source:y,target:b})}return S?c.sort(S):c}return e.padAngle=function(t){return arguments.length?(C=aa(0,t),e):C},e.sortGroups=function(t){return arguments.length?(x=t,e):x},e.sortSubgroups=function(t){return arguments.length?(w=t,e):w},e.sortChords=function(t){return arguments.length?(null==t?S=null:(i=t,(S=function(t,e){return i(t.source.value+t.target.value,e.source.value+e.target.value)})._=t),e):S&&S._;var i},e},z.clientPoint=_e,z.cluster=function(){var o=rd,l=1,c=1,h=!1;function e(e){var n,r=0,t=(e.eachAfter(function(t){var e,i=t.children;i?(t.x=(e=i).reduce(ad,0)/e.length,t.y=1+i.reduce(sd,0)):(t.x=n?r+=o(t,n):0,t.y=0,n=t)}),function(t){for(var e;e=t.children;)t=e[0];return t}(e)),i=function(t){for(var e;e=t.children;)t=e[e.length-1];return t}(e),a=t.x-o(t,i)/2,s=i.x+o(i,t)/2;return e.eachAfter(h?function(t){t.x=(t.x-e.x)*l,t.y=(e.y-t.y)*c}:function(t){t.x=(t.x-a)/(s-a)*l,t.y=(1-(e.y?t.y/e.y:1))*c})}return e.separation=function(t){return arguments.length?(o=t,e):o},e.size=function(t){return arguments.length?(h=!1,l=+t[0],c=+t[1],e):h?null:[l,c]},e.nodeSize=function(t){return arguments.length?(h=!0,l=+t[0],c=+t[1],e):h?[l,c]:null},e},z.color=He,z.contourDensity=function(){var s=La,o=Ra,l=ka,i=960,n=500,r=20,c=2,h=3*r,d=i+2*h>>c,u=n+2*h>>c,p=Ia(20);function e(t){var a=new Float32Array(d*u),e=new Float32Array(d*u),t=(t.forEach(function(t,e,i){var n=+s(t,e,i)+h>>c,r=+o(t,e,i)+h>>c,t=+l(t,e,i);0<=n&&n<d&&0<=r&&r<u&&(a[n+r*d]+=t)}),Ea({width:d,height:u,data:a},{width:d,height:u,data:e},r>>c),Na({width:d,height:u,data:e},{width:d,height:u,data:a},r>>c),Ea({width:d,height:u,data:a},{width:d,height:u,data:e},r>>c),Na({width:d,height:u,data:e},{width:d,height:u,data:a},r>>c),Ea({width:d,height:u,data:a},{width:d,height:u,data:e},r>>c),Na({width:d,height:u,data:e},{width:d,height:u,data:a},r>>c),p(a));return Array.isArray(t)||(t=it(0,e=at(a),t),(t=K(0,Math.floor(e/t)*t,t)).shift()),Da().thresholds(t).size([d,u])(a).map(g)}function g(t){return t.value*=Math.pow(2,-2*c),t.coordinates.forEach(a),t}function a(t){t.forEach(f)}function f(t){t.forEach(m)}function m(t){t[0]=t[0]*Math.pow(2,c)-h,t[1]=t[1]*Math.pow(2,c)-h}function _(){return d=i+2*(h=3*r)>>c,u=n+2*h>>c,e}return e.x=function(t){return arguments.length?(s="function"==typeof t?t:Ia(+t),e):s},e.y=function(t){return arguments.length?(o="function"==typeof t?t:Ia(+t),e):o},e.weight=function(t){return arguments.length?(l="function"==typeof t?t:Ia(+t),e):l},e.size=function(t){if(!arguments.length)return[i,n];var e=Math.ceil(t[0]),t=Math.ceil(t[1]);if(0<=e)return i=e,n=t,_();throw new Error("invalid size")},e.cellSize=function(t){if(!arguments.length)return 1<<c;if(1<=(t=+t))return c=Math.floor(Math.log(t)/Math.LN2),_();throw new Error("invalid cell size")},e.thresholds=function(t){return arguments.length?(p="function"==typeof t?t:Array.isArray(t)?Ia(Oa.call(t)):Ia(t),e):p},e.bandwidth=function(t){if(!arguments.length)return Math.sqrt(r*(r+1));if(0<=(t=+t))return r=Math.round((Math.sqrt(4*t*t+1)-1)/2),_();throw new Error("invalid bandwidth")},e},z.contours=Da,z.create=function(t){return ue(At(t).call(document.documentElement))},z.creator=At,z.cross=function(t,e,i){var n,r,a,s,o=t.length,l=e.length,c=new Array(o*l);for(null==i&&(i=b),n=a=0;n<o;++n)for(s=t[n],r=0;r<l;++r,++a)c[a]=i(s,e[r]);return c},z.csv=hs,z.csvFormat=Xa,z.csvFormatBody=Ya,z.csvFormatRow=Ka,z.csvFormatRows=qa,z.csvFormatValue=t,z.csvParse=Ha,z.csvParseRows=Wa,z.cubehelix=Ti,z.curveBasis=function(t){return new V_(t)},z.curveBasisClosed=function(t){return new U_(t)},z.curveBasisOpen=function(t){return new $_(t)},z.curveBundle=z_,z.curveCardinal=W_,z.curveCardinalClosed=Y_,z.curveCardinalOpen=K_,z.curveCatmullRom=Q_,z.curveCatmullRomClosed=ev,z.curveCatmullRomOpen=nv,z.curveLinear=t_,z.curveLinearClosed=function(t){return new rv(t)},z.curveMonotoneX=function(t){return new cv(t)},z.curveMonotoneY=function(t){return new hv(t)},z.curveNatural=function(t){return new uv(t)},z.curveStep=function(t){return new gv(t,.5)},z.curveStepAfter=function(t){return new gv(t,1)},z.curveStepBefore=function(t){return new gv(t,0)},z.customEvent=le,z.descending=function(t,e){return e<t?-1:t<e?1:t<=e?0:NaN},z.deviation=B,z.dispatch=St,z.drag=function(){var i,n,r,a,s=Oe,o=Ge,e=Ie,l=Te,g={},f=St("start","drag","end"),m=0,c=0;function _(t){t.on("mousedown.drag",h).filter(l).on("touchstart.drag",p).on("touchmove.drag",v).on("touchend.drag touchcancel.drag",y).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function h(){var t;!a&&s.apply(this,arguments)&&(t=b("mouse",o.apply(this,arguments),ve,this,arguments))&&(ue(z.event.view).on("mousemove.drag",d,!0).on("mouseup.drag",u,!0),xe(z.event.view),be(),r=!1,i=z.event.clientX,n=z.event.clientY,t("start"))}function d(){var t,e;Ce(),r||(t=z.event.clientX-i,e=z.event.clientY-n,r=c<t*t+e*e),g.mouse("drag")}function u(){ue(z.event.view).on("mousemove.drag mouseup.drag",null),we(z.event.view,r),Ce(),g.mouse("end")}function p(){if(s.apply(this,arguments))for(var t,e=z.event.changedTouches,i=o.apply(this,arguments),n=e.length,r=0;r<n;++r)(t=b(e[r].identifier,i,ye,this,arguments))&&(be(),t("start"))}function v(){for(var t,e=z.event.changedTouches,i=e.length,n=0;n<i;++n)(t=g[e[n].identifier])&&(Ce(),t("drag"))}function y(){var t,e,i=z.event.changedTouches,n=i.length;for(a&&clearTimeout(a),a=setTimeout(function(){a=null},500),t=0;t<n;++t)(e=g[i[t].identifier])&&(be(),e("end"))}function b(r,a,s,o,l){var c,h,d,u=s(a,r),p=f.copy();if(le(new Me(_,"beforestart",c,r,m,u[0],u[1],0,0,p),function(){return null!=(z.event.subject=c=e.apply(o,l))&&(h=c.x-u[0]||0,d=c.y-u[1]||0,!0)}))return function t(e){var i,n=u;switch(e){case"start":g[r]=t,i=m++;break;case"end":delete g[r],--m;case"drag":u=s(a,r),i=m}le(new Me(_,e,c,r,i,u[0]+h,u[1]+d,u[0]-n[0],u[1]-n[1],p),p.apply,p,[e,o,l])}}return _.filter=function(t){return arguments.length?(s="function"==typeof t?t:Se(!!t),_):s},_.container=function(t){return arguments.length?(o="function"==typeof t?t:Se(t),_):o},_.subject=function(t){return arguments.length?(e="function"==typeof t?t:Se(t),_):e},_.touchable=function(t){return arguments.length?(l="function"==typeof t?t:Se(!!t),_):l},_.on=function(){var t=f.on.apply(f,arguments);return t===f?_:t},_.clickDistance=function(t){return arguments.length?(c=(t=+t)*t,_):Math.sqrt(c)},_},z.dragDisable=xe,z.dragEnable=we,z.dsv=function(t,e,i,n){3===arguments.length&&"function"==typeof i&&(n=i,i=void 0);var r=ja(t);return ls(e,i).then(function(t){return r.parse(t,n)})},z.dsvFormat=ja,z.easeBack=Sr,z.easeBackIn=xr,z.easeBackInOut=Sr,z.easeBackOut=wr,z.easeBounce=Cr,z.easeBounceIn=function(t){return 1-Cr(1-t)},z.easeBounceInOut=function(t){return((t*=2)<=1?1-Cr(1-t):Cr(t-1)+1)/2},z.easeBounceOut=Cr,z.easeCircle=yr,z.easeCircleIn=function(t){return 1-Math.sqrt(1-t*t)},z.easeCircleInOut=yr,z.easeCircleOut=function(t){return Math.sqrt(1- --t*t)},z.easeCubic=ur,z.easeCubicIn=function(t){return t*t*t},z.easeCubicInOut=ur,z.easeCubicOut=function(t){return--t*t*t+1},z.easeElastic=Gr,z.easeElasticIn=Or,z.easeElasticInOut=Ir,z.easeElasticOut=Gr,z.easeExp=vr,z.easeExpIn=function(t){return Math.pow(2,10*t-10)},z.easeExpInOut=vr,z.easeExpOut=function(t){return 1-Math.pow(2,-10*t)},z.easeLinear=function(t){return+t},z.easePoly=gr,z.easePolyIn=hr,z.easePolyInOut=gr,z.easePolyOut=pr,z.easeQuad=dr,z.easeQuadIn=function(t){return t*t},z.easeQuadInOut=dr,z.easeQuadOut=function(t){return t*(2-t)},z.easeSin=_r,z.easeSinIn=function(t){return 1-Math.cos(t*mr)},z.easeSinInOut=_r,z.easeSinOut=function(t){return Math.sin(t*mr)},z.entries=function(t){var e,i=[];for(e in t)i.push({key:e,value:t[e]});return i},z.extent=j,z.forceCenter=function(a,s){var o;function e(){for(var t,e=o.length,i=0,n=0,r=0;r<e;++r)i+=(t=o[r]).x,n+=t.y;for(i=i/e-a,n=n/e-s,r=0;r<e;++r)(t=o[r]).x-=i,t.y-=n}return null==a&&(a=0),null==s&&(s=0),e.initialize=function(t){o=t},e.x=function(t){return arguments.length?(a=+t,e):a},e.y=function(t){return arguments.length?(s=+t,e):s},e},z.forceCollide=function(n){var a,s,u=1,p=1;function e(){for(var t,e,o,l,c,h,d,i=a.length,n=0;n<p;++n)for(e=Cs(a,Ss,Ms).visitAfter(g),t=0;t<i;++t)o=a[t],h=s[o.index],d=h*h,l=o.x+o.vx,c=o.y+o.vy,e.visit(r);function r(t,e,i,n,r){var a=t.data,t=t.r,s=h+t;if(!a)return l+s<e||n<l-s||c+s<i||r<c-s;a.index>o.index&&((i=(e=l-a.x-a.vx)*e+(n=c-a.y-a.vy)*n)<s*s&&(0===e&&(i+=(e=_s())*e),0===n&&(i+=(n=_s())*n),i=(s-(i=Math.sqrt(i)))/i*u,o.vx+=(e*=i)*(s=(t*=t)/(d+t)),o.vy+=(n*=i)*s,a.vx-=e*(s=1-s),a.vy-=n*s))}}function g(t){if(t.data)return t.r=s[t.data.index];for(var e=t.r=0;e<4;++e)t[e]&&t[e].r>t.r&&(t.r=t[e].r)}function i(){if(a){var t,e,i=a.length;for(s=new Array(i),t=0;t<i;++t)e=a[t],s[e.index]=+n(e,t,a)}}return"function"!=typeof n&&(n=f(null==n?1:+n)),e.initialize=function(t){a=t,i()},e.iterations=function(t){return arguments.length?(p=+t,e):p},e.strength=function(t){return arguments.length?(u=+t,e):u},e.radius=function(t){return arguments.length?(n="function"==typeof t?t:f(+t),i(),e):n},e},z.forceLink=function(c){var h,d,a,s,u,o=Os,i=function(t){return 1/Math.min(s[t.source.index],s[t.target.index])},n=f(30),p=1;function e(t){for(var e=0,i=c.length;e<p;++e)for(var n,r,a,s,o,l=0;l<i;++l)n=(r=c[l]).source,a=(r=r.target).x+r.vx-n.x-n.vx||_s(),s=r.y+r.vy-n.y-n.vy||_s(),a*=o=((o=Math.sqrt(a*a+s*s))-d[l])/o*t*h[l],s*=o,r.vx-=a*(o=u[l]),r.vy-=s*o,n.vx+=a*(o=1-o),n.vy+=s*o}function r(){if(a){var t,e=a.length,i=c.length,n=ya(a,o),r=0;for(s=new Array(e);r<i;++r)(t=c[r]).index=r,"object"!=typeof t.source&&(t.source=Gs(n,t.source)),"object"!=typeof t.target&&(t.target=Gs(n,t.target)),s[t.source.index]=(s[t.source.index]||0)+1,s[t.target.index]=(s[t.target.index]||0)+1;for(r=0,u=new Array(i);r<i;++r)t=c[r],u[r]=s[t.source.index]/(s[t.source.index]+s[t.target.index]);h=new Array(i),l(),d=new Array(i),g()}}function l(){if(a)for(var t=0,e=c.length;t<e;++t)h[t]=+i(c[t],t,c)}function g(){if(a)for(var t=0,e=c.length;t<e;++t)d[t]=+n(c[t],t,c)}return null==c&&(c=[]),e.initialize=function(t){a=t,r()},e.links=function(t){return arguments.length?(c=t,r(),e):c},e.id=function(t){return arguments.length?(o=t,e):o},e.iterations=function(t){return arguments.length?(p=+t,e):p},e.strength=function(t){return arguments.length?(i="function"==typeof t?t:f(+t),l(),e):i},e.distance=function(t){return arguments.length?(n="function"==typeof t?t:f(+t),g(),e):n},e},z.forceManyBody=function(){var r,l,c,h,n=f(-30),d=1,u=1/0,p=.81;function e(t){var e,i=r.length,n=Cs(r,Is,Ts).visitAfter(a);for(c=t,e=0;e<i;++e)l=r[e],n.visit(s)}function i(){if(r){var t,e,i=r.length;for(h=new Array(i),t=0;t<i;++t)e=r[t],h[e.index]=+n(e,t,r)}}function a(t){var e,i,n,r,a,s=0,o=0;if(t.length){for(n=r=a=0;a<4;++a)(e=t[a])&&(i=Math.abs(e.value))&&(s+=e.value,o+=i,n+=i*e.x,r+=i*e.y);t.x=n/o,t.y=r/o}else for((e=t).x=e.data.x,e.y=e.data.y;s+=h[e.data.index],e=e.next;);t.value=s}function s(t,e,i,n){if(!t.value)return!0;var r=t.x-l.x,a=t.y-l.y,s=n-e,o=r*r+a*a;if(s*s/p<o)return o<u&&(0===r&&(o+=(r=_s())*r),0===a&&(o+=(a=_s())*a),o<d&&(o=Math.sqrt(d*o)),l.vx+=r*t.value*c/o,l.vy+=a*t.value*c/o),!0;if(!(t.length||u<=o))for(t.data===l&&!t.next||(0===r&&(o+=(r=_s())*r),0===a&&(o+=(a=_s())*a),o<d&&(o=Math.sqrt(d*o)));t.data!==l&&(s=h[t.data.index]*c/o,l.vx+=r*s,l.vy+=a*s),t=t.next;);}return e.initialize=function(t){r=t,i()},e.strength=function(t){return arguments.length?(n="function"==typeof t?t:f(+t),i(),e):n},e.distanceMin=function(t){return arguments.length?(d=t*t,e):Math.sqrt(d)},e.distanceMax=function(t){return arguments.length?(u=t*t,e):Math.sqrt(u)},e.theta=function(t){return arguments.length?(p=t*t,e):Math.sqrt(p)},e},z.forceRadial=function(i,o,l){var c,h,d,n=f(.1);function e(t){for(var e=0,i=c.length;e<i;++e){var n=c[e],r=n.x-o||1e-6,a=n.y-l||1e-6,s=Math.sqrt(r*r+a*a),s=(d[e]-s)*h[e]*t/s;n.vx+=r*s,n.vy+=a*s}}function r(){if(c){var t,e=c.length;for(h=new Array(e),d=new Array(e),t=0;t<e;++t)d[t]=+i(c[t],t,c),h[t]=isNaN(d[t])?0:+n(c[t],t,c)}}return"function"!=typeof i&&(i=f(+i)),null==o&&(o=0),null==l&&(l=0),e.initialize=function(t){c=t,r()},e.strength=function(t){return arguments.length?(n="function"==typeof t?t:f(+t),r(),e):n},e.radius=function(t){return arguments.length?(i="function"==typeof t?t:f(+t),r(),e):i},e.x=function(t){return arguments.length?(o=+t,e):o},e.y=function(t){return arguments.length?(l=+t,e):l},e},z.forceSimulation=function(l){var a,s=1,e=.001,o=1-Math.pow(e,1/300),c=0,h=.6,d=ya(),t=En(n),i=St("tick","end");function n(){r(),i.call("tick",a),s<e&&(t.stop(),i.call("end",a))}function r(t){var e,i,n=l.length;void 0===t&&(t=1);for(var r=0;r<t;++r)for(s+=(c-s)*o,d.each(function(t){t(s)}),e=0;e<n;++e)null==(i=l[e]).fx?i.x+=i.vx*=h:(i.x=i.fx,i.vx=0),null==i.fy?i.y+=i.vy*=h:(i.y=i.fy,i.vy=0);return a}function u(){for(var t,e,i,n=0,r=l.length;n<r;++n)(i=l[n]).index=n,null!=i.fx&&(i.x=i.fx),null!=i.fy&&(i.y=i.fy),(isNaN(i.x)||isNaN(i.y))&&(t=10*Math.sqrt(n),e=n*As,i.x=t*Math.cos(e),i.y=t*Math.sin(e)),(isNaN(i.vx)||isNaN(i.vy))&&(i.vx=i.vy=0)}function p(t){return t.initialize&&t.initialize(l),t}return null==l&&(l=[]),u(),a={tick:r,restart:function(){return t.restart(n),a},stop:function(){return t.stop(),a},nodes:function(t){return arguments.length?(l=t,u(),d.each(p),a):l},alpha:function(t){return arguments.length?(s=+t,a):s},alphaMin:function(t){return arguments.length?(e=+t,a):e},alphaDecay:function(t){return arguments.length?(o=+t,a):+o},alphaTarget:function(t){return arguments.length?(c=+t,a):c},velocityDecay:function(t){return arguments.length?(h=1-t,a):1-h},force:function(t,e){return 1<arguments.length?(null==e?d.remove(t):d.set(t,p(e)),a):d.get(t)},find:function(t,e,i){var n,r,a,s=0,o=l.length;for(null==i?i=1/0:i*=i,s=0;s<o;++s)(n=(n=t-(r=l[s]).x)*n+(n=e-r.y)*n)<i&&(a=r,i=n);return a},on:function(t,e){return 1<arguments.length?(i.on(t,e),a):i.on(t)}}},z.forceX=function(i){var r,a,s,n=f(.1);function e(t){for(var e,i=0,n=r.length;i<n;++i)(e=r[i]).vx+=(s[i]-e.x)*a[i]*t}function o(){if(r){var t,e=r.length;for(a=new Array(e),s=new Array(e),t=0;t<e;++t)a[t]=isNaN(s[t]=+i(r[t],t,r))?0:+n(r[t],t,r)}}return"function"!=typeof i&&(i=f(null==i?0:+i)),e.initialize=function(t){r=t,o()},e.strength=function(t){return arguments.length?(n="function"==typeof t?t:f(+t),o(),e):n},e.x=function(t){return arguments.length?(i="function"==typeof t?t:f(+t),o(),e):i},e},z.forceY=function(i){var r,a,s,n=f(.1);function e(t){for(var e,i=0,n=r.length;i<n;++i)(e=r[i]).vy+=(s[i]-e.y)*a[i]*t}function o(){if(r){var t,e=r.length;for(a=new Array(e),s=new Array(e),t=0;t<e;++t)a[t]=isNaN(s[t]=+i(r[t],t,r))?0:+n(r[t],t,r)}}return"function"!=typeof i&&(i=f(null==i?0:+i)),e.initialize=function(t){r=t,o()},e.strength=function(t){return arguments.length?(n="function"==typeof t?t:f(+t),o(),e):n},e.y=function(t){return arguments.length?(i="function"==typeof t?t:f(+t),o(),e):i},e},z.formatDefaultLocale=js,z.formatLocale=zs,z.formatSpecifier=Ls,z.geoAlbers=Rh,z.geoAlbersUsa=function(){var e,i,r,a,s,n,o=Rh(),l=Lh().rotate([154,0]).center([-2,58.5]).parallels([55,65]),c=Lh().rotate([157,0]).center([-3,19.9]).parallels([8,18]),h={point:function(t,e){n=[t,e]}};function d(t){var e=t[0],t=t[1];return n=null,r.point(e,t),n||(a.point(e,t),n)||(s.point(e,t),n)}function u(){return e=i=null,d}return d.invert=function(t){var e=o.scale(),i=o.translate(),n=(t[0]-i[0])/e,i=(t[1]-i[1])/e;return(.12<=i&&i<.234&&-.425<=n&&n<-.214?l:.166<=i&&i<.234&&-.214<=n&&n<-.115?c:o).invert(t)},d.stream=function(t){return e&&i===t?e:(n=[o.stream(i=t),l.stream(t),c.stream(t)],r=n.length,e={point:function(t,e){for(var i=-1;++i<r;)n[i].point(t,e)},sphere:function(){for(var t=-1;++t<r;)n[t].sphere()},lineStart:function(){for(var t=-1;++t<r;)n[t].lineStart()},lineEnd:function(){for(var t=-1;++t<r;)n[t].lineEnd()},polygonStart:function(){for(var t=-1;++t<r;)n[t].polygonStart()},polygonEnd:function(){for(var t=-1;++t<r;)n[t].polygonEnd()}});var n,r},d.precision=function(t){return arguments.length?(o.precision(t),l.precision(t),c.precision(t),u()):o.precision()},d.scale=function(t){return arguments.length?(o.scale(t),l.scale(.35*t),c.scale(t),d.translate(o.translate())):o.scale()},d.translate=function(t){if(!arguments.length)return o.translate();var e=o.scale(),i=+t[0],n=+t[1];return r=o.translate(t).clipExtent([[i-.455*e,n-.238*e],[i+.455*e,n+.238*e]]).stream(h),a=l.translate([i-.307*e,n+.201*e]).clipExtent([[i-.425*e+A,n+.12*e+A],[i-.214*e-A,n+.234*e-A]]).stream(h),s=c.translate([i-.205*e,n+.212*e]).clipExtent([[i-.214*e+A,n+.166*e+A],[i-.115*e-A,n+.234*e-A]]).stream(h),u()},d.fitExtent=function(t,e){return Ch(d,t,e)},d.fitSize=function(t,e){return xh(d,t,e)},d.fitWidth=function(t,e){return wh(d,t,e)},d.fitHeight=function(t,e){return Sh(d,t,e)},d.scale(1070)},z.geoArea=function(t){return Co.reset(),go(t,xo),2*Co},z.geoAzimuthalEqualArea=function(){return Ph(Vh).scale(124.75).clipAngle(179.999)},z.geoAzimuthalEqualAreaRaw=Vh,z.geoAzimuthalEquidistant=function(){return Ph(Uh).scale(79.4188).clipAngle(179.999)},z.geoAzimuthalEquidistantRaw=Uh,z.geoBounds=function(t){var e,i,n,r,a,s,o;if(Lo=h=-(c=No=1/0),Uo=[],go(t,nl),i=Uo.length){for(Uo.sort(ul),e=1,a=[n=Uo[0]];e<i;++e)pl(n,(r=Uo[e])[0])||pl(n,r[1])?(dl(n[0],r[1])>dl(n[0],n[1])&&(n[1]=r[1]),dl(r[0],n[1])>dl(n[0],n[1])&&(n[0]=r[0])):a.push(n=r);for(s=-1/0,e=0,n=a[i=a.length-1];e<=i;n=r,++e)r=a[e],(o=dl(n[1],r[0]))>s&&(s=o,c=r[0],h=n[1])}return Uo=$o=null,c===1/0||No===1/0?[[NaN,NaN],[NaN,NaN]]:[[c,No],[h,Lo]]},z.geoCentroid=function(t){Bo=zo=jo=Ho=Wo=Xo=Yo=qo=Ko=Zo=Jo=0,go(t,gl);var e=Zo,i=Jo,n=(t=Ko)*t+e*e+i*i;return n<1e-12&&(t=Xo,e=Yo,i=qo,zo<A&&(t=jo,e=Ho,i=Wo),(n=t*t+e*e+i*i)<1e-12)?[NaN,NaN]:[N(e,t)*P,k(i/R(n))*P]},z.geoCircle=function(){var n,r,a=Ml([0,0]),s=Ml(90),o=Ml(6),l={point:function(t,e){n.push(t=r(t,e)),t[0]*=P,t[1]*=P}};function e(){var t=a.apply(this,arguments),e=s.apply(this,arguments)*D,i=o.apply(this,arguments)*D;return n=[],r=Il(-t[0]*D,-t[1]*D,0).invert,El(l,e,i,1),t={type:"Polygon",coordinates:[n]},n=r=null,t}return e.center=function(t){return arguments.length?(a="function"==typeof t?t:Ml([+t[0],+t[1]]),e):a},e.radius=function(t){return arguments.length?(s="function"==typeof t?t:Ml(+t),e):s},e.precision=function(t){return arguments.length?(o="function"==typeof t?t:Ml(+t),e):o},e},z.geoClipAntimeridian=Wl,z.geoClipCircle=Xl,z.geoClipExtent=function(){var e,i,n,r=0,a=0,s=960,o=500;return n={stream:function(t){return e&&i===t?e:e=Kl(r,a,s,o)(i=t)},extent:function(t){return arguments.length?(r=+t[0][0],a=+t[0][1],s=+t[1][0],o=+t[1][1],e=i=null,n):[[r,a],[s,o]]}}},z.geoClipRectangle=Kl,z.geoConicConformal=function(){return Eh(jh).scale(109.5).parallels([30,30])},z.geoConicConformalRaw=jh,z.geoConicEqualArea=Lh,z.geoConicEqualAreaRaw=Nh,z.geoConicEquidistant=function(){return Eh(Wh).scale(131.154).center([0,13.9389])},z.geoConicEquidistantRaw=Wh,z.geoContains=function(t,e){return(t&&cc.hasOwnProperty(t.type)?cc[t.type]:dc)(t,e)},z.geoDistance=lc,z.geoEqualEarth=function(){return Ph(Jh).scale(177.158)},z.geoEqualEarthRaw=Jh,z.geoEquirectangular=function(){return Ph(Hh).scale(152.63)},z.geoEquirectangularRaw=Hh,z.geoGnomonic=function(){return Ph(Qh).scale(144.049).clipAngle(60)},z.geoGnomonicRaw=Qh,z.geoGraticule=yc,z.geoGraticule10=function(){return yc()()},z.geoIdentity=function(){var n,r,e,i,a,s,o,l=1,c=0,h=0,d=1,u=1,p=0,g=null,f=1,m=1,_=vh({point:function(t,e){t=b([t,e]);this.stream.point(t[0],t[1])}}),v=bc;function y(){return f=l*d,m=l*u,s=o=null,b}function b(t){var e,i=t[0]*f,t=t[1]*m;return p&&(e=t*n-i*r,i=i*n+t*r,t=e),[i+c,t+h]}return b.invert=function(t){var e,i=t[0]-c,t=t[1]-h;return p&&(e=t*n+i*r,i=i*n-t*r,t=e),[i/f,t/m]},b.stream=function(t){return s&&o===t?s:s=_(v(o=t))},b.postclip=function(t){return arguments.length?(v=t,g=e=i=a=null,y()):v},b.clipExtent=function(t){return arguments.length?(v=null==t?(g=e=i=a=null,bc):Kl(g=+t[0][0],e=+t[0][1],i=+t[1][0],a=+t[1][1]),y()):null==g?null:[[g,e],[i,a]]},b.scale=function(t){return arguments.length?(l=+t,y()):l},b.translate=function(t){return arguments.length?(c=+t[0],h=+t[1],y()):[c,h]},b.angle=function(t){return arguments.length?(r=L(p=t%360*D),n=T(p),y()):p*P},b.reflectX=function(t){return arguments.length?(d=t?-1:1,y()):d<0},b.reflectY=function(t){return arguments.length?(u=t?-1:1,y()):u<0},b.fitExtent=function(t,e){return Ch(b,t,e)},b.fitSize=function(t,e){return xh(b,t,e)},b.fitWidth=function(t,e){return wh(b,t,e)},b.fitHeight=function(t,e){return Sh(b,t,e)},b},z.geoInterpolate=function(t,e){var i=t[0]*D,n=t[1]*D,t=e[0]*D,e=e[1]*D,r=T(n),a=L(n),s=T(e),o=L(e),l=r*T(i),c=r*L(i),h=s*T(t),d=s*L(t),u=2*k(R(oo(e-n)+r*s*oo(t-i))),p=L(u);return(e=u?function(t){var e=L(t*=u)/p,t=L(u-t)/p,i=t*l+e*h,n=t*c+e*d,t=t*a+e*o;return[N(n,i)*P,N(t,R(i*i+n*n))*P]}:function(){return[i*P,n*P]}).distance=u,e},z.geoLength=ac,z.geoMercator=function(){return Bh($h).scale(961/I)},z.geoMercatorRaw=$h,z.geoNaturalEarth1=function(){return Ph(td).scale(175.295)},z.geoNaturalEarth1Raw=td,z.geoOrthographic=function(){return Ph(ed).scale(249.5).clipAngle(90+A)},z.geoOrthographicRaw=ed,z.geoPath=function(e,i){var n,r,a=4.5;function s(t){return t&&("function"==typeof a&&r.pointRadius(+a.apply(this,arguments)),go(t,n(r))),r.result()}return s.area=function(t){return go(t,n(Gc)),Gc.result()},s.measure=function(t){return go(t,n(ph)),ph.result()},s.bounds=function(t){return go(t,n(Rc)),Rc.result()},s.centroid=function(t){return go(t,n(Kc)),Kc.result()},s.projection=function(t){return arguments.length?(n=null==t?(e=null,bc):(e=t).stream,s):e},s.context=function(t){return arguments.length?(r=null==t?(i=null,new mh):new sh(i=t),"function"!=typeof a&&r.pointRadius(a),s):i},s.pointRadius=function(t){return arguments.length?(a="function"==typeof t?t:(r.pointRadius(+t),+t),s):a},s.projection(e).context(i)},z.geoProjection=Ph,z.geoProjectionMutator=Dh,z.geoRotation=Dl,z.geoStereographic=function(){return Ph(id).scale(250).clipAngle(142)},z.geoStereographicRaw=id,z.geoStream=go,z.geoTransform=function(t){return{stream:vh(t)}},z.geoTransverseMercator=function(){var t=Bh(nd),e=t.center,i=t.rotate;return t.center=function(t){return arguments.length?e([-t[1],t[0]]):[(t=e())[1],-t[0]]},t.rotate=function(t){return arguments.length?i([t[0],t[1],2<t.length?t[2]+90:90]):[(t=i())[0],t[1],t[2]-90]},i([0,0,90]).scale(159.155)},z.geoTransverseMercatorRaw=nd,z.gray=function(t,e){return new gi(t,0,0,null==e?1:e)},z.hcl=bi,z.hierarchy=ld,z.histogram=function(){var u=q,p=j,g=nt;function e(t){for(var e,i=t.length,n=new Array(i),r=0;r<i;++r)n[r]=u(t[r],r,t);for(var a=p(n),s=a[0],o=a[1],l=g(n,s,o),c=(Array.isArray(l)||(l=it(s,o,l),l=K(Math.ceil(s/l)*l,o,l)),l.length);l[0]<=s;)l.shift(),--c;for(;l[c-1]>o;)l.pop(),--c;var h,d=new Array(c+1);for(r=0;r<=c;++r)(h=d[r]=[]).x0=0<r?l[r-1]:s,h.x1=r<c?l[r]:o;for(r=0;r<i;++r)s<=(e=n[r])&&e<=o&&d[v(l,e,0,c)].push(t[r]);return d}return e.value=function(t){return arguments.length?(u="function"==typeof t?t:Y(t),e):u},e.domain=function(t){return arguments.length?(p="function"==typeof t?t:Y([t[0],t[1]]),e):p},e.thresholds=function(t){return arguments.length?(g="function"==typeof t?t:Array.isArray(t)?Y(W.call(t)):Y(t),e):g},e},z.hsl=ei,z.html=fs,z.image=function(r,a){return new Promise(function(t,e){var i,n=new Image;for(i in a)n[i]=a[i];n.onerror=e,n.onload=function(){t(n)},n.src=r})},z.interpolate=Ki,z.interpolateArray=function(t,e){return(Bi(e)?$i:zi)(t,e)},z.interpolateBasis=Di,z.interpolateBasisClosed=Ei,z.interpolateBlues=gm,z.interpolateBrBG=Of,z.interpolateBuGn=jf,z.interpolateBuPu=Wf,z.interpolateCividis=function(t){return t=Math.max(0,Math.min(1,t)),"rgb("+Math.max(0,Math.min(255,Math.round(-4.54-t*(35.34-t*(2381.73-t*(6402.7-t*(7024.72-2710.57*t)))))))+", "+Math.max(0,Math.min(255,Math.round(32.49+t*(170.73+t*(52.82-t*(131.46-t*(176.58-67.37*t)))))))+", "+Math.max(0,Math.min(255,Math.round(81.24+t*(442.36-t*(2482.43-t*(6167.24-t*(6614.94-2475.67*t)))))))+")"},z.interpolateCool=Gm,z.interpolateCubehelix=_n,z.interpolateCubehelixDefault=Mm,z.interpolateCubehelixLong=vn,z.interpolateDate=ji,z.interpolateDiscrete=function(e){var i=e.length;return function(t){return e[Math.max(0,Math.min(i-1,Math.floor(t*i)))]}},z.interpolateGnBu=Yf,z.interpolateGreens=mm,z.interpolateGreys=vm,z.interpolateHcl=gn,z.interpolateHclLong=fn,z.interpolateHsl=Ne,z.interpolateHslLong=Ee,z.interpolateHue=function(t,e){var i=Ri(+t,+e);return function(t){t=i(t);return t-360*Math.floor(t/360)}},z.interpolateInferno=Lm,z.interpolateLab=function(e,t){var i=l((e=pi(e)).l,(t=pi(t)).l),n=l(e.a,t.a),r=l(e.b,t.b),a=l(e.opacity,t.opacity);return function(t){return e.l=i(t),e.a=n(t),e.b=r(t),e.opacity=a(t),e+""}},z.interpolateMagma=Nm,z.interpolateNumber=Hi,z.interpolateNumberArray=$i,z.interpolateObject=Wi,z.interpolateOrRd=Kf,z.interpolateOranges=Sm,z.interpolatePRGn=If,z.interpolatePiYG=Af,z.interpolatePlasma=Rm,z.interpolatePuBu=tm,z.interpolatePuBuGn=Jf,z.interpolatePuOr=Df,z.interpolatePuRd=im,z.interpolatePurples=bm,z.interpolateRainbow=function(t){(t<0||1<t)&&(t-=Math.floor(t));var e=Math.abs(t-.5);return Im.h=360*t-100,Im.s=1.5-1.5*e,Im.l=.8-.9*e,Im+""},z.interpolateRdBu=Nf,z.interpolateRdGy=Rf,z.interpolateRdPu=rm,z.interpolateRdYlBu=Ff,z.interpolateRdYlGn=Uf,z.interpolateReds=xm,z.interpolateRgb=Fi,z.interpolateRgbBasis=Ui,z.interpolateRgbBasisClosed=H,z.interpolateRound=Zi,z.interpolateSinebow=function(t){var e;return t=(.5-t)*Math.PI,Tm.r=255*(e=Math.sin(t))*e,Tm.g=255*(e=Math.sin(t+Am))*e,Tm.b=255*(e=Math.sin(t+Pm))*e,Tm+""},z.interpolateSpectral=Bf,z.interpolateString=qi,z.interpolateTransformCss=on,z.interpolateTransformSvg=ln,z.interpolateTurbo=function(t){return t=Math.max(0,Math.min(1,t)),"rgb("+Math.max(0,Math.min(255,Math.round(34.61+t*(1172.33-t*(10793.56-t*(33300.12-t*(38394.49-14825.05*t)))))))+", "+Math.max(0,Math.min(255,Math.round(23.31+t*(557.33+t*(1225.33-t*(3574.96-t*(1073.77+707.56*t)))))))+", "+Math.max(0,Math.min(255,Math.round(27.2+t*(3211.1-t*(15327.97-t*(27814-t*(22569.18-6838.66*t)))))))+")"},z.interpolateViridis=Em,z.interpolateWarm=Om,z.interpolateYlGn=lm,z.interpolateYlGnBu=sm,z.interpolateYlOrBr=hm,z.interpolateYlOrRd=um,z.interpolateZoom=dn,z.interrupt=Jn,z.interval=function(i,n,r){var a=new Dn,s=n;return null==n?a.restart(i,n,r):(n=+n,r=null==r?An():+r,a.restart(function t(e){e+=s,a.restart(t,s+=n,r),i(e)},n,r)),a},z.isoFormat=Jg,z.isoParse=Zg,z.json=function(t,e){return fetch(t,e).then(us)},z.keys=function(t){var e,i=[];for(e in t)i.push(e);return i},z.lab=pi,z.lch=function(t,e,i,n){return 1===arguments.length?yi(t):new Ci(i,e,t,null==n?1:n)},z.line=n_,z.lineRadial=d_,z.linkHorizontal=function(){return __(v_)},z.linkRadial=function(){var t=__(b_);return t.angle=t.x,delete t.x,t.radius=t.y,delete t.y,t},z.linkVertical=function(){return __(y_)},z.local=ge,z.map=ya,z.matcher=Lt,z.max=at,z.mean=function(t,e){var i,n=t.length,r=n,a=-1,s=0;if(null==e)for(;++a<n;)isNaN(i=C(t[a]))?--r:s+=i;else for(;++a<n;)isNaN(i=C(e(t[a],a,t)))?--r:s+=i;if(r)return s/r},z.median=function(t,e){var i,n=t.length,r=-1,a=[];if(null==e)for(;++r<n;)isNaN(i=C(t[r]))||a.push(i);else for(;++r<n;)isNaN(i=C(e(t[r],r,t)))||a.push(i);return rt(a.sort(g),.5)},z.merge=st,z.min=ot,z.mouse=ve,z.namespace=Tt,z.namespaces=It,z.nest=function(){var u,p,e,g=[],s=[];function f(t,i,n,r){if(i>=g.length)return null!=u&&t.sort(u),null!=p?p(t):t;for(var e,a,s,o=-1,l=t.length,c=g[i++],h=ya(),d=n();++o<l;)(s=h.get(e=c(a=t[o])+""))?s.push(a):h.set(e,[a]);return h.each(function(t,e){r(d,e,f(t,i,n,r))}),d}return e={object:function(t){return f(t,0,ba,Ca)},map:function(t){return f(t,0,xa,wa)},entries:function(t){return function i(t,n){if(++n>g.length)return t;var r,a=s[n-1];return null!=p&&n>=g.length?r=t.entries():(r=[],t.each(function(t,e){r.push({key:e,values:i(t,n)})})),null!=a?r.sort(function(t,e){return a(t.key,e.key)}):r}(f(t,0,xa,wa),0)},key:function(t){return g.push(t),e},sortKeys:function(t){return s[g.length-1]=t,e},sortValues:function(t){return u=t,e},rollup:function(t){return p=t,e}}},z.now=An,z.pack=function(){var e=null,i=1,n=1,r=Od;function a(t){return t.x=i/2,t.y=n/2,e?t.eachBefore(Td(e)).eachAfter(Ad(r,.5)).eachBefore(Pd(1)):t.eachBefore(Td(Id)).eachAfter(Ad(Od,1)).eachAfter(Ad(r,t.r/Math.min(i,n))).eachBefore(Pd(Math.min(i,n)/(2*t.r))),t}return a.radius=function(t){return arguments.length?(e=null==(t=t)?null:Md(t),a):e},a.size=function(t){return arguments.length?(i=+t[0],n=+t[1],a):[i,n]},a.padding=function(t){return arguments.length?(r="function"==typeof t?t:Gd(+t),a):r},a},z.packEnclose=gd,z.packSiblings=function(t){return Sd(t),t},z.pairs=function(t,e){null==e&&(e=b);for(var i=0,n=t.length-1,r=t[0],a=new Array(n<0?0:n);i<n;)a[i]=e(r,r=t[++i]);return a},z.partition=function(){var i=1,n=1,o=0,r=!1;function e(t){var a,s,e=t.height+1;return t.x0=t.y0=o,t.x1=i,t.y1=n/e,t.eachBefore((a=n,s=e,function(t){t.children&&Ed(t,t.x0,a*(t.depth+1)/s,t.x1,a*(t.depth+2)/s);var e=t.x0,i=t.y0,n=t.x1-o,r=t.y1-o;n<e&&(e=n=(e+n)/2),r<i&&(i=r=(i+r)/2),t.x0=e,t.y0=i,t.x1=n,t.y1=r})),r&&t.eachBefore(Dd),t}return e.round=function(t){return arguments.length?(r=!!t,e):r},e.size=function(t){return arguments.length?(i=+t[0],n=+t[1],e):[i,n]},e.padding=function(t){return arguments.length?(o=+t,e):o},e},z.path=ua,z.permute=function(t,e){for(var i=e.length,n=new Array(i);i--;)n[i]=t[e[i]];return n},z.pie=function(){var p=s_,g=a_,f=null,m=y(0),_=y(Hm),v=y(0);function e(i){for(var t,e,n,r=i.length,a=0,s=new Array(r),o=new Array(r),l=+m.apply(this,arguments),c=Math.min(Hm,Math.max(-Hm,_.apply(this,arguments)-l)),h=Math.min(Math.abs(c)/r,v.apply(this,arguments)),d=h*(c<0?-1:1),u=0;u<r;++u)0<(n=o[s[u]=u]=+p(i[u],u,i))&&(a+=n);for(null!=g?s.sort(function(t,e){return g(o[t],o[e])}):null!=f&&s.sort(function(t,e){return f(i[t],i[e])}),u=0,t=a?(c-r*d)/a:0;u<r;++u,l=e)e=s[u],n=o[e],o[e]={data:i[e],index:u,value:n,startAngle:l,endAngle:e=l+(0<n?n*t:0)+d,padAngle:h};return o}return e.value=function(t){return arguments.length?(p="function"==typeof t?t:y(+t),e):p},e.sortValues=function(t){return arguments.length?(g=t,f=null,e):g},e.sort=function(t){return arguments.length?(f=t,g=null,e):f},e.startAngle=function(t){return arguments.length?(m="function"==typeof t?t:y(+t),e):m},e.endAngle=function(t){return arguments.length?(_="function"==typeof t?t:y(+t),e):_},e.padAngle=function(t){return arguments.length?(v="function"==typeof t?t:y(+t),e):v},e},z.piecewise=function(t,e){for(var i=0,n=e.length-1,r=e[0],a=new Array(n<0?0:n);i<n;)a[i]=t(r,r=e[++i]);return function(t){var e=Math.max(0,Math.min(n-1,Math.floor(t*=n)));return a[e](t-e)}},z.pointRadial=p_,z.polygonArea=function(t){for(var e,i=-1,n=t.length,r=t[n-1],a=0;++i<n;)e=r,r=t[i],a+=e[1]*r[0]-e[0]*r[1];return a/2},z.polygonCentroid=function(t){for(var e,i,n=-1,r=t.length,a=0,s=0,o=t[r-1],l=0;++n<r;)e=o,o=t[n],l+=i=e[0]*o[1]-o[0]*e[1],a+=(e[0]+o[0])*i,s+=(e[1]+o[1])*i;return[a/(l*=3),s/l]},z.polygonContains=function(t,e){for(var i,n,r=t.length,a=t[r-1],s=e[0],o=e[1],l=a[0],c=a[1],h=!1,d=0;d<r;++d)i=(a=t[d])[0],o<(n=a[1])!=o<c&&s<(l-i)*(o-n)/(c-n)+i&&(h=!h),l=i,c=n;return h},z.polygonHull=function(t){if((e=t.length)<3)return null;for(var e,i=new Array(e),n=new Array(e),r=0;r<e;++r)i[r]=[+t[r][0],+t[r][1],r];for(i.sort(Hd),r=0;r<e;++r)n[r]=[i[r][0],-i[r][1]];var a=Wd(i),s=Wd(n),o=s[0]===a[0],l=s[s.length-1]===a[a.length-1],c=[];for(r=a.length-1;0<=r;--r)c.push(t[i[a[r]][2]]);for(r=+o;r<s.length-l;++r)c.push(t[i[s[r]][2]]);return c},z.polygonLength=function(t){for(var e,i,n=-1,r=t.length,a=t[r-1],s=a[0],o=a[1],l=0;++n<r;)e=s,i=o,e-=s=(a=t[n])[0],i-=o=a[1],l+=Math.sqrt(e*e+i*i);return l},z.precisionFixed=Hs,z.precisionPrefix=Ws,z.precisionRound=Xs,z.quadtree=Cs,z.quantile=rt,z.quantize=function(t,e){for(var i=new Array(e),n=0;n<e;++n)i[n]=t(n/(e-1));return i},z.radialArea=u_,z.radialLine=d_,z.randomBates=Jd,z.randomExponential=Qd,z.randomIrwinHall=Zd,z.randomLogNormal=Kd,z.randomNormal=qd,z.randomUniform=Yd,z.range=K,z.rgb=qe,z.ribbon=function(){var c=pa,h=ga,d=fa,u=ma,p=_a,g=null;function e(){var t,e=sa.call(arguments),i=c.apply(this,e),n=h.apply(this,e),i=+d.apply(this,(e[0]=i,e)),r=u.apply(this,e)-na,a=p.apply(this,e)-na,s=i*ea(r),o=i*ia(r),n=+d.apply(this,(e[0]=n,e)),l=u.apply(this,e)-na,e=p.apply(this,e)-na;if((g=g||(t=ua())).moveTo(s,o),g.arc(0,0,i,r,a),r==l&&a==e||(g.quadraticCurveTo(0,0,n*ea(l),n*ia(l)),g.arc(0,0,n,l,e)),g.quadraticCurveTo(0,0,s,o),g.closePath(),t)return g=null,t+""||null}return e.radius=function(t){return arguments.length?(d="function"==typeof t?t:oa(+t),e):d},e.startAngle=function(t){return arguments.length?(u="function"==typeof t?t:oa(+t),e):u},e.endAngle=function(t){return arguments.length?(p="function"==typeof t?t:oa(+t),e):p},e.source=function(t){return arguments.length?(c=t,e):c},e.target=function(t){return arguments.length?(h=t,e):h},e.context=function(t){return arguments.length?(g=null==t?null:t,e):g},e},z.scaleBand=ou,z.scaleDiverging=function t(){var e=vu(pf()(S));return e.copy=function(){return df(e,t())},eu.apply(e,arguments)},z.scaleDivergingLog=function t(){var e=Ou(pf()).domain([.1,1,10]);return e.copy=function(){return df(e,t()).base(e.base())},eu.apply(e,arguments)},z.scaleDivergingPow=gf,z.scaleDivergingSqrt=function(){return gf.apply(null,arguments).exponent(.5)},z.scaleDivergingSymlog=function t(){var e=Tu(pf());return e.copy=function(){return df(e,t()).constant(e.constant())},eu.apply(e,arguments)},z.scaleIdentity=function t(e){var i;function n(t){return isNaN(t=+t)?i:t}return(n.invert=n).domain=n.range=function(t){return arguments.length?(e=nu.call(t,lu),n):e.slice()},n.unknown=function(t){return arguments.length?(i=t,n):i},n.copy=function(){return t(e).unknown(i)},e=arguments.length?nu.call(e,lu):[0,1],vu(n)},z.scaleImplicit=au,z.scaleLinear=function t(){var e=mu(S,S);return e.copy=function(){return gu(e,t())},tu.apply(e,arguments),vu(e)},z.scaleLog=function t(){var e=Ou(fu()).domain([1,10]);return e.copy=function(){return gu(e,t()).base(e.base())},tu.apply(e,arguments),e},z.scaleOrdinal=su,z.scalePoint=function(){return function t(e){var i=e.copy;return e.padding=e.paddingOuter,delete e.paddingInner,delete e.paddingOuter,e.copy=function(){return t(i())},e}(ou.apply(null,arguments).paddingInner(1))},z.scalePow=Nu,z.scaleQuantile=function t(){var e,r=[],i=[],n=[];function a(){var t=0,e=Math.max(1,i.length);for(n=new Array(e-1);++t<e;)n[t-1]=rt(r,t/e);return s}function s(t){return isNaN(t=+t)?e:i[v(n,t)]}return s.invertExtent=function(t){return(t=i.indexOf(t))<0?[NaN,NaN]:[0<t?n[t-1]:r[0],t<n.length?n[t]:r[r.length-1]]},s.domain=function(t){if(!arguments.length)return r.slice();r=[];for(var e,i=0,n=t.length;i<n;++i)null==(e=t[i])||isNaN(e=+e)||r.push(e);return r.sort(g),a()},s.range=function(t){return arguments.length?(i=ru.call(t),a()):i.slice()},s.unknown=function(t){return arguments.length?(e=t,s):e},s.quantiles=function(){return n.slice()},s.copy=function(){return t().domain(r).range(i).unknown(e)},tu.apply(s,arguments)},z.scaleQuantize=function t(){var e,i=0,n=1,r=1,a=[.5],s=[0,1];function o(t){return t<=t?s[v(a,t,0,r)]:e}function l(){var t=-1;for(a=new Array(r);++t<r;)a[t]=((t+1)*n-(t-r)*i)/(r+1);return o}return o.domain=function(t){return arguments.length?(i=+t[0],n=+t[1],l()):[i,n]},o.range=function(t){return arguments.length?(r=(s=ru.call(t)).length-1,l()):s.slice()},o.invertExtent=function(t){return(t=s.indexOf(t))<0?[NaN,NaN]:t<1?[i,a[0]]:r<=t?[a[r-1],n]:[a[t-1],a[t]]},o.unknown=function(t){return arguments.length&&(e=t),o},o.thresholds=function(){return a.slice()},o.copy=function(){return t().domain([i,n]).range(s).unknown(e)},tu.apply(vu(o),arguments)},z.scaleSequential=function t(){var e=vu(hf()(S));return e.copy=function(){return df(e,t())},eu.apply(e,arguments)},z.scaleSequentialLog=function t(){var e=Ou(hf()).domain([1,10]);return e.copy=function(){return df(e,t()).base(e.base())},eu.apply(e,arguments)},z.scaleSequentialPow=uf,z.scaleSequentialQuantile=function t(){var r=[],e=S;function a(t){if(!isNaN(t=+t))return e((v(r,t)-1)/(r.length-1))}return a.domain=function(t){if(!arguments.length)return r.slice();r=[];for(var e,i=0,n=t.length;i<n;++i)null==(e=t[i])||isNaN(e=+e)||r.push(e);return r.sort(g),a},a.interpolator=function(t){return arguments.length?(e=t,a):e},a.copy=function(){return t(e).domain(r)},eu.apply(a,arguments)},z.scaleSequentialSqrt=function(){return uf.apply(null,arguments).exponent(.5)},z.scaleSequentialSymlog=function t(){var e=Tu(hf());return e.copy=function(){return df(e,t()).constant(e.constant())},eu.apply(e,arguments)},z.scaleSqrt=function(){return Nu.apply(null,arguments).exponent(.5)},z.scaleSymlog=function t(){var e=Tu(fu());return e.copy=function(){return gu(e,t()).constant(e.constant())},tu.apply(e,arguments)},z.scaleThreshold=function t(){var e,i=[.5],n=[0,1],r=1;function a(t){return t<=t?n[v(i,t,0,r)]:e}return a.domain=function(t){return arguments.length?(i=ru.call(t),r=Math.min(i.length,n.length-1),a):i.slice()},a.range=function(t){return arguments.length?(n=ru.call(t),r=Math.min(i.length,n.length-1),a):n.slice()},a.invertExtent=function(t){return t=n.indexOf(t),[i[t-1],i[t]]},a.unknown=function(t){return arguments.length?(e=t,a):e},a.copy=function(){return t().domain(i).range(n).unknown(e)},tu.apply(a,arguments)},z.scaleTime=function(){return tu.apply(cf(cp,op,Xu,ju,Bu,Uu,Fu,ku,z.timeFormat).domain([new Date(2e3,0,1),new Date(2e3,0,2)]),arguments)},z.scaleUtc=function(){return tu.apply(cf(Np,Dp,vp,fp,pp,dp,Fu,ku,z.utcFormat).domain([Date.UTC(2e3,0,1),Date.UTC(2e3,0,2)]),arguments)},z.scan=function(t,e){if(i=t.length){var i,n,r=0,a=0,s=t[a];for(null==e&&(e=g);++r<i;)(e(n=t[r],s)<0||0!==e(s,s))&&(s=n,a=r);return 0===e(s,s)?a:void 0}},z.schemeAccent=mf,z.schemeBlues=pm,z.schemeBrBG=Mf,z.schemeBuGn=zf,z.schemeBuPu=Hf,z.schemeCategory10=ff,z.schemeDark2=_f,z.schemeGnBu=Xf,z.schemeGreens=fm,z.schemeGreys=_m,z.schemeOrRd=qf,z.schemeOranges=wm,z.schemePRGn=Gf,z.schemePaired=vf,z.schemePastel1=yf,z.schemePastel2=bf,z.schemePiYG=Tf,z.schemePuBu=Qf,z.schemePuBuGn=Zf,z.schemePuOr=Pf,z.schemePuRd=em,z.schemePurples=ym,z.schemeRdBu=Ef,z.schemeRdGy=Lf,z.schemeRdPu=nm,z.schemeRdYlBu=kf,z.schemeRdYlGn=Vf,z.schemeReds=Cm,z.schemeSet1=Cf,z.schemeSet2=xf,z.schemeSet3=wf,z.schemeSpectral=$f,z.schemeTableau10=Sf,z.schemeYlGn=om,z.schemeYlGnBu=am,z.schemeYlOrBr=cm,z.schemeYlOrRd=dm,z.select=ue,z.selectAll=function(t){return"string"==typeof t?new x([document.querySelectorAll(t)],[document.documentElement]):new x([null==t?[]:t],he)},z.selection=de,z.selector=Dt,z.selectorAll=Nt,z.set=Ma,z.shuffle=function(t,e,i){for(var n,r,a=(null==i?t.length:i)-(e=null==e?0:+e);a;)r=Math.random()*a--|0,n=t[a+e],t[a+e]=t[r+e],t[r+e]=n;return t},z.stack=function(){var d=y([]),u=mv,p=fv,g=_v;function e(t){for(var e,i=d.apply(this,arguments),n=t.length,r=i.length,a=new Array(r),s=0;s<r;++s){for(var o,l=i[s],c=a[s]=new Array(n),h=0;h<n;++h)c[h]=o=[0,+g(t[h],l,h,t)],o.data=t[h];c.key=l}for(s=0,e=u(a);s<r;++s)a[e[s]].index=s;return p(a,e),a}return e.keys=function(t){return arguments.length?(d="function"==typeof t?t:y(g_.call(t)),e):d},e.value=function(t){return arguments.length?(g="function"==typeof t?t:y(+t),e):g},e.order=function(t){return arguments.length?(u=null==t?mv:"function"==typeof t?t:y(g_.call(t)),e):u},e.offset=function(t){return arguments.length?(p=null==t?fv:t,e):p},e},z.stackOffsetDiverging=function(t,e){if(0<(o=t.length))for(var i,n,r,a,s,o,l=0,c=t[e[0]].length;l<c;++l)for(i=a=s=0;i<o;++i)0<(r=(n=t[e[i]][l])[1]-n[0])?(n[0]=a,n[1]=a+=r):r<0?(n[1]=s,n[0]=s+=r):(n[0]=0,n[1]=r)},z.stackOffsetExpand=function(t,e){if(0<(n=t.length)){for(var i,n,r,a=0,s=t[0].length;a<s;++a){for(r=i=0;i<n;++i)r+=t[i][a][1]||0;if(r)for(i=0;i<n;++i)t[i][a][1]/=r}fv(t,e)}},z.stackOffsetNone=fv,z.stackOffsetSilhouette=function(t,e){if(0<(i=t.length)){for(var i,n=0,r=t[e[0]],a=r.length;n<a;++n){for(var s=0,o=0;s<i;++s)o+=t[s][n][1]||0;r[n][1]+=r[n][0]=-o/2}fv(t,e)}},z.stackOffsetWiggle=function(t,e){if(0<(r=t.length)&&0<(n=(i=t[e[0]]).length)){for(var i,n,r,a=0,s=1;s<n;++s){for(var o=0,l=0,c=0;o<r;++o){for(var h=t[e[o]],d=h[s][1]||0,u=(d-(h[s-1][1]||0))/2,p=0;p<o;++p){var g=t[e[p]];u+=(g[s][1]||0)-(g[s-1][1]||0)}l+=d,c+=u*d}i[s-1][1]+=i[s-1][0]=a,l&&(a-=c/l)}i[s-1][1]+=i[s-1][0]=a,fv(t,e)}},z.stackOrderAppearance=vv,z.stackOrderAscending=bv,z.stackOrderDescending=function(t){return bv(t).reverse()},z.stackOrderInsideOut=function(t){for(var e,i=t.length,n=t.map(Cv),r=vv(t),a=0,s=0,o=[],l=[],c=0;c<i;++c)e=r[c],a<s?(a+=n[e],o.push(e)):(s+=n[e],l.push(e));return l.reverse().concat(o)},z.stackOrderNone=mv,z.stackOrderReverse=function(t){return mv(t).reverse()},z.stratify=function(){var h=Rd,d=kd;function e(t){for(var e,i,n,r,a,s=t.length,o=new Array(s),l={},c=0;c<s;++c)a=t[c],n=o[c]=new ud(a),null!=(r=h(a,c,t))&&(r+="")&&(l[a="$"+(n.id=r)]=a in l?Ld:n);for(c=0;c<s;++c)if(n=o[c],null!=(r=d(t[c],c,t))&&(r+="")){if(!(i=l["$"+r]))throw new Error("missing: "+r);if(i===Ld)throw new Error("ambiguous: "+r);i.children?i.children.push(n):i.children=[n],n.parent=i}else{if(e)throw new Error("multiple roots");e=n}if(!e)throw new Error("no root");if(e.parent=Nd,e.eachBefore(function(t){t.depth=t.parent.depth+1,--s}).eachBefore(dd),e.parent=null,0<s)throw new Error("cycle");return e}return e.id=function(t){return arguments.length?(h=Md(t),e):h},e.parentId=function(t){return arguments.length?(d=Md(t),e):d},e},z.style=zt,z.sum=function(t,e){var i,n=t.length,r=-1,a=0;if(null==e)for(;++r<n;)(i=+t[r])&&(a+=i);else for(;++r<n;)(i=+e(t[r],r,t))&&(a+=i);return a},z.svg=ms,z.symbol=function(){var e=y(C_),i=y(64),n=null;function r(){var t;if(n=n||(t=ua()),e.apply(this,arguments).draw(n,+i.apply(this,arguments)),t)return n=null,t+""||null}return r.type=function(t){return arguments.length?(e="function"==typeof t?t:y(t),r):e},r.size=function(t){return arguments.length?(i="function"==typeof t?t:y(+t),r):i},r.context=function(t){return arguments.length?(n=null==t?null:t,r):n},r},z.symbolCircle=C_,z.symbolCross=x_,z.symbolDiamond=M_,z.symbolSquare=T_,z.symbolStar=O_,z.symbolTriangle=P_,z.symbolWye=L_,z.symbols=R_,z.text=ls,z.thresholdFreedmanDiaconis=function(t,e,i){return t=X.call(t,C).sort(g),Math.ceil((i-e)/(2*(rt(t,.75)-rt(t,.25))*Math.pow(t.length,-1/3)))},z.thresholdScott=function(t,e,i){return Math.ceil((i-e)/(3.5*B(t)*Math.pow(t.length,-1/3)))},z.thresholdSturges=nt,z.tickFormat=_u,z.tickIncrement=et,z.tickStep=it,z.ticks=tt,z.timeDay=ju,z.timeDays=Hu,z.timeFormatDefaultLocale=Kg,z.timeFormatLocale=Vp,z.timeFriday=Ju,z.timeFridays=ap,z.timeHour=Bu,z.timeHours=zu,z.timeInterval=r,z.timeMillisecond=ku,z.timeMilliseconds=iu,z.timeMinute=Uu,z.timeMinutes=$u,z.timeMonday=Yu,z.timeMondays=ep,z.timeMonth=op,z.timeMonths=lp,z.timeSaturday=Qu,z.timeSaturdays=sp,z.timeSecond=Fu,z.timeSeconds=Vu,z.timeSunday=Xu,z.timeSundays=tp,z.timeThursday=Zu,z.timeThursdays=rp,z.timeTuesday=qu,z.timeTuesdays=ip,z.timeWednesday=Ku,z.timeWednesdays=np,z.timeWeek=Xu,z.timeWeeks=tp,z.timeYear=cp,z.timeYears=hp,z.timeout=Fn,z.timer=En,z.timerFlush=Nn,z.touch=ye,z.touches=function(t,e){for(var i=0,n=(e=null==e?me().touches:e)?e.length:0,r=new Array(n);i<n;++i)r[i]=_e(t,e[i]);return r},z.transition=cr,z.transpose=lt,z.tree=function(){var u=Fd,l=1,c=1,h=null;function e(t){var e,i,n,r,a,s,o=function(t){for(var e,i,n,r,a,s=[t=new $d(t,0)];e=s.pop();)if(n=e._.children)for(e.children=new Array(a=n.length),r=a-1;0<=r;--r)s.push(i=e.children[r]=new $d(n[r],r)),i.parent=e;return(t.parent=new $d(null,0)).children=[t],t}(t);return o.eachAfter(d),o.parent.m=-o.z,o.eachBefore(p),h?t.eachBefore(g):((n=i=e=t).eachBefore(function(t){t.x<e.x&&(e=t),t.x>i.x&&(i=t),t.depth>n.depth&&(n=t)}),o=e===i?1:u(e,i)/2,r=o-e.x,a=l/(i.x+o+r),s=c/(n.depth||1),t.eachBefore(function(t){t.x=(t.x+r)*a,t.y=t.depth*s})),t}function d(t){var e=t.children,i=t.parent.children,n=t.i?i[t.i-1]:null;if(e){for(var r,a=0,s=0,o=t.children,l=o.length;0<=--l;)(r=o[l]).z+=a,r.m+=a,a+=r.s+(s+=r.c);e=(e[0].z+e[e.length-1].z)/2;n?(t.z=n.z+u(t._,n._),t.m=t.z-e):t.z=e}else n&&(t.z=n.z+u(t._,n._));t.parent.A=function(t,e,i){if(e){for(var n,r=t,a=t,s=e,o=r.parent.children[0],l=r.m,c=a.m,h=s.m,d=o.m;s=Ud(s),r=Vd(r),s&&r;)o=Vd(o),(a=Ud(a)).a=t,0<(n=s.z+h-r.z-l+u(s._,r._))&&(function(t,e,i){var n=i/(e.i-t.i);e.c-=n,e.s+=i,t.c+=n,e.z+=i,e.m+=i}(function(t,e,i){return t.a.parent===e.parent?t.a:i}(s,t,i),t,n),l+=n,c+=n),h+=s.m,l+=r.m,d+=o.m,c+=a.m;s&&!Ud(a)&&(a.t=s,a.m+=h-c),r&&!Vd(o)&&(o.t=r,o.m+=l-d,i=t)}return i}(t,n,t.parent.A||i[0])}function p(t){t._.x=t.z+t.parent.m,t.m+=t.parent.m}function g(t){t.x*=l,t.y=t.depth*c}return e.separation=function(t){return arguments.length?(u=t,e):u},e.size=function(t){return arguments.length?(h=!1,l=+t[0],c=+t[1],e):h?null:[l,c]},e.nodeSize=function(t){return arguments.length?(h=!0,l=+t[0],c=+t[1],e):h?[l,c]:null},e},z.treemap=function(){var s=jd,e=!1,i=1,n=1,o=[0],l=Od,c=Od,h=Od,d=Od,u=Od;function r(t){return t.x0=t.y0=0,t.x1=i,t.y1=n,t.eachBefore(a),o=[0],e&&t.eachBefore(Dd),t}function a(t){var e=o[t.depth],i=t.x0+e,n=t.y0+e,r=t.x1-e,a=t.y1-e;r<i&&(i=r=(i+r)/2),a<n&&(n=a=(n+a)/2),t.x0=i,t.y0=n,t.x1=r,t.y1=a,t.children&&(e=o[t.depth+1]=l(t)/2,i+=u(t)-e,n+=c(t)-e,(r-=h(t)-e)<i&&(i=r=(i+r)/2),(a-=d(t)-e)<n&&(n=a=(n+a)/2),s(t,i,n,r,a))}return r.round=function(t){return arguments.length?(e=!!t,r):e},r.size=function(t){return arguments.length?(i=+t[0],n=+t[1],r):[i,n]},r.tile=function(t){return arguments.length?(s=Md(t),r):s},r.padding=function(t){return arguments.length?r.paddingInner(t).paddingOuter(t):r.paddingInner()},r.paddingInner=function(t){return arguments.length?(l="function"==typeof t?t:Gd(+t),r):l},r.paddingOuter=function(t){return arguments.length?r.paddingTop(t).paddingRight(t).paddingBottom(t).paddingLeft(t):r.paddingTop()},r.paddingTop=function(t){return arguments.length?(c="function"==typeof t?t:Gd(+t),r):c},r.paddingRight=function(t){return arguments.length?(h="function"==typeof t?t:Gd(+t),r):h},r.paddingBottom=function(t){return arguments.length?(d="function"==typeof t?t:Gd(+t),r):d},r.paddingLeft=function(t){return arguments.length?(u="function"==typeof t?t:Gd(+t),r):u},r},z.treemapBinary=function(t,e,i,n,r){var a,s,f=t.children,o=f.length,m=new Array(o+1);for(m[0]=s=a=0;a<o;++a)m[a+1]=s+=f[a].value;!function t(e,i,n,r,a,s,o){if(i-1<=e)return(l=f[e]).x0=r,l.y0=a,l.x1=s,void(l.y1=o);var l=m[e],c=n/2+l,h=e+1,d=i-1;for(;h<d;){var u=h+d>>>1;m[u]<c?h=1+u:d=u}c-m[h-1]<m[h]-c&&e+1<h&&--h;var l=m[h]-l,p=n-l;{var g;o-a<s-r?(t(e,h,l,r,a,g=(r*p+s*l)/n,o),t(h,i,p,g,a,s,o)):(t(e,h,l,r,a,s,g=(a*p+o*l)/n),t(h,i,p,r,g,s,o))}}(0,o,t.value,e,i,n,r)},z.treemapDice=Ed,z.treemapResquarify=e,z.treemapSlice=Bd,z.treemapSliceDice=function(t,e,i,n,r){(1&t.depth?Bd:Ed)(t,e,i,n,r)},z.treemapSquarify=jd,z.tsv=ds,z.tsvFormat=ts,z.tsvFormatBody=es,z.tsvFormatRow=ns,z.tsvFormatRows=is,z.tsvFormatValue=Za,z.tsvParse=Ja,z.tsvParseRows=Qa,z.utcDay=fp,z.utcDays=mp,z.utcFriday=wp,z.utcFridays=Ap,z.utcHour=pp,z.utcHours=gp,z.utcMillisecond=ku,z.utcMilliseconds=iu,z.utcMinute=dp,z.utcMinutes=up,z.utcMonday=yp,z.utcMondays=Op,z.utcMonth=Dp,z.utcMonths=Ep,z.utcSaturday=Sp,z.utcSaturdays=Pp,z.utcSecond=Fu,z.utcSeconds=Vu,z.utcSunday=vp,z.utcSundays=Mp,z.utcThursday=xp,z.utcThursdays=Tp,z.utcTuesday=bp,z.utcTuesdays=Gp,z.utcWednesday=Cp,z.utcWednesdays=Ip,z.utcWeek=vp,z.utcWeeks=Mp,z.utcYear=Np,z.utcYears=Lp,z.values=function(t){var e,i=[];for(e in t)i.push(t[e]);return i},z.variance=w,z.version="5.16.0",z.voronoi=function(){var r=wv,a=Sv,e=null;function i(n){return new Jv(n.map(function(t,e){var i=[Math.round(r(t,e,n)/$)*$,Math.round(a(t,e,n)/$)*$];return i.index=e,i.data=t,i}),e)}return i.polygons=function(t){return i(t).polygons()},i.links=function(t){return i(t).links()},i.triangles=function(t){return i(t).triangles()},i.x=function(t){return arguments.length?(r="function"==typeof t?t:xv(+t),i):r},i.y=function(t){return arguments.length?(a="function"==typeof t?t:xv(+t),i):a},i.extent=function(t){return arguments.length?(e=null==t?null:[[+t[0][0],+t[0][1]],[+t[1][0],+t[1][1]]],i):e&&[[e[0][0],e[0][1]],[e[1][0],e[1][1]]]},i.size=function(t){return arguments.length?(e=null==t?null:[[0,0],[+t[0],+t[1]]],i):e&&[e[1][0]-e[0][0],e[1][1]-e[0][1]]},i},z.window=Bt,z.xml=gs,z.zip=function(){return lt(arguments)},z.zoom=function(){var u,s,o=s0,c=o0,p=d0,r=c0,e=h0,a=[0,1/0],g=[[-1/0,-1/0],[1/0,1/0]],l=250,h=dn,i=St("start","zoom","end"),d=500,f=150,m=0;function _(t){t.property("__zoom",l0).on("wheel.zoom",w).on("mousedown.zoom",S).on("dblclick.zoom",M).filter(e).on("touchstart.zoom",O).on("touchmove.zoom",G).on("touchend.zoom touchcancel.zoom",I).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function v(t,e){return(e=Math.max(a[0],Math.min(a[1],e)))===t.k?t:new e0(e,t.x,t.y)}function y(t,e,i){var n=e[0]-i[0]*t.k,e=e[1]-i[1]*t.k;return n===t.x&&e===t.y?t:new e0(t.k,n,e)}function b(t){return[(+t[0][0]+ +t[1][0])/2,(+t[0][1]+ +t[1][1])/2]}function C(t,i,l){t.on("start.zoom",function(){x(this,arguments).start()}).on("interrupt.zoom end.zoom",function(){x(this,arguments).end()}).tween("zoom",function(){var t=arguments,n=x(this,t),e=c.apply(this,t),r=null==l?b(e):"function"==typeof l?l.apply(this,t):l,a=Math.max(e[1][0]-e[0][0],e[1][1]-e[0][1]),e=this.__zoom,s="function"==typeof i?i.apply(this,t):i,o=h(e.invert(r).concat(a/e.k),s.invert(r).concat(a/s.k));return function(t){var e,i;t=1===t?s:(e=o(t),new e0(i=a/e[2],r[0]-e[0]*i,r[1]-e[1]*i)),n.zoom(null,t)}})}function x(t,e,i){return!i&&t.__zooming||new n(t,e)}function n(t,e){this.that=t,this.args=e,this.active=0,this.extent=c.apply(t,e),this.taps=0}function w(){if(o.apply(this,arguments)){var t=x(this,arguments),e=this.__zoom,i=Math.max(a[0],Math.min(a[1],e.k*Math.pow(2,r.apply(this,arguments)))),n=ve(this);if(t.wheel)t.mouse[0][0]===n[0]&&t.mouse[0][1]===n[1]||(t.mouse[1]=e.invert(t.mouse[0]=n)),clearTimeout(t.wheel);else{if(e.k===i)return;t.mouse=[n,e.invert(n)],Jn(this),t.start()}a0(),t.wheel=setTimeout(function(){t.wheel=null,t.end()},f),t.zoom("mouse",p(y(v(e,i),t.mouse[0],t.mouse[1]),t.extent,g))}}function S(){var i,t,e,n,r;!s&&o.apply(this,arguments)&&(i=x(this,arguments,!0),t=ue(z.event.view).on("mousemove.zoom",function(){{var t,e;a0(),i.moved||(t=z.event.clientX-n,e=z.event.clientY-r,i.moved=m<t*t+e*e)}i.zoom("mouse",p(y(i.that.__zoom,i.mouse[0]=ve(i.that),i.mouse[1]),i.extent,g))},!0).on("mouseup.zoom",function(){t.on("mousemove.zoom mouseup.zoom",null),we(z.event.view,i.moved),a0(),i.end()},!0),e=ve(this),n=z.event.clientX,r=z.event.clientY,xe(z.event.view),r0(),i.mouse=[e,this.__zoom.invert(e)],Jn(this),i.start())}function M(){var t,e,i,n;o.apply(this,arguments)&&(n=this.__zoom,t=ve(this),e=n.invert(t),i=n.k*(z.event.shiftKey?.5:2),n=p(y(v(n,i),t,e),c.apply(this,arguments),g),a0(),0<l?ue(this).transition().duration(l).call(C,n,t):ue(this).call(_.transform,n))}function O(){if(o.apply(this,arguments)){var t,e,i,n,r=z.event.touches,a=r.length,s=x(this,arguments,z.event.changedTouches.length===a);for(r0(),e=0;e<a;++e)n=[n=ye(this,r,(i=r[e]).identifier),this.__zoom.invert(n),i.identifier],s.touch0?s.touch1||s.touch0[2]===n[2]||(s.touch1=n,s.taps=0):(s.touch0=n,t=!0,s.taps=1+!!u);u=u&&clearTimeout(u),t&&(s.taps<2&&(u=setTimeout(function(){u=null},d)),Jn(this),s.start())}}function G(){if(this.__zooming){var t,e=x(this,arguments),i=z.event.changedTouches,n=i.length;for(a0(),u=u&&clearTimeout(u),t=e.taps=0;t<n;++t)d=ye(this,i,(h=i[t]).identifier),e.touch0&&e.touch0[2]===h.identifier?e.touch0[0]=d:e.touch1&&e.touch1[2]===h.identifier&&(e.touch1[0]=d);if(h=e.that.__zoom,e.touch1)var r=e.touch0[0],a=e.touch0[1],s=e.touch1[0],o=e.touch1[1],l=(l=s[0]-r[0])*l+(l=s[1]-r[1])*l,c=(c=o[0]-a[0])*c+(c=o[1]-a[1])*c,h=v(h,Math.sqrt(l/c)),d=[(r[0]+s[0])/2,(r[1]+s[1])/2],l=[(a[0]+o[0])/2,(a[1]+o[1])/2];else{if(!e.touch0)return;d=e.touch0[0],l=e.touch0[1]}e.zoom("touch",p(y(h,d,l),e.extent,g))}}function I(){if(this.__zooming){var t,e,i,n=x(this,arguments),r=z.event.changedTouches,a=r.length;for(r0(),s&&clearTimeout(s),s=setTimeout(function(){s=null},d),t=0;t<a;++t)e=r[t],n.touch0&&n.touch0[2]===e.identifier?delete n.touch0:n.touch1&&n.touch1[2]===e.identifier&&delete n.touch1;n.touch1&&!n.touch0&&(n.touch0=n.touch1,delete n.touch1),n.touch0?n.touch0[1]=this.__zoom.invert(n.touch0[0]):(n.end(),2===n.taps&&(i=ue(this).on("dblclick.zoom"))&&i.apply(this,arguments))}}return _.transform=function(t,e,i){var n=t.selection?t.selection():t;n.property("__zoom",l0),t!==n?C(t,e,i):n.interrupt().each(function(){x(this,arguments).start().zoom(null,"function"==typeof e?e.apply(this,arguments):e).end()})},_.scaleBy=function(t,e,i){_.scaleTo(t,function(){return this.__zoom.k*("function"==typeof e?e.apply(this,arguments):e)},i)},_.scaleTo=function(t,a,s){_.transform(t,function(){var t=c.apply(this,arguments),e=this.__zoom,i=null==s?b(t):"function"==typeof s?s.apply(this,arguments):s,n=e.invert(i),r="function"==typeof a?a.apply(this,arguments):a;return p(y(v(e,r),i,n),t,g)},s)},_.translateBy=function(t,e,i){_.transform(t,function(){return p(this.__zoom.translate("function"==typeof e?e.apply(this,arguments):e,"function"==typeof i?i.apply(this,arguments):i),c.apply(this,arguments),g)})},_.translateTo=function(t,n,r,a){_.transform(t,function(){var t=c.apply(this,arguments),e=this.__zoom,i=null==a?b(t):"function"==typeof a?a.apply(this,arguments):a;return p(i0.translate(i[0],i[1]).scale(e.k).translate("function"==typeof n?-n.apply(this,arguments):-n,"function"==typeof r?-r.apply(this,arguments):-r),t,g)},a)},n.prototype={start:function(){return 1==++this.active&&(this.that.__zooming=this).emit("start"),this},zoom:function(t,e){return this.mouse&&"mouse"!==t&&(this.mouse[1]=e.invert(this.mouse[0])),this.touch0&&"touch"!==t&&(this.touch0[1]=e.invert(this.touch0[0])),this.touch1&&"touch"!==t&&(this.touch1[1]=e.invert(this.touch1[0])),this.that.__zoom=e,this.emit("zoom"),this},end:function(){return 0==--this.active&&(delete this.that.__zooming,this.emit("end")),this},emit:function(t){le(new t0(_,t,this.that.__zoom),i.apply,i,[t,this.that,this.args])}},_.wheelDelta=function(t){return arguments.length?(r="function"==typeof t?t:Qv(+t),_):r},_.filter=function(t){return arguments.length?(o="function"==typeof t?t:Qv(!!t),_):o},_.touchable=function(t){return arguments.length?(e="function"==typeof t?t:Qv(!!t),_):e},_.extent=function(t){return arguments.length?(c="function"==typeof t?t:Qv([[+t[0][0],+t[0][1]],[+t[1][0],+t[1][1]]]),_):c},_.scaleExtent=function(t){return arguments.length?(a[0]=+t[0],a[1]=+t[1],_):[a[0],a[1]]},_.translateExtent=function(t){return arguments.length?(g[0][0]=+t[0][0],g[1][0]=+t[1][0],g[0][1]=+t[0][1],g[1][1]=+t[1][1],_):[[g[0][0],g[0][1]],[g[1][0],g[1][1]]]},_.constrain=function(t){return arguments.length?(p=t,_):p},_.duration=function(t){return arguments.length?(l=+t,_):l},_.interpolate=function(t){return arguments.length?(h=t,_):h},_.on=function(){var t=i.on.apply(i,arguments);return t===i?_:t},_.clickDistance=function(t){return arguments.length?(m=(t=+t)*t,_):Math.sqrt(m)},_},z.zoomIdentity=i0,z.zoomTransform=n0,Object.defineProperty(z,"__esModule",{value:!0})}),function(t,e){"objectXX"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-array")):"function"==typeof define&&define.amdXX?define(["exports","d3-array"],e):e(t.d3=t.d3||{},t.d3)}(this,function(t,g){"use strict";t.tile=function(){function e(){var t=Math.max(Math.log(u)/Math.LN2-8,0),i=Math.round(t+p),t=Math.pow(2,t-i+8),e=h-u/2,n=d-u/2,r=[],a=g.range(Math.max(0,Math.floor((s-e)/t)),Math.max(0,Math.ceil((l-e)/t)));return g.range(Math.max(0,Math.floor((o-n)/t)),Math.max(0,Math.ceil((c-n)/t))).forEach(function(e){a.forEach(function(t){r.push([t,e,i])})}),r.translate=[e/t,n/t],r.scale=t,r}var s=0,o=0,l=960,c=500,h=(s+l)/2,d=(o+c)/2,u=256,p=0;return e.size=function(t){return arguments.length?(s=o=0,l=+t[0],c=+t[1],e):[l,c]},e.extent=function(t){return arguments.length?(s=+t[0][0],o=+t[0][1],l=+t[1][0],c=+t[1][1],e):[[s,o],[l,c]]},e.scale=function(t){return arguments.length?(u=+t,e):u},e.translate=function(t){return arguments.length?(h=+t[0],d=+t[1],e):[h,d]},e.zoomDelta=function(t){return arguments.length?(p=+t,e):p},e},Object.defineProperty(t,"__esModule",{value:!0})}),function(t){var e;"objectXX"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amdXX?define([],t):(e=(e=(e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).d3||(e.d3={})).layout||(e.layout={})).cloud=t()}(function(){return function n(r,a,s){function o(i,t){if(!a[i]){if(!r[i]){var e="function"==typeof require&&require;if(!t&&e)return e(i,!0);if(l)return l(i,!0);t=new Error("Cannot find module '"+i+"'");throw t.code="MODULE_NOT_FOUND",t}e=a[i]={exports:{}};r[i][0].call(e.exports,function(t){var e=r[i][1][t];return o(e||t)},e,e.exports,n,r,a,s)}return a[i].exports}for(var l="function"==typeof require&&require,t=0;t<s.length;t++)o(s[t]);return o}({1:[function(t,e,i){var O=Math.PI/180,G=64,I=2048;function a(t){return t.text}function s(){return"serif"}function o(){return"normal"}function l(t){return Math.sqrt(t.value)}function c(){return 30*(~~(6*Math.random())-3)}function h(){return 1}function d(t){var e=t[0]/t[1];return function(t){return[e*(t*=.1)*Math.cos(t),t*Math.sin(t)]}}function T(){return document.createElement("canvas")}function A(t){return"function"==typeof t?t:function(){return t}}e.exports=function(){var x=[256,256],n=a,r=s,u=l,p=o,g=o,f=c,m=h,w=d,_=[],v=1/0,y=d3.dispatch("word","end"),b=null,S=Math.random,C={},M=T;return C.canvas=function(t){return arguments.length?(M=A(t),C):M},C.start=function(){(t=M()).width=t.height=1,e=Math.sqrt(t.getContext("2d").getImageData(0,0,1,1).data.length>>2),t.width=(G<<5)/e,t.height=I/e,(t=t.getContext("2d")).fillStyle=t.strokeStyle="red",t.textAlign="center";var t,e,a={context:t,ratio:e},s=function(t){var e=[],i=-1;for(;++i<t;)e[i]=0;return e}((x[0]>>5)*x[1]),o=null,l=_.length,c=-1,h=[],d=_.map(function(t,e){return t.text=n.call(this,t,e),t.font=r.call(this,t,e),t.style=p.call(this,t,e),t.weight=g.call(this,t,e),t.rotate=f.call(this,t,e),t.size=~~u.call(this,t,e),t.padding=m.call(this,t,e),t}).sort(function(t,e){return e.size-t.size});return b&&clearInterval(b),b=setInterval(i,0),i(),C;function i(){for(var t=Date.now();Date.now()-t<v&&++c<l&&b;){var e=d[c];if(e.x=x[0]*(S()+.5)>>1,e.y=x[1]*(S()+.5)>>1,!function(t,e,i,n){if(!e.sprite){var r=t.context,a=t.ratio,s=(r.clearRect(0,0,(G<<5)/a,I/a),0),o=0,l=0,c=i.length;for(--n;++n<c;){e=i[n],r.save(),r.font=e.style+" "+e.weight+" "+~~((e.size+1)/a)+"px "+e.font;var h,d,u,p,g=r.measureText(e.text+"m").width*a,f=e.size<<1;if(e.rotate?(p=Math.sin(e.rotate*O),u=Math.cos(e.rotate*O),h=g*u,d=g*p,u=f*u,p=f*p,g=Math.max(Math.abs(h+p),Math.abs(h-p))+31>>5<<5,f=~~Math.max(Math.abs(d+u),Math.abs(d-u))):g=g+31>>5<<5,l<f&&(l=f),G<<5<=s+g&&(o+=l,l=s=0),I<=o+f)break;r.translate((s+(g>>1))/a,(o+(f>>1))/a),e.rotate&&r.rotate(e.rotate*O),r.fillText(e.text,0,0),e.padding&&(r.lineWidth=2*e.padding,r.strokeText(e.text,0,0)),r.restore(),e.width=g,e.height=f,e.xoff=s,e.yoff=o,e.x1=g>>1,e.y1=f>>1,e.x0=-e.x1,e.y0=-e.y1,e.hasText=!0,s+=g}for(var m=r.getImageData(0,0,(G<<5)/a,I/a).data,_=[];0<=--n;)if((e=i[n]).hasText){for(var v=(g=e.width)>>5,f=e.y1-e.y0,y=0;y<f*v;y++)_[y]=0;if(null==(s=e.xoff))return;o=e.yoff;for(var b=0,C=-1,x=0;x<f;x++){for(y=0;y<g;y++){var w=v*x+(y>>5),S=m[(o+x)*(G<<5)+(s+y)<<2]?1<<31-y%32:0;_[w]|=S,b|=S}b?C=x:(e.y0++,f--,x--,o++)}e.y1=e.y0+C,e.sprite=_.slice(0,(e.y1-e.y0)*v)}}}(a,e,d,c),e.hasText&&function(t,e,i){x[0],x[1];var n,r,a=e.x,s=e.y,o=Math.sqrt(x[0]*x[0]+x[1]*x[1]),l=w(x),c=S()<.5?1:-1,h=-c;for(;(f=l(h+=c))&&(n=~~f[0],r=~~f[1],!(Math.min(Math.abs(n),Math.abs(r))>=o));)if(e.x=a+n,e.y=s+r,!(e.x+e.x0<0||e.y+e.y0<0||e.x+e.x1>x[0]||e.y+e.y1>x[1])&&(!i||!function(t,e,i){i>>=5;for(var n,r=t.sprite,a=t.width>>5,s=t.x-(a<<4),o=127&s,l=32-o,c=t.y1-t.y0,h=(t.y+t.y0)*i+(s>>5),d=0;d<c;d++){for(var u=n=0;u<=a;u++)if((n<<l|(u<a?(n=r[d*a+u])>>>o:0))&e[h+u])return 1;h+=i}return}(e,t,x[0]))&&(!i||function(t,e){return t.x+t.x1>e[0].x&&t.x+t.x0<e[1].x&&t.y+t.y1>e[0].y&&t.y+t.y0<e[1].y}(e,i))){for(var d,u=e.sprite,p=e.width>>5,g=x[0]>>5,f=e.x-(p<<4),m=127&f,_=32-m,v=e.y1-e.y0,y=(e.y+e.y0)*g+(f>>5),b=0;b<v;b++){for(var C=d=0;C<=p;C++)t[y+C]|=d<<_|(C<p?(d=u[b*p+C])>>>m:0);y+=g}return delete e.sprite,1}return}(s,e,o)){if(h.push(e),y.call("word",C,e),o){r=n=i=r=void 0;var i=e,n=(r=o)[0],r=r[1];i.x+i.x0<n.x&&(n.x=i.x+i.x0),i.y+i.y0<n.y&&(n.y=i.y+i.y0),i.x+i.x1>r.x&&(r.x=i.x+i.x1),i.y+i.y1>r.y&&(r.y=i.y+i.y1)}else o=[{x:e.x+e.x0,y:e.y+e.y0},{x:e.x+e.x1,y:e.y+e.y1}];e.x-=x[0]>>1,e.y-=x[1]>>1}}l<=c&&(C.stop(),y.call("end",C,h,o))}},C.stop=function(){return b&&(clearInterval(b),b=null),C},C.timeInterval=function(t){return arguments.length?(v=null==t?1/0:t,C):v},C.words=function(t){return arguments.length?(_=t,C):_},C.size=function(t){return arguments.length?(x=[+t[0],+t[1]],C):x},C.font=function(t){return arguments.length?(r=A(t),C):r},C.fontStyle=function(t){return arguments.length?(p=A(t),C):p},C.fontWeight=function(t){return arguments.length?(g=A(t),C):g},C.rotate=function(t){return arguments.length?(f=A(t),C):f},C.text=function(t){return arguments.length?(n=A(t),C):n},C.spiral=function(t){return arguments.length?(w=P[t]||t,C):w},C.fontSize=function(t){return arguments.length?(u=A(t),C):u},C.padding=function(t){return arguments.length?(m=A(t),C):m},C.random=function(t){return arguments.length?(S=t,C):S},C.on=function(){var t=y.on.apply(y,arguments);return t===y?C:t},C};var P={archimedean:d,rectangular:function(t){var i=4*t[0]/t[1],n=0,r=0;return function(t){var e=t<0?-1:1;switch(Math.sqrt(1+4*e*t)-e&3){case 0:n+=i;break;case 1:r+=4;break;case 2:n-=i;break;default:r-=4}return[n,r]}}}},{}]},{},[1])(1)}),GCO5.view.component.D3ChartContainer=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.D3ChartContainer",PIE_DIAMETER:190,MAX_NBROWS_BY_PAGE:40},_id:null,_chart:null,_animating:null,map:null,_compChart:null,_d3ChartContainer:null,_$blocContainer:null,_options:null,_def_o:null,_lastType:null,_lastxScaleType:null,_svg:null,_xScale:null,_x2Scale:null,_yScale:null,_yScale2:null,_yZero:null,_xZero:null,_xRef:null,_yRef:null,_g:null,_gScale:null,_gScale2:null,_emptyData:[[]],_extents:null,tickLabelGap:3,_metrics0:{axisPaddingTop:0,axisPaddingRight:0,axisPaddingBottom:0,axisPaddingLeft:0,outerXPadding:null,paddingTop:0,paddingRight:0,paddingBottom:0,paddingLeft:0,paddingCenter:0,pieRadius:0,labelsAxisYWidth:0,labelsAxisXHeight:0,label1AxisYHeight:0,labelAxisXSumLength:0,axisXmax:null,axisYmax:null,label1AxisXLeftPadding:0,label2AxisXRightPadding:0,containerPadding:0,legendWidth:0,legendHeight:0,legendTopPadding:10,legendLeftPadding:20,timeSliderWidth:0,timeSliderHeight:0},_defaults:{mouseover:function(t,e){},mouseout:function(t,e){},click:function(t,e){},tooltip:function(t,e){},chartOuterHeight:function(){return this.get$ChartContainer().innerHeight()},chartOuterWidth:function(){return this.get$ChartContainer().innerWidth()},tickHintX:function(t){var e=this._chart.getType();if("distrib"==e)return 0;if(this._hasNumericXAxis()&&0==e.indexOf("barh")&&this._extents.x){if(this.get$ChartContainer().innerWidth()<400)return 5;if(0==this._extents.x[0]&&this._extents.x[1]==parseInt(this._extents.x[1],10))return Math.min(this._extents.x[1],8)}return 8},tickHintY:function(t){var e=this._chart.getType();return"distrib"==e?0:this._hasNumericYAxis()&&(0==e.indexOf("line")||0==e.indexOf("barv"))&&this._extents.y&&0==this._extents.y[0]&&this._extents.y[1]==parseInt(this._extents.y[1],10)?Math.min(this._extents.y[1],8):8},tickSize0:5,legendPosition:"bottom",align:"center",xMin:null,xMax:null,yMin:null,yMax:null,fullHTML:!1,timing:$("body").hasClass("pre-print")?0:750,interpolation:d3.curveMonotoneX,isSynth:!1},_defaultSpacing:.25,_layoutAdjusted:null,gclg:null,initialize:function(t,e,i){var n;this._metrics=GCO5.core.GcObjectUtil.clone(this._metrics0),!e||e.seriesData&&e.seriesData[0].data&&0==e.seriesData[0].data.length?console.error("erreur : pas de données",t,e,i):(i=i||{},this.gclg=GCO5.core.GcLangManager.getInstance(),this._$blocContainer=t,n=this._$blocContainer.find(".xchart-container"),this._d3ChartContainer=i.fullHTML?null:d3.select(n.get(0)),this._$blocContainer||this._d3ChartContainer?(this._$blocContainer.is(":visible"),GCO5.browser.isKitchen&&this._$blocContainer.empty(),GCO5.core.GcDelayUtil.callLater(this.update,[e,i],"SPINE"==e.type?0:1,this)):console.error("erreur : pas de container"))},setSpineChart:function(t){this._options.spineChart=t},update:function(r,t){this._options=GCO5.core.GcObjectUtil.defaults(t||{},this._defaults),this._def_o=r;var e,i=this._$blocContainer,n=(this.buildDomStructure(!0),$(".maplegendH",i));if(n.empty().hide(),$(".xchart-container",i).hide(),$(".report-table",i).hide(),$(".report-text",i).hide(),$(".report-map",i).hide(),$(".filter-axis",i).hide(),$(".report-block-iframe",i).hide(),"SPINE"==r.type)$(".spineChart",i).show(),$("h2",i).show().text(GCO5.core.GcStringUtil.proper(this.gclg.getString("TERRITORY","concepts"))+this.gclg.getString("P2B")+" "+r.libsel),$(".key",i).addClass("italic").show().text(this.gclg.getString("FILTER_SPINE_HINT","report")),i.css("height","auto").css("max-width","80em");else if("TXT"==r.type)e=$(".report-text",i),r.text||(r.text=""),r.htmlString=r.text.split("size=").join("sizex=").split("\n").join("<br>"),""!=r.htmlString?e.empty().append(r.htmlString).show().css("display","block"):i.closest("div").addClass("header-only");else if("SPC"==r.type)this._genHTMLTable(r),(a=$(".report-table",i)).empty().append(r.htmlString).show();else if("TA"==r.type.substr(0,2)){this._genHTMLTable(r),r.subsetType&&"serie"==r.subsetType&&this._addSerieGroup(r.filterMods,r.subsetKey,!1,r.fullBlocInfo,r.datavizModel),r.subsetType&&"filter1"==r.subsetType&&this._addFilter1Group(r.filterMods,r.fullBlocInfo,r.datavizModel);var a=$(".report-table",i),s=i.closest(".row.dataviz"),o=this.constructor.MAX_NBROWS_BY_PAGE;if((GCO5.browser.isFirefox||GCO5.browser.isIE)&&"LIST_ALL_UNITS"==r.struct){for(var l,c=s.parent(),h=s.first(),d=(h.addClass("no-print").removeClass("visible-pr"),a.empty().append(r.htmlString).show(),$("[duplistfor='"+h.attr("id")+"']",c).remove(),h.is(":first-child")),u=h.clone(),p=(u.removeClass("no-print").addClass("print-only visible-pr"),$("[data-menu]",u).remove(),$(".grille",u).remove(),u.attr("duplistfor",h.attr("id")),Math.ceil(r.v_a.length/o)),g=r.v_a.concat(),f=0;f<p;f++){(l=u.clone()).insertBefore(h),l.attr("id",l.attr("id")+"_"+f),$(".dataviz-container",l).addClass("duplistgeo"),0<f&&$("h2",l).text($("h2",l).text()+" (suite)"),!d&&5<g.length?l.css("page-break-before","always"):l.css("page-break-before","auto"),l.css("page-break-inside","avoid"),$(".dataviz-container",l).css("page-break-inside","avoid"),r.v_a=g.slice(f*o,(f+1)*o-1);var m=$.render.pageReportListTable(r);$(".report-table",l).empty().append(m)}r.v_a=g,$("header [data-menu] a",i).on("click keydown",this.onClickMenuIcon.bind(this)),$(document).trigger("enhance"),$(".report-table",c).show(),r.subsetType&&"serie"==r.subsetType&&this._addSerieGroup(r.filterMods,r.subsetKey,!1,r.fullBlocInfo,r.datavizModel)}else a.empty().append(r.htmlString);e=$(".ui-table-reflow",i),$(e).off("click").on("click","a",function(t){if($("body").hasClass("pre-print"))return!1;var e={},i=$(this).data("pk").split("."),n=$(this).data("view");e.c_id_indicateur=i[1],e.c_id_dataset=i[0],r.subsetType&&"serie"==r.subsetType&&(e.serie=r.subsetKey),r.subsetType&&"filter1"==r.subsetType?e.f1code=r.subsetKey:$(this).data("f1code")&&(e.f1code=$(this).data("f1code")),$(GCO5.topApp).triggerHandler(GCO5.view.component.AComponent.LOAD_COMPONENT,{id:"indicator",categ:"main",indicModel:new GCO5.model.indics.IndicModel(e),mapName:n})}),e.parent().show()}else"MAP"==r.type?((s=$(".report-map",i)).show(),GCO5.browser.isKitchen?(c=Math.round(Math.min(s.width(),400)),s.height(355*c/400),s.css("min-height",355*c/400+"px"),a=$("<img width='"+c+"' src='../GC_make_map.php?lang="+this.gclg.getLang()+"&cosmetics=0&width="+c+"&indics="+r.indic+"'>"),s.empty().append(a)):(s.height(400),s.css("min-height","400px"),n.show(),r.rovContainer=$("body"),this.setupMap(r,s,{divH:n}))):($(".xchart-container",i).show(),this.loadData(t));return r.type},_genHTMLTable:function(t){return"nodata"==t.err?t.htmlString=this.gclg.getString("NODATA"):("TAC"==t.type?t.htmlString=$.render.pageReportTacTable(t):"LIST_ALL_UNITS"==t.struct?t.htmlString=$.render.pageReportListTable(t):"SERIE"==t.struct&&"TAB"==t.type&&1<t.fullBlocInfo.blocvar_a.length?t.htmlString=$.render.pageReportSerieTable(t):"LIST_FILTER1"==t.struct?t.htmlString=$.render.pageReportFilter1Table(t):t.htmlString=$.render.pageReportSynthTable(t),$(".source",this.get$BlocContainer()).html(t.source?this.gclg.getString("SOURCE","indics")+this.gclg.getString("P2B")+" "+t.source:"")),t},setupMap:function(t,e,i){t.mapContainer=e,t.styles.width=e.width(),t.styles.height=Math.max(e.height(),400),t.styles.height=Math.min(t.styles.width,t.styles.height),t.styles.containerPosition="variable",t.legendContainer=i,t.styles.inReport=!0,this.map&&this.map.destroy(),t.mapContainer.empty(),this.map=new GCO5.view.component.MapViewThematic(t)},loadData:function(t){for(var e=this._def_o.seriesData,i=e.length,n=0;n<i;n++){var r=e[n];this._def_o.subsetKey&&r.data[this._def_o.subsetKey]?(r.chartData=r.data[this._def_o.subsetKey],r.datab100&&(r.chartDatab100=r.datab100[this._def_o.subsetKey])):(r.chartData=r.data,r.datab100&&(r.chartDatab100=r.datab100))}this._updateChart(t)},_hasNumericXAxis:function(){var t=this.getChartType();return"barh"==t||"pyr"==t||"distrib"==t},_hasNumericYAxis:function(){var t=this.getChartType();return"barv"==t||"lin"==t.substr(0,3)||"distrib"==t},getD3ChartContainer:function(){return this._d3ChartContainer},get$ChartContainer:function(){return this._d3ChartContainer?$(this._d3ChartContainer.node()):null},get$BlocContainer:function(){return this._$blocContainer},_updateChart:function(t){var s=this._def_o,e=this._options,o=this,i=s.seriesData[0].nbdec||0,l=(t&&t.hasOwnProperty("tickFormatX")||(this._hasNumericXAxis()?e.tickFormatX=function(t){return o.gclg.formatNumber(t,Math.abs(t)<10&&0!=t?i:0,!0)}:e.tickFormatX=function(t){return t}),this.get$ChartContainer()),c=$(".chart-tooltip",l),h=$(".chart-tooltip-container",c);switch(e.mouseover=function(){if(!GCO5.browser.isKitchen){c.show();var t=d3.select(d3.event.target),e=t.datum(),i=s.tooltip.call(d3.event.target,e),n="<table>";GCO5.browser.isIE?n+="<tr> <th class='red' style='font-weight:400'>"+i.caption+"</td> </tr>":n+="<caption>"+i.caption+"</caption>";for(var r,a=0;a<i.row_a.length;a++)n+="<tr> <th class='wsnow'>"+i.row_a[a].th+"</th> <td class='wsnow'>"+i.row_a[a].td+"</td> </tr>";h.html(n+="</table>"),t.attr("fill")&&!o._animating&&(e.colfill=t.attr("fill"),r=GCO5.core.GcMathUtil.adjustBrightness2(e.colfill,30),t.attr("fill",GCO5.core.GcMathUtil.binToHex(r))),t.attr("stroke")||(t.attr("stroke",e.colfill||"white"),t.attr("stroke-width","2"),e.strokenull=!0)}},e.mouseout=function(){var t,e;GCO5.browser.isKitchen||(c.hide(),e=(t=d3.select(d3.event.target)).datum(),t.attr("fill")&&!o._animating&&void 0!==e.colfill&&t.attr("fill",e.colfill),e.strokenull&&(t.attr("stroke",""),t.attr("stroke-width",""),e.strokenull=!1))},e.mousemove=function(){var t,e,i,n,r,a;GCO5.browser.isKitchen||(c.show(),t=(r=d3.mouse(d3.select("body").node()))[0],e=r[1],i=(n=l.offset()).top,n=n.left,i="auto"==i?0:parseFloat(i),n="auto"==n?0:parseFloat(n),c.css({top:"0px",left:"0px","z-index":100}),r=Math.min(0,GCO5.browser.width-r[0]-c.width()/2-20),2<(a=n-t+c.width()/2)&&(r=a),a=0<l.closest(".report-viewport").length&&l.closest(".report-viewport").offset().top>e-c.height()-30,c.css({top:(a?e-i+30:e-i-c.height()-30)+"px",left:t-n-c.width()/2+r+"px"}),a?h.removeClass("arrowbottom"):h.addClass("arrowbottom"))},t&&(t.hasOwnProperty("tickFormatY")||this._hasNumericXAxis())||(e.tickFormatY=function(t){return o.gclg.formatNumber(t,i,!0)}),s.type){case"barv":case"pie":case"pie2":case"line-dotted":case"line":s.xScaleType="ordinal",s.yScaleType=s.yScaleType||"linear";break;case"distrib":s.xScaleType="linear",s.yScaleType="linear";break;case"barh":s.xScaleType=s.xScaleType||"linear",s.yScaleType="ordinal";break;case"pyr":s.xScaleType=s.xScaleType||"linear",s.x2ScaleType=s.x2ScaleType||"linear",s.yScaleType="ordinal"}this._chart=this._getChartByType(s.type),this._draw(t)},_getChartByType:function(t){var e;if(this._chart&&this._chart.getType()==t)return this._chart;switch(t){case"barv":e=new GCO5.view.component.BarVChart(this);break;case"barh":e=new GCO5.view.component.BarHChart(this);break;case"line":e=new GCO5.view.component.LineChart(this);break;case"distrib":e=new GCO5.view.component.DistribChart(this);break;case"line-dotted":e=new GCO5.view.component.LineDottedChart(this);break;case"pie":e=new GCO5.view.component.PieChart(this);break;case"pie2":e=new GCO5.view.component.Pie2Chart(this);break;case"pyr":e=new GCO5.view.component.PyrChart(this)}return e},setType:function(t,e){this.getChartType()&&this.getChartType()},_draw:function(t){this._chart&&(this._updateScales(t),this._chart.addLegend(),this._computeAxesMetrics(),this.buildDomStructure(),this._updateScales(t),this._drawAxes(),this._chart.enter(".main"),this._chart.exit(),this._chart.update())},_updateScales:function(t){var e,i=this,n=i.getSeriesData();"pie"!=this.getChartType().substr(0,3)&&n?(n=GCO5.core.GcArrayUtil.getDistinctValues(d3.merge([n.filter(function(t){return t.enabled}),i.getCompData()||[]])),this._xScale=null,this._x2Scale=null,this._yScale=null,this._yZero=null,this._xZero=null,this._yRef=null,this._xRef=null,i=this._getAxes(n,t),this._xScale=i.x,i.x2&&(this._x2Scale=i.x2),this._yScale=i.y,"ordinal"!=this._getYScaleType()&&(e=this._yScale.domain()[0],this._yZero=0<e?this._yScale(e):this._yScale(0)),"ordinal"!=this._getXScaleType()&&(e=this._xScale.domain()[0],this._xZero=0<e?this._xScale(e):this._xScale(0)),this._def_o.hasOwnProperty("yrefVal")&&(this._yRef=this._yScale(this._def_o.yrefVal)),this._chart.postUpdateScale(n)):this._removeTicks()},_addFilter1Group:function(t,i,n){var r,a,e,s;!t||1==t.length||n&&n.getDashboardData().globalFilter1||(r=this.get$BlocContainer(),$(".filter-axis",r).show(),a=this,t=t.concat(),(e=d3.select($(".filter-axis",r).get(0))).selectAll("div.filterGroup").data([[]]).enter().append("div").attr("cursor","pointer").attr("class","filterGroup mlvs mrvs").append("select").attr("class","filter1Group"),$(".filter-axis",r).find("option").remove(),e=e.selectAll("div .filter1Group").selectAll("option .label").data(t),s=GCO5.core.GcLangManager.getInstance(),e.enter().append("option").attr("class","label").attr("value",function(t){return t.id}).html(function(t){return t["lib_"+s.getLang()]||t.lib}),(t=$(".filter-axis",r).find("select")).val(a._def_o.subsetKey),t.off("change").on("change",function(t){var e;a._def_o.subsetKey=i.f1code=$(this).val(),0==a._def_o.type.indexOf("TA")?(e=n.getTableDef(i),a._genHTMLTable(e),$(".ui-table-reflow",r).parent().empty().append(e.htmlString),a._def_o.htmlString=e.htmlString,$(".key",r).text(a._def_o.subTitle=e.subTitle)):GCO5.core.GcDelayUtil.callLater(function(){a.loadData({dvz:n}),$(".key",r).text(n.getFilter1Lib(i.filter1,a._def_o.subsetKey))},[],2,a)}),GCO5.browser.isKitchen&&t.prop("disabled","disabled"))},_addSerieGroup:function(i,t,e,n,r){var a,s,o,l,c,h;!i||i.length<=1||(a=this.get$BlocContainer(),$(".filter-axis",a).show(),s=this,i=(i=10<=i.length?i.slice(-11):i).concat(),e&&i.push(">>"),(o=d3.select($(".filter-axis",a).get(0)).selectAll("div.serieGroup").data([[]])).enter().append("div").attr("class","serieGroup").attr("cursor","pointer"),l=i.length-1,c=0,$(".filter-axis",a).find("a").remove(),o.selectAll("a .label").data(i).enter().append("a").attr("class","label").attr("href","javascript:void(0)").html(function(t){return t}).on("click",function(t,e){GCO5.browser.isKitchen||s._animating||(">>"==t?(c=0,s._def_o.subsetKey=String(i[c]),n&&(n.curSerie=s._def_o.subsetKey),s.loadData(),s._styleSerieGroup(o),s._animating=!0,h=setInterval(function(){++c==l-1&&(clearInterval(h),h=null,n&&(n.curSerie=i[i.length-2]),GCO5.core.GcDelayUtil.callLater(function(){s._animating=!1},[],15,s)),s._def_o.subsetKey=i[c],s.loadData(),s._styleSerieGroup(o)},GCO5.browser.isTouch?1500:1e3)):(s._def_o.subsetKey=t,n&&(n.curSerie=t),0==s._def_o.type.indexOf("TA")?(t=r.getTableDef(n),s._genHTMLTable(t),$(".ui-table-reflow",a).parent().empty().append(t.htmlString),s._def_o.htmlString=t.htmlString):(s.loadData(),n&&!GCO5.core.GcStringUtil.isEmpty(n.source)&&(t=n.source+" - "+n.curSerie,$(".source",a).html(s.gclg.getString("SOURCE","indics")+s.gclg.getString("P2B")+" "+t))),s._styleSerieGroup(o)))}),this._styleSerieGroup(o))},_styleSerieGroup:function(t){var e=this;t.selectAll("a.label").style("color",function(t){return t==e._def_o.subsetKey?"#000":"#666"}).style("font-weight",function(t){return t==e._def_o.subsetKey?"bold":"normal"})},getPieContainerHeight:function(t,e){var i=this._metrics,n=this.getChartContainerWidth(),r=i.legendWidth,a=i.legendHeight,s=i.containerPadding,o=this.constructor;return i.elementsPadding=10,i.titleHeight=25,this.id_bloc=t,(n-r-2*s-2*i.elementsPadding)/2>o.PIE_DIAMETER?Math.max(o.PIE_DIAMETER,a)+i.titleHeight+i.paddingTop+i.paddingBottom:2*o.PIE_DIAMETER>n-2*s-i.elementsPadding?2*o.PIE_DIAMETER+a+2*i.titleHeight+i.paddingTop+i.paddingBottom+2*i.elementsPadding:o.PIE_DIAMETER+a+i.titleHeight+i.paddingTop+i.paddingBottom+i.elementsPadding},getPieLayout:function(){var t=this._metrics,e=this.getChartContainerWidth(),i=(this.getChartContainerHeight(),t.legendWidth),n=(t.legendHeight,t.containerPadding),r=(t.titleHeight,this.constructor);return(e-i-2*n-2*t.elementsPadding)/2>r.PIE_DIAMETER?{nbLines:1,radius:r.PIE_DIAMETER/2}:e-2*r.PIE_DIAMETER-2*n-t.elementsPadding<0?{nbLines:3,radius:r.PIE_DIAMETER/2}:{nbLines:2,radius:r.PIE_DIAMETER/2}},backToChart:function(){var t=this.get$BlocContainer();$("header [data-menu] li:eq(1)",t).removeClass("no-display"),$("header [data-menu] li:eq(0)",t).addClass("no-display"),$("header [data-menu] li:eq(-1)",t).removeClass("no-display"),$(".report-block-iframe",t).hide(),"TA"==this._def_o.type.substr(0,2)?(t.find(".ui-table-reflow").parent().show(),t.find(".xchart-container").hide()):(t.find(".xchart-container").show(),t.find(".ui-table-reflow").parent().hide(),$(".serieGroup",t).show(),$(".filter-axis",t).show())},onClickMenuIcon:function(t){if("keydown"!=t.type||13==t.keyCode){var e=$(t.target).data("index"),i=this.menu_values;if(["data","doc"].indexOf(i[e].id)<0&&this.backToChart(),"exp"==i[e].id&&this._exportInternalBlocChart("svg",$(t.target)),"data"==i[e].id){if(this._spineChartActive())return void this._getChartData({title:GCO5.appModel.getLegal("tit_nav"),libZone:$("h2",this._$blocContainer).show().text()},"csv",$(t.target));this.displayChartDataAsHTML(),$(".serieGroup",this._$blocContainer).hide(),$(".filter-axis",this._$blocContainer).hide(),$(".report-block-iframe",this._$blocContainer).hide(),$("header [data-menu] li:eq(0)",this._$blocContainer).removeClass("no-display"),$("header [data-menu] li:eq(1)",this._$blocContainer).addClass("no-display"),$("header [data-menu] li:eq(-1)",this._$blocContainer).removeClass("no-display")}"agr"==i[e].id&&this._exportInternalBlocChart("png",$(t.target)),"doc"==i[e].id&&this._exportInternalBlocChart("html",$(t.target)),"mapindic"==i[e].id&&((t=this._def_o.fullBlocInfo.blocvar_a[0]).c_id_indicateur=t.c_id_variable,GCO5.core.GcStringUtil.isEmpty(this._def_o.fullBlocInfo.curSerie)||(t.serie=this._def_o.fullBlocInfo.curSerie),GCO5.core.GcStringUtil.isEmpty(this._def_o.fullBlocInfo.f1code)||(t.f1code=this._def_o.fullBlocInfo.f1code),$(GCO5.topApp).triggerHandler(GCO5.view.component.AComponent.LOAD_COMPONENT,{id:"indicator",categ:"main",indicModel:new GCO5.model.indics.IndicModel(t),mapName:this._def_o.selgeo1.getIdView()})),"iframe"==i[e].id&&this.displayBlockIframe(this._def_o.id_bloc,this._def_o.selgeo1,this._def_o.selgeo2)}},buildDomStructure:function(t,e,i){var n=this._options,r=this._def_o,a=this._metrics,s=this.getD3ChartContainer(),o=this.get$BlocContainer(),l=this._def_o.id_bloc;if(n.fullHTML){0==o.find("h2").length&&o.append("<header class='datavizHeader'><div><h2></h2><p class='key'></p></div><a href='javascript:void(0)' data-menu-trigger='chartmenucontent"+l+"' class='grille no-print'></a><div id='chartmenucontent"+l+"' data-menu aria-hidden=true> <ul></ul></div></header><figure class='xchart-container'></figure><div class='no-display vertical-scrollable center mts report-table'><table class='ui-table-reflow mbvs' style='margin-right:20px'></table></div><div class='no-display report-text'></div><figure class='spineChart ptvs'></figure><figure class='no-display report-map'><canvas></canvas></figure><canvas id='legend_cv' class='no-display'></canvas><div class='no-display maplegendH'></div><div class='no-display filter-axis'></div> <div class='no-display hide-iframe report-block-iframe vertical-scrollable center mts w100 mbs'></div><footer><div><p class='source'></p><p class='note'></p></div></footer>");for(var c=[{id:"gra",label:this.gclg.getString("BACK_TO_CHART","exports")},{id:"data",label:this.gclg.getString("TO_DATA","exports")},{id:"doc",label:this.gclg.getString("XP_HTML","exports")},{id:"exp",label:this.gclg.getString("XP_SVG","exports")},{id:"agr",label:this.gclg.getString("XP_PNG","exports")}],h=(!this._options.isSynth&&GCO5.initInfo.hasOwnProperty("allowIframe")&&"1"===GCO5.initInfo.allowIframe&&c.push({id:"iframe",label:this.gclg.getString("IFRAME","exports")}),0==this._def_o.type.indexOf("TA")&&(c=[{id:"gra",label:this.gclg.getString("BACK_TO_CHART","exports")},{id:"doc",label:this.gclg.getString("XP_HTML","exports")}],GCO5.initInfo.hasOwnProperty("allowIframe")&&"1"===GCO5.initInfo.allowIframe&&c.push({id:"iframe",label:this.gclg.getString("IFRAME","exports")})),"SPINE"==this._def_o.type&&(c.splice(1,2),h=[{id:"data",label:this.gclg.getString("XP_DATA","exports")}],c=c.concat(h)),[]),d=0;d<c.length;d++)h.push("<li><a href='javascript:void(0)' role='button' data-index='"+d+"'class='js-modal' data-focus-back='chartMenu'data-modal-prefix-class='simple' data-modal-content-id='modal_id_2nd_example' data-modal-title='Title for your modal' data-modal-close-text='X' data-modal-close-title='Close it, really' >"+c[d].label+"</a></li>");$("header [data-menu]",o).html(h.join("")),$("header [data-menu] li",o).first().addClass("no-display"),$("header [data-menu] li",o).last().addClass("hide-iframe"),this.menu_values=c,$("header [data-menu] a",o).on("click keydown",this.onClickMenuIcon.bind(this));var l=o.find(".xchart-container"),s=this._d3ChartContainer=d3.select(l.get(0)),l=($("h2",o).html(r.title),r.source),l=($(".source",o).html(r.source?this.gclg.getString("SOURCE","indics")+this.gclg.getString("P2B")+" "+l:""),$(".key",o).html(r.subTitle),"&nbsp;"===r.title&&GCO5.core.GcStringUtil.isEmpty(r.subTitle)&&$(".datavizHeader",o).hide(),$(".note",o).html(r.note),r.note||$(".note",o).hide(),r.subTitle||$(".key",o).hide(),$(".source",o).css("display",r.source?"block":"none"),this._def_o.filterMods),o=this._def_o.subsetKey;"serie"==this._def_o.subsetType&&l&&1<l.length&&this._addSerieGroup(l,o,this._def_o.animate,this._def_o.fullBlocInfo,this._def_o.datavizModel),"filter1"==this._def_o.subsetType&&this._addFilter1Group(l,this._def_o.fullBlocInfo,this._def_o.datavizModel)}r=this.getChartContainerWidth(),o=e||this.getChartContainerHeight(),isNaN(r)?console.error("container de largeur nulle"):(s.selectAll("svg").data(this._emptyData).enter().append("svg").attr("height",o).attr("width",r).attr("class","xchart"+("distrib"==this._def_o.type?" distrib":"")),(e=(l=s.selectAll("svg")).selectAll("g.header").data(this._emptyData).enter().append("g").attr("class","header")).selectAll("g.chart-title").data(this._emptyData).enter().append("text").attr("class","chart-title").attr("x",5).attr("dy",20),e.selectAll("g.chart-libzone").data(this._emptyData).enter().append("text").attr("class","chart-libzone").attr("x",5).attr("dy",50),e.selectAll("g.chart-subtitle").data(this._emptyData).enter().append("text").attr("class","chart-subtitle").attr("x",5).attr("dy",80),e.selectAll("g.chart-source").data(this._emptyData).enter().append("text").attr("class","chart-source"),l.selectAll("g.chart").data(this._emptyData).enter().append("g").attr("class","chart"),e=l.select("g.chart"),t?(e.classed("init",!0),0==$(".chart-tooltip",this.get$ChartContainer()).length&&s.append("div").attr("class","chart-tooltip").append("div").attr("class","chart-tooltip-container")):e.classed("init")&&e.attr("transform","translate("+a.paddingLeft+","+a.paddingTop+")").classed("init",!1),e.selectAll("g.scale").data(this._emptyData).enter().append("g").attr("class","scale"),e.selectAll("g.scale2").data(this._emptyData).enter().append("g").attr("class","scale2"),t||(l.attr("width",r).attr("height",o),l.select(".chart-overlay").attr("width",r).attr("height",o),e.transition().duration(n.timing).attr("transform","translate("+a.paddingLeft+","+a.paddingTop+")")),this._svg=l,this._g=e,this._gScale=e.selectAll("g.scale"),this._gScale2=e.selectAll("g.scale2"))},resize:function(){var t,e,i,n=this.get$BlocContainer(),r=this._def_o.type;GCO5.browser.isKitchen||("MAP"==r?GCO5.browser.isKitchen||(t=$(".report-map",n),this.map._zoomingOnSelection=!0,$(".map-display",n).hide(),e=t.width(),i=Math.max(400,t.height()),t.height(i=Math.min(e,i)),$(".map-display",n).show(),this.map.setSize(e,i)):"TXT"!=r&&"TA"!=r.substr(0,2)&&this._draw())},getChartContainerWidth:function(){var t,e=this._svg?$(this._svg.node()):null;return e&&e.hide(),t=this._options.chartOuterWidth?this._options.chartOuterWidth.apply(this):this.get$ChartContainer().width(),e&&e.show(),t},getChartContainerHeight:function(){var t,e=this._svg?$(this._svg.node()):null;return e&&e.hide(),t=this._options.chartOuterHeight?this._options.chartOuterHeight.apply(this):this.get$ChartContainer().height(),e&&e.show(),t},getChartScalesWidth:function(){var t=this.getChartContainerWidth(),e=this._metrics,t=t-e.paddingLeft-e.paddingRight-e.axisPaddingLeft-e.axisPaddingRight-e.paddingCenter;return"pyr"==this.getChartType()&&(t/=2),t},getChartScalesHeight:function(){var t=this.getChartContainerHeight(),e=this._metrics;return t-e.paddingTop-e.paddingBottom-e.axisPaddingTop-e.axisPaddingBottom},getContainer:function(){return this._d3ChartContainer},getSeriesData:function(){return this._def_o?this._def_o.seriesData:null},getCompData:function(){return this._def_o?this._def_o.compData:null},_getXScaleType:function(){return this._def_o?this._def_o.xScaleType:null},_getX2ScaleType:function(){return this._def_o?this._def_o.x2ScaleType:null},_getYScaleType:function(){return this._def_o?this._def_o.yScaleType:null},_getXVar:function(){return this._def_o?this._def_o.xVar:null},_getYLCLVar:function(){return this._def_o?this._def_o.ylclVar:null},_getYUCLVar:function(){return this._def_o?this._def_o.yuclVar:null},getDef:function(t){return this._def_o?this._def_o[t]:null},_getCurrentYVar:function(){return this._chart?this._chart.getCurrentYVar():this._getYVar()},_getX2Var:function(){return this._def_o?this._def_o.x2Var:null},_getYVar:function(){return this._def_o?this._def_o.yVar:null},_getCVar:function(){return this._def_o?this._def_o.cVar:null},getXZero:function(){return this._xZero},getYZero:function(){return this._yZero},getXScale:function(){return this._xScale},getXScale2:function(){return this._xScale2},getYScale:function(){return this._yScale},getYScale2:function(){return this._yScale2},getChartGroup:function(){return this._g},getChartType:function(){return this._def_o?this._def_o.type:null},getDefs:function(){return this._def_o},getOptions:function(){return this._options},destroy:function(){this._chart&&this._chart.destroy()},_getDomain:function(t,i){t=t.reduce(function(t,e){return t.concat(e.chartData.reduce(function(t,e){return t.concat(e[i])},[]))},[]);return GCO5.core.GcArrayUtil.getDistinctValues(t)},_ordinal:function(t,e,i,n,r){n=n||this._defaultSpacing;t=this._getDomain(t,e);return 100<t.length?d3.scaleBand().domain(t).range(i).paddingInner(0).paddingOuter(r=1):d3.scaleBand().domain(t).rangeRound(i).paddingInner(n).paddingOuter(r)},_linear:function(t,e){t=d3.scaleLinear().domain(t).rangeRound(e);return"distrib"==this.getChartType()?t:t.nice()},_time:function(t,e){return d3.scaleTime().domain(t.map(function(t){return new Date(t)})).range(e)},_removeTicks:function(){this._gScale.selectAll(".tick").remove(),this._gScale2.selectAll(".tick").remove()},_extendDomain:function(t){var e,i=t[0],n=t[1],r=!1;return i===n?(i-=e=Math.max(Math.round(i/10),4),n+=e):n<i&&(i=t[1],n=t[0],r=!0),n=r?(i=0<t[1]?0:i,t[0]<0?Math.min(n,0):n):(i=0<t[0]?0:i,t[1]<0?Math.max(n,0):n),!r&&!isNaN(this._def_o.yrefVal)&&this._def_o.yrefVal>n&&(n=this._def_o.yrefVal),!r&&!isNaN(this._def_o.ymaxVal)&&this._def_o.ymaxVal>n&&(n=this._def_o.ymaxVal),r?[n,i]:[i,n]},_getExtents:function(t,e){var a=this,s=this.getChartType(),i=this._getXScaleType(),n=this._getYScaleType(),r=this._getXVar(),o=this._getX2Var(),l=this._getCurrentYVar(),c=this.getDefs().base100,h=["pyr","barh","barXXv"].indexOf(s)<0||"serie"!=this._def_o.subsetType?"chartData":"data",d=t[0][h+(c?"b100":"")];if(d&&!Array.isArray(d)){var u,p=[];for(u in d)p=p.concat(d[u])}else p=t.reduce(function(t,e){return t.concat(e[c?"chartDatab100":[h]])},[]);var t="ordinal"==i?p:p.filter(function(t){return!GCO5.core.GcMathUtil.isNumericInvalid(t[r])}),g="ordinal"==n?p:p.filter(function(t){return!GCO5.core.GcMathUtil.isNumericInvalid(t[l])}),f=this._getYLCLVar(),m=this._getYUCLVar(),_=(f&&(g=g.concat(g.map(function(t){return(t=GCO5.core.GcObjectUtil.clone(t))[l]=t[f],t})).concat(g.map(function(t){return(t=GCO5.core.GcObjectUtil.clone(t))[l]=t[m],t}))),{x:d3.extent(t,function(t){return"ordinal"==i?t[r]:parseFloat(t[r])}),y:d3.extent(g,function(t){return"ordinal"==n?t[l]:parseFloat(t[l])})}),t=("pyr"==this.getChartType().substr(0,3)&&(g=p.filter(function(t){return!GCO5.core.GcMathUtil.isNumericInvalid(t[o])}),_.x2=d3.extent(g,function(t){return parseFloat(t[o])}),_.x1=_.x,_.x=[Math.min(_.x1[0],_.x2[0]),Math.max(_.x1[1],_.x2[1])],_.x2=_.x.concat().reverse()),[i,n]);return o&&t.push("xScaleType"),t.forEach(function(i,t){var n,r=2==t?"x2":t?"y":"x";"ordinal"!==i&&("time"!==i&&"distrib"!=s&&(n=a._extendDomain(_[r])),[r+"Min",r+"Max"].forEach(function(t,e){_[r][e]=a._options.hasOwnProperty(t)&&null!==a._options[t]?a._options[t]:("time"!==i&&"distrib"!=s?n:_[r])[e]}))}),this._extents=_},_getAxes:function(o,t){this._options;var l=this,c=this._metrics,h=this._getExtents(o,t),d={},u=[c.axisPaddingLeft,c.axisPaddingLeft+this.getChartScalesWidth()],p=[0,this.getChartScalesWidth()],t=[0,this.getChartScalesWidth()],g=[this.getChartScalesHeight()+c.axisPaddingTop,c.axisPaddingTop],f=this.getChartType(),e=this._getXScaleType(),i=this._getYScaleType(),m="pyr"==f,_="bar"==f.substr(0,3),v="lin"==f.substr(0,3);return[e,i].forEach(function(t,e){var i=0===e?"x":"y",n=0===e?m?p:u:g,r=e?l._getYVar():l._getXVar();switch(t){case"ordinal":var a=_?.25:m?.15:-.25,s=v&&c.outerXPadding?c.outerXPadding:0;_&&(s="barv"!=f||l._def_o.noYAxis?0:.15),d[i]=l._ordinal(o,r,n,a=v?0:a,s=m?0:s);break;case"linear":d[i]=l._linear(h[i],n,i);break;case"time":d[i]=l._time(h[i],n)}}),c.outerXPadding&&(c.outerXPadding=null),m&&h.x2&&(d.x2=this._linear(h.x2,t)),d},_computeAxesMetrics:function(){var n,t,e,r,i,a,s,o,l,c=this,h=(this._d3ChartContainer,this._options),d=this._metrics,u=this.getChartType(),p="pyr"==u,g="barh"==u,f="distrib"==u,m="pie"==u.substr(0,3),_="lin"==u.substr(0,3),v=h.tickHintX.apply(this),y=h.tickHintY.apply(this),b=h.tickSize0,C=parseFloat($(this._svg.node()).css("padding-bottom")),x=d.containerPadding=!f&&C||0;p&&(x=d.containerPadding=5),p&&$(this._svg.node()).css({"padding-top":"0px","padding-bottom":"0px"}),C&&$(this._svg.node()).css({"padding-left":"0px","padding-top":"0px"}),d.axisPaddingTop=f?16:0,d.axisPaddingRight=5,d.axisPaddingBottom=m?0:b,d.axisPaddingLeft=m||p||f?0:b,d.paddingLeft=x,d.paddingTop=x,d.paddingRight=x,d.paddingBottom=x,d.paddingCenter=0,d.labelsAxisYWidth=0,d.labelsAxisXHeight=0,d.labelAxisXMaxWidth=0,d.labelAxisXSumLength=0,d.labelAxisXMaxWidth=0,d.label1AxisXLeftPadding=0,d.label2AxisXRightPadding=0,d.outerXPadding=0,m||(t=c._hasNumericXAxis()?c._extents.x[1]:null,C=c._hasNumericYAxis()?c._extents.y[1]:null,b=d3.axisLeft(this._yScale).ticks(y).tickFormat(h.tickFormatY),this._def_o.noYAxis||(e=this._gScale.selectAll("g.__axisY").data(this._emptyData).enter().append("g").attr("class","axis __axisY").call(b),this._gScale.selectAll("text").attr("class","chart-tick-text"),r=d3.selectAll(".axis.__axisY text").nodes().length,d3.selectAll(".axis.__axisY text").each(function(t,e){var i=GCO5.core.GcObjectUtil.getSVGElementBbox(this,"xchart chart-tick-text"),n=i.width;p&&50<r&&0<e%Math.ceil(r/25)||(d.labelsAxisYWidth=Math.max(d.labelsAxisYWidth,n)),c._hasNumericYAxis()&&(d.label1AxisYHeight=i.height,d.axisYmax=t)})),y=d3.axisBottom(this._xScale).ticks(p?v/2:v).tickSize(-this.getChartScalesHeight()-d.axisPaddingBottom).tickFormat(h.tickFormatX),this._def_o.noXAxis||(i=this._gScale.selectAll("g.__axisX").data([[]]).enter().append("g").attr("class","axis __axisX").call(y)),p||(b=g?(a=this._xScale.range(),d3.selectAll(".axis.__axisX text").nodes.length):(a=this._xScale.range(),d3.selectAll(".axis.__axisX text").size()),s=(a[1]-a[0])/(b||v),this._hasNumericXAxis()||_||d3.selectAll(".axis.__axisX text").call(this.wrap,this._xScale.bandwidth()+30,0,"xchart chart-tick-text")),o=d3.selectAll(".axis.__axisX text").size(),d3.selectAll(".axis.__axisX text").each(function(t,e){(!l||o<50)&&(l=GCO5.core.GcObjectUtil.getSVGElementBbox(this,"chart-tick-text")),d.labelsAxisXHeight=Math.max(d.labelsAxisXHeight,l.height);var i=parseFloat(d3.select(this.parentNode).attr("transform").split("(")[1].split(",")[0]);n=l.width,d.labelAxisXSumLength+=n,d.axisXmax=t,p||(d.label1AxisXLeftPadding||(d.label1AxisXLeftPadding=i-n/2),d.label2AxisXRightPadding=a[1]-a[0]-(i+n/2))}),d.labelAxisXMaxWidth=n,d.paddingBottom+=d.labelsAxisXHeight-2+this.tickLabelGap,c._hasNumericYAxis()&&d.axisYmax>=C&&(d.paddingTop+=d.label1AxisYHeight/2),m||p||this._def_o.legendBottom&&0<d.legendHeight&&(d.paddingBottom+=d.legendHeight+d.legendTopPadding),i&&i.remove(),e&&e.remove(),this._def_o.noYAxis||(p?(d.paddingCenter=d.labelsAxisYWidth+5+8,d.paddingLeft=x,d.paddingTop=20+x):f||(d.paddingLeft+=d.labelsAxisYWidth+this.tickLabelGap))),d.label1AxisXLeftPadding&&(d.outerXPadding=-(Math.max(d.label1AxisXLeftPadding,d.label2AxisXRightPadding)-10)/s),this._hasNumericXAxis()&&(d.axisXmax>=t||"barh"==u||"pyr"==u)?(d.axisPaddingRight+=d.labelAxisXMaxWidth/2,p&&(d.axisPaddingLeft+=d.labelAxisXMaxWidth/2)):!this._hasNumericXAxis()&&(0==u.indexOf("line")||"distrib"==u||"barv"==u)&&this._xScale.bandwidth()<50&&(d.axisPaddingRight+=d.labelAxisXMaxWidth/2-5,d.axisPaddingLeft+=d.labelAxisXMaxWidth/2-5)},_drawAxes:function(){if(!this._noData){var i,n,t,e,r,a=this._options,s=this._metrics,o=(this._def_o,this._gScale),l=a.tickHintX.apply(this),c=a.tickHintY.apply(this),h=a.tickSize0,d=this.getChartScalesHeight()+s.axisPaddingBottom,u=(d3.line().x(function(t){return t}),this.getChartType()),p="pyr"==u,g="barh"==u;if(p||o.selectAll("g.axis2X .tick").style("opacity",0),"pie"==u.substr(0,3))return this._def_o.noXAxis=!0,(o=this._lastType&&"pie"==this._lastType.substr(0,3)?o:o.transition().duration(a.timing).style("opacity",0)).selectAll("g.axisX .tick").style("opacity",0),void o.selectAll("g.axisY .tick").style("opacity",0);(this._lastxScaleType==this._xScaleType||this._lastType&&"pie"==this._lastType.substr(0,3)||p)&&(o=o.transition().duration(a.timing).style("opacity",1)),e=d3.axisBottom(this._xScale).ticks(p?l/2:"barhXX"!=u?l:5).tickSize("barv"==u?-s.axisPaddingBottom:-this.getChartScalesHeight()-s.axisPaddingBottom).tickFormat(a.tickFormatX),this._gScale.selectAll("g.axisX").data([[]]).enter().append("g").attr("class","axis axisX").attr("transform","translate(0,"+d+")"),p?(o.selectAll("g.axisX").transition().duration(this._options.timing).attr("transform","translate("+(s.axisPaddingLeft+this.getChartScalesWidth()+s.paddingCenter)+","+d+")").call(e),t=d3.axisBottom(this._x2Scale).ticks(l/2).tickSize(-this.getChartScalesHeight()-s.axisPaddingBottom).tickFormat(a.tickFormatX),this._gScale.selectAll("g.axis.axis2X").data([[]]).enter().append("g").attr("class","axis axis2X"),o.selectAll("g.axis2X").transition().duration(this._options.timing).attr("transform","translate("+s.axisPaddingLeft+","+d+")").call(t).style("opacity",1),o.selectAll("g.axis2X .tick").style("opacity",1)):this._def_o.noXAxis?(o.selectAll("g.axisX .tick").style("opacity",0),o.selectAll("g.axis2X .tick").style("opacity",0)):(this._gScale.selectAll("g.axisX").call(e),o.selectAll("g.axisX .tick").style("opacity",1),o.selectAll("g.axisX").attr("transform","translate(0,"+d+")"),this._gScale.selectAll("g.axis2X").transition().duration(a.timing).style("opacity",0),this._hasNumericXAxis()||"line"==u.substr(0,4)||this._gScale.selectAll(".axis.axisX text").call(this.wrap,this._xScale.bandwidth()+30,0,"xchart chart-tick-text")),this._def_o.noXAxis||(e=(t=0<(n=(i=this._gScale.selectAll(".axisX g").nodes()).length)?GCO5.core.GcObjectUtil.getSvgTextMaxWidthInChars(i[n-1].lastChild):0)<5?30:t<9?50:70,(i.length>this.getChartScalesWidth()/e&&("pyr"==u||"barh"==u)||s.labelAxisXSumLength>1.1*this.getChartScalesWidth()&&"barh"!=u&&"pyr"!=u)&&(i.sort(function(t,e){var i=/translate\(([^,)]+)/;return t=t.getAttribute("transform").match(i),e=e.getAttribute("transform").match(i),!(!t||!e)&&(!(t.length<1||e.length<1)&&parseFloat(t[1],10)-parseFloat(e[1],10))}),this._hasNumericXAxis()?d3.selectAll(i).filter(function(t,e){return(n-e-1)%(Math.ceil(n/l)+1)}).remove():(r=Math.floor(1.1*n*this.getChartScalesWidth()/s.labelAxisXSumLength),(0==u.indexOf("line")||0==u.indexOf("barv"))&&20<n&&(r-=2),d3.selectAll(i).filter(function(t,e){return(n-e-1)%Math.ceil(n/r)!=0}).remove()),p&&((i=this._gScale.selectAll(".axis2X g").nodes()).sort(function(t,e){var i=/translate\(([^,)]+)/;return t=t.getAttribute("transform").match(i),e=e.getAttribute("transform").match(i),-parseFloat(t[1],10)+parseFloat(e[1],10)}),d3.selectAll(i).filter(function(t,e){return e%(Math.ceil(i.length/l)+1)}).remove()))),this._def_o.noYAxis||(d=d3.axisLeft(this._yScale).scale(this._yScale).ticks(c).tickSize(p?5:g?-h:-this.getChartScalesWidth()-s.axisPaddingRight-s.axisPaddingLeft).tickFormat(a.tickFormatY),this._gScale.selectAll("g.axisY").data(this._emptyData).enter().append("g").attr("class","axis axisY"),o.selectAll("g.axisY").attr("transform","translate("+(p?s.axisPaddingLeft+this.getChartScalesWidth()+s.paddingCenter:"0")+",0)").call(d),o.selectAll("g.axisY .tick").style("opacity",1)),g||p?this._gScale.selectAll("g.axisZero").remove():(this._gScale.selectAll("g.axisZero").data(this._emptyData).enter().append("g").attr("class","axisZero").selectAll("line").data(this._emptyData).enter().append("line").attr("x1",0).attr("x2",this.getChartScalesWidth()+s.axisPaddingLeft+s.axisPaddingRight).attr("y1",this._yZero).attr("y2",this._yZero),"distrib"!==u&&this._gScale.selectAll("g.axisZero line").transition().duration(a.timing).attr("x2",this.getChartScalesWidth()+s.axisPaddingLeft+s.axisPaddingRight).attr("y1",this._yZero).attr("y2",this._yZero)),this._def_o.hasOwnProperty("yrefVal")?(this._yRef=this._yScale(this._def_o.yrefVal),this._gScale2.selectAll("g.axisYref").data(this._emptyData).enter().append("g").attr("class","axisYref").selectAll("line").data(this._emptyData).enter().append("line"),this._gScale2.selectAll("g.axisYref line").attr("stroke-opacity",1).attr("x1",0).attr("x2",this.getChartScalesWidth()+s.axisPaddingLeft+s.axisPaddingRight).attr("y1",this._yZero).attr("y2",this._yZero).transition().duration(a.timing).attr("y1",this._yRef).attr("y2",this._yRef)):this._gScale2.selectAll("g.axisYref line").attr("stroke-opacity",0),this._svg.select("g.chart").transition().duration(a.timing).attr("transform","translate("+s.paddingLeft+","+s.paddingTop+")"),this._gScale.selectAll("line").attr("class","chart-tick-line"),this._gScale.selectAll("text").attr("class","chart-tick-text"),this._gScale.selectAll("g.axisZero line").attr("class","chart-axis0"),this._gScale2.selectAll("g.axisYref line").attr("class","chart-axis-yref"),p&&50<(i=this._gScale.selectAll(".axisY g").nodes()).length&&d3.selectAll(i).filter(function(t,e){return 0<e%Math.ceil(i.length/25)}).remove()}},hideRefSerie:function(){this._chart._hideRefSerie()},showRefSerie:function(){this._chart._showRefSerie()},hasLegend:function(){return this._chart.hasLegend()},beforePrint:function(t){var i,e=t.isSpine?d3.select(".spineChart").selectAll("svg"):this._svg,n=$(e.node()),r=e.selectAll("g.header"),a=this._metrics,s=this,o=(r.selectAll("text.chart-title").text(t.title).attr("dy","1.5em").attr("x",function(t){var e=GCO5.core.GcObjectUtil.getSVGElementBbox(this).width;return i=(s.getChartContainerWidth()-e)/2}),i<0&&r.selectAll("text.chart-title").attr("x",0).attr("dy","0.5em").call(this.wrap,this.getChartContainerWidth(),1),GCO5.core.GcObjectUtil.getSVGElementBbox(r.selectAll("text.chart-title").node()).height),l=o+35,c=(i<0&&(l+=5),r.selectAll("text.chart-libzone").text(t.libZone).attr("x",function(t){var e=GCO5.core.GcObjectUtil.getSVGElementBbox(this).width;return(s.getChartContainerWidth()-e)/2}).attr("dy",l-12),GCO5.core.GcStringUtil.isEmpty(t.subTitle)||t.subTitle==t.libZone||(r.selectAll("text.chart-subtitle").text(t.subTitle).attr("x",function(t){var e=GCO5.core.GcObjectUtil.getSVGElementBbox(this).width;return(s.getChartContainerWidth()-e)/2}),l+=30),t.source),h=this.gclg.getString("SOURCE","indics")+this.gclg.getString("P2B")+" ",h=(c.indexOf(h)<0&&(c=h+c),r.selectAll("text.chart-source").text(c).attr("x",function(t){var e=GCO5.core.GcObjectUtil.getSVGElementBbox(this).width;return i=(s.getChartContainerWidth()-e)/2}).attr("dy",parseFloat(e.attr("height"))+l-5),0),c=(i<0&&(r.selectAll("text.chart-source").attr("x",0).attr("dy",0).call(this.wrap,this.getChartContainerWidth(),1).attr("transform","translate("+a.paddingLeft+","+(a.paddingTop+parseFloat(e.attr("height"))+l+25-25)+")"),h=GCO5.core.GcObjectUtil.getSVGElementBbox(r.selectAll("text.chart-source").node()).height),e.selectAll("g.chart").node());c.getAttribute("transform")?(1==(r=(a=c.getAttribute("transform").match(/translate\(([^]+)\)/))[1].split(",")).length&&(r=a[1].split(" ")),t.isSpine?l-=(GCO5.browser.isIE,5):l-=15,1==r.length&&r.push(0),e.selectAll("g.chart").attr("transform","translate("+r[0]+","+(+r[1]+l)+")"),o=parseFloat(e.attr("height")),t.isSpine&&(t.height0=e.attr("height")),n.attr("height",o+l+50-25+h)):n.attr("height",600)},afterPrint:function(t){var e=t.isSpine?d3.select(".spineChart").selectAll("svg"):this._svg,i=e.selectAll("g.header");this._metrics;i.selectAll("text.chart-title").text(""),i.selectAll("text.chart-libzone").text(""),i.selectAll("text.chart-subtitle").text(""),i.selectAll("text.chart-source").text(""),t.isSpine&&(e.selectAll("g.chart").attr("transform","translate(0,0)"),this._def_o.subTitle=this.gclg.getString("FILTER_SPINE_HINT","report"),$(".xchart-container",this.get$BlocContainer()).hide()),this.buildDomStructure(),e.attr("height",t.height0)},_spineChartActive:function(){var t=$(".spineChart",this.get$BlocContainer());return!!(t.is(":visible")&&0<t.height())&&t},_getTitleData:function(){var t=this.get$BlocContainer().find(".key").text(),e=this.get$BlocContainer().find(".source").text();return{title:this.get$BlocContainer().find("h2").html().split("<br>").join(" - "),libZone:t,subTitle:t,source:e}},_exportInternalBlocChart:function(t,e){var i=this._getTitleData();0==this._def_o.type.indexOf("TA")?this._exportTable(this,t,e,i.source):this.exportChart(i,t,e)},_exportTable:function(t,e,i,n){var r="<h1>"+t._def_o.title+"</h1>";t._def_o.subTitle&&(r+="<p>"+t._def_o.subTitle+"</p>"),r+=t._def_o.htmlString.split("<a").join("<p").split("</a").join("</p"),n&&(r+="<p class='source'>"+n+"</p>"),localStorage.expimg="<table>"+r+"</table>",window.open("GC_exportImg.php?lang="+GCO5.appModel.getLang()+"&fmt=html&ios="+GCO5.browser.isIOS)},exportChart:function(n,r,a){var s=document.createElement("canvas"),o=this;if("csv"==(r=r.toLowerCase())||"html"==r)try{o.exportChartData(n,r,a)}catch(t){alert(t.message)}else{var t=this._spineChartActive(),e=t?$("svg",t).get(0):this._svg.node();n.isSpine=!!t,n.isSpine||(n.height0=this._svg.attr("height")),this.beforePrint(n),svgAsDataUri(e,1,function(t,e){var i;e=e.replace(/&nbsp;/gi," "),"svg"==r?(localStorage.expimg="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e),window.open("GC_exportImg.php?lang="+GCO5.appModel.getLang()+"&fmt=svg&ios="+GCO5.browser.isIOS)):(canvg(s,e,{ignoreClear:!0}),(e=document.createElement("canvas")).width=s.width+20,e.height=s.height+0,(i=e.getContext("2d")).fillStyle="#ffffff",i.fillRect(0,0,e.width,e.height),i.drawImage(s,10,10),GCO5.core.GcBitmapUtil.exportCanvas(e,"chart.png",a),GCO5.core.GcBitmapUtil.dropCanvas(s),GCO5.core.GcBitmapUtil.dropCanvas(e)),o.afterPrint(n)})}},displayChartDataAsHTML:function(){var t=this._getChartData({},"html"),t=GCO5.core.GcArrayUtil.csvToHTML(t.delim,t.titleData,t.csvData,t.sourceData),e=this.get$BlocContainer().find("table");e.empty(),e.append($(t).html()),this.get$BlocContainer().find(".xchart-container").hide(),e.parent().show()},_getChartData:function(t,e,i,n,r){if(this._spineChartActive())return this._options.spineChart.exportChartData(t,e,i);t=t||this._getTitleData();var a=this.getSeriesData();if(!a)return null;n=n||("html"==e?"##":this.gclg.get_delim_csv());for(var s=!!(a&&0<a.length)&&a[0].area,i=new Array,o=new Array,l=new Array,c=new Array,h={},d=a.length,u=a[0].chartData.length,p=this._getXVar(),g=this._getX2Var(),f=this._getYVar(),m="pyr"==this.getChartType(),_="barh"==this.getChartType(),v="",y=0;y<(m?2:d);y++)v+=n;var b="CSV"==e?'"':"",C=(t.title&&i.push(b+t.title+b+v),t.libZone&&i.push(b+t.libZone+b+v),t.subTitle&&t.subTitle!=t.libZone&&i.push(b+t.subTitle+b+v),this._def_o.cVar?[""]:["X"==this._def_o.xVar?this.gclg.getString("PERIOD","indics"):this.gclg.getString("INDICS2","concepts")]);_&&!this._def_o.cVar&&(C=[this.gclg.getString("TERRITORIES","concepts")]);for(y=0;y<d;y++){var x=a[y];C.push(""==x.label?this.gclg.getString("VALUE"):x.label)}var w=this._def_o.blocvar_a;if(m&&(C=[this.gclg.getString("TRAGE","report").toLowerCase(),w&&2==w.length?w[1].c_lib_court:this.gclg.getString("MEN","report").toLowerCase(),w&&2==w.length?w[0].c_lib_court:this.gclg.getString("WOMEN","report").toLowerCase()]),o.push(b+C.join(b+n+b)+b),l.push(C),m||_)for(var S=0;S<u;S++){var C=[],M=a[0].chartData[S][f];h.col0||(h.col0="char");for(y=0;y<d;y++){var O=(x=a[y]).chartData[S][p];GCO5.core.GcMathUtil.isInvalid(O)&&(O="N/A"),r?C.push(O):C.push(this.gclg.formatNumber(O,a[0].nbdec||0,!0,"html"!=e)),h["col"+(y+1)]||(h["col"+(y+1)]="num"),m&&(O=x.chartData[S][g],GCO5.core.GcMathUtil.isInvalid(O)&&(O="N/A"),r?C.push(O):C.push(this.gclg.formatNumber(O,a[0].nbdec||0,!0,"html"!=e)),h["col"+(y+2)]||(h["col"+(y+2)]="num"))}o.push(b+M+b+n+C.join(n)),l.push([M].concat(C))}else for(S=0;S<u;S++){C=[],M=a[0].chartData[S][p];h.col0||(h.col0="char");for(var G=0,y=0;y<d;y++)O=(x=a[y]).chartData[S][f],GCO5.core.GcMathUtil.isInvalid(O)||s&&GCO5.core.GcMathUtil.isInvalid(G)?O="N/A":s&&(O-=G),G=x.chartData[S][f],GCO5.core.GcMathUtil.isInvalid(O)&&(G="N/A"),r?C.push(O):C.push(this.gclg.formatNumber(O,a[0].nbdec||0,!0)),h["col"+(y+1)]||(h["col"+(y+1)]="num");o.push(b+M+b+n+C.join(n)),l.push([M].concat(C))}return t.source&&c.push(b+t.source+b+v+" "),{sourceData:c,csvData:o,bodyData:l,titleData:i,delim:n,colsdef:h,headerLength:1}},displayBlockIframe:function(t,e,i){var n,r,a=this.get$BlocContainer(),s=(t=this._def_o.datavizModel.isPublic()?(n=Math.ceil(this.get$BlocContainer().height()),n=Math.max(n+20,300),r=document.URL.split("#").shift(),r=(r=(r+=(-1<r.indexOf("?")?"&":"?")+"iframe=1#c=report&block="+t)+(e?"&selgeo1="+e.getPkGeo("."):""))+(i?"&selgeo2="+selgeo2getPkGeo("."):""),'<p class="">'+this.gclg.getString("IFRAME_DESC","exports")+this.gclg.getString("P2","common")+'</p>\n<div class="">\n   <textarea rows="3" class="w100" style="max-width: 600px" readonly ><iframe width="100%" height="'+n+'" src="'+r+'" style="border-style: hidden;min-width: 600px;"></iframe></textarea>\n</div>\n<div class="p-like">   <button class=\'copyToClipboard\'>'+this.gclg.getString("IFRAME_COPY","exports")+"</button>&nbsp;   <button class='backtoChart'>"+this.gclg.getString("IFRAME_BACK","exports")+"</button></div>"):'<p class="">'+this.gclg.getString("IFRAME_NOT_AVAILABLE","exports")+"</p>\n<div class=\"p-like\">   <button class='backtoChart'>"+this.gclg.getString("IFRAME_BACK","exports")+"</button></div>",$(".report-block-iframe",a));s.empty(),s.append(t),s.find("button.backtoChart").on("click",this.backToChart.bind(this)),s.find("button.copyToClipboard").on("click",function(){$("textarea",s).select(),document.execCommand("copy")}),$(".serieGroup",a).hide(),$(".filter-axis",a).hide(),$("header [data-menu] li:eq(0)",a).removeClass("no-display"),$("header [data-menu] li:eq(-1)",a).addClass("no-display"),a.find(".xchart-container").hide(),a.find(".ui-table-reflow").parent().hide(),$(".serieGroup",a).hide(),$(".filter-axis",a).hide(),a.find(".ui-table-reflow").parent().hide(),s.show()},exportChartData:function(t,e,i){var n,t=this._getChartData(t,e,i);"html"==e?(n=GCO5.core.GcArrayUtil.csvToHTML(t.delim,t.titleData,t.csvData,t.sourceData),localStorage.expimg=n,window.open("GC_exportImg.php?lang="+GCO5.appModel.getLang()+"&fmt=html&ios="+GCO5.browser.isIOS)):(n=t.titleData.concat(t.csvData).concat(t.sourceData).join("\r\n"),GCO5.core.ClientInfo.getInstance().exportBlob(n,"data.csv","text",i))},getOption:function(t){return this._options[t]},wrap:function(t,d,u,p){u=u||0,t.each(function(){var t=d3.select(this),e=t.text().split(/\s+/).reverse();if(!(1==e.length&&e[0].indexOf("|")<0))for(var i,n=[],r=0,a=t.attr("y"),s=parseFloat(t.attr("dy")),o=t.text(null).append("tspan").attr("x",0).attr("y",a).attr("dy",s+u+"em");c=e.pop();){var l,c,h=!1;0<c.indexOf("|")&&(c=(l=c.split("|")).shift(),e.push(l.join("|")),h=!0),n.push(c),o.text(n.join(" ")),(GCO5.core.GcObjectUtil.getSVGElementBbox(o.node(),p).width>d||i)&&(n.pop(),o.text(n.join(" ")),n=[c],o=t.append("tspan").attr("x",0).attr("y",a).attr("dy",1.1*++r+s+"em").text(c)),0<e.length&&(i=h)}})}}),GCO5.view.component.ReportLayout=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.ReportLayout"},_chart:null,_compChart:null,_dashboardModel:null,_d3ReportContainer:null,_$reportContainer:null,_datavizs:null,_defaults:{mouseover:function(t,e){}},_defaultSpacing:.25,gclg:null,initialize:function(t,e,i){e?(this.gclg=GCO5.core.GcLangManager.getInstance(),this._$reportContainer=t,this._d3ReportContainer=d3.select(t.get(0)),this.update(e,i)):console.error("erreur : pas de données")},update:function(t,e){this._dashboardModel=t.dashboardModel,this._options=GCO5.core.GcObjectUtil.defaults(e||{},this._defaults);for(var i=this._dashboardModel.getBlocList({exclude2:["ITA","IMA","ITX"]},!0),n=0;n<i.length;n++){var r=i[n].pk;i[n].defBloc=this._dashboardModel.getDefFromIdBloc(r)}var a,s,t=this._d3ReportContainer.selectAll(".dataviz-container").data(i,function(t){return t.pk}),o=this._$reportContainer.width(),l=this._$reportContainer.height(),c=0;t.enter().append("article").attr("class","dataviz-container abso").attr("id",function(t){return t.pk}).style("width",function(t,e){return a=t.defBloc.metrics.width,"TXT"==t.defBloc.type||"MAP"==t.defBloc.type?100*a/650+"%":"auto"}).style("max-width",function(t,e){return"TAB"==t.defBloc.type?"500px":"none"}).style("height",function(t,e){return s=t.defBloc.metrics.height||a,"MAP"==t.defBloc.type?100*s/900+"%":"auto"}).style("left",function(t,e){var i=t.defBloc.metrics.x;return"pyr"==t.defBloc.type&&(i-=t.defBloc.metrics.width-70),"barv"!=t.defBloc.type&&"line"!=t.defBloc.type.substr(0,4)||(i-=40),"barh"==t.defBloc.type&&(i-=45),100*i/650+"%"}).style("top",function(t,e){return 100*t.defBloc.metrics.y/900-20+"%"}).style("visibility","hidden").each(function(t,e){var i={fullHTML:!0,report:!0,chartOuterWidth:function(){return a=t.defBloc.metrics.width,"barh"==t.defBloc.type&&(a+=40),"pyr"==t.defBloc.type&&(a=1.9*a+40),100*(a="pie"==t.defBloc.type?Math.min(300,a+150):a)/650*o/100},chartOuterHeight:function(){return a=t.defBloc.metrics.width,s=t.defBloc.metrics.height||a,"barh"==t.defBloc.type||"pyr"==t.defBloc.type?s+=70:s-=10,100*s/900*l/100}},n=this;c++,GCO5.core.GcDelayUtil.callLater(function(){$(n).css("visibility","visible"),t.reportChart=new GCO5.view.component.D3ChartContainer($(n),t.defBloc,i)},[],15*e,n)}),GCO5.core.GcDelayUtil.callLater(function(){$(document).trigger("enhance")},[],15*c+1,this),t.exit().each(function(t,e){}).remove(),this._datavizs=t},resize:function(){var i,n,r=this._$reportContainer.width(),a=this._$reportContainer.height();this._datavizs.each(function(t,e){t.reportChart._options.chartOuterWidth=function(){return i=t.defBloc.metrics.width,"barh"==t.defBloc.type&&(i+=40),"pyr"==t.defBloc.type&&(i=1.9*i+40),100*(i="pie"==t.defBloc.type?Math.min(300,i+150):i)/650*r/100},t.reportChart._options.chartOuterHeight=function(){return i=t.defBloc.metrics.width,n=t.defBloc.metrics.height||i,"barh"==t.defBloc.type&&(n+=70),"pyr"==t.defBloc.type&&(n+=70),100*n/900*a/100},t.reportChart.resize()})}}),GCO5.view.component.AChart=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.AChart"},_isConfig:null,_d3Chart:null,_zIndex:null,_selector:null,_insertBefore:null,_isComp:null,_elements:null,_callbacks:null,_timing:null,_nbObs:null,_type:null,_rotateInterval:null,gclg:null,gcsm:null,_emptyData:[[]],initialize:function(t){this._d3Chart=t,this._elements={},this._timing=t.getOption("timing"),this.gclg=GCO5.core.GcLangManager.getInstance(),this.gcsm=GCO5.core.SystemManager.getInstance()},_getInsertionPoint:function(){return d3.range(10,this._zIndex,-1).map(function(t){return'g[data-index="'+t+'"]'}).join(", ")},_getColorClass:function(t,e){t=t.getAttribute("class");return(null!==t?t.replace(/color\d+/g,""):"")+" color"+e},_mouseOverLegend:function(t){var e,i,n,r,a,s;GCO5.browser.isKitchen||(e=(r=this._d3Chart._def_o).hasBase100Switch,n=this._d3Chart.get$ChartContainer(),n=$(".chart-tooltip",n),i=$(".chart-tooltip-container",n),n.show(),n=!1!==r.base100,r=this._someLinesDisabled(),a=this.gclg.getString("DISPLAY_ALL","report"),s=this.gclg.getString("ISOLATE","report"),e?i.html(n!=t.enabled?a:s):i.html(r&&t.enabled?a:s))},_someLinesDisabled:function(){this._d3Chart,this._isComp;var t=this.getSeriesData(),e=!1;return t.forEach(function(t){t.enabled||(e=!0)}),e},_addTooltipOnLegend:function(t){var e=this,o=this._d3Chart.get$ChartContainer(),l=$(".chart-tooltip",o),c=$(".chart-tooltip-container",l);t.on("mouseover",function(t){e._mouseOverLegend(t,this)}).on("mouseout",function(t){l.hide()}).on("mousemove",function(t){var e=d3.mouse(d3.select("body").node()),i=e[0],n=e[1],r=o.offset(),a=r.top,r=r.left,a="auto"==a?0:parseFloat(a),r="auto"==r?0:parseFloat(r),e=(l.css({top:"0px",left:"0px","z-index":100}),Math.min(0,GCO5.browser.width-e[0]-l.width()/2-20)),s=r-i+l.width()/2,s=(2<s&&(e=s),0<o.closest(".report-viewport").length&&o.closest(".report-viewport").offset().top>n-l.height()-30);l.css({top:(s?n-a+30:n-a-l.height()-30)+"px",left:i-r-l.width()/2+e+"px"}),s?c.removeClass("arrowbottom"):c.addClass("arrowbottom")})},postUpdateScale:function(t){},setAsComp:function(){this._isComp=!0},isAreaChart:function(){var t=this.getSeriesData();return!!(t&&0<t.length)&&t[0].area},getSeriesData:function(){return this._isComp?this._d3Chart.getCompData():this._d3Chart.getSeriesData()},enter:function(){var t=this._d3Chart._options;this._callbacks={click:t.click,mouseover:this._d3Chart._def_o.mouseover||t.mouseover,mouseout:this._d3Chart._def_o.mouseout||t.mouseout,mousemove:this._d3Chart._def_o.mousemove||t.mousemove,tooltip:this._d3Chart._def_o.tooltip||t.tooltip}},_hideRefSerie:function(){var t=this._d3Chart,e=t.getSeriesData();1!=e.length&&(e[1].enabled=!1,t._draw(!0))},_showRefSerie:function(){var t=this._d3Chart,e=t.getSeriesData();1!=e.length&&(e[1].enabled=!0,t._draw(!0))},hasLegend:function(){return 1<this._d3Chart.getSeriesData().filter(function(t){return""!=t.label}).length},getCurrentYVar:function(){return this._d3Chart._getYVar()},getType:function(){return this._type},_styleSerieGroup:function(i,n){var r;this._elements.serieGroup&&(r=this._d3Chart.getDefs().subsetKey,this._elements.serieGroup.attr("transform",function(t,e){return"translate("+i+","+n+")"}),this._elements.serieGroup.selectAll("g."+this._type+".serieGroup text .label").style("fill",function(t,e){return t==r?"#00":"#666"}).style("font-weight",function(t,e){return t==r?"bold":"normal"}))},update:function(){},exit:function(){},addLegend:function(){},destroy:function(){clearInterval(this._rotateInterval),this._rotateInterval=null}}),GCO5.view.component.BarHChart=GCO5.view.component.AChart.extend({statics:{NAME:"GCO5.view.component.BarHChart"},_isConfig:null,_type:"barh",initialize:function(t){this._super(t),this._zIndex=3,this._selector="g.barh",this._insertBefore=this._getInsertionPoint(),this.setup()},setup:function(){},postUpdateScale:function(t,e){var i=0,n=this._d3Chart,r=n.getSeriesData(),a=n.getYScale();r.forEach(function(t){i+=t.enabled?1:0}),n._yScale2=d3.scaleBand().domain(d3.range(0,i)).range([0,a.bandwidth()]).paddingInner(1==i?0:.2)},enter:function(n){this._super();var t=this._d3Chart,e=t.getXScale(),i=t.getYScale(),r=(t.getXScale2(),t.getYScale2()),a=t._getXVar(),s=t._getYVar(),o=t.getXZero(),l=(t.getYZero(),t.getSeriesData()),c=t.getChartGroup(),h=t._def_o.colf_a,d=this._callbacks,c=(t._yZero,t._def_o,(t=c.selectAll(this._selector+n).data(l.filter(function(t,e){return t.enabled}),function(t){return t.className})).exit().transition().duration(this._timing).style("opacity",0).remove(),t.enter().insert("g",this._insertBefore).attr("data-index",this._zIndex).style("opacity",0).attr("class",function(t,e){var i=t.className.split(".").pop();return GCO5.core.GcArrayUtil.getDistinctValues((n+t.className).split(".")).join(" ")+" barh color"+(parseFloat(i.substr(1))-1)}).attr("transform",function(t,e){return"translate(0,"+r(e)+")"}).merge(t)),t=(c.transition().duration(this._timing).style("opacity",1).attr("transform",function(t,e){return"translate(0,"+r(e)+")"}),(l=c.selectAll("rect").data(function(t){return t.chartData},function(t){return t[s]})).exit().transition().duration(this._timing).attr("height",0).remove(),l.enter().append("rect").attr("class",function(t,e){return"chart-fill chart-fill-"+d3.select(this.parentNode).attr("class").split(" ").pop()}).attr("width",0).attr("height",r.bandwidth()).attr("y",function(t){return i(t[s])}).attr("width",function(t){return 0}).attr("x",function(t){return 0<=t[a]?o:e(t[a])}).attr("class",function(t,e){return"chart-fill chart-fill-"+(t[a]<0?"color1":"color0")}).merge(l));h&&t.style("fill",function(t,e){var i=d3.select(this.parentNode).attr("class").split(" ").pop();return h[i.substr(-1,1)]}),t.transition().duration(this._timing).attr("height",r.bandwidth()).attr("y",function(t){return i(t[s])}).attr("width",function(t){return Math.abs(e(t[a])-o)}).attr("x",function(t){return 0<=t[a]?o:e(t[a])}).attr("class",function(t,e){return"chart-fill chart-fill-"+(t[a]<0?"color1":"color0")}),this.addLegend(),this._elements.barHGroups=c,this._elements.barsH=t,this._elements.barHGroups.style("pointer-events","auto"),c.on("mouseover",d.mouseover).on("mouseout",d.mouseout).on("mousemove",d.mousemove)},addLegend:function(){var t,i,n,r,a,s,o,l,c=this,h=this._d3Chart,d=h.getSeriesData(),e=h.getChartGroup(),u=h._metrics;e.selectAll(this._selector+".legend").remove(),1<d.length&&((t=e.append("g").attr("class","barh legendGroup").attr("transform","translate(0,"+(h.getChartScalesHeight()+60)+")").selectAll("g").data(d,function(t){return t.className}).attr("data-index",this._zIndex).enter().append("g").attr("class",function(t,e){return"barh legend "+c._getColorClass(this,e)+(t.enabled?"":" disabled")}).on("click",function(t){var e;e=t,GCO5.browser.isKitchen||(d.forEach(function(t){t.enabled=!!e.enabled&&!t.enabled,e.enabled=!0}),h._draw())})).append("rect").attr("class",function(t,e){return 0<=d3.select(this.parentNode).attr("class").indexOf("disabled")?"chart-fill-disabled":"chart-fill-"+$.trim(c._getColorClass(this,e))}).attr("width",28).attr("height",10),t.append("text").attr("class",function(t,e){return 0<=d3.select(this.parentNode).attr("class").indexOf("disabled")?"chart-fill-disabled legend-text":"legend-text chart-fill-"+$.trim(c._getColorClass(this,e))}).attr("x",32).attr("dy",".65em").text(function(t){return t.label}),i=[0],a=r=n=0,o=-15,l=h.getChartContainerWidth(),e.selectAll(this._selector+".legend").each(function(t,e){try{i[e+1]=this.getBBox().width}catch(t){i[e+1]=GCO5.core.GcObjectUtil.getSVGElementBbox(this).width}0==i[e+1]&&(i[e+1]=GCO5.core.GcObjectUtil.getSVGElementBbox(this).width),i[e+1]+=r,n+=i[e+1],a++}).attr("transform",function(t,e){return 0==e?(r=Math.max(10,Math.min((l-n)/(a+1),20)),(s=(l-(a-1)*r-n)/2-u.paddingLeft)<-u.paddingLeft&&(s=10-u.paddingLeft,r+=10)):s+=r+i[e],u.paddingLeft+s+i[e+1]>l&&(s=10-u.paddingLeft,o+=20,u.paddingBottom+=20),"translate("+s+","+String(o)+")"})),this._elements.barsHLegend=t},destroy:function(){var t=this._d3Chart,e=t.getYScale(),i=t.getYScale2(),n=t._getYVar(),r=i?i.bandwidth()/2:0;this._elements.barHGroups.style("pointer-events","none"),this._elements.barsH.transition().duration(this._timing).attr("height",0).attr("y",function(t){if(t[n])return e(t[n])+r}),this._elements.barsHLegend&&this._elements.barsHLegend.transition().duration(this._timing).style("opacity",0)}}),GCO5.view.component.BarVChart=GCO5.view.component.AChart.extend({statics:{NAME:"GCO5.view.component.BarVChart"},_isConfig:null,_type:"barv",initialize:function(t){this._super(t),this._zIndex=2,this._selector="g.barv",this._insertBefore=this._getInsertionPoint(),this.setup()},setup:function(){},postUpdateScale:function(t){var e=0,i=this._d3Chart,n=i.getSeriesData(),r=i.getXScale();n.forEach(function(t){e+=t.enabled?1:0}),i._xScale2=d3.scaleBand().domain(d3.range(0,e)).range([0,r.bandwidth()]).paddingInner(1==e?0:.2)},enter:function(n){this._super();var t,e=this,i=this._d3Chart,r=i.getXScale(),a=i.getYScale(),s=i.getXScale2(),o=i._getXVar(),l=i._getYVar(),c=(i.getYZero(),i.getSeriesData()),h=i.getChartGroup(),d=(i._metrics,this._callbacks),u=(i._def_o,i._def_o.colf_a),p=i._yZero,g=i._def_o,i=h.selectAll(this._selector+n).data(c.filter(function(t,e){return t.enabled}),function(t){return t.className}),f=i.enter().insert("g",this._insertBefore).attr("data-index",this._zIndex).style("opacity",0).attr("class",function(t,e){var i=t.className.split(".").pop();return GCO5.core.GcArrayUtil.getDistinctValues((n+t.className).split(".")).join(" ")+" barv color"+(parseFloat(i.substr(1))-1)}).attr("transform",function(t,e){return"translate(0,"+s(e)+")"}).merge(i),h=(f.transition().duration(this._timing).style("opacity",1).attr("transform",function(t,e){return"translate("+s(e)+",0)"}),i.exit().transition().duration(this._timing).style("opacity",0).remove(),(h=(i=h.selectAll(this._selector+n)).selectAll("rect").data(function(t){return t.chartData},function(t){return t[o]})).exit().transition().duration(this._timing).attr("width",0).remove(),h.enter().append("rect").attr("width",0).attr("x",function(t){return r(t[o])+s.bandwidth()/2}).attr("height",function(t){return 0}).attr("y",function(t){return p}).merge(h));h.attr("class",function(t,e){var i=d3.select(this.parentNode).attr("class").split(" ").pop();return"chart-fill "+(t.hasOwnProperty("compar")?"":"chart-fill-"+(t[l]<0&&1==c.length?"color1":i))}).style("fill",function(t,e){var i=d3.select(this.parentNode).attr("class").split(" ").pop();return t.hasOwnProperty("compar")?u[t.compar]:u?2==c.length?u[i.substr(-1,1)]:!(1<u.length)||0<=t[l]?u[0]:u[1]:null}).transition().duration(this._timing).attr("width",s.bandwidth()).attr("x",function(t){return r(t[o])}).attr("height",function(t){return 9e-4==t[l]||GCO5.core.GcMathUtil.isInvalid(t[l])?0:Math.abs(p-a(t[l]))}).attr("y",function(t){return 9e-4==t[l]||GCO5.core.GcMathUtil.isInvalid(t[l])?a(0):t[l]<0?p:a(t[l])}),1==g.labels&&((t=i.append("g").selectAll(".vlabels").data(function(t){return t.chartData},function(t){return t[o]})).exit().transition().duration(this._timing).style("opacity",0).remove(),(t=t.enter().append("text").attr("text-anchor","middle").attr("class","vlabels").attr("fill","black").attr("stroke","none").text(function(t){return 9e-4==t[l]||-99999==t[l]||-9999==t[l]||-8888==t[l]?"N/A":e.gclg.formatNumber(t[l],g.nbdec,!0)}).merge(t)).transition().duration(this._timing).attr("x",function(t){return r(t[o])+s.bandwidth()/2}).attr("y",function(t){return 9e-4==t[l]||-99999==t[l]||-9999==t[l]||-8888==t[l]?a(0)-5:a(t[l])-5})),this.addLegend(),i.style("pointer-events","auto"),this._elements.barVGroups=i,this._elements.barVLabels=t,this._elements.barsV=h,f.on("mouseover",d.mouseover).on("mouseout",d.mouseout).on("mousemove",d.mousemove)},update:function(){var t=this._d3Chart;t.getXScale(),t.getYScale(),t.getXScale2(),t._getXVar(),t._getYVar(),t.getYZero(),t.getSeriesData(),t._def_o,t._def_o.colf_a,t.getChartGroup(),t._metrics},exit:function(){},destroy:function(){var t=this._d3Chart,e=t.getXScale(),i=t.getXScale2(),n=t._getXVar(),r=i?i.bandwidth()/2:0;this._elements.barVGroups.style("pointer-events","none"),this._elements.barsV.transition().duration(this._timing).attr("width",0).attr("x",function(t){if(t[n])return e(t[n])+r}),this._elements.barsVLegend&&this._elements.barsVLegend.transition().duration(this._timing).style("opacity",0),this._elements.barVLabels&&this._elements.barVLabels.transition().duration(this._timing).style("opacity",0)},addLegend:function(){var t,i,n,r,a,s,o,l,c=this,h=this._d3Chart,d=h.getSeriesData(),e=h.getChartGroup(),u=h._metrics,p=h._def_o,g=h._def_o.colf_a,f="legend-text-small",m=(e.selectAll(this._selector+".legendGroup").remove(),d),_=(u.legendHeight=0,p.ci&&g&&3<=g.length);_&&(p=p.zonreflib,m=[{className:"1",enabled:!0,label:this.gclg.getString("SBETTER_AVG","report")+" /  "+p,color:g[0]},{className:"2",enabled:!0,label:this.gclg.getString("NOTSDIFF_AVG","report"),color:g[1]},{className:"3",enabled:!0,label:this.gclg.getString("SWORST_AVG","report")+" / "+p,color:g[2]}],1<d.length?m.push({className:"4",enabled:!0,label:p,color:"#cccccc"}):m.push({className:"4",enabled:!0,label:p,color:"#666666",type:"line"})),(1<d.length||_)&&((t=e.append("g").attr("class","barv legendGroup").selectAll("g").data(m,function(t){return t.className}).attr("data-index",this._zIndex).enter().append("g").attr("class",function(t,e){return"barv legend "+c._getColorClass(this,e)+(t.enabled?"":" disabled")}).on("click",function(t){var e;_||(e=t,GCO5.browser.isKitchen||(d.forEach(function(t){t.enabled=!!e.enabled&&!t.enabled,e.enabled=!0}),h._draw()),c._mouseOverLegend(t,this))})).append(function(t,e){return document.createElementNS("http://www.w3.org/2000/svg",t.type||"rect")}).attr("class",function(t,e){return 0<=d3.select(this.parentNode).attr("class").indexOf("disabled")?"chart-fill-disabled":"chart-fill-"+$.trim(c._getColorClass(this,e))}).style("fill",function(t,e){return t.hasOwnProperty("compar")?g[t.compar]:g?g[e]:null}).attr("width",_?20:28).attr("height",_?12:10),t.append("text").attr("class",function(t,e){return 0<=d3.select(this.parentNode).attr("class").indexOf("disabled")?"chart-fill-disabled legend-text":"legend-text chart-fill-"+$.trim(c._getColorClass(this,e))}).attr("x",1<d.length||_?_?15:32:0).attr("dy",".8em").style("fill","#000").text(function(t){return t.label.split("|").join(" ")}),_&&(t.selectAll("rect").attr("class",null).attr("fill",function(t,e){return t.color}),t.selectAll("line").attr("class","chart-axis-yref").attr("x1",0).attr("y1",4).attr("x2",20).attr("y2",4),t.selectAll("text").attr("class",f).attr("x",23).attr("fill",function(t,e){return"#000"}),e.select("g.scale2").raise()),_||this._addTooltipOnLegend(t),i=[],o=a=r=n=0,l=h.getChartContainerWidth()-2*u.containerPadding,e.selectAll(this._selector+".legend").each(function(t,e){try{i[e]=this.getBBox().width}catch(t){i[e]=GCO5.core.GcObjectUtil.getSVGElementBbox(this,f).width}0==i[e]&&(i[e]=GCO5.core.GcObjectUtil.getSVGElementBbox(this,f).width),n+=i[e],a++}).attr("transform",function(t,e){return 0==e?(r=Math.max(10,Math.min((l-n)/(a-1),20)),(s=(l-(a-1)*r-n)/2)<0&&(s=0,r+=10)):s+=r+i[e-1],s+i[e]>l-10&&(s=0,o+=20),"translate("+(u.containerPadding+s-u.paddingLeft)+","+String(o)+")"}),p=GCO5.core.GcObjectUtil.getSVGElementBbox(e.select(".barv.legendGroup").node()),u.legendHeight=p.height,m=h.getChartScalesHeight()+u.labelsAxisXHeight+h.tickLabelGap+u.legendTopPadding,e.select(".barv.legendGroup").attr("transform","translate(0,"+m+")")),this._elements.barsVLegend=t}}),GCO5.view.component.LineChart=GCO5.view.component.AChart.extend({statics:{NAME:"GCO5.view.component.LineChart"},_type:"line",initialize:function(t){this._super(t),this._zIndex=4,this._selector="g.line",this._selectorCI="g.areaci",this._insertBefore=this._getInsertionPoint(),this.setup(t)},setup:function(t){var e=this._d3Chart.getDefs();e.hasOwnProperty("legendBottom")||(e.legendBottom=!0)},getCurrentYVar:function(){return this._d3Chart._getYVar()+(this.isAreaChart()&&this._someLinesDisabled()?"0":"")},enter:function(n){this._super();function t(t,e){return h(t[u])+h.bandwidth()/2}function e(t,e){return d(t[o._someLinesDisabled()&&o.isAreaChart()?p+"0":p])}var i,r,a,s,o=this,l=this._d3Chart,c=this._isComp,h=l.getXScale(),d=l.getYScale(),u=l._getXVar(),p=l._getYVar(),g=l.getYZero(),f=l.getDefs().base100,c=c?l.getCompData():l.getSeriesData(),m=c[0].chartData.length,_=l.getChartGroup(),v=l._options.interpolation,y=d3.line().x(t).y(e);function b(t){return[f&&t.hasOwnProperty("chartDatab100")?t.chartDatab100:t.chartData]}m<50&&y.curve(v),this.isAreaChart()?(i=d3.area().x(t).y1(g),m<50&&i.curve(v)):l._getYLCLVar()&&(i=d3.area().x(t),r=function(t,e){return d(t[l._getYLCLVar()])},a=function(t,e){return d(t[l._getYUCLVar()])});var C,g=c.filter(function(t,e){return t.enabled}).reverse(),o=this,x=(l._getYLCLVar()&&((s=_.selectAll("g.area.main").data(g,function(t){return t.className})).exit().transition().duration(this._timing).style("opacity",0).remove(),(s=s.enter().insert("g").attr("data-index",this._zIndex-1).attr("class",function(t,e){t=t.className.split(".").pop();return"area main color"+(parseFloat(t.substr(1))-1)}).merge(s)).order(),C=(C=s.selectAll("path.chart-fill-light-alpha").data(b)).enter().append("path").attr("class",function(t,e){return"chart-fill-light-alpha chart-fill-light-alpha-"+d3.select(this.parentNode).attr("class").split(" ").pop()}).style("opacity",1).merge(C),l._def_o.colf_a&&C.style("fill",function(t,e){var i=d3.select(this.parentNode).attr("class").split(" ").pop().substr(5);return l._def_o.colf_a[+i]+"25"}),C.transition().delay(x?0:this._timing/2).duration(this._timing).style("opacity",1).attr("d",i.y0(a).y1(r))),(m=_.selectAll(this._selector+n).data(g,function(t){return t.className})).exit().transition().duration(this._timing).style("opacity",0).remove(),(m=m.enter().insert("g").attr("data-index",this._zIndex).attr("class",function(t,e){var i=t.className.split(".").pop();return GCO5.core.GcArrayUtil.getDistinctValues((n+t.className).split(".")).join(" ")+(o.isAreaChart()?" area-chart ":"")+" line color"+(parseFloat(i.substr(1))-1)}).merge(m)).order(),this.isAreaChart());x&&((C=m.selectAll("path.chart-fill-light").data(b)).enter().append("path").attr("class",function(t,e){return"chart-fill-light chart-fill-light-"+d3.select(this.parentNode).attr("class").split(" ").pop()}).style("opacity",1).merge(C),C=m.selectAll("path.chart-fill-light"),_.node().appendChild(_.select(".scale").node()),C.transition().delay(x?0:this._timing/2).duration(this._timing).style("opacity",1).attr("d",i.y0(e)),l._def_o.colf_a&&C.style("fill",function(t,e){var i=d3.select(this.parentNode).attr("class").split(" ").pop().substr(5);return l._def_o.colf_a[+i]})),(v=(v=m.selectAll("path.chart-line").data(b)).enter().append("path").attr("class",function(t,e){return"chart-line chart-line-"+d3.select(this.parentNode).attr("class").split(" ").pop()}).merge(v)).transition().delay(x?0:this._timing/2).duration(this._timing).style("opacity",1).attr("d",y),l._def_o.colf_a?v.style("stroke",function(t,e){var i=d3.select(this.parentNode).attr("class").split(" ").pop().substr(5);return l._def_o.colf_a[+i]}):v.style("stroke",""),this.addLegend(),this._elements.lineContainers=m,this._elements.linePaths=v,this._elements.lineX=t,this._elements.lineY=e,this._elements.line=y,x&&(this._elements.lineFills=C,this._elements.lineA=i),this._elements.lineContainers.style("pointer-events","auto"),s&&(this._elements.ciContainers=s,this._elements.ciContainers.style("pointer-events","none"),this._elements.lineFills=C)},destroy:function(){this._elements.lineContainers.style("pointer-events","none"),this._elements.linePaths.transition().duration(this._timing).style("opacity",0),this._elements.lineLegend.transition().duration(this._timing).style("opacity",0),this.isAreaChart()?this._elements.lineFills.transition().duration(this._timing).style("opacity",0):this._elements.ciContainers&&(this._elements.ciContainers.style("pointer-events","none"),this._elements.lineFills.transition().duration(this._timing).style("opacity",0))},addLegend:function(){var i,n,s=this,e=this._d3Chart,o=e.getSeriesData(),t=e.getChartGroup(),r=e._metrics,l=e._def_o,a=e._def_o.colf_a,c=(t.selectAll(this._selector+".legendGroup").remove(),l.hasBase100Switch),h=(l.subTitle0||(l.subTitle0=l.subTitle),s.gclg.getString("COMPARISON")+" - "+s.gclg.getString("BASE100_INDICE","report")),d="",u=t.append("g").attr("class","line legendGroup").attr("transform","translate(0,"+(e.getChartScalesHeight()+r.labelsAxisXHeight+e.tickLabelGap+r.legendTopPadding)+")").selectAll("g").data(o.filter(function(t){return""!=t.label}),function(t){return t.className}).attr("data-index",this._zIndex).enter().append("g").attr("class",function(t,e){return"line legend"+(t.enabled?"":" disabled")}).on("click",function(t){var i,n,r,a;i=t,GCO5.browser.isKitchen||(n=i.enabled,r=s._someLinesDisabled(),a=c,o.forEach(function(t,e){t.enabled=!(!n&&t!=i||n&&!r),!t.enabled&&c&&(a=!1)}),d=i.label,i.enabled=!0,c&&(l.base100=a,l.subTitle=l.base100&&l.subTitle0==h?h:d),e._draw(!0)),s._mouseOverLegend(t,this)}),p=(this._addTooltipOnLegend(u),u.append("rect").attr("class",function(t,e){return 0<=d3.select(this.parentNode).attr("class").indexOf("disabled")?"chart-fill-disabled":"chart-fill-"+$.trim(s._getColorClass(this,e))}).attr("width",28).attr("height",this.isAreaChart()?10:4).attr("y",this.isAreaChart()?-3:0),u.append("text").attr("class",function(t,e){return 0<=d3.select(this.parentNode).attr("class").indexOf("disabled")?"chart-fill-disabled legend-text":"legend-text chart-fill-"+$.trim(s._getColorClass(this,e))}).attr("x",32).attr("dy",".5em").style("fill","#000").text(function(t){return t.label.split("|").join(" ")}),a&&(u.selectAll("rect").style("fill",function(t,e){var i=0<=d3.select(this.parentNode).attr("class").indexOf("disabled"),n=+d3.select(this).attr("class").substr(-1);return i?"":a[n]}),u.selectAll("text").style("fill",function(t,e){var i=0<=d3.select(this.parentNode).attr("class").indexOf("disabled");d3.select(this).attr("class").substr(-1);return i?"":"#333"})),[]),g=0,f=0,m=0,_=e.getChartContainerWidth()-2*r.containerPadding,u=(t.selectAll(this._selector+".legend").each(function(t,e){try{p[e]=this.getBBox().width}catch(t){p[e]=GCO5.core.GcObjectUtil.getSVGElementBbox(this).width}0==p[e]&&(p[e]=GCO5.core.GcObjectUtil.getSVGElementBbox(this).width),g+=p[e],f++}).attr("transform",function(t,e){return 0==e?(i=Math.max(10,Math.min((_-g)/(f-1),20)),(n=(_-(f-1)*i-g)/2)<0&&(n=0,i+=10)):n+=i+p[e-1],n+p[e]>_&&(n=0,m+=20),"translate("+(r.containerPadding+n-r.paddingLeft)+","+String(m)+")"}),this._elements.lineLegend=u,GCO5.core.GcObjectUtil.getSVGElementBbox(t.select(".line.legendGroup").node())),u=(r.legendHeight=u.height-2,e.getChartScalesHeight()+r.labelsAxisXHeight+e.tickLabelGap+r.legendTopPadding+5);t.select(".line.legendGroup").attr("transform","translate(0,"+u+")")}}),GCO5.view.component.LineDottedChart=GCO5.view.component.LineChart.extend({statics:{NAME:"GCO5.view.component.LineDottedChart"},_type:"linedotted",initialize:function(t){this._super(t)},enter:function(t){this._super(t);var n=this._d3Chart,e=n._getXVar(),t=this._callbacks,i=n.getDefs().base100,r=0,a=this.isAreaChart(),s=this._elements.lineContainers.selectAll("circle").data(function(t){return r=t.data.length,i&&t.hasOwnProperty("chartDatab100")?t.chartDatab100:t.chartData},function(t){return t[e]}),o=(this._nbObs=r,null!=this._d3Chart._getYLCLVar());s.enter().append("circle").attr("class",function(t,e){return"chart-circle chart-fill-"+d3.select(this.parentNode).attr("class").split(" ").pop()}).style("opacity",0).attr("cx",this._elements.lineX).attr("cy",this._elements.lineY).attr("r",4).merge(s).transition().delay(a?0:this._timing/2).duration(this._timing).attr("cx",this._elements.lineX).attr("cy",this._elements.lineY).style("opacity",10<this._nbObs||this.isAreaChart()||o?.01:1),s.exit().remove(),s=this._elements.lineCircles=this._elements.lineContainers.selectAll("circle"),n._def_o.colf_a&&s.style("fill",function(t,e){var i=d3.select(this.parentNode).attr("class").split(" ").pop().substr(5);return n._def_o.colf_a[+i]}),s.on("mouseover",t.mouseover).on("mouseout",t.mouseout).on("mousemove",t.mousemove)},destroy:function(){this._super(),this._elements.lineCircles&&this._elements.lineCircles.transition().duration(this._timing).style("opacity",0)}}),GCO5.view.component.PieChart=GCO5.view.component.AChart.extend({statics:{NAME:"GCO5.view.component.PieChart"},_isConfig:null,_color:null,_pieLayout:null,newSetOfData:null,dataString:null,_type:"pie",nbSlices:null,nbSlices0:null,initialize:function(t){this._super(t),this._zIndex=5,this._selector="g.pie",this._insertBefore=this._getInsertionPoint(),this.nbSlices0=0,this._color=d3.scaleOrdinal(d3.schemeCategory20),this.setup()},setup:function(t){},_filterFn:function(t){var e=this._d3Chart,i=e._getYVar();return"_TOT_"!=t[e._getCVar()]&&!GCO5.core.GcMathUtil.isNumericInvalid(t[i])&&t[i]>GCO5.model.dashboard.GcDatavizModel.EPSILON},enter:function(e){var i=this,n=(this._super(),this),t=this._d3Chart,r=t._getYVar(),a=t._getCVar(),s=t.getSeriesData(),o=t.getChartGroup(),l=t.getOptions(),c=this._callbacks,h=t._metrics,d="",l=(this._pieLayout=d3.pie().sort(null).value(function(t){return d+=t[r],t[r]}),"center"==l.align),u=2*h.containerPadding,p=t.getChartContainerWidth()-u,t=t.getChartContainerHeight()-u,u=(p-h.legendLeftPadding-h.legendWidth)/2,g=(h.pieRadius=Math.min(t/2,u),l?u:h.pieRadius),f=l?t/2:h.pieRadius,p=o.selectAll(this._selector+e).data(s,function(t){return t.className}).join(function(t){return t.insert("g",i._insertBefore).attr("data-index",i._zIndex).style("opacity",0).attr("class",function(t){return GCO5.core.GcArrayUtil.getDistinctValues((e+t.className).split(".")).join(" ")+" pie "}).attr("transform","translate(".concat(g,", ").concat(f,")"))},function(t){return t},function(t){return t.call(function(t){return t.transition(i._timing).style("opacity",0).remove()})}),u=p.selectAll("path").data(function(t){return n._pieLayout(t.chartData.filter(n._filterFn,n))},function(t){return t.data[a]}).join(function(t){return t.append("path").attr("stroke","#cccccc")},function(t){return t},function(t){return t.call(function(t){return t.transition(i._timing).style("opacity",0).remove()})}).attr("fill",function(t,e){return n._color(t.data[a])});d!=this.dataString?(this.dataString=d,this.newSetOfData=!0):this.newSetOfData=!1,p.on("mouseover",c.mouseover).on("mouseout",c.mouseout).on("mousemove",c.mousemove),(l=o.selectAll("g.pie.centerGroup").data([[]]).enter().append("g").attr("class","pie centerGroup").attr("transform","translate( ".concat(g,", ").concat(f," )"))).append("text").attr("class","label pie-center-text").append("tspan").attr("x",0).attr("dy",-10).text(n.gclg.getString("TOTAL")),l.selectAll(".label").append("tspan").attr("class","total").attr("x",0).attr("dy",18),this.addLegend(),this._elements.pieGroup=p,this._elements.slices=u,this._elements.centerGroup=o.selectAll("g.pie.centerGroup"),this._elements.legendGroup=o.selectAll(".pie.legendGroup"),this._elements.pieGroup.style("pointer-events","auto")},addLegend:function(){var e=this,t=this._d3Chart,i=t._getXVar(),n=t._getYVar(),r=t._getCVar(),a=t.getChartGroup(),s=t._metrics,o=t.getSeriesData(),l=t._def_o.colf_a,c=t._def_o.colf_o,h=o[0].chartData.filter(this._filterFn,this).reduce(function(t,e){return t.concat(e[r])},[]),l=c?h.map(function(t){return c[t]}):l.concat();this._color.domain(h).range(l);var h="center"==t.getOptions().align,l=2*s.containerPadding,d=t.getChartContainerWidth()-l,t=t.getChartContainerHeight()-l-s.paddingBottom,l=(d-s.legendLeftPadding-s.legendWidth)/2,d=h?l:s.pieRadius,l=(h?t/2:s.pieRadius)-s.legendHeight/2,h=d+s.pieRadius+s.legendLeftPadding,u=(this.totValue=o[0].chartData.filter(this._filterFn,this).reduce(function(t,e){return t+e[n]},0),a.selectAll("g.pie.legendGroup").data([[]]).enter().append("g").attr("class","pie legendGroup").attr("transform","translate(".concat(h,", ").concat(l,")")),1==this._d3Chart.getDef("display_numbers")),t=(a.selectAll("g.pie.legendGroup").selectAll("g").data(o[0].chartData.filter(this._filterFn,this),function(t){return JSON.stringify(t)}).join(function(t){return t.append("g").attr("transform",function(t,e){return"translate(0, ".concat(15*e,")")}).each(function(){d3.select(this).append("rect").attr("width",18).attr("height",13).attr("stroke","#cccccc").style("fill",function(t){return e._color?e._color(t[r]):"#f00"}),d3.select(this).append("text").attr("x",23).attr("y",7).attr("dy",".35em").attr("class","pie-legend-text").text(function(t){return t[i]+(u?" (".concat(e.gclg.formatNumber(100*t[n]/e.totValue,1,!0)," %)"):"")})})}),GCO5.core.GcObjectUtil.getSVGElementBbox(a.select(".pie.legendGroup").node()));s.legendWidth=t.width,s.legendHeight=t.height,this._elements.legendGroup=a.selectAll("g.pie.legendGroup")},update:function(){var t,e,i=this,n=this,r=this._d3Chart,a=r._metrics,s=r.getSeriesData(),o=s[0].chartData.filter(this._filterFn,this).length,l=r.getOptions(),c=0,h=s[0].isInvalid,s=h?s[0].isInvalidReason:"OTHER";if(h)e=t=0;else{try{u=this._elements.legendGroup.node().getBBox()}catch(t){u=GCO5.core.GcObjectUtil.getSVGElementBbox(this._elements.legendGroup.node())}t=(u=0==u.width?GCO5.core.GcObjectUtil.getSVGElementBbox(this._elements.legendGroup.node()):u).width,e=u.height}a.paddingBottom=0;var d,u="center"==l.align,p=2*a.containerPadding,g=r.getChartContainerWidth()-p,p=r.getChartContainerHeight()-p-a.paddingBottom,f=(g-a.legendLeftPadding-t)/2,f=(a.pieRadius=Math.min(p/2,f),a.pieRadius<80&&(d=!0,a.pieRadius=Math.min(p/2,g/2,(p-e-10)/2)),u?f:a.pieRadius),u=u?p/2:a.pieRadius,m=u-e/2,_=f+a.pieRadius+a.legendLeftPadding,v=(d&&(f=g/2,u="center"!=l.align?a.pieRadius:p/2-(e+a.legendTopPadding)/2,_=Math.max(0,(g-t)/2),m=u+a.pieRadius+a.legendTopPadding,a.paddingBottom+=e+a.legendTopPadding),d3.arc().innerRadius(.5*a.pieRadius).outerRadius(a.pieRadius));this._elements.pieGroup.transition().duration(this._timing).attr("transform","translate(".concat(f,", ").concat(u,")")).style("opacity",1),this._elements.centerGroup.transition().duration(this._timing).style("opacity",1).attr("transform","translate(".concat(f,", ").concat(u+5,")")),this._elements.legendGroup.transition().duration(this._timing).style("opacity",1).attr("transform","translate(".concat(_,", ").concat(m,")")),o=0,this._elements.slices.each(function(t){0<t.value&&o++,t.data&&t.data.hasOwnProperty("_TOTVARS_")?c=t.data._TOTVARS_:c+=t.value}),o==this.nbSlices0?this.newSetOfData?this._elements.slices.attr("stroke-opacity",function(t){return t.data.v<1?0:1}).transition().duration(this._timing).attrTween("d",function(t){this._current||(this._current=GCO5.core.GcObjectUtil.cloneJson(t));var e=d3.interpolate(this._current,t);return this._current=e(0),function(t){return v(e(t))}}):this._elements.slices.transition().duration(this._timing).attr("d",v).attr("stroke-opacity",function(t){return t.data.v<1?0:1}):this._elements.slices.attr("d",v).each(function(t){i._current=t}),c<.001||h?(this._elements.centerGroup.selectAll(".pie-center-text tspan").each(function(){d3.select(this).text(n.gclg.getString("NOGRAPH"))}),l="",l=s===GCO5.model.dashboard.GcDatavizModel.INVALID_REASON_STR.ZERODATA?this.gclg.getString("NOGRAPH_REASON_NODATA"):s===GCO5.model.dashboard.GcDatavizModel.INVALID_REASON_STR.SECRET?this.gclg.getString("NOGRAPH_REASON_SECRET"):this.gclg.getString("NOGRAPH_REASON_OTHER"),this._elements.centerGroup.selectAll(".total").text(l).style("display","block"),this._elements.legendGroup.style("display","none")):(this._elements.centerGroup.selectAll(".pie-center-text tspan").each(function(){d3.select(this).text(n.gclg.getString("TOTAL"))}),this._elements.centerGroup.selectAll(".total").text(n.gclg.formatNumber(c,0,!0)).style("display","block"),this._elements.legendGroup.style("display","block")),this._elements.pieGroup.style("display",c<.001||h?"none":"block"),this.nbSlices=o,this.nbSlices0=o,this._styleSerieGroup(f+(d?0:(t+a.legendTopPadding)/2),r.getChartContainerHeight()-2*a.containerPadding-12)},exit:function(){},destroy:function(){this._elements.pieGroup.style("pointer-events","none"),this._elements.pieGroup.transition().duration(this._timing).style("opacity",0),this._elements.centerGroup.transition().duration(this._timing).style("opacity",0),this._elements.legendGroup.transition().duration(this._timing).style("opacity",0),this.newSetOfData=this.dataString=null,this._super()}}),GCO5.view.component.Pie2Chart=GCO5.view.component.AChart.extend({statics:{NAME:"GCO5.view.component.Pie2Chart"},_isConfig:null,_color:null,_pieLayout:null,newSetOfData:null,dataString:null,_type:"pie2",nbSlices:null,nbSlices0:0,initialize:function(t){this._super(t),this._zIndex=8,this._selector="g.pie2",this._insertBefore=this._getInsertionPoint(),this.setup()},setup:function(t){},enter:function(i){this._super();function e(t){return"_TOT_"!=t[a]&&!GCO5.core.GcMathUtil.isNumericInvalid(t[r])}var n=this,t=this._d3Chart,r=t._getYVar(),a=t._getCVar(),s=t.getSeriesData(),o=t.getChartGroup(),l=t.getOptions(),c=this._callbacks,h=t._def_o.colf_a,d=t._def_o.colf_o,u=t._metrics,p=s[0].chartData.filter(e).reduce(function(t,e){return t.concat(e[a])},[]);if(d)for(var g=[],f=0;f<p.length;f++)g.push(d[p[f]]);else g=h.concat();this._color=d3.scaleOrdinal(d3.schemeCategory20),this._color.domain(p).range(g);var m="",h=(this._pieLayout=d3.pie().sort(null).value(function(t){return m+=t[r],t[r]}),t.getChartContainerWidth()-2*u.containerPadding),_=t.getChartContainerHeight()-2*u.containerPadding-20,v=(400<=t.getChartContainerHeight()?u.pieRadius=Math.min((_-u.legendHeight)/2,h/2):u.pieRadius=Math.min(_/2,(h-u.legendLeftPadding-u.legendWidth)/2),"center"==l.align?(h-u.legendLeftPadding-u.legendWidth)/2:u.pieRadius),y=("center"==l.align?_/2:u.pieRadius)+20,l=(400<=t.getChartContainerHeight()&&(y=u.pieRadius),(h=o.selectAll(this._selector+i).data(s,function(t){return t.className})).exit().transition().duration(this._timing).style("opacity",0).remove(),h.enter().insert("g",this._insertBefore).attr("data-index",this._zIndex).style("opacity",0).attr("class",function(t,e){return GCO5.core.GcArrayUtil.getDistinctValues((i+t.className).split(".")).join(" ")+" pie2 "}).attr("transform",function(t,e){return"translate("+(v+200*e)+","+y+")"}).merge(h)),t=((_=l.selectAll("path").data(function(t){return n._pieLayout(t.chartData.filter(e))},function(t){return t.data[a]})).exit().transition().duration(this._timing).style("opacity",0).remove(),m!=this.dataString?(this.dataString=m,this.newSetOfData=!0):this.newSetOfData=!1,l.on("mouseover",c.mouseover).on("mouseout",c.mouseout).on("mousemove",c.mousemove),_.enter().append("path").attr("stroke","#cccccc").merge(_).attr("fill",function(t,e){return n._color(t.data[a])}));(h=o.selectAll("g.pie2.centerGroup").data([0,1]).enter().append("g").attr("class","pie2 centerGroup").attr("transform",function(t,e){return"translate("+(u.paddingLeft+u.pieRadius)+","+(u.paddingTop+u.pieRadius+5)+")"})).append("text").attr("class","label pie-center-text").append("tspan").attr("class","TOTAL").attr("x",0).attr("dy",-10).text(n.gclg.getString("TOTAL")),h.selectAll(".label").append("tspan").attr("class","total").attr("x",0).attr("dy",18),o.selectAll("g.pie2.titleGroup").data(s.filter(function(t){return""!=t.label}),function(t){return t.className}).enter().append("g").attr("class","pie2 titleGroup").attr("transform",function(t,e){return"translate("+(u.paddingLeft+u.pieRadius)+","+(u.paddingTop+u.pieRadius+5)+")"}).append("text").attr("class","pie-title-text").attr("x",0).attr("dy","-10"),this.addLegend(),this._elements.pieGroup=l,this._elements.slices=t,this._elements.centerGroup=o.selectAll("g.pie2.centerGroup"),this._elements.titleGroup=o.selectAll("g.pie2.titleGroup"),this._elements.legend=o.selectAll(".pie2.legendGroup"),this._elements.pieGroup.style("pointer-events","auto")},addLegend:function(){var e=this,t=this._d3Chart,i=t._getXVar(),n=t._getCVar(),r=t.getSeriesData(),a=t.getChartGroup(),t=t._metrics,s=(a.selectAll(e._selector+".legendGroup").remove(),t.paddingLeft+2*t.pieRadius+10),r=a.append("g").attr("class","pie2 legendGroup").attr("transform",function(t,e){return"translate("+s+",0)"}).selectAll("g").data(r[0].chartData.filter(function(t){return"_TOT_"!=t[n]})).enter().append("g").attr("transform",function(t,e){return"translate(0,"+15*e+")"}),r=(r.append("rect").attr("width",18).attr("height",13).attr("stroke","#cccccc"),a.selectAll(".pie2.legendGroup rect").style("fill",function(t){return e._color?e._color(t[n]):"#f00"}),r.append("text").attr("x",23).attr("y",7).attr("dy",".35em").attr("class","pie-legend-text").text(function(t){return t[i]}),GCO5.core.GcObjectUtil.getSVGElementBbox(a.select(".pie2.legendGroup").node()));t.legendWidth=r.width,t.legendHeight=r.height,this._elements.legend=a.selectAll(".pie2.legendGroup")},update:function(){var t,i,e,n,r,a,s=this,o=this._d3Chart,l=o._metrics,c=o.getSeriesData(),h=o._getCVar(),d=c[0].chartData.filter(function(t){return"_TOT_"!=t[h]}).length,u=o.getPieLayout(),p=c.every(function(t){return t.isInvalid}),g=[],f=(c.forEach(function(t,e){var i=0;t.label=t.label.split("|").join(" "),t.isInvalid?i=GCO5.core.GcMathUtil.SPECIFIC_VALUE.NODATA:t.chartData.forEach(function(t){"_TOT_"!=t.X&&(i+=t.Y)}),g.push(i)}),p?0:l.legendWidth),m=p?0:l.legendHeight,_=(l.pieRadius=u.radius,o.getChartContainerWidth()-2*l.containerPadding),v=o.getChartContainerHeight()-2*l.containerPadding-l.paddingBottom-l.titleHeight,y=[20,20],b=(a=1==u.nbLines?(i=[_/2-(t=.5*f+l.pieRadius+l.elementsPadding),_/2+t],n=[e=v/2+l.titleHeight,e],r=_/2-.5*f,e-m/2):3==u.nbLines?(t=l.pieRadius+l.elementsPadding,i=[_/2,_/2],y=[20,(n=[l.pieRadius+l.titleHeight,3*l.pieRadius+2*l.titleHeight+l.elementsPadding])[0]+l.pieRadius+20+l.elementsPadding],r=_/2-.5*f,n[1]+l.pieRadius+l.elementsPadding):(i=[_/2-(t=l.pieRadius+l.elementsPadding),_/2+t],n=[e=l.pieRadius+l.titleHeight,e],r=_/2-.5*f,e+l.pieRadius+l.elementsPadding),d3.arc().innerRadius(.5*l.pieRadius).outerRadius(l.pieRadius)),C=(this._elements.centerGroup.transition().duration(this._timing).style("opacity",1).attr("transform",function(t,e){return"translate("+i[e]+","+(n[e]+5)+")"}),this._elements.titleGroup.transition().duration(this._timing).style("opacity",1).attr("transform",function(t,e){return"translate("+i[e]+","+y[e]+")"}),this._elements.legend.attr("transform",function(t,e){return"translate("+r+","+a+")"}),d=0,this._elements.slices.each(function(t){0<t.value&&d++}),d==this.nbSlices0?this.newSetOfData?this._elements.slices.attr("stroke-opacity",function(t,e){return t.data.v<1?0:1}).transition().duration(this._timing).attrTween("d",function(t){this._current||(this._current=GCO5.core.GcObjectUtil.cloneJson(t));var e=d3.interpolate(this._current,t);return this._current=e(0),function(t){return b(e(t))}}):this._elements.slices.transition().duration(this._timing).attr("d",b).attr("stroke-opacity",function(t,e){return t.data.v<1?0:1}):this._elements.slices.attr("d",b).each(function(t,e){this._current=t}),this._elements.pieGroup.transition().duration(this._timing).attr("transform",function(t,e){return"translate("+i[e]+","+n[e]+")"}).style("opacity",function(t,e){return g[e]<.001?0:1}),this._elements.pieGroup.each(function(t,e){d3.select(this).style("display",c[e].isInvalid||g[e]<.001?"none":"block")}),p&&this._elements.legend.style("display","none"),this._elements.centerGroup.selectAll(".total").each(function(t){t=c[t].isInvalid?c[t].isInvalidReason===GCO5.model.dashboard.GcDatavizModel.INVALID_REASON_STR.ZERODATA?s.gclg.getString("NOGRAPH_REASON_NODATA"):c[t].isInvalidReason===GCO5.model.dashboard.GcDatavizModel.INVALID_REASON_STR.SECRET?s.gclg.getString("NOGRAPH_REASON_SECRET"):s.gclg.getString("NOGRAPH_REASON_OTHER"):g[t]<.001?s.gclg.getString("NOGRAPH_REASON_NODATA"):s.gclg.formatNumber(g[t],0,!0);d3.select(this).text(t)}),this._elements.centerGroup.selectAll(".TOTAL").each(function(t){t=g[t]<.001||c[t].isInvalid?s.gclg.getString("NOGRAPH"):s.gclg.getString("TOTAL");d3.select(this).text(t)}),0);this._elements.titleGroup.selectAll("text").text(function(){return c[C++].label}).call(this.wrap2Lines,2*l.pieRadius+30,-7,"xchart pie-title-text",!0),this.nbSlices=d,this.nbSlices0=d,this._styleSerieGroup(_/2,o.getChartContainerHeight()-2*l.containerPadding-12)},wrap2Lines:function(t,h,d,u,p){d=d||0,t.each(function(){var t=" ",e=d3.select(this),i=e.text().split(/\s+/).reverse(),n=0;if(1!=i.length||(p&&(i=e.text().split("-").reverse(),t="-"),1!=i.length)){for(var r,a=[],s=0,o=e.attr("y"),l=parseFloat(e.attr("dy")),c=e.text(null).append("tspan").attr("x",0).attr("y",o).attr("dy",l+d+"");r=i.pop();)a.push(r),c.text(a.join(t)),GCO5.core.GcObjectUtil.getSVGElementBbox(c.node(),u).width>h&&(n++,a.pop(),c.text(a.join(t)+t),a=[r],c=e.append("tspan").attr("x",0).attr("y",o).attr("dy",13*++s).text(r));n||c.attr("dy","-10")}})},exit:function(){},destroy:function(){this._elements.pieGroup.style("pointer-events","none"),this._elements.pieGroup.transition().duration(this._timing).style("opacity",0),this._elements.centerGroup.transition().duration(this._timing).style("opacity",0),this._elements.legend.transition().duration(this._timing).style("opacity",0),this._elements.serieGroup&&this._elements.serieGroup.remove(),this.newSetOfData=this.dataString=null,this._super()}}),GCO5.view.component.PyrChart=GCO5.view.component.AChart.extend({statics:{NAME:"GCO5.view.component.PyrChart"},_isConfig:null,_type:"pyr",initialize:function(t){this._super(t),this._zIndex=6,this._selector="g.pyr",this._insertBefore=this._getInsertionPoint(),this.setup()},setup:function(){},postUpdateScale:function(t,e,i){},enter:function(i){this._super();(new Date).getTime();var n=this,r=this._d3Chart,e=(r.getXScale(),r.getYScale()),a=(r._getXVar(),r._getX2Var(),r._getYVar()),s=r.getXZero(),t=(r._def_o.colf_a,r.getSeriesData()),o=r.getChartGroup(),l=r._metrics,c=this._callbacks,h=r._def_o.blocvar_a,d=this.gclg,u=o.selectAll(this._selector+"H").data(t,function(t){return t.className+"H"});u.enter().insert("g",this._insertBefore).attr("data-index",this._zIndex).style("opacity",0).attr("class",function(t,e){return GCO5.core.GcArrayUtil.getDistinctValues((i+t.className).split(".")).join(" ")+" pyrH "+n._getColorClass(this,e)}).attr("transform",function(t,e){return"translate("+(l.axisPaddingLeft+r.getChartScalesWidth()+l.paddingCenter)+",0)"}),(u=o.selectAll(this._selector+"H")).selectAll("rect").data(function(t){return t.chartData},function(t){return t[a]}).enter().append("rect").attr("class",function(t,e){d3.select(this.parentNode).attr("class").split(" ").pop();return"chart-fill chart-fill-men"}).attr("width",0).attr("y",function(t){return e(t[a])}).attr("width",function(t){return 0}).attr("x",function(t){return s}).on("mouseover",c.mouseover).on("mousemove",c.mousemove).on("mouseout",c.mouseout).on("click",c.click),(t=o.selectAll(this._selector+"F").data(t,function(t){return t.className+"F"})).enter().insert("g",this._insertBefore).attr("data-index",this._zIndex).style("opacity",0).attr("class",function(t,e){return GCO5.core.GcArrayUtil.getDistinctValues((i+t.className).split(".")).join(" ")+" pyrF "+n._getColorClass(this,e+1)}).attr("transform",function(t,e){return"translate(0,0)"});var p=(t=o.selectAll(this._selector+"F")).selectAll("rect").data(function(t){return t.chartData},function(t){return t[a]}),g=r.getChartScalesWidth()-10,p=(p.enter().append("rect").attr("class",function(t,e){d3.select(this.parentNode).attr("class").split(" ").pop();return"chart-fill chart-fill-women"}).attr("width",0).attr("y",function(t){return e(t[a])}).attr("x",g).on("mouseover",c.mouseover).on("mousemove",c.mousemove).on("mouseout",c.mouseout).on("click",c.click),o.selectAll("g.pyr.sexGroup").data([[]]).enter().append("g").attr("class","pyr sexGroup"));p.append("text").attr("class","pyr-sex-text label women").attr("x",-l.axisPaddingLeft+r.getChartScalesWidth()).attr("dy",10+l.axisPaddingTop).attr("text-anchor","end").text(h&&2==h.length?h[0].c_lib_court:d.getString("WOMEN","report")),p.append("text").attr("class","pyr-sex-text label men").attr("x",-l.axisPaddingLeft+r.getChartScalesWidth()+l.paddingCenter).attr("dy",10+l.axisPaddingTop).text(h&&2==h.length?h[1].c_lib_court:d.getString("MEN","report")),this._elements.sexGroup=o.selectAll("g.pyr.sexGroup"),this._elements.pyrGroupsH=u,this._elements.pyrH=u.selectAll("rect"),this._elements.pyrGroupsF=t,this._elements.pyrF=t.selectAll("rect"),this._elements.pyrH.style("pointer-events","auto"),this._elements.pyrF.style("pointer-events","auto"),r._def_o.colf_a&&2<=r._def_o.colf_a.length&&(this._elements.pyrF.style("fill",function(t,e){return r._def_o.colf_a[0]}),this._elements.pyrH.style("fill",function(t,e){return r._def_o.colf_a[1]})),u.on("mouseover",c.mouseover).on("mouseout",c.mouseout).on("mousemove",c.mousemove),t.on("mouseover",c.mouseover).on("mouseout",c.mouseout).on("mousemove",c.mousemove)},update:function(){var i=this,t=this._d3Chart,e=t.getXScale(),n=t.getYScale(),r=t._getXVar(),a=t._getX2Var(),s=t._getYVar(),o=t.getXZero(),l=(t.getYZero(),t.getSeriesData(),t.getDefs(),t._metrics),c=t.getChartScalesWidth();this._elements.pyrGroupsH.attr("class",function(t,e){return i._getColorClass(this,e)}).transition().duration(this._timing).style("opacity",1).attr("transform",function(t,e){return"translate("+(l.axisPaddingLeft+c+l.paddingCenter)+",0)"}),this._elements.pyrH.transition().duration(this._timing).attr("height",n.bandwidth()).attr("y",function(t){return n(t[s])}).attr("width",function(t){return GCO5.core.GcMathUtil.isNumericInvalid(t[r])?0:Math.abs(e(t[r]))}).attr("x",function(t){return o}),this._elements.pyrGroupsF.attr("class",function(t,e){return i._getColorClass(this,e+1)}).transition().duration(this._timing).style("opacity",1).attr("transform",function(t,e){return"translate("+l.axisPaddingLeft+",0)"}),this._elements.pyrF.transition().duration(this._timing).attr("height",n.bandwidth()).attr("y",function(t){return n(t[s])}).attr("width",function(t){return GCO5.core.GcMathUtil.isNumericInvalid(t[a])?0:Math.abs(e(t[a]))}).attr("x",function(t){return c-e(t[a])}),this._elements.sexGroup.transition().duration(this._timing).attr("transform",function(t,e){return"translate("+l.axisPaddingLeft+","+-l.paddingTop+")"}),this._elements.sexGroup.select(".pyr .women").transition().duration(this._timing).attr("x",c).attr("dy",-10+l.paddingTop).attr("text-anchor","end"),this._elements.sexGroup.select(".pyr .men").transition().duration(this._timing).attr("x",c+l.paddingCenter).attr("dy",-10+l.paddingTop),this._styleSerieGroup(l.axisPaddingLeft+c+l.paddingCenter/2,l.axisPaddingTop+t.getChartScalesHeight()+l.axisPaddingBottom+30)},exit:function(){},destroy:function(){this._elements.pyrH.style("pointer-events","none"),this._elements.pyrF.style("pointer-events","none"),this._elements.pyrH.transition().duration(this._timing).attr("height",0).remove(),this._elements.pyrF.transition().duration(this._timing).attr("height",0).remove(),this._elements.serieGroup&&this._elements.serieGroup.remove(),this._elements.sexGroup&&this._elements.sexGroup.remove(),this._super()}}),GCO5.view.component.D3SpineChart=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.D3SpineChart",REDUCEDWIDTH:700},_def_o:null,inited:!1,_d3Container:null,_emptyData:[[]],_svg:null,_enlargeWidthForPrint:0,_exportMode:null,_rows:null,_legendData:null,_callbacks:null,_d3ChartContainer:null,_$blocContainer:null,gclg:null,_defaults:{chartOuterHeight:function(){var t=parseFloat($("svg",this.get$ChartContainer()).css("padding"))||10;return Math.max(0,this.get$ChartContainer().innerHeight()-2*t)},chartOuterWidth:function(){var t=parseFloat($("svg",this.get$ChartContainer()).css("padding"))||10;return this.get$ChartContainer().innerWidth()-t}},_colf_a:["#3c6","#fc0","#f00"],initialize:function(t,e,i){if(e){i=i||{},this._options=GCO5.core.GcObjectUtil.defaults(i||{},this._defaults),this.gclg=GCO5.core.GcLangManager.getInstance(),this._$blocContainer=t;t=this._$blocContainer.find(".spineChart");if(this._d3ChartContainer=i.fullHTML?null:d3.select(t.get(0)),this._$blocContainer||this._d3ChartContainer){for(var n in(this._def_o=e).data)e.data[n].enabled=!0;this.buildSvgStructure(!0),this._addListeners(),this.enter(e)}else console.error("erreur : pas de container")}else console.error("erreur : pas de données")},_addListeners:function(){var r,a,s=this._def_o,o=(this._options,this),l=$(".chart-tooltip",this.get$ChartContainer()),c=$(".chart-tooltip-container",l);this._callbacks={mouseover:function(t){l.show(),r=d3.select(this),a=r.datum();for(var e=s.tooltip.call(r,a),i="<table><caption style='color:black;text-transform: uppercase'>"+e.caption+"</caption>",n=0;n<e.row_a.length;n++)i+="<tr> <th>"+(e.row_a[n].th||"")+"</th> <td>"+e.row_a[n].td+"</td> </tr>";c.html(i+="</table>"),r.select(".g-spine-background").style("fill","#f0f0f0")},mouseout:function(){l.hide(),(r=d3.select(this)).select(".g-spine-background").style("fill","none")},mousemove:function(){var t=o.get$ChartContainer().offset().top,e=o.get$ChartContainer().offset().left,t="auto"==t?0:parseFloat(t),e="auto"==e?0:parseFloat(e),i=d3.mouse(d3.select("body").node()),n=0,r=0;i[1]+30+l.height()>GCO5.browser.height&&(r=l.height()+50),i[0]+l.width()>GCO5.browser.width&&(n=i[0]+l.width()-GCO5.browser.width+10),l.css({top:i[1]-t+30-r+"px",left:i[0]-e-n+"px","z-index":100})}}},getD3ChartContainer:function(){return this._d3ChartContainer},get$ChartContainer:function(){return this._d3ChartContainer?$(this._d3ChartContainer.node()):null},get$BlocContainer:function(){return this._$blocContainer},getChartContainerWidth:function(){var t=this._svg?$(this._svg.node()):null,e=this._options.chartOuterWidth?this._options.chartOuterWidth.apply(this):this.get$ChartContainer().height();return t&&t.show(),e},getChartContainerHeight:function(){var t=this._svg?$(this._svg.node()):null,e=this._options.chartOuterHeight?this._options.chartOuterHeight.apply(this):this.get$ChartContainer().height();return t&&t.show(),e},buildSvgStructure:function(t,e,i){var e=e||this.getChartContainerWidth(),i=i||this.getChartContainerHeight(),n=(this._options,e<GCO5.view.component.D3SpineChart.REDUCEDWIDTH),r=this.getD3ChartContainer(),a=this.get$BlocContainer();isNaN(e)||(a.attr("id").split("|").join("_"),(a=r.selectAll("svg")).selectAll("*").remove(),r.selectAll("svg").data(this._emptyData).enter().append("svg"),r.selectAll("svg").attr("height",i).attr("width",e).attr("class","xchart").append("svg:clipPath").attr("id","g-clip-cell").append("svg:rect").attr("width",300).attr("height",21),this._svg=a=r.selectAll("svg"),a.append("svg:linearGradient").attr("id","g-clip-gradient").attr("y2","0%").append("svg:stop").attr("offset","0%").attr("stop-color","#fff").attr("stop-opacity",0),a.selectAll("#g-clip-gradient").append("svg:stop").attr("offset","100%").attr("stop-color","#fff").attr("stop-opacity",1),a.selectAll("g.header").data(this._emptyData).enter().append("g").attr("class","header").selectAll("g.chart-title").data(this._emptyData).enter().append("text").attr("class","chart-title").attr("x",5).attr("dy",20),a.append("g").attr("class","chart").attr("transform","translate(0,0)").append("g").attr("id","g-legend"),a.selectAll(".chart").append("g").attr("class","g-legendchart").attr("transform","translate(0,30)"),a.selectAll(".chart").append("g").attr("id","g-header").attr("transform","translate(0,60)"),a.selectAll(".chart").append("g").attr("id","g-rows").attr("transform","translate(0,"+(n?90:120)+")"),0==$(".chart-tooltip",this.get$ChartContainer()).length&&r.append("div").attr("class","chart-tooltip").append("div").attr("class","chart-tooltip-container"))},_addLegend:function(t,e){var i,n=GCO5.core.GcLangManager.getInstance(),r=this,a=e<GCO5.view.component.D3SpineChart.REDUCEDWIDTH,n=(this._legendData=[{className:"1",enabled:!0,label:n.getString("SBETTER_AVG","report")+" / "+t,color:this._colf_a[0]},{className:"2",enabled:!0,label:n.getString("NOTSDIFF_AVG","report"),color:this._colf_a[1]},{className:"3",enabled:!0,label:n.getString("SWORST_AVG","report")+" / "+t,color:this._colf_a[2]}],this._svg.select("#g-legend").selectAll("g").data(this._legendData,function(t){return t.className}).enter().append("g").attr("class",function(t,e){return"legend  color"+e+(t.enabled?"":" disabled")}).attr("tabindex","0").on("click keyup",function(t,e){"keyup"==d3.event.type&&[13,32].indexOf(d3.event.keyCode)<0||r._filterChart(t,this)})),s=(n.append("svg:title").text("Press to filter table"),n.append("circle").attr("class",function(t,e){return 0<=d3.select(this.parentNode).attr("class").indexOf("disabled")?"chart-fill-disabled":"chart-fill-color"}).attr("stroke","#999").attr("stroke-width","1").attr("cx",0).attr("cy",6).attr("r",6),n.append("text").attr("class","legend-text").attr("x",12).attr("dy",".75em").text(function(t){return t.label}),n.selectAll("circle").attr("class","spine-circle").attr("fill",function(t,e){return t.color}),n.selectAll("text").attr("y",1).attr("fill",function(t,e){return"#000"}),[0]),o=0,l=0,c=0,h=0,d=e||this.getChartContainerWidth(),u={paddingLeft:0,paddingBottom:0},t=(n.each(function(t,e){try{s[e+1]=this.getBBox().width}catch(t){s[e+1]=GCO5.core.GcObjectUtil.getSVGElementBbox(this).width}0==s[e+1]&&(s[e+1]=GCO5.core.GcObjectUtil.getSVGElementBbox(this).width),s[e+1]+=l,o+=s[e+1],c++}).attr("transform",function(t,e){return 0==e?(l=Math.max(10,Math.min((d-o)/(c+1),20)),(i=(d-(c-1)*l-o)/2-u.paddingLeft)<-u.paddingLeft&&(i=10-u.paddingLeft,l+=10)):i+=l+s[e],u.paddingLeft+i+s[e+1]>d&&(i=10-u.paddingLeft,h+=20,u.paddingBottom+=20),"translate("+i+","+String(h)+")"}),this._svg.select("#g-legend").node().getBBox().height);a||this._svg.select("#g-header").attr("transform","translate(0,"+t+")"),this._svg.select("#g-rows").attr("transform","translate(0,"+(a?t+30:t+75-15)+")")},resize:function(){this.buildSvgStructure(!0),this.enter(this._def_o)},_addSpineLeg:function(t,e){var i=t||this.getChartContainerWidth(),n=(GCO5.view.component.D3SpineChart.REDUCEDWIDTH,this._svg.select(".g-legendchart")),r=.5*(i-260),i=(n.attr("transform","translate("+.5*(i-260)+","+e+")"),n.append("g").attr("class","g-graphic"),n.append("g").attr("class","g-text legend-text"),n.selectAll(".g-graphic")),e=n.selectAll(".g-text"),a=(e.append("text").attr("text-anchor","middle").attr("x",210).attr("y",-5).text(this.gclg.getString("AREA_VALUE","report")),e.append("text").attr("text-anchor","middle").attr("x",130).attr("y",-5).text(this._def_o.zonreflib),e.append("text").attr("text-anchor","middle").attr("x",77).attr("y",33).text(this.gclg.getString("PCTL25","report")),e.append("text").attr("text-anchor","middle").attr("x",180).attr("y",33).text(this.gclg.getString("PCTL75","report")),e.append("text").attr("text-anchor","end").attr("x",14).attr("y",15).text(this.gclg.getString("WORST","report")),e.append("text").attr("text-anchor","start").attr("x",260).attr("y",15).text(this.gclg.getString("BEST","report")),e.append("text").attr("text-anchor","start").attr("x",-r).attr("y",50).text(GCO5.appModel.getLegal("tx_copyright_spine")),256-(t=252*(1+2.9/3.3)/2)),s=t/(2.9+3.3),n=(i.append("rect").attr("class","g-bar g-spine-bar-large").attr("fill","#ddd").attr("x",a).attr("width",t).attr("height",20),i.append("rect").attr("class","g-bar g-spine-bar-ci").attr("fill","#bbb").attr("x",function(t){return a+1.6*s}).attr("width",function(t){return 2.7*s}).attr("height",20),i.append("line").attr("class","g-spine-compare").attr("stroke-dasharray","2,2").attr("stroke","#666").attr("transform",function(t){return"translate(130,0)"}).attr("y2",20),this._colf_a);i.append("circle").attr("class","spine-circle").attr("stroke","#999").attr("stroke-width","1").attr("cx",function(t){return a+s*Math.abs(5)}).attr("fill",n[0]).attr("cy",10).attr("r",6)},enter:function(i,t){i=i||this._def_o;function a(t,e){return isNaN(t)||-9999==t||-999999==t||-99999==t?"N/A":p.gclg.formatNumber(t,e,!0)}var t=t||this.getChartContainerWidth(),u=t<GCO5.view.component.D3SpineChart.REDUCEDWIDTH,e=parseFloat($("svg",this.get$ChartContainer()).css("padding"))||10,t=t-2*e,p=this,g=t-130-300-35-5,f=[0,75+g+5,150+g+10,225+g+15,225+g+35,300+g+35+130],s=(u||this._svg.selectAll("#g-clip-cell rect").attr("width",10+g),this._def_o.zonreflib),m=[{name:"INDS",format:null,anchor:"start",tx:0},{name:"VALSEL",format:a,numeric:!0,anchor:"end",tx:f[1]},{name:"VAL0",format:a,numeric:!0,anchor:"end",tx:f[2]},{name:"worstVAL0",format:a,numeric:!0,anchor:"end",tx:f[3]},{name:"VALSEL",format:a,graphic:!0,anchor:"middle",tx:f[4]+65},{name:"bestVAL0",format:a,numeric:!0,anchor:"end",tx:f[5]}],n=((this._def_o.dimensions=m).forEach(function(t,e){t.index=e,t.lib=i.libcols[t.name]}),m[4].lib=this.gclg.getString("SPINE_CHART_HEADER","report"),i.data.length),r=u?110:21,o=this._callbacks,l=(u||(this._svg.select("#g-header").selectAll(".g-spine-column").data(m).enter().append("g").attr("class","g-spine-column").attr("transform",function(t,e){return"translate("+t.tx+",0)"}),this._svg.select("#g-header").selectAll(".g-spine-column").append("text").attr("class","legend-text bold").attr("y",2).attr("dy",".55em").text(function(t){return t.lib}).attr("text-anchor",function(t,e){return t.anchor}),this._svg.selectAll(".g-spine-column text").call(GCO5.core.GcObjectUtil.wrapDelims,"|")),this._addLegend(s,t),this.getTranslateParameters(this._svg.select("#g-rows"))),t=(this._svg.attr("height",Math.ceil(l.y)+n*r+2*e+50+10+28),this._addSpineLeg(t,Math.ceil(l.y)+n*r+e+10+10+10),this._rows=this._svg.select("#g-rows").selectAll(".g-row").data(i.data,function(t){return t.IND})),_=(t.enter().append("g").attr("class","g-row").classed("g-odd",function(t,e){return u&&e%2==1}).attr("transform",function(t,e){return"translate(0,"+e*r+")"}).on("mouseover",o.mouseover).on("mousemove",o.mousemove).on("mouseout",o.mouseout).on("click",o.click).append("rect").attr("class","g-spine-background").style("fill","none").attr("width","100%").attr("height",r),t=this._rows=this._svg.selectAll(".g-row"),0),c={td:p.gclg.getString("SWORST_AVG","report")},h={td:p.gclg.getString("SBETTER_AVG","report")},d={td:p.gclg.getString("NOTSDIFF_AVG","report")},v=p.gclg.getString("P2B");i.tooltip=function(t,e){var i=parseFloat(t.nbdec),n=1==t.highisgood,r=t.VAL0<t.LCL?c:t.VAL0>t.UCL?h:d,n=(n&&(r=t.VAL0<t.LCL?h:t.VAL0>t.UCL?c:d),[]);return n.push({th:p.gclg.getString("SELECTION","concepts"),td:p.gclg.getString("VALUE").toLowerCase()+v+" "+a(t.VALSEL,i)}),n.push({th:p.gclg.getString("SELECTION","concepts"),td:isNaN(t.LCL)?p.gclg.getString("NA","indics"):p.gclg.getString("CI","tables")+" ["+p.gclg.formatNumber(t.LCL,i)+" ; "+p.gclg.formatNumber(t.UCL,i)+"]"}),r.th=p.gclg.getString("SELECTION","concepts"),n.push(r),n.push({th:s,td:p.gclg.getString("VALUE").toLowerCase()+v+" "+a(t.VAL0,i)}),n.push({th:s,td:p.gclg.getString("PCTL25","report").toLowerCase()+v+" "+a(t.PCT25,i)}),n.push({th:s,td:p.gclg.getString("PCTL75","report").toLowerCase()+v+" "+a(t.PCT75,i)}),{caption:t.INDS,row_a:n}},t.each(function(e){var t,i,n=parseFloat(e.nbdec),r=Math.abs(e.VAL0-e.worstVAL0),a=Math.abs(e.bestVAL0-e.VAL0),s=1==e.highisgood,o=d3.select(this).selectAll(".g-cell").data(m).enter().append("g").attr("class","g-cell").attr("text-anchor",function(t){return t.numeric?"end":"start"}).classed("g-spine-quantitative",function(t){return t.numeric}).classed("reduced",function(t){return u}).classed("g-graphic",function(t){return t.graphic}).attr("transform",function(t,e){return u&&t.graphic?"translate(200,25)":"translate("+(u?0:f[e])+","+(u?3+21*Math.min(e,4):0)+")"}),l=o.filter(function(t){return t.graphic&&!isNaN(e[t.name])&&-9999!=e[t.name]&&-99999!=e[t.name]&&-999999!=e[t.name]}),c=(i=a<r?(t=122*(1+a/r)/2,4):126-(t=122*(1+r/a)/2),t/(r+a)),h=e.VAL0-e.PCT25,d=e.PCT75-e.VAL0,r=(e.compci=s?e.VAL0<e.LCL?1:e.VAL0>e.UCL?3:2:e.VAL0<e.LCL?3:e.VAL0>e.UCL?1:2,l.append("rect").attr("class","g-bar g-spine-bar-large").attr("fill","#ddd").attr("x",i).attr("width",t).attr("height",20),l.append("rect").attr("class","g-bar g-spine-bar-ci").attr("fill","#bbb").attr("x",function(t){return i+c*(s?e.PCT25-e.miniVAL0:e.maxiVAL0-e.PCT75)}).attr("width",function(t){return c*(h+d)}).attr("height",20),l.append("line").attr("class","g-spine-compare").attr("stroke-dasharray","2,2").attr("stroke","#666").attr("transform",function(t){return"translate(65,0)"}).attr("y2",20),p._colf_a);l.append("circle").attr("class","spine-circle").attr("stroke","#999").attr("stroke-width","1").attr("cx",function(t){return i+c*Math.abs(e.VALSEL-e.worstVAL0)}).attr("fill",r[e.compci-1]).attr("cy",10).attr("r",6),o.filter(function(t){return!t.graphic}).append("text").attr("class","g-value legend-text").attr("y",10).attr("dy",".35em").text(function(t){return t.format?(u?t.lib.split("|").join(" ")+v+" ":"")+t.format(e[t.name],n):e[t.name]}).each(function(t,e){0==e&&(0==(e=this.getComputedTextLength())&&(e=GCO5.core.GcObjectUtil.getSVGComputedTextLength(this,"g-value")),_=Math.max(_,e))}).classed("bold upc",function(t,e){return 0==e&&u}).attr("x",0).attr("fill","#000").attr("clip-path",function(t,e){if(0==e&&!p._exportMode)return e=this.getComputedTextLength(),t.clipped=g-20<e&&!u,t.clipped&&(_=Math.max(_,e)),t.clipped?"url(#g-clip-cell)":null}),o.filter(function(t){return t.clipped}).append("rect").style("fill","url(#g-clip-gradient)").attr("x",g-10).attr("width",20).attr("height",20)}),this._enlargeWidthForPrint=_?_-g:0,this._inited=!0,GCO5.core.GcDelayUtil.callLater(this._testScrollbarV,[],0,this)},_testScrollbarV:function(t,e){this.getChartContainerWidth()<parseFloat($("svg",this.get$ChartContainer()).attr("width"))-5&&this.resize()},_filterChart:function(i,t){var n=!0,r=this,a=(this._legendData.forEach(function(t,e){t!==i&&(t.enabled=!!i.enabled&&!t.enabled)}),i.enabled=!0,[]),s=(this._legendData.forEach(function(t,e){t.enabled||(n=!1),a.push(Number(t.enabled))}),this._svg.select("#g-legend").selectAll("circle").attr("fill",function(t,e){return r._legendData[e].enabled?r._colf_a[e]:"#ccc"}),this.getChartContainerWidth()<GCO5.view.component.D3SpineChart.REDUCEDWIDTH),o=s?110:21,e=this._def_o.data.filter(function(t){return n||t.compci==i.className}),l=this._rows.data(e,function(t){return t.IND}),l=(l.exit().transition(1e3).style("opacity",0).transition(0).attr("transform","translate(0,-200)"),l.classed("g-odd",function(t,e){return s&&e%2==1}).transition().duration(1e3).delay(600).style("opacity",1).attr("transform",function(t,e){return"translate(0,"+e*o+")"}),e.length),o=s?110:21,e=this.getTranslateParameters(this._svg.select("#g-rows")),c=parseFloat($("svg",this.get$ChartContainer()).css("padding"))||10,h=(this._svg.transition().duration(1e3).delay(600).attr("height",Math.ceil(e.y)+l*o+2*c+50+10+28),this.getChartContainerWidth());this._svg.select(".g-legendchart").transition().duration(1e3).delay(600).attr("transform","translate("+.5*(h-260)+","+(Math.ceil(e.y)+l*o+c+10+10+10)+")")},getTranslateParameters:function(t){t=t.attr("transform"),t=/translate\(\s*([^\s,)]+)[ ,]([^\s,)]+)/.exec(t);return{x:t[1],y:t[2]}},exportChart:function(t,n,r){GCO5.core.GcLangManager.getInstance();var a=document.createElement("canvas"),s=this;if("csv"==(n=n.toLowerCase())||"html"==n)try{s.exportChartData(t,n,r)}catch(t){alert(t.message)}else this.beforePrint(t),svgAsDataUri(this._svg.node(),1,function(t,e){if("svg"==n)return GCO5.browser.isIOS,localStorage.expimg="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e),window.open("GC_exportImg.php?lang="+GCO5.appModel.getLang()+"&fmt=svg"),void s.afterPrint();canvg(a,e,{ignoreClear:!0});var e=document.createElement("canvas"),i=(e.width=a.width+20,e.height=a.height+30,e.getContext("2d"));i.fillStyle="#ffffff",i.fillRect(0,0,e.width,e.height),i.drawImage(a,10,10),GCO5.core.GcBitmapUtil.exportCanvas(e,"chart.png",r),GCO5.core.GcBitmapUtil.dropCanvas(a),GCO5.core.GcBitmapUtil.dropCanvas(e),s.afterPrint()})},exportChartData:function(t,e,i){for(var n=GCO5.core.GcLangManager.getInstance(),r="html"==e?"##":n.get_delim_csv(),a=new Array,s=new Array,o=new Array,l=this._def_o.dimensions.concat([{name:"PCT25",lib:this._def_o.zonreflib+" "+n.getString("PCTL25","report")},{name:"PCT75",lib:this._def_o.zonreflib+" "+n.getString("PCTL75","report")},{name:"LCL",lib:n.getString("SELECTION","concepts")+" "+n.getString("LCL_CI","indics")},{name:"UCL",lib:n.getString("SELECTION","concepts")+" "+n.getString("UCL_CI","indics")}]),c=l.length,h=this._def_o.data.length,d="",u=0;u<c;u++)d+=r;for(var p,g="csv"==e?'"':"",f=(a.push(g+t.title+g+d),a.push(g+t.libZone+g+d),t.subTitle&&a.push(g+t.subTitle+g+d),[]),u=0;u<c;u++)4!=u&&(p=l[u],f.push(p.lib.split("|").join("csv"==e?" ":"<br>")));s.push(g+f.join(g+r+g)+g);for(var m,_=0;_<h;_++){var f=[],v=this._def_o.data[_];f.push(g+v[l[0].name]+g);for(u=1;u<c;u++)4!=u&&("csv"==e?f.push(v[l[u].name]):f.push(n.formatNumber(v[l[u].name],v.nbdec||0,!0)));s.push(f.join(r)+"")}"html"==e?(m=GCO5.core.GcArrayUtil.csvToHTML(r,a,s,o),localStorage.expimg=m,window.open("GC_exportImg.php?lang="+GCO5.appModel.getLang()+"&fmt=html&ios="+GCO5.browser.isIOS)):(m=a.concat(s).concat(o).join("\r\n"),GCO5.core.ClientInfo.getInstance().exportBlob(m,"data.csv","text",i))},beforePrint:function(t){this._exportMode=!0;var e=this.getChartContainerWidth()+this._enlargeWidthForPrint;this.buildSvgStructure(!0,e),this.enter(this._def_o,e)},afterPrint:function(){this._exportMode=!1,this.buildSvgStructure(!0),this.enter(this._def_o)},_getAvailableWidth:function(){var t=window.matchMedia("(min-width: 50em)").matches,e=$("#fincIndicBlocD",this.page).width();return"%"==$("#fincIndicBlocD",this.page).css("width").substr(-1,1)&&(e*=(GCO5.browser.width-15)/100),Math.ceil(t?e:GCO5.browser.width-20)}}),GCO5.view.component.D3SynthChart=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.D3SynthChart"},_ficindicView:null,_synthContainer:null,_histoContainer:null,_map:null,_indicModel:null,gclg:null,synthXChart:null,_spineChart:null,histoChart:null,inited:!1,initialize:function(t){this.gclg=GCO5.core.GcLangManager.getInstance(),this.setup(t)},setup:function(t){this._ficindicView=t.ficindicView,this._synthContainer=t.synthContainer,this._histoContainer=t.histoContainer,this._map=t.map},setSpineChart:function(t){this._spineChart=t,this.synthXChart.setSpineChart(t)},update:function(t,e){var i={fullHTML:!0,spineChart:this._spineChart,isSynth:!0};e&&"SPINE"==e.type?this.synthXChart?($(".spineChart",this._synthContainer).empty(),this.synthXChart.update(e,i)):this.synthXChart=new GCO5.view.component.D3ChartContainer(this._synthContainer,e,i):(this._indicModel=t.getIndicModel(),e?(this._synthContainer.show(),this.synthXChart?(this.synthXChart.destroy(),this.synthXChart.update(e,i)):this.synthXChart=new GCO5.view.component.D3ChartContainer(this._synthContainer,e,i),this.buildHistoChart()):this._synthContainer.hide())},getChartList:function(t,e,i){function n(t){return s.gclg.getString(t,"report")}var r=t.getIndicModel(),a=this._getIndicDisplayType0(r),s=this,o=(r.getProp("serie"),r.getProp("dpValRef")),s=this,l=this.gclg.getString("SELECTION","concepts");if(!t.hasValidData())return[];o&&0<o.length&&(c=2<r.getNbPeriods());var c,h=Math.min(10,e),d=[],u=[];if("VI"==a||"PIE"==a&&c)return c&&(d.push({id:"area",label:n("TEMPORAL_EVOL_CUMUL")}),1<=i&&u.push({id:"area_SEL",label:n("TEMPORAL_EVOL_CUMUL")+" - "+l})),d.push({id:"*",label:GCO5.core.GcStringUtil.proper(n("REPART"))+" - "+s.gclg.getString("ENS")}),1<=i&&t.valuesDisplayable()&&u.push({id:"*_SEL",label:GCO5.core.GcStringUtil.proper(n("REPART"))+" - "+l}),c||(d.push({id:"desc",label:GCO5.core.GcStringUtil.proper(n("RANKING"))+" - "+s.gclg.getString("ENS")}),1<i&&u.push({id:"desc_SEL",label:GCO5.core.GcStringUtil.proper(n("RANKING"))+" - "+l})),u.concat(d);if("OURSINS"==a)return c=GCO5.appModel.getConcept("extent_o")[s._map.getIdExtent()].c_lib_extent,d=[{id:"10+",label:n("FIRST_POLES").replace(/XXX/g,h)}],o&&0<o.length&&o[0].values2&&1<o[0].values2.length&&u.push({id:"*",label:n("EVOL_NB_POLES")+" "+n("LOCATED_IN")+" "+c}),u.concat(d);if("FLUX"==a)return d=[{id:"flux|entrants",label:n("FLUX_IN")+this.gclg.getString("P2B")+" "+n("FIRST_TERRS").replace(/XXX/g,h)},{id:"flux|sortants",label:n("FLUX_OUT")+this.gclg.getString("P2B")+" "+n("FIRST_TERRS").replace(/XXX/g,h)},{id:"flux|soldes_absolus",label:n("FLUX_SOLDE")+this.gclg.getString("P2B")+" "+n("FIRST_TERRS").replace(/XXX/g,h)},{id:"flux|soldes_absolus_10last",label:n("FLUX_SOLDE")+this.gclg.getString("P2B")+" "+n("LAST_TERRS").replace(/XXX/g,h)}];if(t.isZonage())return d.push({id:"10+",label:n("FIRST_TERRS").replace(/XXX/g,h)}),1<i&&u.push({id:"10+_SEL",label:n("FIRST_TERRS").replace(/XXX/g,h)+" - "+l}),d.push({id:"10-",label:n("LAST_TERRS").replace(/XXX/g,h)}),1<i&&u.push({id:"10-_SEL",label:n("LAST_TERRS").replace(/XXX/g,h)+" - "+l}),u.concat(d);t.valuesDisplayable()&&(10<e?(d=[{id:"10+",label:n("FIRST_TERRS").replace(/XXX/g,10)},{id:"10-",label:n("LAST_TERRS").replace(/XXX/g,10)}],1<i&&(u.push({id:"10+_SEL",label:n("FIRST_TERRS").replace(/XXX/g,Math.min(i,10))+" - "+l}),10<i&&u.push({id:"10-_SEL",label:n("LAST_TERRS").replace(/XXX/g,Math.min(i,10))+" - "+l}),d=u.concat(d))):d=[{id:"10+",label:n("SELECTION_DETAIL")}]);o="FLUX"!=a?this._getChartDefinition(r):null;return o&&"pie"==o.type?(d.unshift({id:"*",label:n("REPART")}),0<i&&d.unshift({id:"*_SEL",label:n("REPART")+" - "+l})):r.hasMultiplePeriods()&&(r.getProp("dpValRef")?d.unshift({id:"*",label:0<i&&r.hasSerieChartableSelectionInfo()?n("TEMPORAL_EVOL_COMP"):n("TEMPORAL_EVOL")}):0<i&&r.hasSerieChartableSelectionInfo()&&d.unshift({id:"*",label:n("TEMPORAL_EVOL")+" - "+l})),d},displayChart:function(t,e,i,n){if(n=n||{},"SPINE"==e)this.update(null,{type:"SPINE",libsel:n.libsel,spineChart:n.spineChart});else{var r,n=t.getIndicModel(),a=this,s=(n.getProp("serie"),0<e.indexOf("_SEL"));if(0==e.indexOf("*"))r=this._getChartDefinition(n,{selOnly:s});else if(0==e.indexOf("area"))r=this._getChartDefinition(n,{selOnly:s,area:!0});else if(0==e.indexOf("desc")){(r=this._getChartDefinition(n,{selOnly:s})).type="barh";var o=r.xVar;if(r.xVar=r.yVar,r.yVar=o,Array.isArray(r.seriesData[0].data))r.seriesData[0].data.sort(function(t,e){return t.eft-e.eft});else for(var l in r.seriesData[0].data)r.seriesData[0].data[l].sort(function(t,e){return t.eft-e.eft});r.tooltip=function(t,e){return{caption:"",row_a:[{th:a.gclg.getString("CATEG","indics"),td:t.label},{th:a.gclg.getString("NB"),td:a.gclg.formatNumber(t.eft,0,!0)}]}}}else 0==e.indexOf("10+")?r=this._getTopTenDefinition(n,!1,s?i:null):0==e.indexOf("10-")?r=this._getTopTenDefinition(n,!0,s?i:null):0==e.indexOf("flux")&&(o=e.split("|"),r=this._getFluxDefinition(n,o[1],s?i:null));this._synthContainer.css("max-width",0==r.type.indexOf("line")?(30<(e=r.seriesData[0].data.length)?1500:20<e?1200:12<e?800:700)+"px":"50em"),"PT"==n.getProp("topology")&&0==r.type.indexOf("barh")&&this._synthContainer.css("max-width","1500px"),this.update(t,r)}},_getIndicDisplayType0:function(t){return t?(t=t.isMapIndicModel?t.getIndicModel():t).isPie()?"PIE":t.isZonage()?"ZON":t.isOursins()||t.isTypoPole()?"OURSINS":t.isFlux()?"FLUX":t.isCharUnord()?"VI":"SINGLENUM":null},_getTopTen:function(t,e,i){var n=this._getIndicDisplayType0(t),r=GCO5.appModel.getRefData(t.getProp("idgeo"),this._map.getIdExtent()),a="OURSINS"==n||t.isZonage()?t.getProp("dpValRef")[0].values:t.getValues(),s=(i||a).length,o=[],l="PT"==t.getProp("topology");if("OURSINS"==n||t.isZonage()){a=(a=i?t.getProp("selectionInfo").dtscumul:a).concat(),e?a.sort(function(t,e){return t.eft-e.eft}):a.sort(function(t,e){return e.eft-t.eft});for(var c=Math.min(10,a.length),h=0;h<c;h++){var d=a[h].codgeo;a[h].libgeo&&a[h].libgeo!=a[h].codgeo&&(d+=" - "+a[h].libgeo),o.push({libgeo:d,v:a[h].eft})}return o}for(h=0;h<s;h++){var u=i?i[h]:h,p=a[u];"-9999"===p||-9999===p||-99999===p||-999999===p||l&&0===p||o.push({fid:u,v:p})}return e?o.sort(function(t,e){return t.v-e.v}):o.sort(function(t,e){return e.v-t.v}),o.slice(0,10).map(function(t){var e=r.codgeo[t.fid],i=r.libgeo[t.fid];return i&&i!=e&&(e+=" - "+i),{v:t.v,codgeo:r.codgeo[t.fid],libgeo:e}})},_getChartDefinition:function(e,t){var i,n=this._getIndicDisplayType0(e),r=this,a=e.getProp("idIndic"),s=(t=t||{},e.getProp("dpValRef")),o=(s&&0<s.length&&(T=GCO5.core.GcObjectUtil.cloneJson(s[0].values),i=GCO5.core.GcObjectUtil.cloneJson(s[0].valuesExploded),"OURSINS"==n&&(T=GCO5.core.GcObjectUtil.cloneJson(s[0].values2))),e.getProp("filter1")),s=e.getProp("selectionInfo"),s=(s&&t.selOnly&&("VI"==n||"PIE"==n||"OURSINS"==n)&&(T=s.dts,i=s.dtscumul,o&&e.getProp("f1Code")&&0<T.length&&T[0].hasOwnProperty(o)&&(T=T.filter(function(t){return t[o]=e.getProp("f1Code")}),i=i&&i.filter(function(t){return t[o]=e.getProp("f1Code")}))),e.hasMultiplePeriods()),l=e.getProp("varSerie"),c=e.getProp("dataSeries"),s=(c&&10<c.length&&(c=c.slice(-15)),s?c.length:0),h=e.getProp("VIMods"),d=e.getProp("VILibs"),R=e.getProp("hexVIColsMap"),k=e.getProp("hexColors"),u=h?h.length:0,p=e.getTerrRefs(),g=e.getProp("nbDec"),f=e.getProp("refLib"),m=this._map.getSelgeo(e.getLayerName()),_=m?this._map.getNbSelObjs():0,v=m&&t&&t.selOnly?r.gclg.getString("SELECTION","concepts"):e.getProp("refLib"),F=e.getStat("minth")<0&&e.isAdditive();if(0<u)for(var y={},b=0;b<u;b++)y[h[b]]=b+1;if(!(T&&0!=T.length||m))return null;var C,x,w=this._hasNa(T,"v"),S=[{className:".main.l2",enabled:!0,label:"",nbdec:g}];if("I"==e.getProp("type")&&"PT"==e.getProp("topology")&&(T=T.filter(function(t){return"-9999"!=t.code})),1<s){if("OURSINS"==n){var M={xVar:l,yVar:"nbpoles",type:"line"},l=GCO5.appModel.getConcept("extent_o")[r._map.getIdExtent()].c_lib_extent;S[0].data=T,v=this.gclg.getString("EVOL_NB_POLES","report")+" "+this.gclg.getString("LOCATED_IN","report")+" "+l}else if("SINGLENUM"==n){if(w&&(!m||!e.hasSerieChartableSelectionInfo())){var O,G=T.length;for(b=0;GCO5.core.GcMathUtil.isInvalid(T[b].v)&&++b<G;);for(l=b,b=G-1;GCO5.core.GcMathUtil.isInvalid(T[b].v)&&0<=--b;);if(O=b,G<=l||l==O)return;T=T.slice(l,O+1),w=this._hasNa(T,"v")}M={xVar:"gc_serie",yVar:"v",type:w||F?"barv":s<100?"line-dotted":"line"},e.getProp("hasCI")&&"1"==GCO5.initInfo.ip_emc3&&T.length<50&&(M.ylclVar="v_lcl",M.yuclVar="v_ucl",M.ci=!0),S[0].data=T,f=f||e.getProp("selectionInfo").valRefLib,m&&e.hasSerieChartableSelectionInfo()&&(x=r.buildSynthChartDpFromInfosel(e.getProp("selectionInfo").dts,e,a,n,!0,_,f)),m&&x&&(S[0].data=x.stdDp[0].data,S[0].label=m.libgeo.replace("&nbsp;"," "),v=T?r.gclg.getString("COMPARISON"):S[0].label,S[0].className=".main.l1",1<x.stdDp.length&&(S[1]={className:".main.l2",enabled:!0,label:f,nbdec:g,data:x.stdDp[1].data}),x.base100&&(M.base100=M.hasBase100Switch=!0,S[0].datab100=x.stdDp[0].datab100,S[1].datab100=x.stdDp[1].datab100,T&&!x.hasNa&&(v+=" - "+r.gclg.getString("BASE100_INDICE","report"))),x.hasNa&&(M.type="barv",M.base100=!1)),"barv"==M.type&&(M.legendBottom=!0)}else if(("PIE"==n||"VI"==n)&&(a="VI"==n?"eft":"v0",u<=10&&!w&&t.area)){if(m&&x)S=x.stdDp,v=r.gclg.getString("SELECTION","concepts");else for(b=0;b<u;b++)S[b]={area:!0,label:d[b],data:GCO5.core.GcArrayUtil.getSubArray(i,{code:[h[b]]}),className:".main.l"+(b+1),enabled:!0};M={xVar:"gc_serie",yVar:"v",type:"line-dotted",zAxis:h,colf_a:k}}M&&(C=function(t,e){var i=[{th:r.gclg.getString("PERIOD","indics"),td:t.gc_serie},{th:r.gclg.getString("VALUE"),td:r.gclg.formatNumber(t[a],g,!0)}];return M.ci&&i.push({th:r.gclg.getString("CI","tables"),td:"["+r.gclg.formatNumber(t.v_lcl)+" ; "+r.gclg.formatNumber(t.v_ucl,g,!0)+"]"}),1<S.length&&t.label&&i.push({th:GCO5.core.GcStringUtil.proper(r.gclg.getString("TERRITORY","concepts")),td:t.label}),{caption:"PIE"==n||"VI"==n?d[y[t.code]-1]:"",row_a:i}})}if(!M&&("PIE"==n||"VI"==n)){if("VI"==n||"PIE"==n&&m&&t&&t.selOnly)a="eft",T.forEach(function(t,e){"-9999"==t.code?(t.categ=0,t.label="N/A"):(t.categ=y[t.code],t.label=d[t.categ-1]),t.hasOwnProperty(a)||(t[a]=t.v)});else if(!x){var I=t.selOnly?e.getProp("selectionInfo").dts:e.getProp("pieSumVars"),T=[];if(Array.isArray(I))for(var A=0;A<I.length;A++)for(b=0;b<d.length;b++)(P={label:d[b],gc_filter1:b+1,categ:b+1,gc_serie:I[A].gc_serie})[a]=P.eft=P.Y=I[A][h[b]],I[A].hasOwnProperty("totvars")&&(P._TOTVARS_=I[A].totvars),T.push(P);else for(var P,b=0;b<d.length;b++)(P={label:d[b],gc_filter1:b+1,categ:b+1})[a]=P.eft=I[h[b]],I.hasOwnProperty("totvars")&&(P._TOTVARS_=I.totvars),T.push(P)}if(M={xVar:"label",cVar:"categ",yVar:"eft",type:"pie",display_numbers:!0,colf_o:R},c&&1<=c.length){M.animate=1<s,M.subsetKey=c[c.length-1],M.subsetType="serie";for(var D={},E=0;E<c.length;E++){var N={},L=c[E];N.gc_serie=[String(L),parseFloat(L)],D[L]=GCO5.core.GcArrayUtil.getSubArray(T,N)}M.filterMods=c,T=D}else a="eft";S[0].data=T,C=function(t,e){return{caption:"",row_a:[{th:r.gclg.getString("CATEG","indics"),td:t.data.label},{th:r.gclg.getString("VALUE"),td:r.gclg.formatNumber(t.data[a],g,!0)}]}}}return!M&&p&&(1<p.length||m&&!e.isAdditive())&&(M={xVar:"libgeo",cVar:"codgeo",yVar:"v",type:"barv"},(x=x&&r.buildSynthChartDpFromInfosel(x,e,a,n,!1,_,f))&&((l=x.stdDp).libgeo=m.libgeo.replace("&nbsp;"," "),T.push(l),v=""),e.isAdditive()&&(M={yVar:"libgeo",cVar:"codgeo",xVar:"v",type:"barh"},T.sort(function(t,e){return t.v-e.v})),S[0].data=T,C=function(t,e){return{caption:"tooltip",row_a:[{th:GCO5.core.GcStringUtil.proper(r.gclg.getString("TERRITORY","concepts")),td:t[M.xVar]},{th:r.gclg.getString("VALUE"),td:r.gclg.formatNumber(t[M.yVar],g,!0)}]}}),M&&("barv"==M.type&&(M.base100=!1),M.seriesData=S,M.source=e.getProp("source"),M.title=e.getProp("libIndic"),M.subTitle=v,M.tooltip=C),M},_getFluxDefinition:function(e,t,i){var t=e.getProp("dpValRef")[0].values[t],n=this,r=(e.getProp("serie")&&(t=t.filter(function(t){return t[e.getProp("varSerie")]==e.getProp("serie")})),[{className:".main.l1",enabled:!0,label:"",nbdec:0}]),a=(r[0].data=t.concat().reverse(),{yVar:"libgeo",xVar:"value",type:"barh",seriesData:r}),s=GCO5.appModel.getInfo("libNivgeo",[n._map.nivgeo]);return a.tooltip=function(t,e){return{caption:"",row_a:[{th:s,td:t[a.yVar]},{th:n.gclg.getString("VALUE"),td:n.gclg.formatNumber(t[a.xVar],0,!0)+""}]}},a.source=e.getProp("source"),a.title=GCO5.core.GcStringUtil.proper(e.getProp("libIndic")),a.subTitle="",a},_getTopTenDefinition:function(t,e,i){function n(t){return a.gclg.getString(t,"report")}var r=this._getIndicDisplayType0(t),a=this,s=t.getProp("nbDec"),o=t.getProp("unit"),o=GCO5.core.GcStringUtil.isEmpty(o)?"":" "+o,l=GCO5.appModel.getInfo("libNivgeo",[a._map.nivgeo]),c=GCO5.appModel.getInfo("libNivgeo",[t.getProp("idgeo"),["de","en"].indexOf(this.gclg.getLang())<0,!0]),h=[{className:".main.l1",enabled:!0,label:"",nbdec:s}],i=(h[0].data=this._getTopTen(t,e,i),e||h[0].data.reverse(),h[0].data.length),d=a.gclg.getString("NB").toLowerCase(),u={yVar:"libgeo",xVar:"v",type:"barh",seriesData:h,tooltip:function(t,e){return{caption:"",row_a:[{th:l,td:t[u.yVar]},{th:a.gclg.getString("VALUE"),td:a.gclg.formatNumber(t[u.xVar],s,!0)+o}]}}};return u.source=t.getProp("source"),u.title=GCO5.core.GcStringUtil.proper(t.getProp("libIndic")),u.subTitle=n(e?"LAST_TERRS":"FIRST_TERRS").replace(/XXX/g,i),"OURSINS"==r?u.subTitle=(e?etString("LAST_POLES"):n("FIRST_POLES")).replace(/XXX/g,i)+" ("+c+", "+d+")":u.subTitle+="ZON"==r?" "+a.gclg.getString("TERRITORIES","concepts").toLowerCase()+" ("+c+", "+d+")":" ("+c+")",u},buildSynthChartDpFromInfosel:function(t,e,i,n,r,R,k){var a,s,o=[{territ:"SEL"},{territ:"REF"}],l=[],c=[],h=!1,d=e.getProp("type"),u=e.getProp("hasCI"),p=GCO5.core.GcMathUtil.isInvalid,g=e.getProp("VIMods"),f=e.getProp("VILibs"),F=g?g.length:0,m=e.getProp("refLib")||k,_=this._map.getSelgeo(e.getLayerName()).libgeo;if("PIE"==n||"VI"==n){var v=t.infosel_a;if(r){for(var y={},b=e.getProp("dataSeries").concat(),C=(b.reverse(),[]),x=0;x<F;x++){for(var w=GCO5.core.GcArrayUtil.getSubArray(v,{gc_filter1:[String(x+1)]}),S=[],M=0;M<b.length;M++){var O=GCO5.core.GcArrayUtil.indexOfByKey(w,"gc_serie",b[M]);O<0?S.push({gc_serie:b[M],cumul:y[b[M]]||0,cumul0:0,gc_filter1:String(x+1)}):(y[(T=w[O]).gc_serie]||(y[T.gc_serie]=0),T[i]=parseFloat(T[i]),y[T.gc_serie]+=T[i],T.cumul=y[T.gc_serie],T.cumul0=T[i],S.push(T))}C.push({label:f[x],data:S,area:!0,className:".main.l"+(x+1),enabled:!0})}return{hasNa:h,stdDp:C}}if("VI"==n){if(0==v.length)return;for(var x=0;x<v.length;x++){if(!v[x].hasOwnProperty(i))return;v[x].redressed||(v[x].gc_filter1=v[x].VALSELDATA||g[v[x].gc_filter1-1],v[x].redressed=1)}}else for(var w=v[v.length-1].VALSEL.split("|"),v=[],x=0;x<f.length;x++)(T={label:f[x],categ:x+1})[i]=parseFloat(w[x]),v.push(T);return{hasNa:h,stdDp:v}}if(0<=["C","R","O"].indexOf(d)){if(!r)return{hasNa:h,stdDp:v={codgeo:"",libgeo:"selection",v:t.infosel_a[0].VALSEL}};if(!("R"==d&&e.getStat("minth")<0)){if("R"==d&&0<=e.getStat("minth")){var G=[],V=[],I=t.length;for(x=0;(0==t[x].valSel||p(t[x].valSel)||0==t[x].valRef1||p(t[x].valRef1))&&++x<I;);for(D=x,x=I-1;(0==t[x].valSel||p(t[x].valSel))&&0<=--x;);if(E=x,I<=D||D==E)return;var U=t[D].valSel,$=t[D].valRef1;for(x=D;x<=E;x++){var T,A=(T=t[x]).valRef1,P=T.valSel;p(A)||p(P)||((a={gc_serie:s=T.gc_serie}).v=100*P/U,a.label=_,G.push(a),a[i]=P,(a={gc_serie:s}).v=100*A/$,a.label=m,V.push(a),a[i]=A)}0==G.length?G=null:(o[0].datab100=G,o[1].datab100=V)}var D=0,E=I-1,N=0;if("C"==d){for(I=t.length,x=0;p(t[x].valSel)&&p(t[x].valRef1)&&++x<I;);for(D=x,x=I-1;p(t[x].valSel)&&p(t[x].valRef1)&&0<=--x;);for(E=x,x=0;p(t[x].valRef1)&&++x<I;)N++;N==I-1&&(h=!0)}for(x=D;x<=E;x++){var L=t[x],P=L.valSel,A=L.valRef1;(p(P)||p(A))&&(h=!0),(a={gc_serie:s=L.gc_serie}).label=_,a.v=p(P)?9e-4:parseFloat(P),u&&(a.v_lcl=L.valSel_lcl,a.v_ucl=L.valSel_ucl),l.push(a),a[i]=P,c&&N!==I-1&&((a={gc_serie:s}).label=m,a.v=p(A)?9e-4:parseFloat(A),a[i]=A,u&&(a.v_lcl=L.valRef1_lcl,a.v_ucl=L.valRef1_ucl),c.push(a))}return o[0].data=l,0==c.length?(c=null,o.pop()):o[1].data=c,{hasNa:h,stdDp:o,base100:null!=G}}}},_isFilter1Chartable:function(t){if(10<t.length)return!1;for(var e in t)t[e];return!0},_hasNa:function(t,e){return!!t&&t.some(function(t){return GCO5.core.GcMathUtil.isInvalid(t[e])})},resize:function(){this.synthXChart&&this.synthXChart.resize()},_getChartAvailableHeight:function(){return GCO5.browser.height>GCO5.browser.width?Math.min(220,.4*GCO5.browser.height):Math.min(220,GCO5.browser.height-20)},_getChartAvailableWidth:function(){var t=window.matchMedia("(min-width: 50em)").matches;return Math.ceil(t?.45*$(window).width():GCO5.browser.width)-20},buildHistoChart:function(){var n=this,r=this.gclg,t=(this._indicModel.getProp("idIndic"),this._indicModel.getProp("type"),this._histoContainer);if(t)if(t.height(Math.ceil(200)+"px"),!(this._indicModel.getStat("eftvalth")<50)){t.parent().show();var a,e,i=this._indicModel.getProp("histoVals"),s=this._indicModel.getProp("histoLissVals");if(s){for(var o=s.length,l=[],c=[],h=0;h<o;h++){var d=h;l.push({c:d,v:s[h]}),c.push({c:d,v:i[h]})}function u(t,e){var i=t.hasOwnProperty(a.yVar+"0")?t[a.yVar+"0"]:t[a.yVar];return r.getString("VALUE")+" "+t[a.xVar]+r.getString("P2")+" "+r.formatNumber(i,n._indicModel.getProp("nbDec"),!0)}this.histocharts_o={lin:{crit:"zon",chartdefs:[{zon:"",type:"line",tooltip:u,main:[{className:".main.l1",label:"",data:[],area:!1,enabled:!0}]}]},barv:{crit:"zon",chartdefs:[{type:"barv",zon:"",tooltip:u,main:[{className:".main.l1",label:"",enabled:!0}]}]}},e=20<c.length?"lin":"barv",(a=this.histocharts_o[e].chartdefs[0]).xVar="c",a.yVar="v",a.nbdec=0,a.noSpacing=!0,Math.min(10,c?c.length:10);a.noXAxis=!0,a.main=[{className:".main.l1",label:"",data:c,area:!0,enabled:!0}],a.compData=[{className:".comp.l2",type:"line",label:"",chartData:l,data:l,enabled:!0}],a&&(a.legendBottom=!1,a.seriesData=a.main,a.fitToContainer=!0,this.histoChart=new GCO5.view.component.D3ChartContainer(this._histoContainer,a)),t.parent().css("display",a?"block":"none")}else t.parent().hide()}},getSynthChart:function(){return this.synthXChart},getSelgeoChart:function(){return this.selgeoChart},getChart:function(t){return"SELGEO"==t?this.selgeoChart:this.synthXChart},synthChartHasLibgeoLegend:function(){return this._leg2zones}}),GCO5.view.component.FicindicView=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.FicindicView"},_synthChartContainer:null,_histoChartContainer:null,_valrefContainer:null,_map:null,_ca:null,_d3SynthChart:null,_$container:null,_viewData:null,_gcDashboardModel:null,_curIndic:null,spineChart:null,gclg:null,gcsm:null,test:0,initialize:function(t){this._$container=t.container,this.gclg=GCO5.core.GcLangManager.getInstance(),this.gcsm=GCO5.core.SystemManager.getInstance(),this.setup(t)},getFicIndicList:function(t){var e,i=this._map.getIndicsModelsIndexed(),n=[];for(e in i)i[e].onImportedData()||i[e].isTJS()||t&&!i[e].valuesDisplayable()||n.push({data:i[e].getPkF1(),label:i[e].getProp("libIndicWithF1",!1,!0,!0),enabled:i[e].isEnabled()});return n},isComposited:function(){var t=this._ca._viewData.selectedRestit;return 1<t.length&&0<=t.indexOf("f")},_updateSelHash:function(){var t=this._map.getSelgeo(),t=t?t.getPkGeo():null,e=t!=this._selHash;return this._selHash=t,e},onBuildInfosel:function(t){t&&(this.isComposited()&&(this._viewData.selOnly=!!this._map.getSelIds(),t&&"delsel"==t.from)?this._ca._showMap(!0):t&&"delsel"==t.from&&"*"==this._curIndic?this._ca._viewData.prevFicIndic():((this._updateSelHash()||this._infoselingNewIndic)&&this.setIndic(this._curIndic),$.observable(this._viewData).setProperty("libSel",this._viewData.getLibsel()),this._infoselingNewIndic=!1))},setup:function(t){t.map&&(this._map=t.map),this._ca=t.ca,this._viewData={map:t.map,selectedChart:"",selOnly:!1,hasSpine:t.hasSpine,chart_a:[],statSelInfo:{},hasSel:function(){return this.map.hasSelgeo()},getLibsel:function(){return this.map.hasSelgeo()?this.map.getLibSel():null}},this._viewData.libSel=this._viewData.getLibsel(),GCO5.core.GcDelayUtil.callLater(this.onResize,[],1,this),$.render.indicatorComponentFicheBody.link(this._$container.find(".fic-body"),this._viewData),this._synthChartContainer=t.synthChartContainer||this._$container.find(".dataviz-container"),this._histoChartContainer=t.histoChartContainer||(1==this._$container.find(".histo-container").length?this._$container.find(".histo-container"):null),this._valrefContainer=t.valrefContainer||this._$container.find(".valref-container"),this._d3SynthChart=new GCO5.view.component.D3SynthChart({ficindicView:this,map:this._map,synthContainer:this._synthChartContainer,histoContainer:this._histoChartContainer}),this._synthChartContainer.addClass("inFicIndic");GCO5.core.GcDelayUtil.callLater(function(){$(document).trigger("enhance")},[],20,this),this._addListeners()},getStatTable:function(){return $(".stat-report",this._$container).find("table")},_addListeners:function(){var n=this;$.observe(this._viewData,"selectedChart",function(t,e){var i,e=e.value;"SPINE"==e?n._testSpineChart():($(".xchart",n._synthChartContainer).show(),$(".spineChart",n._synthChartContainer).hide(),n._synthChartContainer.height(800<GCO5.browser.height?400:300),i=n._viewData.exporting?0:1,GCO5.core.GcDelayUtil.callLater(n._d3SynthChart.displayChart,[n._viewData.mapIndicModel,e,n._viewData.selOnly?n._map.getSelIds():null,{spineChart:n.spineChart}],i,n._d3SynthChart))})},_testSpineChart:function(){var t=this,l=t._map.getInfoSel(),e=l?l.indicateurs:[],i=[];if(l&&l.spineIndics)for(var n in l.spineIndics)1==(c=e.filter(function(t){return n===t.c_id_indicateur+"."+t.c_id_dataset})).length&&i.push(c[0]);var c=[],r="";if(l)for(var n in l.territories){var h,d,a=l.territories[n];"SELGEO"===a.type&&(h=a.id),"REF"===a.type&&(r=a.title,d=a.id)}var u=GCO5.appModel.getConcept("dataset_o"),s=(i.forEach(function(t){var e,i=l.data[t.c_id_dataset],n=l.distributions[t.c_id_dataset][t.c_id_indicateur];if(n){for(var r in i){var a,s,o=i[r];o.territory===h&&(a=i[r]),o.territory===d&&(s=i[r])}Array.isArray(n)&&(n=n.concat().pop()),s&&(e=u[t.c_id_dataset],e={IND:t.c_lib_indicateur_court,INDS:t.c_lib_indicateur_court+(t.c_unite?" ("+t.c_unite+")":"")+(e.varserie?" - "+a[e.varserie]:""),INDSL:t.c_lib_indicateur,LCL:a[t.c_id_indicateur+"_lcl"],PCT25:n.q25,PCT75:n.q75,UCL:a[t.c_id_indicateur+"_ucl"],VAL0:s[t.c_id_indicateur],VALSEL:a[t.c_id_indicateur],compci:2,enabled:!0,highisgood:1-t.c_highisbad,maxiVAL0:n.max,miniVAL0:n.min,nbdec:t.c_nbdec,typind:t.c_id_typind},GCO5.core.GcMathUtil.isInvalid(e.VALSEL)||(e.LCL>e.VAL0?e.compci=1:e.UCL<e.VAL0&&(e.compci=3),e.bestVAL0=e.highisgood?e.maxiVAL0:e.miniVAL0,e.worstVAL0=e.highisgood?e.miniVAL0:e.maxiVAL0,c.push(e)))}}),t.gclg.getString("SELECTION","concepts")),s={INDS:t.gclg.getString("INDICS2","concepts"),VAL0:r+"|"+t.gclg.getString("VALUE"),VALSEL:s+"|"+t.gclg.getString("VALUE"),bestVAL0:r+"|"+t.gclg.getString("BEST","report"),worstVAL0:r+"|"+t.gclg.getString("WORST","report")},s=(t._d3SynthChart.displayChart(null,"SPINE",null,{libsel:this._map.getLibSel()}),{data:c,libcols:s});s.zonreflib=r,t.spineChart=new GCO5.view.component.D3SpineChart(t._synthChartContainer,s,{}),t._d3SynthChart.setSpineChart(t.spineChart)},spineChartActive:function(){var t=$(".spineChart");return!!(this.spineChart&&t.is(":visible")&&0<t.height())&&t},getChartData:function(){var i=this,n=[],t=this._viewData.selectedChart;return this._viewData.exporting=!0,this._viewData.chart_a.forEach(function(t,e){$.observable(i._viewData).setProperty("selectedChart",t.id),n.push({title:t.label,dp:i._d3SynthChart.getSynthChart()._getChartData(null,null,null,"|||").csvData.map(function(t){return t.split("|||")})})}),this._viewData.exporting=!1,$.observable(i._viewData).setProperty("selectedChart",t),n},_displayTablo:function(){this._synthChartContainer.css("height","auto"),this._synthChartContainer.hide();var t=this;GCO5.core.GcDelayUtil.callLater(function(){t._organizeTabloDp(t._map.getInfoSel())},[],5,this)},_organizeTabloDp:function(t){var e,i,l=[],c=this,h={},n=0,d=t.data,u=this._map.getIndicsModelsIndexed();for(e in u)n++,h[u[e].getProp("idDataset")]=u[e].getProp("serie");for(e in t.ref_o){var p,g,r=t.ref_o[e];"valSel"==r&&(p=e),"valRef1"==r&&(g=e)}t.indicateurs&&(this.getFicIndicList(!0).forEach(function(t){var e=u[t.data],i=d[e.getProp("idDataset")],n=e.getProp("serie"),r=e.getProp("filter1"),a=e.getProp("libIndic"),a=(GCO5.core.GcObjectUtil.isEmpty(e.getProp("unit"))||(a+=" ("+e.getProp("unit")+")"),{id:e.getPkF1(),lib:a,typind:e.getProp("type"),isIndic:!0,comp:-1,symb:"",class:""}),s={territory:p},o=(e.getProp("serie")&&(s[e.getProp("varSerie")]=e.getProp("serie")),e.getProp("filter1")&&(s[e.getProp("filter1")]=e.getProp("f1Code")),GCO5.core.GcArrayUtil.getSubArray(i,s).filter(function(t){return t.hasOwnProperty(e.getProp("idIndicateur"))}));0!=o.length&&(a.valSel=o[0][e.getProp("idIndicateur")],a.valSelFormatted=c.gclg.formatNumber(a.valSel,e.getProp("nbDec")),n&&(a.lib+=", "+o[0][e.getProp("varSerie")]),r&&(a.lib+=" - "+e.getProp("f1Lib")),s.territory=g,0!=(o=GCO5.core.GcArrayUtil.getSubArray(i,s).filter(function(t){return t.hasOwnProperty(e.getProp("idIndicateur"))})).length&&(a.valRef=o[0][e.getProp("idIndicateur")],a.valRefFormatted=GCO5.core.GcMathUtil.isInvalid(a.valRef)?"N/A":c.gclg.formatNumber(a.valRef,e.getProp("nbDec")),a.serie=h[t.c_id_dataset],a.highIsGood=e.getProp("highIsGood"),"1"==GCO5.appModel.getOption("noCompArrowsInTable")||"C"!=a.typind||GCO5.core.GcMathUtil.isInvalid(a.valRef)||GCO5.core.GcMathUtil.isInvalid(a.valSel)||((a.valSel-a.valRef)/(a.valSel+a.valRef)<-.01?(a.comp=a.highIsGood?1:2,a.symb="▼",a.class="score plm "+(a.highIsGood?"red":"green")):.01<(a.valSel-a.valRef)/(a.valSel+a.valRef)&&(a.comp=a.highIsGood?2:1,a.symb="▲",a.class="score plm "+(a.highIsGood?"green":"red"))),-9999!=a.valSel&&-99999!=a.valSel&&l.push(a)))}),i=this._viewData.mapIndicModel?this._viewData.mapIndicModel.getProp("refLib"):this.gclg.getString("ENS"),i=0<l.length?$.render.indicatorComponentSynthTable({v_a:l,score:!0,terrRef:!0,refLabel:i,selLabel:this._map.getLibSel(),libgroupvar:this.gclg.getString("INDICS2","concepts")}):this.gclg.getString("NO_COMPAR_DATA","restit","indicator"),1<n&&this._checkInfoselAllIndics(),$(".synth-table",this._$container).empty().append(i).show(),$(".xchart-container",this._synthChartContainer).hide(),$("h2",this._synthChartContainer).text(this.gclg.getString("COMPAR_TABLE","restit","indicator")),$(".key",this._synthChartContainer).text(this.gclg.getString("COMPAR_SEL_REF","restit","indicator")))},_checkInfoselAllIndics:function(){var t,e=this._map.getIndicsModelsIndexed();for(t in e){var i=e[t];if(i.getPkF1()!=this._curIndic&&GCO5.core.GcObjectUtil.isEmpty(i.getProp("selectionInfo"))&&0<=["C","R","I"].indexOf(i.getProp("type")))return this._infoselingNewIndic=!0,this._viewData.mapIndicModel=i,void this._map.testCallInfosel(null,i)}},getSynthChart:function(){return this._d3SynthChart},getMapIndicModel:function(){var t=this._map.getIndicsModelsIndexed()[this._curIndic];return this._viewData.mapIndicModel||t},setIndic:function(t,e){var i=this._map.getIndicsModelsIndexed(),n=i[t],r=this._map.getEnabledIndicsModelsIndexed()[t],a=this,s=0;if(void 0===e&&(e=this._viewData.selOnly),!this._viewData.noTrigger){if(this._synthChartContainer.height(800<GCO5.browser.height?400:300),GCO5.core.GcDelayUtil.callLater(function(){a._curIndic=t},[],"*"==t||"SPINE"==t?1:0,this),"*"==t)return $.observable(this._viewData.chart_a).refresh([]),this._displayTablo(),void this._$container.addClass("tabdet-mode");if($(".synth-table",this._$container).hide(),this._$container.removeClass("tabdet-mode spine-mode "),"SPINE"==t)return $.observable(this._viewData.chart_a).refresh([{id:"SPINE",label:"SPINE"}]),$.observable(a._viewData).setProperty("hasSpine",2),this._$container.addClass("spine-mode"),this._viewData.selectedChart=null,void $.observable(this._viewData).setProperty("selectedChart","SPINE");$.observable(a._viewData).setProperty("hasSpine",a._viewData.hasSpine?1:0),this.isComposited()&&n&&!r&&(this._ca._waitingForUpdateMapTitle=!1,this._ca.displayThisMapindicOnly(t));e=this._map.getSelIds();if(e&&0<e.length&&GCO5.core.GcObjectUtil.isEmpty(n.getProp("selectionInfo"))&&0<=["C","R","I","Z"].indexOf(n.getProp("type")))return this._infoselingNewIndic=!0,void this._map.testCallInfosel(null,n);var o,r=!!a._lastIndic&&a._lastIndic!=t,l=((a._lastIndic=t)||(o=!0,t=this._viewData.mapIndicModel.getPkF1()),$(".ui-table-reflow",this._synthChartContainer).parent().hide(),$(".xchart-container",this._synthChartContainer).show(),this._viewData.selectedChart),i=(e&&0<e.length&&$.observable(this._viewData).setProperty("statSelInfo",this._getStatSelInfo(i[t].getIndicModel(),e)),this._viewData.mapIndicModel&&this._viewData.mapIndicModel.getPkF1()==n.getPkF1()&&(o=!0),this._viewData.mapIndicModel=this._viewData.selectedChart=null,$.observable(this._viewData).setProperty("mapIndicModel",n),n.getLayerName()||this._map.getStatLayer().getName()),e=this._map.getLayerByName(i),c=this._d3SynthChart.getChartList(n,e.getNbObjs(),this._map.getNbSelObjs(i)),h=($.observable(this._viewData.chart_a).refresh(c),o?Math.max(0,GCO5.core.GcArrayUtil.indexOfByKey(c,"id",l)):0);0<=h&&0<c.length&&(s=this.isComposited()&&r?60:1,$("#tm_fiche_select_chart",a._$container).val(c[h].id),this.gcsm.freeze("synthchart"),GCO5.core.GcDelayUtil.callLater(function(){$.observable(a._viewData).setProperty("selectedChart",c[h].id),a.gcsm.unFreeze("synthchart")},[],s)),this.onResize(null,!0)}},_getStatSelInfo:function(t,e){var i=t.getValues(),n=GCO5.appModel.getRefData(this._map.nivgeo,this._map.getIdExtent()),r=e?e.length:0,a=[],s=0,o=0,l=t.getProp("nbDec");if("O"==t.getProp("type")||"F"==t.getProp("type"))return{};for(var c=0;c<r;c++){var h=e?e[c]:c,d=i[h];-9999===d||-99999===d||-999999===d?s++:(o+=d,a.push({fid:h,v:d}))}if(0==a.length)return null;a.sort(function(t,e){return e.v-t.v});var t=a.length,u=Math.floor(t/2),p=a[u].v;return t%2==0&&(p=.5*(a[u-1].v+a[u].v)),{max:this.gclg.formatNumber(a[0].v,l)+" ("+n.libgeo[a[0].fid]+" - "+n.codgeo[a[0].fid]+")",min:this.gclg.formatNumber(a[t-1].v,l)+" ("+n.libgeo[a[t-1].fid]+" - "+n.codgeo[a[t-1].fid]+")",nbna:s,nbvalid:a.length,eft:t,avg:o/t,mediane:p}},displayFicPanel:function(t){var t=new GCO5.view.component["Fic"+t+"Panel"],e={action:"NEW",categ:"panel",container:this.isComposited()?$(".cd-panel.from-right .cd-panel-content"):$(".cd-panel.from-left .cd-panel-content"),map:this.map,fic:this};GCO5.core.GcDelayUtil.callLater(t.setup,[e],10,t)},show:function(t){t=t||{},$.observable(this._viewData).setProperty("selOnly",t.selOnly,{noTrigger:!0})},onResize:function(t,e){var i,n;this.resizing||(this._updateSelHash(),i=$(".fic-body.vertical-scrollable",this._$container),n=GCO5.browser.height-i.offset().top-10,i.height(n),i.scrollTop(0),$("#tm_fiche_select_chart",this._$container).width($(".ficHeader",this._$container).width()-30),this.spineChartActive()&&this.spineChart.resize(),!e&&this._d3SynthChart&&$(".xchart-container").is(":visible")&&this._d3SynthChart.resize())}}),jQuery&&function(s){function a(t){var e=t.parent();t.removeData("minicolors-initialized").removeData("minicolors-settings").removeProp("size").removeClass("minicolors-input"),e.before(t).remove()}function o(t){var e=t.parent(),i=e.find(".minicolors-panel"),n=t.data("minicolors-settings");!t.data("minicolors-initialized")||t.prop("disabled")||e.hasClass("minicolors-inline")||e.hasClass("minicolors-focus")||(l(),e.addClass("minicolors-focus"),i.stop(!0,!0).fadeIn(n.showSpeed,function(){n.show&&n.show.call(t.get(0))}))}function l(){s(".minicolors-focus").each(function(){var t=s(this),e=t.find(".minicolors-input"),i=t.find(".minicolors-panel"),n=e.data("minicolors-settings");i.fadeOut(n.hideSpeed,function(){n.hide&&n.hide.call(e.get(0)),t.removeClass("minicolors-focus")})})}function i(t,e,i){var n=t.parents(".minicolors").find(".minicolors-input"),r=n.data("minicolors-settings"),a=t.find("[class$=-picker]"),s=t.offset().left,o=t.offset().top,l=Math.round(e.pageX-s),c=Math.round(e.pageY-o),i=i?r.animationSpeed:0;e.originalEvent.changedTouches&&(l=e.originalEvent.changedTouches[0].pageX-s,c=e.originalEvent.changedTouches[0].pageY-o),c<0&&(c=0),(l=l<0?0:l)>t.width()&&(l=t.width()),c>t.height()&&(c=t.height()),t.parent().is(".minicolors-slider-wheel")&&a.parent().is(".minicolors-grid")&&(s=75-l,e=75-c,o=Math.sqrt(s*s+e*e),(e=Math.atan2(e,s))<0&&(e+=2*Math.PI),75<o&&(l=75-75*Math.cos(e),c=75-75*Math.sin(e)),l=Math.round(l),c=Math.round(c)),t.is(".minicolors-grid")?a.stop(!0).animate({top:c+"px",left:l+"px"},i,r.animationEasing,function(){h(n,t)}):a.stop(!0).animate({top:c+"px"},i,r.animationEasing,function(){h(n,t)})}function h(t,e){function i(t,e){var i,n;return t.length&&e?(i=t.offset().left,n=t.offset().top,{x:i-e.offset().left+t.outerWidth()/2,y:n-e.offset().top+t.outerHeight()/2}):null}var n,r,a,s=t.val(),o=t.attr("data-opacity"),l=t.parent(),c=t.data("minicolors-settings"),h=l.find(".minicolors-swatch"),d=l.find(".minicolors-grid"),u=l.find(".minicolors-slider"),p=l.find(".minicolors-opacity-slider"),g=d.find("[class$=-picker]"),f=u.find("[class$=-picker]"),m=p.find("[class$=-picker]"),_=i(g,d),v=i(f,u),g=i(m,p);if(e.is(".minicolors-grid, .minicolors-slider")){switch(c.control){case"wheel":n=d.width()/2-_.x,a=d.height()/2-_.y,r=Math.sqrt(n*n+a*a),(a=Math.atan2(a,n))<0&&(a+=2*Math.PI),75<r&&(_.x=69-(r=75)*Math.cos(a),_.y=69-75*Math.sin(a)),n=C(r/.75,0,100),s=x({h:r=C(180*a/Math.PI,0,360),s:n,b:a=C(100-Math.floor(v.y*(100/u.height())),0,100)}),u.css("backgroundColor",x({h:r,s:n,b:100}));break;case"saturation":s=x({h:r=C(parseInt(_.x*(360/d.width()),10),0,360),s:n=C(100-Math.floor(v.y*(100/u.height())),0,100),b:a=C(100-Math.floor(_.y*(100/d.height())),0,100)}),u.css("backgroundColor",x({h:r,s:100,b:a})),l.find(".minicolors-grid-inner").css("opacity",n/100);break;case"brightness":s=x({h:r=C(parseInt(_.x*(360/d.width()),10),0,360),s:n=C(100-Math.floor(_.y*(100/d.height())),0,100),b:a=C(100-Math.floor(v.y*(100/u.height())),0,100)}),u.css("backgroundColor",x({h:r,s:n,b:100})),l.find(".minicolors-grid-inner").css("opacity",1-a/100);break;default:s=x({h:r=C(360-parseInt(v.y*(360/u.height()),10),0,360),s:n=C(Math.floor(_.x*(100/d.width())),0,100),b:a=C(100-Math.floor(_.y*(100/d.height())),0,100)}),d.css("backgroundColor",x({h:r,s:100,b:100}))}t.val(b(s,c.letterCase))}e.is(".minicolors-opacity-slider")&&(o=c.opacity?parseFloat(1-g.y/p.height()).toFixed(2):1,c.opacity&&t.attr("data-opacity",o)),h.find("SPAN").css({backgroundColor:s,opacity:o}),y(t,s,o)}function c(t,e){var i,n,r,a,s,o=t.parent(),l=t.data("minicolors-settings"),c=o.find(".minicolors-swatch"),h=o.find(".minicolors-grid"),d=o.find(".minicolors-slider"),u=o.find(".minicolors-opacity-slider"),p=h.find("[class$=-picker]"),g=d.find("[class$=-picker]"),f=u.find("[class$=-picker]"),m=b(v(t.val(),!0),l.letterCase),_=function(t){t=function(t){var e={h:0,s:0,b:0},i=Math.min(t.r,t.g,t.b),n=Math.max(t.r,t.g,t.b),i=n-i;return e.b=n,e.s=0!==n?255*i/n:0,0!==e.s?t.r===n?e.h=(t.g-t.b)/i:t.g===n?e.h=2+(t.b-t.r)/i:e.h=4+(t.r-t.g)/i:e.h=-1,e.h*=60,e.h<0&&(e.h+=360),e.s*=100/255,e.b*=100/255,e}(w(t));return 0===t.s&&(t.h=360),t}(m=m||b(v(l.defaultValue,!0),l.letterCase));switch(e||t.val(m),l.opacity&&(i=""===t.attr("data-opacity")?1:C(parseFloat(t.attr("data-opacity")).toFixed(2),0,1),isNaN(i)&&(i=1),t.attr("data-opacity",i),c.find("SPAN").css("opacity",i),r=C(u.height()-u.height()*i,0,u.height()),f.css("top",r+"px")),c.find("SPAN").css("backgroundColor",m),l.control){case"wheel":a=C(Math.ceil(.75*_.s),0,h.height()/2),s=_.h*Math.PI/180,n=C(75-Math.cos(s)*a,0,h.width()),r=C(75-Math.sin(s)*a,0,h.height()),p.css({top:r+"px",left:n+"px"}),r=150-_.b/(100/h.height()),g.css("top",(r=""===m?0:r)+"px"),d.css("backgroundColor",x({h:_.h,s:_.s,b:100}));break;case"saturation":n=C(5*_.h/12,0,150),r=C(h.height()-Math.ceil(_.b/(100/h.height())),0,h.height()),p.css({top:r+"px",left:n+"px"}),r=C(d.height()-_.s*(d.height()/100),0,d.height()),g.css("top",r+"px"),d.css("backgroundColor",x({h:_.h,s:100,b:_.b})),o.find(".minicolors-grid-inner").css("opacity",_.s/100);break;case"brightness":n=C(5*_.h/12,0,150),r=C(h.height()-Math.ceil(_.s/(100/h.height())),0,h.height()),p.css({top:r+"px",left:n+"px"}),r=C(d.height()-_.b*(d.height()/100),0,d.height()),g.css("top",r+"px"),d.css("backgroundColor",x({h:_.h,s:_.s,b:100})),o.find(".minicolors-grid-inner").css("opacity",1-_.b/100);break;default:n=C(Math.ceil(_.s/(100/h.width())),0,h.width()),r=C(h.height()-Math.ceil(_.b/(100/h.height())),0,h.height()),p.css({top:r+"px",left:n+"px"}),r=C(d.height()-_.h/(360/d.height()),0,d.height()),g.css("top",r+"px"),h.css("backgroundColor",x({h:_.h,s:100,b:100}))}t.data("minicolors-initialized")&&y(t,m,i)}function y(t,e,i){var n=t.data("minicolors-settings"),r=t.data("minicolors-lastChange");r&&r.hex===e&&r.opacity===i||(t.data("minicolors-lastChange",{hex:e,opacity:i}),n.change&&(n.changeDelay?(clearTimeout(t.data("minicolors-changeTimeout")),t.data("minicolors-changeTimeout",setTimeout(function(){n.change.call(t.get(0),e,i)},n.changeDelay))):n.change.call(t.get(0),e,i)),t.trigger("change").trigger("input"))}function b(t,e){return"uppercase"===e?t.toUpperCase():t.toLowerCase()}function v(t,e){return 3!==(t=t.replace(/[^A-F0-9]/gi,"")).length&&6!==t.length?"":"#"+(t=3===t.length&&e?t[0]+t[0]+t[1]+t[1]+t[2]+t[2]:t)}function C(t,e,i){return t=i<(t=t<e?e:t)?i:t}function x(t){return t=t,n={},r=Math.round(t.h),a=Math.round(255*t.s/100),t=Math.round(255*t.b/100),0===a?n.r=n.g=n.b=t:(t=r%60*((e=t)-(a=(255-a)*t/255))/60,(r=360===r?0:r)<60?(n.r=e,n.b=a,n.g=a+t):r<120?(n.g=e,n.b=a,n.r=e-t):r<180?(n.g=e,n.r=a,n.b=a+t):r<240?(n.b=e,n.r=a,n.g=e-t):r<300?(n.b=e,n.g=a,n.r=a+t):r<360?(n.r=e,n.g=a,n.b=e-t):(n.r=0,n.g=0,n.b=0)),r={r:Math.round(n.r),g:Math.round(n.g),b:Math.round(n.b)},i=[r.r.toString(16),r.g.toString(16),r.b.toString(16)],s.each(i,function(t,e){1===e.length&&(i[t]="0"+e)}),"#"+i.join("");var i,e,n,r,a}function w(t){return{r:(t=parseInt(-1<t.indexOf("#")?t.substring(1):t,16))>>16,g:(65280&t)>>8,b:255&t}}s.minicolors={defaults:{animationSpeed:50,animationEasing:"swing",change:null,changeDelay:0,control:"hue",defaultValue:"",hide:null,hideSpeed:100,inline:!1,letterCase:"lowercase",opacity:!1,position:"bottom left",show:null,showSpeed:100,theme:"default"}},s.extend(s.fn,{minicolors:function(t,r){switch(t){case"destroy":return s(this).each(function(){a(s(this))}),s(this);case"hide":return l(),s(this);case"opacity":return void 0===r?s(this).attr("data-opacity"):(s(this).each(function(){c(s(this).attr("data-opacity",r))}),s(this));case"rgbObject":return i=s(this),n=w(v(s(i).val(),!0)),i=s(i).attr("data-opacity"),n?(void 0!==i&&s.extend(n,{a:parseFloat(i)}),n):null;case"rgbString":case"rgbaString":return i=s(this),n="rgbaString"===t,e=w(v(s(i).val(),!0)),i=s(i).attr("data-opacity"),e?(void 0===i&&(i=1),n?"rgba("+e.r+", "+e.g+", "+e.b+", "+parseFloat(i)+")":"rgb("+e.r+", "+e.g+", "+e.b+")"):null;case"settings":return void 0===r?s(this).data("minicolors-settings"):(s(this).each(function(){var t=s(this).data("minicolors-settings")||{};a(s(this)),s(this).minicolors(s.extend(!0,t,r))}),s(this));case"show":return o(s(this).eq(0)),s(this);case"value":return void 0===r?s(this).val():(s(this).each(function(){c(s(this).val(r))}),s(this));default:return"create"!==t&&(r=t),s(this).each(function(){var e,t,i,n;e=s(this),t=r,i=s('<div class="minicolors" />'),n=s.minicolors.defaults,e.data("minicolors-initialized")||(t=s.extend(!0,{},n,t),i.addClass("minicolors-theme-"+t.theme).toggleClass("minicolors-with-opacity",t.opacity),void 0!==t.position&&s.each(t.position.split(" "),function(){i.addClass("minicolors-position-"+this)}),e.addClass("minicolors-input").data("minicolors-initialized",!1).data("minicolors-settings",t).prop("size",7).wrap(i).after('<div class="minicolors-panel minicolors-slider-'+t.control+'"><div class="minicolors-slider"><div class="minicolors-picker"></div></div><div class="minicolors-opacity-slider"><div class="minicolors-picker"></div></div><div class="minicolors-grid"><div class="minicolors-grid-inner"></div><div class="minicolors-picker"><div></div></div></div></div>'),t.inline||(e.after('<span class="minicolors-swatch"><span class="minicolors-swatch-color"></span></span>'),e.next(".minicolors-swatch").on("click",function(t){t.preventDefault(),e.focus()})),e.parent().find(".minicolors-panel").on("selectstart",function(){return!1}).end(),t.inline&&e.parent().addClass("minicolors-inline"),c(e,!1),e.data("minicolors-initialized",!0))}),s(this)}var e,i,n}}),s(document).on("mousedown.minicolors touchstart.minicolors",function(t){s(t.target).parents().add(t.target).hasClass("minicolors")||l()}).on("mousedown.minicolors touchstart.minicolors",".minicolors-grid, .minicolors-slider, .minicolors-opacity-slider",function(t){var e=s(this);t.preventDefault(),s(document).data("minicolors-target",e),i(e,t,!0)}).on("mousemove.minicolors touchmove.minicolors",function(t){var e=s(document).data("minicolors-target");e&&i(e,t)}).on("mouseup.minicolors touchend.minicolors",function(){s(this).removeData("minicolors-target")}).on("mousedown.minicolors touchstart.minicolors",".minicolors-swatch",function(t){var e=s(this).parent().find(".minicolors-input");t.preventDefault(),o(e)}).on("focus.minicolors",".minicolors-input",function(){var t=s(this);t.data("minicolors-initialized")&&o(t)}).on("blur.minicolors",".minicolors-input",function(){var t=s(this),e=t.data("minicolors-settings");t.data("minicolors-initialized")&&(t.val(v(t.val(),!0)),""===t.val()&&t.val(v(e.defaultValue,!0)),t.val(b(t.val(),e.letterCase)))}).on("keydown.minicolors",".minicolors-input",function(t){var e=s(this);if(e.data("minicolors-initialized"))switch(t.keyCode){case 9:l();break;case 13:case 27:l(),e.blur()}}).on("keyup.minicolors",".minicolors-input",function(){var t=s(this);t.data("minicolors-initialized")&&c(t,!0)}).on("paste.minicolors",".minicolors-input",function(){var t=s(this);t.data("minicolors-initialized")&&setTimeout(function(){c(t,!0)},1)})}(jQuery),GCO5.core.GcGeomUtil={RADIAN:360/(2*Math.PI),DEG_TO_MT:40075016.68/(2*Math.PI),pointInsidePolygon:function(t,e,i,n){for(var r=t.x_a,a=t.y_a,s=(r.length,0),t=Number.POSITIVE_INFINITY,o=r.length,l=0;l<o;l++)s+=this.pointInsideRing(r[l].length,r[l],a[l],e,i)>>0;return 1==(1&s)&&0<t},pointInsideRing:function(t,e,i,n,r){for(var a,s=t-1,o=0;o<t;s=o++){var l,c=i[o],h=i[s];c!=h&&r<c!=r<h&&(l=e[o],n<(e[s]-l)*(r-c)/(h-c)+l&&(a=!a))}return a},pointDistance2ToRing:function(t,e,i,n,r){for(var a,s=Number.POSITIVE_INFINITY,o=0;o<t;o++){var l=e[o],c=i[o],h=n-l,d=r-c,h=(h<0?-h:h)+(d<0?-d:d);h<s&&(a=o,s=h)}var u,l=e[a],c=i[a],p=e[u=a<t-1?a+1:0],g=i[u],f=this.pointDistanceToLine2(l,c,p,g,n,r),p=e[u=0<a?a-1:t-1],g=i[u];return s=Math.min(f,this.pointDistanceToLine2(l,c,p,g,n,r))},pointProjectedOnLine:function(t,e,i,n,r,a){var s,o=i-t,l=n-e;return a=0==o&&0==l||(r=((r-t)*o+(a-e)*l)/(o*o+l*l))<0?(s=t,e):1<r?(s=i,n):(s=t+r*o,e+r*l),[s,a]},pointDistanceToLine2:function(t,e,i,n,r,a){t=this.pointProjectedOnLine(t,e,i,n,r,a),e=t[0]-r,i=t[1]-a;return e*e+i*i},SMC_to_WGSrad:function(t,e){var i=this.DEG_TO_MT,t=t/i,e=2*(Math.atan(Math.exp(e/i))-Math.PI/4);return new GCO5.model.geom.Point(t,e)},SMC_to_LongLat:function(t,e){var t=this.SMC_to_WGSrad(t,e),e=t.y*this.RADIAN,i=t.x*this.RADIAN;return t.x=e,t.y=i,t}},GCO5.model.maps.GcTopoModel=GCO5.Class.extend({statics:{NAME:"GCO5.model.maps.GcTopoModel",DECAL_ROV_GRID:10},lyName:null,tabvars_a:null,cursor:0,bbox_o:null,params_o:null,params:{},isEpsgMobile3857:null,params900913:null,ctr:null,arcs:null,karcs:null,pt:null,grid_o:null,codgeo_a:null,libgeo_a:null,colors:null,typo:null,distorted:null,topoModelOrig:null,topoModelAnamorph:null,srId0:null,srId:null,new_x_a:null,new_y_a:null,valid:null,areas:null,area:null,ctrType:null,isStat:null,worldToScreenMatrix0:null,arcToFt_a:null,edges_a:null,islands_a:null,neighbours_a:null,multrings_a:null,withholes_a:null,fond_karcs:null,objsToClone:["bbox_o","params","params900913","ctr","arcs","pt","grid_o","areas"],isCarro:function(){var t=this.getParams();return t&&1-t.avgw_mt/t.maxw_mt<.2&&1-t.avgh_mt/t.maxh_mt<.2&&1-t.avgw_mt/t.avgh_mt<.01&&t.avgw_mt<2e3&&t.avgh_mt<2e3},initialize:function(e){if(e){if(this.params_o={},this.grid_o={},this.bbox_o={},e.isEpsgMobile3857&&(this.isEpsgMobile3857=!0),e.epsg?this.srId=this.srId0=e.epsg:console.log("epsg absent",e.name),"_E"==e.name.substr(-2,2))return this.pt={x:e.ba.x1,y:e.ba.y1},this.libgeo_a=e.ba.libgeo,this.colors=e.ba.colors,this.lyName=e.ba.layer,void(this.params_o[this.srId]=this.params_o[3857]=this.params={topo:"E",nbObjs:this.libgeo_a.length,nbPoints:this.libgeo_a.length,mult_xy:e.ba.params.mult_xy,italics:e.ba.italics,bolds:e.ba.bolds,sizes:e.ba.size,align:e.ba.align});if(e.ba&&e.ba.params)this._loadFromLocalStorage(e.ba);else{var t,i,n,r,a;this.isStat=e.stat,this.lyName=e.name,void 0!==e.ba&&(t=new Uint8Array(e.ba),i=new DataView(e.ba)),this.valid=1;try{void 0!==e.ba?(n=new Uint8Array(t,0,4),r=new ArrayBuffer(4),(a=new Uint8Array(r))[0]=n[0],a[1]=n[1],a[2]=n[2],a[3]=n[3],t.length===new Uint32Array(r)[0]?this._decodeTopoFormat(t,i):(console.log("Error file => FTP transfert binary mode ON "+(this.lyName||"")+", ba "+e.ba.length+" != "+new Uint32Array(t,0,4)[0]),this.valid=-1)):this.valid=-1}catch(t){alert(e.name+" "+t.message)}}}},addRefgeo:function(t,e){if(t&&(t.libgeo&&(this.libgeo_a=t.libgeo),t.codgeo&&(this.codgeo_a=t.codgeo),e))for(var i in this.tabvars_a=e){i=e[i].c_varname;this[i]=t[i]}},setSrId:function(t){this.srId=t},isReprojected:function(){return this.srId!=this.srId0},getParams:function(t){return t=t||this.srId,this.params_o[t]},_decodeTopoFormat:function(t,e){this.areas=[],this.cursor=4,this.params=this.params_o[this.srId]=this._rObj(t,e),this._extendParams(),"4326XX"==this.srId||this.isEpsgMobile3857&&(!this.params.proj4def||""===this.params.proj4def||this.params.epsg&&"3857"===this.params.epsg)||(this.params900913=this.params_o[3857]=this._rObj(t,e),this.params900913.area_mt2||(this.params900913.area_mt2=this.params.area_mt2),this.params900913.nbObjs||(this.params900913.nbObjs=this.params.nbObjs),this._extendParams("3857"),this._initRolloverGrid("3857")),this.cursor++,"P"===this.params.topo||this.params.carroyage?(this._rStr2(t),this.pt=this._rPt(t),this.cursor++,"libgeo"===this._rStr(t)&&(this.cursor++,this.libgeo_a=this._rLib(t))):(e="",this._rStr2(t),this.cursor++,this.arcs=this._rArcs(t),this.cursor++,"karcs"===(e=this._rStr(t))&&(this.karcs=this._rKarcs(t),this.cursor++),"DR"===this.params.topo?("ctr"===(e=this._rStr(t))&&(this.ctr=this._rCtr(t),this.cursor++,e=this._rStr(t)),"colors"===e&&(this.colors=this._rColors(t),e=this._rStr(t)),this.ctr||(this.ctrType="init")):"L"===this.params.topo&&this.params.typoField&&this._rStr(t)===this.params.typoField&&(this.cursor++,this._rTypo(t))),this._initRolloverGrid(),t=null},_initRolloverGrid:function(t){t=t||this.srId;var e,i=this.getParams(t),n=1/i.echelle,r="P"!==i.topo?(e=Math.ceil(+i.maxw_mt*n),Math.ceil(+i.maxh_mt*n)):e=100,a=Math.ceil(900/e),s=Math.ceil(800/r),o=Math.ceil(i.nbObjs/(a*s));this.grid_o[t]={gd_pasx:e,gd_pasy:r,gd_ncx:a,gd_ncy:s,z:o,t:n,gd_a:[],params:i,computed:!1}},rolloverGridInited:function(t){return this.getGrid(t).computed},getCtrType:function(){return this.ctrType},_decodeCtr:function(){var t,e,i=this.params,n=i.mult_xy,r=this.getBboxes(),a=i.nbObjs,s=(e=60<n?(t=new Int32Array(a),new Int32Array(a)):(t=new Int16Array(a),new Int16Array(a)),this.ctr&&this.ctr.x);s||(this.ctr={});for(var o,l,c=0;c<a;c++)s?(o=this.ctr.x[c],l=this.ctr.y[c]):o=l=0,0===o&&0===l?(t[c]=r.fminx_a[c]+.5*r.fw_a[c],e[c]=r.fminy_a[c]+.5*r.fh_a[c]):(t[c]=o+r.fminx_a[c],e[c]=l+r.fminy_a[c]);this.ctr.x=t,this.ctr.y=e},getCtrX:function(){var t=this.getParams();return"P"==t.topo?this.x:"DR"!==t.topo?null:"computed"===this.ctrType||"real"===this.ctrType?this.ctr.x:"null"===this.ctrType?(this._upAreaCtr(),this.ctr.x):"init"===this.ctrType?(this._decodeCtr(),this.ctrType="real",this.ctr.x):void 0},getLayerName:function(){return this.lyName},getCtrY:function(){var t=this.getParams();return"P"==t.topo?this.y:"DR"!==t.topo?null:"computed"===this.ctrType||"real"===this.ctrType?this.ctr.y:"null"===this.ctrType?(this._upAreaCtr(),this.ctr.y):"init"===this.ctrType?(this._decodeCtr(),this.ctrType="real",this.ctr.y):void 0},getAreas:function(){return"DR"!==this.getParams().topo?null:(0===this.areas.length&&this._upAreaCtr(),this.areas)},getArea:function(){return"DR"!==this.getParams().topo?null:(null===this.area&&this._upAreaCtr(),this.area)},isDistorted:function(){return!0===this.distorted},clearDistortionInfo:function(t){this.restoreTopoModelOrig(),t&&(this.topoModelOrig=null),this.topoModelAnamorph=null},updateMetaDataAfterDistortion:function(){var t,e,i,n,r,a=this.getParams(),s=("DR"===a.topo&&(this._upAreaCtr(),a.area_mt2=this.area),this.getBboxes());if(null!=s&&"DR"===a.topo&&(this.setBboxes(null),s=this._computeBboxes(),this._initRolloverGrid(),t=s.minx,e=s.miny,i=s.maxx,n=s.maxy,r=a.echelle,r/=a.mult_xy,a.ly_minx_mt=r*t+a.x0_mt,a.ly_maxy_mt=r*e+a.y0_mt,a.ly_w_mt=r*(i-t),a.ly_h_mt=r*(n-e),a.maxw_mt=r*s.maxw,a.maxh_mt=r*s.maxh,a.avgw_mt=r*s.avgw,a.avgh_mt=r*s.avgh,a.ly_minx_px=t/a.mult_xy,a.ly_maxy_px=-e/a.mult_xy,a.ly_w_px=(i-t)/a.mult_xy,a.ly_h_px=(n-e)/a.mult_xy),a.nbPoints=0,(a.maxPointsByArc=0)<this.arcs.length)for(var o=0,l=this.arcs.length;o<l;o++){for(var c=0,h=0,d=this.arcs[o].length;h<d;h+=2)a.nbPoints++,c++;a.maxPointsByArc<c&&(a.maxPointsByArc=c)}this.distorted=!0},saveTopoModelOrig:function(){if(!this.topoModelOrig){var t,e={};for(t in this.objsToClone){var i=this.objsToClone[t];e[i]="arcs"==i?this._cloneArcs(this.arcs):this._cloneObject(this[i])}this.topoModelOrig=e}},_cloneArcs:function(t){if(t!==Object(t))return t;var e,i=t.slice();for(e in i){var n=t[e];i[e]=n.slice(),i[e].minx=n.minx,i[e].maxx=n.maxx,i[e].miny=n.miny,i[e].maxy=n.maxy}return i},_cloneObject:function(t){if(t!==Object(t))return t;if(Array.isArray(t))return t.slice();var e,i=GCO5.core.GcObjectUtil.clone(t);for(e in i)Array.isArray(i[e])?i[e]=i[e].slice(0):GCO5.core.GcObjectUtil.isTypedArray(i[e])&&("function"==typeof i[e].slice?i[e]=i[e].slice(0):i[e]=i[e].subarray(0));return i},restoreProjInit:function(){this.srId=this.srId0,this._loadSavedModel("orig")},restoreTopoModelOrig:function(){this._loadSavedModel("orig"),this.distorted=!1},loadAnamorphModel:function(){this._loadSavedModel("anamorph")},anamorphComputed:function(){return null!==this.topoModelAnamorph},_loadSavedModel:function(t,e){if("orig"===t){if(!this.topoModelOrig)return!1;for(var i in e&&this._storeAnamorphModel(),this.objsToClone)this[n=this.objsToClone[i]]=this.topoModelOrig[n];this.ctr||(this.ctrType="null"),this.topoModelOrig=null}else if("anamorph"===t)for(var i in this.objsToClone){var n;this[n=this.objsToClone[i]]=this.topoModelAnamorph[n]}return!0},_storeAnamorphModel:function(){var t,e={};for(t in this.objsToClone){var i=this.objsToClone[t];e[i]=this[i]}this.topoModelAnamorph=e},getPtX:function(){return this.pt||(this.pt={x:[],y:[]}),this.pt.x},getPtY:function(){return this.pt||(this.pt={x:[],y:[]}),this.pt.y},getColors:function(){return this.colors||{fillStyle:[],strokeStyle:[]}},getBboxes:function(t){return this.bbox_o[t||this.srId]},setNewCoordinates:function(t,e){this.new_x_a=t,this.new_y_a=e},getCurrentPtX:function(){return this.new_x_a||this.getPtX()},getCurrentPtY:function(){return this.new_y_a||this.getPtY()},_computeBboxes:function(){if(this.karcs.length<1)return null;var t=this.getBboxes();if(!t){for(var e,i,n,r=this.getParams(),a=r.nbObjs,s=new Uint16Array(a),o=new Uint16Array(a),l=(r.mult_xy,e=new Int32Array(a),i=new Int32Array(a),n=new Int32Array(a),new Int32Array(a)),t={},c=0,h=r.nbObjs;c<h;c++){var d=this.karcs[c].rings;if(d){var u=d.length;if(u){for(var p=Math.abs(d[0][0])-1,g=this.arcs[p].minx,f=this.arcs[p].miny,m=g,_=f,v=0;v<u;v++)for(var y=d[v],b=0,C=y.length;b<C;b++){var x=this.arcs[Math.abs(y[b])-1];x.minx<g?g=x.minx:x.maxx>m&&(m=x.maxx),x.miny<f?f=x.miny:x.maxy>_&&(_=x.maxy)}e[c]=g,i[c]=f,s[c]=m-g,o[c]=_-f,n[c]=m,l[c]=_}}}t={fminx_a:e,fminy_a:i,fw_a:s,fh_a:o,minx:GCO5.core.GcArrayUtil.min(e),miny:GCO5.core.GcArrayUtil.min(i),maxx:GCO5.core.GcArrayUtil.max(n),maxy:GCO5.core.GcArrayUtil.max(l),maxw:GCO5.core.GcArrayUtil.max(s),maxh:GCO5.core.GcArrayUtil.max(o),avgw:GCO5.core.GcArrayUtil.avg(s),avgh:GCO5.core.GcArrayUtil.avg(o)},this.setBboxes(t)}return t},setBboxes:function(t){this.bbox_o[this.srId]=t},setArcToFtIndex:function(t){this.arcToFt_a=t},getArcToFtIndex:function(t){return this.arcToFt_a},getNeighbours:function(t){return this.neighbours_a||this._computeNeighbours(),this.neighbours_a},_computeNeighbours:function(t){(new Date).getTime();for(var e=this.karcs,i=e.length,n=this.arcs,r=new Array(i),a=(this.neighbours_a=new Array(i),this.edges_a=new Array,this.islands_a=new Array,this.multrings_a=new Array,this.neighbours1_a=new Array,new Array),s=i<15e4,o=0;o<i;o++){for(var l=(t=e[o]).rings,c=t.nring,h=0;h<c;h++){for(var d=(p=l[h]).length,u=0;u<d;u++){n[g=Math.abs(p[u])-1];void 0===(_=r[g])?r[g]=[o]:_.push(o)}1==d&&a.push(g)}1<c&&this.multrings_a.push(o)}for(o=0;o<i;o++)for(l=(t=e[o]).rings,c=t.nring,h=0;h<c;h++)for(var p,d=(p=l[h]).length,u=0;u<d;u++){var g,f;n[g=Math.abs(p[u])-1];1<(_=r[g]).length?(f=(f=_[0])==o?_[1]:f,void 0===(v=this.neighbours_a[o])?this.neighbours_a[o]=[f]:v.indexOf(f)<0&&v.push(f)):s&&this.edges_a.indexOf(o)<0&&this.edges_a.push(o)}for(o=0;o<i;o++)(_=this.neighbours_a[o])?1==_.length&&this.neighbours1_a.push(o):this.islands_a.push(o);for(var m=a.length,_=[],v=[],u=0;u<m;u++){var y=r[a[u]];_=_.concat(y)}for(m=(_=GCO5.core.GcArrayUtil.getDistinctValues(_)).length,u=0;u<m;u++)o=_[u],0<=this.islands_a.indexOf(o)||this._hasHole(o)&&v.push(o);v.sort(function(t,e){return t-e}),this.withholes_a=v;(new Date).getTime();return this.neighbours_a},getFondKArcs:function(){return this.fond_karcs},setFondKArcs:function(t){this.fond_karcs=t},exportForLocalStorage:function(){var t,e={},i=["bbox_o","params","params900913","ctr","arcs","karcs","pt","grid_o","libgeo_a","colors"];for(t in i)e[i[t]]=this[i[t]];return e},_loadFromLocalStorage:function(t){for(var e in t)this[e]=t[e];this.params_o[this.srId]=this.params,"3857"!=this.srId&&(this.params_o[3857]=this.params900913),this.isEpsgMobile3857||(this.params_o[3857]=this.params900913,this.params_o[3857]&&(this._extendParams("3857"),this._initRolloverGrid("3857")));var i,n,r=this.getParams(),a=1/r.echelle,s=("P"===r.topo&&(n=i=20),Math.ceil(900/i)),o=Math.ceil(800/n),l=Math.ceil(r.nbObjs/(s*o));this.grid_o[this.srId]={gd_pasx:i,gd_pasy:n,gd_ncx:s,gd_ncy:o,z:l,t:a,gd_a:[],params:r}},getGrid:function(t){return this.grid_o[t||this.srId]},getTopology:function(){return this.params.topo},getNbObjs:function(){return this.params.nbObjs||this.params.nbPoints},getMeanPointsByObj:function(){return this.getNbPoints()/this.getNbObjs()},getNbPoints:function(){return this.params.nbPoints},getTypo:function(){return this.typo},getArcs:function(){return this.arcs},getFeatureArcs:function(){return this.karcs},getPrecisionFactor:function(){return 1/this.getParams().mult_xy},getParam:function(t,e){return this.getParams(e)[t]},getEchelle:function(){return this.getParams().echelle},getParams900913:function(){return this.params900913},getLibgeos:function(){return this.libgeo_a},getCodgeos:function(){return this.codgeo_a},getLibgeoById:function(t){return this.libgeo_a?this.libgeo_a[t]:null},getCodgeoById:function(t){return this.codgeo_a?this.codgeo_a[t]:null},getTabVarsById:function(t){if(!this.tabvars_a)return[];var e=[],i=GCO5.core.GcArrayUtil.toIndexedObj(this.tabvars_a,"c_varname");if(this.tabvars_a)for(var n in this.tabvars_a){n=this.tabvars_a[n].c_varname;e.push({var:n,lib:i[n].c_varlib,val:this[n][t],url:i[n].c_url})}return e},_extendParams:function(t){t=this.getParams(t);t.h_px||(t.h_px=800,t.w_px=900,t.echelle=t.h_mt/t.h_px,t.mult_xy=this.params.mult_xy,t.topo=this.params.topo),t.ly_w_px=t.w_px*t.ly_w_mt/t.w_mt,t.ly_h_px=t.h_px*t.ly_h_mt/t.h_mt,t.ly_minx_px=(t.ly_minx_mt-t.x0_mt)/t.echelle,t.ly_maxy_px=-(t.ly_maxy_mt-t.y0_mt)/t.echelle,t.ly_area_pct=t.area_mt2/(t.ly_w_mt*t.ly_h_mt)},pointInsidePolygon:function(t,e,i){return t<0||t>=this.params.nbObjs?null:GCO5.core.GcGeomUtil.pointInsidePolygon(this._getPolyAt(t),e,i)},extentA_px:function(t){t=this.getParams(t||this.srId);return new GCO5.model.geom.Rectangle(Math.floor(t.ly_minx_px),Math.floor(t.ly_maxy_px),Math.ceil(t.ly_w_px),Math.ceil(t.ly_h_px))},extentA_calage_px:function(t){t=this.getParams(t||this.srId),t=t.ly_cal_w_mt/t.ly_cal_h_mt/(9/8);return 1<=t?new GCO5.model.geom.Rectangle(0,Math.floor(400*(1-1/t)),900,Math.ceil(800/t)):new GCO5.model.geom.Rectangle(Math.floor(450*(1-t)),0,Math.ceil(900*t),800)},centerDelta_px:function(){this.getWtoS_Matrix();var t=this.extentA_px().center();return t.x-=450,t.y-=400,t},extentA_mt:function(t){t=this.getParams(t||this.srId),t=new GCO5.model.geom.Rectangle(Math.floor(t.ly_minx_mt),Math.floor(t.ly_maxy_mt),Math.ceil(t.ly_w_mt),Math.ceil(t.ly_h_mt));return new GCO5.model.maps.GeoExtent(t)},extentC_mt:function(t){t=this.getParams(t||this.srId),t=new GCO5.model.geom.Rectangle(Math.floor(t.x0_mt),Math.floor(t.y0_mt),Math.ceil(t.w_mt),Math.ceil(t.h_mt));return new GCO5.model.maps.GeoExtent(t)},getOrigC:function(t){t=this.getParams(t||this.srId);return new GCO5.model.geom.Point(t.x0_mt,t.y0_mt)},getBottomRightC:function(t){t=this.getParams(t||this.srId);return new GCO5.model.geom.Point(t.x0_mt+t.w_mt,t.y0_mt-t.h_mt)},getWtoS_Matrix:function(t){t=1/this.getParams(t||this.srId).echelle;return new GCO5.model.geom.Matrix(t,0,0,-t,-t*this.getOrigC().x,t*this.getOrigC().y)},getAvgRadius:function(){return this.params.avgw_mt<1&&this.params.avgh_mt<1&&this.params900913?.5*(this.params900913.avgw_mt+this.params900913.avgh_mt)/2:.5*(this.params.avgw_mt+this.params.avgh_mt)/2},sourceRect:function(t,e){null==t&&(t=5);e=this.getParams(e||this.srId);return new GCO5.model.geom.Rectangle(Math.max(0,Math.floor(e.ly_minx_px)-t),Math.max(0,Math.floor(e.ly_maxy_px)-t),Math.min(900,Math.ceil(e.ly_minx_px+e.ly_w_px)+t),Math.min(800,Math.ceil(e.ly_maxy_px+e.ly_h_px)+t))},_rLib:function(t){var e=[],i=this._rInt(t)>>1;this.cursor++;for(var n=0;n<i;n++)this.cursor++,e[n]=this.utf8_decode(this._rStr(t));return e},_rTypo:function(t){var e=[],i=this._rInt(t)>>1;this.cursor++;for(var n=0;n<i;n++)this.cursor++,e[n]=this._rStr(t);this.typo=e},_rColors:function(t){for(var e=[],i=[],n=0,r=[],a=[],s=(this.cursor+=2,t[this.cursor++]),o=0;s--;)e[o++]=this._rInt(t);for(s=t[this.cursor++],o=0;s--;)i[o++]=this._rInt(t);for(s=(n=t[this.cursor++])<128?n:(127&n)<<7|t[this.cursor++],o=0;s--;)r[o++]="#"+e[t[this.cursor++]].toString(16);for(s=(n=t[this.cursor++])<128?n:(127&n)<<7|t[this.cursor++],o=0;s--;)a[o++]="#"+i[t[this.cursor++]].toString(16);return{fillStyle:r,strokeStyle:a}},_rObj:function(t,e){var i={};if(this.cursor++,this._rStr2(t),10===t[this.cursor++]){for(this.cursor+=2;1!==t[this.cursor];){var n,r=this._rStr(t),a=t[this.cursor++];4===a?n=this._rInt(t):5===a?n=e.getFloat64((this.cursor+=8)-8):6===a&&(n=this._rStr(t)),i[r]=n}this.cursor++}return i},_rArcs:function(t){var e,i,n,r,a=this,s=this.params,o=s.nbArcs,l=s.nb_grid_x,c=s.nb_grid_y,h=(s.w_px*s.mult_xy*s.ly_w_mt/s.w_mt>>0)/l>>0,d=(s.h_px*s.mult_xy*s.ly_h_mt/s.h_mt>>0)/c>>0,u=s.w_px*s.mult_xy*(s.ly_minx_mt-s.x0_mt)/s.w_mt+.5>>0,p=s.h_px*s.mult_xy*(s.y0_mt-s.ly_maxy_mt)/s.h_mt+.5>>0,g=0,f=0,s=this._rInt(t);if(s-2!=o)return console.warn("définition d'arcs invalide dans la couche "+this.lyName,s,o,this),void(this.valid=-2);var m=[],s=(this._rInt(t),this._rInt(t)),_=t[this.cursor++],v=this.cursor+s;this._rInt(t);for(var y,b=0,C=null;b<o;b++,C=y){O=M=S=w=x=void 0,(y=t[a.cursor++])!==C?(g=a._rInt(t)+h*(y%l)+u,f=a._rInt(t)+d*(y/c>>0)+p):(g+=a._rInt(t),f+=(i=a._rInt(t))>>>1^-(1&i));var x,w,S=m[b]=[n=g,r=f];S.minx=S.maxx=n,S.miny=S.maxy=r;var M,O=1;if(x=((x=t[v++])<128?x:(M=t[v++])<128?x=(127&x)<<7|M:((127&x)<<7|127&M)<<7|t[v++])>>1,_<=2)for(;x--;)S[++O]=n+=((e=t[v++])<128?e:e=(127&e)<<7|t[v++])>>>1^-(1&e),S[++O]=r+=((i=t[v++])<128?i:i=(127&i)<<7|t[v++])>>>1^-(1&i),G(S,n,r);else for(;x--;)S[++O]=n+=(e=(e=t[v++])<128?e:(w=t[v++])<128?e=(127&e)<<7|w:((127&e)<<7|127&w)<<7|t[v++])>>>1^-(1&e),S[++O]=r+=(i=(i=t[v++])<128?i:(w=t[v++])<128?i=(127&i)<<7|w:((127&i)<<7|127&w)<<7|t[v++])>>>1^-(1&i),G(S,n,r)}function G(t,e,i){e<t.minx?t.minx=e:e>t.maxx&&(t.maxx=e),i<t.miny?t.miny=i:i>t.maxy&&(t.maxy=i)}return this.cursor=v,m},_rKarcs:function(t){var e,i=[],n=[],r=[],a=0,s=0,o="DR"===this.params.topo;this.cursor+=2;for(var l=0,c=this._rInt(t)>>1;l<c;l++)i[l]=120*(12*((e=t[this.cursor++])<128?e:(127&e)<<7|t[this.cursor++])+((e=t[this.cursor++])<128?e:(127&e)<<7|t[this.cursor++]));var h,d,u,p,g=n[0]={rings:[],nring:0},c=this._rInt(t),f=0;function m(t,e,i){e<t.minx?t.minx=e:e>t.maxx&&(t.maxx=e),i<t.miny?t.miny=i:i>t.maxy&&(t.maxy=i)}for(;c--;)(e=t[this.cursor++])?1===e?(o&&a&&0<=r[a-1]&&(h=r[0],d=this.arcs[Math.abs(h)-1],u=this.arcs[Math.abs(r[a-1])-1],0<=h?(u.push(d[0],d[1]),m(u,d[0],d[1])):(p=d.length-2,u.push(d[p],d[p+1]),m(u,d[p],d[p+1]))),(g=n[f]).rings[g.nring++]=r,r=[],a=0):(h=(g=e-2+i[s++])>>>1^-(1&g),o&&a&&0<=r[a-1]&&(d=this.arcs[Math.abs(h)-1],u=this.arcs[Math.abs(r[a-1])-1],0<=h?(u.push(d[0],d[1]),m(u,d[0],d[1])):(p=d.length-2,u.push(d[p],d[p+1]),m(u,d[p],d[p+1]))),r[a++]=h):(o&&a&&0<=r[a-1]&&(h=r[0],d=this.arcs[Math.abs(h)-1],u=this.arcs[Math.abs(r[a-1])-1],0<=h?(u.push(d[0],d[1]),m(u,d[0],d[1])):(p=d.length-2,u.push(d[p],d[p+1]),m(u,d[p],d[p+1]))),g=n[f++],a&&(g.rings[g.nring++]=r),n[f]={rings:[],nring:0},r=[],a=0);return o&&a&&0<=r[a-1]&&(h=r[0],d=this.arcs[Math.abs(h)-1],u=this.arcs[Math.abs(r[a-1])-1],0<=h?(u.push(d[0],d[1]),m(u,d[0],d[1])):(p=d.length-2,u.push(d[p],d[p+1]),m(u,d[p],d[p+1]))),a&&(n[f].rings[n[f].nring++]=r),n},_rPt:function(t){for(var e=[],i=[],n=[],r=this.params,a=r.nb_grid_x,s=r.nb_grid_y,o=(r.w_px*r.mult_xy*r.ly_w_mt/r.w_mt>>0)/a>>0,l=(r.h_px*r.mult_xy*r.ly_h_mt/r.h_mt>>0)/s>>0,c=r.w_px*r.mult_xy*(r.ly_minx_mt-r.x0_mt)/r.w_mt+.5>>0,h=r.h_px*r.mult_xy*(r.y0_mt-r.ly_maxy_mt)/r.h_mt+.5>>0,d=(this.cursor+=2,this._rInt(t)),u=0,p=0;d--;)e[u++]=t[this.cursor++];for(d=this._rInt(t),p=u=0;d--;)i[u++]=this._rInt(t)+o*(e[p++]%a)+c;for(d=this._rInt(t),p=u=0;d--;)n[u++]=this._rInt(t)+l*(e[p++]/s>>0)+h;return{x:i,y:n}},_rCtr:function(t){this.cursor+=2;for(var e=new Array(n),i=new Array(n),n=this._rInt(t);n--;)e[n]=this._rInt(t);for(n=this._rInt(t);n--;)i[n]=this._rInt(t);return this.ctrType="init",{x:e,y:i}},_rInt:function(t){var e=t[this.cursor++];if(e<128)return e;var i=t[this.cursor++];if(i<128)return(127&e)<<7|i;var n=t[this.cursor++];return n<128?((127&e)<<7|127&i)<<7|n:((((127&e)<<7|127&i)<<7|127&n)<<8|t[this.cursor++])<<3>>3},_rStr:function(t){for(var e=this._rInt(t)>>1,i="";e--;)i+=String.fromCharCode(t[this.cursor++]);return i},_rStr2:function(t){this.cursor+=1+t[this.cursor]>>1},utf8_decode:function(t){for(var e,i="",n=0,r=(v1=v2=0,t.length);n<r;)(e=t.charCodeAt(n))<128?(i+=String.fromCharCode(e),n++):191<e&&e<224?(v2=t.charCodeAt(n+1),i+=String.fromCharCode((31&e)<<6|63&v2),n+=2):(v2=t.charCodeAt(n+1),v3=t.charCodeAt(n+2),i+=String.fromCharCode((15&e)<<12|(63&v2)<<6|63&v3),n+=3);return i},_upAreaCtr:function(){var t=this.params.nbObjs;this.ctr={x:[],y:[]},this.areas=[];for(var e=this.area=0;e<t;e++)this._rAreaCtr(e);this.ctrType="computed"},_rAreaCtr:function(t){var e=this.params;if(!(t<0||t>=e.nbObjs)){var i=this.karcs[t].rings,n=i.length,r=this._rAreaCtrRing(i[0]),a=r.area;if(1<n){var s=[];s[0]=r;for(var o=1;o<n;o++)s[o]=this._rAreaCtrRing(i[o]),a+=s[o].area,s[o].area>r.area&&(r=s[o])}this.ctr.x[t]=r.x,this.ctr.y[t]=r.y,this.areas[t]=a,this.area+=a}},_hasHole:function(t){for(var t=this._getPolyAt(t),e=t.x_a,i=t.y_a,n=e.length,r=0;r<n;r++)for(var a=e[r],s=i[r],o=0;o<n;o++)if(o!=r){var l=e[o][0],c=i[o][0];if(GCO5.core.GcGeomUtil.pointInsideRing(a.length,a,s,l,c))return!0}return!1},_rAreaCtrRing:function(t){this.params.mult_xy;for(var e=t.length,i=[],n=0,r=0;r<e;r++){var a=t[r],s=this.arcs[Math.abs(a)-1],o=s.length;if(0<a)for(var l=0;l<o;l+=2)i[n++]=s[l],i[n++]=s[l+1];else for(;0<=(o-=2);)i[n++]=s[o],i[n++]=s[o+1]}var c,h,d,u,p=0,g=0,f=0;n-=2;for(var m,r=0;r<n;r+=2)0==r?(c=i[r],h=i[r],d=i[r+1],u=i[r+1]):(i[r]<c&&(c=i[r]),i[r]>h&&(h=i[r]),i[r+1]<d&&(d=i[r+1]),i[r+1]>u&&(u=i[r+1])),p+=(m=i[r]*i[r+3]-i[r+2]*i[r+1])*(i[r]+i[r+2]),g+=m*(i[r+1]+i[r+3]),f+=m>>1;if(0!==f)return{x:p/(m=6*f),y:g/m,area:f};var _=0,v=0;n++;for(r=0;r<n;r+=2)_+=i[r],v+=i[r+1],0==r?(c=i[r],h=i[r],d=i[r+1],u=i[r+1]):(i[r]<c&&(c=i[r]),i[r]>h&&(h=i[r]),i[r+1]<d&&(d=i[r+1]),i[r+1]>u&&(u=i[r+1]));return{x:_/(n=n+1>>1),y:v/n,area:0}},_getPolyAt:function(t){for(var e=this.arcs,t=this.karcs[t],i=t.rings,n=t.nring,r=[],a=[],s=1/this.params.mult_xy,o=0;o<n;o++){for(var l=[],c=[],h=i[o],d=h.length,u=0;u<d;u++){var p=h[u],g=e[Math.abs(p)-1],f=g.length;if(0<=p)for(var m=0;m<f;m+=2)l.push(g[m]*s),c.push(g[m+1]*s);else for(m=f-2;0<=m;m-=2)l.push(g[m]*s),c.push(g[m+1]*s)}r.push(l),a.push(c)}return{x_a:r,y_a:a}}}),GCO5.model.maps.GcTopoSelection=GCO5.Class.extend({statics:{NAME:"GCO5.model.maps.GcTopoSelection"},initialize:function(t,e,i,n){if(i)for(var r=(new Date).getTime(),n={},a=i.length,s=0;s<a;s++)for(var o=i[s],l=(p=e[o].rings).length,c=0;c<l;c++)for(var h=p[c],d=0,u=h.length;d<u;d++)n[g=Math.abs(h[d])]?n[g]++:n[g]=1;if(e.length>GCO5.view.component.LayerView.AGREG_THRESHOLD){var p=[];for(g in n)1===n[g]&&p.push(+g);p=[p]}else{var g,f={},m=0;for(g in n)1===n[g]&&(f[g]=1,m++);p=this._computePolyAgreg(t,e,i,f,n=null,[],m,0,0),1==GCO5.initInfo.ip_emc3&&i&&1e3<i.length&&console.log("dessin new sel en: "+((new Date).getTime()-r)/1e3+" s")}this.getKarcs=function(){return[{rings:p}]}},_computePolyAgreg:function(t,e,i,n,r,a,s,o,l){if(!r)for(var c in r={},n){var h=(m=t[(c=+c)-1]).length,d=m[0]+","+m[1],u=m[h-2]+","+m[h-1];r[d]?r[d].push(+c):r[d]=[+c],r[u]?r[u].push(-+c):r[u]=[-+c]}var p,g,f=[];for(c in(a=a||[]).push(f),n){var m,h=(m=t[c-1]).length;if(d=m[0]+","+m[1],u=m[h-2]+","+m[h-1],c=p=+c,f.push(c),g=d!=u)break;a.push(f=[]),o++,delete n[c]}for(var _=0;g&&_++<5e3;){var v=r[u];if(v){var y=v.length,b=v[0];if(2===y)p=b===-p?v[1]:b;else{if(1==y){o++,delete n[c];break}for(var C=0;C<y;C++){var x=v[C];x!==-p&&n[Math.abs(x)]&&f.indexOf(x)<0&&f.indexOf(-x)<0&&(p=x)}}if(o++,delete n[c],h=(m=t[(c=Math.abs(p))-1]).length,u=0<=p?m[h-2]+","+m[h-1]:m[0]+","+m[1],f.push(p),u===d){o++,delete n[c];break}}null===p&&(delete n[c],o++,g=!1)}return u!==d&&a.pop(),o<s&&l++<2e3?this._computePolyAgreg(t,e,i,n,r,a,s,o,l):a}}),GCO5.model.maps.TopoCacheModel=GCO5.Class.extend({statics:{NAME:"GCO5.model.maps.TopoCacheModel"},topoModel_o:null,initialize:function(){this._setup()},_setup:function(){this.topoModel_o={}},registerTopoModel:function(t,e){this.topoModel_o[t]=e},clearTopoModel:function(t){delete this.topoModel_o[t]},getTopoModel:function(t){return this.topoModel_o[t]}}),GCO5.model.maps.GeoExtent=GCO5.Class.extend({statics:{NAME:"GCO5.model.maps.GeoExtent"},rect:null,srId:null,_roundCoord:null,initialize:function(t,e){this.rect=t,this.srId=e,t instanceof GCO5.model.maps.GeoExtent?this.rect=t.rect.clone():t instanceof GCO5.model.geom.Rectangle?this.rect=t.clone():t.minx&&t.w?this.rect=new GCO5.model.geom.Rectangle(t.minx,t.maxy,t.w,t.h):t.hasOwnProperty("x")&&t.hasOwnProperty("y")?this.rect=new GCO5.model.geom.Rectangle(t.x,t.y,t.width,t.height):(1==(e=t.split("|")).length&&(e=t.split(",")),this.rect=new GCO5.model.geom.Rectangle(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])))},_invert1Y:function(t){var e=t.clone();return e.y-=t.height,e},contains:function(t,e){return!(!t||!t.rect)&&(e&&(t=t.zoomOutPreserveRatio(1.01)),this._invert1Y(this.rect).containsRect(this._invert1Y(t.rect)))},containsAndTouches:function(t,e){return!!t&&((e=null==e?!0:e)?!(!this.contains(t.zoomOutPreserveRatio(1.01))||!GCO5.core.GcMathUtil.isRoughlyEqual(this.getWidth(),t.getWidth(),.02)&&!GCO5.core.GcMathUtil.isRoughlyEqual(this.getHeight(),t.getHeight(),.02)):!(!this.contains(t)||this.getWidth()!=t.getWidth()&&this.getHeight()!=t.getHeight()))},resize:function(t,e){return this._inflate((t-this.getWidth())/2,(e-this.getHeight())/2)},scale:function(t){var e=this.getWidth(),i=this.getHeight();return this._inflate((e/t-e)/2,(i/t-i)/2)},_inflate:function(t,e){var i=this.rect?this.rect.clone():new GCO5.model.geom.Rectangle(0,0,0,0);return i.inflate(t,-e),i.height+=4*e,new GCO5.model.maps.GeoExtent(i)},zoomOut:function(t,e){t=Math.round((1/t-1)/2*Math.min(this.getWidth(),this.getHeight()));return!1!==e&&(t=Math.round(t)),this._inflate(t,t)},zoomOutPreserveRatio:function(t,e){var t=(1/t-1)/2,i=t*this.getWidth(),t=t*this.getHeight();return!1!==e&&(i=Math.round(i),t=Math.round(t)),this._inflate(i,t)},getWidth:function(){return this.rect.width},getHeight:function(){return this.rect.height},getTopLeft:function(){return this.rect.topLeft()},getBottomRight:function(){return this.rect.bottomRight2()},getCenter:function(){return this.rect.center2()},getMinx:function(){return this.rect.x},getMaxy:function(){return this.rect.y},toString:function(t){return this.rect.toStringCompact(t=t||"|",!0)}}),GCO5.model.geom.Point=GCO5.Class.extend({statics:{NAME:"GCO5.model.geom.Point"},x:0,y:0,initialize:function(t,e){return this.x=null==t?0:t,this.y=null==e?0:e,this},clone:function(){return new GCO5.model.geom.Point(this.x,this.y)},toString:function(){return"[Point (x="+this.x+" y="+this.y+")]"}}),GCO5.model.geom.Rectangle=GCO5.Class.extend({statics:{NAME:"GCO5.model.geom.Rectangle"},x:0,y:0,width:0,height:0,initialize:function(t,e,i,n){return this.x=t||0,this.y=e||0,this.width=i||0,this.height=n||0,this},intersects:function(t){return!(this.x>t.x+t.width)&&(!(this.y>t.y+t.height)&&(!(this.x+this.width<t.x)&&!(this.y+this.height<t.y)))},intersection:function(t){var e=Math.max(this.x,t.x),i=Math.max(this.y,t.y),n=Math.min(this.x+this.width,t.x+t.width),t=Math.min(this.y+this.height,t.y+t.height);return n-e<0||t-i<0?null:new GCO5.model.geom.Rectangle(e,i,n-e,t-i)},inflate:function(t,e){this.x-=t,this.width+=2*t,this.y-=e,this.height+=2*e},containsPoint:function(t){return this.containsXY(t.x,t.y)},containsRect:function(t){return this.containsPoint(t.topLeft())&&this.containsPoint(t.bottomRight())},center:function(){return{x:this.x+this.width/2,y:this.y+this.height/2}},center2:function(){return{x:this.x+this.width/2,y:this.y-this.height/2}},topLeft:function(){return{x:this.x,y:this.y}},bottomRight:function(){return{x:this.x+this.width,y:this.y+this.height}},bottomRight2:function(){return{x:this.x+this.width,y:this.y-this.height}},containsXY:function(t,e){return t>=this.x&&t<=this.x+this.width&&e>=this.y&&e<=this.y+this.height},equals:function(t){return t.toString()==this.toString()},clone:function(){return new GCO5.model.geom.Rectangle(this.x,this.y,this.width,this.height)},toString:function(){return this?"[Rectangle (x="+this.x+" y="+this.y+" width="+this.width+" height="+this.height+")]":null},toStringCompact:function(t,e){return t=t||"|",e?this?Math.round(this.x)+t+Math.round(this.y)+t+Math.round(this.width)+t+Math.round(this.height):null:this?this.x+t+this.y+t+this.width+t+this.height:null}}),GCO5.model.geom.Matrix=GCO5.Class.extend({statics:{NAME:"GCO5.model.geom.Matrix"},a:1,b:0,c:0,d:1,tx:0,ty:0,initialize:function(t,e,i,n,r,a){return this.a=null==t?1:t,this.b=e||0,this.c=i||0,this.d=null==n?1:n,this.tx=r||0,this.ty=a||0,this},prepend:function(t,e,i,n,r,a){var s,o,l=this.tx;return 1==t&&0==e&&0==i&&1==n||(s=this.a,o=this.c,this.a=s*t+this.b*i,this.b=s*e+this.b*n,this.c=o*t+this.d*i,this.d=o*e+this.d*n),this.tx=l*t+this.ty*i+r,this.ty=l*e+this.ty*n+a,this},append:function(t,e,i,n,r,a){var s=this.a,o=this.b,l=this.c,c=this.d;return this.a=t*s+e*l,this.b=t*o+e*c,this.c=i*s+n*l,this.d=i*o+n*c,this.tx=r*s+a*l+this.tx,this.ty=r*o+a*c+this.ty,this},prependMatrix:function(t){return this.prepend(t.a,t.b,t.c,t.d,t.tx,t.ty),this},appendMatrix:function(t){return this.append(t.a,t.b,t.c,t.d,t.tx,t.ty),this},scale:function(t,e){return this.a*=t,this.d*=e,this.c*=t,this.b*=e,this.tx*=t,this.ty*=e,this},translate:function(t,e){return this.tx+=t,this.ty+=e,this},identity:function(){return this.a=this.d=1,this.b=this.c=this.tx=this.ty=0,this},appendTransform:function(t,e,i,n,r,a,s,o,l){return this.append(i,0,0,n,t,e),(o||l)&&(this.tx-=o*this.a+l*this.c,this.ty-=o*this.b+l*this.d),this},invert:function(){var t=this.a,e=this.b,i=this.c,n=this.d,r=this.tx,a=t*n-e*i;return this.a=n/a,this.b=-e/a,this.c=-i/a,this.d=t/a,this.tx=(i*this.ty-n*r)/a,this.ty=-(t*this.ty-e*r)/a,this},transformPoint:function(t,e,i){return(i=i||{}).x=t*this.a+e*this.c+this.tx,i.y=t*this.b+e*this.d+this.ty,i},transformRect:function(t){var e=t.topLeft(),t=t.bottomRight(),e=this.transformPoint(e.x,e.y),t=this.transformPoint(t.x,t.y);return new GCO5.model.geom.Rectangle(e.x,e.y,t.x-e.x,t.y-e.y)},copy:function(t){return this.initialize(t.a,t.b,t.c,t.d,t.tx,t.ty)},clone:function(){return(new GCO5.model.geom.Matrix).copy(this)},applyToCanvasContext:function(t){return t.setTransform(this.a,this.b,this.c,this.d,this.tx,this.ty),t},hasTranslatedFrom:function(t){return!!t&&(this.a===t.a&&(this.tx!=t.tx||this.ty!=t.ty))},toString:function(){return"[Matrix (a="+this.a+" b="+this.b+" c="+this.c+" d="+this.d+" tx="+this.tx+" ty="+this.ty+")]"}}),GCO5.view.display.DisplayObject=GCO5.Class.extend({statics:{NAME:"GCO5.view.display.DisplayObject",_nextCacheID:1},alpha:1,cacheCanvas:null,id:null,mouseEnabled:!0,name:null,parent:null,regX:0,regY:0,rotation:0,scaleX:1,scaleY:1,shadow:null,visible:!0,x:0,y:0,compositeOperation:null,snapToPixel:!1,filters:null,cacheID:0,mask:null,hitArea:null,cursor:null,_cacheOffsetX:0,_cacheOffsetY:0,_cacheScale:1,_cacheDataURLID:0,_cacheDataURL:null,_matrix:null,_rectangle:null,_bounds:null,initialize:function(){this.id=GCO5.getUID(),this._matrix=new GCO5.model.geom.Matrix,this._rectangle=new GCO5.model.geom.Rectangle},isVisible:function(){return!!(this.visible&&0<this.alpha&&0!=this.scaleX&&0!=this.scaleY)},getBounds:function(){if(this._bounds)return this._rectangle.copy(this._bounds);var t,e=this.cacheCanvas;return e?(t=this._cacheScale,this._rectangle.initialize(this._cacheOffsetX,this._cacheOffsetY,e.width/t,e.height/t)):null},draw:function(t,e){var i=this.cacheCanvas;if(e||!i)return!1;var e=this._cacheScale,n=this._cacheOffsetX,r=this._cacheOffsetY;return t.drawImage(i,n,r,i.width/e,i.height/e),!0},updateContext:function(t){this.mask;var e=this,i=e._matrix.identity().appendTransform(e.x,e.y,e.scaleX,e.scaleY,e.rotation,e.skewX,e.skewY,e.regX,e.regY);t.transform(i.a,i.b,i.c,i.d,i.tx,i.ty),t.globalAlpha*=e.alpha},cache:function(t,e,i,n,r){console.log("cache"),r=r||1,this.cacheCanvas||(this.cacheCanvas=document.createElement("canvas")),this._cacheWidth=i,this._cacheHeight=n,this._cacheOffsetX=t,this._cacheOffsetY=e,this._cacheScale=r,this.updateCache()},uncache:function(){this._cacheDataURL=this.cacheCanvas=null,this.cacheID=this._cacheOffsetX=this._cacheOffsetY=0,this._cacheScale=1},updateCache:function(t){var e=this.cacheCanvas,i=this._cacheScale,n=this._cacheOffsetX*i,r=this._cacheOffsetY*i,a=this._cacheWidth,s=this._cacheHeight;if(!e)throw"cache() must be called before updateCache()";var o=e.getContext("2d"),a=Math.ceil(a*i),s=Math.ceil(s*i);a!=e.width||s!=e.height?(e.width=a,e.height=s):t||o.clearRect(0,0,a+1,s+1),o.save(),o.globalCompositeOperation=t,o.setTransform(i,0,0,i,-n,-r),this.draw(o,!0),o.restore(),this.cacheID=GCO5.view.display.DisplayObject._nextCacheID++},clone:function(){var t=new GCO5.view.display.Bitmap(this.image);return this.sourceRect&&(t.sourceRect=this.sourceRect.clone()),this.cloneProps(t),t},cloneProps:function(t){t.alpha=this.alpha,t.name=this.name,t.regX=this.regX,t.regY=this.regY,t.rotation=this.rotation,t.scaleX=this.scaleX,t.scaleY=this.scaleY,t.shadow=this.shadow,t.skewX=this.skewX,t.skewY=this.skewY,t.visible=this.visible,t.x=this.x,t.y=this.y,t._bounds=this._bounds,t.mouseEnabled=this.mouseEnabled,t.compositeOperation=this.compositeOperation},toString:function(){return"[DisplayObject (x="+this.x+" y="+this.y+")]"}}),GCO5.view.display.Container=GCO5.view.display.DisplayObject.extend({statics:{NAME:"GCO5.view.display.Container"},children:null,mouseChildren:null,initialize:function(){this._super(),this.children=[],this.name="cont"+this.id},draw:function(t,e){if(!this._super(t,e))for(var i=this.children.slice(0),n=0,r=i.length;n<r;n++){var a=i[n];a.isVisible()&&(t.save(),a.updateContext(t),a.draw(t),t.restore())}return!0},addChild:function(t){if(null!=t){var e=arguments.length;if(1<e){for(var i=0;i<e;i++)this.addChild(arguments[i]);return arguments[e-1]}t.parent&&t.parent.removeChild(t),(t.parent=this).children.push(t)}return t},addChildAt:function(t,e){var i=arguments.length,n=arguments[i-1];if(n<0||n>this.children.length)return arguments[i-2];if(2<i){for(var r=0;r<i-1;r++)this.addChildAt(arguments[r],n+r);return arguments[i-2]}return t.parent&&t.parent.removeChild(t),(t.parent=this).children.splice(e,0,t),t},getChildAt:function(t){return this.children[t]},getChildByName:function(t){for(var e=this.children,i=0,n=e.length;i<n;i++)if(e[i].name==t)return e[i];return null},removeChild:function(t){var e=arguments.length;if(1<e){for(var i=!0,n=0;n<e;n++)i=i&&this.removeChild(arguments[n]);return i}return this.removeChildAt(this.children.indexOf(t))},removeChildAt:function(t){var e=arguments.length;if(1<e){for(var i=[],n=0;n<e;n++)i[n]=arguments[n];i.sort(function(t,e){return e-t});for(var r=!0,n=0;n<e;n++)r=r&&this.removeChildAt(i[n]);return r}if(t<0||t>this.children.length-1)return!1;var a=this.children[t];return a&&(a.parent=null),this.children.splice(t,1),!0},removeAllChildren:function(){for(var t=this.children;t.length;)t.pop().parent=null},getNumChildren:function(){return this.children.length},getBounds:function(){return this._getBounds(null,!0)},getTransformedBounds:function(){return this._getBounds()},_getBounds:function(t,e){var i,n,r,a,s=this._super();if(s)return this._transformBounds(s,t,e);for(var o=e?this._matrix.identity():this.getMatrix(this._matrix),l=(t&&o.prependMatrix(t),this.children.length),c=0;c<l;c++){var h,d=this.children[c];d.visible&&(s=d._getBounds(o))&&(d=s.x,h=s.y,(d<i||null==i)&&(i=d),(n<(d=d+s.width)||null==n)&&(n=d),(h<r||null==r)&&(r=h),(a<(d=h+s.height)||null==a)&&(a=d))}return null==n?null:this._rectangle.initialize(i,r,n-i,a-r)},clone:function(){var t=new GCO5.view.display.Container;return this.sourceRect&&(t.sourceRect=this.sourceRect.clone()),t},toString:function(){return"[container (x="+this.x+" y="+this.y+")]"}}),GCO5.view.display.Stage=GCO5.view.display.Container.extend({statics:{NAME:"GCO5.view.display.Stage",_snapToPixelEnabled:!1},autoClear:!0,canvas:null,mouseX:0,mouseY:0,mouseInBounds:!1,mouseMoveOutside:!1,nextStage:null,tickOnUpdate:!0,initialize:function(t){this._super(),this.canvas="string"==typeof t?document.getElementById(t):t,this._pointerData={}},update:function(t){var e;this.canvas&&(this.autoClear&&this.clear(),e=this.canvas.getContext("2d"),this.updateContext(e),this.draw(e,!1))},clear:function(){this.canvas&&(GCO5.browser.canvasBugged?this.canvas.width=this.canvas.width:this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height))},clone:function(){var t=new GCO5.view.display.Bitmap(this.image);return this.sourceRect&&(t.sourceRect=this.sourceRect.clone()),t},toString:function(){return"[Stage (x="+this.x+" y="+this.y+")]"}}),GCO5.view.display.Text=GCO5.view.display.DisplayObject.extend({statics:{NAME:"GCO5.view.display.Text",H_OFFSETS:{start:0,left:0,center:-.5,end:-1,right:-1},V_OFFSETS:{top:0,hanging:-.01,middle:-.4,alphabetic:-.8,ideographic:-.85,bottom:-1},_workingContext:null,pxInEm:null},text:"",font:null,color:null,textAlign:"left",etiqAlign:null,lineHeight:0,lineWidth:null,outline:0,halo:!1,offsetX:0,offsetY:0,textBaseline:"top",initialize:function(t,e,i,n){this._super(),this.text=t,this.font=e,this.color=i,this.halo=n,GCO5.view.display.Text._workingContext||(t=document.createElement("canvas")).getContext&&(GCO5.view.display.Text._workingContext=t.getContext("2d"),t.width=t.height=1)},_prepContext:function(t){return t.font=this._replaceEmByPx(this.font),t.textAlign=this.textAlign||"left",t.textBaseline=this.textBaseline||"top",t},draw:function(t,e){return this._super(t,e)||(e=this.color||"#000",this.outline?(t.strokeStyle=e,t.lineWidth=+this.outline):t.fillStyle=e,this._drawText(this._prepContext(t))),!0},getMeasuredWidth:function(){return this._prepContext(GCO5.view.display.Text._workingContext).measureText(this.text).width},getMeasuredHeight:function(){return this._drawText(null,{}).height},getMeasuredLineHeight:function(){return this._prepContext(GCO5.view.display.Text._workingContext).measureText("M").width*(this.halo,1.2)},_replaceEmByPx:function(t){var e,i=t.split(" ");for(e in i)"em"==i[e].substr(-2,2)&&(i[e]=String(Math.round(10*parseFloat(i[e])*this._getPxInEm())/10)+"px");return i.join(" ")},_getPxInEm:function(){return parseFloat(getComputedStyle(document.body).fontSize)},_drawText:function(t,e){for(var i=!!t,n=(i||(t=this._prepContext(GCO5.view.display.Text._workingContext)),this.lineHeight||this.getMeasuredLineHeight()),r=0,a=0,s=String(this.text).split(/(?:\r\n|\r|\n)/),o=0,l=s.length;o<l;o++){var c=s[o],h=null;i&&this._drawTextLine(t,c,a*n),r<(h=e&&null==h?t.measureText(c).width:h)&&(r=h),a++}return e&&(e.count=a,e.width=r,e.height=a*n),e},_drawTextLine:function(t,e,i){if(this.outline)t.strokeText(e,0,i,this.maxWidth||65535);else if(this.halo){for(var n=this._getPxInEm()/16,r=this.getMeasuredHeight(),a=(t.save(),t.measureText(e).width),s=[1,2,3],o=(s.pop(),s.length);o--;){var l=s[o],c=a+2*(l*=5*n),h=0,d=c,u=-l+h-a/2,p=-r-this.offsetY-2,g=("t"!=this.etiqAlign&&("l"==this.etiqAlign?(u-=a/2,h=-this.offsetX,p=-r/2-1+3):"b"==this.etiqAlign?p=this.offsetY-1+3:"r"==this.etiqAlign&&(p=-r/2-1+3,u=-l+(h=this.offsetX))),-2*l+p);t.save(),t.beginPath(),t.rect(u,g,c+2*l,4*l+r),t.clip(),t.shadowColor="#fff",t.shadowOffsetX=d,t.shadowBlur=l,t.fillText(e,-d+h,i+p,this.maxWidth||65535),t.restore()}t.restore(),t.save(),t.beginPath(),t.rect(u-10,p,c+2*l,4*l+r),t.clip(),t.strokeStyle="rgb(254,254,254)",t.lineWidth=(GCO5.browser.isIOS?3:4)*n,t.globalAlpha=GCO5.browser.isIOS?.7:GCO5.browser.isAndroid?.6:.4,t.strokeText(e,h,i+p+(GCO5.browser.isIOS?.5:0),this.maxWidth||65535),t.restore(),t.globalAlpha=1,t.fillText(e,h,i+p,this.maxWidth||65535)}else t.fillText(e,0,i,this.maxWidth||65535)},cloneProps:function(t){this._super(t),t.textAlign=this.textAlign,t.textBaseline=this.textBaseline,t.maxWidth=this.maxWidth,t.outline=this.outline,t.lineHeight=this.lineHeight,t.lineWidth=this.lineWidth,t.halo=this.halo},clone:function(){var t=new GCO5.view.display.Text(this.text,this.font,this.color);return this.cloneProps(t),t},toString:function(){return"[Text (x="+this.x+" y="+this.y+")]"}}),GCO5.view.display.Bitmap=GCO5.view.display.DisplayObject.extend({statics:{NAME:"GCO5.view.display.Bitmap"},image:null,sourceRect:null,snapToPixel:!0,initialize:function(t){this._super(),"string"==typeof t?(this.image=document.createElement("img"),this.image.src=t):this.image=t},isImage:function(t){return t instanceof HTMLImageElement||t instanceof HTMLCanvasElement},isVisible:function(){var t=this.cacheCanvas||this.image;return!!(this.visible&&0<this.alpha&&0!=this.scaleX&&0!=this.scaleY&&t)},draw:function(e,t){var i,n;return this._super(e,t)||(i=this.sourceRect,n=this.image,this.isImage(n)?i?e.drawImage(n,i.x,i.y,i.width,i.height,0,0,i.width,i.height):e.drawImage(n,0,0):$("canvas",n).each(function(t){n=this,$(this).is(":visible"),i?e.drawImage(n,i.x,i.y,i.width,i.height,0,0,i.width,i.height):e.drawImage(n,0,0)})),!0},clone:function(){var t=new GCO5.view.display.Bitmap(this.image);return this.sourceRect&&(t.sourceRect=this.sourceRect.clone()),t},toString:function(){return"[Bitmap (x="+this.x+" y="+this.y+")]"}}),GCO5.view.display.Shape=GCO5.view.display.DisplayObject.extend({statics:{NAME:"GCO5.view.display.Shape"},graphics:null,initialize:function(t){this._super(),this.graphics=t||new GCO5.view.display.Graphics},isVisible:function(){var t=this.cacheCanvas||this.graphics&&!this.graphics.isEmpty();return!!(this.visible&&0<this.alpha&&0!=this.scaleX&&0!=this.scaleY&&t)},draw:function(t,e){return this._super(t,e)||this.graphics.draw(t),!0},clone:function(t){t=new GCO5.view.display.Shape(t&&this.graphics?this.graphics.clone():this.graphics);return this.cloneProps(t),t},toString:function(){return"[Shape (name="+this.name+")]"}}),GCO5.view.display.Graphics=GCO5.Class.extend({statics:{NAME:"GCO5.view.display.Graphics",getRGB:function(t,e,i,n){return null!=t&&null==i&&(n=e,i=255&t,e=t>>8&255,t=t>>16&255),null==n?"rgb("+t+","+e+","+i+")":"rgba("+t+","+e+","+i+","+n+")"},getHSL:function(t,e,i,n){return null==n?"hsl("+t%360+","+e+"%,"+i+"%)":"hsla("+t%360+","+e+"%,"+i+"%,"+n+")"},STROKE_CAPS_MAP:["butt","round","square"],STROKE_JOINTS_MAP:["miter","round","bevel"]},_strokeInstructions:null,_strokeStyleInstructions:null,_strokeIgnoreScale:!1,_fillInstructions:null,_fillMatrix:null,_instructions:null,_oldInstructions:null,_activeInstructions:null,_active:!1,_dirty:!1,initialize:function(t){var e,i;this.clear(),GCO5.view.display.Graphics._ctx||((GCO5.view.display.Graphics.Command=function(t,e,i){this.f=t,this.params=e,this.path=null==i||i}).prototype.exec=function(t){this.f.apply(t,this.params)},(e=document.createElement("canvas")).getContext&&(i=e.getContext("2d"),GCO5.view.display.Graphics._ctx=i,GCO5.view.display.Graphics.beginCmd=new GCO5.view.display.Graphics.Command(i.beginPath,[],!1),GCO5.view.display.Graphics.fillCmd=new GCO5.view.display.Graphics.Command(i.fill,[],!1),GCO5.view.display.Graphics.strokeCmd=new GCO5.view.display.Graphics.Command(i.stroke,[],!1),e.width=e.height=1)),this._ctx=GCO5.view.display.Graphics._ctx},isEmpty:function(){return!(this._instructions.length||this._oldInstructions.length||this._activeInstructions.length)},draw:function(t){this._dirty&&this._updateInstructions();for(var e=this._instructions,i=0,n=e.length;i<n;i++)e[i].exec(t)},moveTo:function(t,e){return this._activeInstructions.push(new GCO5.view.display.Graphics.Command(this._ctx.moveTo,[t,e])),this},lineTo:function(t,e){return this._dirty=this._active=!0,this._activeInstructions.push(new GCO5.view.display.Graphics.Command(this._ctx.lineTo,[t,e])),this},rect:function(t,e,i,n){return this._dirty=this._active=!0,this._activeInstructions.push(new GCO5.view.display.Graphics.Command(this._ctx.rect,[t,e,i,n])),this},drawRect:this.rect,closePath:function(){return this._active&&(this._dirty=!0,this._activeInstructions.push(new GCO5.view.display.Graphics.Command(this._ctx.closePath,[]))),this},beginFill:function(t){return this._active&&this._newPath(),this._fillInstructions=t?[new GCO5.view.display.Graphics.Command(this._setProp,["fillStyle",t],!1)]:null,this._fillMatrix=null,this},endFill:function(){return this.beginFill()},setStrokeStyle:function(t,e,i,n,r){return this._active&&this._newPath(),this._strokeStyleInstructions=[new GCO5.view.display.Graphics.Command(this._setProp,["lineWidth",null==t?"1":t],!1),new GCO5.view.display.Graphics.Command(this._setProp,["lineCap",null==e?"butt":isNaN(e)?e:GCO5.view.display.Graphics.STROKE_CAPS_MAP[e]],!1),new GCO5.view.display.Graphics.Command(this._setProp,["lineJoin",null==i?"miter":isNaN(i)?i:GCO5.view.display.Graphics.STROKE_JOINTS_MAP[i]],!1),new GCO5.view.display.Graphics.Command(this._setProp,["miterLimit",null==n?"10":n],!1)],this._strokeIgnoreScale=r,this},beginStroke:function(t){return this._active&&this._newPath(),this._strokeInstructions=t?[new GCO5.view.display.Graphics.Command(this._setProp,["strokeStyle",t],!1)]:null,this},endStroke:function(){return this.beginStroke(),this},arc:function(t,e,i,n,r,a){return this._dirty=this._active=!0,null==a&&(a=!1),this._activeInstructions.push(new GCO5.view.display.Graphics.Command(this._ctx.arc,[t,e,i,n,r,a])),this},drawCircle:function(t,e,i){return this.arc(t,e,i,0,2*Math.PI),this},drawPolyStar:function(t,e,i,n,r,a){this._dirty=this._active=!0,r=1-(r=null==r?0:r),null==a?a=0:a/=180/Math.PI;var s=Math.PI/n;this._activeInstructions.push(new GCO5.view.display.Graphics.Command(this._ctx.moveTo,[t+Math.cos(a)*i,e+Math.sin(a)*i]));for(var o=0;o<n;o++)a+=s,1!=r&&this._activeInstructions.push(new GCO5.view.display.Graphics.Command(this._ctx.lineTo,[t+Math.cos(a)*i*r,e+Math.sin(a)*i*r])),a+=s,this._activeInstructions.push(new GCO5.view.display.Graphics.Command(this._ctx.lineTo,[t+Math.cos(a)*i,e+Math.sin(a)*i]));return this},beginRadialGradientFill:function(t,e,i,n,r,a,s,o){this._active&&this._newPath();for(var l=this._ctx.createRadialGradient(i,n,r,a,s,o),c=0,h=t.length;c<h;c++)l.addColorStop(e[c],t[c]);return this._fillInstructions=[new GCO5.view.display.Graphics.Command(this._setProp,["fillStyle",l],!1)],this._fillMatrix=null,this},clone:function(){var t=new Graphics;return t._instructions=this._instructions.slice(),t._activeInstructions=this._activeInstructions.slice(),t._oldInstructions=this._oldInstructions.slice(),this._fillInstructions&&(t._fillInstructions=this._fillInstructions.slice()),this._strokeInstructions&&(t._strokeInstructions=this._strokeInstructions.slice()),this._strokeStyleInstructions&&(t._strokeStyleInstructions=this._strokeStyleInstructions.slice()),t._active=this._active,t._dirty=this._dirty,t._fillMatrix=this._fillMatrix,t._strokeIgnoreScale=this._strokeIgnoreScale,t},toString:function(){return"[Graphics]"},clear:function(){return this._instructions=[],this._oldInstructions=[],this._activeInstructions=[],this._strokeStyleInstructions=this._strokeInstructions=this._fillInstructions=this._fillMatrix=null,this._active=this._dirty=this._strokeIgnoreScale=!1,this},_updateInstructions:function(){this._instructions=this._oldInstructions.slice(),this._instructions.push(GCO5.view.display.Graphics.beginCmd),this._appendInstructions(this._fillInstructions),this._appendInstructions(this._strokeInstructions),this._appendInstructions(this._strokeInstructions&&this._strokeStyleInstructions),this._appendInstructions(this._activeInstructions),this._fillInstructions&&this._appendDraw(GCO5.view.display.Graphics.fillCmd,this._fillMatrix),this._strokeInstructions&&this._appendDraw(GCO5.view.display.Graphics.strokeCmd,this._strokeIgnoreScale&&[1,0,0,1,0,0])},_appendInstructions:function(t){t&&this._instructions.push.apply(this._instructions,t)},_appendDraw:function(t,e){e?this._instructions.push(new GCO5.view.display.Graphics.Command(this._ctx.save,[],!1),new GCO5.view.display.Graphics.Command(this._ctx.transform,e,!1),t,new GCO5.view.display.Graphics.Command(this._ctx.restore,[],!1)):this._instructions.push(t)},_newPath:function(){this._dirty&&this._updateInstructions(),this._oldInstructions=this._instructions,this._activeInstructions=[],this._active=this._dirty=!1},_setProp:function(t,e){this[t]=e}}),GCO5.view.component.MapView=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.MapView",REQUEST_CHANGE_VIEW:"rqchgview",INFOSEL:"infosel",ONBUILD_INFOSEL:"onbinfos",UPD_HABILL_LAYER:"updHabLy",UPD_ZON_LAYER:"updZonLy",UPD_LEGEND:"updleg",END_RENDER:"endrender",REFRAME:"zoomOnFullExtent",ZOOMONSEL:"zoomsel",DELSEL:"delsel",MOUSEMOVE:"rov",END_NEW_EXTENT:"endmapext",UPD_RASTER_SERVICES:"updrstsrv",UPD_SERIE:"updserie",END_ANIM:"endanim",REPROJ:"reproj",DRAGGING:"dragging",RASTER_LOADED:"rstldd",ZOOMBACK1:1.25,ZOOMBACK2:3.1,ZOOMMAX:1e3,SCALES:[1e4,5e3,1e3,500,200,100,50,20,10,5,1,.5,.1,.05,.025,.0125]},container:null,selectionManager:null,mapName:null,nivgeo:null,copyrights:null,mapToolTip:null,global_ly_o:null,styles:null,lyRaster:null,_zoomRectActive:null,_zoomRectDrawing:null,_printMode:null,_captureStage:null,_captureCanvas:null,_bmpMap:null,gclg:GCO5.core.GcLangManager.getInstance(),gcsm:GCO5.core.SystemManager.getInstance(),_changingViewKeepExtent:null,_lastMapNameBeforeChangeView:null,_rovStage:null,_etiqStage:null,_toolsStage:null,_ly_a:null,_ly_o:null,_bmpMap0_o:null,_transformMt0:null,_transformMt00:null,_transformMt:null,_lastTransformMt:null,_WtoS_Matrix0:null,_mapExtentA:null,_mapExtentC:null,_mapExtent0:null,_srId0:null,_srId:null,_mapExtentA_o:null,_mapExtentC_o:null,_WtoS_Matrix_o:null,_transformMt0_o:null,_transformMt00_o:null,_rovobj_o:null,_dirty_o:null,_rendering:!1,_animating:!1,_dragging:!1,_pinching:!1,_tapHolding:!1,_doubleTapping:!1,_containerResizing:!1,_isTouchDevice:!1,_zoomingOnSelection:null,_selCircle:null,_mx:-1,_my:-1,_x00:0,_y00:0,_r00:null,_map_x:null,_map_y:null,_cvnames_a:null,_cvVisi_o:null,_drag_a:null,_lastPos:null,_hash0_o:null,_lastBmpx:null,_lastBmpy:null,legendManager:null,initialize:function(t){var e;this.container=t.mapContainer,this._createContainerStructure(t),this.global_ly_o={},this.styles={},t.styles&&t.styles.noMouseEvents||(e=t.styles&&t.styles.mouseEventList?t.styles.mouseEventList:null,this._addListeners(e)),this._isSelectable(t.layers)&&(this.selectionManager=new GCO5.view.component.MapSelections(this,t),this._addProxySelFunctions()),this.legendManager=new GCO5.view.component.MapLegends(this),this._addProxyLegendFunctions(),this.setup(t)},getContainer:function(){return this.container},getEpsg:function(){return this._srId},setPrintMode:function(t){var e;this._printMode=t,500<GCO5.browser.width&&(e=this.getPrintMapScaleRatio(),t?this._transformMt.scale(e,e):this._transformMt.scale(1/e,1/e))},getPrintMode:function(t){return this._printMode},onBuildInfosel:function(t){this.legendManager.onBuildInfosel(t)},_addProxyLegendFunctions:function(){var t,e=["clearLegend","getLegendPrecision"];for(t in e){var i=e[t];this[i]=$.proxy(this.legendManager[i],this.legendManager)}},getLinkedMap:function(){return this.linkedMap},hasCompatibleLinkedMap:function(){return this.linkedMap&&this.linkedMap.getIdExtent()==this.getIdExtent()},linkToMap:function(t,e){t?(this.linkedMap=t,e&&this.linkedMap.linkToMap(this)):(e&&this.linkedMap.linkToMap(),this.linkedMap=null)},getLibView:function(){return GCO5.appModel.getInfo("infoFromMapName",[this.mapName,"lib_view"]).split("|").join(" ")},hasLayer:function(t){return!!this.global_ly_o[t]},containerIsResizing:function(){this._containerResizing=!0},_createContainerStructure:function(t){this.container.append("<div id='mapgroup_cv'></div><div id='maptooltip' class='no-display unselectable maptooltip' ></div>"),this._configContainer(t)},_configContainer:function(t){this._captureCanvas=this.getCanvas("mapcapture"),this._rovStage=new GCO5.view.display.Stage(this.getCanvas("maprov")),this._etiqStage=new GCO5.view.display.Stage(this.getCanvas("mapetiq")),$("#mapgroup_cv").on("mousedown",function(t){t.preventDefault()},!1),GCO5.browser.translate3d?this._bmpMap={x:0,y:0,scaleX:1,scaleY:1,alpha:1}:(this._captureStage=new GCO5.view.display.Stage(this._captureCanvas),this._bmpMap=new GCO5.view.display.Bitmap(document.createElement("canvas")),this._captureStage.addChild(this._bmpMap));t=t.rovContainer||$(".maptooltip",this.container);this.mapToolTip=new GCO5.view.component.MapToolTip({map:this,container:t})},getName:function(){return this.mapName},getPxMt:function(){if("4326"!=this._srId)return this.getWtoSMatrix().a;this.getMapExtent().rect;var t=this.getMapExtent().getTopLeft(),e=this.getMapExtent().getBottomRight(),t=GCO5.core.GcMathUtil.getDistanceFromLatLonInM(t.y,t.x,e.y,e.x),e=this.getWidth(),i=this.getHeight();return Math.sqrt(e*e+i*i)/t},_updateScale:function(t){for(var e=GCO5.view.component.MapView.SCALES,i=this.getPxMt(),n=0,r=e.length;n<r-1&&400/i<1e3*e[n++];);var a=1e3*e[++n]*i,s=e[n];$(".scale-label",t).html(s+this.gclg.getString("KM","units")),$(".scale-ruler",t).width(a)},drawCopyrights:function(t){if(this.rasterActive()&&!t)return this.lyRaster.drawCopyrights();var e=this.copyrights,i=this.getGlassContainer(),e=e?e+(t?" "+t:""):"";return $(".copyright",$(i)).html(e),this._updateScale($(i)),e},_isSelectable:function(t){for(var e in t=t||this._ly_a)if(t[e].styles.selectable)return!0;return!1},getSelectableLayers:function(){var t,e=[];for(t in this._ly_a){var i=this._ly_a[t].ly;i.styles.selectable&&i.isDisplayable()&&e.push(i)}return 0<e.length?e:null},getMainActiveLayerName:function(){var t,e=this._isSelectable();for(t in this._ly_a){var i=this._ly_a[t];if(i.ly){if((e&&i.styles.selectable||i.styles.rovable)&&i.ly.isPolygon())return i.name}else console.log("row.ly missing",i)}return null},getMainActiveLayer:function(){return this.getLayerByName(this.getMainActiveLayerName())},setup:function(t){var e=this.mapName!=t.mapName,i=this;this._ly_a=t.layers,this.mapName=t.mapName,this.nivgeo=t.nivgeo,this.copyrights=t.copyrights,this._lastTransformMt=null,this.setStyles(t.styles),this.updateGlobe(),this._resizeMapCanvases(),this._initLayers(),this._initMatrices(),this._initCanvasesState(),this._setSelgeo(t.selgeo,e),GCO5.core.GcDelayUtil.callLater(function(){i.render(),e&&(i.onNewIndicData(!1),t.selgeo&&(i._zoomingOnSelection=!0)),i._changingViewKeepExtent||GCO5.core.GcDelayUtil.callLater(i._captureBmp0,[],12,i)},[],GCO5.testMode?0:2)},getStatLayerName:function(){return this.lyStat?this.lyStat.layerName:null},_setSelgeo:function(t,e,i){t?(this.styles.inReport&&(this._zoomingOnSelection=!0),this.selectionManager&&this.selectionManager.setSelgeo(t,i),e&&!this._changingViewKeepExtent&&this.clearSelCanvas()):this.selectionManager&&this.selectionManager.clearSel("*")},onNewIndicData:function(t){this.selectionManager&&this.onLoadInfosel(),!t&&this.isFullExtentDisplayed()&&this.clearBitmapCache({newIndic:!0})},setStyles:function(t){this.styles||(this.styles={}),GCO5.core.GcObjectUtil.extend(this.styles,t),this.styles.width||(this.styles.width=this.container.width(),this.styles.height=this.container.height())},getStyle:function(t){return this.styles[t]},drawSelgeo:function(t,e,i,n){this.selectionManager&&(this.selectionManager.setSelgeo(t,e),this.selectionManager.drawSelgeo(e,i,n))},_addProxySelFunctions:function(){var t,e=["getSelgeo","getSelIds","clearSel","drawSelIds","onLoadInfosel","getInfoSel","getSelExtent","hasSingleSelgeo","hasMultSelgeo","getSelgeoCenterWorld","getLastSelAddedInfo","getMetaSel","getLibSel","getNbSelObjs","getFormattedTabVarsInfo","getSelDescriptions","testCallInfosel"];for(t in e){var i=e[t];this[i]=$.proxy(this.selectionManager[i],this.selectionManager)}},_addListeners:function(i){function n(t){o._zoomRectDrawing&&o._clearToolStage(),27===t.keyCode&&$(".map-zoom-rect",o.container).click()}var t,e,r,a,s,o=this,l=GCO5.browser.width<500,c=new Hammer.Manager($("#mapgroup_cv",this.container).get(0)),h=(c.add(t=new Hammer.Tap({event:"singletap",taps:1,threshold:l?7:15})),c.add(e=new Hammer.Tap({event:"doubletap",taps:2})),c.add(new Hammer.Pan({direction:Hammer.DIRECTION_ALL,threshold:l?10:20})),c.add(new Hammer.Press({time:300,threshold:l?7:15})),c.add(new Hammer.Pinch({enable:!0})),e.recognizeWith(t),t.requireFailure(e),$(".map-zoom-in",this.container).on("click",function(t){o.setMapExtent(o.getMapExtent().scale(1.2),!1,"+")}),$(".map-zoom-reframe",this.container).on("click",function(t){o.zoomOnFullExtent()}),$(".map-wmts",this.container).on("click",function(t){var e,i,n,r=GCO5.appModel.getOption("btMapWMTS");o.getRasterInfo().globe==r?GCO5.core.GcDelayUtil.callLater(o.updateGlobe,[],0,o):(e=0,o.is3857Projected()&&""!=r&&!GCO5.view.component.ARasterProvider.is3857Globe(r)&&(o.updateGlobe(),o.restoreProjInit(),e=45),i=GCO5.appModel.getInfo("viewDef",[o.getName()]),n=(i=GCO5.core.GcArrayUtil.getSubArray(i.tiles,{id_globe:[r]}))[0].capURL,GCO5.core.GcDelayUtil.callLater(o.updateGlobe,[r,null,n,i[0].services],e,o))}),$(".map-zoom-rect",this.container).on("click",function(t){$(o._captureCanvas).toggleClass("cursor-zoom");var e=o._zoomRectActive="crosshair"==$(o._captureCanvas).css("cursor"),i=(e?($(document).one("keyup",n),$("#mapgroup_cv",o.container).on("mousedown touchstart",function(t){o._initRectZoom(t)})):($(document).off("keyup",n),$("#mapgroup_cv",o.container).off("mousedown touchstart"),o._zoomRectDrawing=!1),o.getGlassContainer());$(".mapHint",$(i)).text(e?o.gclg.getString("DRAW_ZOOM_RECT","map"):"").css("display",e?"block":"none")}),$(".map-zoom-out",this.container).on("click",function(t){o.setMapExtent(o.getMapExtent().scale(.8),!1,"-")}),$(["PanStart","Pan","PanEnd","PanCancel","Press","PressUp","SingleTap","DoubleTap","Pinch","PinchEnd","PinchCancel"]).each(function(t){var e=this;i&&!i[e]||c.on(this.toLowerCase(),function(t){o["on"+e].apply(o,[t])})}),i&&!i.mouseMove||(this.container.on("mouseenter mouseleave",".map-control",function(t){t=t.originalEvent&&t.originalEvent.touches?t.originalEvent.touches[0]:t;r="mouseenter"==t.type}),this.container.on("mousemove touchmove",function(t){var e=t.originalEvent&&t.originalEvent.touches?t.originalEvent.touches[0]:t;r&&"touchmove"!=t.type?o.clearLayerRovInfo.apply(o,[null,!0]):o.onVMouseMove.apply(o,[e])}),this.container.on("mouseleave",function(t){o.clearLayerRovInfo.apply(o,[null,!0])})),this.container);i&&!i.mouseWheel||(a=[],s=parseInt($(document)["offsetParent"in $.fn?"offsetParent":"parent"]().css("fontSize"),10),GCO5.core.GcDelayUtil.callLaterAfterEventStopped(h,function(t){var e,i,n;t.originalEvent&&(t=t.originalEvent),o._uiEventInMapView(t)&&!o._printMode&&(e=GCO5.core.GcArrayUtil.sum(a)/20,a=[],i=o.getMainActiveLayerName(),n=o.getRovObjByLayerName(i),o.zoomOnFeatureId(i,n,e,t.pageX-h.offset().left,t.pageY-h.offset().top))},"wheel",100,this,function(t){t.originalEvent&&(t=t.originalEvent),a.push(-t.deltaY*(1==t.deltaMode?s:1))},function(t){return o._uiEventInMapView(t)}))},_resizeMapCanvases:function(){},getCanvas:function(t){return $("#"+t+"_cv",this.container).get(0)},_getLibgeo:function(t,e){e=e||this.getMainActiveLayerName();e=this.getLayerByName(e);return e?e.getLibgeoById(t):null},_getCodgeo:function(t,e){e=e||this.getMainActiveLayerName();e=this.getLayerByName(e);return e?e.getCodgeoById(t):null},_initCanvasesState:function(){},_getIndicInfo:function(t){return null},_initLayers:function(){this._ly_o={};for(var t=this._checkLyBackground(),e=0;e<this._ly_a.length;e++){var i=this._ly_a[e];i.zOrder=e,this._createOrFetchLayerView(i,t)}$(this.container).children().first().css("border-color",this.getStyle("colbg"))},updateLayers:function(t,e){this._ly_a=t,this._initLayers(),e||(this._resizeMapCanvases(),this.render())},_checkLyBackground:function(){for(var t in this._ly_a){var e;(i=this._ly_a[t]).map=this,i.stat&&i.agreg&&(e=i.agreg)}if(e)for(var t in this._ly_a){var i;(i=this._ly_a[t]).name==e&&this._createOrFetchLayerView(i)}return e},_createOrFetchLayerView:function(t,e){var i=t.name,n=(t.styles&&t.styles.zon?"Z":"")+i,r=(n+=t.styles.fillStyle?t.styles.fillStyle.toString():"",this.global_ly_o[n]);return r?(t.cv=r._outputCanvas,t.ly=r,t.styles?t.ly.styles=t.styles:t.styles={}):(t.styles||(t.styles={}),t.cv=this._createLayerCanvas(i),r=t.ly=new GCO5.view.component.LayerView(t)),r.map=this,GCO5.appModel.isLineOrPtLayer(i)||(this.global_ly_o[n]=r),this._ly_o[i]=r},_initMatrices:function(t){t=t||{},this._mapExtentA_o={},this._mapExtentC_o={},this._WtoS_Matrix_o={},this._transformMt0_o={},this._transformMt00_o={},this._srId=this._srId0=GCO5.appModel.getInfo("html5Epsg",[this.getName()]);var e=this.getStyle("zoomOut"),i=this.getMainActiveLayer().topoModel,n=i.extentA_calage_px();"1"==GCO5.appModel.getOption("centerauto_on_statlayer")&&(n=i.extentA_px());var r=this.getWidth()/this.getHeight()<n.width/n.height?this.getWidth()/n.width:this.getHeight()/n.height,e=this._getInitialTransformMt(i,n,e*r);t.resizing||(this._transformMt=e),this._transformMt0=this._transformMt0_o[this._srId]=e.clone(),this._WtoS_Matrix0=this._WtoS_Matrix_o[this._srId]=i.getWtoS_Matrix(),this._mapExtentA=this._mapExtentA_o[this._srId]=i.extentA_mt(),this._mapExtentC=this._mapExtentA_o[this._srId]=i.extentC_mt(),this._transformMt00=this._transformMt00_o[this._srId]=this._getInitialTransformMt(i,n,r)},setProjInfo:function(t){t=t||this._srId;var e=this.getStyle("zoomOut"),i=this.getMainActiveLayer().topoModel,n=i.extentA_px(),r=this.getWidth()/this.getHeight()<n.width/n.height?this.getWidth()/n.width:this.getHeight()/n.height,e=e*r;this._WtoS_Matrix0=this._WtoS_Matrix_o[t]=i.getWtoS_Matrix(),this._mapExtentA=this._mapExtentA_o[t]=i.extentA_mt(),this._mapExtentC=this._mapExtentA_o[t]=i.extentC_mt(),this._transformMt0=this._transformMt0_o[t]=this._getInitialTransformMt(i,n,e),this._transformMt00=this._transformMt00_o[t]=this._getInitialTransformMt(i,n,r)},_getInitialTransformMt:function(t,e,i){var n=(new GCO5.model.geom.Matrix).identity(),e=(n.scale(i,i),e.center()),r=e.x-.5*t.getParam("w_px"),e=e.y-.5*t.getParam("h_px");return n.translate(this.getWidth()/2-.5*t.getParam("w_px")*i-r*i,this.getHeight()/2-.5*t.getParam("h_px")*i-e*i),n.clone()},is3857Projected:function(){return"3857"==this._srId||!this._srId},reprojTo3857:function(){console.log("reprojTo3857",this._srId0,GCO5.model.maps.AProj4.PROJ_FAM["e"+this._srId0]);var t=GCO5.model.maps.AProj4.PROJ_FAM["e"+this._srId0],t=new GCO5.model.maps["Proj4"+t](this._srId0),e=this.getMapExtent(),i=e.contains(this._mapExtentA),t=(this._srId="3857",this._lastTransformMt=null,this._reprojLayersTo3857(t),this.setProjInfo("3857"),t.projExtentTo3857(e)),n=(this.clearBitmapCache(),this.styles);i?GCO5.core.GcDelayUtil.callLater(this.zoomOnFullExtent,[!0],1,this):(n.noZoomAnim=!0,GCO5.core.GcDelayUtil.callLater(this.zoomOnFullExtent,[!0],1,this),GCO5.core.GcDelayUtil.callLater(this.setMapExtent,[t],10,this),GCO5.core.GcDelayUtil.callLater(function(){n.noZoomAnim=!1},[],30))},_reprojLayersTo3857:function(t){for(var e=this._ly_a.length,i=0;i<e;i++){var n=this._ly_a[i].ly.getTopoModel();t.reprojTo3857(n)}},isReprojected:function(){return this._srId0!==this._srId},restoreProjInit:function(t){if(this._srId0!=this._srId){var e=GCO5.model.maps.AProj4.PROJ_FAM["e"+this._srId0],e=new GCO5.model.maps["Proj4"+e](this._srId0),i=this.getMapExtent(),n=i.containsAndTouches(this._getMapExtentA5()),e=(this._lastTransformMt=null,this._srId=this._srId0,this._restoreLayersProjInit(),this.setProjInfo(this._srId),e.projExtentFrom3857(i));if(t)return e;this.clearBitmapCache();var r=this.styles;n?GCO5.core.GcDelayUtil.callLater(this.zoomOnFullExtent,[!0],10,this):(r.noZoomAnim=!0,GCO5.core.GcDelayUtil.callLater(this.zoomOnFullExtent,[!0],1,this),GCO5.core.GcDelayUtil.callLater(this.setMapExtent,[e],10,this),GCO5.core.GcDelayUtil.callLater(function(){r.noZoomAnim=!1},[],30))}},_restoreLayersProjInit:function(){for(var t=this._ly_a.length,e=0;e<t;e++)this._ly_a[e].ly.getTopoModel().restoreProjInit()},_getMapExtentA5:function(){return this._mapExtentA?this._mapExtentA.zoomOut(this.getStyle("zoomOut"),this.getStyle("roundCoord")):null},getWtoSMatrixFromExtent:function(t){var e=this.getWidth(),i=this.getHeight(),n=t.getWidth(),r=t.getHeight(),n=n/2+t.getMinx(),r=-r/2+t.getMaxy(),t=Math.min(e/t.getWidth(),i/t.getHeight());return new GCO5.model.geom.Matrix(t,0,0,-t,e/2-t*n,i/2+t*r)},getWtoSMatrix0:function(){return this._WtoS_Matrix0},getWtoSMatrix:function(){var t=this._transformMt.clone();return t.appendMatrix(this._WtoS_Matrix0),t},getStoWMatrix:function(){var t=this.getWtoSMatrix();return t.invert(),t},setMapExtent:function(t,e,i,n){t=this._validateExtent(t,i);var r=this._getLocalMatrixFromExtent(t);this._zoomOnNewTransformMt(r,e),this.hasCompatibleLinkedMap()&&!n&&this.getLinkedMap().setMapExtent(t,e,i,!0)},_validateExtent:function(t,e){var i,n;return t&&!this.anamorphing&&(i=(t=t.contains(this._getMapExtentA5())&&this.getStyle("zoomOut")<=1?this._getMapExtentA5():t).getWidth()/this.getWidth(),(n=this._getScaleFactor(t))<.3&&!t.containsAndTouches(this._getMapExtentA5())&&(t=t.scale(.3/n)),this.lyRaster&&this.lyRaster.isActive()&&this.lyRaster.hasDiscreteZooms()&&(i=Math.max(t.getWidth()/this.getWidth(),t.getHeight()/this.getHeight()),n=this.lyRaster.getClosestTilesRes(i,e),Math.round(10*i)!=Math.round(10*n)&&(t=t.scale(i/n)))),t},_getScaleFactor:function(t){return t=t||this.getMapExtent(),Math.min(1.2*this._mapExtentA.getWidth()/t.getWidth(),this._mapExtentA.getHeight()/t.getHeight())},getMapExtent:function(){var t=this.getStoWMatrix(),e=t.transformPoint(0,0),t=t.transformPoint(this.getWidth(),this.getHeight());return new GCO5.model.maps.GeoExtent({minx:e.x,maxy:e.y,w:t.x-e.x,h:Math.abs(t.y-e.y)})},getMapExtentC:function(){var t=this._WtoS_Matrix0.clone(),e=(t.invert(),t.transformPoint(0,0)),t=t.transformPoint(900,800);return new GCO5.model.maps.GeoExtent({minx:e.x,maxy:e.y,w:t.x-e.x,h:Math.abs(t.y-e.y)})},render:function(t,e,i,n){},_draw2:function(t,e,i,n){},clearSelCanvas:function(){var t=this.getSelCanvas();GCO5.core.GcBitmapUtil.clearCanvas(t),$(t).css("display","none")},setSelCanvasVisibility:function(t){this._cvVisi_o.mapsel=t},rasterActive:function(){return this.lyRaster&&this.lyRaster.isActive()},rasterWMSActive:function(){return this.rasterActive()&&this.lyRaster.isWMS()},rasterDiscreteZoomsActive:function(){return this.lyRaster&&this.lyRaster.isActive()&&this.lyRaster.hasDiscreteZooms()},gMapsActive:function(){return this.lyRaster&&this.lyRaster.isActive()&&this.lyRaster.hasGMaps()},_displayStageCanvases:function(){for(var t=this._cvnames_a,e=0;e<t.length;e++)this._cvVisi_o[t[e]]&&($(this.getCanvas(t[e])).css("display","block"),$(this.getCanvas(t[e])).css("opacity",1));var i=$(this._captureCanvas);i.removeClass("cursor-move"),i.css("opacity",0),GCO5.browser.translate3d&&(i.css("transform","none"),i.css("transform","translate3d(0, 0, 0)"))},hasSelgeo:function(t){return this.selectionManager&&this.selectionManager.hasSelgeo(t)},_clearAndResizeCanvases:function(t,e){var i,n=this.getWidth(),r=this.getHeight();"V"==t&&(e="cities",t=null);for(i in GCO5.browser.translate3d||(this._bmpMap.image.width=n,this._bmpMap.image.height=r),this._ly_a){var a=this._ly_a[i];t&&a.name!=t||e&&this._getLayerCat(a.name)!=e||((a=a.cv).width=+n,a.height=+r)}var s=this;this.container.is(":visible")&&GCO5.core.GcDelayUtil.callLater(function(){var t=$(s.getRovCanvas()).offset(),e=$(s.getRovCanvas()).closest(".mapPrintContainer");(t.left||t.top)&&(s._map_x=t.left,s._map_y=t.top,0<e.length&&(t=e.offset(),s._map_x+=t.left+1,s._map_y+=t.top+10+1))},[],20,this)},getMapXPosition:function(){return"variable"==this.styles.containerPosition?this.container.offset().left:this._map_x},getMapYPosition:function(){return"variable"==this.styles.containerPosition?this.container.offset().top:this._map_y},getLocalBBox:function(){return new GCO5.model.geom.Rectangle(0,0,this.getWidth(),this.getHeight())},getRectSelectionScreen:function(t,e){var e=this._getSelIdsExtentPx(t,e),i=e.maxxr-e.minxr,n=e.maxyr-e.minyr,e=new GCO5.model.geom.Rectangle(e.minxr,e.minyr,i,n);return t._getRectFidScreen(e,this._transformMt)},isSelectionVisible:function(t,e,i){if(!e||0==e.length)return!0;t=this.getRectSelectionScreen(t,e),t=new GCO5.model.geom.Rectangle(t.x,t.y,t.w,t.h),e=this.getLocalBBox();return i?e.intersects(t):e.containsRect(t)},addLayer:function(t,e){var i=t.name,n=this.getLayerByName(i);return n||(n=this._createOrFetchLayerView(t),0<=t.zOrder?this._ly_a.splice(t.zOrder,0,t):this._ly_a.push(t),e||this.render(i)),n},_createLayerCanvas:function(t,e){return e||((e=document.createElement("canvas")).id=t+"_cv"),e.width=this.getWidth(),e.height=this.getHeight(),e},removeLayer:function(t,e,i){var n,r,a=this.getLayerByName(t);return a&&(n=this._getLayerCat(t),r=GCO5.core.GcArrayUtil.deleteItemByKey(this._ly_a,"name",t),a.destroy(),delete this._ly_o[t],delete this._rovobj_o[t],i&&(a=r.styles&&r.styles.zon?"Z":"",delete this.global_ly_o[a+t],GCO5.appModel.clearTopoModel(t)),e||this.render(null,null,n)),!0},onRemovedFromStage:function(){for(var t in this._ly_a)this._ly_a[t].ly.onRemovedFromStage();this.clearCanvases()},destroy:function(){for(var t in this.clearLegend(),this.container.off("mousemove touchmove mouseenter mouseleave"),this._ly_a)this._ly_a[t].ly.destroy();for(var e=this._cvnames_a,i=0;i<e.length;i++)GCO5.core.GcBitmapUtil.dropCanvas(this.getCanvas(e[i]));for(t in this._bmpMap0_o)GCO5.core.GcBitmapUtil.dropCanvas(this._bmpMap0_o[t]);for(t in this)this[t]=null},viewContainsAndTouchesSelExtent:function(){var t=this.getMapExtent(),e=this.getSelExtent();return!!e&&(e=e.zoomOutPreserveRatio(1/GCO5.view.component.MapView.ZOOMBACK1),t.containsAndTouches(e))},setSize:function(t,e,i){this._containerResizing=!1,this._hasNewSize=!0;var n=this.getMapExtent(),r=!!this.hasSelgeo()&&this.viewContainsAndTouchesSelExtent(),a=(this.setStyles({width:t,height:e}),n.containsAndTouches(this._getMapExtentA5()));this._initMatrices({resizing:!a}),i||(a?this.render():r?(this.setStyles({noZoomAnim:!0}),this.zoomOnFeatureId(this.getStatLayerName(),this.getSelIds(this.getStatLayerName())),this.setStyles({noZoomAnim:!1})):(i=this._validateExtent(n),a=this._getLocalMatrixFromExtent(i),this.endNewMapext(a,{noRenderXX:!0}))),this.clearBitmapCache(),this._resizeMapCanvases(Math.floor(t),Math.floor(e))},clearCanvases:function(){this._resizeMapCanvases(1,1)},getWidth:function(){return this.getResolutionRatio()*this.getStyle("width")},getWidthWorld:function(){if("4326"==this._srId)return this.getWidth()/this.getPxMt();var t=this.getMapExtent(),e=t.getCenter(),e="3857"==this._srId?Math.cos(2*(Math.atan(Math.exp(e.y/6378137))-Math.PI/4)):1;return t.rect.width*e},getHeight:function(){return this.getResolutionRatio()*Math.floor(this.getStyle("height"))},getRovObjByLayerName:function(t){return this._rovobj_o[t]?this._rovobj_o[t].fid:null},viewContainsAndTouchesMainActiveLayer:function(t){return this.getMapExtent().containsAndTouches(this._getMapExtentA5(),t)},viewContainsAndNotTouchesMainActiveLayer:function(){var t=this.getMapExtent();return t.contains(this._mapExtentA)&&!t.containsAndTouches(this._getMapExtentA5())},getRasterInfo:function(){return this.lyRaster?{globe:this.lyRaster.getGlobe(),service:this.lyRaster.getService()}:{}},enterPrePrintMode:function(){var t,e,i,n;this.rasterWMSActive()&&(t=this.lyRaster._globe,e=this.lyRaster._service,i=this.lyRaster._capURL,n=this.lyRaster._services,this.lyRaster.hide(),GCO5.core.GcDelayUtil.callLater(this.updateGlobe,[],20,this),GCO5.core.GcDelayUtil.callLater(this.updateGlobe,[t,e,i,n],50,this))},updateGlobe:function(t,e,i,n,r){var a;(this.lyRaster||t)&&(this.lyRaster||(this.lyRaster=new GCO5.view.component.RasterLayerView(this)),(a=this)._cvVisi_o.mapraster=!!t&&"GM3"!=t,this._cvVisi_o.gmaps=!!t&&"GM3"==t,["mapraster","gmaps"].forEach(function(t){$(a.getCanvas(t)).css({opacity:0,display:"none"})}),r||(r=this.viewContainsAndTouchesMainActiveLayer(),r=this.lyRaster.updateProvider(t,r,i,n,e,this.styles.noZoomAnim),t||this.viewContainsAndNotTouchesMainActiveLayer()&&this.zoomOnFullExtent(),r&&GCO5.core.GcDelayUtil.callLater(this._buildCapture,[],50,this)))},_captureBmp0:function(t,e){if(this.isFullExtentDisplayed()){for(var i=this._cvnames_a,n=0;n<i.length-1;n++)if(!(t&&i[n]!=t||e&&e.indexOf(i[n])<0)){var r=this._bmpMap0_o[i[n]]=this._createLayerCanvas(i[n],this._bmpMap0_o[i[n]]),a=this.getCanvas(i[n]);if(a&&"none"!=$(a).css("display"))try{r.getContext("2d").drawImage(a,0,0)}catch(t){}}return r}},getEtiqCanvas:function(){return this.getCanvas("mapetiq")},getRasterContainer:function(){return this.getCanvas("mapraster")},getGlassContainer:function(){return this.getCanvas("mapglass")},getGMapsContainer:function(){return this.getCanvas("gmaps")},getSelCanvas:function(t){var e=this.getCanvas("mapsel");return t&&GCO5.core.GcBitmapUtil.clearAndResetCanvas(e),e},getRovCanvas:function(){return this._rovStage.canvas},zoomOnFullExtent:function(t){!t&&this.isFullExtentDisplayed()||(this.gcsm.freeze("map",null,!0),this.zoomOnFeatureId(this.getMainActiveLayerName(),-1))},getLayerByName:function(t){return this._ly_o[t]},clearLayerRovInfo:function(t,e,i){if(!this._animating||e){t=t||this.getMainActiveLayerName();var n,r=!1;for(n in this._rovobj_o[t]=null,this._rovobj_o)"null"!=n&&this._rovobj_o[n]&&(r=!0);r&&!e||(GCO5.core.GcBitmapUtil.clearCanvas(this._rovStage.canvas),GCO5.core.GcDelayUtil.callLater(this.mapToolTip.clear,[],2,this.mapToolTip),i||$(this).triggerHandler(GCO5.view.component.MapView.MOUSEMOVE,[null,t]))}},hasTranslated:function(){return!(!this._lastTransformMt||this._hasNewSize)&&this._transformMt.hasTranslatedFrom(this._lastTransformMt)},hasScaled:function(){return!!this._lastTransformMt&&this._transformMt.a!=this._lastTransformMt.a},getMatrix:function(){return this._transformMt.clone()},getScaleRatio:function(){return this._transformMt.a/this._transformMt0.a},getPrintMapScaleRatio:function(){return this.rasterWMSActive()?1:2},getResolutionRatio:function(){return this.getPrintMode()&&500<GCO5.browser.width?this.getPrintMapScaleRatio():1},_buildCapture:function(t){if(!this._rendering)for(var e,i=this._captureCanvas,n=(i.width!=this.getWidth()&&(i.width=this.getWidth()),i.height!=this.getHeight()&&(i.height=this.getHeight()),this.getResolutionRatio()),r=(i.style.width=i.width/n+"px",i.style.height=i.height/n+"px",GCO5.browser.translate3d?(GCO5.core.GcBitmapUtil.clearCanvas(i),i.getContext("2d").globalAlpha=.25):(i=this._bmpMap.image,GCO5.core.GcBitmapUtil.clearCanvas(i)),this._cvnames_a),a=i.getContext("2d"),s=0;s<r.length;s++)"mapcities"!=r[s]&&"mapetiq"!=r[s]&&"mapsvgetiq"!=r[s]&&"gmaps"!=r[s]&&this._cvVisi_o[r[s]]&&this.getCanvas(r[s])&&("mapraster"==r[s]||"mapglass"==r[s]?!this.lyRaster||e||this.lyRaster.hasGMaps()||(this.lyRaster.storeCanvasSnapshot(a),e=!0):a.drawImage(this.getCanvas(r[s]),0,0))},_initExportCanvas:function(){var t=this._captureCanvas,e=document.createElement("canvas"),t=(e.width=t.width,e.height=t.height,e.getContext("2d"));return t.fillStyle=this.getStyle("colbg"),t.fillRect(0,0,e.width,e.height),GCO5.browser.translate3d?t.globalAlpha=1:t.drawImage(this._bmpMap.image,0,0),e},captureGmaps:function(){for(var t=this._cvnames_a,e=0;e<t.length;e++)if(this._cvVisi_o[t[e]]&&this.getCanvas(t[e])&&"gmaps"==t[e]&&this.lyRaster)return this.lyRaster.storeCanvasSnapshot(this._captureCanvas.getContext("2d"),!0),!0},exportImage:function(t){this._captureCanvas;for(var e,i,n,r=this._initExportCanvas(),a=r.getContext("2d"),s=this._cvnames_a,o=0;o<s.length;o++)!this._cvVisi_o[s[o]]||(e=this.getCanvas(s[o]))&&("mapraster"==s[o]||"gmaps"==s[o]?this.lyRaster&&this.lyRaster.supportCrossOrigin()&&this.lyRaster.storeCanvasSnapshot(a):"mapsvgetiq"==s[o]?(i=document.createElement("canvas"),n=this.getCanvas("mapsvgetiq"),i.width=r.width,i.height=r.height,svgAsDataUri(n,1,function(t,e){canvg(i,e,{ignoreClear:!0}),a.drawImage(i,0,0)})):0!=$(e).css("opacity")&&GCO5.core.GcBitmapUtil.isImage(e)&&(r.getContext("2d").globalAlpha=$(e).css("opacity"),a.drawImage(e,0,0)));return r},startNewMapext:function(){this.clearLayerRovInfo(null,!0),this._animating=!0,this._bmpMap.x=this._bmpMap.y=0,this._bmpMap.scaleX=this._bmpMap.scaleY=1;for(var t=this._cvnames_a,e=0;e<t.length;e++)$(this.getCanvas(t[e])).css("opacity",0);this._bmpMap.alpha=.25,$(this._captureCanvas).css("opacity",1)},_testChangeMapOnZoom:function(){if(0==this.getStyle("drillMaps")||!this._getIndicInfo())return null;var t=GCO5.appModel.getInfo("testChangeMapOnZoom",[this.mapName,this.getScaleRatio(),this._lastMapNameBeforeChangeView]);return t?(this._lastMapNameBeforeChangeView=t.lastMapNameBeforeChangeView,{mapName:t.newMapName,nivgeo:t.newNivgeo}):null},_getLocalMatrixFromExtent:function(t){var t=this.getWtoSMatrixFromExtent(t).clone(),e=this._WtoS_Matrix0.clone();return e.invert(),t.appendMatrix(e),t},_getExtentFromLocalMatrix:function(t){var t=t.clone(),e=(t.appendMatrix(this._WtoS_Matrix0),t.invert(),t.transformPoint(0,0)),t=t.transformPoint(this.getWidth(),this.getHeight());return new GCO5.model.maps.GeoExtent({x:e.x,y:e.y,width:t.x-e.x,height:e.y-t.y})},endNewMapext:function(t,e){e=e||{},this.clearSelCanvas();var i=!this._changingViewKeepExtent&&this._transformMt.a<t.a&&.05<Math.abs(this._transformMt.a/t.a-1),t=(this._transformMt=t.clone(),this._animating=!1,this._doubleTapping=!1,this.gcsm.freeze("map",null,!0),this.gcsm.unFreeze("map",15),window.scrollTo(0,1),i?this._testChangeMapOnZoom():null);t&&t.mapName!=this.mapName?this.requestChangeView(t.mapName,t.nivgeo,!0):(e.reset?(this._restoreFromBmp0(),this._rendering=!1,this._lastTransformMt=this._transformMt0.clone(),this.hasSelgeo("stat")&&this.getMainActiveLayer().drawPolySel(this.getSelIds("stat"),this.getSelgeo("stat")),this.drawCopyrights(),$(this).triggerHandler(GCO5.view.component.MapView.END_RENDER,[{reframe:!0},this.getName()])):e.noRender||this.render(),this._setRovCanvasTransform(),$(this.getCanvas("mapsvgetiq")).hide(),$(this).triggerHandler(GCO5.view.component.MapView.END_NEW_EXTENT,[this.getMapExtent()]))},getIdNivgeo:function(){return this.nivgeo},getIdExtent:function(){return GCO5.appModel.getInfo("infoFromMapName",[this.mapName,"id_extent"])},getIdView:function(){return GCO5.appModel.getInfo("infoFromMapName",[this.mapName,"id_view"])},_restoreFromBmp0:function(){},_compareZoomGroup:function(t,e){if(!t||!e)return!1;var i=GCO5.appModel.getConcept("view"),i=GCO5.core.GcArrayUtil.toIndexedObj(i,"pk");return i[t].c_id_extent==i[e].c_id_extent},beforeChangeView:function(t,e){var i={mapName:t};return!this.isFullExtentDisplayed()&&this._compareZoomGroup(this.mapName,t)&&!1!==e&&((t=this.getMapExtent().rect)&&(i.extent=t),this._changingViewKeepExtent=!0),this._lastMapNameBeforeChangeView=this.mapName,this._bmpMap.alpha=1,i},requestChangeView:function(t,e,i){var n={mapName:t};GCO5.core.GcObjectUtil.extend(n,this.beforeChangeView(t,i)),$(this).triggerHandler(GCO5.view.component.MapView.REQUEST_CHANGE_VIEW,[n])},_getSelIdsExtentPx:function(t,e,i){var n,r,a=e[0],s=e.length;if(this.hasSymbSelgeo()){for(var o=t.topoModel,l=o.getPtX(),c=o.getPtY(),h=n=l[a],d=r=c[a],u=1;u<s;u++)a=e[u],h=Math.min(l[a],h),d=Math.min(c[a],d),n=Math.max(l[a],n),r=Math.max(c[a],r);1==s&&(h-=i=void 0===i?10:i,d-=i,n+=i,r+=i)}else{var p=t.topoModel.getBboxes(),g=t.topoModel.getPrecisionFactor();if(h=g*p.fminx_a[a],d=g*p.fminy_a[a],n=g*p.fw_a[a]+h,r=g*p.fh_a[a]+d,1<s)for(u=1;u<s;u++)a=e[u],h=Math.min(g*p.fminx_a[a],h),d=Math.min(g*p.fminy_a[a],d),n=Math.max(g*(p.fminx_a[a]+p.fw_a[a]),n),r=Math.max(g*(p.fminy_a[a]+p.fh_a[a]),r)}return{minxr:h,minyr:d,maxxr:n,maxyr:r}},zoomOnFeatureId:function(t,i,e,n,r,a,s,o){var l,c,h,d,u,p,g,f,m,_,v,y,b,C,x,w,S,M,O;this._animating||(s&&s!=this.getName()&&-1!=i&&(i=null),l=this,c=GCO5.browser.translate3d,y=this.hasSymbSelgeo(),t=t||(y?this.getSymbThemeLayer().getName():this.getMainActiveLayerName()),y=this._ly_o[t],d=this._transformMt.tx,u=this._transformMt.ty,p=this._transformMt.a,g=l.getWidth()/2,f=l.getHeight()/2,m=this.rasterDiscreteZoomsActive(),-1!=i?(C=(new GCO5.model.geom.Matrix).identity(),y=null!=i?(M=Array.isArray(i)?i:[i],M=(y=this._getSelIdsExtentPx(y,M)).minxr,b=y.minyr,v=y.maxxr,y=y.maxyr,_=i[0],w=(M+v)/2,S=(b+y)/2,v=v-M,M=y-b,e||(i==_&&M/this.getStyle("height")<.1&&v/this.getStyle("width")<.1?(v*=GCO5.view.component.MapView.ZOOMBACK2,M*=GCO5.view.component.MapView.ZOOMBACK2):(v*=GCO5.view.component.MapView.ZOOMBACK1,M*=GCO5.view.component.MapView.ZOOMBACK1)),v/M<this.getWidth()/this.getHeight()?this.getHeight()/M:this.getWidth()/v):GCO5.view.component.MapView.ZOOMMAX,e?(y=GCO5.view.component.MapView.ZOOMMAX,b=0<e?100<e?100:e+1:e<-10?.05:(10+e+1)/20,b=Math.sqrt(b),y=0<e?Math.min(y,p*b):m||this.anamorphing?Math.max(this._transformMt0.a/2,p*b):Math.max(this._transformMt0.a,p*b),(y=e<0&&!m&&1<this.getStyle("zoomOut")?Math.max(this._transformMt00.a,p*b):y)==this._transformMt0.a?C=this._transformMt0.clone():C.scale(y,y).translate(n-(n-d)*y/p,r-(r-u)*y/p),w=n,S=r):(C.translate(-w,-S),C.scale(y,y),C.translate(g,f),w=S=null)):(C=this._transformMt0.clone(),w=g,S=f,h="-"),e&&(h=0<e?"+":"-"),-1==i&&!m||(C=this._getLocalMatrixFromExtent(this._validateExtent(this._getExtentFromLocalMatrix(C),h))),this.hasCompatibleLinkedMap()&&!s&&this.getLinkedMap().zoomOnFeatureId(t,i,e,n,r,a,this.getName(),C),o&&(C=o),e&&(l._rovobj_o[t]={fid:_}),x=this._transformMt.clone().invert().appendMatrix(C),!w&&c&&(w=x.tx/(1-x.a),S=x.ty/(1-x.a),M=this._transformMt.transformPoint(w,S),w=M.x,S=M.y),this.startNewMapext(),O=this.getResolutionRatio(),GCO5.core.GcDelayUtil.animate(l._bmpMap,c?{x:function(t){return Math.abs(x.a-1)<1e-4?t*(C.tx-d)/O:(1/((x.a-1)*t+1)-1)*(w-g)},y:function(t){return Math.abs(x.a-1)<1e-4?t*(C.ty-u)/O:(1/((x.a-1)*t+1)-1)*(S-f)},scaleX:function(t){return(x.a-1)*t+1}}:{x:C.tx-x.a*d,y:C.ty-x.a*u,scaleX:x.a,scaleY:x.a},function(){var t;c?(t=l._bmpMap.scaleX,$(l._captureCanvas).css("transform","scale3d("+t+", "+t+", 1) translate3d("+l._bmpMap.x+"px, "+l._bmpMap.y+"px, 0) ")):l._captureStage.update(),0},function(){GCO5.core.GcDelayUtil.callLater(function(){l.endNewMapext(C,{reset:-1==i&&!m}),GCO5.core.GcDelayUtil.callLater(function(){var t,e;-1!=i&&(t=l.getMainActiveLayer(),_==i&&(t._rovFid=i,Array.isArray(i)?(e=t._getRectFid(i),l.affTtp(t.layerName,i,null,null,t._getRectFidScreen(e,C))):l._changingViewKeepExtent||a&&l._isTouchEvent(a)||t.onVMouseMove(null,null,C,!0)))},[],5,l)},[],GCO5.browser.canvasBugged?15:5,l),e&&$(l._captureCanvas).trigger("mousemove")},l.getStyle("noZoomAnim")?0:30,null,GCO5.browser.canvasBugged?30:0,this))},displayTooltipOnFid:function(t,e,i){var n,r,e=e?this.getLayerByName(e):this.getMainActiveLayer();null===t?e.clearRovEfect():(r=(e=e.topoModel).getPrecisionFactor(),n=e.getCtrX(),e=e.getCtrY(),n=r*n[t],r*=e[t],e=this.getMatrix().transformPoint(n,r),this.onVMouseMove({pageX:e.x+this.getMapXPosition(),pageY:e.y+this.getMapYPosition(),refresh:!0,fromMap:i}))},_zoomOnNewTransformMt:function(e,t){var i,n,r,a,s,o=this,l=this._transformMt.tx,c=this._transformMt.ty,h=(this._transformMt.a,GCO5.browser.translate3d),d=this._transformMt.clone().invert().appendMatrix(e);h&&(n=d.tx/(1-d.a),r=d.ty/(1-d.a),i=this._transformMt.transformPoint(n,r),n=i.x,r=i.y),t?GCO5.core.GcDelayUtil.callLater(o.endNewMapext,[e],1,o):(a=this.getWidth()/2,s=this.getHeight()/2,this.startNewMapext(),GCO5.core.GcDelayUtil.animate(o._bmpMap,h?{x:function(t){return Math.abs(d.a-1)<1e-4?t*(e.tx-l):(1/((d.a-1)*t+1)-1)*(n-a)},y:function(t){return Math.abs(d.a-1)<1e-4?t*(e.ty-c):(1/((d.a-1)*t+1)-1)*(r-s)},scaleX:function(t){return(d.a-1)*t+1}}:{x:e.tx-d.a*l,y:e.ty-d.a*c,scaleX:d.a,scaleY:d.a},function(){var t;h?(t=o._bmpMap.scaleX,$(o._captureCanvas).css("transform","scale3d("+t+", "+t+", 1) translate3d("+Math.round(10*o._bmpMap.x)/10+"px, "+Math.round(10*o._bmpMap.y)/10+"px, 0) ")):o._captureStage.update()},function(){o.endNewMapext(e)},(GCO5.browser.canvasBugged,30),null,GCO5.browser.canvasBugged?20:0,this))},onKeyDown:function(t){0<=["select-one","submit","search","checkbox","input","text","number"].indexOf(t.target.type)||(String.fromCharCode(t.keyCode).toLowerCase(),this._ctrlKey=!!t.ctrlKey,this._shiftKey=!!t.shiftKey)},onKeyUp:function(t){var e;0<=["select-one","submit","search","checkbox","input","text","number"].indexOf(t.target.type)||(this._ctrlKey=this._shiftKey=!1,t=String.fromCharCode(t.keyCode).toLowerCase(),e={f:(e=GCO5.view.component.MapView).REFRAME,d:e.DELSEL,z:e.ZOOMONSEL},this.keyActions(e[t]))},keyActions:function(t){var e;GCO5.core.SystemManager.getInstance().focusInText()||(t==(e=GCO5.view.component.MapView).REFRAME&&this.zoomOnFullExtent(),t==e.DELSEL&&this.clearSel("*"),t==e.ZOOMONSEL&&(t=this.getSelIds())&&this.zoomOnFeatureId(null,t))},isFullExtentDisplayed:function(){return this._transformMt.toString()==this._transformMt0.toString()},clearBitmapCache:function(t){t&&t.newIndic?this._clearBmp0AfterNewIndic():this._bmpMap0_o={}},_clearBmp0AfterNewIndic:function(){this._dirty_o.mapstat=!0,this._dirty_o.maptoptheme=!0;var t=this._bmpMap0_o.mapstat,e=this._bmpMap0_o.maptoptheme;t&&(t.width=e.height=1),e&&(e.width=e.height=1)},updateRovInfo:function(t,e,i,n,r,a,s){this._rovobj_o[t]={fid:e,fluxId:i,pageX:n,pageY:r,rect:a,layerName:t},s&&s!=this||$(this).triggerHandler(GCO5.view.component.MapView.MOUSEMOVE,[this._rovobj_o,t]),GCO5.core.GcDelayUtil.callLater(this.mapToolTip.update,[this._rovobj_o,GCO5.core.GcDelayUtil.curFrame()],1,this.mapToolTip)},affTtp:function(t,e,i,n,r,a,s){this.updateRovInfo(t,e,i,n,r,a,s)},clearTooltip:function(){this.mapToolTip.clear()},affCircTtp:function(t,e,i){this.mapToolTip.affCircTtp(t,e,i)},_setRovCanvasTransform:function(t){var e=this.getRovCanvas();t&&!GCO5.browser.canvasBugged?e.getContext("2d").clearRect(t.x-20,t.y-20,t.width+40,t.height+40):GCO5.core.GcBitmapUtil.clearCanvas(e),this._transformMt.applyToCanvasContext(e.getContext("2d"))},_uiEventInMapView:function(t){var e,i,n=this.container.offset();return t.pageY&&(e=t.pageX,i=t.pageY),t&&t.center&&(e=t.center.x,i=t.center.y),!(i<n.top||i>n.top+this.getStyle("height"))&&!(e>n.left+this.getStyle("width"))},onVMouseMove:function(t){if(!(!t.refresh&&t.pageX==this._mx&&t.pageY==this._my||this._animating||this._dragging||this._pinching||this._printMode||this._rendering||this.gcsm.popupClosing||this._containerResizing)){if(this._zoomRectDrawing)return r=this._selCircle.graphics,e=$(this._rovStage.canvas),i=t.pageX-e.offset().left,n=t.pageY-e.offset().top,r.clear(),r.beginStroke("#00f"),r.setStrokeStyle(2),r.beginFill("rgba(150, 150, 150, 0.25)"),r.rect(this._x00,this._y00,i-this._x00,n-this._y00),r.endFill(),r.endStroke(),void this._toolsStage.update();if(this._tapHolding){var e=$(this._toolsStage.canvas),i=t.pageX,n=t.pageY,r=i-e.offset().left-this._x00,i=n-e.offset().top-this._y00;"select"!=t.type&&(this._r00=Math.sqrt(r*r+i*i));try{t.preventDefault()}catch(t){}}else{for(var a=0,s=this._ly_a.length-1;0<=s;s--){var o=this._ly_a[s];o.ly.styles&&o.ly.styles.rovable&&(o.ly.onVMouseMove(t.pageX,t.pageY,this._transformMt,GCO5.browser.isTouch,a,t.fromMap),null!=o.ly._rovFid&&a++)}this._isTouchEvent(t)&&(GCO5.core.GcBitmapUtil.clearCanvas(this._rovStage.canvas),this.mapToolTip.clear()),t.pageX&&(this._mx=t.pageX,this._my=t.pageY)}}},onPanStart:function(t){$(this._captureCanvas).addClass("cursor-move"),this.onDragStart(t)},_initRectZoom:function(t){var e,i,n,r;this._zoomRectDrawing?(i=$(this._rovStage.canvas),n=t.originalEvent.pageX,r=t.originalEvent.pageY,e=n-i.offset().left,i=r-i.offset().top,e=this._getExtentFromLocalRect(this._x00,this._y00,e,i),this.setMapExtent(e),this._clearToolStage(),$(".map-zoom-rect",this.container).click()):((i=$(this._toolsStage.canvas)).css("display","block"),this._selCircle=new GCO5.view.display.Shape,this._selCircle.graphics.beginFill("rgba(150, 150, 150, 0.5)"),this._toolsStage.removeAllChildren(),this._toolsStage.addChild(this._selCircle),i=$(this._rovStage.canvas),n=t.originalEvent.pageX,r=t.originalEvent.pageY,this._x00=n-i.offset().left,this._y00=r-i.offset().top,this.clearLayerRovInfo(this.lyStat.layerName),this._zoomRectDrawing=!0)},onDragStart:function(t,e){if(this._pinching||this._tapHolding||!this._uiEventInMapView(t)&&!e||this._zoomRectActive)return $(this._captureCanvas).removeClass("cursor-move"),!1;if(this._isMultiTouchEvent(t))return!1;this.hasCompatibleLinkedMap()&&!e&&this.getLinkedMap().onDragStart(t,!0);var i,e=t.center.x,n=t.center.y,r=(this.getMainActiveLayer().onVMouseMove(e,n,this._transformMt,!0),this._x00=e-this._map_x,this._y00=n-this._map_y,this.startNewMapext(),this.gcsm.unFreeze("map"),this._dragging=!0,this);GCO5.core.GcDelayUtil.callFunctionWhile(function(){var t;i!=r._bmpMap.x+"|"+r._bmpMap.y&&(GCO5.browser.translate3d?(t="translate3d("+r._bmpMap.x+"px, "+r._bmpMap.y+"px, 0)",$(r._captureCanvas).css({transform:t})):r._captureStage.update()),i=r._bmpMap.x+"|"+r._bmpMap.y},[],0,this,function(){return r._dragging?1:0}),t.preventDefault()},onPan:function(t){this.onDrag(t)},onDrag:function(t,e){if(this._pinching||this._tapHolding||!this._dragging&&!this._zoomRectActive)return!1;t.preventDefault(),this.hasCompatibleLinkedMap()&&!e&&this.getLinkedMap().onDrag(t,!0),this._tapHolding&&GCO5.browser.isIE&&(e=$(this._toolsStage.canvas),i=t.center.x,n=t.center.y,r=i-e.offset().left-this._x00,e=n-e.offset().top-this._y00,this._r00=Math.sqrt(r*r+e*e),t.preventDefault());var i=t.center.x,n=t.center.y,r=i-this._map_x,e=n-this._map_y;this._bmpMap.x=r-this._x00,this._bmpMap.y=e-this._y00,this._drag_a||(this._drag_a=[]),this._drag_a.push({t:(new Date).getTime(),x:this._bmpMap.x,y:this._bmpMap.y})},onPanEnd:function(t){this._tapHolding?this.onRelease(t):this._zoomRectActive?this._onZoomEnd(t):this.onDragEnd(t),t.preventDefault()},_onZoomEnd:function(t){var e=$(this._rovStage.canvas),i=t.center.x,t=t.center.y,i=i-e.offset().left,t=t-e.offset().top,e=this._getExtentFromLocalRect(this._x00,this._y00,i,t);this.setMapExtent(e),this._clearToolStage(),$(".map-zoom-rect",this.container).click()},_getExtentFromLocalRect:function(t,e,i,n){var r=this._transformMt.clone(),a=(r.appendMatrix(this._WtoS_Matrix0),r.invert(),r.transformPoint(Math.min(t,i),Math.min(e,n))),r=r.transformPoint(Math.max(t,i),Math.max(e,n));return new GCO5.model.maps.GeoExtent({x:a.x,y:a.y,width:r.x-a.x,height:a.y-r.y})},_getExtentFromRect0:function(t,e,i,n){var r=this._WtoS_Matrix0.clone(),a=(r.invert(),r.transformPoint(Math.min(t,i),Math.min(e,n))),r=r.transformPoint(Math.max(t,i),Math.max(e,n));return new GCO5.model.maps.GeoExtent({x:a.x,y:a.y,width:r.x-a.x,height:a.y-r.y})},onPanCancel:function(t){if(this._isMultiTouchEvent(t))return!1;this._dragging=!1},onPinchEnd:function(t,e){this._changingViewKeepExtent=!0,this.onRelease(t),this.hasCompatibleLinkedMap()&&!e&&this.getLinkedMap().onPinchEnd(t,!0)},onPinchCancel:function(t,e){if(t.pointers&&2<t.pointers.length)return!1;this.onRelease(t),this.hasCompatibleLinkedMap()&&!e&&this.getLinkedMap().onPinchCancel(t,!0)},onDragEnd:function(t,e){if(this._pinching||this._tapHolding||!this._dragging)return!1;this.hasCompatibleLinkedMap()&&!e&&this.getLinkedMap().onDragEnd(t,!0);var i=this,e=(this._drag_a.reverse(),this._drag_a.length,(new Date).getTime()),n=i._bmpMap.x,r=i._bmpMap.y,a=250<e-this._drag_a[0].t,s=2<this._drag_a.length?Math.abs(this._drag_a[0].x-this._drag_a[2].x)+Math.abs(this._drag_a[0].y-this._drag_a[2].y):0,o=this.getResolutionRatio();250<a||s/GCO5.browser.width<10/768||1!=o?(i._transformMt.translate(o*(i._bmpMap.x=Math.round(i._bmpMap.x)),o*(i._bmpMap.y=Math.round(i._bmpMap.y))),i.endNewMapext(i._transformMt),i._dragging=!1,i._rendering=!0,i._drag_a=null):(this.gcsm.freeze("map",null,!0),a=Math.min(4,this._drag_a.length-1),s=this._drag_a[a].t,o=this._drag_a[a].x,a=this._drag_a[a].y,n=(n-o)*Math.sqrt(1e3/(e-s)),o=(r-a)*Math.sqrt(1e3/(e-s)),i._rendering=!0,$(this._captureCanvas).css("cursor","auto"),GCO5.core.GcDelayUtil.callLater(function(){i._animating=!0},[],2),GCO5.core.GcDelayUtil.animate(i._bmpMap,{x:i._bmpMap.x+n,y:i._bmpMap.y+o},function(){GCO5.browser.translate3d?$(i._captureCanvas).css("transform","translate3d("+i._bmpMap.x+"px, "+i._bmpMap.y+"px, 0)"):i._captureStage.update()},function(){i._transformMt.translate(i._bmpMap.x=Math.round(i._bmpMap.x),i._bmpMap.y=Math.round(i._bmpMap.y)),i.endNewMapext(i._transformMt),i._dragging=i._animating=!1,i._drag_a=null},GCO5.browser.canvasBugged?20:50,null,3,this,GCO5.core.GcDelayUtil.Quad_easeOut,i._breakTranslationAnimation)),t.preventDefault()},_breakTranslationAnimation:function(t){return this._pinching||this._tapHolding||!this._animating},onPinch:function(t,e){this.getResolutionRatio();var i,n,r,a,s=t.center.x,o=t.center.y,l=GCO5.browser.translate3d,c=t.scale,h=this,d=(this.hasCompatibleLinkedMap()&&!e&&this.getLinkedMap().onPinch(t,!0),(e?this.getLinkedMap():this)._map_x),e=(e?this.getLinkedMap():this)._map_y;this._pinching?(this._bmpMap.scaleX=this._bmpMap.scaleY=c,i=s-d-this._x00,n=o-e-this._y00,h._lastBmpx=- --c*this._x00+i,h._lastBmpy=-c*this._y00+n,l?(r=this.getWidth()/2,a=this.getHeight()/2,this._bmpMap.x=-c*(this._x00-r)+i,this._bmpMap.y=-c*(this._y00-a)+n):(this._bmpMap.x=h._lastBmpx,this._bmpMap.y=h._lastBmpy)):(this._tapHolding&&(this._tapHolding=!1,this._clearToolStage()),this.startNewMapext(),this._x00=s-d,this._y00=o-e,this._pinching=!0,GCO5.core.GcDelayUtil.callFunctionWhile(function(){h._lastPos!=h._bmpMap.x+"|"+h._bmpMap.scaleX&&(l?$(h._captureCanvas).css("transform","translate3d("+h._bmpMap.x+"px, "+h._bmpMap.y+"px, 0) scale3d("+h._bmpMap.scaleX+", "+h._bmpMap.scaleY+", 1)"):h._captureStage.update())},[],0,this,function(){return h._pinching?1:0},function(){h._bmpMap.x=h._lastBmpx,h._bmpMap.y=h._lastBmpy})),this._pinching=!0,t.preventDefault()},_clearToolStage:function(){this._selCircle&&(this._toolsStage.removeChild(this._selCircle),this._selCircle.graphics.clear());var t=this._toolsStage.canvas,e=(GCO5.core.GcBitmapUtil.clearCanvas(t),$(t).css("display","none"),this);GCO5.core.GcDelayUtil.callLater(function(){e._r00=null},[],10)},onSingleTap:function(t){1==t.tapCount?this.onRelease(t):this.onDoubleTap(t)},onDoubleTap:function(t){if(this._uiEventInMapView(t)){if(this._isMultiTouchEvent(t))return!1;var e,i=this.lyStat.layerName;this.onRelease(t),this._rovobj_o[i]&&(e=this,GCO5.core.GcDelayUtil.callLater(function(){$(e).triggerHandler(GCO5.view.component.MapViewThematic.DISPLAY_SEL_SETTINGS,[])},[],50))}},onPressUp:function(t){$(t.target).is("button")||this.onRelease(t)},getFirstSelectableLayer:function(){var t=this.getSelectableLayers();if(1==t.length)return t[0];t=t.filter(function(t){return"P"==t.getTopology()});return 1==t.length?t[0]:null},onRelease:function(t){if(this.gcsm.mouseDown=0,!$(t.target).is("canvas")&&(!$(t.target).attr("id")||$(t.target).attr("id").indexOf("_cv")<0)&&!this._tapHolding)return this._tapHolding=!1;var e=this;t.srcEvent;if(t.preventDefault(),!this._uiEventInMapView(t)&&!this._pinching&&!this._tapHolding)return!0;if(this._rendering)GCO5.core.GcDelayUtil.callLater(function(){e._rendering=!1},[],20);else{var i=this.getMainActiveLayer(),n=this.getFirstSelectableLayer();if(this._pinching)GCO5.core.GcDelayUtil.callLater(function(){e._pinching=!1},[],3),this._rendering=!0,GCO5.core.GcDelayUtil.callLater(function(){var t=e._transformMt.clone();t.scale(e._bmpMap.scaleX,e._bmpMap.scaleY).translate(e._bmpMap.x,e._bmpMap.y),t=this._getLocalMatrixFromExtent(this._validateExtent(this._getExtentFromLocalMatrix(t),1<e._bmpMap.scaleX?"+":"-"));try{e.endNewMapext(t)}catch(t){console.log("onRelease",t)}},[],6,this);else if(this._tapHolding){if(GCO5.core.GcDelayUtil.callLater(function(){e._tapHolding=!1}),this._isMultiTouchEvent(t))return this._clearToolStage(),!1;var r,a,s,o,i=n,l=5<this._r00?i.findObjsInCircle({x:this._x00,y:this._y00,radius:this._r00}):[];0<l.length?(c=i.layerName,h=this._rovobj_o[c]?this._rovobj_o[c].fid:this._lastFidPressed,r=this._getLibgeo(h),s=(a=this.getStoWMatrix()).transformPoint(this._x00,this._y00),o="3857"==this._srId?Math.cos(2*(Math.atan(Math.exp(s.y/6378137))-Math.PI/4)):1,GCO5.core.GcDelayUtil.callLater(function(){e._clearToolStage();var t=(t=a.a*e._r00*o/1e3)<2?Math.round(10*t)/10:Math.round(t),t=r?t+" "+e.gclg.getString("KM","units")+" "+e.gclg.getString("AROUND")+" "+r:null;1==l.length&&(t=r),e._shiftKey&&(t=void 0),e.drawSelIds(i.layerName,l,!1,!!e._shiftKey,{libsel:t,centerFid:h})},[],GCO5.browser.isAndroid?20:1)):(this.testCallInfosel(i.layerName),this._clearToolStage()),this.mapToolTip.clear()}else if(!this._dragging&&!this._rendering&&!this._isMultiTouchEvent(t)){var c=(i=n)?i.layerName:null;if(this.onVMouseMove({pageX:t.center.x,pageY:t.center.y}),null==e._rovobj_o[c]||null==e._rovobj_o[c].fid&&null==e._rovobj_o[c].fluxId)return e.mapToolTip.clear(),e.clearSel("*"),void(this._nbTouches=0);var h=this._rovobj_o[c]?this._rovobj_o[c].fid:null;if(this._shiftKey&&null!=h)return t.preventDefault(),void this._onSingleObjPressed(h,c);GCO5.core.GcDelayUtil.callLater(function(){var t;e._doubleTapping||(t=e._getLibgeo(h,c),e.drawSelIds(c,[h],!1,!1,{libsel:t}))},[],GCO5.browser.isAndroid?2:1,this)}this._nbTouches=0}},_onSingleObjPressed:function(t,e,i){this.drawSelIds(e,[t],!1,!0,i)},_isMultiTouchEvent:function(t){return!(!t.pointers||!(1<t.pointers.length||1<this._nbTouches))},_isTouchEvent:function(t){return!!this._isTouchDevice||(t.originalEvent&&0<=t.originalEvent.type.indexOf("touch")&&(this._isTouchDevice=!0),"touch"==t.pointerType&&(this._isTouchDevice=!0),t.srcEvent&&0<=t.srcEvent.type.indexOf("touch")&&(this._isTouchDevice=!0),this._isTouchDevice)},onPress:function(t){var e;this.gcsm.mouseDown=1,$(t.target).is("button")||this._zoomRectActive||(e=(e=this.getFirstSelectableLayer())?e.layerName:null,this._lastFidPressed=this._rovobj_o[e]?this._rovobj_o[e].fid:null,this.onHold(t))},onHold:function(t){if(this._uiEventInMapView(t)){if(this._isMultiTouchEvent(t))return!1;var e,i,n,r,a,s,o,l;this._pinching||((r=this)._tapHolding=!0,o=t.center.x,e=t.center.y,(n=$(this._toolsStage.canvas)).css("display","block"),this._x00=o-n.offset().left,this._y00=e-n.offset().top,i=(n=this.getFirstSelectableLayer()).layerName,this._setRovCanvasTransform(),n.onVMouseMove(o,e,this._transformMt,!0),this.affCircTtp(o,e,null),null!=(n=this._rovobj_o[i]?this._rovobj_o[i].fid:null)&&this._onSingleObjPressed(n,i,{noCallInfosel:!0}),r=this,s=a=0,$(this._captureCanvas).css("cursor","initial"),this._selCircle=new GCO5.view.display.Shape,this._selCircle.graphics.beginFill("rgba(150, 150, 150, 0.5)"),this._toolsStage.removeAllChildren(),this._toolsStage.addChild(this._selCircle),o=this.getStoWMatrix().transformPoint(this._x00,this._y00),l="3857"==this._srId?Math.cos(2*(Math.atan(Math.exp(o.y/6378137))-Math.PI/4)):1,GCO5.core.GcDelayUtil.callFunctionWhile(function(){s!=r._r00&&a%2==0&&($(r._captureCanvas).css("cursor","initial"),r._selCircle.graphics.clear(),r._selCircle.graphics.beginStroke("#f00"),r._selCircle.graphics.setStrokeStyle(2),r._selCircle.graphics.beginFill("rgba(150, 150, 150, 0.25)"),r._selCircle.graphics.drawCircle(r._x00,r._y00,r._r00),r._selCircle.graphics.endFill(),r._selCircle.graphics.endStroke(),r._toolsStage.update(),r.affCircTtp(r._x00,r._y00-r._r00,r._r00*l)),a++,s=r._r00},[],0,this,function(){return r._tapHolding?1:0}),t.preventDefault())}},drawSelCircleAroundFid:function(t,e,i,n){var r=this.getFirstSelectableLayer(),t=("P"==r.getTopology()?n?(s=this.getSelgeoCenterWorld(n),this._x00=s.p0S.x,this._y00=s.p0S.y):(s=this._getSelIdsExtentPx(r,[t],0),a=this._transformMt.transformPoint(s.minxr,s.minyr),this._x00=a.x,this._y00=a.y):n?(s=this.getSelgeoCenterWorld(n,t),this._x00=s.p0S.x,this._y00=s.p0S.y):(n=r._getRectFid(t),s=r._getRectFidScreen(n,this._transformMt),this._x00=s.x+s.w/2,this._y00=s.y+s.h/2),this.getStoWMatrix()),r=1/this.getPxMt(),n=e?e/r:i,a=t.transformPoint(this._x00,this._y00),s="3857"==this._srId?Math.cos(2*(Math.atan(Math.exp(a.y/6378137))-Math.PI/4)):1,e={};i&&(e.noTtp=!0,e.fill="#F00"),this._drawSelCircle(this._x00,this._y00,this._r00=n/s,null,s,e)},selectInCurrentCircle:function(t,e){var i=this.getFirstSelectableLayer(),n=i.findObjsInCircle({x:this._x00,y:this._y00,radius:this._r00}),t={libsel:t};e&&(t.centerFid=e.centerFid),this.drawSelIds(i.layerName,n,!1,!!e,t),this.clearSelCircle()},clearSelCircle:function(){this._clearToolStage(),this.mapToolTip.clear()},_drawSelCircle:function(t,e,i,n,r,a){n||(n=this._selCircle=new GCO5.view.display.Shape,this._toolsStage.removeAllChildren(),this._toolsStage.addChild(n));$(this._toolsStage.canvas).css("display","block");var s,n=n.graphics;n.beginFill("rgba(150, 150, 150, 0.5)"),r||(s=this.getStoWMatrix().transformPoint(t,e),r="3857"==this._srId?Math.cos(2*(Math.atan(Math.exp(s.y/6378137))-Math.PI/4)):1),n.clear(),n.beginStroke("#f00"),n.setStrokeStyle(2),n.beginFill(a&&a.fill?a.fill:"rgba(150, 150, 150, 0.25)"),n.drawCircle(t,e,i),n.endFill(),n.endStroke(),this._toolsStage.update(),a&&a.noTtp||this.affCircTtp(t,e-i,i*r)}}),GCO5.view.component.MapViewThematic=GCO5.view.component.MapView.extend({statics:{NAME:"GCO5.view.component.MapViewThematic",LYSTAT_OPACITY_ADJUSTABLE:"statopadj",MAXNBTHEMES:100,ON_DISABLE_INDIC:"disableInd",ON_ENABLE_INDIC:"enableInd",ON_ADD_INDIC:"addInd",DISPLAY_THM_SETTINGS:"thmsettings",DISPLAY_GEO_SETTINGS:"geosettings",DISPLAY_SEL_SETTINGS:"selsettings",DISPLAY_TABLE_SETTINGS:"tablesettings",DISPLAY_FIC_SETTINGS:"ficsettings",DISPLAY_SEL_METHODS:"selmeth",ANIM_BMP_READY:"animbmpready"},lyStat:null,lyThmPt:null,_legStage:null,$legDivContainerV:null,$legDivContainerH:null,anamorphing:!1,zonSelLayerName:null,zon1LayerName:null,zon2LayerName:null,_thmAnimating:!1,_lastRenderFrame:null,isThematic:!0,setup:function(t){this._super(t),this._lastRenderFrame=0},_createContainerStructure:function(t){function e(t){return o.gclg.getString(t,"map")}var i,n,r,a,s=GCO5.core.ClientInfo.getInstance().isMediumWidthScreen(),o=this;GCO5.appModel.getOption("btMapWMTS")&&(a=GCO5.appModel.getOption("btMapWMTS"),n=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("globe"),{c_id_globe:a}),r=GCO5.appModel.getInfo("viewDef",[this.getName()]),r=GCO5.core.GcArrayUtil.getSubArray(r.tiles,{id_globe:[a]}),a=n[0].c_lib_globe,0<r.length&&(i=0<n.length?n[0].c_icon:null)),this.container.append("<div class='map-background'></div><div id='mapgroup_cv' class='map-display'><canvas id='mapenv_cv'         ></canvas><div    id='mapraster_cv'         class='no-display' style='overflow:hidden'></div><div    id='gmaps_cv'             class='no-display' ></div><canvas id='mapstat_cv'        ></canvas><canvas id='maptransition_cv'  class='no-display' ></canvas><canvas id='maptransition1_cv' class='no-display' ></canvas><canvas id='maprov_cv'         ></canvas><canvas id='maplin_cv'         ></canvas><canvas id='mapsel_cv'         class='no-display'></canvas><canvas id='maptoptheme_cv'    class='no-display'></canvas><canvas id='mapcities_cv'      ></canvas><canvas id='maprovtoptheme_cv' class='noxxx-display'></canvas><canvas id='mapetiq_cv'        class='no-display'></canvas><svg    id='mapsvgetiq_cv'      class='no-display'></svg><canvas id='maptools_cv'       class='no-display' style='z-index:2'></canvas><canvas id='mapcapture_cv'     class='map-capture' style='z-index:2'></canvas><div    id='mapglass_cv'       class='no-display' style='overflow:hidden;z-index:2'><div class='mapHint'></div><div class='copyright-scale' style='z-index:2'><label class='copyright'></label><label class='scale-label'>2km</label><div class='scale-ruler'></div></div></div><div class='map-zoom map-control' style='z-index:3'>"+(GCO5.browser.isTouch,"<button class='map-zoom-in' type='button' title='"+e("ZOOM_PLUS")+"'><span aria-hidden='true' data-gcicon='+'></span></button>")+(GCO5.browser.isTouch,"<button class='map-zoom-out' type='button' title='"+e("ZOOM_MOINS")+"'><span aria-hidden='true' data-gcicon='-'></span></button>")+(GCO5.browser.isTouch&&!s?"":"<button class='map-zoom-rect' type='button' title='"+e("ZOOM_RECTANGLE")+"'><span aria-hidden='true' data-gcicon='s'></span></button>")+"<button class='map-zoom-reframe' type='button' title=\""+e("OVERALL_VIEW")+"\"><span aria-hidden='true' data-gcicon='r'></span></button>"+(i?"<button class='map-wmts' type='button' title=\""+a+"\"><img src='"+i+"'></button>":"")+"</div></div><div id='maptooltip' class='no-display unselectable maptooltip' style='z-index:4'></div><div id='mapwmslegend' class='no-display' style='z-index:5'><img class='mtm'></div>"),this._configContainer(t),this._toolsStage=new GCO5.view.display.Stage(this.getCanvas("maptools")),t.legendContainer?(t.legendContainer.cv?GCO5.core.GcBitmapUtil.isCanvas(t.legendContainer.cv)&&(this._legStage=new GCO5.view.display.Stage(t.legendContainer.cv)):this._legStage=new GCO5.view.display.Stage(document.createElement("canvas")),t.legendContainer.div&&(this.$legDivContainerV=t.legendContainer.div),t.legendContainer.divH&&(this.$legDivContainerH=t.legendContainer.divH)):this._legStage=new GCO5.view.display.Stage(document.createElement("canvas"))},getLegendContainers:function(){return{legH:this.$legDivContainerH,legV:this.$legDivContainerV}},getDisplayGroup:function(){return $(".map-display",this.container)},getLegendCanvas:function(t){this.legendManager._updateLegend({legStage:!0,svgLegendH:!0,imageWidth:t});var e,i,n=this.getEnabledIndicsModelsIndexed(),r=[],a=0;for(i in n){var s=this.getThemeViewByMapIndicModel(n[i]).getLegendCanvas();r.push(s),a+=s.width,e=s.height}if(0==r.length)return null;var o=document.createElement("canvas");return o.width=a,o.height=e,a=0,r.forEach(function(t,e){o.getContext("2d").drawImage(t,a,0),a=t.width}),o},_initCanvasesState:function(){for(var t in this._cvnames_a=["mapenv","mapraster","gmaps","mapstat","maplin","maptoptheme","mapcities","mapsvgetiq","mapetiq","mapsel","mapglass"],this._bmpMap0_o={},this._rovobj_o={},this._hash0_o={},this._dirty_o={},this._cvVisi_o={},this._cvnames_a)this._cvVisi_o[this._cvnames_a[t]]=!0;this._cvVisi_o.mapsel=!1,this._cvVisi_o.mapraster=this.rasterActive()&&!this.gMapsActive(),this._cvVisi_o.gmaps=this.rasterActive()&&this.gMapsActive(),this._cvVisi_o.maptoptheme=null!=this.lyStat.getSymbTheme()||this.lyThmPt&&this.lyThmPt.getSymbTheme()},showEtiqs:function(t,e,i,n,r){(t=t||this.getStatLayer())&&t.showEtiqs(e,i,n,r)},hideEtiqs:function(t){(t=t||this.getStatLayer())&&t.hideEtiqs()},getEtiqTheme:function(t){return(t=t||this.getStatLayer()).getEtiqTheme()},isZonage:function(t){return t==this.zon1LayerName},getCurrentUrl:function(t,e){var i,n,r,a,s=document.URL.split("#").shift(),o=(t=t||GCO5.core.GcObjectUtil.getFirstVal(this.getEnabledIndicsModelsIndexed()),{view:this.getName()});for(a in t&&(i=t.getPk(),n=t.getProp("serie"),GCO5.core.GcStringUtil.isEmpty(n)||(n=n.replace(/\//g,"_slash_")),r=t.getProp("f1Code"),t=t.getProp("f0Code"),o.indics=i,n&&(o.serie=n),r&&(o.f1code=r),t&&(o.f0code=t),this.anamorphing&&(o.cartogram="1")),this.getScaleRatio(),o.lang=this.gclg.getLang(),o)s=GCO5.core.ClientInfo.getInstance().replaceQueryParam(a,o[a],s);return s},_testChangeMapOnZoom:function(){var t=this._super();if(!t)return null;var e,i=this.getEnabledIndicsModelsIndexed();for(e in i)if(i[e].getProp("nivgeos").indexOf(t.nivgeo)<0)return null;return t},_createOrFetchLayerView:function(t,e){var i=this._super(t,e);i.removeAllThemes(),t.stat&&(i.styles.rovable=!0,i.styles.hasOwnProperty("selectable")||(i.styles.selectable=!0),this.lyStat=i);if(t.mapIndicModels)for(var n in t.mapIndicModels){n=t.mapIndicModels[n];i.addTheme(n),(n.applyToPoints()||n.applyToLines())&&((this.lyThmPt=i).styles.rovable=i.styles.selectable=!0)}return i},_displayStageCanvases:function(){var t;this._super(),this.rasterActive()&&(t=this.getStyle("lyStatOpacity"),this.setStyles({lyStatOpacity:t}),$(this.getCanvas("mapstat")).css("opacity",t),$(this).triggerHandler(GCO5.view.component.MapViewThematic.LYSTAT_OPACITY_ADJUSTABLE,[t]))},_resizeMapCanvases:function(){var t=this.getWidth(),e=this.getHeight(),i=(i=[]).concat("lin","raster","cities","sel","env","stat","etiq","svgetiq","tools","glass","rov","env","toptheme","rovtoptheme","transition","transition1"),n=this.getResolutionRatio();for(r in i)(s=this.getCanvas("map"+i[r]))&&(0<=i[r].indexOf("svg")?($(s).attr("width",t),$(s).attr("height",e),$(s).find("text").remove()):(s.width=+t||s.width,e&&(s.height=+e),s.style.width=t/n+"px",s.style.height=e/n+"px"));var r,a=["toptheme","sel","svgetiq","etiq","tools"];for(r in a)$(this.getCanvas("map"+a[r])).css("display","none");for(r in a=["map","mapgroup","mapglass"]){var s=$("#"+a[r]+"_cv",this.container);t&&s.width(t),e&&s.height(e)}for(r in a=["mapraster","gmaps"]){s=$("#"+a[r]+"_cv",this.container);t&&s.width(t/n),e&&s.height(e/n)}$(".map-background",this.container).css("border-width",t/n+"px").height(e/n)},addLayer:function(t,e){if("V"!=t.name)return t.zOrder=this.isZonage(t.name)?this.getNewZonIndex():this.getNewHabillIndex(t.styles.ordre,t.name),this._super(t,e);this._setCityLayersVisible(!0)},removeLayer:function(t,e,i){return"V"==(t=t instanceof GCO5.view.component.LayerView?t.layerName:t)?(this._setCityLayersVisible(!1,!0,e),!0):this._super(t,e,i)},destroy:function(){$(this.getCanvas("maptransition1")).off("webkitTransitionEnd transitionEnd",this.crossFadeTopTheme),this._super()},_addListeners:function(t){this._super(t),$(this.getCanvas("maptransition1")).on("webkitTransitionEnd transitionEnd",{ca:this},this.crossFadeTopTheme)},_captureBmp0:function(t,e){t=this._super(t,e);return this._dirty_o.mapstat=this._dirty_o.maptoptheme=!1,this._hash0_o.linlayers=this._getLinLayersHash(),t},_getLinLayersHash:function(){var t=this._getLinLayers(),t=GCO5.core.GcArrayUtil.getColumnByKey(t,"name");return GCO5.core.GcStringUtil.hashCode(t.join(""))},getTopThemeCanvas:function(){return this.getCanvas("maptoptheme")},getRovTopThemeCanvas:function(){return this.getCanvas("maprovtoptheme")},getStatCanvas:function(){return this.getCanvas("mapstat")},exportImageWithHeaders:function(t,e){e=e||0;var i,n=this.exportImage(),r=this.getEnabledIndicsModelsIndexed(),a=[],s=[],o=n.width<420&&1==GCO5.core.GcObjectUtil.count(r);for(i in r){var l=r[i].getProp("LibIndicWithF1"),c=r[i].getProp("unit"),h=r[i].getProp("serie"),h=(GCO5.core.GcStringUtil.isEmpty(h)||(l+=", "+h),GCO5.core.GcStringUtil.isEmpty(c)||(l+=" ("+c+")"),a.push(l),r[i].getProp("source"));!GCO5.core.GcStringUtil.isEmpty(r[i].getProp("TJSMention"))&&r[i].getProp("TJSServer")&&(h+=" - "+r[i].getProp("TJSMention"),o=!0),s.push((o?"":" - ")+this.gclg.getString("SOURCE","indics")+this.gclg.getString("P2B")+" "+h)}for(var d=r[i],u=this.getLegendCanvas(Math.max(n.width,e)),p=this.getLegendPrecision(),g=document.createElement("canvas"),e=(g.width=Math.max(n.width,e,u.width),20+(o?13:0)),f=u?u.height/p:0,m=10+f+(0==f?10:0),e=20+Math.max(1,a.length)*e-10,_=(g.height=n.height+e+m,g.getContext("2d")),v=(_.fillStyle="#ffffff",_.fillRect(0,0,g.width,g.height),"bold 12px Arial"),y=0;y<a.length;y++){var b=0,C=(_.fillStyle="#000000",_.font=v,2==a.length?y+1+"  ":""),x=2==a.length?2:0,C=(_.fillText(C+a[y],3+x,20+20*y),b+=_.measureText(C+a[y]).width,_.measureText(C+a[y]).width),w=_.measureText(2==a.length?y+1:"").width;if(_.font="10px Arial",o?_.fillText(s[y],3+x,20+20*y+15):(_.fillText(s[y],x+C+5,20+20*y),b+=_.measureText(s[y]).width),b>g.width)return void this.exportImageWithHeaders(t,b+10);2==a.length&&(_.strokeStyle="#333333",_.lineWidth=1,_.strokeRect(2,20+20*y-10-3,w+6,16))}0==a.length&&(_.fillStyle="#000000",_.font=v,_.fillText(this.getLibView(),g.width/2-_.measureText(this.getLibView()).width/2,20)),_.drawImage(n,0,e);e=$("<p>"+this.copyrights+"</p>").text();_.font="italic 10px Arial",d&&_.drawImage(u,0,0,u.width,u.height,-1,g.height-f-3,u.width/p,u.height/p),_.fillText(e,n.width-_.measureText(e).width-2,g.height-m+10-1+(0==a.length?2:0)),GCO5.core.GcBitmapUtil.exportCanvas(g,"map.png",t)},updateGlobe:function(t,e,i,n){this._super(t,e,i,n);e=!t||"IGN3"==t,i=this.getStyle("lyStatOpacity"),n=t&&this.lyStat&&null!==this.lyStat.getChoroTheme(),n=t?t&&!n&&1==i?.3:n&&1==i?.75:i:1;$(this.getStatCanvas()).css("opacity",n),this.setStyles({lyStatOpacity:n,citiesVisible:e}),$(this).triggerHandler(GCO5.view.component.MapViewThematic.LYSTAT_OPACITY_ADJUSTABLE,[n,t])},clearLayerRovInfo:function(t,e,i){this._super(t,e,i),this.getLyStatName()==t&&!e||(i=this.getRovTopThemeCanvas(),GCO5.core.GcBitmapUtil.clearCanvas(i))},getStatLayer:function(){return this.lyStat},getStatLayerNbObjs:function(){return this.lyStat.getNbObjs()},getStatLayerNbObjsFormatted:function(){var t=this.getStatLayerNbObjs(),e=GCO5.appModel.getInfo("libNivgeo",[this.nivgeo,["de","en"].indexOf(this.gclg.getLang())<0,!0]);return this.gclg.formatNumber(t)+" <b>"+e+"</b>"},isAnamorphOk:function(){return this.lyStat.getMeanPointsByObj()<500&&this.lyStat.getNbObjs()<5e3},_restoreFromBmp0:function(){var t,e,i=this;if(0==(h=GCO5.core.GcObjectUtil.count(this._bmpMap0_o))||this._dirty_o.mapstat||this._dirty_o.maptoptheme||this._bmpMap0_o&&this._bmpMap0_o.mapstat&&1==this._bmpMap0_o.mapstat.width)return this.render(),this._dirty_o.mapstat=!1,this._dirty_o.maptoptheme=!1,n=[],0<h&&(t=["mapstat"],(e=this._getIndicInfo())&&!e.isChoro()&&t.push("maptoptheme"),n=[null,t]),void GCO5.core.GcDelayUtil.callLater(this._captureBmp0,n,12,this);for(var n=this._cvnames_a,r=0==this._getCityLayers().length,a=0,s=0;s<n.length-1;s++){var o=this._bmpMap0_o[n[s]];if(o){var l=this.getCanvas(n[s]);if(l)if(l.width=this.getWidth(),l.height=this.getHeight(),"maplin"==n[s]&&this._hash0_o.linlayers!=this._getLinLayersHash()){for(var c=this._getLinLayers(),h=c.length,d=0;d<h;d++){var u=c[d];u.ly.isVisible()&&(this._clearAndResizeCanvases(u.ly.layerName),u.ly.draw())}a=1,GCO5.core.GcDelayUtil.callLater(function(){i._drawLinLayers();var t=i.getCanvas("maplin");i._bmpMap0_o.maplin.getContext("2d").drawImage(t,0,0),i._hash0_o.linlayers=i._getLinLayersHash()},[],1)}else"mapraster"==n[s]||"gmaps"==n[s]||"mapsvgetiq"==n[s]||r&&("mapcities"==n[s]||"mapetiq"==n[s])||(l.getContext("2d").drawImage(o,0,0),"mapstat"==n[s]&&this.lyStat.restoreFromBmp0())}}this.lyRaster&&this.lyRaster.draw(),this.getEtiqTheme()&&this.getEtiqTheme().draw(),GCO5.core.GcDelayUtil.callLater(this._displayStageCanvases,[],GCO5.testMode?0:a,this),GCO5.core.GcDelayUtil.callLater(this._buildCapture,[!0],GCO5.testMode?0:a+5,this)},updateRovInfo:function(t,e,i,n,r,a,s){var o;GCO5.browser.isTouch&&!a&&null===e&&(t=(o=this.lyStat).layerName,0<=(e=this._rovobj_o[t]?this._rovobj_o[t].fid:null)&&(a=o._getRectFid(e),a=o._getRectFidScreen(a,this.getMatrix()))),t&&this._super(t,e,i,n,r,a,s)},render:function(t,i,e,n){if(this.getHeight()){var r=this,a=this.getCanvas("maptransition"),s=(this._rendering=!0,GCO5.core.GcDelayUtil.curFrame()),o=s-this._lastRenderFrame;if(o<20&&(!this.getStyle("extent0")||!this._changingViewKeepExtent)&&"1"==GCO5.initInfo.ip_emc3&&(console.warn("render rapprochés",o),o<5))r.gcsm.unFreeze("render");else{this._lastRenderFrame=s,this.drawCopyrights(),this._hasNewSize&&($(this._captureCanvas).css("opacity",1),o=this.getWidth()-this._captureCanvas.width,$(this._captureCanvas).css("transform","translate3d("+o/2+"px, 0, 0)")),!this.hasTranslated()||i||t||this.lyStat.captureBitmap(),this._clearAndResizeCanvases(t,e),t&&"*"!=t&&(e=this._getLayerCat(t));var l,c,s=this.getTopThemeCanvas(),h=($(a).removeClass("cfade"),GCO5.core.GcBitmapUtil.clearCanvas(a),$(a).css("display","none"),$(s).removeClass("cfade"),$(s).css("display","none"),$(s).css("opacity",0),t==this.getLyStatName()||"*"==t||this.lyThmPt&&t==this.lyThmPt.getName()?(i=i||{},this._cvVisi_o.maptoptheme=null!=this.lyStat.getSymbTheme()||this.lyThmPt&&this.lyThmPt.getSymbTheme(),o=(o=(o=i.themeSuperCat)||(this.lyStat.getSymbTheme()||this._cvVisi_o.maptoptheme?"Symb":null))||(this.lyStat.getChoroTheme()?"Choro":null),(l=i.themeUpdateMode)||("Symb"==o&&(l=i.themeUpdateMode=this._cvVisi_o.maptoptheme?"replace":"add"),"Choro"==o&&(l=i.themeUpdateMode="replace")),"Symb"==o?($(s).css("display","block"),"replace"==l?(i&&i.anim||$(a).insertAfter($(s)),$(a).css("display","block"),$(a).css("opacity",1),a.getContext("2d").drawImage(s,0,0)):"remove"==l&&$(s).css("opacity",1),this._dirty_o.maptoptheme=!0):"Choro"==o&&($(a).insertAfter($(this.getStatCanvas())),$(a).css("opacity",1),$(a).css("display","block"),a.getContext("2d").drawImage(this.getCanvas("mapstat"),0,0),$(this.getCanvas("mapstat")).removeClass("cfade"),this._cvVisi_o.maptoptheme?($(s).css("display","block"),$(s).css("opacity",1)):GCO5.core.GcBitmapUtil.clearCanvas(s),this._dirty_o.mapstat=!0)):(this._cvVisi_o.maptoptheme=null!=this.lyStat.getSymbTheme()||this.lyThmPt&&null!=this.lyThmPt.getSymbTheme(),this._cvVisi_o.maptoptheme?this._dirty_o.maptoptheme=!0:GCO5.core.GcBitmapUtil.clearCanvas(s)),t&&"*"!=t||this._etiqStage.removeAllChildren(),0),d=[[],[],[]],u={env:0,stat:1,lin:2,city:2};for(c in this._ly_a){var p=this._ly_a[c];t&&p.name!=t&&"*"!=t&&"cities"!=e||!p.ly.isDisplayable()||e&&this._getLayerCat(p.name)!=e||(h=u[this.getLayerGroup(p.name)],d[h].push(p.ly))}for(var g=this.getStyle("extent0")&&this._changingViewKeepExtent,h=0;h<=2;h++)GCO5.core.GcDelayUtil.callLater(function(){var t,e=d.shift();for(t in e)e[t]&&e[t].draw(i,g)},[],GCO5.testMode?0:2*h,this);this.gcsm.freeze("render"),GCO5.core.GcDelayUtil.callLater(function(){r._draw2(t,i,e)},[],GCO5.testMode?0:2*h,this),this.lyRaster&&this.lyRaster.draw(n)}}else console.warn("render carte de hauteur nulle",this.getWidth(),this.getHeight())},_draw2:function(t,e,i){var n=this,r=this.getCanvas("maptransition"),a=this.getCanvas("mapstat"),s=this.getTopThemeCanvas();if("lin"==i){var o=this.getLayerByName(t),o=o?o.getTopoModel():null;if(o&&this.isReprojected()&&!o.isReprojected())return l=GCO5.model.maps.AProj4.PROJ_FAM["e"+this._srId0],new GCO5.model.maps["Proj4"+l](this._srId0).reprojTo3857(o),void this.render(t,e,i)}if(this.getStyle("extent0")&&this._changingViewKeepExtent||(!(l=!t&&!i)&&"env"!=i||this._drawEnvLayers(),!l&&"stat"!=i||this._drawStatLayer(),!l&&"lin"!=i||this._drawLinLayers(),!l&&"cities"!=i||this._drawCityLayers(),o=0,(t==this.getLyStatName()||this.lyThmPt&&t==this.lyThmPt.getName())&&($(s).addClass("cfade"),"Symb"==e.themeSuperCat?("replace"==e.themeUpdateMode?($(r).addClass("cfade"),GCO5.core.GcDelayUtil.callLater(function(){$(r).css("opacity",0),$(s).css("opacity",1)},[],3),o=1):"add"==e.themeUpdateMode?GCO5.core.GcDelayUtil.callLater(function(){$(s).css("opacity",1)},[],3):"remove"==e.themeUpdateMode&&GCO5.core.GcDelayUtil.callLater(function(){$(s).css("opacity",0)},[],2),this._cvVisi_o.maptoptheme="remove"!=e.themeUpdateMode):"Choro"!=e.themeSuperCat||e.anim||($(r).addClass("cfade"),$(a).css("opacity",.6),$(a).addClass("cfade"),GCO5.core.GcDelayUtil.callLater(function(){$(r).css("opacity",0),$(a).css("opacity",1)},[],2),o=1),o?GCO5.core.GcDelayUtil.callLater(function(){n._rendering||(GCO5.core.GcBitmapUtil.clearCanvas(r),$(r).css("display","none"),$(s).removeClass("cfade"),$(a).removeClass("cfade"))},[],50):($(s).hasClass("cfade")||$(this.getCanvas("mapstat")).hasClass("cfade"))&&GCO5.core.GcDelayUtil.callLater(function(){n._rendering||($(s).removeClass("cfade"),$(a).removeClass("cfade"))},[],50))),GCO5.core.GcDelayUtil.callLater(this.legendManager._updateLegend,[e],3,this.legendManager),this._lastTransformMt=this._transformMt.clone(),this.getStyle("extent0")&&this.getStyle("extent0").contains(this._getMapExtentA5(),!0)&&!this._changingViewKeepExtent&&(this.styles.extent0=null),this.getStyle("extent0")){if(this._changingViewKeepExtent)return void GCO5.core.GcDelayUtil.callLater(function(){n.setMapExtent(n.getStyle("extent0"),!0),n.styles.extent0=null},[],2,this);GCO5.core.GcDelayUtil.callLater(function(){n.setMapExtent(n.getStyle("extent0")),n.styles.extent0=null},[],20,this)}else!this.hasSelgeo("stat")||e&&(e.anim||e.updStyles)?this.lyThmPt&&this._zoomingOnSelection&&this.styles.inReport&&(t=this.lyThmPt.getName(),this.selectionManager.drawSelgeo(t,!0,25),this._zoomingOnSelection=!1):this.selectionManager.drawSelgeo(null,this._zoomingOnSelection,this.getStyle("noZoomAnim")?25:10);this._changingViewKeepExtent=!1,this._rendering=!1,this._hasNewSize&&$(this._captureCanvas).css("opacity",0),this._hasNewSize=!1,GCO5.core.GcDelayUtil.callLater(this._displayStageCanvases,[],GCO5.testMode?0:5,this),GCO5.core.GcDelayUtil.callLater(this._buildCapture,[],GCO5.testMode?0:GCO5.browser.isAndroid?20:10,this);var l=n._updateThemesAfterBackgroundChanged(e,!0)?40:21;GCO5.core.GcDelayUtil.callLater(function(){n._updateThemesAfterBackgroundChanged(e),$(n).triggerHandler(GCO5.view.component.MapView.END_RENDER,[e,this.getName()]),n.gcsm.unFreeze("render")},[],GCO5.testMode?0:l,this)},_updateThemesAfterBackgroundChanged:function(t,e){var i=this.getCurSymbTheme();if(!(i&&i instanceof GCO5.view.component.SymbGradThemeView&&!i.hasIndicAssoc()))return!1;if(!t&&this.lyStat.getChoroTheme()||t&&"Choro"==t.themeSuperCat||t&&"Symb"==t.themeSuperCat){if(e)return!0;i.updateAfterBackgroundChanged()}},startNewMapext:function(){this._super()},getLyStatName:function(){return this.lyStat.layerName},getRovData:function(t){var e,i=[],n=this.getStatLayerName(),r=this.getNbActiveThemes(),a=0<=["de","en"].indexOf(this.gclg.getLang());for(e in t){var s,o,l=t[e];!l||null==l.fid&&null==l.fluxId||(s=l.fid,(o=this.getLayerByName(e))&&(l.codgeo=o.getCodgeoById(s),l.libgeo=o.getLibgeoById(s),l.thmData=o.getAllThemesDataById(s,l.fluxId),l.typeLy="stat",e==this.zon1LayerName?l.typeLy="zon":n!=e&&(l.typeLy="symb",l.lyLib=GCO5.appModel.getInfo("libNivgeo",[e.substr(0,e.length-2)])),l.lyLib||(l.lyLib=GCO5.appModel.getInfo("layerFullName",[e,this.mapName],!a)),l.nbActiveThemes=r,i.push(l)))}return i},getCurrentMapIndicModel:function(){var t=GCO5.core.GcArrayUtil.indexOfByKey(this._ly_a,"ly",this.lyStat);return 0<=t?this._ly_a[t].mapIndicModel:null},getMapIndicModelByPk:function(t){var e,i=this.getIndicsModelsIndexed(),n=t;for(e in t&&t.id_indicateur&&(n=t.id_datasets+"."+t.id_indicateur),i)if(e==n)return i[e];return null},getLayerFromTheme:function(t){return this.getLayerByName(t.getLayerName()||this.lyStat.getName())},addTheme:function(t,e){var i,n;this.getIndicsModelsIndexed()[t.getPkF1()]?this.updTheme(t,e):((i=this.getLayerFromTheme(t))||(n=t.getLayerName(),this.hasLayer(n)?i=this.addLayer({name:n},!0):t.getLayerDef()&&(i=this.addLayer(t.getLayerDef(),!0)),(t.applyToPoints()||t.applyToLines())&&(this.lyThmPt=i),i||console.error("addTheme ly missing")),(e=e||{}).replace&&(i.removeAllThemes(),i!==this.getStatLayer()&&this.getStatLayer().removeAllThemes(),i!=this.lyThmPt&&(this.lyThmPt=null)),i.addTheme(t),this.gcsm.statTrack("mapindics",this.mapName,t.getProp("idDataset"),t.getProp("idIndicateur")),$(this).triggerHandler(GCO5.view.component.MapViewThematic.ON_ADD_INDIC,[t]),e.render?this.enableTheme(t,e):!1===e.enabled&&t.disable())},setThemeVisibility:function(t,e,i){e?this.enableTheme(t,i):this.disableTheme(t,i)},addThemes:function(t){var e,i=0,n=GCO5.core.GcObjectUtil.count(t);for(e in t){var r=t[e];this.addTheme(r,{render:++i==n}),i<n&&this.reorganizeMapIndicsAfter(r,"add")}},enableTheme:function(t,e){var i,n,r,a;e=e||{render:!0},t&&(this.onNewIndicData(e.resizeNeeded),n=this.reorganizeMapIndicsAfter(t,"add"),r=this.getLayerFromTheme(t),(t.applyToPoints()||t.applyToLines())&&(this.lyThmPt=r),(i=e.renderDefs||{}).themeSuperCat=t.getSuperCategory(),i.themeUpdateMode=e.replace?"replace":n.result||"add",n=r.getName(),e.resizeNeeded&&(n=null),r=t.getProp("idIndicAssoc"),t.getAssocModel()||GCO5.core.GcStringUtil.isEmpty(r)||(r=t.getProp("idDataset")+"."+r,(a=this.getIndicsModelsIndexed())[r]&&(a[r].isEnabled()||(a[r].enable(),this.reorganizeMapIndicsAfter(a[r],"add"),$(this).triggerHandler(GCO5.view.component.MapViewThematic.ON_ENABLE_INDIC,[r])),t.getIndicModel().linkAssocModel(a[r].getIndicModel()))),a=2,this.anamorphing&&!e.noRender&&(a+=100,GCO5.core.GcDelayUtil.callLater(this.anamorph,[!1],10,this)),t.enable(),e.noRender||GCO5.core.GcDelayUtil.callLater(this.render,[n,i],a,this))},disableSymbMapindicModel:function(t,e){var i;if(t.applyToPoints()||t.applyToLines()){var n=this.getLayerFromTheme(t);if(!n)return;var r=n.layerName,e=(this.clearSel(r),e?this.getLayerFromTheme(e):null);e&&r==e.layerName||(this.removeLayer(n,!0),i=!(this.lyThmPt=null),t.applyToPoints()&&GCO5.core.GcBitmapUtil.clearCanvas(this.getTopThemeCanvas()))}return i},disableTheme:function(t,e){var i,n,r,a=this.getLayerFromTheme(t);a&&(a=a.layerName,i=t.getSuperCategory(),e||t.disable(),n=this.reorganizeMapIndicsAfter(t,e?"remove":"disable"),r=this.disableSymbMapindicModel(t),this.unlinkAssocModel(t),(t={themeSuperCat:i,render:!0}).themeUpdateMode=e&&n.result||"remove",GCO5.core.GcDelayUtil.callLater(this.render,[r?null:a,t],10,this),this.anamorphing&&GCO5.core.GcDelayUtil.callLater(this.anamorph,[!1],20,this))},unlinkAssocModel:function(t){var e=t.getAssocModel();e&&(t.linkAssocModel(),e=this.getIndicsModelsIndexed()[e.getPkF1()],(e=this.getThemeViewByMapIndicModel(e)).linkAssocModel(),(e=this.getThemeViewByMapIndicModel(t))&&e.linkAssocModel())},updTheme:function(t,e){var i,n,r,a,s=this;!1!==(e=e||{}).render&&(i=this.getLayerFromTheme(t),(n=this.getMapIndicModelByPk(t.getPkF1()))&&n!==t&&(i.removeThemeByModel(n),i.addTheme(t)),(r=e.renderDefs||{}).updStyles=!0,r.themeSuperCat=t.getSuperCategory(),r.themeUpdateMode="replace",a=i.getName(),e.resizeNeeded&&(a=null),GCO5.core.GcDelayUtil.callLater(function(){s.render(a,r)},[],5))},removeTheme:function(t,e){var i,n;t&&(this.getLayerFromTheme(t).removeThemeByModel(t),i=0,(n=this).anamorphing&&(i+=80,GCO5.core.GcDelayUtil.callLater(this.anamorph,[!1],10,this)),t.isEnabled()&&GCO5.core.GcDelayUtil.callLater(function(){n.disableTheme(t,!e||!e.noEnablingOthers)},[],i))},removeDisabledThemes:function(){var t,e=this.getIndicsModelsIndexed();for(t in e){var i=e[t];i.isEnabled()||this.getLayerFromTheme(i).removeThemeByModel(i)}},removeAllThemes:function(t){var e,i,n=this.getIndicsModelsIndexed();for(i in n){var r=n[i],a=this.getLayerFromTheme(r);a&&(a.removeThemeByModel(r),(r.applyToPoints()||r.applyToLines())&&(this.removeLayer(a,!0),e=!(this.lyThmPt=null)))}t&&t.noRender||(t=t&&t.immediate?0:10,this.anamorphing&&(t+=50,GCO5.core.GcDelayUtil.callLater(this.anamorph,[!1],2,this)),GCO5.core.GcDelayUtil.callLater(this.render,[e?null:this.getLyStatName(),{render:!0,themeUpdateMode:"remove"}],t,this))},pauseAnim:function(t){this._thmAnimating=!1},closeAnim:function(t){this.getThemeViewByMapIndicModel(t).onCloseTimeAnim(),t.getIndicModel().clearAnimData()},isAnimating:function(){return this._thmAnimating},getIndicsModelsIndexed:function(t){var e,i={};for(e in t&&(i=this.getEnabledIndicsModelsIndexed()),this._ly_a){var n=this._ly_a[e].ly;n&&(n=n.getMapIndicModelsIndexed(),GCO5.core.GcObjectUtil.extend(i,n))}return i},getNbActiveThemes:function(){var t,e=0;for(t in this._ly_a){var i=this._ly_a[t].ly;i&&(e+=i.getNbActiveThemes())}return e},getEnabledIndicsModelsIndexed:function(t){var e,i,n,r,a=this.getIndicsModelsIndexed(),s={};for(r in a)t&&t.onlyDisplayable&&!a[r].valuesDisplayable()||a[r].isEnabled()&&("Choro"==(e=a[r].getSuperCategory())&&(i=a[r]),"Symb"==e&&(n=a[r]));return n&&(s[n.getPkF1()]=n),i&&(s[i.getPkF1()]=i),s},reorganizeMapIndicsAfter:function(t,e){var i=this.getIndicsModelsIndexed(),n={};if(i){GCO5.core.GcObjectUtil.count(i)>GCO5.view.component.MapViewThematic.MAXNBTHEMES&&this.removeDisabledThemes();var r=this.getNewMapIndicsInfoAfter(t,e);if("add"==e){if(n={action:"add",result:"add"},0<GCO5.core.GcObjectUtil.count(r.indicsToDisable))for(var a in n.result="replace",r.indicsToDisable)r.indicsToDisable[a].disable(),this.unlinkAssocModel(r.indicsToDisable[a]),this.disableSymbMapindicModel(r.indicsToDisable[a],t),$(this).triggerHandler(GCO5.view.component.MapViewThematic.ON_DISABLE_INDIC,[a])}else if("remove"==e&&(n={action:"remove"},0<GCO5.core.GcObjectUtil.count(r.indicsToEnable)))for(var a in n.result="replace",r.indicsToEnable)r.indicsToEnable[a].enable(),$(this).triggerHandler(GCO5.view.component.MapViewThematic.ON_ENABLE_INDIC,[a]);return n}},getNewMapIndicsInfoAfter:function(t,e){var i,n=this.getIndicsModelsIndexed(),r=t.isMapIndicModel?t.getSuperCategory():GCO5.model.indics.MapIndicModel.getScatFromCat(t.getMappingCategory()),a=(!r&&t&&(r=t.isMapIndicModel?t.getSuperCategory():GCO5.model.indics.MapIndicModel.getScatFromCat(t.getMappingCategory())),{}),s={},o={},l=[];if("add"==e)for(var c in l.push(t),o[t.getPkF1()]=t,n)(u=(d=n[c]).getPkF1())!=t.getPkF1()&&r==GCO5.model.indics.MapIndicModel.getScatFromCat(d.getCategory())?d.isEnabled()&&(s[u]=d).getAssocModel()&&t.getAssocModel()&&(n[i=d.getAssocModel().getPkF1()],n[i].isEnabled()&&i!=t.getAssocModel().getPkF1()&&(s[i]=n[i])):d.isEnabled()&&(o[u]=d);else if("remove"==e&&t.isEnabled()){var h=0;for(c in n){var d,u=(d=n[c]).getPkF1();0!=h||d==t||d.isEnabled()||r!=GCO5.model.indics.MapIndicModel.getScatFromCat(d.getCategory())?d.isEnabled()&&(o[u]=d):(a[u]=d,o[u]=d,h++)}}return{indicsToEnable:a,indicsToDisable:s,indicsModelRetained:o,indicsAdded:l}},_getIndicInfo:function(t){var e=this.getEnabledIndicsModelsIndexed();return(t=t||GCO5.core.GcObjectUtil.getFirstKey(e))?e[t]:null},_getLayerCat:function(t){if(t==this.getLyStatName())return"stat";this._ly_a.length;var e=this._getStatLayerIndex(),i=this._getFirstCityLayerIndex(),n=GCO5.core.GcArrayUtil.indexOfByKey(this._ly_a,"name",t),n=this._ly_a[n].zOrder;return n<e?"env":!(n<i)||"_P"==t.substr(-2,2)?"cities":"lin"},onCloseTimeAnim:function(){this.gcsm.freezeAfterPopup(),this.lyStat.getCurTheme().onCloseTimeAnim()},_setCityLayersVisible:function(t,e,i){for(var n in this._ly_o){n=this._ly_o[n];(e&&n.styles.cityGroup||!e&&this._isCityLayer(n))&&n.setVisible(t)}i||this.render(null,null,"cities")},_getFirstCityLayerIndex:function(){for(var t=this._ly_a.length,e=0;e<t;e++){var i=this._ly_a[e];if(this._isCityLayer(i.ly))return e}return-1},_isCityLayer:function(t){return"P"==t.getTopology()&&t!==this.lyThmPt},_getStatLayerIndex:function(){for(var t=this._ly_a.length,e=0;e<t;e++)if(this._ly_a[e].ly.isStat)return e;return-1},getNewZonIndex:function(){var t=+this._getFirstCityLayerIndex();return this.zonSelLayerName&&t--,Math.max(t,this._getStatLayerIndex()+1)},getNewHabillIndex:function(t,e){for(var i=this._getStatLayerIndex(),n=this._getFirstCityLayerIndex(),r=n-1;i<r;r--)if(this._ly_a[r].styles.hasOwnProperty("ordre"))return t>this._ly_a[r].styles.ordre?r+1:r;return n},onSerieAnimChange:function(t,e,i){var n=this.lyStat.getChoroTheme(),r=this.lyStat._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_GRAD);n&&(!e||0<=e.indexOf(n.getModel()))&&n.onSerieAnimChange(t,i),r&&(!e||0<=e.indexOf(r.getModel()))&&r.onSerieAnimChange(t,null!=n&&n.getModel().getProp("idDataset")==r.getModel().getProp("idDataset"),i)},_getEnvLayers:function(){this._ly_a.length;for(var t=this._getStatLayerIndex(),e=[],i=0;i<t;i++){var n=this._ly_a[i];e.push(n)}return e},getLayerGroup:function(t){this._ly_a.length;if(t==this.getLyStatName())return"stat";for(var e=this._getStatLayerIndex(),i=0;i<e;i++)if(this._ly_a[i].name==t)return"env";for(var n=this._getFirstCityLayerIndex(),i=e+1;i<n;i++)if(this._ly_a[i].name==t)return"lin";return"city"},_drawEnvLayers:function(){for(var t=this._getEnvLayers(),e=t.length,i=!1,n=0;n<e;n++)(s=t[n]).ly.isVisible()&&(i=!0);var r=this.getCanvas("mapenv"),a=(GCO5.core.GcBitmapUtil.clearCanvas(r),r.getContext("2d"));if(i)for(var s,n=0;n<e;n++)(s=t[n]).ly.isVisible()&&(a.drawImage(s.cv,0,0),s.cv.width=s.cv.height=1)},_getLinLayers:function(){for(var t,e=this._ly_a.length,i=[],n=this._getStatLayerIndex()+1;n<e;n++){var r=this._ly_a[n];r.ly.isDisplayable()&&"P"!=r.ly.getTopology()&&("C"==r.purpose?t=r:i.push(r))}return t&&i.push(t),i},_drawLinLayers:function(){for(var t=this._getLinLayers(),e=t.length,i=!1,n=0;n<e;n++)(s=t[n]).ly.isVisible()&&(i=!0);if(i=0==e?!0:i)for(var r=this.getCanvas("maplin"),a=(GCO5.core.GcBitmapUtil.clearCanvas(r),r.getContext("2d")),n=0;n<e;n++){var s=t[n];a.drawImage(s.cv,0,0)}},_getCityLayers:function(){for(var t=this._ly_a.length,e=[],i=this._getFirstCityLayerIndex();i<t;i++){var n=this._ly_a[i];!n||!n.ly.isDisplayable()||n.ly._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_PTVI)||n.ly._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_OURSINS)||n.ly._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_PTCHORO)||e.push(n)}return e},_drawCityLayers:function(){for(var t=this._getCityLayers(),e=t.length,i=0;i<e;i++)(a=t[i]).ly.isDisplayable();for(var n=this.getCanvas("mapcities"),r=(GCO5.core.GcBitmapUtil.clearCanvas(n),this.getCanvas("mapcities").getContext("2d")),i=0;i<e;i++){var a=t[i];r.drawImage(a.cv,0,0),a.cv.width=a.cv.height=1}0==t.length&&this._etiqStage.update()},_drawStatLayer:function(){var t,e=this.getCanvas("mapstat"),i=e.getContext("2d");for(t in GCO5.core.GcBitmapUtil.clearCanvas(e),this._ly_a){var n=this._ly_a[t];n.stat&&1<n.cv.width&&(i.drawImage(n.cv,0,0),n.cv.width=n.cv.height=1)}},crossFadeTopTheme:function(t){var t=t.data.ca,e=t.getCanvas("maptransition"),t=t.getCanvas("maptransition1");GCO5.core.GcBitmapUtil.clearCanvas(e),GCO5.core.GcBitmapUtil.clearCanvas(t),$(e).removeClass("cfade"),$(e).css("opacity",1),$(t).removeClass("cfade"),$(t).css("opacity",0)},getCurTheme:function(){var t=this.lyStat.getChoroTheme()||this.lyStat.getSymbTheme();return t=!t&&this.lyThmPt?this.lyThmPt.getSymbTheme():t},getThemeViewByMapIndicModel:function(t){for(var e in this._ly_a){var i,n=this._ly_a[e].ly,r=n.getMapIndicModelsIndexed();for(i in r)if(t===r[i])return n.getThemeByModel(t)}return null},getCurThemeLayerName:function(){var t=this.getCurTheme();return t?t.getLayerName():null},getSymbThemeLayer:function(){return this.lyThmPt&&this.lyThmPt.getSymbTheme()?this.lyThmPt:this.lyStat.getSymbTheme()?this.lyStat:null},getCurSymbTheme:function(){var t=this.getSymbThemeLayer();return t?t.getSymbTheme():null},hasSymbSelgeo:function(){var t=this.lyThmPt;return!!(t&&t.getSymbTheme()&&t.getSymbTheme().isEnabled())&&this.hasSelgeo(t.getName())},onBuildInfosel:function(t){this.lyStat.onChangeSelection(t),this._super(t)},anamorph:function(e,t,i){var n=this.lyStat,r=(new Date).getTime(),a=this,s=this.anamorphing;if(this.anamorphing=e,this.clearBitmapCache({newIndic:!0}),e){if(0<=["#CCCCCC","#888888"].indexOf(n.styles.strokeStyle)&&(n.styles.strokeStyle="#f00"),n.topoModel.anamorphComputed()){for(var o in n.topoModel.loadAnamorphModel(),this._ly_a)(c=this._ly_a[o]).ly.topoModel.loadAnamorphModel();var l=(new Date).getTime()-r}else{n.topoModel.saveTopoModelOrig();var c,h=n.topoModel.getNbObjs(),d=h<500?16:h<1500?10:6,u=(GCO5.browser.isIE&&(d=h<500?10:h<1500?8:6),new GCO5.model.maps.GcCartogram(n.topoModel,d,t||n.getCurTheme().getStatData())),l=(u.distortArcs(n.topoModel),(new Date).getTime()-r);for(o in this._ly_a)(c=this._ly_a[o]).ly!==n&&"E"!=c.styles.topo&&(c.ly.topoModel.saveTopoModelOrig(),u.distortArcs(c.ly.topoModel))}if(a.gcsm.freeze("anamorph"),GCO5.core.GcDelayUtil.callLater(function(){var t=(new Date).getTime()-r;a.gcsm.unFreeze("anamorph"),console.log("Cartogramme",e,"durée",l,"durée déformation toutes couches",t,"frame=",GCO5.core.GcDelayUtil.curFrame())},[],10*(d-1),this),d)for(var p=0;p<d;p+=1)GCO5.core.GcDelayUtil.callLater(a.render,[],10*p+2,this);else GCO5.core.GcDelayUtil.callLater(function(){a.render(),a.gcsm.unFreeze("anamorph")},[],2,this)}else if(s){for(var o in this._ly_a)(c=this._ly_a[o]).ly.topoModel.restoreTopoModelOrig();i||GCO5.core.GcDelayUtil.callLater(function(){a.render(),a.gcsm.unFreeze("anamorph")},[],2,this)}}}),GCO5.view.component.MapLegends=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.MapLegends"},map:null,d3legendsH0:null,$thLegDivContainerH:null,$selDivContainerH:null,legendHTranslateX:null,$thLegDivContainerV:null,$libViewDivContainerH:null,$selDivContainerV:null,_x00:null,_dragging:null,gclg:null,_formattedSelData:null,_leg_a:null,initialize:function(i){this.map=i,this.gclg=GCO5.core.GcLangManager.getInstance();function t(t){return a.gclg.getString(t,"selection")}var n,r,a=this;this.map.$legDivContainerH&&(0==this.map.$legDivContainerH.find("mapthlegendH").length&&(this.map.$legDivContainerH.append("<div class='mapLibView' ><p class='txtcenter'></p></div><button class='mapselH' title='"+t("SEL_PLAY_WITH")+"'><div><p class='selText'></p><span class='selPlus'>5</span></div></button><div class='mapthlegendH'></div>"),this.$thLegDivContainerH=this.map.$legDivContainerH.find(".mapthlegendH"),this.$selDivContainerH=this.map.$legDivContainerH.find(".mapselH"),this.$libViewDivContainerH=this.map.$legDivContainerH.find(".mapLibView"),$(".mapselH",this.map.$legDivContainerH).on("click keydown",function(t){$(a.map).triggerHandler(GCO5.view.component.MapViewThematic.DISPLAY_SEL_SETTINGS,[])})),(n=new Hammer.Manager(this.map.$legDivContainerH.get(0))).add(new Hammer.Tap({event:"singletap",threshold:15})),n.add(new Hammer.Pan({direction:Hammer.DIRECTION_HORIZONTAL})),this.legendHTranslateX=0,$(["PanStart","Pan","PanEnd","PanCancel","Press","PressUp","SingleTap","DoubleTap","Pinch","PinchEnd","PinchCancel"]).each(function(t){var e=this;n.on(this.toLowerCase(),function(t){a["on"+e]&&a["on"+e].apply(a,[t])})})),this.map.$legDivContainerV&&0==this.map.$legDivContainerV.find("mapthlegendV").length&&(r="<p class='pbn flex-container' style='justify-content:space-between'><span class='selTit'></span><button class='removeAllItems' tabindex='0' title='"+t("DESELECT_ALL")+"' ></button></p><div class='selMsg'></div>",r=(r+="<ul class='button-set pavs' style='line-height: 120%' >")+"<li><a href='javascript:void(0)' class='selPlusV small' title='"+t("SEL_PLAY_WITH2_HINT")+"...' >"+t("SEL_PLAY_WITH2")+"</a></li>"+(GCO5.appModel.hasReports()?"<li class='goto-report'><a href='javascript:void(0)' class='pdzV small' title=\""+t("GOTO_REPORTS_HINT")+'">'+t("GOTO_REPORTS")+"</a></li>":"")+"<li><a href='javascript:void(0)' class='methodsselgeo small' title='"+t("SELECTIONS_HELP_HINT")+"...'>"+t("SELECTIONS_HELP")+"</a><br class='no-display'><a href='javascript:void(0)' class='zoomselgeo small no-display' >"+t("SEL_ZOOM_IN")+"</a></li>",this.map.$legDivContainerV.append("<div class='mapselV' tabindex='0'>"+(r+="</ul>")+"</div><div class='mapthlegendV'></div>"),this.$thLegDivContainerV=this.map.$legDivContainerV.find(".mapthlegendV"),this.$selDivContainerV=this.map.$legDivContainerV.find(".mapselV"),$(".removeAllItems",this.$selDivContainerV).on("click keydown",function(t){var e=t.keyCode||t.which;"keydown"==t.type&&"13"!=e||a.map.clearSel("*")}),$(".zoomselgeo",this.$selDivContainerV).on("click",function(){var t=e.keyCode||e.which;"keydown"==e.type&&"13"!=t||a.map.zoomOnFeatureId(null,a.map.getSelIds())}),$(".selPlusV",this.map.$legDivContainerV).on("click keydown",function(t){var e=t.keyCode||t.which;"keydown"==t.type&&"13"!=e||$(a.map).triggerHandler(GCO5.view.component.MapViewThematic.DISPLAY_SEL_SETTINGS,[])}),$(".pdzV",this.map.$legDivContainerV).on("click keydown",function(t){var e=t.keyCode||t.which;"keydown"==t.type&&"13"!=e||(t={id:"report",categ:"main",selgeo:i.getSelgeo(),mapName:i.getName()},$(GCO5.topApp).triggerHandler(GCO5.view.component.AComponent.LOAD_COMPONENT,t))}),$(".methodsselgeo",this.map.$legDivContainerV).on("click keydown",function(t){var e=t.keyCode||t.which;"keydown"==t.type&&"13"!=e||$(a.map).triggerHandler(GCO5.view.component.MapViewThematic.DISPLAY_SEL_METHODS,[])}))},onBuildInfosel:function(t){var e=this.map.getSelDescriptions(),r=this;if(e){function i(t){return r.gclg.getString(t,"selection")}var r=this,n=this.map.getEnabledIndicsModelsIndexed(),a=this.map.hasSymbSelgeo()?this.map.getSymbThemeLayer().getName():this.map.getStatLayerName(),e=e[a];if(e){if(this.$selDivContainerH&&(this.$selDivContainerH.find("p").html(e.txt1),this.$libViewDivContainerH.find("p").html(e.libView+"<br>"+e.libView2),0!=e.nbObjs?(this.$thLegDivContainerH.parent().addClass("has-sel"),this.$libViewDivContainerH.hide()):(this.$thLegDivContainerH.parent().removeClass("has-sel"),this.$libViewDivContainerH.show())),this.$selDivContainerV)if(0!=e.nbObjs){var s,o,l=GCO5.appModel.getInfo("ReportsCompatibleWithSelgeo",[this.map.getSelgeo()]),l=(this.$selDivContainerV.find(".goto-report").css("display",0==l.length?"none":"block"),this.$selDivContainerV.find(".selTit").html(i("MY_SELECTION")),"<b>"+e.libSel+"</b>"),c=e.zonSelInfo;if(c?(s=GCO5.appModel.getInfo("libNivgeo",[this.map.getIdNivgeo(),!0,!0]),c.nivgeo=GCO5.appModel.getInfo("nivgeoFromLayerName",[c.layerName]),o=GCO5.core.GcStringUtil.proper(GCO5.appModel.getInfo("libNivgeo",[c.nivgeo])),l=e.libSel2+this.gclg.getString("P2")+" <b>"+e.libSel+"</b>",l+="<br>"+c.lyLib+this.gclg.getString("P2")+" <b><a href='javascript:void(0)'  class='selUnderZon' title='"+i("SEL_THE")+" "+s+"'>"+c.libgeo+"<a></b> "):e.libSel2!=e.libSel&&(l+="<br>"+e.libSel2),this.$selDivContainerV.find(".selMsg").html(l),this.$selDivContainerV.addClass("has-sel"),this.$selDivContainerV.focus(),$(".selUnderZon",this.map.$legDivContainerV).on("click keydown",function(t){var e,i,n=t.keyCode||t.which;"keydown"==t.type&&"13"!=n||((t={codgeo:c.codgeo,nivgeo:c.nivgeo,libgeo:o+" : "+c.libgeo}).id_extent=r.map.getIdExtent(),e=new GCO5.model.maps.SelGeo(t),i=r.map.getLyStatName(),e.getSelIds(r.map.nivgeo,t.id_extent,function(){r.map.drawSelgeo(e,i,!0)}))}),t)for(var h in n)this.map.getThemeViewByMapIndicModel(n[h]).updateLegend()}else if(this.$selDivContainerV.find(".selTit").html(""),this.$selDivContainerV.find(".selMsg").html(e.libView+"<br>"+e.libView2),this.$selDivContainerV.removeClass("has-sel"),t&&"delsel"==t.from)for(var h in n)this.map.getThemeViewByMapIndicModel(n[h]).updateLegend()}else console.warn("SelDescriptions manquantes",a,t,this.map.getSelDescriptions())}},animLegendRect:function(t,e){var i=$(t.node()),n=(1==this._legH_a.indexOf(t.attr("id"))&&(n=i.prev().attr("width")+"px",t.transition().duration(500).style("left",n)),e.width&&"0px"!=n&&(i=t.attr("width"),t.attr("width",e.width),i||t.style("width","2px")),t.transition().delay(function(t,e){return 1e3*$(this).index()}).duration(500));e.width&&n.style("width",e.width+"px")},_isMultiTouchEvent:function(t){return!(!t.pointers||!(1<t.pointers.length||1<this._nbTouches))},onPanStart:function(t){this.onDragStart(t)},onDragStart:function(t){if(this._isMultiTouchEvent(t))return!1;this._dragging=!0;var e=$(this.map.$legDivContainerH);e.css("cursor","move"),this._x00=t.center.x-e.offset().left,t.preventDefault()},onPan:function(t){this.onDrag(t)},onDrag:function(t){if(!this._dragging)return!1;t.preventDefault();t=this._getDragMoveX(t);$(".maplegendH > div, .maplegendH > button").css("transform","translateX("+(this.legendHTranslateX+t)+"px)")},onPanEnd:function(t){this.onDragEnd(t)},onDragEnd:function(t){var e=this;if(!this._dragging)return!1;GCO5.core.GcDelayUtil.callLater(function(){e._dragging=!1},[],10);var i=this.$selDivContainerH.outerWidth(),t=(this.d3legendsH0.each(function(t){i+=$(this).outerWidth()}),this.legendHTranslateX+=this._getDragMoveX(t),$(this.map.$legDivContainerH).width());0<this.legendHTranslateX?(this.legendHTranslateX=0,$(".maplegendH > div, .maplegendH > button").css("transform","translateX("+this.legendHTranslateX+"px)")):-this.legendHTranslateX>i-t&&(this.legendHTranslateX=Math.min(0,t-i),$(".maplegendH > div, .maplegendH > button").css("transform","translateX("+this.legendHTranslateX+"px)")),$(this.map.$legDivContainerH).css("cursor","pointer")},_getDragMoveX:function(t){var e=$(this.map.$legDivContainerH);t.center.x;return t.center.x-e.offset().left-this._x00},clearLegend:function(t){var e=this.map._legStage.canvas;GCO5.core.GcBitmapUtil.clearCanvas(e)},getLegendPrecision:function(){return GCO5.browser.isAndroid&&GCO5.browser.width<500||GCO5.browser.isIOS?2:1},_displaySettingsPanel:function(t,e,i){GCO5.core.GcComponentUtil.displaySlidingPanel(i),$(this.map).triggerHandler(GCO5.view.component.MapViewThematic.DISPLAY_THM_SETTINGS,[e])},_updateLegend:function(t){if(!this.map._zoomingOnSelection||this.map.getStyle("inReport")){var i=this.map.getEnabledIndicsModelsIndexed(),e=this,n=this.gclg.getString("SETTINGS"),r=(["de","en"].indexOf(this.gclg.getLang())<0&&(n=n.toLowerCase()),[]),a=0,s={};for(g in i)s[i[g].getExtendedPk()]=i[g].getProp("type"),r.push({mim:i[g],pk:i[g].getExtendedPk(),ordre:i[g].isVI()||i[g].isChoro()?2:1,imported:i[g].onImportedData(),id:++a});var o,l,c,h,d,u,p,g,f=GCO5.appModel.getInfo("IsFunctionAuthorized",["thparams"]),m=(this._legV_a=r.map(function(t){return t.pk}),r.sort(function(t,e){return t.ordre-e.ordre}),this._legH_a=r.map(function(t){return t.pk}),0<r.length?(this.$thLegDivContainerH.parent().addClass("has-thlegend"),this.$thLegDivContainerV&&this.$thLegDivContainerV.parent().addClass("has-thlegend")):(this.$thLegDivContainerH&&this.$thLegDivContainerH.parent().removeClass("has-thlegend"),this.$thLegDivContainerV&&this.$thLegDivContainerV.parent().removeClass("has-thlegend")),this.map.$legDivContainerV&&(o=(l=(u=d3.select(this.$thLegDivContainerV.get(0)).selectAll("svg").data(this._legV_a,function(t){return t})).enter().append("svg").attr("class","svgLegendV").attr("id",function(t,e){return t}).attr("height",20).attr("opacity",0)).merge(u),(GCO5.browser.isEdge?u.exit():u.exit().transition().duration(500).style("opacity",0).attr("height",0)).remove(),l.append("g").attr("class","header").append("rect").attr("height",22).attr("width","100%"),(u=l.select(".header")).append("text").attr("fill","white").attr("x",6).attr("y",2).attr("dy","1em"),u.append("rect").attr("class","figure-with-border").attr("width",15).attr("height",18).attr("x",3).attr("y",2),u.filter(function(t,e){return"Z"!=s[t]&&(f||r[e].imported)}).append("a").attr("xlink:href","javascript:void(0)").on("click",function(t){e._displaySettingsPanel(t,d3.select(this).datum(),this)}).on("keydown",function(t){13==t.keyCode||32==t.keyCode?e._displaySettingsPanel(t,d3.select(this).datum(),this):27==event.keyCode&&$(".cd-panel").trigger("click")}).attr("class","no-print").append("text").attr("text-anchor","end").attr("fill","white").attr("x","100%").attr("y",15).insert("tspan").style("font-family","arial").style("font-size","0.95em").text(" "+n+" ").append("tspan").attr("dy",1).style("font-family","GC_mobileIcons").text("t "),(u=l.append("g").attr("class","container").attr("transform","translate(5,25)")).append("g").attr("class","shapes"),u.append("g").attr("class","texts"),u.append("g").attr("class","valref"),u.append("g").attr("class","treatment"),o.select("g.header rect").attr("fill",function(t,e){t=t.split("|"),t.pop(),t=t.join("|");return i[t].getHeaderColor()}),o.select("g.header text").text(function(t,e){return e+1})),this.$thLegDivContainerH&&((c=(l=d3.select(this.$thLegDivContainerH.get(0)).selectAll("svg").data(this._legH_a,function(t){return t})).exit()).transition().duration(500).style("opacity",0).attr("height",function(){return 0}).remove(),1==c.size()&&l.transition().duration(500).style("left","0px").style("transform","none"),c=this._legH_a.length,h=l.enter().append("svg").attr("id",function(t,e){return $(".maplegendH > div").css("transform","none"),t}),(d=this.d3legendsH0=h.merge(l)).order(),(u=h.append("g").attr("class","container").attr("transform","translate(5,4)")).append("g").attr("class","shapes").attr("transform","translate(30,0)"),u.append("g").attr("class","texts").attr("transform","translate(30,0)"),u.append("g").attr("class","valref").attr("transform","translate(30,0)"),u.append("rect").attr("class","figure figure-with-border black").attr("width",15).attr("height",18).attr("x",2).attr("y",0),u.append("text").attr("fill","black").attr("class","figure").attr("x",5).attr("y",1).text("2").attr("dy","1em"),2==c&&d.select("g text.figure").text(function(t,e){return r[e].id}),u.filter(function(t,e){return"Z"!=s[t]&&(f||r[e].imported)}).append("a").attr("xlink:href","javascript:void(0)").on("click",function(t){e._displaySettingsPanel(t,d3.select(this).datum(),this)}).on("keydown",function(t){13==t.keyCode||32==t.keyCode?e._displaySettingsPanel(t,d3.select(this).datum(),this):27==event.keyCode&&$(".cd-panel").trigger("click")}).attr("class","mapsettings").append("text").text("t").attr("x",0).attr("y",2==c?41:29),d.select("g .mapsettings title").node()||d.select("g .mapsettings").append("title").text(n),d.select("g .mapsettings text").attr("y",2==c?41:29),d.select("g .figure").style("visibility",2==c?"visible":"hidden"),d.select("g text.figure").style("visibility",2==c?"visible":"hidden")),this.getLegendPrecision()),_=this.map._legStage.canvas,v=$(_),y=(_.height=50*m,_.width=1200*m,v.height(50),v.width(1200),this.map._legStage.removeAllChildren(),this.map._legStage.scaleX=this.map._legStage.scaleY=m,0),b=t&&t.imageWidth?t.imageWidth:1200,C=0<r.length?b/r.length:b;for(g in r){var x=r[g].mim,w=this.map.getThemeViewByMapIndicModel(x),S=(0<y++&&((S=new GCO5.view.display.Shape).graphics.beginStroke("#999").setStrokeStyle(1).moveTo(1,10).lineTo(1,45),this.map._legStage.addChild(S)),d?d.filter(function(t,e){t=t.split("|");return t.pop(),i[t.join("|")]===x}):null),M=o?o.filter(function(t,e){t=t.split("|");return t.pop(),i[t.join("|")]===x}):null,O=p&&r.length===r[g].id?b-p:C;p=w.updateLegend({legStage:t?t.legStage:null,svgLegendH:S,svgLegendV:M,id:r[g].id,nbLegends:r.length,maxWidth:O},this).h_curx+20,_.width=m*p,v.width(_.width/m),this.map._legStage.update()}1==y&&"Z"==r[0].mim.getProp("type")&&(d.select("g .figure").style("visibility","visible").attr("y","11"),d.select("g text.figure").style("visibility","visible").text("1").attr("y","12")),2==y&&"Z"==r[1].mim.getProp("type")&&(d.select("g .figure").filter(function(t,e){return 1==e}).attr("y","11"),d.select("g text.figure").filter(function(t,e){return 1==e}).attr("y","12")),$(this.map).triggerHandler(GCO5.view.component.MapView.UPD_LEGEND,[p])}}}),GCO5.view.component.Maplegend=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.Maplegend"},map:null,thv:null,gclg:null,boxesFiltered:null,def_o:null,legendManager:null,legendStage:null,initialize:function(t){this.map=t.map,this.thv=t.thv,this.gclg=GCO5.core.GcLangManager.getInstance()},updateLegend:function(t,e){t&&(this.def_o=t),e&&(this.legendManager=e),t&&t.legStage&&(this.legendStage||(this.legendStage=new GCO5.view.display.Stage(document.createElement("canvas"))),this.legendStage.removeAllChildren(),2==t.nbLegends&&((e=new GCO5.view.display.Shape).graphics.beginFill("#FFF").beginStroke("#333333").setStrokeStyle(1).rect(1,1,14,16),(t=new GCO5.view.display.Text(t.id,"bold 12px Arial,Helvetica,sans-serif","#000",!1)).textBaseline="alphabetic",t.x=4,t.y=13,this.legendStage.addChild(e),this.legendStage.addChild(t)))},getCanvas:function(){return this.legendStage.canvas},_toggleVis:function(t,e){if(!this.legendManager._dragging&&!this.thv.mapIndicModel.isTypoPole()){var i,n=this.thv.mapIndicModel,r=n.getMeta("classesVisibility"),a=t.hasOwnProperty("id")?t.id:e;for(i in r)r[i]=!!this.boxesFiltered||a==i;n.updateWithDefs({classesVisibility:r}),this.map.updTheme(n),this.boxesFiltered=!this.boxesFiltered}},clearLegends:function(t){this.def_o&&[this.def_o.svgLegendV,this.def_o.svgLegendH].forEach(function(e){e&&t.forEach(function(t){e.selectAll(t).remove()})})},animLegendRect:function(t,e){t=t.transition().duration(500);e.width&&t.attr("width",e.width),e.height&&t.attr("height",e.height),t.attr("opacity",1)},drawChoroLegendV:function(n){n.symbVI||n.symbDiscr?(e={cc:"circle",sq:"rect",tr:"polygon",st:"polygon",ls:"polygon",cr:"polygon",line:"line"},this.def_o.svgLegendV.select(".shapes").selectAll(".box").empty(),i=(t=this.def_o.svgLegendV.select(".shapes")).selectAll(".box").data(n.v_box_a).enter().append(function(t){return document.createElementNS("http://www.w3.org/2000/svg",e[t.symb])}).attr("class",function(t){return"box "+t.symb}).attr("stroke-width",1).on("click",$.proxy(this._toggleVis,this)),this.thv.mapIndicModel.isTypoPole()||i.append("title").text(this.gclg.getString("SHOW_CAT_INDIC","indics")),GCO5.core.GcD3Util.addD3Attributes(i,["fill","stroke"]),t.selectAll(".box.cc").attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}).attr("r",function(t){return t.w/2}),t.selectAll(".box.sq").attr("x",function(t){return t.x-t.w/2}).attr("y",function(t){return t.y-t.h/2}).attr("width",function(t){return t.w}).attr("height",function(t){return t.h}),t.selectAll(".box.line").attr("x1",function(t){return t.x-t.w/2}).attr("y1",function(t){return t.y}).attr("x2",function(t){return t.x-t.w/2+t.w}).attr("y2",function(t){return t.y}).attr("stroke",function(t){return t.fill}).attr("fill","none").attr("stroke-width",function(t){return t.size}),["ls","st","tr","cr"].forEach(function(e){t.selectAll(".box."+e).attr("points",function(t){return GCO5.view.component.SymbPointThemeView.drawSVGSymb(e,t)})})):((i=this.def_o.svgLegendV.select(".shapes").selectAll(".box").data(n.v_box_a).enter().append("rect").attr("class","box").attr("stroke-width",1).on("click",$.proxy(this._toggleVis,this))).append("title").text(this.gclg.getString("SHOW_CAT_INDIC","indics")),GCO5.core.GcD3Util.addD3Attributes(i,["width","height","fill","stroke","x","y"]));var e,t,i,r=parseFloat($(this.def_o.svgLegendV.node()).css("max-width")),a=(170==r&&GCO5.browser.isFirefox&&(r=150),!n.isZonage&&0<n.v_txt_a.length&&(r+=-(n.v_txt_a[0].x-5)-15),0),s=this.map.getPrintMode(),o=s?10:GCO5.browser.isFirefox?13:12,l=s?"1.55em":"1.4em",c=n.symbVI&&!GCO5.browser.isIE,l=this.def_o.svgLegendV.select(".texts").selectAll(".txtleg").data(n.v_txt_a).enter().append("text").attr("class","txtleg").text(function(t){return t.txt}).attr("x",function(t){return t.x}).each(function(t,e){var i=GCO5.core.GcObjectUtil.getSVGElementBbox(this,"txtleg").width;n.tl=Math.max(n.tl,i)}).attr("y",function(t){return t.y}).attr("dy",c?0:l).call(this.wrap,r,"txtleg",function(t){return t.x},0,c);return l.each(function(t,e){var i=$(this).children("tspan").length;t.y+=a,n.v_box_a[e].y+=a,1<i&&(a+=(i-1)*o,n.v_box_a[e].y+=(i-1)*o/2+(s?-1:3)),e==n.k_valref_v&&(n.v_yref=n.v_box_a[e].y)}).attr("y",function(t){return t.y}).selectAll("tspan").attr("y",function(t){return t.y}),0<a&&(n.symbVI||n.symbDiscr?(i.attr("cy",function(t){return t.y}).attr("y",function(t){return t.y-("sq"==t.symb?t.h/2:0)}),["ls","st","tr","cr"].forEach(function(e){t.selectAll(".box."+e).attr("points",function(t){return GCO5.view.component.SymbPointThemeView.drawSVGSymb(e,t)})})):i.attr("y",function(t){return t.y}),n.v_cury+=a),{selBoxes:i,selTexts:l}},drawChoroLegendH:function(t){var e,i,n,r=this,t=(t.symbVI?(e={cc:"circle",sq:"rect",tr:"polygon",st:"polygon",ls:"polygon",cr:"polygon",line:"rect"},this.def_o.svgLegendH.select(".shapes").selectAll(".box").empty(),n=(i=this.def_o.svgLegendH.select(".shapes")).selectAll(".box").data(t.h_box_a).enter().append(function(t){return document.createElementNS("http://www.w3.org/2000/svg",e[t.symb])}).attr("class",function(t){return"box "+t.symb}).attr("stroke-width",1).on("click",$.proxy(this._toggleVis,this)),GCO5.core.GcD3Util.addD3Attributes(n,["fill","stroke"]),i.selectAll(".box.cc").attr("r",function(t){return t.w/2}),i.selectAll(".box.sq, .box.line").attr("width",function(t){return t.w}).attr("height",function(t){return t.h}),["ls","st","tr","cr"].forEach(function(e){i.selectAll(".box."+e).attr("points",function(t){return GCO5.view.component.SymbPointThemeView.drawSVGSymb(e,t)})})):(n=this.def_o.svgLegendH.select(".shapes").selectAll(".box").data(t.h_box_a).enter().append((t.symbDiscr,"rect")).attr("class","box").attr("stroke-width",1).on("click",$.proxy(this._toggleVis,this)),GCO5.core.GcD3Util.addD3Attributes(n,["width","height","fill","stroke","x","y"])),n.append("title").text(function(t,e){return r.gclg.getString("SHOW_CAT_INDIC","indics")}),this.def_o.svgLegendH.select(".texts").selectAll(".txtleg").data(t.h_txt_a).enter().append("text").attr("class","txtleg").attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).text(function(t){return t.isRequired?t.txt:""}));return{selBoxes:n,selTexts:t}},gatherChoroLegendInfo:function(t){var e=this.thv.mapIndicModel,i=e.isZonage()||e.isTypoPole(),n=0<(e.getDistribInfo()?e.getDistribInfo().eftallnath:0),r=this.thv.mapIndicModel.isChoro()&&"1"==GCO5.appModel.getInfo("option",["choroLegDesc"]),a={h_txt_a:[],v_txt_a:[],h_box_a:[],v_box_a:[],h_curx:0,v_cury:0,h_cursy:13,tl:0,h_boxwidth:GCO5.browser.width<400?35:50,h_boxheight:15,v_boxwidth:GCO5.browser.isFirefox?15:20,v_boxheight:GCO5.browser.isFirefox?15:20,isZonage:i,treatment:e.getMeta("treatment")},s=this.thv.mapIndicModel.isSymbVI(),o=this.thv.mapIndicModel.isSymbDiscr(),l=this.thv.mapIndicModel.applyToLines(),c=(o&&(n=!1),"VI"==t?(a.h_boxwidth=l?15:20,e.isSymbVI()&&!l&&(a.v_boxwidth=a.h_boxwidth=10)):a.h_cursy+=2,e.getDiscretisationInfo()?e.getDiscretisationInfo().k_valref:-1),h=e.getRangesInfo(!0,!1,o,"VI"==t),d=h?h.length:0,u=0,p=0,g=0,f=(e.isTypoPole()&&(d=6),(i||s&&n)&&(h.pop(),n=!1,d--),-1==c&&"VI"!=t&&(a.h_cursy+=5),h),t=c,m=(r&&(f=h.concat().reverse(),n&&f.push(f.shift()),0<=c&&(t=h.length-c-Number(n))),0);if(s||o)for(var _=0;_<d;_++)var v=GCO5.view.component.SymbPointThemeView.getRectSymb(h[_].symb,h[_].size),m=Math.max(m,v.w);for(_=0;_<d;_++){var y,b,C,x,w=_==d-1,S=(n&&w&&(u=15),s?(v=GCO5.view.component.SymbPointThemeView.getRectSymb(h[_].symb,h[_].size||6),a.h_box_a.push({id:h[_].id,fill0:h[_].colf,fill:h[_].visi?h[_].colf:"rgba(0,0,0,0)",stroke:"#999",size:l?2:6,w:v.w,h:v.h,symb:h[_].symb||"cc",x:u,y:0})):a.h_box_a.push({id:h[_].id,fill0:h[_].colf,fill:h[_].visi?h[_].colf:"#fff",stroke:"#ccc",width:a.h_boxwidth,height:a.h_boxheight,x:_*a.h_boxwidth+u,y:a.h_cursy,r:h[_].size||5,symb:h[_].symb||"cc",cx:_*a.h_boxwidth+u,cy:a.h_cursy}),!i&&(_<d||n)&&(n&&w&&(a.h_curx+=5,u-=a.h_boxwidth/2+5),a.h_curx+=a.h_boxwidth,0===_&&h[_].startValueLib&&a.h_txt_a.push({txt:h[_].startValueLib,x:u,y:a.h_cursy-5,isRequired:!1}),x=h[_].lib0,S=a.h_curx+u,y=a.h_cursy-5,b=!0,(!n&&w||n&&_===d-2)&&h[_].endValueLib&&(x=h[_].endValueLib,b=!1),a.h_txt_a.push({txt:x,x:S,y:y,isRequired:b})),n&&w&&(p=5),s||o?(C=m/2,v=GCO5.view.component.SymbPointThemeView.getRectSymb(f[_].symb,f[_].size),g+=(x=Math.max(v.h+10,a.v_boxheight))/2,a.v_box_a.push({id:f[_].id,fill0:f[_].colf,fill:f[_].visi?f[_].colf:"rgba(0,0,0,0)",stroke:"#999",size:f[_].size,w:v.w,h:v.h,x:C,y:g+(n&&w?5:0),rowHeight:x,symb:f[_].symb||"cc"}),g+=x/2):a.v_box_a.push({id:f[_].id,fill0:f[_].colf,fill:f[_].visi?f[_].colf:"#fff",stroke:"#ccc",width:a.v_boxwidth,height:a.v_boxheight,x:i?_*a.h_boxwidth+u:0,y:i?a.h_cursy-5:_*a.v_boxheight+p,r:f[_].size||5,cx:5,cy:_*a.v_boxheight+p+a.v_boxheight/2}),s&&!GCO5.browser.isIE);i||(s||o?a.v_txt_a.push({txt:f[_].lib,x:2*C+5,y:a.v_box_a[_].y-(S?1:12)-(o?1:0)}):a.v_txt_a.push({txt:f[_].lib,x:a.v_boxwidth+5,y:a.v_boxheight*_+p-2}))}return i&&this.thv.map.getStyle("zonagesOnly")&&(a.h_txt_a.push({txt:e.getProp("libIndic"),x:0,y:15}),a.h_box_a.forEach(function(t){t.y+=10})),a.v_cury=s||o?g-4:_*a.v_boxheight+p,(!isNaN(c)&&0<=c||i)&&(a.valref=!0,a.k_valref_v=t,a.ref_txt=e.getProp("refLib"),a.h_xref=c*a.h_boxwidth,a.h_yref=a.h_boxheight+a.h_cursy+12,a.v_yref=t*a.v_boxheight,o||(a.includeValref=!0)),a.valref_txt=e.getProp("refMention",!0,!0),this.testValSel(a,e),a},updateLegendValref:function(){},updateLegendEfts:function(){this.thv.mapIndicModel},testValSel:function(t,e){e=e.getProp("valSelFormatted",!0,!0);e&&(t.valsel_txt=this.gclg.getString("SELECTION","concepts")+this.gclg.getString("P2B")+" "+e)},wrap:function(t,l,c,h,d,u){h=h||0,d=d||0,t.each(function(){var t,e=d3.select(this),i=e.text().split(/ +/).reverse(),n=[],r=0,a=e.attr("y"),s=parseFloat(e.attr("dy")||0),o=e.text(null).append("tspan").attr("x",h).attr("y",a).attr("dy",s+d+"em");for(u&&o.attr("dominant-baseline","central");t=i.pop();)n.push(t),o.text(n.join(" ")),GCO5.core.GcObjectUtil.getSVGElementBbox(o.node(),c).width>l&&(n.pop(),o.text(n.join(" ")),n=[t],o=e.append("tspan").attr("x",h).attr("y",a).attr("dy",1.1*++r+s+"em").text(t),u&&o.attr("dominant-baseline","central"))})}}),GCO5.view.component.MaplegendChoroNum=GCO5.view.component.Maplegend.extend({statics:{NAME:"GCO5.view.component.MaplegendChoroNum"},updateLegendValref:function(){var t=this.gatherChoroLegendInfo();t.valref_txt&&this.def_o.svgLegendV.select(".valref").selectAll(".txtRef").text(t.valref_txt),t.valsel_txt&&this.def_o.svgLegendV.select(".valref").selectAll(".txtSel").text(t.valsel_txt)},updateLegendEfts:function(){var i=this.thv.mapIndicModel.getRangesInfo(!0,!1,!1,!1);this.def_o.svgLegendV.selectAll(".txtleg:not(.txtRef)").text(function(t,e){return i[e]?i[e].lib:null})},updateLegend:function(t,e){if(this._super(t,e),!this.def_o)return{};var i,n,r,a,s,o,l,c,e=this.gatherChoroLegendInfo();return e.symbDiscr=this.thv.mapIndicModel.isSymbDiscr(),this.clearLegends([".box",".txtleg",".txtRef",".lineRef"]),this.def_o.svgLegendV&&(i=parseFloat($(this.def_o.svgLegendV.node()).css("max-width")),this.drawChoroLegendV(e),e.valref_txt&&(n=this.def_o.svgLegendV.select(".valref").selectAll(".txtRef").data([[]]).enter().append("text").attr("class","txtRef txtleg").text(e.valref_txt).attr("x",0).attr("y",e.v_cury+18).call(this.wrap,i,"txtRef",0,0,!1),r=GCO5.core.GcObjectUtil.getSVGElementBbox(n.node()),e.includeValref&&this.def_o.svgLegendV.select(".valref").selectAll(".lineRef").data([[]]).enter().append("line").attr("class","lineRef").attr("x1",0).attr("y1",e.v_yref).attr("x2",e.v_boxwidth).attr("y2",e.v_yref),e.v_cury+=r.height),e.valsel_txt&&(n=this.def_o.svgLegendV.select(".valref").selectAll(".txtSel").data([[]]).enter().append("text").attr("class","txtSel txtleg").text(e.valsel_txt).attr("x",0).attr("y",e.v_cury+18+1).call(this.wrap,i,"txtSel",0,0,!1),r=GCO5.core.GcObjectUtil.getSVGElementBbox(n.node()),e.v_cury+=r.height),n={liss:this.gclg.getString("LISSED_DATA","mapthemes"),dem:this.gclg.getString("DEM","mapthemes")},e.treatment&&(this.def_o.svgLegendV.select(".treatment").selectAll(".txtTreatment").data([[]]).enter().append("text").attr("class","italic txtleg").text(n[e.treatment]).attr("x",0).attr("y",e.v_cury+18),e.v_cury+=18),this.animLegendRect(this.def_o.svgLegendV,{width:i,height:e.v_cury+25+7,delay:0})),this.def_o.svgLegendH&&(a=(r=this.drawChoroLegendH(e)).selBoxes,r.selTexts.attr("text-anchor","middle"),e.valref&&(this.def_o.svgLegendH.select(".valref").selectAll(".txtRef").data([[]]).enter().append("text").attr("class","txtRef txtleg").attr("text-anchor","middle").text(e.ref_txt).attr("x",e.h_xref).attr("y",e.h_yref),this.def_o.svgLegendH.select(".valref").selectAll(".lineRef").data([[]]).enter().append("line").attr("class","lineRef").attr("x1",e.h_xref).attr("y1",e.h_cursy).attr("x2",e.h_xref).attr("y2",e.h_cursy+e.h_boxheight)),s=e.h_curx+20+20+10,this.legendManager.animLegendRect(this.def_o.svgLegendH,{width:s})),t&&t.legStage&&(o=this.legendStage,l=new GCO5.view.display.Shape,o.canvas.width=s,o.canvas.height=Math.max(o.canvas.height,60),a.each(function(t){l.graphics.beginFill(t.fill).beginStroke(t.stroke).setStrokeStyle(.5).rect(t.x+25,t.y+15,t.width,t.height),o.addChild(l)}),e.h_txt_a.forEach(function(t){(c=new GCO5.view.display.Text(t.txt,"normal 0.65em Arial,Helvetica,sans-serif","#000000",!1)).textBaseline="alphabetic",c.textAlign="center",c.x=t.x+25,c.y=t.y+15,o.addChild(c)}),e.valref&&(l.graphics.beginStroke("#666").setStrokeStyle(2).moveTo(e.h_xref+25,+e.h_cursy+15).lineTo(e.h_xref+25,e.h_boxheight+e.h_cursy+15),(c=new GCO5.view.display.Text(e.ref_txt,"normal 0.65em Arial,Helvetica,sans-serif","#000000",!1)).textBaseline="alphabetic",c.textAlign="center",c.x=e.h_xref+25,c.y=e.h_yref+15,o.addChild(c)),o.update()),e}}),GCO5.view.component.MaplegendVI=GCO5.view.component.Maplegend.extend({statics:{NAME:"GCO5.view.component.MaplegendVI"},updateLegend:function(t,e){if(this._super(t,e),!this.def_o)return{};var i,n,r,a,s,o,l,c,h,d,u,p,g,f,m=this.gatherChoroLegendInfo("VI"),e=(m.symbVI=this.thv.mapIndicModel.isSymbVI(),this.thv.mapIndicModel.applyToLines());return this.clearLegends([".box",".txtleg"]),this.def_o.svgLegendV&&(this.drawChoroLegendV(m),h=parseFloat($(this.def_o.svgLegendV.node()).css("max-width")),m.isZonage?(m.h_curx=m.h_box_a.length*m.h_boxwidth+20,m.v_cury=20,d=this.def_o.svgLegendV.select(".valref").selectAll(".txtRef").data([0]),c=this.thv.mapIndicModel.isTypoPole()?this.gclg.getString("POLE_TYPO_DESC_LEGEND","mapthemes")+". "+m.valref_txt+" "+this.gclg.getString("POLES","indics"):this.gclg.getString("ADJACENT_AREAS_DIFFERENT_COLOR","mapthemes")+". "+m.valref_txt,(d=d.enter().append("text").attr("class","txtRef txtleg").text(c).attr("x",0).attr("y",m.v_cury).attr("dy","2em").call(this.wrap,h,"txtRef",function(t){return 0}).merge(d)).each(function(t,e){u=GCO5.core.GcObjectUtil.getSVGElementBbox(this,"txtleg")}),m.v_cury=u.y+u.height-5):m.h_curx=Math.max(m.tl+20+20,120),this.animLegendRect(this.def_o.svgLegendV,{width:h,height:m.v_cury+25+7})),this.def_o.svgLegendH&&(r=this.drawChoroLegendH(m),i=[],n=r.selBoxes,(r=r.selTexts).each(function(t,e){i[e]=GCO5.core.GcObjectUtil.getSVGComputedTextLength(this)}),a=m.h_boxwidth,f=GCO5.core.GcD3Util._getMiddleIndice(i,a+15+5),m.isZonage||(s=f.id,l=i.length,r.attr("x",function(t,e){return m.h_txt_a[e].x=0==e||e==s?o=a+5:o+=i[e-1]+a+15}).attr("y",function(t,e){return m.h_txt_a[e].y=1==l?24:e<s?12:37})),m.h_curx=Math.max(f.sum1,f.sum2)-15,m.isZonage?(m.h_curx=m.h_box_a.length*a+10,this.thv.mapIndicModel.isTypoPole()&&(c=this.gclg.getString("POLE_TYPO_DESC_LEGEND_MAIN","mapthemes"),h=a,(d=(d=this.def_o.svgLegendH.select(".valref").selectAll(".txtRef").data([0])).enter().append("text").attr("class","txtRef txtleg").text(c).attr("x",m.v_curx).attr("y",20).attr("dy","1.8em")).each(function(t,e){u=GCO5.core.GcObjectUtil.getSVGElementBbox(this,"txtleg")}),m.v_cury=u.y+u.height-5,m.h_curx=u.width)):e?n.attr("x",function(t,e){return m.h_box_a[e].x=0==e||e==s?o=0:o+=a+i[e-1]+15}).attr("y",function(t,e){return m.h_box_a[e].y=6+(1==l?12:e<s?0:25)}).attr("stroke","none"):n.attr("x",function(t,e){return m.h_box_a[e].x=0==e||e==s?o=1:o+=a+i[e-1]+15}).attr("y",function(t,e){return m.h_box_a[e].y=(m.symbVI?4:1)+(1==l?12:e<s?0:25)}).attr("cx",function(t,e){return m.h_box_a[e].cx=0==e||e==s?o=5:o+=a+i[e-1]+15}).attr("cy",function(t,e){return m.h_box_a[e].cy=8+(1==l?12:e<s?0:25)}).each(function(t,e){0<=["st","ls","cr","tr"].indexOf(t.symb)&&(p=m.h_txt_a[e].x-10,g=m.h_box_a[e].y=8+(1==l?12:e<s?0:25),d3.select(this).attr("transform","translate("+p+","+g+")"))}),f=m.h_curx+20+20,this.legendManager.animLegendRect(this.def_o.svgLegendH,{width:f})),t&&t.legStage&&this._buildLegendCanvas(t,r,i,f,m,n),m},_buildLegendCanvas:function(t,e,i,n,r,a){var s,o,l,c=this.legendStage,h=new GCO5.view.display.Shape,d=2==t.nbLegends?25:0,u=document.createElement("canvas").getContext("2d"),p=c.canvas.getContext("2d"),g=(u.font="11px Arial,Helvetica,sans-serif",[]),f=[],m=0,_=(e.each(function(t,e){g[e]=Math.ceil(u.measureText(t.txt).width)}),a.each(function(t,e){f[e]=r.symbVI?t.w||t.size:r.h_boxwidth}),t.maxWidth),v=1,y=d;return g.forEach(function(t,e){y+=t+f[e]+10,_<y&&(v++,y=d+t+f[e]+10)}),c.canvas.width=Math.max(c.canvas.width,_+(2==t.nbLegends?-10:0)),c.canvas.height=Math.max(c.canvas.height,10+25*v),r.symbVI?(m=d,o=12,a.each(function(t,e){d<m&&m+g[e]+f[e]>_&&(o+=25,m=d),"cc"==t.symb?(h.graphics.beginFill(t.fill).beginStroke(t.stroke).setStrokeStyle(.5).drawCircle(5+m,3+o,t.size),c.addChild(h)):"line"==t.symb?(h.graphics.beginFill(t.fill).rect(5+m,3+o,t.w,3),c.addChild(h)):GCO5.view.component.SymbPointThemeView.drawCanvasSymb(t.symb,p,t.size,t.fill,{x:5+m,y:3+o}),m+=g[e]+f[e]+10})):(m=d,o=6,l=this.thv.mapIndicModel.isTypoPole(),a.each(function(t,e){!r.isZonage&&!l&&d<m&&m+g[e]+f[e]>_&&(o+=25,m=d),h.graphics.beginFill(t.fill).beginStroke(t.stroke).setStrokeStyle(.5).rect(m,3+o,t.width,t.height),c.addChild(h),r.isZonage||l?m+=f[e]:m+=g[e]+f[e]+10})),m=d,o=15,e.each(function(t,e){d<m&&m+g[e]+f[e]>_&&(o+=25,m=d),(s=new GCO5.view.display.Text(t.txt,"11px Arial,Helvetica,sans-serif","#000000",!1)).textBaseline="alphabetic",s.x=5+f[e]+m,s.y=5+o,c.addChild(s),m+=g[e]+f[e]+10}),r.symbVI&&(c.autoClear=!1),c.update(),c}}),GCO5.view.component.MaplegendCircles=GCO5.view.component.Maplegend.extend({statics:{NAME:"GCO5.view.component.MaplegendCircles"},updateLegendValref:function(){var t,e=this.thv.mapIndicModel.getProp("refMention",!0,!0),e=(GCO5.core.GcStringUtil.isEmpty(e)||this.def_o.svgLegendV.select(".valref").selectAll(".txtRef").text(e),this.thv.mapIndicModel.getProp("valSelFormatted",!0,!0));(t=e?this.gclg.getString("SELECTION","concepts")+this.gclg.getString("P2B")+" "+e:t)&&this.def_o.svgLegendV.select(".valref").selectAll(".txtSel").text(t)},updateLegend:function(t,e){if(this._super(t,e),!this.def_o)return{};e=this.thv.mapIndicModel;if(e.getMeta("pauseLegend"))return{};var i=e.getProp("nbDec"),n={h_curx:40,v_cury:100,h_boxwidth:(GCO5.browser.width,20),h_boxheight:15,v_boxwidth:20,v_boxheight:15},r=e.getProp("refMention",!0,!0),r=(GCO5.core.GcStringUtil.isEmpty(r)||(n.valref_txt=r),this.testValSel(n,e),e.indicModel),a=e.getHighlightedMod(),s=e.hasMultVars(),R=e.getMeta("classesVisibility"),k=e.getProp("VILibs"),o=e.getMeta("colf"),r=!s&&0<r.getStat("nv_neg")||!s&&2==o.length,l=e.getMeta("idSymb"),c=r||s&&-1==a?"#bbb":s&&0<=a?o[a]:o[0],F=(this.thv.hasIndicAssoc()&&(c="#ccc"),GCO5.core.GcMathUtil.binToHex(GCO5.core.GcMathUtil.adjustBrightness2(c,20))),h=r?[this.gclg.getString("POSITIVE","indics"),this.gclg.getString("NEGATIVE","indics")]:k;if(this.clearLegends([".box",".txtleg",".txtleg2",".txtRef",".circles","defs"]),this.def_o.svgLegendV){var d,u=e.getMeta("valmax"),u=2*this.thv.getRadiusFromValue(u),u=u<75&&(!e.isPie()||-1==a)?u:75,a=(d=u/2)/2,p=this.thv.getValueFromRadius(d).toPrecision(3),g=((p=isNaN(p)?0:p)/4).toPrecision(3),f=this.gclg.formatNumber(p,i,!0),m=this.gclg.formatNumber(g,i,!0),_=(0==p&&(f=0<e.getDistribInfo().eftallnath?this.gclg.getString("NA","indics")+" ("+e.getDistribInfo().eftallnath+")":this.gclg.getString("NO_POSITIVE_VALUES","mapthemes"),m="",d=a=0),40<u),v={v:+p,t:f},y=(_&&(v.v2=+g,v.t2=m),e.setStyleSilent("legend",v),[{dcx:0,dcy:17,r:d,txt:f,x:0==d?5:d,y:14},{dcx:a,dcy:2*a+17,r:a,txt:m,x:d,y:17+d-3}]),a=("sq"!=l&&"es"!=l||(y[0].dcy+=2,y[0].y+=4),y.forEach(function(t){t.cx=t.cy=t.r,t.idSymb=l,t.colf1=F,t["text-anchor"]=0==d?"start":"middle"}),_?(this._createCircles(this.def_o.svgLegendV,y,1==e.getMeta("rdplein"),r||s,!0),(g=GCO5.core.GcObjectUtil.cloneJson(y[1])).halo=!0,y.splice(1,0,g)):(y.pop(),7<f.length&&(v=4*(f.length-7),y[0].x+=v,y[0].dcx+=v),this._createCircles(this.def_o.svgLegendV,y,1==e.getMeta("rdplein"),r||s)),this._createTexts(this.def_o.svgLegendV,y),this.def_o.svgLegendV.select(".container"));a.attr("transform","translate(5,25)").select(".valref").attr("transform","translate(0,0)");var b=5-GCO5.core.GcObjectUtil.getSVGElementBbox(a.node()).x;if(a.attr("transform","translate("+(5+b)+",25)").select(".valref").attr("transform","translate("+-b+",0)"),n.v_cury=17+2*d,(r||s)&&!this.thv.hasIndicAssoc()&&0<p){var C=h.length,x=2;n.v_cury+=5,y=[],n.h_curx+=10;for(var w=0;w<C;w++)y.push({fill:R[w]?o[w]:"#fff",fill0:o[w],txt:$.trim(h[w]),x:5-b,y:n.v_cury,tx:5+n.v_boxwidth+5-b,ty:n.v_cury-4-2,width:n.v_boxwidth,height:n.v_boxheight}),n.v_cury+=n.v_boxheight+6;n.v_cury-=6;var m=this.def_o.svgLegendV.select(".shapes").selectAll(".box").data(y).enter().append("rect").attr("class","box").attr("stroke-width",1).attr("stroke","#ccc").on("click",$.proxy(this._toggleVis,this)),S=(GCO5.core.GcD3Util.addD3Attributes(m,["width","height","fill","x","y"]),0),M=parseFloat($(this.def_o.svgLegendV.node()).css("max-width")),V=(M+=-(y[0].tx-5)-15,this.map.getPrintMode());this.def_o.svgLegendV.select(".texts").selectAll(".txtleg2").data(y).enter().append("text").attr("class","txtleg2").text(function(t){return t.txt}).attr("x",function(t){return t.tx}).each(function(t,e){var i=GCO5.core.GcObjectUtil.getSVGElementBbox(this,"txtleg2").width;n.tl=Math.max(n.tl,i)}).attr("y",function(t){return t.ty}).attr("dy","1.4em").call(this.wrap,M,"txtleg2",function(t){return t.tx}).each(function(t,e){var i=$(this).children("tspan").length;t.ty+=S,y[e].y+=S,1<i&&(S+=10*(i-1),y[e].y+=10*(i-1)/2+(V?-1:3))}).attr("y",function(t){return t.ty}).selectAll("tspan").attr("y",function(t){return t.ty}),0<S&&(m.attr("y",function(t){return t.y}),n.v_cury+=S)}M=parseFloat($(this.def_o.svgLegendV.node()).css("max-width"));n.valref_txt&&(A=this.def_o.svgLegendV.select(".valref").selectAll(".txtRef").data([[]]).enter().append("text").attr("class","txtRef txtleg").text(n.valref_txt).attr("x",0).attr("y",n.v_cury+18).call(this.wrap,M,"txtRef",0,0,!1),P=GCO5.core.GcObjectUtil.getSVGElementBbox(A.node()),n.v_cury+=P.height),n.valsel_txt&&(A=this.def_o.svgLegendV.select(".valref").selectAll(".txtSel").data([[]]).enter().append("text").attr("class","txtSel txtleg").text(n.valsel_txt).attr("x",0).attr("y",n.v_cury+18+1).call(this.wrap,M,"txtSel",0,0,!1),P=GCO5.core.GcObjectUtil.getSVGElementBbox(A.node()),n.v_cury+=P.height),this.animLegendRect(this.def_o.svgLegendV,{width:M,height:n.v_cury+25+6+2})}if(this.def_o.svgLegendH){if(y=[],d=(u=40)/2,p=this.thv.getValueFromRadius(u/2),isNaN(p)&&(p=0),f="= "+this.gclg.formatNumber(p.toPrecision(3),i,!0),y.push({dcx:0,dcy:0,r:d,txt:f,x:u+5,y:d+3}),y.forEach(function(t){t.cx=t.cy=t.r,t.flat=!1,t.colf1=F,t.idSymb=l,t["text-anchor"]="start"}),this._createCircles(this.def_o.svgLegendH,y,1==e.getMeta("rdplein")),n.h_curx+=this._createTexts(this.def_o.svgLegendH,y),(r||s)&&!this.thv.hasIndicAssoc()){C=h.length,x=2,y=[];n.h_curx+=10;for(w=0;w<C;w++)y.push({fill:R[w]?o[w]:"#fff",fill0:o[w],txt:$.trim(h[w]),x:n.h_curx,y:x,tx:n.h_curx,ty:x,width:n.h_boxwidth,height:n.h_boxheight}),x+=n.h_boxheight+6;var U,_=this.def_o.svgLegendH.select(".shapes").selectAll(".box").data(y).enter().append("rect").attr("class","box").attr("stroke-width",1).attr("stroke","#ccc").on("click",$.proxy(this._toggleVis,this)),O=(GCO5.core.GcD3Util.addD3Attributes(_,["width","height","fill"]),[]),g=this.def_o.svgLegendH.select(".texts").selectAll(".txtleg2").data(y).enter().append("text").attr("class","txtleg2").text(function(t){return t.txt}).each(function(t,e){O[e]=GCO5.core.GcObjectUtil.getSVGComputedTextLength(this)}),G=n.h_boxwidth,v=GCO5.core.GcD3Util._getMiddleIndice(O,G+15+5),B=v.id,C=O.length;g.attr("x",function(t,e){return y[e].tx+=0==e||e==B?U=G+5:U+=O[e-1]+G+15}).attr("y",function(t,e){return y[e].ty=1==C?24:e<B?12:37}),_.attr("x",function(t,e){return 0==e||e==B?n.h_curx+(U=0):n.h_curx+(U+=G+O[e-1]+15)}).attr("y",function(t,e){return 1==C?12:e<B?0:25}),n.h_curx+=Math.max(v.sum1,v.sum2)-15-10}this.legendManager.animLegendRect(this.def_o.svgLegendH,{width:n.h_curx+20+20+10})}if(t&&t.legStage){var a=n.h_curx+20+20+10,I=this.legendStage,m=(I.canvas.width=a+(2==t.nbLegends?-10:0),I.canvas.height=Math.max(I.canvas.height,60),GCO5.core.GcMathUtil.binToHex(GCO5.core.GcMathUtil.adjustBrightness2(c,10))),T=20,w=40,A=20+T,P=20+(x=10),M=(D=new GCO5.view.display.Shape,"cc"==l?D.graphics.beginStroke(c).setStrokeStyle(.5).drawCircle(A,P,20):"dq"==l?D.graphics.beginFill(c).beginStroke("#fff").setStrokeStyle(.5).drawCircle(A,P,20):"es"==l?D.graphics.beginStroke(c).setStrokeStyle(.5).rect(A-10,P-10,20,20):"sq"==l?D.graphics.beginFill(c).beginStroke("#fff").setStrokeStyle(.5).rect(A-10,P-10,20,20):D.graphics.beginRadialGradientFill(["#fff",F,m,c],[0,.4,.6,1],.8*w,.8*w,.1*w,.8*w,.8*w,1.5*w).drawCircle(A,P,20),I.addChild(D),this.thv.getValueFromRadius(20));if($.isNumeric(M)&&(p="= "+this.gclg.formatNumber(M,i,!0),(E=new GCO5.view.display.Text(p,"normal 0.65em Arial,Helvetica,sans-serif","#000000",!1)).textBaseline="middle",E.x=T+w+5,E.y=x+20,I.addChild(E)),T=E?E.x+E.getMeasuredWidth()+10:120,r){for(var D,E,z=[],C=(h=[this.gclg.getString("POSITIVE","indics"),this.gclg.getString("NEGATIVE","indics")]).length,x=8,G=20,w=0;w<C;w++)(E=new GCO5.view.display.Text(h[w],"normal 0.72em Arial,Helvetica,sans-serif","#000000",!1)).textBaseline="middle",z.push(E),I.addChild(E);for(w=0;w<C;w++)(D=new GCO5.view.display.Shape).graphics.beginFill(o[w]).beginStroke("#bbb").setStrokeStyle(.5).rect(T,x,G,15),I.addChild(D),z[w].x=T+G+5,z[w].y=x+7.5,x+=23}else if(s){for(var j=k||[],C=j.length,x=8,H=t.maxWidth-T,N=0,W=0,w=0;w<C;w++){var L=new GCO5.view.display.Text(j[w],"normal 0.72em Arial,Helvetica,sans-serif","#000000",!1),X=(L.textBaseline="middle",L.getMeasuredWidth()),Y=(0<N&&H<N+20+5+X&&(W=Math.max(W,N),N=0,x+=23),new GCO5.view.display.Shape);Y.graphics.beginFill(o[w]).beginStroke("#bbb").setStrokeStyle(.5),Y.graphics.rect(T+N,x,20,15),L.x=T+N+20+5,L.y=x+7.5,I.addChild(Y),I.addChild(L),N+=25+X+10}I.canvas.width=T+W,I.canvas.height=Math.max(I.canvas.height,x+15+8),n.h_curx=T+=W}I.update()}return n},_createTexts:function(t,e){var i=0,t=t.select(".texts").selectAll(".txtleg").data(e).enter().append("text").attr("class",function(t){return t.halo?"txtleg halo":"txtleg"}).text(function(t){return t.txt}).each(function(t){i=Math.max(i,GCO5.core.GcObjectUtil.getSVGComputedTextLength(this))});return GCO5.core.GcD3Util.addD3Attributes(t,["x","y","text-anchor"]),i},_createCircles:function(t,e,i,n,r){var a,s=this.thv.mapIndicModel,o=s.getMeta("idSymb"),l=GCO5.core.GcDelayUtil.curFrame(),c=s.getRondsStrokeColor();2==e.length&&GCO5.browser.isFirefox&&"sp"==o&&i&&(e=[e[0]].concat(e)),"sp"==o&&i&&t.append("defs").selectAll("radialGradient").data(e).enter().append("radialGradient").attr("gradientUnits","userSpaceOnUse").attr("cx",function(t){return.9*t.r}).attr("cy",function(t){return.9*t.r}).attr("fx",function(t){return.6*t.r}).attr("fy",function(t){return.6*t.r}).attr("r",function(t){return 1.2*t.r}).attr("id",function(t,e){return("gr"+s.getExtendedPk()+Math.round(t.r)+e+l).split(".").join("_").split("|").join("_")}).each(function(t){d3.select(this).append("stop").attr("offset","0.1").style("stop-color","white"),d3.select(this).append("stop").attr("offset","0.901").style("stop-color",t.colf1)}),"sq"==o||"es"==o?(a=Math.sqrt(Math.PI/4),t.select(".shapes").selectAll(".circles").data(e).enter().append("rect").attr("class","circles").attr("x",function(t){return t.cx}).attr("y",function(t){return t.cy}).attr("width",function(t){return 2*a*t.r}).attr("height",function(t){return 2*a*t.r}).attr("fill",function(t){return i?t.colf1:"none"}).attr("stroke",n?"#999":c).attr("stroke-width",i?s.getMeta("epCont"):Math.max(1,s.getMeta("epCont"))).attr("transform",function(t){return"translate("+(t.dcx-a*t.r)+","+(t.dcy-a*t.r)+")"})):(t=t.select(".shapes").selectAll(".circles").data(e).enter().append("circle").attr("class","circles").attr("fill",function(t,e){e=(e="gr"+s.getExtendedPk()+Math.round(t.r)+e+l).split(".").join("_").split("|").join("_");return"sp"==o&&i?"url(#"+e+")":i?t.colf1:"none"}).attr("stroke",n?"#999":c).attr("stroke-width",i?Math.max(.75,s.getMeta("epCont")):Math.max(1,s.getMeta("epCont"))).attr("transform",function(t){return"translate("+t.dcx+","+t.dcy+")"}),GCO5.core.GcD3Util.addD3Attributes(t,["cx","cy","r"]))}}),GCO5.view.component.MaplegendOursins=GCO5.view.component.Maplegend.extend({statics:{NAME:"GCO5.view.component.MaplegendOursins"},updateLegend:function(t,e){if(this._super(t,e),!this.def_o)return{};this.clearLegends([".line",".txtleg"]);for(var i,n,r,e=this.thv.mapIndicModel,a={h_curx:40,v_cury:100,h_boxwidth:(GCO5.browser.width,20),h_boxheight:15,v_boxwidth:20,v_boxheight:15},s=e.getMeta("colf"),o=s[0].hasOwnProperty("col")?s[0].col:s[0],s=e.getProp("refMention",!0,!0),a={v_cury:86,h_curx:46,v_line_a:[],h_line_a:[]},l=[3,13,33,23,58,78,88,70.5,43],c=[-68.3,-73.3,-78.3,-95.8,-83.3,-63.3,-43.3,-51,-48.3],h=[53,53,53,53,53,53,53,53,53],d=[-68.3,-68.3,-68.3,-68.3,-68.3,-68.3,-68.3,-68.3,-68.3],u=0;u<l.length;u++){var p={x1:l[u]/2,y1:c[u]/2+55,x2:h[u]/2,y2:d[u]/2+55,stroke:o};a.v_line_a.push(p),a.h_line_a.push(p)}if(a.v_cury=50,this.def_o.svgLegendV&&(e=this.def_o.svgLegendV.select(".shapes").selectAll(".line").data(a.v_line_a).enter().append("line").attr("class","line").attr("stroke-width",1),GCO5.core.GcD3Util.addD3Attributes(e,["x2","y2","stroke","x1","y1"]),i=[{x:55,y:25,txt:s}],r=this.def_o.svgLegendV.select(".texts").selectAll(".txtleg").data(i).enter().append("text").attr("class","txtleg").text(function(t){return t.txt}),GCO5.core.GcD3Util.addD3Attributes(r,["x","y"]),e=parseFloat($(this.def_o.svgLegendV.node()).css("max-width")),this.animLegendRect(this.def_o.svgLegendV,{width:e,height:a.v_cury+20})),this.def_o.svgLegendH&&(e=this.def_o.svgLegendH.select(".shapes").selectAll(".line").data(a.h_line_a).enter().append("line").attr("class","line").attr("stroke-width",1),GCO5.core.GcD3Util.addD3Attributes(e,["x2","y2","stroke","x1","y1"]),i=[{x:50,y:25,txt:s}],n=0,r=this.def_o.svgLegendH.select(".texts").selectAll(".txtleg").data(i).enter().append("text").attr("class","txtleg").text(function(t){return t.txt}),this.def_o.svgLegendH.selectAll(".txtleg").each(function(t){n=Math.max(n,GCO5.core.GcObjectUtil.getSVGComputedTextLength(this))}),a.h_curx+=n,GCO5.core.GcD3Util.addD3Attributes(r,["x","y"]),this.legendManager.animLegendRect(this.def_o.svgLegendH,{width:a.h_curx+40+10})),t&&t.legStage){var e=this.legendStage,g=new GCO5.view.display.Shape;g.graphics.beginStroke(o).setStrokeStyle(1);for(u=0;u<18;u++)g.graphics.moveTo(45,27).lineTo(45+18*Math.cos(20*u*Math.PI/180),27+18*Math.sin(20*u*Math.PI/180));a.h_curx=80,e.addChild(g),e.update()}return a}}),GCO5.view.component.MaplegendFlux=GCO5.view.component.Maplegend.extend({statics:{NAME:"GCO5.view.component.MaplegendFlux"},gatherFluxLegendInfo:function(t){for(var e=this.thv.mapIndicModel,i=(e.getMeta("nbClasses"),e.getMeta("eps"),e.getMeta("alphas"),e.getMeta("seuils"),e.getProp("firstDistribInfo"),0<(e.getDistribInfo()?e.getDistribInfo().eftallnath:0)),n={h_txt_a:[],v_txt_a:[],h_box_a:[],v_box_a:[],h_curx:0,v_cury:0,h_cursy:13,tl:0,h_boxwidth:GCO5.browser.width<400?35:50,h_boxheight:15,v_boxwidth:40,v_boxheight:20},r=e.getRangesInfo(!0),a=r?r.length:0,s=0,o=0;o<a;o++){var l,c=r[o].colfa;n.h_box_a.push({fill0:c,fill:r[o].visi?c:"#fff",stroke:"#ccc",width:n.h_boxwidth,height:n.h_boxheight,x:o*n.h_boxwidth+(s=i&&o==a-1?5:s),y:n.h_cursy,r:5,cx:o*n.h_boxwidth+s,cy:n.h_cursy}),o<a&&(n.h_curx+=n.h_boxwidth,n.h_txt_a.push({txt:r[o].lib0,x:n.h_curx+s,y:n.h_cursy-5})),n.v_box_a.push({fill0:c,fill:r[o].visi?c:"#fff",stroke:"#ccc",width:n.v_boxwidth,height:+r[o].eps,x:0,y:l=o*n.v_boxheight+(n.v_boxheight-r[o].eps)/2+5*o,r:5,cx:5,cy:o*n.v_boxheight+0+n.v_boxheight/2}),n.v_txt_a.push({txt:r[o].lib,x:n.v_boxwidth+5,y:n.v_boxheight*o+0-2+5*o})}return n.v_cury=l+r[a-1].eps,n},updateLegend:function(t,e){if(this._super(t,e),!this.def_o)return{};var t=this.thv.mapIndicModel,e=t.getProp("nbDec"),i={h_curx:40,v_cury:100,h_boxwidth:(GCO5.browser.width,20),h_boxheight:15,v_boxwidth:20,v_boxheight:15},n=t.getProp("valRef"),r=(GCO5.core.GcStringUtil.isEmpty(n)||(i.ref_txt=t.getProp("refLib"),i.valref_txt=i.ref_txt+this.gclg.getString("P2B")+" "+this.gclg.formatNumber(n,e,!0)),t.indicModel,t.getHighlightedMod(),t.getMeta("classesVisibility"),t.getMeta("col"),t.getMeta("eps"),t.getMeta("alphas")),i=(t.getMeta("colf").map(function(t,e){return GCO5.core.GcMathUtil.hexToRGBAString(t,r[e])}),t.getMeta("classesVisibility"),t.getMeta("seuils"),t.getProp("firstDistribInfo"),this.gatherFluxLegendInfo());return this.clearLegends([".box",".txtleg",".txtleg2",".txtRef",".circles","defs"]),this.def_o.svgLegendV&&(n=this.def_o.svgLegendV.select(".shapes").selectAll(".box").data(i.v_box_a).enter().append("rect").attr("class","box").attr("stroke-width",0).on("click",$.proxy(this._toggleVis,this)),GCO5.core.GcD3Util.addD3Attributes(n,["width","height","fill","stroke","x","y"]),i.valref_txt&&this.def_o.svgLegendV.select(".valref").selectAll(".txtRef").data([[]]).enter().append("text").attr("class","txtRef txtleg").text(i.valref_txt).attr("x",0).attr("y",i.v_cury+=15),this.def_o.svgLegendV.select(".texts").selectAll(".txtleg").data(i.v_txt_a).enter().append("text").attr("class","txtleg").attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).attr("dy","1.4em").text(function(t){return t.txt}).each(function(t){i.tl=Math.max(i.tl,GCO5.core.GcObjectUtil.getSVGComputedTextLength(this))}),this.animLegendRect(this.def_o.svgLegendV,{height:i.v_cury+25+10})),this.def_o.svgLegendH&&(e=this.def_o.svgLegendH.select(".shapes").selectAll(".box").data(i.h_box_a).enter().append("rect").attr("class","box").attr("stroke-width",1).on("click",$.proxy(this._toggleVis,this)),GCO5.core.GcD3Util.addD3Attributes(e,["width","height","fill","stroke","x","y"]),e.append("title").text(function(t,e){return"click to isolate"}),this.def_o.svgLegendH.select(".texts").selectAll(".txtleg").data(i.h_txt_a).enter().append("text").attr("class","txtleg").attr("x",function(t){return t.x}).attr("y",function(t){return t.y}).text(function(t){return t.txt}),this.legendManager.animLegendRect(this.def_o.svgLegendH,{width:i.h_curx+20+20+10})),i},_createTexts:function(t,e){var i=0,t=t.select(".texts").selectAll(".txtleg").data(e).enter().append("text").attr("class","txtleg").text(function(t){return t.txt}).each(function(t){i=Math.max(i,GCO5.core.GcObjectUtil.getSVGComputedTextLength(this))});return GCO5.core.GcD3Util.addD3Attributes(t,["x","y","text-anchor"]),i}}),GCO5.view.component.AThemeView=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.AThemeView",MAX_ANIM_PERIODS:25},ly:null,mapIndicModel:null,indicModel:null,_cv_a:null,_curBmpId:null,_curSerie:null,map:null,legend:null,gclg:null,initialize:function(t,e){this.ly=t,this.map=t.map,this.mapIndicModel=e,this.indicModel=e.indicModel,this._cv_a=[],this.gclg=GCO5.core.GcLangManager.getInstance()},onChangeSelection:function(t){},getLayerName:function(){return this.ly.layerName},drawSel:function(t){},hasIndicAssoc:function(){return this.indicModel.getAssocModel()},linkAssocModel:function(t){},getStatData:function(){return this.mapIndicModel.getStatData()},getModel:function(){return this.mapIndicModel},getIndicModel:function(){return this.mapIndicModel.getIndicModel()},isEnabled:function(){return!!this.mapIndicModel.styles.enabled},_updateCanvasStructure:function(t){var e=this._cv_a.length;if(e<t)for(var i=e;i<t;i++){var n=document.createElement("canvas");this._cv_a.push(n)}this._resizeCanvases(this.ly.map.getWidth(),this.ly.map.getHeight())},_resizeCanvases:function(t,e){for(var i in this._cv_a){i=this._cv_a[i];i.width=+t||i.width,e&&(i.height=+e)}},_afterSerieBitmapsBuilt:function(t,e){$(this.ly.map).triggerHandler(GCO5.view.component.MapViewThematic.ANIM_BMP_READY,{thv:this,mapIndicModel:this.mapIndicModel})},playAnim:function(t){},clearAnimCanvases:function(){this._cv_a.map(function(t){GCO5.core.GcBitmapUtil.dropCanvas(t)}),this._cv_a=[],this._curBmpId=null},onCloseTimeAnim:function(){this.clearAnimCanvases(),this.ly.map._thmAnimating=!1},_endTransition:function(){var t=this.ly.map,e=t.getCanvas("maptransition"),i=t.getCanvas("maptransition1");GCO5.core.GcBitmapUtil.clearCanvas(e),GCO5.core.GcBitmapUtil.clearCanvas(i),$(e).removeClass("cfade cfade0"),$(i).removeClass("cfade cfade0"),$(e).css("opacity",1),$(i).css("opacity",0),$(e).css("display","none"),$(i).css("display","none"),t._thmAnimating=!1,$(i).off("webkitTransitionEnd transitionend",this._crossFadeAnimTheme),$(t).triggerHandler(GCO5.view.component.MapView.END_ANIM,{mapIndicModel:this.mapIndicModel})},_crossFadeAnimTheme:function(t){},updateLegend:function(t,e){return this.legend?this.legend.updateLegend(t,e):0},updateLegendValref:function(){return this.legend?this.legend.updateLegendValref():0},updateLegendEfts:function(){return this.legend?this.legend.updateLegendEfts():0},getLegendCanvas:function(){return this.legend?this.legend.getCanvas():0},getRovShape:function(t,e,i){return null},highlight:function(t,e,i,n){return null},destroy:function(){}}),GCO5.view.component.MapToolTip=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.MapToolTip",sort_o:{zon:0,stat:2,symb:1}},map:null,container:null,lastFrame:null,lastHtml:null,lastPageX:null,gclg:null,initialize:function(t){this.map=t.map,t.container.hasClass("maptooltip")||(0==$(">.maptooltip",t.container).length&&t.container.append("<div class='maptooltip'></div>"),t.container=$(">.maptooltip",t.container)),this.container=t.container,this.gclg=GCO5.core.GcLangManager.getInstance()},update:function(t,e){if(e!=this.lastFrame){var i=this.container,n=this.map.getMapYPosition(),t=this.map.getRovData(t),t=this._getRovInfo(t),r=(t&&t.pageX&&(this.lastPageX=t.pageX),this.lastHtml=t.html),a=1;if(""!=r){i.html(r);var r=i.outerWidth(),s=i.outerHeight();if(i.removeClass(),i.removeAttr("style"),i.addClass("maptooltip"),t.r){if(!new GCO5.model.geom.Rectangle(t.r.x,t.r.y,t.r.w,t.r.h).intersects(this.map.getLocalBBox()))return void i.hide();var o,n=n>>0,l=t.r.y+n-s-15,c=t.pageX||this.lastPageX;(c-=r/2)<5?(c=5,a=0):0<(o=c+r-GCO5.browser.width)&&(c-=o+5,a=0),t.r.y-s<0&&(l=n+t.r.y+t.r.h+10,a=0),l-n+t.r.h>this.map.getHeight()&&(a=1,(l=t.pageY-s-20)-n<0&&(l=t.pageY+25,a=0))}else t.pageX&&(c=t.pageX+20,l=t.pageY-35,0<(o=c+r-GCO5.browser.width)&&(c-=o+5,a=0,l-s<5?l+=s:l-=s));i.css({top:l,left:c,"z-index":"100"}),i.show(),t.r||t.pageX||i.hide()}else i.hide();a&&t.r&&i.addClass("arrowbottom"),s<30&&0<i.find(".ttpt1").length&&i.css("background-color","#555"),this.lastFrame=e}},_getRovInfo:function(t){var e,i,n={};for(i in t){var r=t[i];r.ordre=this.constructor.sort_o[r.typeLy],"stat"==r.typeLy?n.r=r.rect:e=!0,n.pageX=r.pageX,n.pageY=r.pageY}return e&&delete n.r,GCO5.core.GcArrayUtil.sortOn(t,["ordre"],[GCO5.core.GcArrayUtil.NUMERIC]),n.html=this._getRovHtml(t),n},_getRovHtmlZonages:function(t){for(var e,i=this.gclg,n="",r="",a="",s=0;s<t.length;s++){var o,l,c,h=t[s];"stat"==h.typeLy?(c=h.codgeo===h.libgeo?h.codgeo:h.codgeo+" - "+h.libgeo,h.codgeo&&(n=GCO5.core.GcStringUtil.proper(h.lyLib)+i.getString("P2")+" "+c),h.thmData&&1==h.thmData.length&&(o=e=h.thmData[0].value)&&"Z"==h.thmData[0].typInd&&(r=GCO5.core.GcStringUtil.proper(h.thmData[0].libInd)+i.getString("P2")+" "+o)):"zon"==h.typeLy&&(l=h.codgeo?h.codgeo===h.libgeo?h.codgeo:h.codgeo+" - "+h.libgeo:h.libgeo,a=c=GCO5.core.GcStringUtil.proper(h.lyLib)+i.getString("P2")+" "+l)}return""==r?""==n?"":"<p class='ttpt1'>"+n+"</p>":"<p class='ttpt1'>"+r+"</p>"+(""==a||e==l?"":"<p class='ttpt1'>"+a+"</p>")+"<p class='ttptv1'>"+n+"</p>"},_getRovHtml:function(t){var e=[],i=this.gclg;0<=["de","en"].indexOf(i.getLang())?i.getString("VALUE"):i.getString("VALUE").toLowerCase(),GCO5.model.indics.MapIndicModel;if(this.map.styles.zonagesOnly)return this._getRovHtmlZonages(t);for(var n="1"==GCO5.appModel.getOption("noStatLayerLibInTooltip"),r=0;r<t.length;r++){var a,s,o=t[r];if("symb"==o.typeLy){if(!GCO5.browser.isTouch&&o.thmData){e.push("<p class='ttpt1'>"+o.lyLib+(void 0!==o.codgeo?i.getString("P2")+" "+o.codgeo+" - "+o.libgeo:"")+"</p>");for(var l=0;l<o.thmData.length;l++)e.push("<p class='ttpv2'><span class='figure-with-border'>1</span><span class='plvs'>"+o.thmData[l].value+"</p>")}}else if("stat"==o.typeLy){if(s=o.codgeo!==o.libgeo&&o.libgeo?o.codgeo+" - "+o.libgeo:o.codgeo,o.codgeo&&(n?e.push("<p class='ttpt1'>"+s+"</p>"):e.push("<p class='ttpt1'>"+o.lyLib+i.getString("P2")+" "+s+"</p>")),(!GCO5.browser.isTouch||200<GCO5.browser.width)&&o.thmData)for(var c=o.thmData.length,h=o.nbActiveThemes-c,l=0;l<c;l++){var d=o.thmData[l].value,u=o.thmData[l].ci;d&&(u&&d.indexOf("N/A")<0&&(d+=" ("+i.getString("CI")+" = ["+u+"])"),"Z"==o.thmData[l].typInd?e.push("<p class='ttpv1'>"+o.thmData[l].libInd+i.getString("P2")+" "+d+"</p>"):e.push("<p class='ttpv1'><span class='figure-with-border'>"+(l+1+h)+"</span><span class='plvs'>"+d+"</span></p>"))}}else"zon"==o.typeLy&&(a=o.codgeo?o.codgeo===o.libgeo?o.codgeo:o.codgeo+" - "+o.libgeo:o.libgeo,s=o.lyLib+i.getString("P2")+" "+a,e.push("<p class='ttpz1'>"+s+"</p>"))}var p=e.slice(1);return a&&0<=p.join("").indexOf(a)&&e.shift(),e.join("")},clear:function(){var t=this.container;t.css({top:0,left:0}),t.hide(),this.lastHtml=null},hide:function(){this.container.hide()},affCircTtp:function(t,e,i){var n=this.container,r=GCO5.core.GcLangManager.getInstance(),a=this.map.getMapYPosition(),s=this.map.getMapXPosition(),o=1/this.map.getPxMt();null==i&&(""!=(l=this.lastHtml)&&(l+="<br>"),n.html(l+r.getString("CIRC_SEL_HINT2","selection")));var l=t+s-n.outerWidth()/2,t=e+a-n.outerHeight()-10,s=(n.removeAttr("style"),n.addClass("red"),2e3<o*i?1:10);null!=i?(e=r.formatNumber(Math.round(o*i*s/1e3)/s,1==s?0:1)+" "+r.getString("KM","units"),n.html(e)):t-=30+a,n.css({top:t,left:l,"z-index":"100"}),i>(GCO5.browser.isTouch?10:3)?n.show():n.hide(),n.blur()}}),GCO5.view.component.MapSelections=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.MapSelections"},map:null,infosel_o:null,selgeo:null,sel_o:null,metasel_o:null,adding_o:null,gclg:null,_formattedSelData:null,initialize:function(t,e){this.map=t,this.sel_o={},this.metasel_o={},this.adding_o={},this.gclg=GCO5.core.GcLangManager.getInstance()},getInfoSel:function(){return this.infosel_o},drawSelgeo:function(t,e,i){void 0===i&&(i=20);var n,r,a=this.getSelgeo(t);a?(n=this.getSelIds(t))&&0<n.length&&(r=this,GCO5.core.GcDelayUtil.callLater(function(){r.drawSelIds(t,n,e,!1,{libsel:a.libgeo})},[],i,this)):this.clearSel(t)},getLastSelAddedInfo:function(t){return t?"stat"==t&&(t=this.map.getStatLayerName()):t=this.map.hasSymbSelgeo()?this.map.getSymbThemeLayer().getName():this.map.getStatLayerName(),this.adding_o[t]},drawSelIds:function(t,e,i,n,r){if(!1!==this.map.getStyle("selectable")){t&&"stat"!=t||(t=this.map.getStatLayerName()),e=e||[];var a,s,o=n&&e&&1==e.length?e[0]:null,l=r?r.libsel:"",c=t==this.map.getStatLayerName()?this.map.nivgeo:t.substr(0,t.length-2),n=(!0===n&&(1==(s=(s=this.getSelIds(t))||[]).length?(h=s[0],-1==(u=e.indexOf(h))?(e.push(h),d=!0):(d=!1,e.splice(u,1))):e=1==e.length?(h=e[0],d=0<=(u=s.indexOf(h))?(s.splice(u,1),!1):(s.push(h),s.sort(function(t,e){return t-e}),!0),s):(a=r&&r.hasOwnProperty("centerFid")?r.centerFid:null,1==(n=e.filter(function(t){return s.indexOf(t)<0})).length&&n[0]===a?s.filter(function(t){return e.indexOf(t)<0||t===a}):(null!==a&&n.indexOf(a)<0&&n.push(a),n.concat(s))),e=GCO5.core.GcArrayUtil.getDistinctValues(e)),this.adding_o[t]=null!==o?{fid:o,adding:d}:null,e.sort(function(t,e){return t-e}),1==e.length?(l=this.map._getLibgeo(e[0],t),(r=r||{})&&(r.libsel=l)):1<e.length&&GCO5.core.GcStringUtil.isEmpty(l)&&(l=this.gclg.formatNumber(e.length)+" "+GCO5.appModel.getInfo("libNivgeo",[c,["de","en"].indexOf(this.gclg.getLang())<0,!0])),this.metasel_o[t]=r,this._updateWithSelIdsOrCodgeo(e,t,l),this._getOtherLySel(t));if(!r||!r.silent){if(i)return this.map.zoomOnFeatureId(t,e),void(this.map._zoomingOnSelection=!1);0!=e.length&&!n||("_P"==t.substr(-2,2)&&this.map.getLayerByName(t).drawPointSel([]),this.map.clearSelCanvas()),0<e.length&&("_P"==t.substr(-2,2)?(this.map.getSelCanvas(!0),this.map.getLayerByName(t).drawPointSel(e)):this.map.getLayerByName(t).drawPolySel(e,this.getSelgeo(t),r)),GCO5.core.GcDelayUtil.callLater(this.map._buildCapture,[],GCO5.browser.isAndroid?20:5,this.map),this.map.setSelCanvasVisibility(0<e.length)}if(0<e.length){if(1==e.length){var o=this.map.getLayerByName(t),h=e[0];if(!o)return void this.onLoadInfosel();var d=o.topoModel,c=d.getPrecisionFactor(),l=d.getCtrX(),i=d.getCtrY(),o=c*l[h],d=c*i[h],l=this.map.getMatrix().transformPoint(o,d),c=(this.map.getStyle("hidden-pilotage")||this.map.styles.inReport||GCO5.core.SystemManager.getInstance().isMouseDown()||this.map.onVMouseMove({pageX:l.x+this.map.getMapXPosition(),pageY:l.y+this.map.getMapYPosition(),refresh:!0}),this.map.getRovData(this.map._rovobj_o)),u=GCO5.core.GcArrayUtil.indexOfByKey(c,"typeLy","zon"),i=GCO5.core.GcArrayUtil.indexOfByKey(c,"typeLy","stat");0<=u?0<=(i=GCO5.core.GcArrayUtil.indexOfByKey(c,"typeLy","stat"))&&c[i].fid==e[0]&&(this.zonSelInfo=c[u]):0<=i&&(this.zonSelInfo=null)}else this.zonSelInfo=null;n&&this._clearLocalSelInfo(n),r&&r.noCallInfosel||this.map.getStyle("noCallInfosel")?this.onLoadInfosel():this.testCallInfosel(t)}else this._clearLocalSelInfo()}},testCallInfosel:function(t,e){var i,n;t=t||this.map.getStatLayerName(),this.hasSelgeo(t)&&(n=this.map.getCurTheme(),n=(i=this.map.getLayerByName(t)).getCurTheme(),e||n&&i.hasTheme(n)&&"F"!=n.mapIndicModel.getProp("type")||GCO5.appModel.getOption("defaultSpineChart")?this.infosel(t,e):this.onLoadInfosel())},onLoadInfosel:function(t){if(t){var e=GCO5.core.GcArrayUtil.indexOfByKey(t.territories,"type","SELGEO"),i=this;if(0<=e){if(this.lastIdSelgeo&&t.territories[e].id==this.lastIdSelgeo){var n,r,a,s,o,l=GCO5.appModel.getInitKey("dataset_o");for(u in t.data)l[u]&&(n=this.infosel_o.data[u],r=t.data[u],s=a=null,n?Array.isArray(r)&&(a||(a={},s||(s=["territory"],l[u].varserie&&s.push(l[u].varserie),l[u].filter1&&s.push(l[u].filter1)),n.forEach(function(t,e){for(var i in o="",s)o+=t[s[i]];a[o]=e+1})),r.forEach(function(t){for(var e in o="",s)o+=t[s[e]];a[o]?GCO5.core.GcObjectUtil.extend(n[a[o]-1],t):n.push(t)})):this.infosel_o.data[u]=r);t.indicateurs.forEach(function(e){0==i.infosel_o.indicateurs.filter(function(t){return JSON.stringify(t)===JSON.stringify(e)}).length&&i.infosel_o.indicateurs.push(e)})}else this.infosel_o=t;this.lastIdSelgeo=t.territories[e].id}}this._registerCurSelGeo();var c=this.map.getEnabledIndicsModelsIndexed(),h=this.map.getIndicsModelsIndexed(),d=this.map.hasSymbSelgeo()?this.map.getSymbThemeLayer().getName():this.map.getStatLayerName(),e=t&&t.params?t.params.def_o.mim:null;if(e)e.setSelectionInfo(t);else for(var u in h)t&&1==this.getNbSelObjs(h[u].getLayerName())&&(t.txtTabVars=this.getFormattedTabVarsInfo(h[u].getLayerName())),this.getSelgeo()&&!t||h[u].setSelectionInfo(this.getSelgeo()&&c[u]?t:null,null,this.getNbSelObjs(d));this._prepareSelInfo(),this.map.onBuildInfosel(t),$(this.map).triggerHandler(GCO5.view.component.MapView.ONBUILD_INFOSEL,t)},getSelDescriptions:function(){return this._formattedSelData},_prepareSelInfo:function(){this._formattedSelData={};var t,e=this.map.getSelectableLayers();for(t in e){var i=e[t].getName(),n=this.map.getLibView(),r=this.map.getStatLayerNbObjsFormatted();if(i!=this.map.getStatLayerName()){var a=GCO5.appModel.getConcept("nivgeo_o")[i.substr(0,i.length-2)];if(!a)return;n=a.c_lib_nivgeop}var a=this.getLibSel(i),s=this.getNbSelObjs(i),o="",l=(0<s?o="<b>"+a+"</b>":0==s&&(o=n+"<br>"+r),o.split("<br>")),c=l.length,c=(a!=this.map.getLibSel(i,!0)&&c<3&&(l.splice(1,0,this.map.getLibSel(i,!0)),o=l.join("<br>")),"");1==s&&(c=this.getFormattedTabVarsInfo(i)),this._formattedSelData[i]={txt1:o,txtTabVars:c,nbObjs:s,libView:n,libView2:r,zonSelInfo:this.zonSelInfo,lyName:i,libSel:this.getLibSel(i),libSel2:this.map.getLibSel(i,!0),libSel3:this.map.getLibSel(i,!0,!0)}}return this._formattedSelData},getNbSelObjs:function(t){t=this.getSelIds(t);return t?t.length:0},getLibSel:function(t,e,i){t=t||(this.map.hasSymbSelgeo()?this.map.getSymbThemeLayer().getName():this.map.getStatLayerName());var n=this.getSelIds(t),r=GCO5.core.GcLangManager.getInstance(),a=r.getLang(),n=n?n.length:0,r=r.formatNumber(n),s=GCO5.appModel.getInfo("nivgeoFromLayerName",[t,!1,this.map.getName()]),o=1==n?this.getSelgeo(t).codgeo:null,s=GCO5.appModel.getInfo("libNivgeo",[s,["de","en"].indexOf(a)<0&&1<n,1<n]),a=this.map.getMetaSel(t),t=a&&a.libsel&&!e?a.libsel:(1<n?r+" ":"")+s;return i&&o&&(t+=" : "+o),t},infosel:function(t,e){var i,n,r,a=[],s=this.map.getEnabledIndicsModelsIndexed();for(n in e&&((s={})[e.getPkF1()]=e),s)s[n].getIndicModel().onImportedData()||s[n].getIndicModel().isTJS()||"F"!=s[n].getProp("type")&&(a.push(i=s[n].getIndicModel()),i.getProp("varSerie"));0==a.length&&!GCO5.appModel.getOption("defaultSpineChart")||(r=(t=this.getSelgeo(t)).getPkGeo()+a.map(function(t){return t.getPkF1()}).concat("|"))==this.infoselHash?this.onLoadInfosel():(this.infoselHash=r,r={dest:"map",typsel:"STD",id_view:this.map.getIdView(),id_extent:t.getIdExtent(),id_nivgeo:t.nivgeo,mim:e,selgeo:t,subnivgeos:this._getSubNivgeos(this.map.getIdNivgeo()),indicModels:a},$(this.map).triggerHandler(GCO5.view.component.MapView.INFOSEL,r))},getFormattedTabVarsInfo:function(t){var e=this.getSelIds(t);if(!e)return"";var i=[],e=e[0],t=this.map.getLayerByName(t);if(!t)return null;for(var n=t.getTabVarsById(e),r=0;r<n.length;r++){var a=n[r].val;GCO5.core.GcStringUtil.isEmpty(a)||(1==n[r].url?0<=a.toLowerCase().indexOf(".jpg")||0<=a.toLowerCase().indexOf(".png")?i.push("<img style='max-width:95%' class='mbs' src='"+n[r].val+"'>"):i.push("<a href='"+n[r].val+"' target='_blank'>"+n[r].lib+"</a>"):i.push(n[r].lib+this.gclg.getString("P2B")+" "+n[r].val))}return i.join("<br>")},_getSubNivgeos:function(t){var e=this.map._getIndicInfo(),e=e?e.getProp("surNivgeos")||e.getProp("nivgeos"):null,e=GCO5.core.GcArrayUtil.getColumnByKey(GCO5.appModel.getInfo("subNivgeos",[t,e]),"nivgeo");return 0==e.length?t:e.join("|")},_registerCurSelGeo:function(){GCO5.model.maps.SelGeo.registerCurSelGeo(this.getSelgeo())},setSelgeo:function(t,e){!e&&(e="PT"==t.getTopology()?t.getNivgeo()+"_P":this.map.getStatLayerName(),t&&"PG"==t.getTopology()&&!t.isCompatibleWithMapView(this.map.getName()))||(t?this.sel_o[e]=t:delete this.sel_o[e])},getSelgeo:function(t){if("*"==t)return this.sel_o;if(!(t="stat"==t?this.map.getStatLayerName():t)){if(this.map.hasSymbSelgeo())return this.getSelgeo(this.map.getSymbThemeLayer().getName());t=this.map.getStatLayerName()}return!!this.sel_o.hasOwnProperty(t)&&this.sel_o[t]},getSelgeoCenterWorld:function(t,e){var i;t?(i=this.map.getLyStatName(),"PT"==GCO5.appModel.getInfo("NivgeoTopology",[t.nivgeo])&&(i=t.nivgeo+"_P")):(i=this.map.hasSymbSelgeo()?this.map.getSymbThemeLayer().getName():this.map.getStatLayerName(),t=this.getSelgeo(i)),void 0===e&&(e=t.getSelIds()[0]);var t=this.map.getLayerByName(i).topoModel,n=t.getPrecisionFactor(),r=t.getCtrX(),t=t.getCtrY(),r=this.map.getMatrix().transformPoint(r[e]*n,t[e]*n);return{p0W:this.map.getStoWMatrix().transformPoint(r.x,r.y),p0S:r,lyName:i}},getSelIds:function(t){t=this.getSelgeo(t);return t?t.getSelIds(t.nivgeo,t.id_extent):null},getSelExtent:function(t){t=t||this.map.getStatLayer();var e=this.getSelIds(t.layerName);if(!e)return null;t=this.map._getSelIdsExtentPx(t,e);return this.map._getExtentFromRect0(t.minxr,t.minyr,t.maxxr,t.maxyr)},hasSelgeo:function(t){if("*"!=t)return"stat"==t&&(t=this.map.getStatLayerName()),(i=this.getSelgeo(t))&&i.isNotEmptyFor(i.nivgeo,this.map.getIdExtent());var e,i,n=this.map.getSelectableLayers();for(e in n)if((i=this.getSelgeo(n[e].getName()))&&i.isNotEmptyFor(i.nivgeo,this.map.getIdExtent()))return!0;return!1},hasSingleSelgeo:function(t){return this.hasSelgeo()&&this.getSelgeo().getSingleCodgeo()},hasMultSelgeo:function(t){return this.hasSelgeo()&&!this.getSelgeo().getSingleCodgeo()},getMetaSel:function(t){return t=t||this.map.getStatLayerName(),this.metasel_o[t]},clearSel:function(t){if("*"==t){var e,i=this.map.getSelectableLayers();for(e in i)this.drawSelIds(i[e].getName(),[])}else this.drawSelIds(t,[]);this.lastIdSelgeo=null},_getOtherLySel:function(t){for(var e in this.sel_o)if(e&&e!=t)return e;return null},_clearLocalSelInfo:function(t){t=t||this.map.getStatLayerName(),delete this.sel_o[t],this.metasel_o[t]=null,this.infosel_o=null,this.zonSelInfo=null,this._registerCurSelGeo(),this.onLoadInfosel({from:"delsel"})},_updateWithSelIdsOrCodgeo:function(t,e,i,n){var r=this.getSelgeo(e),a=this.map.getIdExtent(),s=e&&"_P"==e.substr(-2,2)?e.substr(0,e.length-2):this.map.getIdNivgeo();r?this.sel_o[e]=r.updateSelIds(s,a,t,i,n):(t&&0<t.length||n)&&(this.sel_o[e]=new GCO5.model.maps.SelGeo({nivgeo:s,id_extent:a,selIds:t,libgeo:i,codgeo:n}))}}),GCO5.view.component.LayerView=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.LayerView",LOADLY:"loadly",SELCOLOR1:"rgba(150, 150, 150, 0.1)",SELCOLOR2:"rgba(150, 150, 150, 0.3)",BACKGROUND_STAT:"#f0f0f0",AGREG_THRESHOLD:5e4,MIN_LEN_PX:.3},layerName:null,styles:null,map:null,isStat:0,topoModel:null,hashSel:null,mainPalette:null,_cv_a:null,_theme_a:null,_outputCanvas:null,disabled:null,_completed:!1,_lyBackground:null,_cvOrigin_px:null,_rovFid:null,_rovFluxFid:null,_debug_a:null,_lastMapExtentPx:null,_bufferCanvas:null,_lastRovRect:null,_etiqStage:null,initialize:function(t){this.layerName=t.name,this.map=t.map,this.styles=t.styles,this.isStat=t.stat,this._lyBackground=t.lyBackground,this._cvOrigin_px={x:0,y:0},this._theme_a=[],this._cv_a=[],this._debug_a=[],this._outputCanvas=t.cv,this.topoModel=t.tm||GCO5.appModel.getInfo("topoModel",[this.layerName,t])},checkCompatibilityWithRefgeo:function(t,e){this.getNbObjs()!=t&&console.error("erreur : le nombre d'objets du fond de carte est différent de celui du référentiel "+this.getNbObjs()+" "+t,this)},getName:function(){return this.layerName},getTopoModel:function(){return this.topoModel},_updateLayerCanvas:function(t){for(var e,i,n=this,r=this._cv_a.length,a=this._outputCanvas.getContext("2d"),s=this.getChoroTheme(),o=s&&!s.hasIndicAssoc(),l=0;l<r;l++){var c=this._cv_a[l].cv;c.width*c.height==1||!o&&this.isStat&&"categ"==this._cv_a[l].type||a.drawImage(c,0,0)}GCO5.core.GcDelayUtil.callLater(function(){n._cv_a.forEach(function(t){"categ"!=t.type&&"mesh"!=t.type||(t.cv.width=t.cv.height=1)})},[],5,this),this.isStat&&this._bufferCanvas.width*this._bufferCanvas.height!=1&&this._lastMapExtentPx&&(s=this.map._bmpMap.x<0?0:this.map._bmpMap.x,e=this.map._bmpMap.y<0?0:this.map._bmpMap.y,i=this.map.getResolutionRatio(),a.drawImage(this._bufferCanvas,i*s,i*e),this._bufferCanvas.width=this._bufferCanvas.height=1),o&&GCO5.core.ColorThief?this.mainPalette=GCO5.core.ColorThief.getIndexedColors(this._outputCanvas,5):this.mainPalette=null},getAllThemesDataById:function(t,e,i){for(var n,r=[],a=0,s=-1,o=-1,l=0;l<this._theme_a.length;l++){var c=this._theme_a[l].thv;c.isEtiq||(c=c.getModel()).isEnabled()&&c.valuesDisplayable()&&("Choro"==(n=c.getSuperCategory())&&(s=a),"Symb"==n&&(o=a),r.push({idIndic:c.getPk(),typInd:c.getProp("type"),libInd:c.getProp("shortLibIndic"),cat:c.getCategory(),unit:c.getProp("unit"),ci:c.getDataICById(c.isFlux()?e:t),value:c.getFormattedDataById(c.isFlux()?e:t,void 0,void 0,i)}),a++)}return s<o&&r.reverse(),r},addTheme:function(t){if(!this.hasMapIndicModel(t)){var e,i=t.getCategory(),n=GCO5.model.indics.MapIndicModel;switch(i){case n.ETIQ:e=new GCO5.view.component.EtiqThemeView(this,t);break;case n.CHORO_NUM:case n.CHORO_VI:e=new GCO5.view.component.ChoroThemeView(this,t);break;case n.SYMB_GRAD:e=new GCO5.view.component.SymbGradThemeView(this,t);break;case n.SYMB_PTCHORO:case n.SYMB_PTVI:e=new GCO5.view.component.SymbPointThemeView(this,t);break;case n.SYMB_FLUX:e=new GCO5.view.component.SymbFluxThemeView(this,t);break;case n.SYMB_OURSINS:e=new GCO5.view.component.SymbOursinThemeView(this,t);break;case n.SYMB_LNVI:e=new GCO5.view.component.SymbLineThemeView(this,t)}return this._theme_a.push({thv:e,cat:i,mapIndicModel:t}),e}},getThemeByModel:function(t){t=GCO5.core.GcArrayUtil.getSubArray(this._theme_a,{mapIndicModel:[t]});return 0<t.length?t[0].thv:null},removeThemeByModel:function(t){t=this.getThemeByModel(t);t&&this.removeTheme(t)},getMapIndicModelsIndexed:function(){var t,e=GCO5.core.GcArrayUtil.getColumnByKey(this._theme_a,"mapIndicModel"),i={};for(t in e)e[t].cat!=GCO5.model.indics.MapIndicModel.ETIQ&&(i[e[t].getPkF1()]=e[t]);return i},getNbActiveThemes:function(){var e=0;return this._theme_a.forEach(function(t){t.cat!==GCO5.model.indics.MapIndicModel.ETIQ&&t.mapIndicModel.isEnabled()&&e++}),e},removeTheme:function(t){return 0!=this._theme_a.length&&(!!GCO5.core.GcArrayUtil.deleteItemByKey(this._theme_a,"thv",t)&&(!!t&&(t.destroy(),!(t=null))))},removeAllThemes:function(){if(this._theme_a){var t,e=this._theme_a.length;for(t in this._theme_a){var i=this._theme_a[t].thv;i&&(i.destroy(),i=null)}return this._theme_a=[],e}},_addListeners:function(){this._completed},restoreFromBmp0:function(){this.map.getCanvas("mapstat");this._bufferCanvas.width=1,this._bufferCanvas.height=1,this._lastMapExtentPx=null,this._lastMapExtentPx=this._getCurMapExtentPx()},onRemovedFromStage:function(){this._bufferCanvas&&(this._bufferCanvas.width=1,this._bufferCanvas.height=1,this._lastMapExtentPx=null),this._cv_a.forEach(function(t){t.cv.width=t.cv.heigth=1,t.cv=null}),this._cv_a=[]},_getCurMapExtentPx:function(){var t=this.map.getMatrix().clone().invert(),e=t.transformPoint(0,0),t=t.transformPoint(this.map.getWidth(),this.map.getHeight()),i=e.x,n=e.y,r=t.x-e.x,t=t.y-e.y;return new GCO5.model.geom.Rectangle(i,n,r,t)},getLibgeoById:function(t){return this.topoModel.getLibgeoById(t)},getCodgeoById:function(t){return this.topoModel.getCodgeoById(t)},getTabVarsById:function(t){return this.topoModel.getTabVarsById(t)},getBmpFilledAreaPct:function(){return this.topoModel.getParam("ly_area_pct")},getCanvasTopLeft:function(){return this._cvOrigin_px},getTopology:function(){return this.styles.topo||this.topoModel.getTopology()},isPolygon:function(){return"DR"==this.getTopology()},setVisible:function(t){t?this._show():this._hide()},getEtiqTheme:function(){return this._getThemeByCat(GCO5.model.indics.MapIndicModel.ETIQ)},_show:function(t){this.styles.disabled=!1;var e=this._getThemeByCat(GCO5.model.indics.MapIndicModel.ETIQ);e&&this.isDisplayable()&&e.draw()},_hide:function(t){this.styles.disabled=!0;var e=this._getThemeByCat(GCO5.model.indics.MapIndicModel.ETIQ);e&&e.clear()},isVisible:function(){return!this.styles.disabled},isDisplayable:function(){var t=!0;if("P"==this.getTopology()){var e=this._getThemesByCat([GCO5.model.indics.MapIndicModel.SYMB_PTVI,GCO5.model.indics.MapIndicModel.SYMB_PTCHORO],!0),i=this._getThemesByCat(GCO5.model.indics.MapIndicModel.SYMB_GRAD,!0),n=0;if(e&&e.forEach(function(t){n+=+t.isEnabled()}),i&&i.forEach(function(t){n+=+t.isEnabled()}),this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_OURSINS))return!0;if(0==n&&(e||i))return!1}var r,e=this.map.getScaleRatio(),i=(GCO5.browser.width+GCO5.browser.height)/2500;return i<1&&(e*=i),this.styles&&(i=this.styles.zoomMinPct,r=this.styles.zoomMaxPct,!isNaN(i)&&e<=i&&(t=!1),!isNaN(r)&&0<r&&r<e&&(t=!1)),t&&!this.styles.disabled},getNbObjs:function(){return this.topoModel.getNbObjs()},getMeanPointsByObj:function(){return this.topoModel.getMeanPointsByObj()},destroy:function(){this.removeAllThemes(),this._cv_a.push({cv:this._outputCanvas}),this.onRemovedFromStage(),this._cv_a=[],this._theme_a=[]},hasMapIndicModel:function(t){for(var e in this._theme_a)if(this._theme_a[e].mapIndicModel===t)return!0;return!1},hasTheme:function(t){for(var e in this._theme_a)if(this._theme_a[e].thv===t)return!0;return!1},getChoroTheme:function(){return this._getThemeByCat(GCO5.model.indics.MapIndicModel.CHORO_NUM)||this._getThemeByCat(GCO5.model.indics.MapIndicModel.CHORO_VI)},getSymbTheme:function(){return this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_OURSINS)||this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_FLUX)||this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_GRAD)||this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_PTVI)||this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_PTCHORO)},getFluxTheme:function(){return this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_FLUX)},getCurTheme:function(){return this.getSymbTheme()||this.getChoroTheme()},hasOnlyEtiqTheme:function(){var t=!1;return t=1==this._theme_a.length&&this._getThemeByCat(GCO5.model.indics.MapIndicModel.ETIQ)?!0:t},_getThemeByCat:function(t,e){t=this._getThemesByCat(t,e);return t?t[0]:null},_getThemesByCat:function(t,e){Array.isArray(t)||(t=[t]);var i,n=[];for(i in this._theme_a)0<=t.indexOf(this._theme_a[i].cat)&&(e||this._theme_a[i].mapIndicModel.isEnabled())&&n.push(this._theme_a[i].thv);return 0<n.length?n:null},onChangeSelection:function(t,e){for(var i in this._theme_a)this._theme_a[i].cat!=GCO5.model.indics.MapIndicModel.ETIQ&&(e||this._theme_a[i].mapIndicModel.isEnabled())&&this._theme_a[i].thv.onChangeSelection(t)},captureBitmap:function(t){var e,i,n,r,a,s,o;this.styles.disabled||(e=!this._completed,o=(s=this.map.getMatrix().clone().invert()).transformPoint(0,0),s=s.transformPoint(this.map.getWidth(),this.map.getHeight()),n=o.x,r=o.y,a=s.x-o.x,s=s.y-o.y,o=new GCO5.model.geom.Rectangle(n,r,a,s),this._lastMapExtentPx&&(i=o.intersection(this._lastMapExtentPx)),this.getCanvasTopLeft(),n=this.map.getResolutionRatio(),this.isStat&&!e&&this.map.hasTranslated()&&i&&(r=n*Math.max(-this.map._bmpMap.x,0),a=n*Math.max(-this.map._bmpMap.y,0),s=this.map.getWidth()-n*Math.abs(this.map._bmpMap.x),o=this.map.getHeight()-n*Math.abs(this.map._bmpMap.y),this._bufferCanvas.width=s,this._bufferCanvas.height=o,this._bufferCanvas.getContext("2d").drawImage(this.map.getCanvas("mapstat"),r,a,s,o,0,0,s,o)))},_meshToDraw:function(t){var e=this.getTopology();if("L"==e||this.styles.zon)return!0;if("P"==e)return!1;if("none"==this.styles.strokeStyle)return!1;var e=this.topoModel.getFeatureArcs(),e=e?e.length:0,i=this.map.getScaleRatio();if(t){t=t.mapIndicModel.getMeta("contVis");if("yes"==t)return!0;if("no"==t)return!1}t=this.topoModel.isCarro();return e<(this.getCurTheme()?2e3:5e4)&&400<GCO5.browser.width||800/GCO5.browser.width*e/(i*i)<1e3&&!t},draw:function(t,e){var i;this.styles.disabled||(e||this._updateCanvasStructure(),i=this,GCO5.core.GcDelayUtil.callLater(function(){i._draw2(t,e)},[],GCO5.testMode?0:1,this))},_draw2:function(t,e){if(!this.styles.disabled){(new Date).getTime();var R=!this._completed,k=this.map.getMatrix(),i=this.getChoroTheme(),F=this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_GRAD),V=this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_PTVI)||this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_PTCHORO),U=this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_OURSINS),$=this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_FLUX),B=this._getThemeByCat(GCO5.model.indics.MapIndicModel.ETIQ),n=null==i||null!=i.hasIndicAssoc(),r=this.topoModel,z=r.getArcs(),j=r.getFeatureArcs(),a=j?j.length:0,H=(this.isStat&&GCO5.core.GcDelayUtil.curFrame()<200&&15e4<a&&(n=!1),this.isStat&&!this._meshToDraw(i)&&!n&&(GCO5.appModel.getOption("drawStatLayerEdges")||GCO5.appModel.getOption("isolateSelection")));if(!n&&t&&1==t.anim)i.getSerieBitmaps();else{var s=this.getTopology();if("P"!=s||e)if("E"!=s||e){var W,X,o,l,c,Y,q,K,Z,J,Q,h,tt,et,it,nt,rt,d,at,st,ot,lt,ct,ht,dt,u=r.colors&&r.colors.fillStyle?r.colors.fillStyle:GCO5.core.GcStringUtil.isEmpty(this.styles.fillStyle)?["#D1E1D1"]:[this.styles.fillStyle],p=(GCO5.core.GcMathUtil.isNumber(this.styles.fillAlpha)&&1!=this.styles.fillAlpha&&(X=100-100*this.styles.fillAlpha,u=r.colors&&r.colors.fillStyle?u.map(function(t){return W=GCO5.core.GcMathUtil.adjustBrightness2(t,X),GCO5.core.GcMathUtil.binToHex(W)}):"H"==this.styles.purpose&&this.styles.fillStyle?[this.styles.fillStyle+GCO5.core.GcMathUtil.binToHex(255*this.styles.fillAlpha).substr(-2)]:(W=GCO5.core.GcMathUtil.adjustBrightness2(this.styles.fillStyle,X),[GCO5.core.GcMathUtil.binToHex(W)])),GCO5.browser.isAndroid&&Math.min(this.map.getWidth(),this.map.getHeight())<400),ut=GCO5.browser.isIOS,g=r.getPrecisionFactor(),f=!1,m=(!this._lyBackground&&this.isStat&&n&&a<this.constructor.AGREG_THRESHOLD&&(r&&r.getArcs()||console.error("couche invalide : ",this.layerName,r),o=new Uint8Array(r.getArcs().length+1),f=!0),Z=60<1/g?(K=new Int32Array(a),new Int32Array(a)):(K=new Int16Array(a),new Int16Array(a)),Q=100<1/g?(J=new Uint32Array(a),new Uint32Array(a)):(J=new Uint16Array(a),new Uint16Array(a)),r.getGrid()),pt=(m&&(tt=m.gd_pasx,et=m.gd_pasy,v=m.gd_ncx,m.gd_ncy,nt=v+(it=GCO5.model.maps.GcTopoModel.DECAL_ROV_GRID),rt=m.gd_a,m.params),g),gt=g,_=(this._lowRes(),r.getBboxes()),v=(this.map.hasScaled()&&(this._lastMapExtentPx=null),k.clone().invert()),ft=v.transformPoint(0,0),v=v.transformPoint(this.map.getWidth(),this.map.getHeight()),mt=ft.x,_t=ft.y,vt=v.x-ft.x,yt=v.y-ft.y,bt=v.x,Ct=v.y,v=new GCO5.model.geom.Rectangle(mt,_t,vt,yt),y=this._lastMapExtentPx,vt=(y&&this.isStat&&this._bufferCanvas.width*this._bufferCanvas.height!=1&&((st=v.intersection(y))&&(ot=!n&&st.intersection(this.topoModel.sourceRect(3)).equals(v.intersection(this.topoModel.sourceRect(3)))),lt=y.x,ct=y.y,ht=y.x+y.width,dt=y.y+y.height),this.needFullScan()&&!st),xt=p?2e3:5e3,wt=n||p||ut||GCO5.browser.isIE,St=[],b=this._cv_a.map(function(t){return t.cv.getContext("2d")}),Mt=this._cv_a.length,yt=!1;if(!e){if(!n&&i){var Mt=GCO5.core.GcArrayUtil.getSubArray(this._cv_a,{type:["categ"]}).length,Ot=i.mapIndicModel.getChoroCodes(),p=i.mapIndicModel.getCurrentHexColors(),ut=(u=p||u.map(GCO5.core.GcMathUtil.binToHex),i.mapIndicModel.getMeta("classesVisibility")),p=i.mapIndicModel.getMeta("nbClasses"),Gt=!0,It=(ut.length>p&&(Gt=ut[p]),u.unshift(Gt?GCO5.view.component.ChoroThemeView[i.mapIndicModel.isZonage()?"COL_NA_LIGHT":"COL_NA"]:"#fff"),-1);0<=It&&(this._cv_a[It+1].cv.width=this._cv_a[It+1].cv.height=1);for(var C=1;C<=Mt;C++){var x=b[C];x.fillStyle=u[C-1]||"#000",x.strokeStyle=x.fillStyle,x.lineWidth=.5/k.a,St.push(0),x.beginPath()}}else It=-1;(x=b[0]).clearRect(0,0,x.canvas.width,x.canvas.height),this.map.getMatrix().applyToCanvasContext(x.canvas.getContext("2d"));var Tt="DR"==s&&!this.isStat&&!this.styles.zon&&1<u.length;"DR"!=s||this.isStat||this.styles.zon||(x.fillStyle=GCO5.core.GcMathUtil.hexToRGBAString(u[0]),x.fill(),x.beginPath(),yt=h=!0),"L"!=s&&!this.styles.zon||(x.lineJoin="round",x.lineWidth=this.styles.lineWidth/k.a,this.styles.fillStyle&&(x.fillStyle=this.styles.fillStyle),x.strokeStyle=this.styles.strokeStyle,h=!1,this.styles.zon&&this.styles.fillStyle&&(h=!0))}ut=this._meshToDraw(i);if(n&&t&&(t.updStyles||1==t.anim)&&(ot=!0),(f||yt)&&(vt=!0),"DR"==s&&!ot){r.getArcToFtIndex()||(At=new(65535<=a?Uint32Array:Uint16Array)(z.length),r.setArcToFtIndex(At));var At,p=!R&&!vt,Pt=!r.rolloverGridInited();if(p){for(var Dt,Et,Nt=this._getGridCell(v.topLeft()),ft=this._getGridCell(v.bottomRight()),Lt=(st&&(Dt=this._getGridCell(y.topLeft()),Et=this._getGridCell(y.bottomRight())),[]),w=Nt.y-1;w<=ft.y+1;w++)for(var Rt,kt=Nt.x-1;kt<=ft.x+1;kt++)st&&kt>Dt.x+1&&kt<Et.x-1&&w>Dt.y+1&&w<Et.y-1||((Rt=nt*w+kt)<0||Rt>=m.gd_a.length||m.gd_a[Rt]&&Lt.push(Rt));for(w in 0==Lt.length&&(p=!1,console.log("grid fail",this.layerName)),this.isStat&&n&&!f&&(x.fillStyle=this.constructor.BACKGROUND_STAT,x.beginPath(),h=!0),Lt)for(var Ft=m.gd_a[Lt[w]],Vt=Ft.length,Ut=0;Ut<Vt;Ut++){var S=Ft[Ut],$t=g*_.fminx_a[S],Bt=g*_.fminy_a[S],zt=$t+g*_.fw_a[S],jt=Bt+g*_.fh_a[S];if(!(bt<$t||Ct<Bt||zt<mt||jt<_t)&&!(y&&lt<$t&&ct<Bt&&zt<ht&&jt<dt)){var Ht=(qt=j[S]).rings,Wt=qt.nring;n||((x=b[(A=Ot[S])+1]||b[1]).mozFillRule="evenodd",x.msFillRule="evenodd",h=A!==It,wt&&xt<St[A+1]++&&(x.closePath(),x.fill(),x.beginPath(),St[A+1]=0));for(var M=0;M<Wt;M++)for(var C=(te=Ht[M]).length,O=0;O<C;O++){(ie=0===O&&0===M)&&(I=0);var Xt=te[O],G=Math.abs(Xt),Yt=(L=z[G-1]).length;if((I=0)<=Xt){if(E=L[0],N=L[1],h&&(0===O?x.moveTo(g*E,g*N):x.lineTo(g*E,g*N)),ie&&(d=E*g,at=N*g),h)for(var I=2;I<Yt;I+=2)E=L[I],N=L[I+1],x.lineTo(g*E,g*N)}else if(E=L[ee=Yt-2],N=L[ee+1],h&&(0===O?x.moveTo(g*E,g*N):x.lineTo(g*E,g*N)),ie&&(d=g*E,at=g*N),h)for(I=ee;0<=I;I-=2)E=L[I],N=L[I+1],x.lineTo(g*E,g*N)}this.isStat||e||(x.closePath(),x.fill(),x.beginPath())}}this.isStat&&h&&(x.closePath(),x.fill("evenodd"),H&&x.stroke())}if(!p){h=!(this.styles.zon&&!this.styles.fillStyle||e),this.isStat&&n&&!f?x.fillStyle=this.constructor.BACKGROUND_STAT:this.isStat&&(h=!1);var T=this.isStat?this.constructor.MIN_LEN_PX:0;1<GCO5.browser.dpr&&(T*=GCO5.browser.dpr),15e4<a&&(T=2),5<this.map.getMatrix().a&&(T=0);for(var S=0;S<a;S++){R&&(l=c=Y=q=-1);var qt,A,Kt,Zt,P,D,Ht=(qt=j[S]).rings,Wt=qt.nring;n||e||!i?Tt&&(x.closePath(),x.fill("evenodd"),x.beginPath(),x.fillStyle=u[S]):(x=b[(A=Ot[S])+1]||b[1],h=!0,wt&&xt<St[A+1]++&&(x.closePath(),x.fill("evenodd"),x.beginPath(),St[A+1]=0));for(var Jt,Qt,M=0;M<Wt;M++)for(var te,C=(te=Ht[M]).length,O=0;O<C;O++){var E,N,ee,ie=0===O&&0===M,Xt=te[O],L=z[(G=Math.abs(Xt))-1],Yt=(f&&(o[G]?o[G]++:o[G]=1),L.length);if(!At||At[G-1]||(At[G-1]=S),0<=Xt){if(E=L[0],N=L[1],_||ne(),h&&(0===O?x.moveTo(g*E,g*N):x.lineTo(g*E,g*N)),ie&&(Kt=d=E*g,Zt=at=N*g),h)for(I=2;I<Yt;I+=2)P=g*(E=L[I]),D=g*(N=L[I+1]),(Math.abs(P-Kt)>T||Math.abs(D-Zt)>T)&&(x.lineTo(P,D),Kt=P,Zt=D)}else if(E=L[ee=Yt-2],N=L[ee+1],_||ne(),h&&(0===O?x.moveTo(g*E,g*N):x.lineTo(g*E,g*N)),ie&&(Kt=d=g*E,Zt=at=g*N),h)for(I=ee;0<=I;I-=2)P=g*(E=L[I]),D=g*(N=L[I+1]),(Math.abs(P-Kt)>T||Math.abs(D-Zt)>T)&&(x.lineTo(P,D),Kt=P,Zt=D)}_?Pt&&((Qt=rt[Jt=nt*Math.floor(it+at*(gt/pt)/et)+Math.floor(it+d*(gt/pt)/tt)])||(rt[Jt]=Qt=[]),Qt.push(S)):(K[S]=l,Z[S]=c,J[S]=Y-l,Q[S]=q-c,(Qt=rt[Jt=nt*Math.floor(it+at*(gt/pt)/et)+Math.floor(it+d*(gt/pt)/tt)])||(rt[Jt]=Qt=[]),Qt.push(S)),this.isStat||e||(x.closePath(),x.fill("evenodd"),x.beginPath())}}}if(_||(r.setBboxes({fminx_a:K,fminy_a:Z,fw_a:J,fh_a:Q}),r.getGrid()&&(r.getGrid().computed=!0)),"DR"==s&&!ot&&!e){for(C=1;C<=Mt;C++)(x=b[C])&&(x.closePath(),x.fill("evenodd"),H&&x.stroke());this.isStat&&!f&&((x=b[0]).closePath(),x.fill("evenodd"))}"DR"==s&&ut&&!e&&this._drawLayerMesh(this._getMeshCv()),"L"!=s||e||this._drawLayerMesh(this._getMeshCv()),(f&&o||this._lyBackground&&n)&&this._drawBackground(o,n?this.constructor.BACKGROUND_STAT:u[It],this._getFondCv()),e||this._updateLayerCanvas(v),this._lastMapExtentPx=v,this._completed=!0,e||(F&&(i&&i.hasIndicAssoc()&&i.hasIndicAssoc().getPkF1()==F.mapIndicModel.getPkF1()&&F.linkAssocModel(i.mapIndicModel),GCO5.core.GcDelayUtil.callLater(function(){F.draw(t)},[],t&&1==t.anim?0:4,F)),U&&U.draw(t),$&&$.draw(t),V&&V.draw(t),B&&GCO5.core.GcDelayUtil.callLater(B.draw,["layer",t,e],10,B))}else this._drawEtiqs(t);else this._drawPoints(t)}}function ne(){q=ie?(l=L.minx,Y=L.maxx,c=L.miny,L.maxy):(l=Math.min(L.minx,l),c=Math.min(L.miny,c),Y=Math.max(L.maxx,Y),Math.max(L.maxy,q))}},_drawBackground:function(t,e,i){this._lyBackground||!t||this.topoModel.getFondKArcs()||(t=this._agregLayer(t),this.topoModel.setFondKArcs(t)),i&&this._drawBackground2(this.topoModel.getFondKArcs(),i.getContext("2d"),e)},_getFondCv:function(){var t=GCO5.core.GcArrayUtil.getSubArray(this._cv_a,{type:["background"]});return 0==t.length?null:t[0].cv},_getMeshCv:function(){var t=GCO5.core.GcArrayUtil.getSubArray(this._cv_a,{type:["mesh"]});return 0==t.length?null:t[0].cv},_drawEtiqs:function(t){for(var e=this.topoModel,i=e.getPtX(),n=e.getPtY(),r=e.getLibgeos(),a=e.getColors(),s=e.getPrecisionFactor(),o=e.getParams(),l=(this._etiqStage||(this._etiqStage=new GCO5.view.display.Stage(this._outputCanvas)),this._etiqStage.removeAllChildren(),GCO5.browser.isAndroid?"sans-serif":GCO5.browser.isIOS?"Helvetica Neue":"Arial"),c=(GCO5.browser.isAndroid||GCO5.browser.isIOS,500<GCO5.browser.width?this.map.getPrintMode()&&2==this.map.getPrintMapScaleRatio()?"1.2":"0.7":"0.6"),h=(GCO5.browser.isAndroid||GCO5.browser.isIOS,0);h<i.length;h++){var d=s*i[h],u=s*n[h],p=r[h],g=1==o.italics[h]?" italic ":"",f=GCO5.browser.isAndroid||GCO5.browser.isIOS?"":1==o.bolds[h]?" 700 ":"400",p=new GCO5.view.display.Text(p.split("|").join("\n"),g+f+" "+c*o.sizes[h]/8+"em "+l,GCO5.core.GcMathUtil.binToHex(a[h]),!1),g=(p.etiqAlign="t",p.textAlign="center",this.map.getMatrix().transformPoint(d,u));p.x=g.x,p.y=g.y-16*parseFloat(c)/2-1,this._etiqStage.addChild(p)}this._etiqStage.update()},showEtiqs:function(t,e,i,n){var r,a=this._getThemeByCat(GCO5.model.indics.MapIndicModel.ETIQ);a||this.styles.noEtiq?(a.setStyles(t),a.enable(e,i,n)):(r=new GCO5.model.indics.MapIndicModel({indic:"libgeo",cat:GCO5.model.indics.MapIndicModel.ETIQ,lib_indicateur:"",enabled:!0}),(a=this.addTheme(r)).setStyles(t),a.draw(e,null,null,i,n))},hideEtiqs:function(){var t=this._getThemeByCat(GCO5.model.indics.MapIndicModel.ETIQ);t&&t.disable()},_drawPoints:function(t){var e=this._getThemeByCat(GCO5.model.indics.MapIndicModel.ETIQ),i=this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_PTVI)||this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_PTCHORO),n=this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_GRAD),r=this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_OURSINS),a=this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_FLUX);if(i)i.draw();else if(n)n.draw(t);else{if(r)return r.draw(t),void(this.styles.rovable=!0);if(a)return a.draw(t),void(this.styles.rovable=!0);e||i||this.styles.noEtiq||(n=new GCO5.model.indics.MapIndicModel({indic:"libgeo",cat:GCO5.model.indics.MapIndicModel.ETIQ,lib_indicateur:"",enabled:!0}),e=this.addTheme(n)),e&&e.draw();var r=this.topoModel,s=r.getPtX(),o=r.getPtY(),l=r.getPrecisionFactor(),c=(1==this._outputCanvas.width&&(this._outputCanvas.width=this.map.getWidth(),this._outputCanvas.height=this.map.getHeight()),this._outputCanvas.getContext("2d")),h=(c.lineWidth=.75,c.strokeStyle=this.styles.strokeStyle,c.fillStyle=this.styles.fillStyle,this.map.getMatrix());if(!GCO5.core.GcStringUtil.isEmpty(this.styles.symbol)&&this.styles.fillStyle){var d=this.styles.size;for(u in s)this.styles.filterIndices&&!this.styles.filterIndices[+u]||(p=h.transformPoint(l*s[u],l*o[u]),c.beginPath(),"sq"==this.styles.symbol?c.rect(p.x-d,p.y-d,2*d,2*d):c.arc(p.x,p.y,2*d,0,2*Math.PI,!1),c.fill(),c.closePath())}else for(var u in s){var p=h.transformPoint(l*s[u],l*o[u]);c.beginPath(),c.arc(p.x,p.y,2.5,0,2*Math.PI,!1),c.stroke(),c.closePath()}var a=r.getGrid(),g=a.gd_a;if(this.styles.rovable){var f,m,_=a.gd_pasx,v=a.gd_pasy,t=a.gd_ncx,y=GCO5.model.maps.GcTopoModel.DECAL_ROV_GRID,b=t+y,g=a.gd_a=[];for(u in s)this.styles.filterIndices&&!this.styles.filterIndices[+u]||(p=h.transformPoint(s[u],o[u]),(m=g[f=b*Math.floor(y+p.y/v)+Math.floor(y+p.x/_)])||(g[f]=m=[]),m.push(u))}}},_drawBackground2:function(t,e,i,n){for(var r,a,s=this._lyBackground?(a=(r=this._lyBackground.topoModel).arcs,t=r.karcs,r.getPrecisionFactor()):(a=this.topoModel.arcs,this.topoModel.getPrecisionFactor()),o=t[0].rings,l=a,c=(this._lowRes(),e.canvas.width=e.canvas.width,this.map.getMatrix().applyToCanvasContext(e.canvas.getContext("2d")),e.beginPath(),i?e.fillStyle=i:(e.lineWidth=1.5/this.map.getMatrix().a,e.strokeStyle=n),o.length),h=0;h<c;h++)for(var d=o[h],u=d.length,p=0;p<u;p++){var g=l[Math.abs(d[p])-1],f=g.length;if(0<=d[p]){0==p?e.moveTo(s*g[0],s*g[1]):e.lineTo(s*g[0],s*g[1]);for(var m=2;m<f;m+=2)e.lineTo(s*g[m],s*g[m+1])}else{0==p?e.moveTo(s*g[f-2],s*g[f-1]):e.lineTo(s*g[f-2],s*g[f-1]);for(m=f-2;0<=m;m-=2)e.lineTo(s*g[m],s*g[m+1])}}i?e.fill():e.stroke(),e.closePath()},_drawLayerMesh:function(t){var e=this.topoModel.getPrecisionFactor(),i=t.getContext("2d"),n=(t.width=t.width,this.map.getMatrix().a);if(this.map.getMatrix().applyToCanvasContext(i),i){"L"==this.getTopology()||this.styles.zon?(t=(t=Array.isArray(this.styles.lineWidth)?this.styles.lineWidth[0]:this.styles.lineWidth)||1,p=Array.isArray(this.styles.strokeStyle)?this.styles.strokeStyle[0]:this.styles.strokeStyle,i.lineWidth=t/n,i.strokeStyle=p,i.lineCap="round",i.lineJoin="round"):GCO5.core.GcStringUtil.isEmpty(this.styles.strokeStyle)?(i.lineWidth=.2/n,t=this.topoModel.getNbPoints(),p=this.map.getScaleRatio(),i.strokeStyle=1e5<t&&p<8?"#cccccc":1e5<t&&p<16?"#999999":"#666666"):(i.lineWidth=this.isStat||0==parseFloat(this.styles.lineWidth)?.5/n:this.styles.lineWidth/n,i.strokeStyle=this.map.anamorphing&&this.isStat?"#999":Array.isArray(this.styles.strokeStyle)?this.styles.strokeStyle[0]:this.styles.strokeStyle,this.isStat||(i.lineCap="round",i.lineJoin="round"));var r,a,s,o,l,c=this.isStat,h=(c&&(r=this.topoModel.getBboxes(),p=(t=this.map.getMatrix().clone().invert()).transformPoint(0,0),t=t.transformPoint(this.map.getWidth(),this.map.getHeight()),a=p.x-5,s=p.y-5,o=t.x+5,l=t.y+5),this.topoModel.arcs),R=h.length,d=0,u=this.topoModel.getTypo(),p=this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_LNVI),t=this._getThemeByCat(GCO5.model.indics.MapIndicModel.SYMB_LNVI,!0);if(!t||p){var g=u?this.styles.lineWidth.length:1;if(p)for(var g=this.styles.lineWidth.length,u=p.mapIndicModel.getValues(),k=p.mapIndicModel.getCurrentHexColors(),F=p.mapIndicModel.getMeta("sizes"),f=(I=this.topoModel.karcs).length,m=0;m<g;m++){i.lineJoin="round",i.lineWidth=F[m]/n,i.strokeStyle=k[m],i.beginPath();for(var _=m+1,v=0;v<f;v++)if(!u||u[v]==_)for(var y=(T=I[v]).rings,b=T.nring,C=0;C<b;C++)for(var x=(A=y[C]).length,w=0;w<x;w++){var S=A[w],M=(E=h[Math.abs(S)-1]).length;i.moveTo(e*E[0],e*E[1]);for(var O=2;O<M;O+=2)i.lineTo(e*E[O],e*E[O+1])}i.stroke(),i.closePath()}else if(u){var G=GCO5.core.GcArrayUtil.getDistinctValues(u);G.sort();for(var I,f=(I=this.topoModel.karcs).length,m=0;m<g;m++){i.lineJoin="round",i.lineWidth=this.styles.lineWidth[m]/n,i.strokeStyle=this.styles.strokeStyle[m],i.beginPath();for(var _=G[m],v=0;v<f;v++)if(!u||u[v]==_)for(var T,y=(T=I[v]).rings,b=T.nring,C=0;C<b;C++)for(var A,x=(A=y[C]).length,w=0;w<x;w++){S=A[w],M=(E=h[Math.abs(S)-1]).length;i.moveTo(e*E[0],e*E[1]);for(O=2;O<M;O+=2)i.lineTo(e*E[O],e*E[O+1])}i.stroke(),i.closePath()}}else{i.beginPath();for(var P=this.topoModel.getArcToFtIndex(),D=0;D<R;D++){var E,M=(E=h[D]).length;if(c)if(null!=(v=P?P[D]:null)){var N=e*r.fminx_a[v],L=e*r.fminy_a[v],V=e*r.fw_a[v],U=e*r.fh_a[v];if(o<N||l<L||N+V<a||L+U<s)continue}5e3<(d+=M)&&(i.stroke(),i.beginPath(),d=0),i.moveTo(e*E[0],e*E[1]);for(w=2;w<M;w+=2)i.lineTo(e*E[w],e*E[w+1])}i.stroke(),i.closePath()}}}},_resizeCanvases:function(t,e){this._cvOrigin_px={x:0,y:0};var i,n=this.map.getMatrix(),r=this.getTopology(),a=this.getChoroTheme(),s=a&&!a.hasIndicAssoc();this.map.getResolutionRatio();for(i in this._cv_a){var o=this._cv_a[i].cv,l=o.width,c=o.height;o.width=+t||l,o.height=e?+e:c,"P"!=r&&((n=n.clone()).scale(1,1),n.applyToCanvasContext(o.getContext("2d"))),"mesh"!=this._cv_a[i].type||this._meshToDraw(a)||1==o.width||(o.width=o.height=1),"background"==this._cv_a[i].type&&s&&1!=o.width&&(o.width=o.height=1)}},_getGridCell:function(t){var e=this.topoModel.getGrid(),i=GCO5.model.maps.GcTopoModel.DECAL_ROV_GRID,n=Math.floor(i+t.x/e.gd_pasx),i=Math.floor(i+t.y/e.gd_pasy);return new GCO5.model.geom.Point(n,i)},findObjsInCircle:function(t){for(var e=[],i=this.topoModel.getGrid(),n=t.radius*t.radius,r=this.map.getMatrix(),a=r.clone().invert(),s=("P"==this.getTopology()&&(a=new GCO5.model.geom.Matrix),this._getGridCell(a.transformPoint(t.x-t.radius,t.y-t.radius))),o=this._getGridCell(a.transformPoint(t.x+t.radius,t.y+t.radius)),l=i.gd_ncx+GCO5.model.maps.GcTopoModel.DECAL_ROV_GRID,c=this.topoModel.getCtrX(),h=this.topoModel.getCtrY(),d=this.topoModel.getPrecisionFactor(),u=s.y-1;u<=o.y+1;u++)for(var p=s.x-1;p<=o.x+1;p++){var g=l*u+p;if(!(g<0||g>=i.gd_a.length)){var f=i.gd_a[g];if(f)for(var m=f.length,_=0;_<m;_++){var v=f[_],y=d*c[v],b=d*h[v],y=r.transformPoint(y,b);(y.x-t.x)*(y.x-t.x)+(y.y-t.y)*(y.y-t.y)<=n&&e.push(v)}}}return e},onVMouseMove:function(t,e,i,n,r,a){var s=this._rovFid,o=this.topoModel.getTopology();if(t){var l,c,h="DR"==o||"L"==o,d=l=t-this.map.getMapXPosition(),u=c=e-this.map.getMapYPosition(),p=i.clone().invert().transformPoint(d,u),d=p.x,u=p.y,p=null!=s?this._getRectFid(s):null,g=this.getFluxTheme();if(g&&(this._rovFluxFid=null,this._rovFluxFid=g.highlight(null,t,e)),!this.styles.zon&&1!=r&&null!=s&&p&&p.containsXY(d,u)&&(i.a*(p.width+p.height)<10||this.topoModel.pointInsidePolygon(s,d,u)))return p=this._getRectFidScreen(p,i),void this._displayToolTip(t,e,p,a);var f,m,_,v,g=this.topoModel.getGrid(),g=(g&&(f=g.gd_pasx,m=g.gd_pasy,T=g.gd_ncx,g.gd_ncy,S=T+(_=GCO5.model.maps.GcTopoModel.DECAL_ROV_GRID),v=g.gd_a),this.topoModel.getPrecisionFactor()),y=g,b=[];if(h)for(var C=v.length,x=Math.floor(_+d*(g/y)/f),w=Math.floor(_+u*(g/y)/m),S=T+_,M=[[0,0],[0,1],[0,-1],[-1,0],[1,0],[-1,-1],[-1,1],[1,-1],[1,1]],O=0;O<9;O++){var G,I=M[O];0<=(G=S*(w+I[0])+(x+I[1]))&&G<C&&v[G]&&(A++,b.push(G))}else{x=Math.floor(_+g/y*l/f),w=Math.floor(_+g/y*c/m);b.push(S*w+x)}if(0==b.length)this.clearRovEfect(t,e);else{var T=this._findRovObj2(b,v,"",t,e,h?d:l,h?u:c,i,o,n,r);if(0==T&&h){for(var b=[],A=0,P=-3;P<=3;P++)for(O=-3;O<=3;O++){var D=O<0?-O:O,E=P<0?-P:P;0<=(G=S*(w+P)+(x+O))&&v[G]&&(A++,D<=1&&E<=1||b.push({h:G,d:D+E}))}0<A&&((T=this._findRovObj2(b,v,"d",t,e,d,u,i,o,n,r))||(null!==this._rovFluxFid?this._displayToolTip(t,e,p,a):this.map.clearLayerRovInfo(this.layerName),this._lastRovRect=null,this._rovFid=null,this._highlightOnMouseOver(null,o,i,p,r,n,d,u,t,e)))}else 0==T&&this.clearRovEfect(t,e)}}else"DR"==o&&(this._drawPolyAt(s),(f=this._getRectFid(s))&&this.map.affTtp(this.layerName,s,null,null,null,this._getRectFidScreen(f,i),a))},clearRovEfect:function(t,e){null===this._rovFluxFid&&this.map.clearLayerRovInfo(this.layerName),this._highlightOnMouseOver(null,null,null,null,null,null,null,null,t,e),this._lastRovRect=null,this._rovFid=null},_findRovObj2:function(t,e,i,n,r,a,s,o,l,c,h){var d=0,u=t.length;if(!e)return 0;for(var p=0;p<u;p++){var g="d"==i?t[p].h:t[p];if(!(g<0)){var f=e[g];if(f)for(var m in f){var m=f[m],_=this._getRectFid(m,l,o);if(_.containsXY(a,s)&&(this._highlightOnMouseOver(m,l,o,_,h,c,a,s,n,r)&&(d++,"P"!=l)))break}if(0<d&&"P"!=l)break}}return d},_highlightOnMouseOver:function(t,e,i,n,r,a,s,o,l,c){var h,d;"P"==e?h=!0:"DR"==e&&null!=t&&(i.a*(n.width+n.height)<10||this.topoModel.pointInsidePolygon(t,s,o))&&(this.map._setRovCanvasTransform(this._lastRovRect),this._lastRovRect=n,a||this._drawPolyAt(t),n=this._getRectFidScreen(n,i),h=!0);for(var u=0;u<this._theme_a.length;u++){var p=this._theme_a[u].thv,g=p.getModel();!p.isEtiq&&g.isEnabled()&&(d=null!==p.highlight(h?t:null,l,c))}return!!(h||d&&g.isFlux())&&(this._rovFid=t,this._displayToolTip(l,c,n),!0)},_displayToolTip:function(t,e,i,n){this.map.affTtp(this.layerName,this._rovFid,this._rovFluxFid,t,e,i,n)},_getRectFid:function(t,e,i){if("P"===e)var e=this.topoModel.getCurrentPtX(),n=this.topoModel.getCurrentPtY(),i=i.transformPoint(e[t],n[t]),e=GCO5.browser.isTouch?20:12,n=.5*e,r=i.x-n,n=i.y-n,a=e,s=e;else{i=this.topoModel.getBboxes();if(!i)return null;e=this.topoModel.getPrecisionFactor(),r=e*i.fminx_a[t],n=e*i.fminy_a[t],a=e*i.fw_a[t],s=e*i.fh_a[t]}return new GCO5.model.geom.Rectangle(r,n,a,s)},_getRectFidScreen:function(t,e){if(!t)return null;var i=e.transformPoint(t.x,t.y);return{x:i.x>>0,y:i.y>>0,w:e.a*t.width>>0,h:e.a*t.height>>0}},_bboxInMapFrame:function(t,e,i){var n=this.topoModel.getPrecisionFactor(),r=n*t.fminx_a[e],a=n*t.fminy_a[e],s=n*t.fw_a[e],n=n*t.fh_a[e];return new GCO5.model.geom.Rectangle(r,a,s,n).intersects(i)},drawPointSel:function(t){this.getCurTheme()&&this.getCurTheme().drawSel(t)},drawPolySel:function(t,e){var i=e.getStyles(),n=this.topoModel.arcs,r=this.topoModel.karcs,a=this.topoModel.getPrecisionFactor(),s=this.map.getSelCanvas(),o=(GCO5.core.GcBitmapUtil.clearCanvas(s),$(s).css("display","block"),$(s).css("opacity",1),s.getContext("2d")),l=(this.map.getMatrix().applyToCanvasContext(o),t.length),e=e.codgeo;t=this.hashSel==e?this.topoSelection:this.topoSelection=new GCO5.model.maps.GcTopoSelection(n,r,t),this.hashSel=e;var c=t.getKarcs()[0].rings,h=1==l?i.fillUniqueSel:"rgba(150, 150, 150, 1)",d=(r.length>GCO5.view.component.LayerView.AGREG_THRESHOLD&&(h=null),1<l&&h&&(o.setTransform(1,0,0,1,0,0),o.fillStyle=GCO5.appModel.getOption("isolateSelection")?"white":this.constructor.SELCOLOR2,o.fillRect(0,0,s.width,s.height),o.globalCompositeOperation="destination-in",o.drawImage(this.map.getStatCanvas(),0,0),this.map.getMatrix().applyToCanvasContext(o),o.globalCompositeOperation="destination-out"),o.beginPath(),h&&(o.fillStyle=h),o.lineWidth=2/this.map.getMatrix().a,o.strokeStyle=i.strokeStyle,o.lineJoin="round",o.lineCap="round",c.length);o.mozFillRule="evenodd",o.msFillRule="evenodd";for(var u=0;u<d;u++)for(var p=c[u],g=p.length,f=0;f<g;f++){var m=p[f],_=n[Math.abs(m)-1],v=_.length;if(0<=m){0!==f&&h?o.lineTo(a*_[0],a*_[1]):o.moveTo(a*_[0],a*_[1]);for(var y=2;y<v;y+=2)o.lineTo(a*_[y],a*_[y+1])}else{0!==f&&h?o.lineTo(a*_[v-2],a*_[v-1]):o.moveTo(a*_[v-2],a*_[v-1]);for(y=v-2;0<=y;y-=2)o.lineTo(a*_[y],a*_[y+1])}}h&&o.closePath(),h&&o.fill("evenodd"),1<l&&(o.globalCompositeOperation="source-over"),o.stroke()},_drawPolyAt:function(t,e,i){if(Array.isArray(t))this.drawPolySel(t);else{var n,r,a=this.topoModel.arcs,t=this.topoModel.karcs[t];if(t){var s=t.rings,o=t.nring,l=this.topoModel.getPrecisionFactor();(e=e||this.map.getRovCanvas().getContext("2d")).lineWidth=2/this.map.getMatrix().a,e.strokeStyle=this.styles.zon?"#c00":"#0000ff",this.getFluxTheme()&&(e.strokeStyle=this.styles.zon?"#c00":"#aaaaaa"),e.lineJoin="round",e.lineCap="round",i&&(i.fill&&(e.fillStyle=i.fill),e.lineWidth&&(e.lineWidth=i.lineWidth),i.strokeStyle&&(e.strokeStyle=i.strokeStyle)),e.beginPath();for(var c=0;c<o;c++)for(var h=s[c],d=h.length,u=0;u<d;u++){var p=h[u],g=a[Math.abs(p)-1],f=g.length;if(0<=p){n=l*g[0],r=l*g[1],0==u?e.moveTo(n,r):e.lineTo(n,r);for(var m=2;m<f;m+=2)e.lineTo(l*g[m],l*g[m+1])}else{n=l*g[f-2],r=l*g[f-1],0==u?e.moveTo(n,r):e.lineTo(n,r);for(m=f-2;0<=m;m-=2)e.lineTo(l*g[m],l*g[m+1])}}i&&!i.lineWidth||e.stroke(),i&&i.fill&&e.fill(),e.closePath()}}},_lowRes:function(){return this.map.getScaleRatio()<5&&1e5<this.getNbObjs()},needFullScan:function(){return this.map.getScaleRatio()<1.1},_updateCanvasStructure:function(){var t=this.getTopology(),e=this._cv_a.length,i=this.getChoroTheme(),n=null!=i&&!i.hasIndicAssoc();if(!this.isStat&&"DR"==t&&GCO5.browser.isIE){for(;0<this._cv_a.length;){var r=this._cv_a.shift();GCO5.core.GcBitmapUtil.dropCanvas(r)}e=0}if(0==e){this.isStat?((r=document.createElement("canvas")).id=this.layerName+"_fond_cv",this._cv_a.push({cv:r,type:"background"})):e="DR"==t?1:0;for(var a=0;a<e;a++)(r=document.createElement("canvas")).id=this.layerName+"_"+a+"_cv",this._cv_a.push({cv:r,type:"categ"});"DR"!=t&&"L"!=t||((r=document.createElement("canvas")).id=this.layerName+"_mesh_cv",this._cv_a.push({cv:r,type:"mesh"}))}this._bufferCanvas||(this._bufferCanvas=document.createElement("canvas"),this._bufferCanvas.width=this._bufferCanvas.height=1);var s=n?i.mapIndicModel.getHexColors().length+1:0,o=GCO5.core.GcArrayUtil.getSubArray(this._cv_a,{type:["categ"]}),l=o.length;if(n&&l<s)for(a=l;a<s;a++)(r=document.createElement("canvas")).id=this.layerName+"_"+a+"_cv",this._cv_a.splice(a+1,0,{cv:r,type:"categ"});if(!n)for(a=0;a<l;a++)(r=o[a].cv).width=r.height=1;this._resizeCanvases(this.map.getWidth(),this.map.getHeight())},_agregLayer:function(t,e,i){return new GCO5.model.maps.GcTopoSelection(this.topoModel.arcs,this.topoModel.karcs,null,t).getKarcs()}}),GCO5.view.component.ChoroThemeView=GCO5.view.component.AThemeView.extend({statics:{NAME:"GCO5.view.component.ChoroThemeView",COL_NA:"#cccccc",COL_NA_LIGHT:"#f0f0f0"},initialize:function(t,e){this._super(t,e);e=e.isVI()?"VI":"ChoroNum",this.legend=new GCO5.view.component["Maplegend"+e]({map:t.map,thv:this}),e=this.mapIndicModel.getChoroCodes();this.ly.checkCompatibilityWithRefgeo(e.length)},getSerieBitmaps:function(t){var e,i,n=this,r=this.mapIndicModel.getProp("animData"),a=this.mapIndicModel.getProp("dataSeriesFromAnimDp"),s=(r&&r.v0?r.v0:r[a[a.length-1]]).concat([]),o=(this.ly._updateCanvasStructure(),this.clearAnimCanvases(),this._updateCanvasStructure(a.length),this.mapIndicModel.getProp("serie")==a[a.length-1]?1:0);1==o&&(e=this.ly.map.getStatCanvas(),i=this._cv_a[0],GCO5.core.GcDelayUtil.callLater(function(){i.getContext("2d").drawImage(e,0,0)},[],1,this));for(var l=o;l<a.length;l++)GCO5.core.GcDelayUtil.callLater(n._getSerieBitmap,[l,s,r],2*l+2,this);this.ly._meshToDraw()&&GCO5.core.GcDelayUtil.callLater(function(){var t=n.ly._getMeshCv();t.width=n.ly.map.getWidth(),t.height=n.ly.map.getHeight(),n.ly._drawLayerMesh(t)},[l,s,r],2*l+2+5,this),GCO5.core.GcDelayUtil.callLater(n._afterSerieBitmapsBuilt,[t,s],2*l+2+10,this)},_getSerieBitmap:function(t,e,i){for(var n,r,a=0==this.mapIndicModel.getProp("idDataset").indexOf("_import"),s=this.mapIndicModel.getProp("dataSeriesFromAnimDp").reverse(),o=(a||0==t||(n=i[s[t]]),this.ly.getNbObjs()),i=this.ly.topoModel,l=this.ly.map.getMatrix(),c=i.getPrecisionFactor(),h=i.getBboxes(),d=l.clone().invert(),u=d.transformPoint(0,0),d=d.transformPoint(this.ly.map.getWidth(),this.ly.map.getHeight()),p=u.x,g=u.y,f=d.x,m=d.y,u=GCO5.browser.isAndroid&&Math.min(this.ly.map.getWidth(),this.ly.map.getHeight())<400,d=GCO5.browser.isIOS,R=i.getArcs(),k=i.getFeatureArcs(),F=u?500:5e3,V=u||d,_=[],v=this,i=GCO5.core.GcArrayUtil.getSubArray(this.ly._cv_a,{type:["categ"]}),y=i.map(function(t){return 1==t.cv.width?(t.cv.width=v.map.getWidth(),t.cv.height=v.map.getHeight()):t.cv.width=t.cv.width,l.applyToCanvasContext(t.cv.getContext("2d")),t.cv.getContext("2d")}),b=i.length,C=this.mapIndicModel.getCurrentHexColors(),U=(C.unshift(GCO5.view.component.ChoroThemeView[this.mapIndicModel.isZonage()?"COL_NA_LIGHT":"COL_NA"]),this.mapIndicModel.getChoroCodes(s[t])),x=0;x<b;x++)(L=y[x]).fillStyle=C[x],_.push(0),L.beginPath();L=y[0];for(var w=0;w<o;w++){var S=c*h.fminx_a[w],M=c*h.fminy_a[w],$=S+c*h.fw_a[w],B=M+c*h.fh_a[w];if(!(f<S||m<M||$<p||B<g)){var S=k[w],z=S.rings,j=S.nring,M=a?U[w]:e[w]+=0==t?0:n[w];if(L=y[M]){V&&F<_[M]++&&(L.closePath(),L.fill(),L.beginPath(),_[M]=0);for(var O=0;O<j;O++)for(var G=z[O],x=G.length,I=0;I<x;I++){(r=0===I&&0===O)&&(D=0);var T=G[I],A=R[Math.abs(T)-1],P=A.length;if((D=0)<=T){E=A[0],N=A[1],0===I?L.moveTo(c*E,c*N):L.lineTo(c*E,c*N),r&&0;for(var D=2;D<P;D+=2)E=A[D],N=A[D+1],L.lineTo(c*E,c*N)}else{var T=P-2,E=A[T],N=A[1+T];0===I?L.moveTo(c*E,c*N):L.lineTo(c*E,c*N),r&&0;for(D=T;0<=D;D-=2)E=A[D],N=A[D+1],L.lineTo(c*E,c*N)}}}else console.warn("erreur itération",t,"fid=",w,e[w],n[w],M)}}for(x=0;x<b;x++)(L=y[x]).closePath(),L.fill();for(var H=this._cv_a[t],x=0;x<b;x++){var L=y[x];H.getContext("2d").drawImage(L.canvas,0,0)}},_afterSerieBitmapsBuilt:function(t,e){this._cv_a.reverse(),this._super()},playAnim:function(){this._cv_a.length;var t,e=this.mapIndicModel.getProp("dataSeriesFromAnimDp"),i=(null==this._curBmpId||this._curBmpId==e.length-1?this._curBmpId=1:this._curBmpId++,console.log(this._curBmpId),this._curBmpId-1),n=this._curBmpId,r=this.ly.map,a=this,s=(r._thmAnimating=!0,r.getCanvas("maptransition")),o=r.getCanvas("maptransition1");$(s).css("display","block"),$(o).css("display","block"),$(o).on("webkitTransitionEnd transitionend",{ca:this},this._crossFadeAnimTheme),s.getContext("2d").drawImage(this._cv_a[i],0,0),o.getContext("2d").drawImage(this._cv_a[n],0,0),$(s).css("opacity",1),$(o).css("opacity",0),this.ly._meshToDraw()&&(t=this.ly._getMeshCv(),s.getContext("2d").drawImage(t,0,0),o.getContext("2d").drawImage(t,0,0)),GCO5.core.GcDelayUtil.callLater(function(){$(r).triggerHandler(GCO5.view.component.MapView.UPD_SERIE,{serie:e[n],mapIndicModel:a.mapIndicModel}),$(o).addClass("cfade"),$(o).css("opacity",1)},[],100,this),$(r).triggerHandler(GCO5.view.component.MapView.UPD_SERIE,{serie:e[i],mapIndicModel:a.mapIndicModel}),this._curSerie=e[i],GCO5.core.GcArrayUtil.getSubArray(this.ly._cv_a,{type:["categ"]}).map(function(t){t.cv.width=t.cv.width=1})},_crossFadeAnimTheme:function(t){var e,i=t.data.ca,n=i.ly.map,t=i._cv_a.length,r=n.getCanvas("maptransition"),a=n.getCanvas("maptransition1"),s=i.mapIndicModel.getProp("dataSeriesFromAnimDp");i._curBmpId==t-1?i._endTransition(i._curBmpId):n._thmAnimating?(e=s[i._curBmpId+1],$(a).removeClass("cfade"),$(r).css("opacity",1),$(a).css("opacity",0),GCO5.core.GcBitmapUtil.clearCanvas(r),GCO5.core.GcBitmapUtil.clearCanvas(a),r.getContext("2d").drawImage(i._cv_a[i._curBmpId],0,0),a.getContext("2d").drawImage(i._cv_a[i._curBmpId+1],0,0),i.ly._meshToDraw()&&(t=i.ly._getMeshCv(),r.getContext("2d").drawImage(t,0,0),a.getContext("2d").drawImage(t,0,0)),GCO5.core.GcDelayUtil.callLater(function(){$(n).triggerHandler(GCO5.view.component.MapView.UPD_SERIE,{serie:e,mapIndicModel:i.mapIndicModel}),$(a).addClass("cfade"),$(a).css("opacity",1)},[],50,i),i._curBmpId++):i._endTransition(i._curBmpId,!0)},onCloseTimeAnim:function(){var t=this.mapIndicModel.getProp("dataSeriesFromAnimDp");this._endTransition(t.indexOf(this.mapIndicModel.getProp("serie"))),this._super()},_endTransition:function(t,e){var i,n=this.ly.map,r=this,a=(n.getStatCanvas().getContext("2d").drawImage(this._cv_a[t],0,0),r.mapIndicModel.getProp("dataSeriesFromAnimDp"));e||(i=a[t],GCO5.core.GcDelayUtil.callLater(function(){$(n).triggerHandler(GCO5.view.component.MapView.UPD_SERIE,{serie:i,mapIndicModel:r.mapIndicModel})},[],50,this)),this._super()},onSerieAnimChange:function(t,e){var i,n,r=this.ly.map;this.getIndicModel().setSerie(t),this.updateLegendValref(),this.updateLegendEfts(),r._thmAnimating||(n=this.mapIndicModel.getProp("dataSeriesFromAnimDp"),t!=this._curSerie&&(n=n.indexOf(t),this._curBmpId=n,i=r.getCanvas("maptransition"),$(i).show().css("opacity",1),GCO5.core.GcBitmapUtil.clearCanvas(i),i.getContext("2d").drawImage(this._cv_a[n],0,0),this.ly._meshToDraw()&&this.mapIndicModel.getProp("serie")!=t&&(n=this.ly._getMeshCv(),i.getContext("2d").drawImage(n,0,0)),e||$(r).triggerHandler(GCO5.view.component.MapView.UPD_SERIE,{serie:t,mapIndicModel:this.mapIndicModel,noSlider:!0}),this._curSerie=t))}}),GCO5.view.component.SymbGradThemeView=GCO5.view.component.AThemeView.extend({statics:{NAME:"GCO5.view.component.SymbGradThemeView",SYMB_AREA_RATIO:7,BIG_CIRCLES:120,sizeLocked:!1,sizeRef:null,valRef:null},_sqrtValuesToPixels:0,_img_a:null,_imgMaxRadius_a:null,_buffer_cv:null,_bufferCols:null,_lastEpCont:null,_lastCols:null,lastF0Code:null,assocChMapModel:null,_syncAnimAfterChoro:null,_lastSymb:null,lastScreenValmax:null,lastnumVisibleRonds:null,lastserie:null,initialize:function(t,e){this._super(t,e),this.legend=new GCO5.view.component.MaplegendCircles({map:t.map,thv:this}),this.lastScreenValmax=this.mapIndicModel.getMeta("valmax"),this.lastserie=this.mapIndicModel.getMeta("serie"),this.lastnumVisibleRonds=this.ly.getNbObjs();e=this.hasIndicAssoc();e&&(this.assocChMapModel=this.map.getMapIndicModelByPk(e.getPk()))},_prepareRondsBuffer:function(t){var e=this.assocChMapModel?this.assocChMapModel.getCurrentHexColors():this.mapIndicModel.getMeta("colf");if(!this._img_a&&(this._buffer_cv=document.createElement("canvas"),this._buffer_cv.id="_buffer_cv",this._buffer_cv.width=200,this._buffer_cv.height=200,this._bufferCols=[],this._img_a=[{},{}],this._imgMaxRadius_a=[1,1],this.assocChMapModel))for(var i=0;i<e.length;i++)this._img_a.push({});var n=this.map.lyStat.getChoroTheme(),r=e[0],n=(this.mapIndicModel.getMeta("fillAuto")&&n&&GCO5.core.ColorThief&&!this.mapIndicModel.hasMultVars()&&!this.assocChMapModel&&(e=this._getContrastedChoroCol(e)),this.mapIndicModel.getHighlightedMod());if(!this.mapIndicModel.hasMultVars()||0<=n){if(!this.assocChMapModel)return 0<=n?this._initRondsBuffer(e[n],0,t):1==e.length?this._initRondsBuffer(r,0,t):(this._initRondsBuffer(e[0],0,t),this._initRondsBuffer(e[1],1,t));this._initRondsBuffer("#f0f0f0",0,t);for(i=0;i<e.length;i++){var a=this._initRondsBuffer(e[i],i+1,t);if(0==i&&a)return a;if(i==e.length-1)return a}return!1}return!0},linkAssocModel:function(t){if(!t||this.assocChMapModel!==t){this.indicModel.linkAssocModel(t?t.getIndicModel():null),this.assocChMapModel=t,this.mapIndicModel.setStyleSilent("idSymb",t?"dq":"sp"),this.mapIndicModel.setStyleSilent("contourAuto",!t),this.mapIndicModel.setStyleSilent("cols","#999"),this._img_a=[],this._imgMaxRadius_a=[],this._bufferCols=[],this._buffer_cv||(this._buffer_cv=document.createElement("canvas"),this._buffer_cv.id="_buffer_cv",this._buffer_cv.width=200,this._buffer_cv.height=200);for(var e=this.assocChMapModel?this.assocChMapModel.getCurrentHexColors().length+1:2,i=0;i<e;i++)this._img_a.push({}),this._imgMaxRadius_a[i]=1,this._bufferCols[i]=null}},_getContrastedChoroCol:function(t){var e,i=this.ly.mainPalette,n=this.mapIndicModel.getMeta("distribInfo"),r=[],a=t.concat(["#FF9A15","#5C85CC","#A8804C","#FF5A4D","#669933","#cc66CC","#00CCFF","#999999","#3399ff","#00d077"]),s=(2==t.length&&n&&(s=n.nv_neg,(0<(n=n.nv_pos)||0<s)&&(r=[n/(n=n+s),s/n]),a=[t].concat([["#FF9A15","#0000ff"],["#A8804C","#FF5A4D"],["#cc66CC","#00CCFF"],["FF9A15","#33cc66"]])),1==GCO5.appModel.getOption("contrastWithRegisteredColors"));for(e in s&&(n=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("color"),{c_typ_pal:"R",c_ncols:1}),2==t.length&&(n=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getInitKey("cols_a"),{c_typ_pal:"R",c_ncols:2,c_diverging:1})),3<(n=GCO5.core.GcArrayUtil.getColumnByKey(n,"coldef")).length&&s&&(a=n)),a)a[e]={col:a[e]};return i?GCO5.core.ColorThief.getMostContrastedColor(i,a,t,r):t},updateAfterBackgroundChanged:function(){var t,e;this.mapIndicModel.isEnabled()&&this.mapIndicModel.getMeta("fillAuto")&&(t=this.mapIndicModel.getMeta("colf"),e=this._getContrastedChoroCol(t),Array.isArray(e)||(e=[e]),t&&e&&t.join("")!=e.join("")&&t.length==e.length&&(t=e,this.mapIndicModel.updateWithDefs({colf:t}),GCO5.core.SystemManager.getInstance().freeze("render"),this.map.updTheme(this.mapIndicModel)))},_checkColorBuffer:function(t,e,i){var n=this.mapIndicModel,r=n.hasMultVars(),a=this.ly.topoModel.getTopology(),s=this.assocChMapModel?this.assocChMapModel.getCurrentHexColors():this.mapIndicModel.getMeta("colf"),a="P"==a,a=this.ly.needFullScan()||a,o=n.getHighlightedMod();if(!e||0!=e.numVisibleRonds){if(!n.hasValidData())return!0;i||(l=n.getStatData(),e=e.cti_a,c=n.getProp("sortedIndices"),c=(a?c:e)[0]);var l,c,h,a=i?this.constructor.BIG_CIRCLES:Math.ceil(this._sqrtValuesToPixels*Math.sqrt(Math.abs(l[c])));if(t&&t.updStyles&&(!r||0<=o)&&this._bufferCols){if(r)this._bufferCols[0]!=s[o]&&(this._imgMaxRadius_a[0]=1,this._initRondsBuffer(s[o],0,a),h=!0);else if(this._bufferCols[this.assocChMapModel?1:0]!=s[0]){if(this.assocChMapModel)return this._prepareRondsBuffer(a);this._imgMaxRadius_a[0]=1,this._initRondsBuffer(s[0],0,a),h=!0}else if(!this.assocChMapModel&&1<s.length&&this._bufferCols[1]!=s[1])this._imgMaxRadius_a[1]=1,this._initRondsBuffer(s[1],1,a),h=!0;else if(this._lastSymb!=n.getMeta("idSymb")||this._lastEpCont!=n.getMeta("epCont")||this._lastCols!=n.getRondsStrokeColor()){if(this.assocChMapModel)return this._img_a=null,this._prepareRondsBuffer(a);this._imgMaxRadius_a[0]=1,this._initRondsBuffer(s[0],0,a),1<s.length&&(this._imgMaxRadius_a[1]=1,this._initRondsBuffer(s[1],1,a)),h=!0}else if(this._prepareRondsBuffer(a))return!0;if(h)return!0}else if(this._prepareRondsBuffer(a))return!0}return!1},draw:function(t,e){this.map.getResolutionRatio();var i=this.map.getEnabledIndicsModelsIndexed();if(t&&1==t.anim)this._getSerieBitmaps();else{this.assocChMapModel&&(n=this.assocChMapModel.getChoroCodes());var n,r=this.mapIndicModel,a=Math.max(1,r.getMeta("epCont")),s=r.getProp("sortedIndices"),o=this.ly.topoModel,l=o.getCtrX(),c=o.getCtrY(),h=o.getPrecisionFactor();if(r.getProp("f0Code")&&r.getProp("f0Code")!==this.lastF0Code){this.lastF0Code=r.getProp("f0Code");var d=r.getProp("notNullIndices",{skipCodgeoPattern:"9",x:l,y:c,rx:h,opti:!0});if(d&&0<d.length)return r.setStyleSilent("pauseLegend",!0),i=1==GCO5.core.GcObjectUtil.count(i)?5:30,void GCO5.core.GcDelayUtil.callLater(this.ly.map.zoomOnFeatureId,[null,d],i,this.ly.map)}r.setStyleSilent("pauseLegend",!1);var R=r.getProp("nbVars"),u=r.hasMultVars(),k=0<r.getStat("nv_neg"),d=o.getTopology(),p=r.getMeta("colf"),i=(this.assocChMapModel&&(p=this.assocChMapModel.getMeta("colf")),"P"==d),g=this.ly.needFullScan()||i,f=r.getHighlightedMod();if(e||(e=this._collectRondsDistribInfo(),null==r.getMeta("valmax")&&r.updateCalcs()),r.hasValidData()&&(!u||-1!=f))if(this._checkColorBuffer(t,e))return void GCO5.core.GcDelayUtil.callLater(this.draw,[null,e],(t&&t.updStyles,3),this);(new Date).getTime();var m,_,v,y,b,C,x,d=this.ly.map.getTopThemeCanvas(),w=d.getContext("2d"),F=(GCO5.core.GcBitmapUtil.clearCanvas(d),Math.PI,i&&(l=o.getPtX(),c=o.getPtY(),m=(t=o.getGrid()).gd_pasx,_=t.gd_pasy,y=t.gd_ncx+(v=GCO5.model.maps.GcTopoModel.DECAL_ROV_GRID),C=b=h,x=t.gd_a=[]),e.cti_a),V=e.ctx_a,U=e.cty_a;if(u){var $,S=r.getProp("vars"),B=r.getProp("totValues");if(S){var M,O=S.concat();for(M in O)O[M]=r.getProp("idDataset")+"."+O[M]}0<=(f=O?f:-1)&&($=r.getValues(f))}w.globalAlpha=Math.min(1,this.assocChMapModel?1:Math.sqrt(r.getMeta("fillOpacity")));for(var G,I,z=r.getStatData(),j=this.ly.map.getMatrix(),H=g?s.length:e.numVisibleRonds,d=this.constructor,W=Math.sqrt(Math.PI/4),X="sq"==r.getMeta("idSymb")||"es"==r.getMeta("idSymb"),Y=(i||this.ly.checkCompatibilityWithRefgeo(s.length),w.beginPath(),w.lineWidth=2,1==r.getMeta("rdplein")),q=0<=["cc","dq"].indexOf(r.getMeta("idSymb"))||1==GCO5.appModel.getOption("flatCirclesInMap"),o=(GCO5.browser.isFirefox&&u&&-1==f&&5e3<this.ly.getNbObjs()&&(q=!0),this.map.getResolutionRatio()),K=Math.sqrt(o)*d.BIG_CIRCLES,T=0;T<H;T++){var A=(g?s:F)[T];if(u&&-1==f?u&&(I=B?B[A]:-9999):I=(u?$:z)[A],-9999!=I&&-99999!=I&&-999999!=I&&-8888!=I){var P=this._sqrtValuesToPixels*Math.sqrt(Math.abs(I));if(!(P<1||isNaN(P))){var D,E,N=g?(G=h*l[A],h*c[A]):(G=V[T],U[T]),N=j.transformPoint(G,N),L=(x&&((D=x[L=y*Math.floor(v+N.y*(C/b)/_)+Math.floor(v+N.x*(C/b)/m)])||(x[L]=D=[]),D.push(A)),2*Math.round(P/2)-1);if(u&&-1==f)this._drawPies(w,A,N.x,N.y,L,R,I,S,p,q);else{if(0<=f&&k){if(0==f&&I<0)continue;if(1==f&&0<I)continue}this.assocChMapModel?E=this._img_a[n[A]]["r"+L]:L<K&&Y?E=this._img_a[0<=I?0:1]["r"+L]:(w.beginPath(),w.lineWidth=2,w.strokeStyle=0<=I?p[0]:p[1],X?(L*=W,w.strokeRect(N.x-L,N.y-L,2*L,2*L)):w.arc(N.x,N.y,L,0,2*Math.PI,!1),w.stroke(),w.closePath()),E?w.drawImage(E,N.x-L-a,N.y-L-a):L<K&&Y&&console.log("XXerreur ronds rayon "+L+" demandé",I,L,this._img_a[0<=I?0:1])}}}}w.stroke(),w.closePath();(new Date).getTime()}},onChangeSelection:function(t){var e=this.mapIndicModel,i=this.map.getNbSelObjs();e.getMeta("resizeOnSel")&&(i<5&&e.updateWithDefs({resizeOnSel:!1}),this.map.updTheme(e))},_collectRondsDistribInfo:function(){var t,e,i,n,r=this.mapIndicModel,a=this.ly.topoModel,s="P"==a.getTopology(),o=this.ly.needFullScan()||s,l=a.getPrecisionFactor(),R=a.getCtrX(),k=a.getCtrY(),c=r.getProp("sortedIndices"),h=this.map.getSelIds(),d=r.getMeta("resizeOnSel")&&0<h.length,u=a.getBboxes(),a=(s||(t=u.fminx_a,e=u.fminy_a),r.getProp("VIMods")),p=r.hasMultVars(),g=r.getProp("values"),f=r.getHighlightedMod();if(p&&(i=r.getProp("totValues")),a){var m,_=a.concat();for(m in _)_[m]=r.getProp("idDataset")+"."+_[m];0<=f&&(n=r.getValues(f))}_||(f=-1);var v,a=this.ly.map.getMatrix().invert(),y=a.transformPoint(0,0),a=a.transformPoint(this.ly.map.getWidth(),this.ly.map.getHeight()),b=y.x,C=y.y,F=b+(a.x-y.x),V=C+(a.y-y.y),x=0,w=0,S=this.ly.getNbObjs(),M=[],O=[],U=[],G=0;this.ly.checkCompatibilityWithRefgeo(c.length);for(var I=0;I<S;I++){var T,A,P,$,D,E,N,L=c[I];o?(p&&-1==f?p&&(v=i?i[L]:-9999):v=(p?n:g)[L],-9999==v||-99999==v||-999999==v||-8888==v?x++:(D=!!d&&0<=h.indexOf(L),d&&!D||(E=Math.abs(v),N=N||E,w+=E,0==v?0:G++))):(T=l*t[L],A=l*e[L],P=l*u.fw_a[L],$=l*u.fh_a[L],F<T||T+P<b||V<A||A+$<C||(p&&-1==f?p&&(v=i?i[L]:-9999):v=(p?n:g)[L],-9999==v||-99999==v||-999999==v||-8888==v?x++:(D=!!d&&0<=h.indexOf(L),d&&!D||(E=Math.abs(v),N=N||E,w+=E,0==v?0:G++),T=l*R[L],P=l*k[L],M.push(L),O.push(T),U.push(P))))}a=o?S-x:O.length;return-10<N&&!s?(this._sqrtValuesToPixels=this._getSqrtValuesToPixels(a,o?S:a+x,G,N,w),y=Math.round(this._sqrtValuesToPixels*Math.sqrt(N)),"max"!=r.getMeta("sizeComputation")&&r.setStyleSilent("rdmax",y),"corresp"!=r.getMeta("sizeComputation")&&(r.setStyleSilent("sizeRef",y),r.setStyleSilent("valRef",N))):(this._sqrtValuesToPixels=r.getMeta("rdmax")/Math.sqrt(N),"corresp"==r.getMeta("sizeComputation")&&(this._sqrtValuesToPixels=r.getMeta("sizeRef")/Math.sqrt(r.getMeta("valRef")))),this.lastScreenValmax=N,this.lastserie=r.getMeta("serie"),this.lastnumVisibleRonds=a,r.setStyleSilent("sqrtValuesToSymbRadiusInWorldUnit",this._sqrtValuesToPixels*this.map.getStoWMatrix().a),{ctx_a:O,cty_a:U,cti_a:M,valmax:N,tot:w,numVisibleRonds:a,numNotNullRonds:G}},_getSqrtValuesToPixels:function(t,e,i,n,r){var a,s=this.mapIndicModel,o=this.map.getResolutionRatio();if("corresp"==s.getMeta("sizeComputation"))return s.getMeta("softLockCorresp")&&(h=this.lastScreenValmax&&0!=n?this.lastScreenValmax/n:1,l=0!=t?this.lastnumVisibleRonds/t:1,c=n==s.getMeta("valmax")&&this.lastScreenValmax!=n&&this.lastserie==s.getMeta("serie"),((h<.5||2<h)&&(l<.7||1.3<l)||c)&&s.setStyleSilent("valRef",n)),o*s.getMeta("sizeRef")/Math.sqrt(s.getMeta("valRef"));if("max"==s.getMeta("sizeComputation"))return o*s.getMeta("rdmax")/Math.sqrt(n);"area"==s.getMeta("sizeComputation")&&(h=s.getMeta("resizeOnSel")?(a=1-GCO5.core.GcBitmapUtil.alphaRatio(this.ly.map.getCanvas("mapsel").getContext("2d")),(a*=1+i/1e4)*this.ly.map.getWidth()*this.ly.map.getHeight()):this.ly.map.isFullExtentDisplayed()?(h=this.ly.getBmpFilledAreaPct(),h*=1+i/1e4,l=this.ly.map.getMatrix(),h*Math.min(this.ly.topoModel.params.ly_w_px*l.a,this.ly.map.getWidth())*Math.min(this.ly.topoModel.params.ly_h_px*l.a,this.ly.map.getHeight())*1):(c=this.ly.map.getStatCanvas(),a=GCO5.core.GcBitmapUtil.alphaRatio(c.getContext("2d")),(a*=1+i/1e4)*this.ly.map.getWidth()*this.ly.map.getHeight()),a=0==r?0:Math.sqrt(h/(s.getMeta("areaRatio")*Math.PI*r)));var l=GCO5.browser.width<500?5:8,c=0==n?0:l/Math.sqrt(n),i=200*o,h=(t<20?i=60*o:t<100&&(i=120*o),i=Math.min(10*Math.sqrt(n),i),0==n?0:i/Math.sqrt(n));return Math.min(h,Math.max(c,a))},highlight:function(t,e,i){var n,r,a,s,o,l,c,h,d,u,p,g=this.ly.map.getRovTopThemeCanvas(),f=(GCO5.core.GcBitmapUtil.clearCanvas(g),Math.sqrt(Math.PI/4));null!==t&&((g=g.getContext("2d")).strokeStyle="#f00",g.lineWidth=2,this.assocChMapModel&&this.assocChMapModel.getChoroCodes(),(u=this.mapIndicModel.getStatData())&&(n=this.ly.map.getMatrix(),h=this.mapIndicModel.hasMultVars(),l=this.mapIndicModel.getHighlightedMod(),r=(s=this.ly.topoModel).getPrecisionFactor(),a=s.getCtrX(),s=s.getCtrY(),o="sq"==this.mapIndicModel.getMeta("idSymb"),h&&(c=this.mapIndicModel.getProp("totValues")),0<=l&&(d=this.mapIndicModel.getValues(l)),h&&-1==l?h&&(p=c?c[t]:-9999):p=(h?d:u)[t],-9999==p||-99999==p||-999999==p||-8888==p||(l=this._sqrtValuesToPixels*Math.sqrt(Math.abs(p)))<1||isNaN(l)||(c=r*a[t],h=r*s[t],d=n.transformPoint(c,h),p=(u=1+(l/20>>0))*(l/u>>0),g.beginPath(),o?g.strokeRect(d.x-(p*=f),d.y-p,2*p,2*p):g.arc(d.x,d.y,p,0,2*Math.PI,!1),g.stroke(),g.closePath())))},getValueFromRadius:function(t){var e=this.map.getResolutionRatio();return 0==this._sqrtValuesToPixels?0:Math.round(Math.pow(e*t/this._sqrtValuesToPixels,2))},getRadiusFromValue:function(t){var e=this.map.getResolutionRatio();return 0==this._sqrtValuesToPixels?0:Math.sqrt(t)*this._sqrtValuesToPixels/e},getSerieBitmaps:function(t){var e=this.mapIndicModel,i=e.getProp("animData"),n=(e.getProp("dataSeries",{anim:!0}),this.mapIndicModel.getProp("dataSeriesFromAnimDp")),r=e.getProp("values"),a=(this.clearAnimCanvases(),this._updateCanvasStructure(n.length),this._checkColorBuffer(null,null,!0),this._cv_a[0]),s=this.ly.map.getTopThemeCanvas();GCO5.core.GcDelayUtil.callLater(function(){a.getContext("2d").drawImage(s,0,0)},[],1,this);for(var o=this.mapIndicModel.getProp("serie")==n[n.length-1]?1:0;o<n.length;o++)GCO5.core.GcDelayUtil.callLater(this._getSerieBitmap,[o,r,i],o+2,this);GCO5.core.GcDelayUtil.callLater(this._afterSerieBitmapsBuilt,[t,r],o+2+60,this)},_afterSerieBitmapsBuilt:function(t,e){this._cv_a.reverse(),this._curBmpId=this._cv_a.length-1,this._super()},playAnim:function(t){var e=this.ly.map.getTopThemeCanvas(),i=($(e).hide(),this._cv_a.length,this.ly.map),n=this,r=(i._thmAnimating=!0,1==t&&(this._syncAnimAfterChoro=!0),i.getCanvas("maptransition")),a=i.getCanvas("maptransition1"),s=($(r).css("display","block"),$(a).css("display","block"),$(a).on("webkitTransitionEnd transitionend",{ca:this},this._crossFadeAnimTheme),r.getContext("2d").drawImage(this._cv_a[0],0,0),a.getContext("2d").drawImage(this._cv_a[1],0,0),$(r).css("opacity",1),$(a).css("opacity",0),this.mapIndicModel.getProp("dataSeries",{anim:!0}).concat([]),this.mapIndicModel.getProp("dataSeriesFromAnimDp"));null==this._curBmpId||this._curBmpId==s.length-1?this._curBmpId=1:this._curBmpId++,GCO5.core.GcDelayUtil.callLater(function(){$(i).triggerHandler(GCO5.view.component.MapView.UPD_SERIE,{serie:s[n._curBmpId],mapIndicModel:this.mapIndicModel}),$(r).addClass("cfade"),$(r).css("opacity",0),$(a).addClass("cfade"),$(a).css("opacity",1)},[],100,this),$(i).triggerHandler(GCO5.view.component.MapView.UPD_SERIE,{serie:s[this._curBmpId-1],mapIndicModel:this.mapIndicModel}),this._curSerie=s[this._curBmpId-1]},_crossFadeAnimTheme:function(t){var e,i=t.data.ca,n=i.ly.map,t=i._cv_a.length,r=n.getCanvas("maptransition"),a=n.getCanvas("maptransition1"),s=(i.mapIndicModel.getProp("dataSeries",{anim:!0}).concat([]),i.mapIndicModel.getProp("dataSeriesFromAnimDp"));i._curBmpId==t-1?i._endTransition(i._curBmpId):n._thmAnimating?(e=s[i._curBmpId+1],$(r).removeClass("cfade"),$(a).removeClass("cfade"),$(r).css("opacity",1),$(a).css("opacity",0),i._syncAnimAfterChoro||(GCO5.core.GcBitmapUtil.clearCanvas(r),GCO5.core.GcBitmapUtil.clearCanvas(a)),r.getContext("2d").drawImage(i._cv_a[i._curBmpId],0,0),a.getContext("2d").drawImage(i._cv_a[i._curBmpId+1],0,0),GCO5.core.GcDelayUtil.callLater(function(){$(n).triggerHandler(GCO5.view.component.MapView.UPD_SERIE,{serie:e,mapIndicModel:i.mapIndicModel}),$(r).addClass("cfade"),$(a).addClass("cfade"),$(a).css("opacity",1)},[],50,i),i._curBmpId++):i._endTransition(i._curBmpId,!0)},_endTransition:function(t,e){var i,n=this.ly.map,r=this,a=(r.mapIndicModel.getProp("dataSeries",{anim:!0}).concat([]),r.mapIndicModel.getProp("dataSeriesFromAnimDp")),e=(e||(i=a[t],GCO5.core.GcDelayUtil.callLater(function(){$(n).triggerHandler(GCO5.view.component.MapView.UPD_SERIE,{serie:i,mapIndicModel:r.mapIndicModel})},[],50,this)),n.getTopThemeCanvas());$(e).show(),this._super()},onCloseTimeAnim:function(){var t=this.mapIndicModel.getProp("dataSeriesFromAnimDp"),t=(this._endTransition(t.indexOf(this.mapIndicModel.getProp("serie"))),this.ly.map.getTopThemeCanvas());$(t).show(),this._syncAnimAfterChoro=!1,this._super()},onSerieAnimChange:function(t,e,i){var n,r,a,s=this.ly.map;this.getIndicModel().setSerie(t),this.updateLegendValref(),s._thmAnimating||(n=this.mapIndicModel.getProp("dataSeries",{anim:!0}).concat(),n=this.mapIndicModel.getProp("dataSeriesFromAnimDp"),t!=this._curSerie&&(n=n.indexOf(t),this._curBmpId=n,r=s.getTopThemeCanvas(),a=s.getCanvas("maptransition"),$(r).hide(),$(a).show().css("opacity",1),e||GCO5.core.GcBitmapUtil.clearCanvas(a),a.getContext("2d").drawImage(this._cv_a[n],0,0),i||$(s).triggerHandler(GCO5.view.component.MapView.UPD_SERIE,{serie:t,noSlider:!0,mapIndicModel:this.mapIndicModel}),this._curSerie=t))},_getSerieBitmap:function(t,e,i){var n,r,a=this.mapIndicModel,s=0==a.getProp("idDataset").indexOf("_import"),o=(a.getProp("dataSeries",{anim:!0}).reverse(),a.getProp("dataSeriesFromAnimDp").reverse()),l=s?this._sqrtValuesToPixels:(n=i[o[t]],Array.isArray(n)||(n=n[a.getProp("idIndicateur")]),this._sqrtValuesToPixels/+Math.sqrt(1)),c=[],h=Math.max(1,a.getMeta("epCont")),d=-1,i=this.ly.topoModel,u=i.getPrecisionFactor(),p=i.getCtrX(),g=i.getCtrY(),f=this.ly.getNbObjs();if(s)for(var m=a.getValues(null,o[t]);++d<f;)C=-9999==(r=m[d])||-99999==r||-999999==r||-8888==r?0:Math.sqrt(Math.abs(r))*l,c.push({id:d,v:C,vabs:0<r?C:-C});else for(;++d<f;)C=-9999==(r=n[d])||-99999==r||-999999==r||-8888==r?0:Math.sqrt(Math.abs(r))*l,c.push({id:d,v:0<r?C:-C,vabs:C});c.sort(function(t,e){return e.vabs-t.vabs});for(var _=this._cv_a[t].getContext("2d"),v=(_.globalAlpha=this.mapIndicModel.getProp("fillOpacity")+.1,this.ly.map.getMatrix()),y=(i.getBboxes(),0);y<f;y++){var b,C,x=c[y].id,w=c[y].vabs;w<1||isNaN(w)||(p&&p[x],g&&g[x],b=u*p[x],x=u*g[x],b=v.transformPoint(b,x),C=2*Math.round(w/2)-1,(x=(0<=c[y].v?this._img_a[0]:this._img_a[1])["r"+C])?_.drawImage(x,b.x-C-h,b.y-C-h):console.log("erreur ronds rayon "+C+" demandé"))}},_initRondsBuffer:function(t,e,i){var n=this.mapIndicModel,r=this.map.getResolutionRatio(),a=n.getMeta("idSymb"),s="sp"==a,o="sq"==a,l="cc"==a,c="dq"==a;if(t!=this._bufferCols[e]&&(this._imgMaxRadius_a[e]=1),i=Math.min(r*this.constructor.BIG_CIRCLES,i),this._imgMaxRadius_a[e]>=i-1)return!1;this._lastSymb=a;for(var r=GCO5.core.GcMathUtil.hexToBin(t),h=n.getRondsStrokeColor(r),d=(this._lastEpCont=n.getMeta("epCont"),this._lastCols=h,(new Date).getTime(),this._buffer_cv),u=d.getContext("2d"),p=2*Math.PI,g=(this._bufferCols[e]=t,[]),f=0,m=this._imgMaxRadius_a[e];m<=i;m++){var _=m;10<m&&m%2==0||_!=f&&g.push(f=_)}for(var v,y,b=g.length,C=(s&&(v=GCO5.core.GcMathUtil.binToHex(GCO5.core.GcMathUtil.adjustBrightness2(r,-5)),y=GCO5.core.GcMathUtil.binToHex(GCO5.core.GcMathUtil.adjustBrightness2(r,90))),Math.max(1,n.getMeta("epCont"))),x=Math.sqrt(Math.PI/4),w=0;w<b;w++){m=g[w],d.width=2*(m+C),d.height=2*(m+C);var S=m+C,M=m+C,O=m,G=O*x,I=(s?((I=u.createRadialGradient(.8*m,.8*m,.1*m,.8*m,.8*m,1.3*m)).addColorStop(0,y),I.addColorStop(1,v),u.strokeStyle=h,u.lineWidth=n.getMeta("epCont"),u.fillStyle=I):(u.strokeStyle=h,u.lineWidth=n.getMeta("epCont"),u.fillStyle=t),u.beginPath(),s||l||c?u.arc(S,M,O,0,p):o&&(u.fillRect(S-G,M-G,2*G,2*G),u.strokeRect(S-G,M-G,2*G,2*G)),u.closePath(),u.fill(),u.stroke(),new Image);I.src=d.toDataURL(),this._img_a[e]||(this._img_a[e]={}),this._img_a[e]["r"+m]=I}return this._imgMaxRadius_a[e]=m,!0},_drawPie:function(t,e,i,n,r,a,s,o,l){var c,h,d,u,p=GCO5.core.GcMathUtil.hexToBin(s);o||(GCO5.core.GcMathUtil.binToHex(GCO5.core.GcMathUtil.adjustBrightness2(p,90)),GCO5.core.GcMathUtil.binToHex(GCO5.core.GcMathUtil.adjustBrightness2(p,20)),GCO5.core.GcMathUtil.binToHex(GCO5.core.GcMathUtil.adjustBrightness2(p,10)),c=GCO5.core.GcMathUtil.binToHex(GCO5.core.GcMathUtil.adjustBrightness2(p,-5)),h=GCO5.core.GcMathUtil.binToHex(GCO5.core.GcMathUtil.adjustBrightness2(p,90)),(u=t.createRadialGradient(u=e-1-.2*n,d=i-1-.2*n,.1*n,u,d,1.3*n)).addColorStop(0,h),u.addColorStop(1,c)),t.strokeStyle=GCO5.core.GcMathUtil.binToHex(GCO5.core.GcMathUtil.adjustBrightness2(p,-50)),t.lineWidth=.25,t.fillStyle=o?s:u,t.beginPath(),t.arc(e,i,n,r*Math.PI*2/360,a*Math.PI*2/360),l||t.lineTo(e,i),t.closePath(),t.fill(),t.stroke()},_drawPies:function(t,e,i,n,r,a,s,o,l,c){for(var h=[],d=[],u=-90,p=[],g=0;g<a-1;g++){var f=this.mapIndicModel.getData(o[g])[e];0!=(f=f<0?0:f)&&(f=360*f/s,h.push(u),d.push(f),u+=f,p.push(l[g]))}u<270&&(h.push(u),d.push(Math.max(0,270-u)),p.push(l[a-1]));for(var m=1==(a=h.length),_=0;_<a;_++)this._drawPie(t,i,n,r,h[_],h[_]+d[_],p[_],c,m)}}),GCO5.view.component.SymbFluxThemeView=GCO5.view.component.AThemeView.extend({statics:{NAME:"GCO5.view.component.SymbFluxThemeView",SEUIL_ARROW:5e3,SEUIL_ARROW2:1e5,BENDFACTOR:-.055},_ctxtRov_a:null,_rovFid:null,_multRound:null,_distrib_o:null,initialize:function(t,e){this._super(t,e),this.legend=new GCO5.view.component.MaplegendFlux({map:t.map,thv:this})},draw:function(t){t&&1==t.anim?this._getSerieBitmaps():(t=this._collectSymbDistribInfo(),this._drawSymbs(t))},_isFluxTotallyOutsideMapFrame:function(t,e,i){if(t.containsPoint(e)||t.containsPoint(i))return!1;var n=Math.min(e.x,i.x),r=Math.max(e.x,i.x),a=Math.min(e.y,i.y),e=Math.max(e.y,i.y);if(this.mapIndicModel.getMeta("crossFluxVisibles")&&new GCO5.model.geom.Rectangle(n,a,r-n,e-a).intersects(t))return!1;return!0},_collectSymbDistribInfo:function(){for(var t=this.ly.topoModel,e=(t.getTopology(),this.ly.needFullScan(),t.getPrecisionFactor()),i=this.mapIndicModel.getProp("fluxIndices1"),n=this.mapIndicModel.getProp("fluxIndices2"),r=this.mapIndicModel.getProp("fluxCodes"),a=r.length,s=[],o=[],l=[],c=[],h=[],d=[],u=-1,p=t.getCtrX(),g=t.getCtrY(),f=new GCO5.model.geom.Point,m=new GCO5.model.geom.Point,_=this.ly.map.getMatrix(),v=(this._multRound=a<32e3?8:4,this.ly.needFullScan()),y=new GCO5.model.geom.Rectangle(0,0,this.ly.map.getWidth(),this.ly.map.getHeight()),b=this.indicModel.getProp("ctrX"),C=this.indicModel.getProp("ctrY"),x=this.ly.map.getWtoSMatrix();++u<a;){var w=i[u],S=n[u];if(0<=w){if(f.x=e*p[w],f.y=e*g[w],f=_.transformPoint(f.x,f.y,f),S<0){if(0==b[u]&&0==C[u])continue;m=x.transformPoint(-b[u],-C[u])}else m.x=e*p[S],m.y=e*g[S],m=_.transformPoint(m.x,m.y,m);!v&&this._isFluxTotallyOutsideMapFrame(y,f,m)||(s.push(f.x),o.push(f.y),l.push(m.x),c.push(m.y),h.push(r[u]),d.push(u))}}t=s.length;return this.mapIndicModel.setCalcSilent("numVisibleFlux",t),{ctx_a:s,cty_a:o,ctx2_a:l,cty2_a:c,code_a:h,ids_a:d,numVisibleFlux:t}},_drawSymbs:function(t){var e,i=-1,n=(t&&(this._distrib_o=t),t.ctx_a),r=t.cty_a,a=t.ctx2_a,s=t.cty2_a,o=t.code_a,l=n.length,c=this.mapIndicModel;if(c.getMeta("bending"))return this._drawSymbsBended(t);(!c.getMeta("arrows")||l>=c.getMeta("arrowThreshold"))&&(e=!0);var h=c.getMeta("eps"),d=c.getMeta("alphas"),u=c.getMeta("classesVisibility"),p=c.getMeta("colf"),g=c.getMeta("positionArrows"),f=this.ly.map.getTopThemeCanvas();if(0==this._cv_a.length)for(i=0;i<p.length;i++){var m=GCO5.core.GcBitmapUtil.createCanvas(null,null,f);this._cv_a.push({cv:m,type:"flux"})}for(var _=GCO5.core.GcBitmapUtil.createCanvas(null,null,f),v=[],t=(this._cv_a.forEach(function(t,e){(m=t.cv).width=f.width,m.height=f.height,(G=m.getContext("2d")).imageSmoothingEnabled=!1;t=e<h.length-1?Math.min(4*h[e],h[e+1]-1):4*h[e];v[e]=h[e]<=2?t:h[e]}),i=0,this._cv_a.map(function(t,e){return h[e]<=2?GCO5.core.GcBitmapUtil.createCanvas(null,null,t.cv):null})),y=[],b=(t.forEach(function(t,e){t&&(N=t.getContext("2d")).beginPath(),y.push(t?N:null)}),this._ctxtRov_a=this._cv_a.map(function(t){return t.cv.getContext("2d")})),C=(GCO5.core.GcBitmapUtil.clearCanvas(f),this._multRound),x=256/C,w=x*x,S={};++i<l;)n[i]==a[i]&&r[i]==s[i]||(S[n[i]+"_"+a[i]]?S[n[i]+"_"+a[i]]=S[a[i]+"_"+n[i]]=2:S[n[i]+"_"+a[i]]=S[a[i]+"_"+n[i]]=1);this._distrib_o.dbl_o=S;for(var M,O,G=(f=this.ly.map.getTopThemeCanvas()).getContext("2d"),I=(GCO5.core.GcBitmapUtil.clearCanvas(f),i=-1,0);++i<l;){var T,A=o[i]-1,P=h[A];n[i]==a[i]&&r[i]==s[i]||(T=2==S[n[i]+"_"+a[i]],e||(I=T?1:0),u[A]&&((G=b[A]).fillStyle=(O=M=void 0,"rgb("+C*(M=~~(i/w))+","+C*(O=~~(i%w/x))+","+C*(i-M*w-x*O)+")"),G.beginPath(),this.draw_arrow(G,n[i],r[i],a[i],s[i],v[A],I,e,g),G.fill(),G.closePath(),(N=y[A])&&(e&&T&&(N.fill(),N.closePath(),N.beginPath()),this.draw_arrow(N,n[i],r[i],a[i],s[i],P,I,e,g))))}for(var D=this.mapIndicModel.getMeta("fluxOrder"),E=0;E<b.length;E++){var i="desc"==D?b.length-1-E:E,N=y[i],L=b[i];u[i]&&(N&&(N.fill(),N.closePath()),f.getContext("2d").globalAlpha=parseFloat(d[i]),_.getContext("2d").globalCompositeOperation="source-over",_.getContext("2d").fillStyle=p[i],_.getContext("2d").fillRect(0,0,_.width,_.height),_.getContext("2d").globalCompositeOperation="destination-in",_.getContext("2d").drawImage((N||L).canvas,0,0),N&&GCO5.core.GcBitmapUtil.dropCanvas(N.canvas),f.getContext("2d").drawImage(_,0,0))}GCO5.core.GcBitmapUtil.dropCanvas(_)},draw_arrow:function(t,e,i,n,r,a,s,o,l){var c,h,d,u,p=Math.atan2(r-i,n-e),g=(p<0&&(p+=2*Math.PI),.7*Math.PI/4),f=40,f=25,m=Math.min(Math.max(3,+a),15),_=o?0:8,v=Math.min(2*a,30),y=(Math.abs(r-i)+Math.abs(n-e)<100&&((y=Math.pow(r-i,2)+Math.pow(n-e,2))<1e4&&(f=20,y<1200&&(v=_=0),m=3)),Math.cos(p)),b=Math.sin(p),C=-b,x=y,w=f*Math.cos(p-g),S=f*Math.sin(p-g),M=f*Math.cos(p+g),f=f*Math.sin(p+g);e+=_*y,i+=_*b,n-=_*y,r-=_*b,p>Math.PI/2&&p<3*Math.PI/2&&0==s?(n-=a*C/2,r-=a*x/2,t.moveTo(d=(e-=a*C/2)+a*C,u=(i-=a*x/2)+a*x),t.lineTo(e,i),t.lineTo(n-v*y,r-v*b),t.lineTo(n+.5*a*C,r+.5*a*x),t.lineTo(n+a*C-v*y,r+a*x-v*b),o||"end"===l||(t.lineTo(c=.5*(e+n-v*y)+a*C+m*y,h=.5*(i+r-v*b)+a*x+m*b),t.lineTo(c-=w/2,h-=S/2),t.lineTo(c-=m*y,h-=m*b),t.lineTo(c+=w/2,h+=S/2))):(0!=s?(e-=s*C,i-=s*x,n-=s*C,r-=s*x):(e+=a*C/2,i+=a*x/2,n+=a*C/2,r+=a*x/2),t.moveTo(d=e-a*C,u=i-a*x),t.lineTo(e,i),t.lineTo(n-v*y,r-v*b),t.lineTo(n-.5*a*C,r-.5*a*x),t.lineTo(n-a*C-v*y,r-a*x-v*b),o||"end"===l||(t.lineTo(c=.5*(e+n-v*y)-a*C+m*y,h=.5*(i+r-v*b)-a*x+m*b),t.lineTo(c-=M/2,h-=f/2),t.lineTo(c-=m*y,h-=m*b),t.lineTo(c+=M/2,h+=f/2))),t.lineTo(d,u)},_getRovShapeId:function(t,e){var i=this.ly.map.getTopThemeCanvas(),n=this.mapIndicModel.getMeta("classesVisibility"),i=i.getBoundingClientRect(),r=t-i.left,a=e-i.top,s=this._multRound,o=256/s;if(this._ctxtRov_a)for(var l=0;l<this._ctxtRov_a.length;l++)if(n[l]&&this._ctxtRov_a[l]&&(p=this._ctxtRov_a[l].getImageData(r,a,1,1).data)[0]+p[1]+p[2]+p[3]!=0&&!(p[0]%s||p[1]%s||p[2]%s))return(p[0]*Math.pow(o,2)+p[1]*o+p[2])/s;return null},highlight:function(t,e,i){var n,r,a,s,o,l,c,h,d,u,p,g,f,m,_,v,y,b,C,e=this._getRovShapeId(e,i),i=(this._rovFid=null===e?null:this._distrib_o.ids_a[e],this.ly.map.getRovTopThemeCanvas());return GCO5.core.GcBitmapUtil.clearCanvas(i),null!==this._rovFid&&(n=this._distrib_o.ctx_a,r=this._distrib_o.cty_a,a=this._distrib_o.ctx2_a,s=this._distrib_o.cty2_a,h=this._distrib_o.code_a,l=(o=this.mapIndicModel).getMeta("eps"),g=o.getMeta("alphas"),c=o.getMeta("colf"),d=l[h=h[e]-1],(!this.mapIndicModel.getMeta("arrows")||this._distrib_o.numVisibleFlux>=this.mapIndicModel.getMeta("arrowThreshold"))&&(u=!0),p=0,(i=i.getContext("2d")).globalAlpha=parseFloat(g[h]),g=o.getMeta("positionArrows"),o.getMeta("bending")?(m=f=2<this.ly.map.getMatrix().a?5:0,_=Math.max(10,2*l[h]),v=Math.max(10,3*l[h]),y=(C=(b=o.getMeta("arrows"))&&this._distrib_o.numVisibleFlux>=o.getMeta("arrowThreshold"))?"end":o.getMeta("positionArrows"),b=b,C&&(v=l[h],_=Math.max(12,2*l[h])),i.strokeStyle=i.fillStyle=GCO5.core.GcMathUtil.decalTf(c[h],80),i.lineWidth=l[h],C=o.getBendingFactorAsNum(o.getMeta("bendingFactor")),this.drawBend(i,n[e],r[e],a[e],s[e],C,_,v,!1,b,m,f,y,!0)):(u||(p=2==this._distrib_o.dbl_o[n[e]+"_"+a[e]]?1:0),i.fillStyle=GCO5.core.GcMathUtil.decalTf(c[h],80),i.beginPath(),this.draw_arrow(i,n[e],r[e],a[e],s[e],d,p,u,g),i.fill(),i.closePath())),this._rovFid},_drawSymbsBended:function(t){var i,e=-1,n=t.ctx_a,r=t.cty_a,a=t.ctx2_a,s=t.cty2_a,o=t.code_a,l=n.length,t=this.mapIndicModel,c=t.getMeta("eps"),h=t.getMeta("alphas"),d=t.getMeta("classesVisibility"),u=t.getMeta("colf"),p=this.ly.map.getTopThemeCanvas();if(0==this._cv_a.length)for(e=0;e<u.length;e++){var g=GCO5.core.GcBitmapUtil.createCanvas(null,null,p);this._cv_a.push({cv:g,type:"flux"})}var f,m,_=GCO5.core.GcBitmapUtil.createCanvas(null,null,p),v=(this._cv_a.forEach(function(t,e){(g=t.cv).width=p.width,g.height=p.height,(i=g.getContext("2d")).imageSmoothingEnabled=!1;t=e<c.length-1?Math.min(4*c[e],c[e+1]-1):4*c[e];i.lineWidth=c[e]<=2?t:c[e]}),this._cv_a.map(function(t,e){return c[e]<=2?GCO5.core.GcBitmapUtil.createCanvas(null,null,t.cv):null})),y=[],b=(v.forEach(function(t,e){t&&((L=t.getContext("2d")).lineWidth=c[e],L.strokeStyle=L.fillStyle="#000000",L.beginPath()),y.push(t?L:null)}),this._ctxtRov_a=this._cv_a.map(function(t){return t.cv.getContext("2d")})),C=(GCO5.core.GcBitmapUtil.clearCanvas(p),this._multRound),x=256/C,w=x*x,S=2<this.ly.map.getMatrix().a?5:0,M=S,O=t.getMeta("arrows"),G=O&&l>=t.getMeta("arrowThreshold"),I=G?"end":t.getMeta("positionArrows"),T=t.getBendingFactorAsNum(t.getMeta("bendingFactor"));for(e=-1;++e<l;){var A,P,D,E=o[e]-1;n[e]==a[e]&&r[e]==s[e]||d[E]&&(A=Math.max(10,2*c[E]),P=Math.max(10,3*c[E]),G&&(P=c[E],A=Math.max(12,2*c[E])),(D=b[E]).strokeStyle=D.fillStyle=(m=f=void 0,"rgb("+C*(f=~~(e/w))+","+C*(m=~~(e%w/x))+","+C*(e-f*w-x*m)+")"),this.drawBend(D,n[e],r[e],a[e],s[e],T,A,P,!1,O,M,S,I),(L=y[E])&&this.drawBend(L,n[e],r[e],a[e],s[e],T,A,P,!1,O,M,S,I))}for(var R=this.mapIndicModel.getMeta("fluxOrder"),N=0;N<b.length;N++){var e="desc"==R?b.length-1-N:N,L=y[e],k=b[e];d[e]&&(p.getContext("2d").globalAlpha=parseFloat(h[e]),_.getContext("2d").globalCompositeOperation="source-over",_.getContext("2d").fillStyle=u[e],_.getContext("2d").fillRect(0,0,_.width,_.height),_.getContext("2d").globalCompositeOperation="destination-in",_.getContext("2d").drawImage((L||k).canvas,0,0),L&&GCO5.core.GcBitmapUtil.dropCanvas(L.canvas),p.getContext("2d").drawImage(_,0,0))}GCO5.core.GcBitmapUtil.dropCanvas(_)},drawBend:function(t,e,i,n,r,a,s,o,l,c,h,d,u,p){var g,f,m,_,v,y;u=u||"middle",f=(i+r)/2,y=n-e,_=r-i,f=(m=(e+n)/2+(_/=g=Math.sqrt(y*y+_*_))*(v=a*g))-_*(m=.5*((e-m)*(e-m)+(i-(_=f-(y/=g)*v))*(i-_))/v),v=_+y*m,m=Math.abs(m),_=Math.atan2(i-v,e-f),y=Math.atan2(r-v,n-f),_=(_+2*Math.PI)%(2*Math.PI),y=(y+2*Math.PI)%(2*Math.PI),a<0?_<y&&(_+=2*Math.PI):y<_&&(y+=2*Math.PI),i=s/m*this.sign(a),e=_+=h/m*this.sign(a),r=y-=d/m*this.sign(a),a<0&&_<y||0<a&&y<_||(r-=i,(a<0&&e<r||0<a&&r<e)&&(c=!1,e=_,r=y),"middle"===u&&.5<s/g&&(c=!1,e=_,r=y),t.beginPath(),t.arc(f,v,m,e,r+(c&&"middle"===u?i:0),a<0),t.stroke(),t.beginPath(),c&&("middle"===u&&(r=(y=(_+y)/2+(.2<s/g?1:.5)*s/g*(y-_))-i),t.moveTo(Math.cos(y)*m+f,Math.sin(y)*m+v),t.lineTo(Math.cos(r)*(m-o/2)+f,Math.sin(r)*(m-o/2)+v),t.lineTo(Math.cos(r)*(m+o/2)+f,Math.sin(r)*(m+o/2)+v),t.closePath()),t.fill())},sign:function(t){t=Number(t);return isNaN(t)?NaN:1/t==-1/0?-0:1/t==1/0?0:t<0?-1:0<t?1:void 0},destroy:function(){}}),GCO5.view.component.SymbPointThemeView=GCO5.view.component.AThemeView.extend({statics:{NAME:"GCO5.view.component.SymbPointThemeView",drawCanvasSymb:function(t,e,i,n,r,a,s){s=s||1;s=a?6+.8*Math.sqrt(s)*i:.8*Math.sqrt(s)*i,a||(e.fillStyle=n),i=2*s;return e.beginPath(),"cc"===t?e.arc(r.x,r.y,s,0,2*Math.PI,!1):"ls"===t?GCO5.core.GcD3Util.arrayToCanvasPolygon(e,GCO5.core.GcD3Util.calculateLosangePoints(r.x,r.y,.9*i)):"sq"===t?e.rect(r.x-(s*=.9),r.y-s,i*=.9,i):"cr"===t?GCO5.core.GcD3Util.arrayToCanvasPolygon(e,GCO5.core.GcD3Util.calculateCrossPoints(r.x,r.y,1.25*s)):"st"===t?GCO5.core.GcD3Util.arrayToCanvasPolygon(e,GCO5.core.GcD3Util.calculateStarPoints(r.x,r.y,5,1.3*s,.7*s)):"tr"===t?GCO5.core.GcD3Util.arrayToCanvasPolygon(e,GCO5.core.GcD3Util.calculateTrianglePoints(r.x,r.y,i)):t||(e.fillStyle="#CCC",e.arc(r.x,r.y,s,0,2*Math.PI,!1)),e.stroke(),a||e.fill(),i},getRectSymb:function(t,e){var i=1.6*e,n=i,r=i;return"ls"===t&&(r=n=1.2726*i),"st"===t&&(r=1.2375*i,n=1.175*i),"sq"===t&&(r=n=.9*i),"tr"===t&&(n=.866*i),"cr"===t&&(n=r=1.25*i),"line"===t&&(r=15,n=e),{w:r,h:n}},drawSVGSymb:function(t,e){var i=1.6*e.size,n=i/2;return"ls"===t?GCO5.core.GcD3Util.arrayToSVGPolygon(GCO5.core.GcD3Util.calculateLosangePoints(e.x,e.y,.9*i)):"st"===t?GCO5.core.GcD3Util.arrayToSVGPolygon(GCO5.core.GcD3Util.calculateStarPoints(e.x,e.y,5,1.3*n,.7*n)):"tr"===t?GCO5.core.GcD3Util.arrayToSVGPolygon(GCO5.core.GcD3Util.calculateTrianglePoints(e.x,e.y,i)):"cr"===t?GCO5.core.GcD3Util.arrayToSVGPolygon(GCO5.core.GcD3Util.calculateCrossPoints(e.x,e.y,1.25*n)):void 0}},screen_pt_a:null,nbSelected:null,initialize:function(t,e){this._super(t,e),this.nbSelected=0,this.legend=new GCO5.view.component[e.isSymbDiscr()?"MaplegendChoroNum":"MaplegendVI"]({map:t.map,thv:this})},_addListeners:function(){this.inited},highlight:function(t,e,i,n){var r,a;if(null!=t)return n=n||this.ly.map.getRovTopThemeCanvas(),GCO5.core.GcBitmapUtil.clearCanvas(n),n=n.getContext("2d"),n.strokeStyle="#F00",n.lineWidth=2,r=this.mapIndicModel,a=(r.isSymbDiscr()?r.getChoroCodes():r.getProp("values"))[t],0==a?null:(0<a&&a--,this.constructor.drawCanvasSymb(r.getMeta("symbs")[a],n,r.getMeta("sizes")[a],null,this.screen_pt_a[t],!0,this.map.getResolutionRatio()),n.closePath(),t)},drawSel:function(t){var e,i=this.nbSelected;0==t.length&&(this.nbSelected=0),1==t.length?(e=this.ly.map.getSelCanvas(),$(e).css("display","block"),$(e).css("opacity",1),this.highlight(t[0],null,null,e)):1!=i&&1!=t.length&&this.draw(null,t)},draw:function(t,e){if(!t||1!=t.anim){for(var t=void 0!==e&&0<e.length,i=this.map.getResolutionRatio(),n=this.mapIndicModel,r=this.constructor,a=this.ly.map.getTopThemeCanvas(),s=(GCO5.core.GcBitmapUtil.clearCanvas(a),a.getContext("2d")),o=n.getCurrentHexColors(),l={},c={},h={},a=n.getMeta("classes"),d=n.isSymbDiscr()?n.getChoroCodes():n.getProp("values"),u=n.isSymbDiscr()?n.getMeta("nbClasses"):a.length,p=(h[0]=GCO5.view.component.ChoroThemeView.COL_NA,l[0]="cc",c[0]=5,0),g=0;g<u;g++)h[g+1]=o[g],l[g+1]=n.getMeta("symbs")[g],c[g+1]=n.getMeta("sizes")[g],p+=c[g+1];if(p/=u,t){for(var R=this.screen_pt_a.length,f=0;f<R;f++)0!=(_=d[f])&&(v=this.screen_pt_a[f],y=0<=e.indexOf(f),r.drawCanvasSymb(l[_],s,c[_],y?h[_]:"#f0f0f0",this.screen_pt_a[f],!1,i));return s.closePath(),void(this.nbSelected=e.length)}!t&&this.map.hasSelgeo(this.getLayerName())&&1==(e=this.map.getSelgeo(this.getLayerName()).getSelIds()).length&&GCO5.core.GcDelayUtil.callLater(this.drawSel,[e],1,this);var m,_,v,y,b,C,x=this.mapIndicModel.getMeta("disperseRadius"),a=0<x&&!t,t=this.ly.topoModel,w=t.getPtX(),S=t.getPtY(),M=this.ly.map.getMatrix(),O=(s.lineWidth=1,s.strokeStyle=this.ly.styles.strokeStyle,s.fillStyle=o[0],t.getGrid()),k=O.gd_pasx,F=O.gd_pasy,G=O.gd_ncx,I=GCO5.model.maps.GcTopoModel.DECAL_ROV_GRID,V=G+I,T=O.gd_a=[],G=t.getPrecisionFactor(),A=G,P=G,D={},E={},N=[];if(a){for(var L,U,f=0,R=w.length;f<w.length;f++)0!=d[f]&&(L=String(w[f]>>0)+"|"+String(S[f]>>0),N[f]=f,void 0===D[L]?D[L]=[f]:(U=!0,D[L][D[L].length-1],D[L].push(f),E[L]=D[L]));if(U){for(var f in x||n.setStyleSilent("rDisperse",x=Math.ceil(p)+1),w=w.concat(),S=S.concat(),E){var $=E[f];$.length<50&&this._disperser(x,M.a,$,w,S)}t.setNewCoordinates(w,S)}N.sort(function(t,e){return t-e})}else N=w.map(function(t,e){return e});for(m in this.screen_pt_a=[],N)0!=(_=d[f=Math.abs(N[m])])&&(v=this.screen_pt_a[f]=M.transformPoint(w[f],S[f]),y=!(e&&1<e.length)||0<=e.indexOf(f),r.drawCanvasSymb(l[_],s,c[_],y?h[_]:"#f0f0f0",v,void 0,i),(C=T[b=V*Math.floor(I+v.y*(P/A)/F)+Math.floor(I+v.x*(P/A)/k)])||(T[b]=C=[]),C.push(f));s.closePath()}},_disperser:function(t,e,i,n,r,a){var s=i.length,o=o||10;if(a=a||400,0!=s){for(var l,o=2*((t=2==s&&6<=t?3:t)-1),c=0,h=0,d=6,u=(d=6,i[0]),p=n[u],g=r[u];h<s;){h+=d,c++;var f=Math.sin(Math.PI/d),d=Math.PI/Math.asin(f*c/(c+1))}for(d=1,h=0;h<s;)for(var h=0,m=++d,_=1;_<=c;_++)h+=m,m=Math.PI/Math.asin(_/(_+1)*Math.round(1e3*Math.sin(Math.PI/m))/1e3);l=(o+1)*(2*c)<=a?o+1:(a-o)/c,l/=e;for(var v=h=0,_=1;_<=c;_++){for(var y=1==_?d:_==c?s-h:Math.PI/Math.asin((_-1)/_*Math.round(1e3*Math.sin(Math.PI/y))/1e3),b=1;b<=y;b++)u=i[v++],6<s&&s<12&&1==_?(n[u]=p+l*(_+1)/3*Math.cos(Math.PI/2+2*b*Math.PI/y),r[u]=g+l*(_+1)/3*Math.sin(Math.PI/2+2*b*Math.PI/y)):(n[u]=p+l*_*Math.cos(Math.PI/2+2*b*Math.PI/y),r[u]=g+l*_*Math.sin(Math.PI/2+2*b*Math.PI/y));h+=y}}},destroy:function(){this.screen_pt_a=null}}),GCO5.view.component.SymbLineThemeView=GCO5.view.component.AThemeView.extend({statics:{NAME:"GCO5.view.component.SymbLineThemeView"},initialize:function(t,e){this._super(t,e),this.legend=new GCO5.view.component.MaplegendVI({map:t.map,thv:this})},_addListeners:function(){this.inited},highlight:function(t,e,i,n){return n=n||this.ly.map.getRovTopThemeCanvas(),this.draw(null,t,n),t},draw:function(t,e,i){this.map.getResolutionRatio();t&&t.anim},destroy:function(){}}),GCO5.view.component.SymbOursinThemeView=GCO5.view.component.AThemeView.extend({statics:{NAME:"GCO5.view.component.SymbOursinThemeView"},initialize:function(t,e){this._super(t,e),this.legend=new GCO5.view.component.MaplegendOursins({map:t.map,thv:this})},_addListeners:function(){this.inited},_collectSymbDistribInfo:function(){for(var t=this.ly.topoModel,e=(t.getTopology(),t.getPrecisionFactor()),i=this.indicModel.getProp("indices"),n=this.ly.getNbObjs(),r=[],a=[],s=[],o=[],l=t.getCtrX(),c=t.getCtrY(),h=new GCO5.model.geom.Point,d=new GCO5.model.geom.Point,u=this.ly.map.getMatrix(),p=new GCO5.model.geom.Rectangle(0,0,this.ly.map.getWidth(),this.ly.map.getHeight()),g=this.indicModel.getProp("ctrX"),f=this.indicModel.getProp("ctrY"),m=this.ly.map.getWtoSMatrix(),_=0;_<n;_++){var v=i[_];if(v!=_){if(v<0){if(0==g[_]&&0==f[_])continue;d=m.transformPoint(-g[_],-f[_])}h.x=e*l[_],h.y=e*c[_],h=u.transformPoint(h.x,h.y,h),0<=v&&(d.x=e*l[v],d.y=e*c[v],d=u.transformPoint(d.x,d.y,d)),this._isFluxTotallyOutsideMapFrame(p,h,d)||(r.push(h.x),a.push(h.y),s.push(d.x),o.push(d.y))}}t=r.length;return this.mapIndicModel.setCalcSilent("numVisibleFlux",t),{ctx_a:r,cty_a:a,ctx2_a:s,cty2_a:o,numVisibleFlux:t}},draw:function(t){var e;t&&1==t.anim||(e=this.ly.needFullScan()?null:this._collectSymbDistribInfo(),this._drawSymbs(t,e))},_isFluxTotallyOutsideMapFrame:function(t,e,i){if(t.containsPoint(e)||t.containsPoint(i))return!1;var n=Math.min(e.x,i.x),r=Math.max(e.x,i.x),a=Math.min(e.y,i.y),e=Math.max(e.y,i.y);return!new GCO5.model.geom.Rectangle(n,a,r-n,e-a).intersects(t)},_drawSymbs:function(t,e){if(!t||1!=t.anim){t&&t.colf&&this.mapIndicModel.updateWithDefs({col:[t.colf]});var i,n,r,a,t=this.ly.topoModel,s=t.getPrecisionFactor(),o=this.ly.map.getTopThemeCanvas(),l=(GCO5.core.GcBitmapUtil.clearCanvas(o),o.getContext("2d")),o=this.ly.getNbObjs(),c=t.getCtrX(),h=t.getCtrY(),d=this.indicModel.getProp("indices"),u=this.ly.map.getMatrix(),p=this.ly.needFullScan(),g=this.mapIndicModel.getMeta("colf"),f="P"==t.getTopology();l.strokeStyle=g[0].hasOwnProperty("col")?g[0].col:g[0],l.lineWidth=this.mapIndicModel.getMeta("epCont"),l.beginPath();for(var m=(e?e.numVisibleFlux:o)<250,_=(l.fillStyle=l.strokeStyle,new GCO5.model.geom.Point),v=new GCO5.model.geom.Point,y=e?e.ctx_a.length:o,b=this.indicModel.getProp("ctrX"),C=this.indicModel.getProp("ctrY"),x=this.ly.map.getWtoSMatrix(),w=0;w<y;w++){var S=p?d[w]:null;if(S!=w){if(p){if(S<0){if(0==b[w]&&0==C[w])continue;v=x.transformPoint(-b[w],-C[w])}r=s*c[w],a=s*h[w],i=s*c[S],n=s*h[S]}else _.x=e.ctx_a[w],_.y=e.cty_a[w],v.x=e.ctx2_a[w],v.y=e.cty2_a[w];p&&(_=u.transformPoint(r,a),0<=S&&(v=u.transformPoint(i,n))),l.moveTo(_.x,_.y),l.lineTo(v.x,v.y),m&&l.arc(v.x,v.y,1,0,2*Math.PI)}}if(l.stroke(),l.closePath(),m){l.beginPath();for(w=0;w<y;w++)(S=p?d[w]:null)<0||(p?(r=s*c[w],a=s*h[w],i=s*c[S],n=s*h[S]):(_.x=e.ctx_a[w],_.y=e.cty_a[w],v.x=e.ctx2_a[w],v.y=e.cty2_a[w]),p&&(_=u.transformPoint(r,a),v=u.transformPoint(i,n)),GCO5.core.GcBitmapUtil.drawEndArrow(l,v,_));l.fill(),l.stroke(),l.closePath()}if(f)for(var M,O,g=t.getGrid(),G=g.gd_pasx,I=g.gd_pasy,o=g.gd_ncx,T=GCO5.model.maps.GcTopoModel.DECAL_ROV_GRID,A=o+T,P=s,D=s,E=g.gd_a=[],w=0;w<y;w++)(S=p?d[w]:null)!=w&&(p?(r=s*c[w],a=s*h[w]):(_.x=e.ctx_a[w],_.y=e.cty_a[w]),p&&(_=u.transformPoint(r,a)),E&&((O=E[M=A*Math.floor(T+_.y*(D/P)/I)+Math.floor(T+_.x*(D/P)/G)])||(E[M]=O=[]),O.push(w)),l.beginPath(),l.arc(_.x,_.y,2.5,0,2*Math.PI,!1),l.stroke(),l.closePath())}},highlight:function(t,e,i){var n,r,a,s,o,l,c=this.ly.map.getRovTopThemeCanvas();GCO5.core.GcBitmapUtil.clearCanvas(c),null!==t&&(this.mapIndicModel.getMeta("colf"),l=this.indicModel.getProp("indices"),(c=c.getContext("2d")).strokeStyle="#00f",c.lineWidth=2,n=this.ly.map.getMatrix(),s=(o=this.ly.topoModel).getPrecisionFactor(),a=o.getCtrX(),o=o.getCtrY(),l=l[t],r=s*a[t],t=s*o[t],a=s*a[l],s=s*o[l],o=n.transformPoint(r,t),l=n.transformPoint(a,s),c.beginPath(),c.moveTo(o.x,o.y),c.lineTo(l.x,l.y),c.stroke(),c.closePath())},destroy:function(){}}),GCO5.view.component.EtiqThemeView=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.EtiqThemeView",SPIRAL_A:[],NB_ETIQS_MAX:150,ETIQ_WIDTH:200,ETIQ_HEIGHT:50},ly:null,mapIndicModel:null,disabled:null,isEtiq:!0,decaltxt_a:null,debug:null,nbEtiqs:null,dragx:null,dragy:null,txt_a:null,txt_o:null,lastTransformMt:null,etiqIds:null,initialize:function(t,e){if(this.ly=t,this.mapIndicModel=e,this.txt_o={},0==this.constructor.SPIRAL_A.length){for(var i=-15;i<=15;i++)for(var n=-15;n<=15;n++)this.constructor.SPIRAL_A.push({i:i,j:n,d:i*i+n*n,i0:15,j0:15});this.constructor.SPIRAL_A.sort(function(t,e){return t.d-e.d})}},setStyles:function(t){this.styles=t},getStyles:function(t){return this.styles},draw:function(t,e,i,n,r){var a;"DR"==this.ly.getTopology()&&this.styles&&this.styles.indic1Id&&(a=this.ly.map.getEnabledIndicsModelsIndexed(),1==GCO5.core.GcObjectUtil.count(a)&&a[this.styles.indic1Id]||(this.styles.indic1Id=null,this.styles.indic1=!1,e=null)),this.disabled||("P"==this.ly.getTopology()?this.drawPtEtiqs():this.ly.isPolygon()&&this.drawPgEtiqs(t,e,i,n,r))},isEnabled:function(){return!this.disabled},enable:function(t,e,i){this.disabled=!1,this.draw(t,null,null,e,i)},disable:function(){this.clear(),this.disabled=!0},getModel:function(){return this.mapIndicModel},dragmove:function(){var e=d3.event.sourceEvent.offsetX-this.dragx,i=d3.event.sourceEvent.offsetY-this.dragy;d3.select(this).attr("transform",function(t){return"translate("+e+","+i+")"})},dragstart:function(){console.log("dragstartXX",this),this.dragx=d3.event.sourceEvent.offsetX,this.dragy=d3.event.sourceEvent.offsetY},_collectEtiqDistribInfo:function(){for(var t=this.ly.topoModel,e=this.styles.etiqIds,i=this.styles.selOnly,n=(t.getCtrX(),t.getCtrY(),this.ly.map.getMatrix()),r=t.getPrecisionFactor(),a=t.getBboxes(),t=n.invert(),n=t.transformPoint(0,0),t=t.transformPoint(this.ly.map.getWidth(),this.ly.map.getHeight()),s=n.x,o=n.y,l=s+(t.x-n.x),c=o+(t.y-n.y),h=a.fminx_a,d=a.fminy_a,u=this.ly.getNbObjs(),p=[],g=[],f=[],m=0;m<u;m++){var _=r*h[m],v=r*d[m],y=r*a.fw_a[m],b=r*a.fh_a[m];l<_||_+y<s||c<v||v+b<o||i&&e&&e.indexOf(m)<0||(p.push(m),g.push(_+y/2),f.push(v+b/2))}return{ctx_a:g,cty_a:f,cti_a:p,numVisibleEtiqs:p.length}},_isStyleChanging:function(t){return 0<=["colf","italic","halo","no_overlap"].indexOf(t)},_getEtiqText:function(t){var e=this.ly.topoModel,i=e.getLibgeos(),e=e.getCodgeos(),e=this.styles.codgeo?e[t]:"";return e+=this.styles.libgeo?(""!=e?" - ":"")+i[t]:"",this.styles.indic1&&(e+=(""==e?"":"|")+this.ly.getAllThemesDataById(t,!1,!1)[0].value.split("&nbsp;").join(" ").split("<br>").join("|")),this.styles.indic2&&(e+=(""==e?"":"|")+this.ly.getAllThemesDataById(t,!1,!1)[1].value.split("&nbsp;").join(" ").split("<br>").join("|")),e=this.styles.capitals?e.toUpperCase():e},drawPgEtiqs:function(t,e,i,n,r){if(this.ly.map.hasTranslated()||(this.txt_o={},$(this.ly.map.getCanvas("mapsvgetiq")).hide()),i)$(this.ly.map.getCanvas("mapsvgetiq")).show();else{var a=this.ly.topoModel,s=this,o=(a.getCtrX(),a.getCtrY(),a.getLibgeos().concat(),this.ly.map.getMatrix()),i=this.ly.map.getResolutionRatio(),l=(a.getPrecisionFactor(),this.styles.fontSize),c=(this.nbPoly=this.nbText=this.nbPolyText=0,2==i&&(l/=this.lastTransformMt.a/this.ly.map._transformMt.a),this._collectEtiqDistribInfo()),h=this.nbEtiqs=c.cti_a.length;if(h>this.constructor.NB_ETIQS_MAX)return n&&r&&n.call(r,{code:"EXCESS",nbObjs:h}),0==this.ly.map._getCityLayers().length&&GCO5.core.GcDelayUtil.callLater(this.ly.map.addLayer,[{name:"V"}],10,this.ly.map),this.clear(),void(this.nbEtiqs=-1);this._isStyleChanging(t)||(this.styles.codgeo&&this.styles.libgeo,this.txt_a=c.cti_a.map(function(t,e){var i=o.transformPoint(c.ctx_a[e],c.cty_a[e]),n=s._getEtiqText(t);return{tests:0,visible:!0,decalTxt:{x:0,y:0},txt:n,x:i.x,y:i.y,txt0:n,cx:i.x,cy:i.y,fid:t,id:e}}));var a=this.ly.map._transformMt,d=document.createElement("canvas"),h=document.createElement("canvas"),u=(this.cvetiqMeasure=document.createElement("canvas"),h.width=this.constructor.ETIQ_WIDTH,h.height=this.constructor.ETIQ_HEIGHT,h.getContext("2d")),h=(u.font=(this.styles.italic?"italic ":"")+(this.styles.bold?"bold ":"")+i*l+"px arial",u.textAlign="center",this.cvetiqMeasure.width=this.constructor.ETIQ_WIDTH,this.cvetiqMeasure.height=this.constructor.ETIQ_HEIGHT,this.cvetiqMeasure.getContext("2d")),h=(h.font=(this.styles.italic?"italic ":"")+(this.styles.bold?"bold ":"")+i*l+"px arial",h.textAlign="center",(new Date).getTime()),p=[];if(this.styles.opti&&!this._isStyleChanging(t))for(var g=this.txt_a.concat(),f=this.txt_a.length;0<f;){var m=2;f-=10,GCO5.core.GcDelayUtil.callLater(function(){g.splice(0,10).forEach(function(t,e){p[e]=s._adjustEtiq(t.id,t.txt0,a,d,u,l)})},[],m+=2,this)}GCO5.core.GcDelayUtil.callLater(this._drawSVGTexts,[p,i,l,h,n,r],m+1,this),2!=i&&(this.lastTransformMt=this.ly.map._transformMt)}},_drawPoly:function(e,t,i,n,r,a,s,o){a=a||1;var l=i.a,c=(n.width=l*r.width,n.height=l*r.height,n.getContext("2d")),o=(o<2&&0,6<o&&0,10<o&&0,20<o&&0,!1),h=(i=i.clone()).transformPoint(r.x,r.y),d=h.x+l*r.width-this.ly.map.getWidth(),u=h.y+l*r.height-this.ly.map.getHeight(),p=0,g=0,f=0,m=0;if((h.y<0||0<u||h.x<0||0<d)&&((v=(h.x<0?-h.x:0)+(0<d?d:0))&&(n.width-=v),(v=(h.y<0?-h.y:0)+(0<u?u:0))&&(n.height-=v),p=(f=h.x<0?-h.x:0)-(0<d?d:0),g=(m=h.y<0?-h.y:0)-(0<u?u:0),o=!0),i.translate(-h.x-f,-h.y-m),i.applyToCanvasContext(c),this.ly._drawPolyAt(t,c,{fill:"rgba(255,0,0,"+a+")"}),0==n.width||0==n.height)return this.txt_a[e].visible=!1,n;if(o){var _=GCO5.core.GcBitmapUtil.alphaBbox(c);if(0==_.width||0==_.height)return this.txt_a[e].visible=!1,n;var v=document.createElement("canvas");v.width=_.width,v.height=_.height;try{v.getContext("2d").drawImage(n,_.x,_.y,_.width,_.height,0,0,_.width,_.height)}catch(t){console.log("erreur cropped",_.x,_.y,_.width,_.height,this.txt_a[e].txt)}p+=2*_.x-n.width+_.width,g+=2*_.y-n.height+_.height,c=(n=v).getContext("2d"),r.width=_.width/l,r.height=_.height/l}return 0==n.width||0==n.height?this.txt_a[e].visible=!1:(this.txt_a[e].tr_x=p,this.txt_a[e].tr_y=g,this.txt_a[e].bboxCropped=_,this.txt_a[e].polyCropped=o,this.txt_a[e].polyPixels=GCO5.core.GcBitmapUtil.alphaRatio(c,!0),this.txt_a[e].polyAlphaRatio=Math.round(100*this.txt_a[e].polyPixels/(n.width*n.height))/100,c.globalCompositeOperation="destination-out",this.nbPoly++),n},_drawText:function(t,e,i,n,r){var a=e.canvas.width,s=e.canvas.height,o=(e.clearRect(0,0,a,s),this.nbText++,t.split("|")),l=o.length;if(e.lineWidth=6+(this.opti?0:-2),e.lineCap="round",e.lineJoin="round",1==l)e.fillText(t,a/2,s/2+2),e.strokeText(t,a/2,s/2);else for(var c=this.styles.fontSize,h=-(l-1)/2*c,d=0;d<l;d++)e.fillText(o[d],a/2,s/2+h+2),e.strokeText(o[d],a/2,s/2+h+2),h+=c},_adjustEtiq:function(t,e,i,n,r,a,s,o){for(var l=this.txt_a[t].fid,c=this.ly._getRectFid(l),h=e.split("|"),d=0,u=c.width*i.a,p=c.height*i.a,g=0;g<h.length;g++)var f=this.cvetiqMeasure.getContext("2d").measureText(h[g]),d=Math.max(d,f.width);var m=this.ly.map.getResolutionRatio(),m=(r.canvas.width=d+10,r.canvas.height=h.length*(a+1)+10,r.font=(this.styles.italic?"italic ":"")+(this.styles.bold?"bold ":"")+m*a+"px arial",r.textAlign="center",a*e.split("|").length),u=Math.min((u-d)/2,(p-m)/2),p=(s||(n=this._drawPoly(t,l,i,n,c,1,s&&!o,u)),this._drawText(e,r,a,l),GCO5.core.GcBitmapUtil.alphaRatio(r,!0));if(this.txt_a[t].txtPixels=p,!s&&this.txt_o[l]&&!this.txt_o[l].polyCropped&&!this.txt_a[t].polyCropped&&this.txt_a[t].visible)return this.txt_a[t].decalTxt=this.txt_o[l].decalTxt,this.txt_a[t].score=this.txt_o[l].score,void(this.txt_a[t].txt=this.txt_o[l].txt);o=this._getNbPixelsTextOutsidePoly(r.canvas,n,0,0,d,m,t),u=Math.round(1e3*(p-o)/p)/10;return this.txt_a[t].score=u/100,this.opti=this.nbEtiqs<35||this.styles.opti2&&this.nbEtiqs<150,(u<100||this.nbEtiqs<200)&&this._adjustEtiq2(l,t,e,d,m,c,i,n,r,a,p,o,s),u},_adjustEtiq2:function(R,t,e,i,n,r,a,s,o,l,c,h,d){var u,p,n=l*e.split("|").length,g=this.constructor.SPIRAL_A,f=(r.width*a.a-i)/2,m=(r.height*a.a-n)/2,_=(this.txt_a[t].ratioTxtPoly=this.txt_a[t].txtPixels/this.txt_a[t].polyPixels,1),k=(this.txt_a[t].ratioTxtPoly<.1&&100<Math.min(f,m)&&(_=2),(.4<this.txt_a[t].ratioTxtPoly||Math.max(f,m)<25||this.txt_a[t].polyAlphaRatio<.4)&&(_=0),this.txt_a[t].ease=_=0==_&&35<f&&35<m?1:_,this.txt_a[t].pass=d||"0",S=d?(w=10,5):(w=15,1==_?8:2==_?50:4),(u=f/w)<S&&(u=S),Math.ceil(f/u)),v=m/w,F=(v<S&&(v=S),Math.ceil(m/v)),y=(this.txt_a[t].dx=u,this.txt_a[t].dy=v,this.txt_a[t].txtBBMargin=Math.min(f,m),(c-h)/c),b=-1,C=0,x=0,w=0,S=0,M=0,V={},O={c:[],si:0,sj:0},G=0,I=[O],T=0;for(p in g){var A=g[p],P=!1;if(!(Math.abs(A.i)>k||Math.abs(A.j)>F)){var D=1-(0==A.i&&0==A.j?h:this._getNbPixelsTextOutsidePoly(o.canvas,s,A.i*u,A.j*v,i,n,t))/c;if(T++,.98<D){if(x++,0<C){var E=O.c.length;if(5<(M=Math.pow(A.i-O.si/E,2)+Math.pow(A.j-O.sj/E,2)))for(var N=0;N<E;N++){var L=O.c[N];if(Math.pow(A.i-L.i,2)+Math.pow(A.j-L.j,2)<3){M=0;break}}if(5<M){if(P=!0,1<I.length)for(N=0;I.length,N!=G;N++){var U=I[N].si/I[N].c.length,$=I[N].sj/I[N].c.length;if(Math.pow(A.i-U,2)+Math.pow(A.j-$,2)<5){O=I[G=N],P=!1;break}}0<I.length&&P&&(I.push(O={c:[],si:0,sj:0}),G=I.length-1)}}O.si+=A.i,O.sj+=A.j,O.c.push({x:A.i*u,y:A.j*v,i:A.i,j:A.j}),V[A.i+"|"+A.j]=1,C++}if(y<=D&&(y=D,b=p,!this.opti)){if(T>(this.nbEtiqs<50?20:12))break;if(x>(this.nbEtiqs<50?6:3))break}if(this.txt_a[t].polyCropped,O.c.length>=(2==_?20:1==_||20<Math.max(f,m)?this.nbEtiqs<50?15:10:5)||T>(this.txt_a[t].polyAlphaRatio<=.3?300:this.txt_a[t].polyAlphaRatio<=.4?200:0==_?130:100)||T>(this.nbEtiqs<35?80:this.txt_a[t].polyAlphaRatio<=.4?70:40)&&0<C||T>(this.nbEtiqs<35?30:20)&&C>=(this.nbEtiqs<35?12:6))break}}0<I.length&&(I.sort(function(t,e){return e.c.length-t.c.length}),w=(A=I[0]).si,S=A.sj,C=A.c.length,this.txt_a[t].clusters=I),1<=C?this.txt_a[t].decalTxt={x:Math.round(w/C)*u+this.txt_a[t].tr_x/2,y:Math.round(S/C)*v+this.txt_a[t].tr_y/2}:0<=b&&(A=g[b],this.txt_a[t].decalTxt={x:A.i*u+this.txt_a[t].tr_x/2,y:A.j*v+this.txt_a[t].tr_y/2}),this.txt_a[t].score=y,this.txt_a[t].score0=C,this.txt_a[t].score1=x;w=0<e.indexOf(" ")||0<e.indexOf("-");!d&&(y<.95||(w||this.opti)&&y<.99)&&(w?(this._adjustEtiq3(R,t,e,i,r,a,s,o,l),this.txt_a[t].score<y&&this._adjustEtiq(t,this.txt_a[t].txt=this.txt_a[t].txt0,a,s,o,l,2)):this._adjustEtiq(t,e,a,s,o,l,2))},_adjustEtiq3:function(t,e,i,n,r,a,s,o,l){var c=i.split("-"),h=!(c.length<=3)&&4==c.length?c[0]+"-"+c[1]+"-|"+c[2]+"-"+c[3]:i.split("-").join("-|");h=(h=(h=(h=(h=1==c.length?i.split(" ").join("|"):h).split("Haut").join("Ht")).split("Territoire").join("T.")).split("Saint-").join("St-")).split("Sainte-").join("Ste-"),this.txt_a[e].decalTxt={x:0,y:0},this.txt_a[e].txt=h,this._adjustEtiq(e,h,a,s,o,l,2,!0)},_getNbPixelsTextOutsidePoly:function(t,e,i,n,r,a,s,o){i=i||0,n=n||0;var l=t.width,c=t.height;r+=10,a+=15;var h=GCO5.core.GcBitmapUtil.cloneCanvas(t).getContext("2d"),d=(o||(h.globalCompositeOperation="destination-out"),e.width/2-r/2+i),u=e.height/2-a/2+n,p=r,g=a,r=(l-r)/2,a=(c-a)/2;o&&(u=d=0,p=e.width,g=e.height,r=l/2-e.width/2-i,a=c/2-e.height/2-n),d<0&&(p+=d,d=0),u<0&&(g+=u,u=0),d+p>e.width&&(p=e.width-d),u+g>e.height&&(g=e.height-u);try{h.drawImage(e,d,u,p,g,r,a,p,g)}catch(t){console.log("ERREUR","fid",this.txt_a[s].fid,d,u,p,g,r,a,this.txt_a[s].txt)}this.nbPolyText++,this.txt_a[s].tests++;l=GCO5.core.GcBitmapUtil.alphaRatio(h,!0);return o&&(GCO5.core.GcBitmapUtil.debugCanvas(h.canvas,!0),GCO5.core.GcBitmapUtil.debugCanvas(t,!0),console.log("debug",i,n,l,h.globalCompositeOperation,d,u,p,g,r,a)),l},wrapDelims:function(t,o,l){t.each(function(){var t,e=d3.select(this),i=e.text().split(o).reverse(),n=0,r=l,a=e.attr("x");e.attr("y");if(1<i.length){e.text(null);for(var s=-(i.length-1)/2*r;t=i.pop();)e.append("tspan").attr("x",a).attr("dy",(0==n?s:r)+"px").text(t),n++}})},_displayControlFid:function(t,e,i,n,r,a,s,o){for(var l=this.txt_a[t].fid,c=this.ly._getRectFid(l),h=(a=a||this.txt_a[t].txt,this._drawText(a,e,i),a.split("|")),d=0,u=0;u<h.length;u++)var p=e.measureText(h[u]),d=Math.max(d,p.width);i*=a.split("|").length,d+=10,i+=10,this._drawPoly(t,l,r,n,c,.3),a=GCO5.core.GcBitmapUtil.cloneCanvas(e.canvas),l=a.getContext("2d");l.globalCompositeOperation="source-over",void 0===s&&(s=this.txt_a[t].decalTxt.x),void 0===o&&(o=this.txt_a[t].decalTxt.y),l.drawImage(n,n.width/2-d/2+s,n.height/2-i/2+o,d,i,(200-d)/2,(50-i)/2,d,i),l.globalCompositeOperation="destination-out",GCO5.core.GcBitmapUtil.debugCanvas(a,!0)},drawPtEtiqs:function(){for(var t=this.ly.topoModel,e=t.getPtX(),i=t.getPtY(),n=t.getLibgeos(),r=(this.ly.getNbObjs(),t.getPrecisionFactor()),t=this.ly.map.getMatrix().invert(),a=t.transformPoint(0,0),t=t.transformPoint(this.ly.map.getWidth(),this.ly.map.getHeight()),s=a.x,o=a.y,l=t.x-a.x,c=t.y-a.y,h=GCO5.browser.isAndroid?"sans-serif":GCO5.browser.isIOS?"Helvetica Neue, Helvetica":"Open Sans, Arial",d=GCO5.browser.isAndroid||GCO5.browser.isIOS?"":"700",u=500<this.ly.map.getWidth()?this.ly.map.getPrintMode()&&2==this.ly.map.getPrintMapScaleRatio()?"1.6":"0.8":300<this.ly.map.getWidth()?"0.8":"0.7",p=GCO5.browser.isAndroid||GCO5.browser.isIOS?"#0":"#333",g=this.ly.map._etiqStage,e=[0].concat(e),i=[-9999.9].concat(i),n=["+"].concat(n),f=0;f<n.length;f++){var m,_,v=r*e[f],y=r*i[f];-9999.9!=i[f]&&(s+l<v||v<s||o+c<y||y<o)||(_="t",1==(m=(m=n[f])||"").indexOf("@")&&(_=m.substr(0,1),m=m.substr(2)),m=m.split("|").join("\n"),(m=new GCO5.view.display.Text(m,d+" "+u+"em "+h,p,!0)).etiqAlign=_,m.textAlign="t"==_||"b"==_?"center":"r"==_?"left":"right",-9999.9==i[f]&&(m.color=this.ly.map.getStyle("colbg"),m.halo=!1),m.offsetX=8,m.offsetY=5,_=this.ly.map.getMatrix().transformPoint(v,y),m.x=_.x,m.y=_.y,g.addChild(m))}g.update()},_drawSVGTexts:function(i,n,r,t,e,a){e&&a&&e.call(a,{code:"OK"});var s=this,e=this.ly.map.getCanvas("mapsvgetiq"),o=(d3.drag().on("start",this.dragstart).on("drag",this.dragmove),$(e).show(),this.txt_a.filter(function(t){return t.visible&&(!s.styles.no_overlap||!s.styles.opti||.7<=t.score)})),a=(this.nbEtiqs=o.length,d3.select(e).selectAll(".pg-etiqs0").data(o,function(t,e){return t.fid})),a=(a.enter().append("text").attr("class","pg-etiqs0").attr("data-pk",function(t,e){return e}).attr("text-anchor","middle").merge(a).attr("x",function(t,e){return t.x/n+(o[e].decalTxt.x?o[e].decalTxt.x/n:0)}).attr("y",function(t,e){return t.y/n+(o[e].decalTxt.y?o[e].decalTxt.y/n:0)}).each(function(t,e){d3.select(this).attr("fill","white"),d3.select(this).style("stroke","white"),d3.select(this).style("stroke-width",.3*r+"px")}).text(function(t){return s.styles.halo?t.txt:""}).style("font-size",r+"px").style("font-weight",s.styles.bold?"bold":"normal").style("font-style",s.styles.italic?"italic":"normal").style("opacity","0.8").call(this.wrapDelims,"|",r),a.exit().remove(),d3.select(e).selectAll(".pg-etiqs").data(o,function(t){return t.fid})),e=(a.enter().append("text").attr("class","pg-etiqs").attr("data-pk",function(t,e){return e}).attr("text-anchor","middle").merge(a).attr("x",function(t,e){return t.x/n+(o[e].decalTxt.x?o[e].decalTxt.x/n:0)}).attr("y",function(t,e){return t.y/n+(o[e].decalTxt.y?o[e].decalTxt.y/n:0)}).each(function(t,e){s.debug&&0<i.length?d3.select(this).attr("fill",i[e]<90?"red":i[e]<100?"orange":"black"):d3.select(this).attr("fill",s.styles.colf)}).text(function(t){return t.txt}).style("font-size",r+"px").style("font-weight",s.styles.bold?"bold":"normal").style("font-style",s.styles.italic?"italic":"normal").style("text-shadow",function(t){return s.styles.halo?"0 0 3px #fff":"none"}).call(this.wrapDelims,"|",r),a.exit().remove(),this.txt_o=GCO5.core.GcArrayUtil.toIndexedObj(this.txt_a.concat(),"fid"),0<this.ly.map._getCityLayers().length&&GCO5.core.GcDelayUtil.callLater(this.ly.map.removeLayer,["V"],10,this.ly.map),(new Date).getTime()-t);console.log("dessin etiqs en: "+e/1e3+" s","nbObjs",o.length,this.nbPoly,this.nbText,this.nbPolyText)},getNbEtiqs:function(){return this.nbEtiqs},clear:function(){var t;this.nbEtiqs=0,"P"==this.ly.getTopology()?(this.ly.map._etiqStage.removeAllChildren(),this.ly.map._etiqStage.update()):(t=this.ly.map.getCanvas("mapsvgetiq"),d3.select(t).selectAll(".pg-etiqs, .pg-etiqs0").data([]).exit().remove())},_addListeners:function(){this.inited},destroy:function(){}}),GCO5.view.component.RasterLayerView=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.RasterLayerView"},map:null,_gMap:null,_rasterProvider:null,_configuredRasterProviders:null,_tile:null,_layer:null,_prefix:null,_layerScale:null,_layerTranslate:null,_globe:null,_container:null,_active:null,_curZoomLevel:null,gMapsOptions:null,_googleStaticImgs:null,_capURL:null,_services:null,_service:null,initialize:function(t){this.map=t,this.page=t.page,this._prefix=this._prefixMatch(["webkit","ms","Moz","O"]),this._configuredRasterProviders={}},isActive:function(){return this._active},hasDiscreteZooms:function(){return this._rasterProvider&&this._rasterProvider.hasDiscreteZooms()},supportCrossOrigin:function(){return this._rasterProvider&&this._rasterProvider.supportCrossOrigin()},isWMS:function(){return GCO5.view.component.ARasterProvider.isWMSGlobe(this._globe)},isWMTS:function(){return GCO5.view.component.ARasterProvider.isWMTSGlobe(this._globe)},updateProvider:function(t,e,i,n,r,a){var s,o=this._globe;if(this._globe=t,this._capURL=i,this._services=n,this._service=r,!t)return this._hide(o),!0;if(GCO5.view.component.ARasterProvider.isWMTSGlobe(t)||GCO5.view.component.ARasterProvider.isWMSGlobe(t)?s=i:GCO5.view.component.ARasterProvider.isPredefGlobe(t)&&(s=t),s&&this._configuredRasterProviders[s])this._rasterProvider=this._configuredRasterProviders[s];else{var l=GCO5.view.component.ARasterProvider.getRasterProviderClass(t);if(!l)return this._hide(o),!0;this._rasterProvider=new l({mapName:this.map.mapName,url:i,view:this,services:n,serviceName:this._service}),s&&(this._configuredRasterProviders[s]=this._rasterProvider)}return this._rasterProvider.isConfig()?(r&&this._rasterProvider.updateService(r,this.map),this._show(t,e,a),!0):!(this._active=!0)},hasGMaps:function(){return"GM3"===this._globe},hide:function(){$("#mapraster_cv",this.map.getContainer()).css("z-index","auto"),$(this._container).hide()},_hide:function(t){var e;t&&(this._active=!1,e=this._container,"GM3"!=t?$(e).empty():this.googleStaticImg=null,$(e).hide(),this.map.drawCopyrights())},_show:function(t,e,i){this._active=!0;var n=this.map.getResolutionRatio();if("GM3"!=t&&(this._initRasterDivs(),t=this._container=this.map.getRasterContainer(),$(t).show(),$(t).css("opacity",1)),!i)return this._rasterProvider.hasDiscreteZooms()?(t=this.map.getMapExtent(),i=1/this.map.getWtoSMatrix().scale(1/n,1/n).a,void((n=this._rasterProvider.getNewExtentFitToRes(i,t,this.map,null,e))?GCO5.core.GcDelayUtil.callLater(this.map.setMapExtent,[n,!0,e?"-":null],2,this.map):GCO5.core.GcDelayUtil.callLater(this.draw,[],3,this))):void this.draw()},_initRasterDivs:function(){var t=this.map.getRasterContainer(),e=($(t).empty(),this.map.getResolutionRatio()),e=($(t).css({width:this.map.getWidth()/e+"px",height:this.map.getHeight()/e+"px"}),d3.select(t));this._layer=e.append("div").attr("class","layer"),this.drawCopyrights()},drawCopyrights:function(){var t=this._rasterProvider.getAttribText();return this.map.drawCopyrights(t||" ")},updateService:function(t){this._rasterProvider.updateService(t,this.map),this._initRasterDivs(),this.draw()},onWmsCapabilities:function(t){$(this.map).triggerHandler(GCO5.view.component.MapView.UPD_RASTER_SERVICES,[this._globe,t]),this._show(this._globe,!0),GCO5.core.GcDelayUtil.callLater(this.map._buildCapture,[],50,this.map)},getClosestTilesRes:function(t,e){return this._rasterProvider.getClosestTilesRes(t,this.map,e)},setLayerZIndex:function(){this._rasterProvider.isLayerAboveStat()?$("#mapraster_cv",this.map.getContainer()).css("z-index","1"):$("#mapraster_cv",this.map.getContainer()).css("z-index","auto")},draw:function(t){if(this.setLayerZIndex(),this._active){var e,i,n,r,a,s,o,l=this.map.getMapExtent(),c=this.map.getResolutionRatio();if(t&&this._rasterProvider.hasDiscreteZooms())return o=1/this.map.getWtoSMatrix().scale(1/c,1/c).a,void((o=this._rasterProvider.getNewExtentFitToRes(o,l,this.map,null,!0))?GCO5.core.GcDelayUtil.callLater(this.map.setMapExtent,[o],2,this.map):GCO5.core.GcDelayUtil.callLater(this.draw,[],3,this));"GM3"===this._globe?this._drawGMap():this._rasterProvider.isConfig()&&(o=(e=this).map.getWtoSMatrix().scale(1/c,1/c),r=this._rasterProvider.getZoomLevel(1/o.a,this._rasterProvider._googleStyle),i=this._rasterProvider.getOrigin(Math.round(r),this.map),i=o.transformPoint(i.x,i.y),this._curZoomLevel=Math.round(r),n=this._rasterProvider.getTiles(l,r,o.a,i,this.map.getWidth()/c,this.map.getHeight()/c,this.map),this._layerTranslate=n.tr,this._layerScale=n.scale,l=n.transform,r=n.tiles,null===this._rasterProvider._crossOrigin?this._rasterProvider.testCORS(e._rasterProvider.getTile.call(e._rasterProvider,r[0]),this.draw,this,t):((o=this._layer.style(this._prefix+"transform",l).selectAll(".tile").data(r,function(t){return t.push(e._rasterProvider.getTile.call(e._rasterProvider,t))})).exit().remove(),a=this._rasterProvider._yOrientBottom?1:-1,s=this._rasterProvider.getTileSize(this._curZoomLevel),(o=o.enter().append("img").filter(function(t){return!!t[3]}).attr("class","tile").each(function(t){e.supportCrossOrigin()&&(this.crossOrigin="*")}).attr("src",function(t){return t[3]}).on("error",function(){d3.select(this).style("visibility","hidden")}).merge(o)).style("width",s+"px").style("height",s+"px").style("left",function(t){return t[0]*s-n.corrdx/n.k+"px"}).style("top",function(t){return(1==a?t[1]*s-n.corrdy/n.k:(-1-t[1])*s-n.corrdy/n.k)+"px"})))}},_drawGMap:function(){var t,e,i,n=this.map.getResolutionRatio(),r=this.map.getWtoSMatrix(),r=this._rasterProvider.getZoomLevel(+n/r.a,!1),a=this.map.getStoWMatrix().transformPoint(this.map.getWidth()/2,this.map.getHeight()/2),s=(a=GCO5.core.GcGeomUtil.SMC_to_LongLat(a.x,a.y)).x,a=a.y,o=this._container=this.map.getGMapsContainer(),o=($(o).show(),$(o).css("opacity",1),new google.maps.LatLng(s,a)),s=this._rasterProvider.getService(),a=this.gMapsOptions={tilt:0,center:o,zoom:r,disableDefaultUI:!0,keyboardShortcuts:!1,draggable:!1,disableDoubleClickZoom:!0,scrollwheel:!1,animatedZoom:!1,streetViewControl:!1,mapTypeId:s,styles:[{stylers:[{saturation:-19}]},{featureType:"all",elementType:"labels",stylers:[{lightness:30}]},{featureType:"road",elementType:"geometry"},{featureType:"road",elementType:"labels",stylers:[{visibility:"off"}]}]};this._gMap?(t=this._container,e=JSON.stringify(this._gMap.getCenter()),i=JSON.stringify(o),this.map.getWidth()/n!=$(this._container).width()?GCO5.core.GcDelayUtil.callLater(this._show,["GM3"],20,this):(e!=i&&(google.maps.event.addListenerOnce(this._gMap,"idle",function(){t.style.visibility=""}),t.style.visibility="hidden"),google.maps.event.trigger(this._gMap,"resize"),this._gMap.setOptions({center:o,zoom:r,mapTypeId:s}))):this._gMap=new google.maps.Map(this._container,a)},_prefixMatch:function(t){for(var e=-1,i=t.length,n=document.body.style;++e<i;)if(t[e]+"Transform"in n)return"-"+t[e].toLowerCase()+"-";return""},storeCanvasSnapshot:function(i,t){if(!this._active)return null;if(i||((e=this.map._createLayerCanvas("raster")).width=this.map.getWidth(),e.height=this.map.getHeight(),i=e.getContext("2d")),"GM3"===this._globe)return this._storeGM3CanvasSnapshot(i,t);var n,e=this._layerScale,r=(this._layerTranslate,e*this._rasterProvider.getTileSize(this._curZoomLevel));if(this._layer)return n=this.map.container.offset(),this._layer.selectAll(".tile").each(function(t){parseFloat($(this).css("left")),parseFloat($(this).css("top"));var e=$(this).offset();try{i.drawImage(this,e.left-n.left,e.top-n.top,r,r)}catch(t){}}),i},_getGMapStaticImageDef:function(t,e,i){var n=this.gMapsOptions,t=GCO5.core.GcGeomUtil.SMC_to_LongLat(t,e),e=(this.map.getWidth(),"https://maps.googleapis.com/maps/api/staticmap");return{staticMapUrl:(e+="?center="+t.x+","+t.y)+"&size=640x640&scale=1"+("&zoom="+n.zoom)+("&maptype="+n.mapTypeId)+"&style=feature:all|saturation:-19&style=feature:all|element:labels|lightness:30&style=feature:road|element:geometry|lightness:100|visibility:simplified&style=feature:road|element:labels|visibility:off"+("&key="+this._rasterProvider._apiKey),ptCanvas:i}},_getGMapStaticImages:function(){var t=this.map.getStoWMatrix(),e=t.transformPoint(0,0),i=this.map.getWidth(),n=this.map.getHeight(),r=t.transformPoint(i,n),t=t.transformPoint(i/2,n/2),e=(r.x-e.x)/i,a=640*e,e=20*e,s=640*(t.x-r.x)/i+r.x,t=640*(t.y-r.y)/n+r.y,r={x:i-640,y:n-640},o=s,l=t+a-2*e,c={x:i-640,y:n-1280+40},a=s-a,h=a,e=t-e,d={x:i-1280,y:n-640+20};return this._googleStaticImgs=[this._getGMapStaticImageDef(a,l,{x:i-1280,y:n-1280+40}),this._getGMapStaticImageDef(o,l,c),this._getGMapStaticImageDef(h,e,d),this._getGMapStaticImageDef(s,t,r)],i<640&&(this._googleStaticImgs.shift(),this._googleStaticImgs.splice(1,1),n<640&&this._googleStaticImgs.shift()),this._googleStaticImgs.length},_storeGM3CanvasSnapshot:function(t,e){t.canvas.width,t.canvas.height;var i=this;if(e){var n,r=this._getGMapStaticImages();for(a in this._googleStaticImgs)(n=this._googleStaticImgs[a]).img=new Image,n.img.crossOrigin="*",n.img.onload=function(){0==--r&&$(i.map).triggerHandler(GCO5.view.component.MapView.RASTER_LOADED)},n.img.onerror=function(){r--,console.log("img error")},n.img.src=n.staticMapUrl}else for(var a in this._googleStaticImgs)(n=this._googleStaticImgs[a]).img&&t.drawImage(n.img,n.ptCanvas.x,n.ptCanvas.y)},_matrixToArray:function(t){return t?t.match(/(-?[0-9\.]+)/g):null},setRasterProvider:function(t){this._rasterProvider=t},getRasterProvider:function(){return this._rasterProvider},getGlobe:function(){return this._globe},getService:function(t){return this._rasterProvider.getService()}}),GCO5.view.component.ARasterProvider=GCO5.Class.extend({statics:{NAME:"GCO5.view.component.ARasterProvider",EARTH_PERIM_MT:40075016.68,BING:"Bing",OSM:"OSM",OSP:"OSP",IGN3:"IGN3",IGNWMTS:"IGNWMTS",GMAPS:"GM3",STREET:"street",AERIAL:"aerial",ELEVATION:"elev",HERE:"HERE",WMTS:"WMTS",WMS:"WMS",is3857Globe:function(t){if(0<=["GM3","OSM","IGN3","IGNWMTS"].indexOf(t))return!0;t=this.getGlobeLayersObject(t);return t&&"3857"===t.c_epsg},isWMTSGlobe:function(t){return!!t&&((t="string"==typeof t?this.getGlobeObject(t):t)&&"WMTS"===t.c_web_service)},isWMSGlobe:function(t){return!!t&&((t="string"==typeof t?this.getGlobeObject(t):t)&&"WMS"===t.c_web_service)},isPredefGlobe:function(t){if(t)if((t="string"==typeof t?GCO5.view.component.ARasterProvider.getGlobeObject(t):t)&&"PREDEF"===t.c_web_service){if({GM3:"GM3",OSM:"OSM",OSP:"OSP",IGN3:"IGN3",IGNWMTS:"IGNWMTS"}[t.c_id_globe])return!0;console.warn("Unknown implementation of predef globe.")}return!1},getGlobeObject:function(t){t=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("globes"),{c_id_globe:t});return 0<t.length&&t[0]},getGlobeLayersObject:function(t,e){t=GCO5.core.GcArrayUtil.getSubArray(GCO5.appModel.getConcept("globesLayers"),{c_id_globe:t});return 0<(t=e?GCO5.core.GcArrayUtil.getSubArray(t,{c_layer:e}):t).length&&t[0]},getRasterProviderClass:function(t){return!!t&&("string"==typeof t&&(t=this.getGlobeObject(t)),GCO5.view.component.ARasterProvider.isPredefGlobe(t)?GCO5.view.component[t.c_id_globe+"RasterProvider"]:GCO5.view.component.ARasterProvider.isWMTSGlobe(t)?GCO5.view.component.WMTSRasterProvider:!!GCO5.view.component.ARasterProvider.isWMSGlobe(t)&&GCO5.view.component.WMSRasterProvider)},getDefsFromApiList:function(t,e){var i=[];if(0<t.length)for(var n in t){var r,a=t[n],s=GCO5.view.component.ARasterProvider.getRasterProviderClass(a);s&&(r=GCO5.core.GcArrayUtil.getSubArray(e,{c_id_globe:[a.c_id_globe]}),i=i.concat(s.getLayersDef(a,r)))}for(n in i)for(var o=i[n],l=o.services,c=0;c<l.length;c++)l[c].name="TileLy",l[c].typLayer="B",l[c].apiKey=o.c_apikey,l[c].provider=o.provider,l[c].id_globe=o.id_globe,l[c].useProxy=o.useProxy;return i},getServices:function(t,e){if(e&&0<e.length)for(var i=[],n=0;n<t.length;n++){var r=t[n],a=GCO5.core.GcArrayUtil.indexOfByKey(e,"c_layer",r.service);0<=a&&1==e[a].c_active&&(r.lib=e[a].c_lib_layer,i.push(r))}else i=t;return i}},_providerName:null,_providerURL:null,_serviceName:null,_zoom:null,_tileSizePx:null,_minZoomLevel:null,_maxZoomLevel:null,_yOrientBottom:null,_originMt:null,_tileSizePx_a:null,_tileSizeMt_a:null,_tileRapMtPx_a:null,_WToPyrMatrix_a:null,_PyrToWMatrix_a:null,_attribText:null,_crossOrigin:null,_googleStyle:null,_apiKey:null,_discreteZooms:null,_globeLib:null,_lang:null,_isConfig:null,initialize:function(t){var e=GCO5.view.component.ARasterProvider.EARTH_PERIM_MT;this._minZoomLevel=0,this._maxZoomLevel=19,this._tileSizePx=256,this._yOrientBottom=!0,this._originMt=new GCO5.model.geom.Point(-e/2,e/2),this._discreteZooms=!1,this._googleStyle=!0,this._lang=GCO5.core.GcLangManager.getInstance().getLang(),this.setup(t),t.services&&(this._globeLib=GCO5.appModel.getConcept("globe_o")[t.services[0].id_globe].c_lib_globe)},setup:function(t){this._apiKey=GCO5.appModel.getInfo("aPIKey",[this._providerName]),this._isConfig=!0},isConfig:function(){return this._isConfig},getAttribText:function(){return this._attribText},getTile:function(t){return""},testCORS:function(t,e,i,n){var r=this;$.ajax({url:t,xhrFields:{withCredentials:!1}}).done(function(){r._crossOrigin=!0,e&&e.apply(i,[n])}).fail(function(){r._crossOrigin=!1,e&&e.apply(i,[n])})},getTiles:function(t,e,i,n,r,a,s){var r=d3.tile().size([r,a]),a=0,o=0,l=(s&&(l=this.getOrigin(Math.round(e)),s=s._WtoS_Matrix0.transformPoint(l.x,l.y),l=this.getTransformFromZoomLevel(e,s,!this._googleStyle),h=(c=r.scale(l.s).translate(l.tr)()).scale,d=c.translate,u=h/256,g=(p=h%1?Number:Math.round)(d[0]*h),f=p(d[1]*h),1e6<Math.abs(Math.round(g))&&(a=-1e3*Math.round(g/1e3)),1e6<Math.abs(Math.round(f))&&(o=-1e3*Math.round(f/1e3))),this.getTransformFromZoomLevel(e,n,!this._googleStyle)),c=r.scale(l.s).translate(l.tr)(),h=c.scale,d=c.translate,u=h/256,p=h%1?Number:Math.round,g=p(d[0]*h),f=p(d[1]*h);return{tiles:c,transform:"matrix3d("+[u,0,0,0,0,u,0,0,0,0,u,0,g+a,f+o,0,1]+")",tr:l.tr,scale:u,corrdx:a,corrdy:o,dx:g,dy:f,k:u}},getTileIndices:function(t,e){e=Math.min(Math.max(e,0),this._WToPyrMatrix_a.length-1),e=Math.round(e);e=this._WToPyrMatrix_a[e].transformPoint(t.x,t.y),t=e.x,e=e.y;return new GCO5.model.geom.Point(Math.floor(t),this._yOrientBottom?Math.floor(e):Math.ceil(e))},getTileIndicesBoundsFromExtent:function(t,e){for(var i=this.getTileIndices(t.getTopLeft(),e),t=this.getTileIndices(t.getBottomRight(),e),n=i.x,r=t.x,a=i.y,s=t.y,o=(t.y<i.y&&(a=t.y,s=i.y),[]),l=n;l<=r;l++)for(var c=a;c<=s;c++)o.push([l,c,e]);return o},getTileScaleRatio:function(t,e){return this._tileRapMtPx_a[t]/e},getTileSize:function(t){return this._tileSizePx_a?this._tileSizePx_a[t]:0},isLayerAboveStat:function(){if(!this._serviceName)return!1;var t=GCO5.core.GcArrayUtil.indexOfByKey(this._ly_a,"service",this._serviceName);return 0<=t&&!!this._ly_a[t].aboveStat},updateService:function(t,e){this._serviceName=t;t=GCO5.core.GcArrayUtil.indexOfByKey(this._ly_a,"service",t);return t<0||$("#mapraster_cv",e.getContainer()).css("z-index",this._ly_a[t].aboveStat?"1":"auto"),t},getService:function(t){return this._serviceName},hasDiscreteZooms:function(){return this._discreteZooms},supportCrossOrigin:function(){return this._crossOrigin},_setGoogleStylePyramid:function(){this._tileSizePx_a=[],this._tileSizeMt_a=[],this._tileRapMtPx_a=[],this._WToPyrMatrix_a=[],this._PyrToWMatrix_a=[];for(var t=0;t<=21;t++){this._tileSizePx_a.push(this._tileSizePx),this._tileSizeMt_a.push(GCO5.view.component.ARasterProvider.EARTH_PERIM_MT/Math.pow(2,t)),this._tileRapMtPx_a.push(this._tileSizeMt_a[t]/this._tileSizePx_a[t]);var e=1/this._tileSizeMt_a[t],i=(e=new GCO5.model.geom.Matrix(e,0,0,this._yOrientBottom?-e:e)).transformPoint(this._originMt.x,this._originMt.y);e.translate(-i.x,-i.y-Number(!this._yOrientBottom)),this._WToPyrMatrix_a.push(e),(i=e.clone()).invert(),this._PyrToWMatrix_a.push(i)}},getClosestTilesRes:function(t,e,i,n){t=this.getZoomLevel(t,!1,i,n);return this._tileRapMtPx_a[t]},getOrigin:function(t){return new GCO5.model.geom.Point(0,0)},getNewExtentFitToRes:function(t,e,i,n,r){n=this.getClosestTilesRes(t,i,n,r);return Math.abs(n/t-1)<.01?null:e.resize(n*i.getWidth(),n*i.getHeight())},getZoomLevel:function(t,e,i,n,r){if(!this._tileRapMtPx_a)return 1;var a=this._tileRapMtPx_a[0]/t;if(e)return Math.log(a)/Math.LN2;e=GCO5.core.GcArrayUtil.getClosestIndiceInfo(this._tileRapMtPx_a,t),e.closest,a=this._tileRapMtPx_a.length-1-e.indice;return"+"==i&&this._tileRapMtPx_a[a]>t&&a++,(n||"-"==i)&&this._tileRapMtPx_a[a]<t&&a--,a=Math.min(a,this._maxZoomLevel),a=Math.max(a,this._minZoomLevel),r<this._tileRapMtPx_a[a]&&a++,a},getTransformFromZoomLevel:function(t,e,i){var n=Math.pow(2,t+8),i=i?Math.pow(2,t-1):0;return{s:n,tr:[e.x+256*i,e.y+256*i]}},getRoundedSizeWithStretchConstraints:function(t,e,i){for(var n,r=String(Math.floor(t)).length,a=[],s=0;s<r&&((n={}).g1=Math.pow(10,s)*Math.floor(t/Math.pow(10,s)),n.g2=Math.pow(10,s)*Math.ceil(t/Math.pow(10,s)),n.t1=t/n.g1<=i&&n.g1/t>=e,n.t2=t/n.g2<=i&&n.g2/t>=e,a.push(n),n.t1||n.t2);s++);return a.pop(),(n=a.pop()).t1?n.g1:n.g2},destroy:function(){}}),GCO5.view.component.OSMRasterProvider=GCO5.view.component.ARasterProvider.extend({statics:{NAME:"GCO5.view.component.OSMRasterProvider",getLayersDef:function(t,e){var i=GCO5.core.ClientInfo.getInstance().isHttps(),n=GCO5.core.GcLangManager.getInstance(),n=[{service:"street",format:"img/png",fitToRes:!0,layers:"OsmS",lib:n.getString("OSM_STYLE_STD","geo"),https:1},{service:"streetstamen",format:"img/png",fitToRes:!0,layers:"OsmS",lib:n.getString("OSM_STYLE_STAMEN","geo"),https:1},{service:"streetfr",format:"img/png",fitToRes:!0,layers:"OsmS",lib:n.getString("OSM_STYLE_FRANCE","geo"),https:1},{service:"thunderforest",format:"img/png",fitToRes:!0,layers:"OsmS",lib:n.getString("OSM_STYLE_THUNDERFOREST","geo"),https:1}];return i&&(n=GCO5.core.GcArrayUtil.getSubArray(n,{https:[1]})),[{provider:GCO5.view.component.ARasterProvider.OSM,id_globe:GCO5.view.component.ARasterProvider.OSM,lib:t&&t.lib_globe?t.lib_globe:"OpenStreetMap",icoName:"p_osm",services:GCO5.view.component.ARasterProvider.getServices(n,e)}]}},setup:function(t){this._providerName=GCO5.view.component.ARasterProvider.OSM,this._serviceName=GCO5.view.component.OSMRasterProvider.getLayersDef()[0].services[0].service,this._attribText='Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.',this._crossOrigin=!0,this._setGoogleStylePyramid(),this._super()},getTile:function(t){var e=t[2],i=t[0],t=t[1],n=(i>=Math.pow(2,e)&&(i-=Math.pow(2,e)),i<0&&(i+=Math.pow(2,e)),this._serviceName);return(n="streetstamen"==(n="thunderforest"==(n="street"==(n="streetfr"==n?"//"+["a","b","c"][3*Math.random()|0]+".tile.openstreetmap.fr/osmfr/":n)?"//"+["a","b","c"][3*Math.random()|0]+".tile.openstreetmap.org/":n)?"//"+["a","b","c"][3*Math.random()|0]+".tile.thunderforest.com/transport/":n)?"//stamen-tiles-"+["a","b","c"][3*Math.random()|0]+".a.ssl.fastly.net/watercolor/":n)+e+"/"+i+"/"+t+".png"}}),GCO5.view.component.OSPRasterProvider=GCO5.view.component.ARasterProvider.extend({statics:{NAME:"GCO5.view.component.OSPRasterProvider",SRV_URL:"//openspace.ordnancesurvey.co.uk/osmapapi/ts?",getLayersDef:function(t,e){return[{provider:GCO5.view.component.ARasterProvider.OSP,lib:t&&t.lib_globe?t.lib_globe:"OpenSpace",icoName:"p_osp",apiKey:t?t.key:null,services:[{service:"street",format:"img/png",fitToRes:!0,layers:"OspS",lib:"Style standard (Mapnik)"}]}]}},_tileLayerId_a:null,setup:function(t){this._providerName=GCO5.view.component.ARasterProvider.OSP,this._serviceName=GCO5.view.component.OSPRasterProvider.getLayersDef()[0].services[0].service,this._attribText="Crown copyrights",this._yOrientBottom=!1,this._crossOrigin=!0,this._originMt=new GCO5.model.geom.Point(0,0),this._discreteZooms=!1,this._googleStyle=!1,this._setPyramid(),this._super()},getTiles:function(t,e,i,n,r,a){t=this.getTileIndicesBoundsFromExtent(t,e),e=this._discreteZooms?1:this.getTileScaleRatio(e,1/i),i=n.x,n=n.y;return{tiles:t,transform:"matrix3d("+[e,0,0,0,0,e,0,0,0,0,e,0,i,n,0,1]+")",tr:[i,n],scale:1,corrdx:0,corrdy:0,dx:i,dy:n,k:1}},_setPyramid:function(){this._tileSizePx_a=[],this._tileSizeMt_a=[],this._tileRapMtPx_a=[],this._WToPyrMatrix_a=[],this._PyrToWMatrix_a=[],this._tileLayerId_a="1|2|5|10|25|50|100|200|500|1000|2500".split("|").reverse();for(var t="250|250|200|200|200|200|200|200|200|200|200".split("|").reverse(),e="250|500|1000|2000|5000|10000|20000|40000|100000|200000|500000".split("|").reverse(),i=t.length,n=0;n<i;n++){this._tileSizePx_a.push(parseInt(t[n])),this._tileSizeMt_a.push(parseInt(e[n])),this._tileRapMtPx_a.push(this._tileSizeMt_a[n]/this._tileSizePx_a[n]);var r=1/this._tileSizeMt_a[n],a=(r=new GCO5.model.geom.Matrix(r,0,0,this._yOrientBottom?-r:r)).transformPoint(this._originMt.x,this._originMt.y);r.translate(-a.x,-a.y-Number(!this._yOrientBottom)),this._WToPyrMatrix_a.push(r),(a=r.clone()).invert(),this._PyrToWMatrix_a.push(a)}},getTile:function(t){var e=t[2],i=t[0],t=t[1],n=this._tileSizePx_a[e],i=i*this._tileSizeMt_a[e],t=t*this._tileSizeMt_a[e],i=i+","+t+","+(i+n)+","+(t+n);return GCO5.view.component.OSPRasterProvider.SRV_URL+"FORMAT=image/png&KEY="+this._apiKey+"&URL="+GCO5.core.ClientInfo.getInstance().getAppRoot()+"&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&LAYERS="+this._tileLayerId_a[e]+"&SRS=EPSG:27700&BBOX="+i+"&WIDTH="+n+"&HEIGHT="+n}}),GCO5.view.component.BingRasterProvider=GCO5.view.component.ARasterProvider.extend({statics:{NAME:"GCO5.view.component.BingRasterProvider",getLayersDef:function(t,e){var i=[{service:"street",format:"img/png",fitToRes:!0,layers:"BingS",lib:"Plan"},{service:"aerial",format:"img/png",fitToRes:!0,layers:"BingA",lib:"Aerial"},{service:"aerial_names",format:"img/png",fitToRes:!0,layers:"BingN",lib:"Aerial with names"}];if(e&&0<e.length)for(var n=[],r=0;r<i.length;r++){var a=i[r],s=GCO5.core.GcArrayUtil.indexOfByKey(e,"layer",a.service);0<=s&&(a.lib=e[s].lib_layer,n.push(a))}else n=i;return[{provider:GCO5.view.component.ARasterProvider.BING,lib:t&&t.lib_globe?t.lib_globe:"Bing Maps",apiKey:t?t.key:null,icoName:"p_bg",services:n}]}},setup:function(t){this._providerName=GCO5.view.component.ARasterProvider.BING,this._serviceName=GCO5.view.component.BingRasterProvider.getLayersDef()[0].services[0].service,this._attribText="",this._setGoogleStylePyramid(),this._super()},getTile:function(t){var e=t[2],i=t[0],n=t[1];i>=Math.pow(2,e)&&(i-=Math.pow(2,e)),i<0&&(i+=Math.pow(2,e));for(var r,a,t=(e+i+n)%4,s="",o=0;o<e;o++)r=Math.floor(i/Math.pow(2,e-o-1)),a=Math.floor(n/Math.pow(2,e-o-1)),s+=r<1&&a<1?"0":1<=r&&a<1?"1":r<1&&1<=a?"2":"3",i-=r*Math.pow(2,e-o-1),n-=a*Math.pow(2,e-o-1);return this._serviceName==GCO5.view.component.ARasterProvider.STREET?"http://origin.t"+t+".tiles.virtualearth.net/tiles/r"+s+".png?g=1879&mkt="+this._lang+"-"+this._lang+"&shading=hill":"http://origin.t"+t+".tiles.virtualearth.net/tiles/a"+s+".jpeg?g=1879&mkt="+this._lang+"-"+this._lang+"&n=z"}}),GCO5.view.component.IGN3RasterProvider=GCO5.view.component.ARasterProvider.extend({statics:{NAME:"GCO5.view.component.IGN3RasterProvider",CONFIG_URL_BASE:"http://jeton-api.ign.fr/getToken?output=xml&key=",getLayersDef:function(t,e){t&&t.cartesIgn&&(this._cartesIgn=!0),t&&t.intranetRestricted&&(this._intranetRestricted=!0);return[{provider:GCO5.view.component.ARasterProvider.IGN3,id_globe:GCO5.view.component.ARasterProvider.IGN3,lib:t&&t.c_lib_globe?t.c_lib_globe:"IGN Géoportail",apiKey:t?t.c_apikey:null,icoName:"p_gp",services:GCO5.view.component.ARasterProvider.getServices([{service:"aerial",format:"image/jpeg",fitToRes:!0,layers:"IgnA",res:"0.25 0.5 1 2 4 8 16 32 64 128 256 512 1024 2048",lib:"Photo"},{service:"street",format:"image/jpeg",fitToRes:!0,layers:"IgnA",res:"0.5 1 2 4 8 16 32 64 128 256 512 1024 2048",lib:"Plan"},{service:"street2",format:"image/jpeg",fitToRes:!0,layers:"IgnA",res:"0.5 1 2 4 8 16 32 64 128 256 512 1024 2048",lib:"Plan2"},{service:"elev",format:"image/jpeg",fitToRes:!0,layers:"IgnA",lib:"Relief"},{service:"cadastre",format:"image/png",fitToRes:!0,layers:"IgnA",lib:"Cadastre"},{service:"hydro",format:"image/png",fitToRes:!0,layers:"IgnA",lib:"Hydrographie"},{service:"roads",format:"image/png",fitToRes:!0,layers:"IgnA",lib:"Routes"},{service:"forest1",format:"image/png",fitToRes:!0,layers:"IgnA",lib:"Inventaire forestier"},{service:"const",format:"image/png",fitToRes:!0,layers:"IgnA",lib:"Constructions"},{service:"ligneselec",format:"image/png",fitToRes:!0,layers:"IgnA",lib:"ligneselec"},{service:"aireparcellaire",format:"image/png",fitToRes:!0,layers:"IgnA",lib:"AireParcellaire"}],e)}]}},_cartesIgn:null,_intranetRestricted:null,setup:function(t){this._providerName=GCO5.view.component.ARasterProvider.IGN3,this._serviceName=GCO5.view.component.IGN3RasterProvider.getLayersDef()[0].services[0].service,this._attribText="© IGN - Géoportail",this._crossOrigin=!0,this._setGoogleStylePyramid(),this._super()},getTile:function(t){var e=t[2],i=t[0],t=t[1],n=(i>=Math.pow(2,e)&&(i-=Math.pow(2,e)),i<0&&(i+=Math.pow(2,e)),"https://wxs.ign.fr/"+this._apiKey+"/geoportail/wmts?"),r=(n+="SERVICE=WMTS&VERSION=1.0.0&REQUEST=GetTile&STYLE=normal&TILEMATRIXSET=PM&EXCEPTIONS=text/xml",this._serviceName),a=this._serviceName==GCO5.view.component.ARasterProvider.STREET;return a&&this._cartesIgn?n+="&LAYER=GEOGRAPHICALGRIDSYSTEMS.MAPS&FORMAT=image/jpeg":a?n+="&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGN&FORMAT=image/jpeg":"street2"==r?n+="&LAYER=GEOGRAPHICALGRIDSYSTEMS.MAPS&FORMAT=image/jpeg":"aerial"==r?n+="&LAYER=ORTHOIMAGERY.ORTHOPHOTOS&FORMAT=image/jpeg":"etatmajor40"==r?n+="&LAYER=GEOGRAPHICALGRIDSYSTEMS.ETATMAJOR40&FORMAT=image/jpeg":"ilotsagri"==r?n+="&LAYER=LANDUSE.AGRICULTURE2009&FORMAT=image/png":"elev"==r?n+="&LAYER=ELEVATION.SLOPES&FORMAT=image/jpeg":"cadastre"==r?n+="&LAYER=CADASTRALPARCELS.PARCELS&FORMAT=image/png":"litto"==r?n+="&LAYER=GEOGRAPHICALGRIDSYSTEMS.COASTALMAPS&FORMAT=image/png":"hydro"==r?n+="&LAYER=HYDROGRAPHY.HYDROGRAPHY&FORMAT=image/png":"roads"==r?n+="&LAYER=TRANSPORTNETWORKS.ROADS&FORMAT=image/png":"forest1"==r?n+="&LAYER=LANDCOVER.FORESTINVENTORY.V1&FORMAT=image/png":"const"==r?n+="&LAYER=BUILDINGS.BUILDINGS&FORMAT=image/png":"cassini"==r?n+="&LAYER=GEOGRAPHICALGRIDSYSTEMS.CASSINI&FORMAT=image/png":"ligneselec"==r?n+="&LAYER=UTILITYANDGOVERNMENTALSERVICES.ALL&FORMAT=image/png":"aireparcellaire"==r&&(n+="&LAYER=Aire-Parcellaire&FORMAT=image/png"),n=(n+="&TILEMATRIX="+e)+("&TILEROW="+t)+("&TILECOL="+i)}}),GCO5.view.component.HERERasterProvider=GCO5.view.component.ARasterProvider.extend({statics:{NAME:"GCO5.view.component.HERERasterProvider",getLayersDef:function(t,e){return[{provider:GCO5.view.component.ARasterProvider.HERE,lib:t&&t.lib_globe?t.lib_globe:"HERE",apiKey:t?t.key:null,icoName:"p_osm",services:[{service:"street",format:"img/png",fitToRes:!0,layers:"OsmS",lib:"Style HERE"}]}]}},setup:function(t){this._providerName=GCO5.view.component.ARasterProvider.HERE,this._serviceName=GCO5.view.component.HERERasterProvider.getLayersDef()[0].services[0].service,this._attribText="",this._setGoogleStylePyramid(),this._super()},getTile:function(t){var e=t[2],i=t[0],t=t[1],n=(i>=Math.pow(2,e)&&(i-=Math.pow(2,e)),i<0&&(i+=Math.pow(2,e)),this._serviceName),r=this._apiKey.split("|");if("street"==n)return"//"+["1","2","3","4"][4*Math.random()|0]+".base.maps.cit.api.here.com/maptile/2.1/maptile/newest/normal.day.grey/"+e+"/"+i+"/"+t+"/256/png8?app_id="+r[0]+"&app_code="+r[1]}}),GCO5.view.component.GM3RasterProvider=GCO5.view.component.ARasterProvider.extend({statics:{NAME:"GCO5.view.component.GM3RasterProvider",getLayersDef:function(t,e){return[{provider:GCO5.view.component.ARasterProvider.GMAPS,id_globe:GCO5.view.component.ARasterProvider.GMAPS,lib:t&&t.lib_globe?t.lib_globe:"Google Maps",icoName:"p_ggm",services:GCO5.view.component.ARasterProvider.getServices([{service:"roadmap",format:"img/png",fitToRes:!0,layers:"OsmS",lib:"Plan"},{service:"satellite",format:"img/png",fitToRes:!0,layers:"OsmS",lib:"Satellite"},{service:"hybrid",format:"img/png",fitToRes:!0,layers:"OsmS",lib:"Mixte"}],e)}]}},setup:function(){this._providerName=GCO5.view.component.ARasterProvider.GMAPS,this._serviceName=GCO5.view.component.GM3RasterProvider.getLayersDef()[0].services[0].service,this._discreteZooms=!0,this._crossOrigin=!0,this._setGoogleStylePyramid(),this._super()}}),GCO5.view.component.WMSRasterProvider=GCO5.view.component.ARasterProvider.extend({statics:{NAME:"GCO5.view.component.WMSRasterProvider",CONFIG_URL_BASE:"GC_wms_getMap.php?",DEFAULT_FMT:"image/png",TILE_SIZE_PX:400,getLayersDef:function(t,e){var i=[];if(e&&0<e.length)for(var n=0;n<e.length;n++){var r=e[n],r={service:r.c_layer,format:r.c_fmt,styles:r.c_style,layers:r.c_layer,lib:r.c_lib_layer,tileSrs:r.c_epsg,fitToRes:!0,aboveStat:!!r.c_abovestat,urlLegend:r.c_url_legend,urlMetadata:r.c_url_metadata};i.push(r)}return[{provider:GCO5.view.component.ARasterProvider.WMS,id_globe:t.c_id_globe,lib:t.c_lib_globe,apiKey:t.key,capURL:t.c_url,services:i}]}},_tileSizeMt:null,_imgFormat:null,_styles:null,_cacheSrv:null,_sridLocal:null,_srcodeLocal:null,_layers:null,setup:function(t){this._providerName=GCO5.view.component.ARasterProvider.WMS,this._attribText="",this._version="1.1.0",this._serviceName=t.services[0].service,this._ly_a=t.services,this._yOrientBottom=!1,this._tileSizePx=this.constructor.TILE_SIZE_PX,this._super()},getTiles:function(t,e,i,n,r,a){this._tileSizeMt=this.getTileSizeMt(t,r,a);r=this.getTileIndicesBoundsFromExtent(t,e=e<0?1:e),a=this._discreteZooms?1:this.getTileScaleRatio(Math.round(e),1/i),t=n.x,e=n.y;return{tiles:r,transform:"matrix3d("+[a,0,0,0,0,a,0,0,0,0,a,0,t,e,0,1]+")",tr:[t,e],scale:a,corrdx:0,corrdy:0,dx:0,dy:0,k:a}},getTileSize:function(t){return this._tileSizePx},updateService:function(t,e){var i=this._super(t,e);i<0&&console.log("erreur wms updateService",t,this._ly_a),this.globe=this._ly_a[i].id_globe,this.tileSrs=this._ly_a[i].tileSrs,this._attribText=" - "+this._globeLib+", "+this._ly_a[i].lib,GCO5.core.GcStringUtil.isEmpty(this._ly_a[i].urlLegend)||(this._attribText+=" - <a href='#' class='js-tooltip' data-tooltip-close-text='x' data-tooltip-close-title='Fermer'  data-tooltip-title="+this._ly_a[i].lib+" data-tooltip-content-id='mapwmslegend'>Légende</a>",$("#mapwmslegend",e.getContainer()).find("img").prop("src",this._ly_a[i].urlLegend)),GCO5.core.GcStringUtil.isEmpty(this._ly_a[i].urlMetadata)||(this._attribText+=" - <a href='"+this._ly_a[i].urlMetadata+"'target='_blank' >Métadonnées</a>")},getTile:function(t){t[2];var e=t[0],t=t[1],i=this._originMt.x,n=this._originMt.y,r=GCO5.view.component.WMSRasterProvider.CONFIG_URL_BASE+"globe="+this.globe+"&layer="+this._serviceName,i=i+e*this._tileSizeMt,e=n+t*this._tileSizeMt;return r+("&minx="+i+"&maxx="+(i+this._tileSizeMt)+"&miny="+e+"&maxy="+(e+this._tileSizeMt))+("&width="+this._tileSizePx+"&height="+this._tileSizePx)},getTileSizeMt:function(t,e,i){var e=Math.max(t.getWidth()/e,t.getHeight()/i)*this._tileSizePx,i=this._cacheSrv?.85:.9,n=this._cacheSrv?1.3:1.2,r="4326"==this._sridLocal,e=r?e:this.getRoundedSizeWithStretchConstraints(e,i,n);return this._tileSizeMt!=e&&this._setPyramid(t,e,r),this._tileSizeMt=e},getOrigin:function(t,e){return this.getTileSizeMt(e.getMapExtent(),e.getWidth(),e.getHeight()),this._originMt},_setPyramid:function(t,e,i){this._WToPyrMatrix_a=[],this._PyrToWMatrix_a=[],this._tileRapMtPx_a=[],this._tileSizePx_a=[];var n=Math.floor(t.getTopLeft().x/e),t=Math.floor((t.getTopLeft().y-t.getHeight())/e),n=(this._originMt=new GCO5.model.geom.Point(n*e,t*e),1/e),r=new GCO5.model.geom.Matrix(n,0,0,this._yOrientBottom?-n:n),t=r.transformPoint(this._originMt.x,this._originMt.y),a=(r.translate(-t.x,-t.y-Number(!this._yOrientBottom)),(this._WToPyrMatrix_a[0]=r).clone());a.invert(),this._tileSizeMt=e;for(var s=0;s<20;s++)this._WToPyrMatrix_a[s]=r,this._tileSizePx_a[s]=this._tileSizePx,this._PyrToWMatrix_a[s]=a,this._tileRapMtPx_a[s]=e/this._tileSizePx}}),GCO5.view.component.WMTSRasterProvider=GCO5.view.component.ARasterProvider.extend({statics:{NAME:"GCO5.view.component.WMTSRasterProvider",CONFIG_URL_BASE:"GC_wmts_getTile.php?",DEFAULT_FMT:"image/png",TILE_SIZE_PX:400,getLayersDef:function(t,e){var i=[];if(e&&0<e.length)for(var n=0;n<e.length;n++){var r=e[n],r={globe:r.c_id_globe,service:r.c_layer,format:r.c_fmt,styles:r.c_style,layers:r.c_layer,lib:r.c_lib_layer,tileSrs:r.c_epsg,fitToRes:!0,aboveStat:!!r.c_abovestat};i.push(r)}return[{provider:GCO5.view.component.ARasterProvider.WMTS,id_globe:t.c_id_globe,lib:t.c_lib_globe,apiKey:t.key,capURL:t.c_url,services:i,useProxy:t.c_use_proxy}]}},_tileBounds_a:null,_tmId_a:null,_originMt_a:null,_tileMatrixSet:null,_tmSet_o:null,_imgFormat:null,_styles:null,_resourceURL:null,_cacheSrv:null,_isRest:null,_mapEPSG:null,_providerName:GCO5.view.component.ARasterProvider.WMTS,_attribText:"",_version:"1.0.0",_googleStyle:!1,_crossOrigin:!0,_dimensions:[],setup:function(t){this._providerURL=t.url,this._services=t.services,this._globe=t.services[0].globe,this._isRest=t.url&&".xml"===t.url.substr(-4,4).toLowerCase(),this._defStyle=t.style,t.tmSet_o||(this._getWMTSCapabilities(t),this._isConfig=!1),this._mapEPSG=GCO5.appModel.getInfo("infoFromMapName",[t.mapName,"epsg"]),this._googleStyle=!1,this._useProxy=this._services[0].useProxy||!1},getGlobe:function(){return this._services[0].globe},_useProxy:!1,getTiles:function(t,e,i,n,r,a){t=this.getTileIndicesBoundsFromExtent(t,e),e=this._discreteZooms?1:this.getTileScaleRatio(e,1/i),i=n.x,n=n.y;return{tiles:t,transform:"matrix3d("+[e,0,0,0,0,e,0,0,0,0,e,0,i,n,0,1]+")",tr:[i,n],scale:e,corrdx:0,corrdy:0,dx:0,dy:0,k:e}},updateService:function(t,e){e=this._super(t,e);return e<0?console.warn("erreur wmts updateService",t,this._ly_a):(this._tileMatrixSet=this._ly_a[e].tmset,this._imgFormat=this._ly_a[e].format,this._styles=this._ly_a[e].style,this._resourceURL=this._ly_a[e].resourceURL,this._dimensions=this._ly_a[e].dimensions,this._setAttribText(),this._setPyramid(this._tmSet_o[this._ly_a[e].tmset])),e},_setAttribText:function(){var t=GCO5.core.GcArrayUtil.getAttrByKey(this._services,"service",this._serviceName,"lib");this._attribText=" - "+this._globeLib+", ",this._attribText+=t||this._ly_a[j].lib},_endSetup:function(t){this._setPyramid(t),this._isConfig=!0},_getWMTSCapabilities:function(t){GCO5.appModel.loadWMSCap(t.url,{globe:t.services[0].globe,layer:t.serviceName},t.mapName,!0,t,this.onCapabilities,this,t.view)},onCapabilities:function(t,e){var t=$(t).find("Contents"),i=Array.isArray(this._services)?GCO5.core.GcArrayUtil.getColumnByKey(this._services,"layers"):null,i=this.parseCapabilitiesForLayers(t,i),t=this.parseTileMatrixSet(t,i);this._ly_a=i,this._tileMatrixSet=t.tileMatrixSet,this._tmSet_o=t.tileMatrix,this._serviceName=i[0].service,this._imgFormat=i[0].format,this._styles=i[0].style,this._resourceURL=i[0].resourceURL,this._setAttribText(),this._dimensions=i[0].dimensions,this._endSetup(t.tileMatrix[this._tileMatrixSet]),e.onWmsCapabilities({provider:this._providerName,services:this._ly_a})},_parseLayerNode:function(t){var n={title:"",layerId:"",format:"",defaultStyle:null,legendURL:"",tmset:"",resourceURL:"",styles:[],tmset_a:[],dimensions:[]};return $(t).children().each(function(){var t,e,i=this.nodeName;"ows:Title"==i?n.title=$(this).text():"ows:Identifier"==i?n.layerId=$(this).text():"Format"==i?n.format=$(this).text():"Style"==i?(t=!1,$(this).attr("isDefault")&&(t=$(this).attr("isDefault")),$(this).children().each(function(){"Identifier"!==this.nodeName&&"ows:Identifier"!==this.nodeName||(t&&!n.defaultStyle||this._defStyle===$(this).text()?n.defaultStyle=$(this).text():n.styles.push($(this).text())),"LegendURL"===this.nodeName&&(n.legendURL=$(this).attr("xlink:href"))})):"TileMatrixSetLink"==i?(n.tmset=$(this).find("TileMatrixSet").text(),n.tmset_a.push(n.tmset)):"ResourceURL"==i?n.resourceURL=$(this).attr("template"):"Dimension"==i&&(e={},$(this).children().each(function(){"Identifier"!==this.nodeName&&"ows:Identifier"!==this.nodeName||(e.id=$(this).text()),"Default"===this.nodeName&&(e.default=$(this).text())}),n.dimensions.push(e))}),n},_getStyleForLayer:function(t,e,i){t=t&&0<t.length&t[i].styles,i=e.styles,e=e.defaultStyle;return t&&-1<i.indexOf(t)?t:e||(0<i.length?i[0]:"default")},parseCapabilitiesForLayers:function(t,n){var r=[],a=0,s=this;return t.find("Layer").each(function(){var t,e,i=s._parseLayerNode(this);(!n||0===n.length||0<=n.indexOf(i.layerId))&&(t=n?n.indexOf(i.layerId):a++,e=s._getStyleForLayer(n,i,t),r.push({service:i.layerId,lib:i.title,format:i.format,style:e,tmset:i.tmset,tmset_a:i.tmset_a,resourceURL:i.resourceURL,ordre:t,epsg:s._services[t].tileSrs,urlLegend:i.legendURL,aboveStat:s._services[t].aboveStat,dimensions:i.dimensions}))}),r.sort(function(t,e){return t.ordre-e.ordre}),r},parseTileMatrixSet:function(t,e){var i=GCO5.core.GcArrayUtil.getColumnByKey(e,"tmset_a").reduce(function(t,e){return t.concat(e)},[]),i=GCO5.core.GcArrayUtil.getDistinctValues(i),n={},r=this,a=(t.children().filter(function(){return"TileMatrixSet"===this.nodeName}).each(function(){var t=this;$(this).children().each(function(){"ows:Identifier"===this.nodeName&&0<=i.indexOf($(this).text())&&(n[$(this).text()]=r._buildTileMatrix(t))})}),0),s=e[0].epsg;return GCO5.core.GcStringUtil.isEmpty(s)&&(s=this._mapEPSG),e[0].tmset_a.forEach(function(t,e){n[t]&&n[t].supportedCRS.substr(-s.length,s.length)===s&&(a=e)}),{tileMatrixSet:e[0].tmset_a[a],tileMatrix:n}},_XMLToJson:function(t){var e={};return $(t).children().each(function(){var t=$(this).text();e[this.nodeName.split(":").pop()]=GCO5.core.GcMathUtil.isNumber(t)?parseFloat(t):t}),e},_buildTileMatrix:function(t){var e,i=this,n=[];return $(t).children().each(function(){"ows:SupportedCRS"==this.nodeName&&(e=$(this).text())}),$(t).find("TileMatrix").each(function(){n.push(i._XMLToJson(this))}),n.sort(function(t,e){return e.ScaleDenominator-t.ScaleDenominator}),{tileMatrix:n,supportedCRS:e}},getTile:function(t){var e,i=t[2],n=t[0],t=t[1],r=this._providerURL.split("|"),r=1<r.length?r[(n+t)%r.length]:this._providerURL;if(!r)return null;if(r.indexOf("http")<0&&(r="http://"+r),this._isRest&&!GCO5.core.GcStringUtil.isEmpty(this._resourceURL)){if(t<0||n<0)return null;e=this._getTileUrlForRest(r,i,n,t)}else e=this._useProxy?this._getTileUrlWithProxy(i,n,t):this._getTileUrl(r,i,n,t);return e},_getTileUrlForRest:function(t,e,i,n){var r=this._resourceURL.replace("{style}",this._styles).replace("{Style}",this._styles);return r=(r=(r=(r=r.replace("{TileMatrixSet}",this._tileMatrixSet)).replace("{TileMatrix}",this._tmId_a[e])).replace("{TileRow}",n)).replace("{TileCol}",i),this._dimensions.forEach(function(t){r=r.replace("{"+t.id+"}",t.default)}),r},_getTileUrlWithProxy:function(t,e,i){var n=GCO5.view.component.WMTSRasterProvider.CONFIG_URL_BASE+"globe="+encodeURI(this.getGlobe())+"&layer="+this._serviceName+"&fmt="+this._imgFormat;return n+="&tileMatrix="+this._tmId_a[t]+"&tileRow="+i+"&tileCol="+e},_getTileUrl:function(t,e,i,n){var r=t;return-1<r.indexOf("?")?"?"!=r.substr(-1,1)&&"&"!=r.substr(-1,1)&&(r+="&"):r+="?",r=(r=(r=(r=(r=(r=(r=(r+="SERVICE=WMTS&REQUEST=GetTile&EXCEPTIONS=text/xml")+("&VERSION="+this.getServiceVersion()))+("&LAYER="+this._serviceName))+("&FORMAT="+this._imgFormat))+("&STYLE="+(GCO5.core.GcStringUtil.isEmpty(this._styles)?"default":this._styles)))+("&TILEMATRIXSET="+this._tileMatrixSet))+("&TILEMATRIX="+this._tmId_a[e]))+("&TILEROW="+n)+("&TILECOL="+i),this._dimensions.forEach(function(t){r+="&"+t.id+"="+t.default}),r},getServiceVersion:function(){return this._version},getOrigin:function(t){return this._originMt_a[t]},_setPyramid:function(t){this._tileSizePx_a=[],this._tileSizeMt_a=[],this._tileRapMtPx_a=[],this._WToPyrMatrix_a=[],this._PyrToWMatrix_a=[],this._tileBounds_a=[],this._tmId_a=[],this._originMt_a=[];var e=t.tileMatrix,i=e.length;this._minZoomLevel=0,this._maxZoomLevel=i-1;for(var n=0;n<i;n++){var r=e[n],a=(this._tileSizePx_a.push(parseFloat(r.TileHeight)),this._tileRapMtPx_a.push(.28*parseFloat(r.ScaleDenominator)/1e3),this._tileSizeMt_a.push(r.ScaleDenominator*r.TileHeight*.28/1e3),this._tmId_a.push(r.Identifier.toString()),r.TopLeftCorner.toString().split(" ")),a=(this._originMt_a.push(new GCO5.model.geom.Point(parseFloat(a[0]),parseFloat(a[1]))),this._tileBounds_a.push(new GCO5.model.geom.Point(parseFloat(r.MatrixWidth),parseFloat(r.MatrixHeight))),a=1/this._tileSizeMt_a[n],(r=new GCO5.model.geom.Matrix(a,0,0,this._yOrientBottom?-a:a)).transformPoint(this._originMt_a[n].x,this._originMt_a[n].y));r.translate(-a.x,-a.y),this._WToPyrMatrix_a.push(r),(a=r.clone()).invert(),this._PyrToWMatrix_a.push(a)}}}),GCO5.view.component.IGNWMTSRasterProvider=GCO5.view.component.WMTSRasterProvider.extend({statics:{NAME:"GCO5.view.component.IGNWMTSRasterProvider",getLayersDef:function(t,e){t&&t.intranetRestricted&&(this._intranetRestricted=!0);var i=[];if(e&&0<e.length)for(var n=0;n<e.length;n++){var r=e[n],r={service:r.c_layer,format:r.c_fmt,styles:r.c_style,layers:r.c_layer,lib:r.c_lib_layer,tileSrs:r.c_epsg,fitToRes:!0,res:"0.5 1 2 4 8 16 32 64 128 256 512 1024 2048",url:r.c_url_layer,aboveStat:!!r.c_abovestat};i.push(r)}return[{provider:GCO5.view.component.ARasterProvider.IGNWMTS,id_globe:t.c_id_globe,lib:t&&t.c_lib_globe?t.c_lib_globe:"IGN Géoportail",apiKey:t.key,capURL:t.c_url,icoName:"p_gp",services:i,useProxy:t.c_use_proxy}]}},_cartesIgn:null,_intranetRestricted:null,_serviceName:null,_providerName:GCO5.view.component.ARasterProvider.IGNWMTS,_attribText:"© IGN - Géoportail",defaultAttribText:"© IGN - Géoportail",_version:"1.0.0",_services:[],_useProxy:!1,_serviceCapabilities:{},setup:function(t){this._view=t.view,this._super(t)},getGlobe:function(){return GCO5.view.component.ARasterProvider.IGNWMTS},_isUpdating:!1,updateService:function(t,e){this._isUpdating=!0,this._updatingParams=[t,e],this._serviceName=t;var i=GCO5.core.GcArrayUtil.indexOfByKey(this._services,"service",this._serviceName);if(i<0&&(i=0,console.warn('Unknown service name "'+this._serviceName+'" for IGNWMTS service. First service will be displayed.')),0<=i&&this._serviceCapabilities&&this._serviceCapabilities[this._services[i].url])this._setCurrentCapabilities();else if(!this._serviceCapabilities||!this._serviceCapabilities[this._services[i].url])return this._getWMTSCapabilities({url:this._services[i].url,mapName:e.mapName,services:this._services,view:this._view}),this._isConfig=!1;return this._super(t,e)},_stateOfCapabilities:{expected:999,asked:0,response:0},_getWMTSCapabilities:function(i){var t;if(this._serviceName&&this._serviceCapabilities){if(t=GCO5.core.GcArrayUtil.indexOfByKey(this._services,"service",this._serviceName),this._serviceCapabilities[this._services[t].url])return this._endSetup(this._tmSet_o[this._tileMatrixSet]),void i.view.onWmsCapabilities({provider:this._providerName,services:this._ly_a})}else t=0;var e=[],n=[],r=(0<=t?(e=[this._services[t].url],n=[this._services[t].layers]):this._services.forEach(function(t){e.indexOf(t.url)||(e.push(t.url),n.push(t.layers))}),this._stateOfCapabilities={expected:e.length,asked:0,response:0},this);e.forEach(function(t,e){r._serviceCapabilities&&r._serviceCapabilities[t]||(GCO5.appModel.loadWMSCap(t,{globe:GCO5.view.component.ARasterProvider.IGNWMTS,layer:n[e]},i.mapName,!0,i,r.onCapabilities,r,[i.view,t]),r._stateOfCapabilities.asked+=1)})},onCapabilities:function(t,e){var i=e[0],e=e[1],t=$(t).find("Contents"),n=Array.isArray(this._services)?GCO5.core.GcArrayUtil.getColumnByKey(this._services,"layers"):null,n=this.parseCapabilitiesForLayers(t,n),t=this.parseTileMatrixSet(t,n);if(this._serviceCapabilities[e]={_ly_a:n,_tileMatrixSet:t.tileMatrixSet,_tmSet_o:t.tileMatrix,_imgFormat:n[0].format,_styles:n[0].style,_resourceURL:n[0].resourceURL,_attribText:" - "+this._globeLib+", "+n[0].lib},this._stateOfCapabilities.response+=1,this._stateOfCapabilities.response===this._stateOfCapabilities.expected&&(this._setCurrentCapabilities(),this._endSetup(t.tileMatrix[this._tileMatrixSet]),i.onWmsCapabilities({provider:this._providerName,services:this._ly_a})),this._isUpdating)return this.updateService(this._updatingParams[0],this._updatingParams[1])},_setCurrentCapabilities:function(){var t,e,i;this._serviceName?t=GCO5.core.GcArrayUtil.indexOfByKey(this._services,"service",this._serviceName):this._serviceName=this._services[t=0].service,-1<t&&(t=this._services[t],e=this._serviceCapabilities[t.url],i=GCO5.core.GcArrayUtil.indexOfByKey(e._ly_a,"service",this._serviceName),i=e._ly_a[i],this._ly_a=e._ly_a,this._tileMatrixSet=e._tileMatrixSet,this._tmSet_o=e._tmSet_o,this._imgFormat=i.format,this._styles=i.style,this._resourceURL=i.resourceURL,this._setAttribText(),this._providerURL=t.url,this._isRest=!1)},getServiceVersion:function(){return this._version}}),GCO5.model.indics.MapIndicModel=GCO5.Class.extend({statics:{NAME:"GCO5.model.indics.MapIndicModel",CHORO_NUM:"Choro_Num",CHORO_HEAT:"Choro_Heat",CHORO_VI:"Choro_VI",SYMB_GRAD:"Symb_Grad",SYMB_PTVI:"Symb_PointVI",SYMB_LNVI:"Symb_Line",SYMB_PTCHORO:"Symb_PointDiscr",SYMB_DOT:"Symb_Dot",SYMB_FLUX:"Symb_Flux",SYMB_OURSINS:"Symb_Ours",ETIQ:"Etiq",CHORO:"Choro",SYMB:"Symb",DEFAULT_COLFAM_ORDERED:"GC_YelReds",DEFAULT_COLFAM_DIVERGING:"GC_BlueOras",DEFAULT_COLFAM_SOLDE:"GC_GrnPurple",COLGRIS:"#f0f0f0",COLFPTVI:d3.scaleOrdinal(d3.schemeCategory10).range(),COLFVI:d3.schemeCategory20=["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"],getScatFromCat:function(t){return t.split("_")[0]},getDefaultDivergingColFam:function(){return GCO5.appModel.isDivergingColfam(this.DEFAULT_COLFAM_DIVERGING)?this.DEFAULT_COLFAM_DIVERGING:GCO5.appModel.getInfo("hexColorsFromColFam",[null,"C",{diverging:1}])[0].idColFam}},indicModel:null,_updated:!1,styles:null,calcs:null,filts:null,cat:null,isMapIndicModel:null,_lydef_o:null,choroCodes:null,distrib:null,_animating:null,_hasColGris:null,initialize:function(t){t&&(t.cat==GCO5.model.indics.MapIndicModel.ETIQ||t.isIndicModel&&t.isFullyLoaded())?(this.styles={enabled:!0},this.calcs={},this.filts={},this._setup(t)):console.error("indicModel absent ou incomplet")},getIndicModel:function(){return this.indicModel},setAnimateMode:function(t){this._animating=t},_setup:function(t){this.indicModel=t;this.constructor;t.isIndicModel?this.cat=t.getMappingCategory():this.cat=t.cat,this.resetParams(),this._addProxyFunctions(),this.isMapIndicModel=!0},setSerie:function(t,e){e&&e.fromAnim||(this.choroCodes=null,this.distrib=null),this.indicModel.setSerie(t,e)},setF0Code:function(t,e){this.choroCodes=null,this.distrib=null,this.indicModel.setF0Code(t,e)},resetParams:function(t){var e=this.constructor;return t&&"*"!=t&&"styles"!=t||(this.styles={enabled:!0}),t&&"*"!=t&&"calcs"!=t||(this.calcs={}),this.choroCodes=null,this.distrib=null,this.cat==e.CHORO_VI||this.cat==e.SYMB_PTVI||this.cat==e.SYMB_LNVI?this._buildChoroVIParams(t):this.cat==e.CHORO_NUM||this.cat==e.SYMB_PTCHORO?this._buildChoroCParams(t):this.cat==e.SYMB_GRAD?this._buildSymbRParams(t):this.cat==e.SYMB_OURSINS?this._buildSymbOParams(t):this.cat==e.SYMB_FLUX&&this._buildSymbFParams(t),this},exportParams:function(t){var e=this.constructor;return this.cat==e.CHORO_VI||this.cat==e.SYMB_PTVI?this._getUpdatedParams("ChoroVI",t):this.cat==e.CHORO_NUM||this.cat==e.SYMB_PTCHORO?this._getUpdatedParams("ChoroC",t):this.cat==e.SYMB_GRAD?this._getUpdatedParams("SymbR",t):this.cat==e.SYMB_OURSINS?this._getUpdatedParams("SymbO",t):this.cat==e.SYMB_FLUX?this._getUpdatedParams("SymbF",t):void 0},_addProxyFunctions:function(){var t,e=["getPk","getExtendedPk","getPkF1","getPkF1Safe","getProp","hasMultiplePeriods","applyToPolygons","applyToPoints","applyToLines","updateWithServerFullData","hasDivergingColorPalette","hasDataForMapName","checkSeriesValues","checkFilter1Values","onImportedData","valuesDisplayable","valuesExportable","getValues","getFormattedValue","getFormattedValrefs","setSelectionInfo","getFormattedDataByData","buildIndicAssocModel","linkAssocModel","getActualFilter1Array","getRefgeoData","getLayerName","getDataset","isZonage","hasValidData","getNivgeosArray","setOption","getOption","getMappingSuperCategory","getFormattedDataById","getDataICById","getDataICBoundById","isTJS","isExternalTJS","hasMultVars","hasFormula","isRatio","getStat","isNumeric","isQualitative","isAdditive","isPie","getF1Lib","isAgregable"];for(t in e){var i=e[t];this[i]=$.proxy(this.indicModel[i],this.indicModel)}},clearComputedData:function(){this.choroCodes=null,this.distrib=null,this.indicModel.clearComputedData()},getChoroCodes:function(t){return!t&&this.choroCodes?this.choroCodes:this.indicModel.getProp("defaultChoroCodes")||(t={meth:this.getMeta("meth")||GCO5.model.indics.Distrib.QUANT,nbClasses:this.getMeta("nbClasses")||5,serie:t,frm_o:this.indicModel.getProp("formulaStructure")},this.updateWithDefs(t),this.choroCodes)},setLayerDef:function(t){this._lydef_o=t},getLayerDef:function(t){return this._lydef_o},isSVGExportable:function(){return this.isChoro()||this.isRonds()||this.isOursins()||this.isVI()},isFlux:function(){return this.cat==this.constructor.SYMB_FLUX},isOursins:function(){return this.cat==this.constructor.SYMB_OURSINS},isRonds:function(){return this.cat==this.constructor.SYMB_GRAD},isChoro:function(){return this.isChoroNum()||this.isChoroVI()},isVI:function(){return this.isSymbVI()||this.isChoroVI()},isSymbVI:function(){return this.cat==this.constructor.SYMB_PTVI||this.cat==this.constructor.SYMB_LNVI},isSymbDiscr:function(){return this.cat==this.constructor.SYMB_PTCHORO},isTypoPole:function(){return this.isChoroVI()&&"pole"===this.indicModel.getProp("idColorFamily")},hasRanges:function(){return this.isChoro()||this.isSymbVI()},isChoroNum:function(){return this.applyToPolygons()&&this.isRatio()||this.isSymbDiscr()},isChoroVI:function(){return this.cat==this.constructor.CHORO_VI},isChoroNonAgreg:function(){return this.isChoroNum()&&!this.hasFormula()},getViewInfo:function(t){return GCO5.appModel.getInfo("viewDef",[t,this.indicModel.getProp("nivgeos")])},isEnabled:function(){return!!this.styles.enabled},enable:function(){this.styles.enabled=!0},disable:function(){this.styles.enabled=!1},getHighlightedMod:function(){var t=-1,e=this.styles.classesVisibility;if(!e)return-1;for(var i=0,n=0;n<e.length;n++)1==e[n]&&(t=n,i++);return t=i==e.length?-1:t},_buildChoroVIParams:function(t){var e=this.indicModel,i={};if(!t||"*"==t||"styles"==t||"orig"==t||this.isTypoPole()){for(var n={classesVisibility:[],idColFam:e.getProp("idColorFamily"),colf:e.getProp("hexColors"),contVis:"auto"},r=(n.sizes=e.getProp("sizes"),n.symbs=e.getProp("symbs"),e.getProp("vIMods")),a=0;a<=r.length;a++)n.classesVisibility[a]=!0;n.disperseRadius=e.getProp("disperseRadius"),"orig"!=t?GCO5.core.GcObjectUtil.extend(this.styles,n):i.styles=n}if(t&&"*"!=t&&"calcs"!=t&&"orig"!=t||(n={nbClasses:e.getProp("VIMods").length,distribInfo:e.getProp("firstDistribInfo")},"orig"!=t?GCO5.core.GcObjectUtil.extend(this.calcs,n):i.calcs=n),"*"!=t&&this._readCustomMapParams(e),"orig"==t)return i},_getUpdatedParams:function(t,e){e=e||{};var i,n=this["_build"+t+"Params"]("orig"),r={styles:{},calcs:{}};for(i in this.styles)"enabled"!=i&&(a=this.styles[i],s=JSON.stringify(a),void 0===a||n.styles.hasOwnProperty(i)&&s==JSON.stringify(n.styles[i])||(r.styles[i]=JSON.parse(s)));for(i in this.calcs){var a=this.calcs[i],s=JSON.stringify(a);void 0===a||n.calcs.hasOwnProperty(i)&&s==JSON.stringify(n.calcs[i])&&!this.onImportedData()||(r.calcs[i]=JSON.parse(s))}return e.svg&&(e=this._addParamsDefForSVG(t),GCO5.core.GcObjectUtil.extend(r.styles,e.styles),GCO5.core.GcObjectUtil.extend(r.calcs,e.calcs)),r},_addParamsDefForSVG:function(t){var e={styles:{},calcs:{}};return"SymbR"==t&&(e.styles.sqrtValuesToSymbRadiusInWorldUnit=this.styles.sqrtValuesToSymbRadiusInWorldUnit,e.styles.isRondsAssoc=this.isRondsAssoc(),e.styles.indicAssoc=this.isRondsAssoc()?this.getAssocModel().getPk():null),"ChoroC"==t&&(e.styles.colf=this.getMeta("colf"),e.calcs.seuils=this.getMeta("seuils"),e.calcs.seuilsinf=this.getMeta("seuilsinf"),e.calcs.efts=this.getMeta("efts"),e.calcs.k_valref=this.getDiscretisationInfo()?this.getDiscretisationInfo().k_valref:-1,e.calcs.valref_txt=this.getProp("refMention",!0,!0),(t=this.getDiscretisationInfo().efts.concat().slice(0,this.getProp("nbClasses")+1))[this.getProp("nbClasses")]=e.calcs.eftNA=t.shift(),e.calcs.efts=t),e},_buildChoroCParams:function(t){var e=this.indicModel,i={};if(!t||"*"==t||"styles"==t||"orig"==t){for(var n={classesVisibility:[],idColFam:e.getProp("idColorFamily"),colf:e.getProp("hexColors"),contVis:"auto"},r=0;r<20;r++)n.classesVisibility[r]=!0;if(this.isSymbDiscr()){for(n.symbs=[],n.sizes=[],r=0;r<e.getProp("nbClasses");r++)n.symbs[r]=e.getStat("eftvalth")<20?"sq":"cc",n.sizes[r]=e.getStat("eftvalth")<20?10:5;n.disperseRadius=e.getProp("disperseRadius")}"orig"!=t?GCO5.core.GcObjectUtil.extend(this.styles,n):i.styles=n}if(t&&"*"!=t&&"calcs"!=t&&"orig"!=t||(n={nbClasses:e.getProp("nbClasses"),seuils:e.getProp("seuils"),seuilsinf:e.getProp("seuilsinf")||(e.getProp("seuils")?e.getProp("seuils").concat():[]),meth:e.getProp("discretizeMethod"),includeValref:0<=e.getProp("kValref"),treatment:"",frm_o:e.getProp("formulaStructure"),lissIntensity:0,calcBreaksOnSel:!1,ind:"v",discretizationInfo:e.getProp("firstDiscretizationInfo"),distribInfo:e.getProp("firstDistribInfo")},"orig"!=t?GCO5.core.GcObjectUtil.extend(this.calcs,n):i.calcs=n),"*"!=t&&(this._readCustomMapParams(e),this.calcs.discretizationInfo&&(this.choroCodes=this.calcs.discretizationInfo.codes)),"orig"==t)return i},_readCustomMapParams:function(t,e){(e=!e&&t?t.getProp("mapParams"):e)&&(GCO5.core.GcObjectUtil.extend(this.styles,e.styles),GCO5.core.GcObjectUtil.extend(this.calcs,e.calcs))},getRondsStrokeColor:function(t){if(this.getMeta("contourAuto")&&(this.hasMultVars()||0<this.indicModel.getStat("nv_neg")))return"#999";var e="sp"==this.getMeta("idSymb");return void 0===t&&(t=this.getMeta("colf")[0]),this.getMeta("contourAuto")?e?GCO5.core.GcMathUtil.binToHex(GCO5.core.GcMathUtil.adjustBrightness2(t,-15)):1==this.getMeta("rdplein")?"#fff":t:1==this.getMeta("rdplein")?this.getMeta("cols"):t},_buildSymbRParams:function(t){var e=this.isRondsAssoc()||"1"==GCO5.appModel.getOption("flatCirclesInMap"),i={},n=this.indicModel;if(!t||"*"==t||"styles"==t||"orig"==t){var r=n.getProp("hexColors")||["#f00"],a=n.getKey("c_rdmax"),s=GCO5.view.component.SymbGradThemeView,o=(GCO5.core.GcMathUtil.isNumber(a)||"PT"!=n.getProp("topology")||(a=40),1==GCO5.appModel.getOption("disableAutoContrastForGraduatedSymbols")),l={resizeOnSel:!1,sizeComputation:a?"max":"area",rdmax:a||40,sizeRef:40,valRef:n.getProp("absoluteMaximum"),fillOpacity:n.getProp("fillOpacity"),colf:r,fillAuto:!n.isPie()&&r.length<=2&&!o,classesVisibility:[],rdplein:Number(1==n.getProp("symbFillActive")),shape:n.getProp("symbShape"),idSymb:e?"cc":{cc:"dq",dq:"dq",sp:"sp",es:"sq",sq:"sq"}[n.getProp("symbShape")],contourAuto:!0,epCont:e?1:.5,cols:"#fff",sqrtValuesToPixels:0,areaRatio:s.SYMB_AREA_RATIO,softLockCorresp:1!=GCO5.appModel.getOption("lockStrongCircleSizes")};GCO5.appModel.getOption("circlesStrokeDefaultColor")&&(l.cols=GCO5.appModel.getOption("circlesStrokeDefaultColor"),l.contourAuto=!1),n.applyToPoints()&&!n.isPie()&&(l.epCont=1),s.sizeLocked&&(l.valRef=s.valRef,l.sizeRef=s.sizeRef,l.sizeComputation="corresp");for(var c=0;c<20;c++)l.classesVisibility[c]=!0;"orig"!=t?GCO5.core.GcObjectUtil.extend(this.styles,l):i.styles=l}if(t&&"*"!=t&&"calcs"!=t&&"orig"!=t||(l={distribInfo:n.getProp("firstDistribInfo"),valmax:n.getProp("absoluteMaximum")},"orig"!=t?GCO5.core.GcObjectUtil.extend(this.calcs,l):i.calcs=l),"*"!=t&&this._readCustomMapParams(n),"orig"==t)return i},updateCalcs:function(){var t=this.indicModel;this.calcs.distribInfo&&this.calcs.valmax||GCO5.core.GcObjectUtil.extend(this.calcs,{distribInfo:t.getProp("firstDistribInfo"),valmax:t.getProp("absoluteMaximum")})},_buildSymbOParams:function(t){var e={},i=this.indicModel;if(!t||"*"==t||"styles"==t||"orig"==t){for(var n={colf:i.getProp("hexColors"),classesVisibility:[],epCont:1},r=0;r<20;r++)n.classesVisibility[r]=!0;"orig"!=t?GCO5.core.GcObjectUtil.extend(this.styles,n):e.styles=n}if(t&&"*"!=t&&"calcs"!=t&&"orig"!=t||(n={distribInfo:i.getProp("firstDistribInfo")},"orig"!=t?GCO5.core.GcObjectUtil.extend(this.calcs,n):e.calcs=n),"*"!=t&&this._readCustomMapParams(i),"orig"==t)return e},getBendingFactorAsNum:function(t){return"LOW"===t?-.045:"INTERM"===t?-.055:"HIGH"===t?-.075:void 0},_buildSymbFParams:function(t){var e={},i=this.indicModel;if(!t||"*"==t||"styles"==t||"orig"==t){var n=i.getProp("hexColors"),r=i.getProp("alphas"),a=n.map(function(t,e){return GCO5.core.GcMathUtil.hexToRGBAString(t,r[e])}),s={colf:n,colfa:a,eps:i.getProp("eps"),alphas:i.getProp("alphas"),classesVisibility:[],arrows:i.getProp("showArrow"),bendingFactor:i.getProp("fluxCurveLevel"),crossFluxVisibles:!1,positionArrows:"middle",fluxOrder:"1"==i.getProp("drawSymbsAsc")?"asc":"desc",arrowThreshold:GCO5.view.component.SymbFluxThemeView.SEUIL_ARROW};console.log("drawSymbsAsc",i.getProp("drawSymbsAsc")),s.bending="ac"==i.getProp("symbShape");for(var o=0;o<20;o++)s.classesVisibility[o]=!0;"orig"!=t?GCO5.core.GcObjectUtil.extend(this.styles,s):e.styles=s}if(t&&"*"!=t&&"calcs"!=t&&"orig"!=t||(s={distribInfo:i.getProp("firstDistribInfo"),nbClasses:i.getProp("nbClasses"),seuils:i.getProp("seuils"),seuilsinf:i.getProp("seuilsinf")||(i.getProp("seuils")?i.getProp("seuils").concat():[]),discretizationInfo:i.getProp("firstDiscretizationInfo")},"orig"!=t?GCO5.core.GcObjectUtil.extend(this.calcs,s):e.calcs=s),"*"!=t&&this._readCustomMapParams(i),"orig"==t)return e},updateAfterChangeView:function(){var t,e,i,n,r,a;this.resetParams("calcs"),this.hasValidData()&&(t=this.getDiscretisationInfo(),e=this.getDistribInfo(),i=t?t.nclasseneutre:0,r=GCO5.appModel.isDivergingColfam(this.getMeta("idColFam")),a=this.indicModel.getProp("idColorFamily")!=this.getMeta("idColFam"),!t||r||this.styles.colf[0]!=this.constructor.COLGRIS&&1!=i?((r||this.getMeta("colf").length<this.getMeta("nbClasses"))&&t&&(n=a?this.getChoroPalette(t,e):t.colorPalette)&&(this.styles.colf=n),this.styles.classesVisibility.fill(!0,0,this.getMeta("nbClasses"))):(n=a?this.getChoroPalette(t,e):t.colorPalette)&&(this.styles.colf=n))},getHexColors:function(){var t,e=this.getMeta("colf");return this.isSymbDiscr()&&1==e.length&&GCO5.core.GcMathUtil.isGray(e[0])&&(e[0]="#888"),e||("C"==this.getProp("type")?(t=this.getMeta("nbClasses"),(e=GCO5.appModel.getInfo("hexColorsFromColFam",[this.getMeta("idColFam"),"C",{c_ncols:t}]))?e=e[0].c_coldef:t<(e=GCO5.appModel.getInfo("hexColorsFromColFam",[this.getMeta("idColFam"),"C"]))[0].c_ncols&&(e=e[0].c_coldef.slice(0,t)),e):"F"==this.getProp("type")?this.getMeta("col"):void 0)},getAssocModel:function(){return this.indicModel.getAssocModel()},isRondsAssoc:function(){return this.getAssocModel()&&this.isRonds()},getHeaderColor:function(){var t=this.getHexColors();return this.isRondsAssoc()||!this.hasValidData()&&!this.getProp("filter1")?"#999":GCO5.core.GcMathUtil.getD3VividColor(t)},getDefaultStandardColFam:function(){var t=this.constructor;return GCO5.appModel.getInfo("hexColorsFromColFam",[t.DEFAULT_COLFAM_ORDERED,"C",{diverging:0}])?t.DEFAULT_COLFAM_ORDERED:GCO5.appModel.getInfo("hexColorsFromColFam",[null,"C",{diverging:0}])[0].idColFam},_choroPaletteNeedUpdating:function(t){return!this.styles.colf||GCO5.appModel.isDivergingColfam(t)||this.calcs.meth!=this.getProp("discretizeMethod")||this.calcs.nbClasses!=this.getProp("nbClasses")},updateWithDefs:function(t,e,i){var n,r,a,s=this._getNewCalcParams(t),o=this._getNewStyleParams(t);o&&(GCO5.core.GcObjectUtil.extend(this.styles,o),o.idColFam&&this._choroPaletteNeedUpdating(o.idColFam)&&(n=this.getDiscretisationInfo(),r=this.getDistribInfo(),n&&(a=this.getChoroPalette(n,r))&&(this.styles.colf=a))),GCO5.core.GcObjectUtil.isEmpty(s)||(GCO5.core.GcObjectUtil.extend(this.calcs,s),s.hasOwnProperty("calcBreaksOnSel")&&(this.calcs.selIds=s.calcBreaksOnSel?t.selIds:null),s.hasOwnProperty("treatment")&&""!=s.treatment?this.loadVarsFrm(e,i):(s.hasOwnProperty("meth")||s.hasOwnProperty("nbClasses")||s.hasOwnProperty("treatment")||s.hasOwnProperty("includeValref")||s.hasOwnProperty("frm_o")||s.hasOwnProperty("calcBreaksOnSel"))&&(n=(o=this.getDistrib(t.serie)).discretize(this.calcs),r=o.getAnalyzeInfo(),(a=this.getChoroPalette(n,r))&&(this.styles.colf=a),this.calcs.seuils=n.seuils,this.calcs.seuilsinf=n.seuilsinf,this.calcs.discretizationInfo=n,this.calcs.distribInfo=r,this.choroCodes=n.codes)),this._updated=!0},areVarsFrmLoaded:function(){var t,e=this.getProp("formulaStructure"),i=this.distrib;if(!e)return!0;var n=e.var1,e=e.var2;return t=i&&n&&e&&i.hasColData("var1")&&i.hasColData("var2")?!0:t},loadVarsFrm:function(n,r){function t(t){t&&(s.setColData(t),s.registerTopology(GCO5.appModel.getRefData(a.getProp("nivgeo"),a.getProp("idExtent"))));var t=s.discretize(this.calcs),e=s.getAnalyzeInfo(),i=a.getChoroPalette(t,e);i&&(a.styles.colf=i),a.calcs.seuils=t.seuils,a.calcs.seuilsinf=t.seuilsinf,a.calcs.discretizationInfo=t,a.calcs.distribInfo=e,a.choroCodes=t.codes,n&&n.apply(r,[a])}var a=this,e=this.getProp("formulaStructure"),i=[e.var1,e.var2],s=(GCO5.core.GcStringUtil.isEmpty(e.var3)||i.push(e.var3),this.getDistrib());this.areVarsFrmLoaded()?t.apply(this):(e=[],this.getProp("serie")&&e.push(this.getProp("varSerie")+"="+this.getProp("serie")),this.getProp("f1Code")&&e.push(this.getProp("filter1")+"="+this.getProp("f1Code")),i={idView:this.getProp("idView"),idDataset:this.getProp("idDataset"),idIndic:this.getProp("idIndicateur"),vars_a:i},0<e.length&&(i.axis=e.join(",")),GCO5.appModel.loadColData(t,this,i))},loadColData:function(t,e,i){var n=[i];this.onImportedData()?t.apply(e,[this.getProp("ColData",i,this.getProp("serie"))]):(i=[],this.getProp("serie")&&i.push(this.getProp("varSerie")+"="+this.getProp("serie")),this.getProp("f1Code")&&i.push(this.getProp("filter1")+"="+this.getProp("f1Code")),n={idView:this.getProp("idView"),idDataset:this.getProp("idDataset"),idIndic:this.getProp("idIndicateur"),vars_a:n},0<i.length&&(n.axis=i.join(",")),GCO5.appModel.loadColData(t,e,n))},getDistrib:function(t){var e;if(!this.distrib||t){if(e=new GCO5.model.indics.Distrib(this.getValues(null,t),{includeValref:!0,divergingValue:this.getProp("divergingValue"),precision:this.getProp("nbDec"),valref:this.getProp("valRef")}),t)return e;this.distrib=e}return this.distrib},getNcolorsPalette:function(t,e,i,n,r){i=i||GCO5.appModel.getInfo("hexColorsFromColFam",[t,"C"]);var a=this.constructor;if(i)for(var s=0;s<i.length;s++){var o=i[s];if(o.c_ncols>=e){h=o.c_coldef;break}}if(h)h=h.slice(0,e);else{if(t!=a.DEFAULT_COLFAM_ORDERED)return this.getNcolorsPalette(a.DEFAULT_COLFAM_ORDERED,e,null,n,r);t=a.DEFAULT_COLFAM_ORDERED;var l=GCO5.appModel.getInfo("hexColorsFromColFam",[t,"C"]),l=(o=l[l.length-1]).c_ncols;if(h=o.c_coldef,l<e)for(var c=l-e,h=h.concat([a.COLGRIS]),s=0;s<c-1;s++)h.push(a.COLGRIS)}return 1==n&&(h[r]=this.constructor.COLGRIS),{coldef:h,idColFam:t}},_findColorPalette:function(t,e,i,n,r,a){var s,o,l,c,h=this.constructor,d=!!t&&GCO5.appModel.isDivergingColfam(t),u=n+r+a,p=null!=this.getAssocModel(),i=(t=!1===d&&i?h.getDefaultDivergingColFam():t||this.getDefaultStandardColFam(),void 0===i&&d&&(i=!0),GCO5.appModel.getInfo("hexColorsFromColFam",[t,"C"])),g=i?i[i.length-1].c_ncols:0;return 0==n&&0<u&&!d?(s=(o=this.getNcolorsPalette(t,e+(u=p?1:0),i,r,n)).coldef.slice(u),t=o.idColFam):s=g<(d=2*Math.max(n,a)+r)?(t=this.getDefaultStandardColFam(),this.getNcolorsPalette(t,e,null,r,n).coldef):(p=(o=this.getNcolorsPalette(t,d,i,r,n)).coldef,u=d%2==0?(c=p.slice(0,l=d/2),p.slice(l,d)):(c=p.slice(0,l=(d-1)/2),p.slice(l+1,d)),c=c.slice(Math.max(c.length-n,0),c.length),u=u.slice(0,a),s=c,1==r&&s.push(h.COLGRIS),s.concat(u)),this.styles.idColFam=t,s},getChoroPalette:function(t,e){var i,n=this.getMeta("idColFam"),r=this.getMeta("meth"),a=t.nclasses_quant_sup,s=t.nclasseneutre,o=t.nclasses_quant_inf,l=t.nclasses,c=(null==s&&(s=0),null==o&&(o=0),null==l&&(l=0),null==a&&(a=l-o),e.diverging||!1),h=e.diverging_value,d=GCO5.appModel.isDivergingColfam(n),u=this.indicModel.getProp("idColorFamily");GCO5.appModel.isDivergingColfam(u);return!c&&0<=e.maxth&&d&&this.getMeta("includeValref")&&(c=void 0,h=this.getProp("valRef"),i=!0),r==GCO5.model.indics.Distrib.QUANT&&!i||(l=(a=(u=GCO5.model.indics.Distrib.getClassesGroups(t.seuils,h,e.minth,e.maxth,t.seuilsinf)).nclassespos)+(s=u.nclasseneutre)+(o=u.nclassesneg)),this._findColorPalette(n,l,c,o,s,a)},setStyleSilent:function(t,e){this.styles[t]=e},setCalcSilent:function(t,e){this.calcs[t]=e},_getNewFiltParams:function(t){var e,i={};for(e in t)this._isFiltParam(e)&&(i[e]=t[e]);return i},_getNewCalcParams:function(t){var e,i={};for(e in t)this._isCalcParam(e)&&(i[e]=t[e]);return i},_getNewStyleParams:function(t){var e,i={};for(e in t)this._isStyleParam(e)&&(i[e]=t[e]);return i},_isFiltParam:function(t){return null!=this.filts[t]},_isStyleParam:function(t){return null!=this.styles[t]},_isCalcParam:function(t){return null!=this.calcs[t]},getCategory:function(){return this.cat},getSuperCategory:function(){return GCO5.model.indics.MapIndicModel.getScatFromCat(this.cat)},getStatData:function(){return this.indicModel.getProp("values")},getCurrentHexColors:function(){for(var t=this.getHexColors(),e=this.styles.classesVisibility,i=[],n=0;n<t.length;n++)i.push(e[n]?t[n]:this.cat==this.constructor.SYMB_LNVI||this.cat==this.constructor.SYMB_PTVI?"rgba(0,0,0,0)":"#fff");return i},getDataById:function(t){return this.indicModel.getDataById(t)},isEstimatedValue:function(t){return this.indicModel.isEstimatedValue(t)},hasEstimatedValues:function(){return this.indicModel.hasEstimatedValues()},getMeta:function(t){return this.styles.hasOwnProperty(t)?this.styles[t]:this.calcs.hasOwnProperty(t)?this.calcs[t]:this.indicModel.getKey(t)},getData:function(t){return this.indicModel.getData(t)},getRangeInfoForVI:function(t,e,i,n,r,a,s,o,l,c){for(var h=this.getProp("VIMods"),d=this.getProp("VILibs"),u=this.getMeta("sizes"),p=this.getMeta("symbs"),g=d.length,f=[],m=(this.getProp("serie")&&(t=GCO5.core.GcArrayUtil.getSubArray(t,{gc_serie:this.getProp("serie")})),GCO5.core.GcArrayUtil.toIndexedObj(t,"code")),_=0;_<g;_++){var v=d[_];m&&m[h[_]]&&(!e&&m[h[_]]&&(v+=i+"("+n.formatNumber(m[h[_]].eft,0,r)+")"),a&&m[h[_]]&&0==m[h[_]].eft)||f.push({id:_,mod:h[_],colf:s[_],lib:v,lib0:v,visi:this.styles.classesVisibility[_],size:u?u[_]:null,symb:p?p[_]:null})}return 0<o.eftallnath&&!l&&(t=v=n.getString("NA","indics"),f.push({id:g,colf:GCO5.view.component.ChoroThemeView[this.isZonage()?"COL_NA_LIGHT":"COL_NA"],lib:v+(e?"":i+"("+n.formatNumber(o.eftallnath,0,r)+")"),lib0:t,visi:c[g],size:5,symb:"cc"})),f},getRangeInfoForDiscretized:function(t,e,i,n,r,a,s,o,l,c){var h,d=this.constructor,u=this.calcs.seuils,p=this.calcs.seuilsinf,g=this.getProp("nbDec"),f=" "+n.getString("TO")+" ",m=[];if(!u)return null;for(var _,v=this.getMeta("alphas"),y=this.getMeta("eps"),b=(v&&(_=s.map(function(t,e){return GCO5.core.GcMathUtil.hexToRGBAString(t,v[e])})),u.length+1),C=this.calcs.discretizationInfo,x=(this.cat==d.CHORO_NUM||this.cat==d.SYMB_FLUX)&&this.calcs.meth===GCO5.model.indics.Distrib.MANU&&"1"==GCO5.appModel.getOption("always_apply_custom_thresholds"),w=0;w<b;w++){var S=0==w?(h=x||o.minth>p[w]?"":n.formatNumber(o.minth,g,r),n.formatNumber(0<p.length?p[w]:o.maxth,g,r)):w<b-1?(h=n.formatNumber(u[w-1],g,r),n.formatNumber(p[w],g,r)):(h=n.formatNumber(u[w-1],g,r),x||o.maxth<u[w-1]?"":n.formatNumber(o.maxth,g,r)),M=h==S?h:h+f+S,O=(x&&(0==w&&(M=n.getString("LESS_THAN")+" "+n.formatNumber(u[0],g,r)),w==b-1&&(M="undefined"!=n.getString("MORE_THAN2")?n.formatNumber(u[w-1],g,r)+" "+n.getString("MORE_THAN2"):n.getString("MORE_THAN")+" "+n.formatNumber(u[w-1],g,r))),C.efts&&!e&&((O=this.getProp("eftsFromAnimDp"))&&this.getProp("serie")?M+=i+"("+n.formatNumber(O[this.getProp("serie")][w+1],0,r)+")":M+=i+"("+n.formatNumber(C.efts[w+1],0,r)+")"),{id:w,colf:s[w],colfa:_?_[w]:null,lib:M,lib0:w<b-1?n.formatNumber(u[w],g,r):"",startValueLib:h,endValueLib:S,eps:y?y[w]:"",visi:c[w],eft:C.efts?C.efts[w+1]:0});this.cat==d.SYMB_PTCHORO&&(O.symb=this.getMeta("symbs")[w],O.size=this.getMeta("sizes")[w]),m.push(O)}return 2==b&&1==this.getMeta("nbClasses")&&(m=this.hasValidData()?[m[0]]:[]),0<o.eftallnath&&!l&&(l=M=n.getString("NA","indics"),e||(M+=i+"("+n.formatNumber(o.eftallnath,0,r)+")"),m.push({id:b,colf:GCO5.view.component.ChoroThemeView.COL_NA,colfa:GCO5.view.component.ChoroThemeView.COL_NA,lib:M,lib0:l,startValueLib:null,endValueLib:null,visi:c[b],symb:"cc",size:5})),m},getRangeInfoForSymbGrad:function(t,e){for(var i=this.getMeta("colf"),n=this.getProp("nbVars"),r=0<this.getStat("nv_neg")||1==n&&2==i.length,a=(r&&(n=2),[]),s=this.getProp("VILibs"),o=r?[t.getString("POSITIVE","indics"),t.getString("NEGATIVE","indics")]:s,l=0;l<n;l++){var c=o?o[l]:"";a.push({id:l,colf:i[l],symb:"cc",lib:c,visi:e[l]})}return a},getRangesInfo:function(t,e,i,n){var r=this.constructor,a=[],s=this.getMeta("colf"),o=GCO5.core.GcLangManager.getInstance(),l=this.calcs.distribInfo,c=this.styles.classesVisibility,h=t?" ":"&nbsp;",d=l?l.frequences:null;return void 0===e&&this._animating&&(e=!0),this.isChoroVI()||this.isSymbVI()?a=this.getRangeInfoForVI(d,e,h,o,t,n,s,l,i,c):this.cat==r.CHORO_NUM||this.cat==r.SYMB_FLUX||this.cat==r.SYMB_PTCHORO?a=this.getRangeInfoForDiscretized(d,e,h,o,t,n,s,l,i,c):this.cat==r.SYMB_GRAD&&(a=this.getRangeInfoForSymbGrad(o,a,c)),a},getDiscretisationInfo:function(){return this.distrib&&this.distrib.getDiscretisationInfo()||this.calcs.discretizationInfo},getDistribInfo:function(){return this.distrib?this.distrib.getAnalyzeInfo():this.calcs.distribInfo},getSortedFrequences:function(){var t=this.getDistribInfo();return t?t.frequences.concat().sort(function(t,e){return t.libgeo.localeCompare(e.libgeo)}):null},hasChanged:function(){return this._updated},_addListeners:function(){this.inited},destroy:function(){}}),GCO5.model.maps.GcCartogram=GCO5.Class.extend({statics:{NAME:"GCO5.model.maps.GcCartogram"},distortionGrid:null,statData:null,totalValues:null,valid:1,sizeErrorsTot:0,sizeErrorsNum:0,nb_iter:null,statTopoModel:null,opt_simplify:!0,_excessive_deformation:null,initialize:function(t,e,i,n,r){this.nb_iter=Math.max(1,Math.min(e,20)),this.distortionGrid=[],this.statTopoModel=t,this.nb_iter<=0||"DR"!==t.getTopology()||i.length!==t.getParams().nbObjs?(console.log("Cartogram non applicable"),console.log(i.length),console.log(t.getParams().nbObjs),console.log(t.getParams()),this.valid=-1):0<this.valid&&this._checkStatData(i,n,r)},isValid:function(){return this.valid},distortArcs:function(t){this._distortArcs(t,0===this.distortionGrid.length)},_checkStatData:function(t,e,i){var n=t.length;if(void 0===e&&(e=0,e=GCO5.core.GcArrayUtil.sum(t.filter(function(t){return!GCO5.core.GcMathUtil.isInvalid(t)}))),i||void 0===i){var r=this.statTopoModel.getAreas(),a=this.statTopoModel.getArea();this.statData=new Float32Array(n);for(var s=0;s<n;s++){var o=t[s];this.statData[s]=null===o||-9999==o||-99999==o||-999999==o||0==o||-8888==o?r[s]*e/a:o}}else this.statData=t;this.totalValues=e},_computedistortionGrid:function(t,e){for(var i=this.statTopoModel,n=(i.updateMetaDataAfterDistortion(),(new Date).getTime(),[]),r=i.getParams(),a=r.nbObjs,s=this.totalValues,o=this.statData,l=i.getCtrX(),c=i.getCtrY(),h=i.getAreas(),d=Math.abs(i.getArea()),u=(i.getBboxes(),0),p=[],g=(Math.max(a,500),Math.ceil(2*Math.sqrt(d/a/Math.PI))),f=r.ly_minx_px*r.mult_xy,m=r.ly_maxy_px*r.mult_xy,i=f+r.ly_w_px*r.mult_xy,r=m+r.ly_h_px*r.mult_xy,i=Math.ceil(Math.abs(i-f)/g)+2,_=Math.ceil(Math.abs(r-m)/g)+2,v=0,y=_*i;v<y;v++)p[v]={initialArea:0,area:0,desired:0,ctrx:0,ctry:0,mass:0,value:0};for(var b=0;b<a;b++){var C,x,w,S,M=Math.abs(h[b]),O=Math.abs(t[b]),G=o[b],I=d*G/s,T=Math.sqrt(M/Math.PI),A=Math.sqrt(I/Math.PI)-T;5<(D=Math.max(M,I)/Math.min(M,I))?(n.push({x:l[b],y:c[b],radius:T,mass:A,area:Math.abs(h[b]),value:G,desired:I,fijn1:A*T,fijn2:A/(T*T)}),this.sizeErrorsTot+=D,this.sizeErrorsNum++,0!=M&&(u=Math.max(Math.max(M,O)/Math.min(M,O),u))):(C=l[b],x=c[b],void 0===(P=p[(w=Math.floor((C-f)/g))*_+(S=Math.floor((x-m)/g))])?console.log("erreur fid=",b,"it=",e,"indice",indice,C,"xmin=",f,x,"ymin=",m,g,w,S):(P.area+=M,P.initialArea+=O,P.desired+=I,P.value+=G,Math.abs(A)>Math.abs(P.mass)&&(P.ctrx=C,P.ctry=x,P.mass=A)))}for(var P,D,v=0,E=p.length;v<E;v++)0!=(P=p[v]).area&&(T=Math.sqrt(P.area/Math.PI),A=Math.sqrt(P.desired/Math.PI)-T,D=Math.max(P.area,P.desired)/Math.min(P.area,P.desired),500<a&&D<1.2||(n.push({x:P.ctrx,y:P.ctry,radius:T,area:P.area,mass:A,fijn1:A*T,fijn2:A/(T*T)}),this.sizeErrorsTot+=D,this.sizeErrorsNum++,u=Math.max(Math.max(P.area,P.initialArea)/Math.min(P.area,P.initialArea),u)));return 150<=u?(console.log("sortie : maxDeformation >= 150",u),!(this._excessive_deformation=!0)):(this.distortionGrid.push({meta:n,reductionFactor:1/(1+this.sizeErrorsTot/this.sizeErrorsNum)}),(new Date).getTime(),!0)},_distortArcs:function(t,e){(new Date).getTime();var i,n,r=t.getTopology(),a=t.getParams(),s=t.getLayerName();"P"!==r&&(i=t.getAreas(),this.opt_simplify&&(r=t.getArcs(),n=t.getNbObjs(),(a=new GCO5.model.maps.GcSimplify(.5*a.mult_xy*(1e3<n?1.5:1)))&&a.simplify(r,s)));for(var o=0;o<this.nb_iter;o++)GCO5.core.GcDelayUtil.callLater(this._iterateDistortion,[t,i,e,o],10*o,this)},_iterateDistortion:function(t,e,i,n){if(this._excessive_deformation)return!1;var r=t.getParams(),a=t.getTopology();t.getLayerName();if("P"===a)for(var s=t.getPtX(),o=t.getPtY(),l=this.distortionGrid[n].reductionFactor,c=this.distortionGrid[n].meta,h=(v=c.length)/r.mult_xy*.02*(l*l),d=0,u=s.length;d<u;d++){var p=s[d],g=o[d],f=0,m=0;M(),s[d]+=f*l,o[d]+=m*l}else{var _=t.getArcs();t.getCtrX(),t.getCtrY();if(_||console.warn("erreur arcs vides deform",t.getLayerName(),t),i&&!this._computedistortionGrid(e,n))console.log("erreur calc deform");else{for(var v,y,b,l=this.distortionGrid[n].reductionFactor,c=this.distortionGrid[n].meta,h=(v=c.length)/r.mult_xy*.02*(l*l),C=_.length,x=((new Date).getTime(),n==this.nb_iter-1),w=0;w<C;w++)for(var S=_[w],d=0,u=S.length;d<u;d+=2){p=S[d],g=S[d+1];f=0,m=0;M(),y=S[d]+=f*l,b=S[d+1]+=m*l,x&&(0===d?(S.minx=S.maxx=y,S.miny=S.maxy=b):(y<S.minx&&(S.minx=y),b<S.miny&&(S.miny=b),y>S.maxx&&(S.maxx=y),b>S.maxy&&(S.maxy=b)))}x&&t.updateMetaDataAfterDistortion()}}function M(){for(var t=0;t<v;t++){var e,i=c[t],n=i.radius,r=i.fijn1,a=i.fijn2,s=i.x,i=i.y,o=r*r*h;isNaN(s)||(o<(i=(o=p-s)*o+(s=g-i)*s)||(s=s/o,r=(n<(e=Math.sqrt(i))?r/e:a*i*(4-3*e/n))/Math.sqrt(1+s*s),0<o?(f+=r,m+=r*s):(f-=r,m-=r*s)))}}}}),GCO5.model.maps.GcSimplify=GCO5.Class.extend({statics:{NAME:"GCO5.model.maps.GcSimplify"},sqTolerance:null,initialize:function(t){this.sqTolerance=void 0!==t?t*t:1},simplify:function(t,e){for(var i=(new Date).getTime(),n=new this.Heap,r=0,a=t.length;r<a;r++){var s,o,l=0,c=[],h=t[r],d=h.minx,u=h.miny,p=h.maxx,g=h.maxy;n.reset();for(var f=0,m=h.length-3;f<m;f+=2)(o=[])[0]=[h[f],h[f+1]],o[1]=[h[f+2],h[f+3]],o[2]=[h[f+4],h[f+5]],(o[1][2]=this._area(o))&&(c.push(o),n.push(o));for(f=0,m=c.length;f<m;++f)(o=c[f]).previous=c[f-1],o.next=c[f+1];for(s=n.getLength();1<n.getLength()&&(o=n.pop())&&!(this._area(o)>this.sqTolerance);)o[1][2]<l?o[1][2]=l:l=o[1][2],o.previous?(o.previous.next=o.next,o.previous[2]=o[2],this._update(n,o.previous)):o[0][2]=o[1][2],o.next?(o.next.previous=o.previous,o.next[0]=o[0],this._update(n,o.next)):o[2][2]=o[1][2];n.getLength()!==s&&((h=n.getArcs(h)).minx=d,h.miny=u,h.maxx=p,h.maxy=g,t[r]=h)}(new Date).getTime();return t},_update:function(t,e){t.remove(e),e[1][2]=this._area(e),t.push(e)},_area:function(t){return Math.abs((t[0][0]-t[2][0])*(t[1][1]-t[0][1])-(t[0][0]-t[1][0])*(t[2][1]-t[0][1]))},Heap:function(){var t={},o=[];function n(t){for(var e=o[t];0<t;){var i=(t+1>>1)-1,n=o[i];if(0<=l(e,n))break;n.index=t,e.index=t=i,o[n.index]=n,o[e.index]=e}}function r(t){for(var e=o[t];;){var i=t+1<<1,n=i-1,r=t,a=o[r],s=o.length;if(n<s&&l(o[n],a)<0&&(a=o[r=n]),i<s&&l(o[i],a)<0&&(a=o[r=i]),r===t)break;o[a.index=t]=a,o[e.index=t=r]=e}}function l(t,e){return t[1][2]-e[1][2]}return t.reset=function(){o=[]},t.getLength=function(){return o.length},t.getArcs=function(){var t=[],e=o[0];for(t.push(e[1][0],e[1][1]);void 0!==e.next;)e=e.next,t.push(e[1][0],e[1][1]);t.push(e[2][0],e[2][1]);for(e=o[0];void 0!==e.previous;)e=e.previous,t.unshift(e[1][0],e[1][1]);return t.unshift(e[0][0],e[0][1]),t},t.push=function(t){return n(t.index=o.push(t)-1),t.index+1},t.pop=function(){var t=o[0],e=o.pop();return 0<o.length&&(o[e.index=0]=e,r(0)),t},t.remove=function(t){var e=t.index,i=o.pop();return e!==o.length&&(l(o[i.index=e]=i,t)<0?n:r)(e),e},t}});